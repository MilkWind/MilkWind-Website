1:"$Sreact.fragment"
2:I[38735,["46","static/chunks/46-268e24d727b280ef.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"default"]
3:I[19945,["46","static/chunks/46-268e24d727b280ef.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"default"]
4:I[65337,["46","static/chunks/46-268e24d727b280ef.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"default"]
5:I[96190,["46","static/chunks/46-268e24d727b280ef.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"ClientProviders"]
6:I[87555,[],""]
7:I[51901,["8039","static/chunks/app/error-dda32be1d095a86c.js"],"default"]
8:I[31295,[],""]
9:I[6874,["6874","static/chunks/6874-fbe9a08eb79b991c.js","4345","static/chunks/app/not-found-9ff98b2ccf24cac7.js"],""]
a:I[94970,[],"ClientSegmentRoot"]
b:I[44065,["206","static/chunks/206-4f4cbf4d7156f437.js","3092","static/chunks/app/documents/layout-28408791defde09e.js"],"default"]
e:I[59665,[],"MetadataBoundary"]
10:I[59665,[],"OutletBoundary"]
13:I[74911,[],"AsyncMetadataOutlet"]
15:I[39460,["2415","static/chunks/2415-689c103fb3d2c28d.js","8610","static/chunks/8610-7bd3f91f3cf2a4d6.js","5650","static/chunks/app/documents/loading-1fa3f98b6e5a8e78.js"],"default"]
16:I[88610,["2415","static/chunks/2415-689c103fb3d2c28d.js","8610","static/chunks/8610-7bd3f91f3cf2a4d6.js","4209","static/chunks/app/loading-68f227fb49b3ac8c.js"],"default"]
17:I[59665,[],"ViewportBoundary"]
19:I[26614,[],""]
:HL["/MilkWind-Website/_next/static/css/f034c804622acb16.css","style"]
:HL["/MilkWind-Website/_next/static/css/276b387d8ca46690.css","style"]
:HL["/MilkWind-Website/_next/static/css/5eacd01f773eed7f.css","style"]
0:{"P":null,"b":"ARIfyKTG2kypPJcFndv6Z","p":"/MilkWind-Website","c":["","documents","zh","light","all-chat-on-this","json-parsing",""],"i":false,"f":[[["",{"children":["documents",{"children":[["slug","zh/light/all-chat-on-this/json-parsing","c"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/MilkWind-Website/_next/static/css/f034c804622acb16.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","link","1",{"rel":"stylesheet","href":"/MilkWind-Website/_next/static/css/276b387d8ca46690.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","suppressHydrationWarning":true,"children":["$","body",null,{"className":"__variable_9b7fb1 __variable_ca2a15 __variable_591dcc font-sans antialiased min-h-screen bg-background text-foreground","suppressHydrationWarning":true,"children":[["$","$L2",null,{}],["$","$L3",null,{}],["$","$L4",null,{}],["$","$L5",null,{"children":["$","$L6",null,{"parallelRouterKey":"children","error":"$7","errorStyles":[],"errorScripts":[],"template":["$","$L8",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","div",null,{"className":"z-10 relative min-h-screen flex items-center justify-center bg-background p-8","children":["$","div",null,{"className":"text-center max-w-md","children":[["$","div",null,{"className":"text-8xl font-bold text-primary mb-4","children":"404"}],["$","h2",null,{"className":"text-2xl font-bold text-foreground mb-4","children":"Page Not Found"}],["$","p",null,{"className":"text-foreground/70 mb-8","children":"The page you're looking for doesn't exist or has been moved to a different location."}],["$","div",null,{"className":"flex flex-col sm:flex-row gap-4 justify-center","children":[["$","$L9",null,{"href":"/","className":"px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors","children":"Go Home"}],["$","$L9",null,{"href":"/works","className":"px-6 py-2 border border-primary text-primary rounded-lg hover:bg-primary/10 transition-colors","children":"View Works"}]]}],["$","div",null,{"className":"absolute inset-0 overflow-hidden pointer-events-none -z-10","children":[["$","div",null,{"className":"absolute top-1/4 left-1/4 w-2 h-2 bg-primary/20 rounded-full animate-float"}],["$","div",null,{"className":"absolute top-3/4 right-1/4 w-3 h-3 bg-accent/20 rounded-full animate-float","style":{"animationDelay":"1s"}}],["$","div",null,{"className":"absolute bottom-1/4 left-1/3 w-1 h-1 bg-secondary/20 rounded-full animate-float","style":{"animationDelay":"2s"}}]]}]]}]}],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}]]}]}]]}],{"children":["documents",["$","$1","c",{"children":[null,["$","$La",null,{"Component":"$b","slots":{"children":["$","$L6",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L8",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]},"params":{},"promise":"$@c"}]]}],{"children":[["slug","zh/light/all-chat-on-this/json-parsing","c"],["$","$1","c",{"children":[null,["$","$L6",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L8",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$Ld",["$","$Le",null,{"children":"$Lf"}],[["$","link","0",{"rel":"stylesheet","href":"/MilkWind-Website/_next/static/css/5eacd01f773eed7f.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","$L10",null,{"children":["$L11","$L12",["$","$L13",null,{"promise":"$@14"}]]}]]}],{},null,false]},null,false]},[["$","$L15","l",{}],[],[]],false]},[["$","$L16","l",{}],[],[]],false],["$","$1","h",{"children":[null,["$","$1","bEe2S6SABlP0fwuZVZSk8",{"children":[["$","$L17",null,{"children":"$L18"}],null]}],null]}],false]],"m":"$undefined","G":["$19","$undefined"],"s":false,"S":true}
1a:"$Sreact.suspense"
1b:I[74911,[],"AsyncMetadata"]
c:{}
f:["$","$1a",null,{"fallback":null,"children":["$","$L1b",null,{"promise":"$@1c"}]}]
1d:I[57340,["5584","static/chunks/b498d07c-095637f0f10883c6.js","2415","static/chunks/2415-689c103fb3d2c28d.js","6874","static/chunks/6874-fbe9a08eb79b991c.js","9554","static/chunks/9554-b714f9de28e85d30.js","1873","static/chunks/app/documents/%5B...slug%5D/page-8f3efa7e6c6c5377.js"],"DocumentPageClient"]
1e:T65c52,<h1 id="all-chat-on-this-配置解析功能实现原理：从配置到消息的完整数据流" class="group relative text-4xl font-bold mt-8 mb-4 text-foreground leading-tight">
            <a href="#all-chat-on-this-配置解析功能实现原理：从配置到消息的完整数据流" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to All-Chat-on-This 配置解析功能实现原理：从配置到消息的完整数据流">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            All-Chat-on-This 配置解析功能实现原理：从配置到消息的完整数据流
        </h1>
<p class="text-base leading-7 mb-4 text-foreground">处理各种AI服务商的API差异简直是个&quot;数据格式联合国&quot;的问题，而ACOT就是专门用来解决这个问题的。</p>
<p class="text-base leading-7 mb-4 text-foreground">本篇文章将深度剖析从UserConfigDO配置类到sendMessage消息发送的每一个环节，全面解构这个让不同AI服务商API&quot;大一统&quot;的数据处理系统。</p>
<h2 id="配置类设计篇：userconfigdo的灵活架构" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#配置类设计篇：userconfigdo的灵活架构" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 配置类设计篇：UserConfigDO的灵活架构">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            配置类设计篇：UserConfigDO的灵活架构
        </h2>
<p class="text-base leading-7 mb-4 text-foreground">在处理多样化AI服务商API时，主要的问题不是调用API本身，而是如何设计一个足够灵活的配置系统来适配千差万别的认证方式和数据格式。</p>
<h3 id="灵活的api密钥放置策略" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#灵活的api密钥放置策略" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 灵活的API密钥放置策略">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            灵活的API密钥放置策略
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20API%E5%AF%86%E9%92%A5%E6%94%BE%E7%BD%AE%E7%AD%96%E7%95%A5%0Aprivate%20String%20apiKeyPlacement%3B%20%2F%2F%20'header'%2C%20'body'%2C%20%E6%88%96%20'custom_header'%0Aprivate%20String%20apiKeyHeader%3B%20%2F%2F%20%E5%BD%93apiKeyPlacement%3D'custom_header'%E6%97%B6%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89header%E5%90%8D%E7%A7%B0%0Aprivate%20String%20apiKeyBodyPath%3B%20%2F%2F%20%E5%BD%93apiKeyPlacement%3D'body'%E6%97%B6%E7%9A%84JSON%E8%B7%AF%E5%BE%84">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// API密钥放置策略</span>
<span class="hljs-keyword inline">private</span> String apiKeyPlacement; <span class="hljs-comment inline">// &#x27;header&#x27;, &#x27;body&#x27;, 或 &#x27;custom_header&#x27;</span>
<span class="hljs-keyword inline">private</span> String apiKeyHeader; <span class="hljs-comment inline">// 当apiKeyPlacement=&#x27;custom_header&#x27;时的自定义header名称</span>
<span class="hljs-keyword inline">private</span> String apiKeyBodyPath; <span class="hljs-comment inline">// 当apiKeyPlacement=&#x27;body&#x27;时的JSON路径</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">为什么需要三种策略</strong>？</p>
<p class="text-base leading-7 mb-4 text-foreground">让我们看看现实中AI服务商的多样性：</p>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Header策略（最常见）</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="http" data-code="%23%20OpenAI%E9%A3%8E%E6%A0%BC%0AAuthorization%3A%20Bearer%20sk-xxxxxxxxxxxx%0A%23%20Anthropic%E9%A3%8E%E6%A0%BC%0Ax-api-key%3A%20sk-ant-xxxxxxxxxxxx%0A%23%20Google%E9%A3%8E%E6%A0%BC%0AX-Goog-Api-Key%3A%20AIzaxxxxxxxxxxxx">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">http</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-http"># OpenAI风格
<span class="hljs-attribute inline">Authorization</span><span class="hljs-punctuation inline">: </span>Bearer sk-xxxxxxxxxxxx

# Anthropic风格  
<span class="hljs-attribute inline">x-api-key</span><span class="hljs-punctuation inline">: </span>sk-ant-xxxxxxxxxxxx

# Google风格
<span class="hljs-attribute inline">X-Goog-Api-Key</span><span class="hljs-punctuation inline">: </span>AIzaxxxxxxxxxxxx
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Body策略（嵌入式）</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%7B%0A%22api_key%22%3A%20%22sk-xxxxxxxxxxxx%22%2C%0A%22messages%22%3A%20%5B...%5D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-punctuation inline">{</span>
  <span class="hljs-attr inline">&quot;api_key&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;sk-xxxxxxxxxxxx&quot;</span><span class="hljs-punctuation inline">,</span>
  <span class="hljs-attr inline">&quot;messages&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>...<span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Custom Header策略（个性化）</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="http" data-code="Custom-Auth-Token%3A%20xxxxxxxxxxxx%0AX-Custom-Key%3A%20xxxxxxxxxxxx">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">http</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-http"><span class="hljs-attribute inline">Custom-Auth-Token</span><span class="hljs-punctuation inline">: </span>xxxxxxxxxxxx
<span class="hljs-attribute inline">X-Custom-Key</span><span class="hljs-punctuation inline">: </span>xxxxxxxxxxxx
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">这种设计的数学表达：<br class="block">
<span class="katex-display inline"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mi>P</mi><mi>I</mi><mtext>认证策略</mtext><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>H</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>if placement = ’header’</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>B</mi><mi>o</mi><mi>d</mi><mi>y</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>if placement = ’body’</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>C</mi><mi>u</mi><mi>s</mi><mi>t</mi><mi>o</mi><mi>m</mi><mi>H</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>if placement = ’custom_header’</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">API认证策略 = \begin{cases} Header &amp; \text{if placement = &#x27;header&#x27;} \\ Body &amp; \text{if placement = &#x27;body&#x27;} \\ CustomHeader &amp; \text{if placement = &#x27;custom\_header&#x27;} \end{cases}</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.6833em;"></span><span class="mord mathnormal inline">A</span><span class="mord mathnormal inline" style="margin-right:0.13889em;">P</span><span class="mord mathnormal inline" style="margin-right:0.07847em;">I</span><span class="mord cjk_fallback inline">认证策略</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:4.32em;vertical-align:-1.91em;"></span><span class="minner inline"><span class="mopen inline"><span class="delimsizing mult inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:2.35em;"><span style="top:-2.2em;" class="inline"><span class="pstrut inline" style="height:3.15em;"></span><span class="delimsizinginner delim-size4 inline"><span class="inline">⎩</span></span></span><span style="top:-2.192em;" class="inline"><span class="pstrut inline" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;" class="inline"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;" class="inline"><span class="pstrut inline" style="height:3.15em;"></span><span class="delimsizinginner delim-size4 inline"><span class="inline">⎨</span></span></span><span style="top:-4.292em;" class="inline"><span class="pstrut inline" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;" class="inline"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;" class="inline"><span class="pstrut inline" style="height:3.15em;"></span><span class="delimsizinginner delim-size4 inline"><span class="inline">⎧</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:1.85em;"><span class="inline"></span></span></span></span></span></span><span class="mord inline"><span class="mtable inline"><span class="col-align-l inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:2.41em;"><span style="top:-4.41em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord mathnormal inline">He</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">d</span><span class="mord mathnormal inline" style="margin-right:0.02778em;">er</span></span></span><span style="top:-2.97em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord mathnormal inline" style="margin-right:0.05017em;">B</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline">d</span><span class="mord mathnormal inline" style="margin-right:0.03588em;">y</span></span></span><span style="top:-1.53em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord mathnormal inline" style="margin-right:0.07153em;">C</span><span class="mord mathnormal inline">u</span><span class="mord mathnormal inline">s</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline">m</span><span class="mord mathnormal inline">He</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">d</span><span class="mord mathnormal inline" style="margin-right:0.02778em;">er</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:1.91em;"><span class="inline"></span></span></span></span></span><span class="arraycolsep inline" style="width:1em;"></span><span class="col-align-l inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:2.41em;"><span style="top:-4.41em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord text inline"><span class="mord inline">if placement = ’header’</span></span></span></span><span style="top:-2.97em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord text inline"><span class="mord inline">if placement = ’body’</span></span></span></span><span style="top:-1.53em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord text inline"><span class="mord inline">if placement = ’custom_header’</span></span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:1.91em;"><span class="inline"></span></span></span></span></span></span></span><span class="mclose nulldelimiter inline"></span></span></span></span></span></span></p>
<h3 id="json模板化设计：统一处理" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#json模板化设计：统一处理" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to JSON模板化设计：统一处理">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            JSON模板化设计：统一处理
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20JSON%E6%A8%A1%E6%9D%BF%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20requestTemplate%3B%20%2F%2F%20%E8%AF%B7%E6%B1%82%E7%9A%84JSON%E6%A8%A1%E6%9D%BF%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20responseTemplate%3B%20%2F%2F%20%E5%93%8D%E5%BA%94%E5%A4%84%E7%90%86%E7%9A%84JSON%E6%A8%A1%E6%9D%BF">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// JSON模板</span>
<span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
<span class="hljs-keyword inline">private</span> Map&lt;String, Object&gt; requestTemplate; <span class="hljs-comment inline">// 请求的JSON模板</span>

<span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
<span class="hljs-keyword inline">private</span> Map&lt;String, Object&gt; responseTemplate; <span class="hljs-comment inline">// 响应处理的JSON模板</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">为什么使用JacksonTypeHandler</strong>？</p>
<p class="text-base leading-7 mb-4 text-foreground">这是MyBatis Plus处理复杂对象的优雅方案：</p>
<p class="text-base leading-7 mb-4 text-foreground">错误的做法：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9D%8C%20%E6%89%8B%E5%8A%A8%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%8C%E5%AE%B9%E6%98%93%E5%87%BA%E9%94%99%0Aprivate%20String%20requestTemplateJson%3B%0A%2F%2F%20%E4%BD%BF%E7%94%A8%E6%97%B6%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E8%BD%AC%E6%8D%A2%0AObjectMapper%20mapper%20%3D%20new%20ObjectMapper()%3B%0AMap%20template%20%3D%20mapper.readValue(requestTemplateJson%2C%20Map.class)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ❌ 手动序列化，容易出错</span>
<span class="hljs-keyword inline">private</span> String requestTemplateJson;

<span class="hljs-comment inline">// 使用时需要手动转换</span>
<span class="hljs-type inline">ObjectMapper</span> <span class="hljs-variable inline">mapper</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ObjectMapper</span>();
Map&lt;String, Object&gt; template = mapper.readValue(requestTemplateJson, Map.class);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">正确的做法：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9C%85%20%E8%87%AA%E5%8A%A8%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%8C%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20requestTemplate%3B%0A%2F%2F%20%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%EF%BC%8C%E6%97%A0%E9%9C%80%E8%BD%AC%E6%8D%A2%0Atemplate.put(%22model%22%2C%20%22gpt-4%22)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ✅ 自动序列化，类型安全</span>
<span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
<span class="hljs-keyword inline">private</span> Map&lt;String, Object&gt; requestTemplate;

<span class="hljs-comment inline">// 直接使用，无需转换</span>
template.put(<span class="hljs-string inline">&quot;model&quot;</span>, <span class="hljs-string inline">&quot;gpt-4&quot;</span>);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">模板化兼容措施</strong>：</p>
<p class="text-base leading-7 mb-4 text-foreground">不同服务商的请求格式有可能差异巨大：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%2F%2F%20OpenAI%E6%A0%BC%E5%BC%8F%0A%7B%0A%22model%22%3A%20%22gpt-4%22%2C%0A%22messages%22%3A%20%5B...%5D%2C%0A%22temperature%22%3A%200.7%0A%7D%0A%2F%2F%20Claude%E6%A0%BC%E5%BC%8F%0A%7B%0A%22model%22%3A%20%22claude-3-sonnet-20240229%22%2C%0A%22max_tokens%22%3A%201024%2C%0A%22messages%22%3A%20%5B...%5D%0A%7D%0A%2F%2F%20%E8%87%AA%E5%AE%9A%E4%B9%89API%E6%A0%BC%E5%BC%8F%0A%7B%0A%22engine%22%3A%20%22custom-model%22%2C%0A%22prompt%22%3A%20%22...%22%2C%0A%22config%22%3A%20%7B%0A%22temperature%22%3A%200.7%2C%0A%22max_length%22%3A%202048%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-comment inline">// OpenAI格式</span>
<span class="hljs-punctuation inline">{</span>
  <span class="hljs-attr inline">&quot;model&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;gpt-4&quot;</span><span class="hljs-punctuation inline">,</span>
  <span class="hljs-attr inline">&quot;messages&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>...<span class="hljs-punctuation inline">]</span><span class="hljs-punctuation inline">,</span>
  <span class="hljs-attr inline">&quot;temperature&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-number inline">0.7</span>
<span class="hljs-punctuation inline">}</span>

<span class="hljs-comment inline">// Claude格式  </span>
<span class="hljs-punctuation inline">{</span>
  <span class="hljs-attr inline">&quot;model&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;claude-3-sonnet-20240229&quot;</span><span class="hljs-punctuation inline">,</span>
  <span class="hljs-attr inline">&quot;max_tokens&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-number inline">1024</span><span class="hljs-punctuation inline">,</span>
  <span class="hljs-attr inline">&quot;messages&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>...<span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>

<span class="hljs-comment inline">// 自定义API格式</span>
<span class="hljs-punctuation inline">{</span>
  <span class="hljs-attr inline">&quot;engine&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;custom-model&quot;</span><span class="hljs-punctuation inline">,</span>
  <span class="hljs-attr inline">&quot;prompt&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;...&quot;</span><span class="hljs-punctuation inline">,</span>
  <span class="hljs-attr inline">&quot;config&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
    <span class="hljs-attr inline">&quot;temperature&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-number inline">0.7</span><span class="hljs-punctuation inline">,</span>
    <span class="hljs-attr inline">&quot;max_length&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-number inline">2048</span>
  <span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">}</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">通过模板化，我们可以预设任意格式，然后动态填充消息内容。</p>
<h3 id="消息路径配置设计：支持复杂嵌套结构" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#消息路径配置设计：支持复杂嵌套结构" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 消息路径配置设计：支持复杂嵌套结构">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            消息路径配置设计：支持复杂嵌套结构
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5%0Aprivate%20String%20requestMessageGroupPath%3B%20%2F%2F%20%E6%B6%88%E6%81%AF%E7%BB%84%E7%9A%84JSON%E8%B7%AF%E5%BE%84%0Aprivate%20String%20requestRolePathFromGroup%3B%20%2F%2F%20%E6%B6%88%E6%81%AF%E7%BB%84%E4%B8%AD%E8%A7%92%E8%89%B2%E7%9A%84JSON%E8%B7%AF%E5%BE%84%0Aprivate%20String%20requestTextPathFromGroup%3B%20%2F%2F%20%E8%AF%B7%E6%B1%82%E6%96%87%E6%9C%AC%E7%9A%84JSON%E8%B7%AF%E5%BE%84%0Aprivate%20String%20responseTextPath%3B%20%2F%2F%20%E5%93%8D%E5%BA%94%E6%96%87%E6%9C%AC%E7%9A%84JSON%E8%B7%AF%E5%BE%84%0Aprivate%20String%20responseThinkingTextPath%3B%20%2F%2F%20%E5%93%8D%E5%BA%94%E4%B8%AD%E6%80%9D%E8%80%83%E6%96%87%E6%9C%AC%E7%9A%84JSON%E8%B7%AF%E5%BE%84">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 请求和响应处理策略  </span>
<span class="hljs-keyword inline">private</span> String requestMessageGroupPath; <span class="hljs-comment inline">// 消息组的JSON路径</span>
<span class="hljs-keyword inline">private</span> String requestRolePathFromGroup; <span class="hljs-comment inline">// 消息组中角色的JSON路径</span>
<span class="hljs-keyword inline">private</span> String requestTextPathFromGroup; <span class="hljs-comment inline">// 请求文本的JSON路径</span>
<span class="hljs-keyword inline">private</span> String responseTextPath; <span class="hljs-comment inline">// 响应文本的JSON路径</span>
<span class="hljs-keyword inline">private</span> String responseThinkingTextPath; <span class="hljs-comment inline">// 响应中思考文本的JSON路径</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">路径系统如何工作</strong>？</p>
<p class="text-base leading-7 mb-4 text-foreground">以一个复杂的API格式为例：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%7B%0A%22model%22%3A%20%22gpt-4%22%2C%0A%22parameters%22%3A%20%7B%0A%22conversation%22%3A%20%7B%0A%22messages%22%3A%20%5B%0A%7B%0A%22role%22%3A%20%22user%22%2C%0A%22content%22%3A%20%22Hello%22%0A%7D%0A%5D%0A%7D%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-punctuation inline">{</span>
  <span class="hljs-attr inline">&quot;model&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;gpt-4&quot;</span><span class="hljs-punctuation inline">,</span>
  <span class="hljs-attr inline">&quot;parameters&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
    <span class="hljs-attr inline">&quot;conversation&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
      <span class="hljs-attr inline">&quot;messages&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>
        <span class="hljs-punctuation inline">{</span>
          <span class="hljs-attr inline">&quot;role&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;user&quot;</span><span class="hljs-punctuation inline">,</span>
          <span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;Hello&quot;</span>
        <span class="hljs-punctuation inline">}</span>
      <span class="hljs-punctuation inline">]</span>
    <span class="hljs-punctuation inline">}</span>
  <span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">}</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">对应的路径配置：</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><code>requestMessageGroupPath</code>: <code>&quot;parameters.conversation.messages&quot;</code></li>
<li class="text-foreground leading-relaxed"><code>requestRolePathFromGroup</code>: <code>&quot;role&quot;</code></li>
<li class="text-foreground leading-relaxed"><code>requestTextPathFromGroup</code>: <code>&quot;content&quot;</code></li>
</ul>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">JsonPath的数学表达</strong>：</p>
<p class="text-base leading-7 mb-4 text-foreground">路径解析算法可以表示为：<br class="block">
<span class="katex-display inline"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>J</mi><mi>s</mi><mi>o</mi><mi>n</mi><mi>P</mi><mi>a</mi><mi>t</mi><mi>h</mi><mo stretchy="false">(</mo><mi>o</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo separator="true">,</mo><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mo stretchy="false">)</mo><mo>=</mo><mi>o</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy="false">[</mo><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mn>0</mn></msub><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mn>1</mn></msub><mo stretchy="false">]</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo stretchy="false">[</mo><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mi>n</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">JsonPath(object, path) = object[path_0][path_1]...[path_n]</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.09618em;">J</span><span class="mord mathnormal inline">so</span><span class="mord mathnormal inline">n</span><span class="mord mathnormal inline" style="margin-right:0.13889em;">P</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">h</span><span class="mopen inline">(</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.05724em;">bj</span><span class="mord mathnormal inline">ec</span><span class="mord mathnormal inline">t</span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">h</span><span class="mclose inline">)</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.05724em;">bj</span><span class="mord mathnormal inline">ec</span><span class="mord mathnormal inline">t</span><span class="mopen inline">[</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">0</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mclose inline">]</span><span class="mopen inline">[</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">1</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mclose inline">]</span><span class="mord inline">...</span><span class="mopen inline">[</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mathnormal mtight inline">n</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mclose inline">]</span></span></span></span></span></p>
<p class="text-base leading-7 mb-4 text-foreground">其中<span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mo>=</mo><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mn>0</mn></msub><mi mathvariant="normal">.</mi><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mn>1</mn></msub><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">path = path_0.path_1...path_n</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">h</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">0</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mord inline">.</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">1</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mord inline">...</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mathnormal mtight inline">n</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span></span></span></span></p>
<h3 id="userconfigdo完整结构图" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#userconfigdo完整结构图" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to UserConfigDO完整结构图">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            UserConfigDO完整结构图
        </h3>
<div class="mermaid block" id="mermaid-1767322174127-ypu3k7k">classDiagram
    class UserConfigDO {
        +Long id
        +Boolean isAvailable
        +String name
        +String apiUrl
        +String apiKey
        
        +String apiKeyPlacement
        +String apiKeyHeader
        +String apiKeyBodyPath
        
        +Map requestTemplate
        +Map responseTemplate
        +Map headers
        
        +String requestMessageGroupPath
        +String requestRolePathFromGroup
        +String requestTextPathFromGroup
        +String responseTextPath
        +String responseThinkingTextPath
        
        +String requestUserRoleField
        +String requestAssistantField
        +String requestSystemField
        
        +LocalDateTime lastUsedTime
        +String secretKey
    }</div>
<h2 id="数据解析逻辑篇：preparerequestdata的双重奏" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#数据解析逻辑篇：preparerequestdata的双重奏" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 数据解析逻辑篇：prepareRequestData的双重奏">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            数据解析逻辑篇：prepareRequestData的双重奏
        </h2>
<p class="text-base leading-7 mb-4 text-foreground">数据准备是整个系统的核心，需要将用户配置转换为可发送的HTTP请求。ACOT提供了两个重载方法来处理不同的场景。</p>
<h3 id="测试版本：单消息处理的基础逻辑" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#测试版本：单消息处理的基础逻辑" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 测试版本：单消息处理的基础逻辑">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            测试版本：单消息处理的基础逻辑
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="public%20static%20Map%20prepareRequestData(UserConfigDO%20config%2C%20String%20messageText)%20%7B%0A%2F%2F%20%E5%87%86%E5%A4%87%E8%AF%B7%E6%B1%82%E5%A4%B4%0AMap%20headers%20%3D%20new%20HashMap(config.getHeaders()%20!%3D%20null%20%3F%20config.getHeaders()%20%3A%20new%20HashMap())%3B%0A%2F%2F%20%E6%A3%80%E6%9F%A5API%E5%AF%86%E9%92%A5%E6%98%AF%E5%90%A6%E5%8A%A0%E5%AF%86%EF%BC%8C%E5%A6%82%E6%9C%89%E9%9C%80%E8%A6%81%E5%88%99%E8%A7%A3%E5%AF%86%0AString%20apiKey%20%3D%20config.getApiKey()%3B%0Aif%20(apiKey%20!%3D%20null%20%26%26%20apiKey.startsWith(%22enc%3A%22)%20%26%26%20StringUtils.hasText(config.getSecretKey()))%20%7B%0Atry%20%7B%0AapiKey%20%3D%20decryptApiKey(apiKey.substring(4)%2C%20config.getSecretKey())%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22Error%20decrypting%20API%20key%22%2C%20e)%3B%0Athrow%20new%20ServiceException(CONFIG_NOT_EXISTS%2C%20%22Failed%20to%20decrypt%20API%20key%3A%20%22%20%2B%20e.getMessage())%3B%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_ inline">prepareRequestData</span><span class="hljs-params inline">(UserConfigDO config, String messageText)</span> {
    <span class="hljs-comment inline">// 准备请求头</span>
    Map&lt;String, String&gt; headers = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(config.getHeaders() != <span class="hljs-literal inline">null</span> ? config.getHeaders() : <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;());

    <span class="hljs-comment inline">// 检查API密钥是否加密，如有需要则解密</span>
    <span class="hljs-type inline">String</span> <span class="hljs-variable inline">apiKey</span> <span class="hljs-operator inline">=</span> config.getApiKey();
    <span class="hljs-keyword inline">if</span> (apiKey != <span class="hljs-literal inline">null</span> &amp;&amp; apiKey.startsWith(<span class="hljs-string inline">&quot;enc:&quot;</span>) &amp;&amp; StringUtils.hasText(config.getSecretKey())) {
        <span class="hljs-keyword inline">try</span> {
            apiKey = decryptApiKey(apiKey.substring(<span class="hljs-number inline">4</span>), config.getSecretKey());
        } <span class="hljs-keyword inline">catch</span> (Exception e) {
            log.error(<span class="hljs-string inline">&quot;Error decrypting API key&quot;</span>, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIG_NOT_EXISTS, <span class="hljs-string inline">&quot;Failed to decrypt API key: &quot;</span> + e.getMessage());
        }
    }
</code></pre>
            </div>
        
<h3 id="api密钥放置的三重分派" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#api密钥放置的三重分派" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to API密钥放置的三重分派">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            API密钥放置的三重分派
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E6%A0%B9%E6%8D%AE%E6%94%BE%E7%BD%AE%E7%AD%96%E7%95%A5%E5%B0%86API%E5%AF%86%E9%92%A5%E6%B7%BB%E5%8A%A0%E5%88%B0%E8%AF%B7%E6%B1%82%E5%A4%B4%0Aif%20(%22header%22.equals(config.getApiKeyPlacement())%20%7C%7C%20config.getApiKeyPlacement()%20%3D%3D%20null)%20%7B%0Aheaders.put(%22Authorization%22%2C%20%22Bearer%20%22%20%2B%20apiKey)%3B%0A%7D%20else%20if%20(%22custom_header%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyHeader()%20!%3D%20null)%20%7B%0Aheaders.put(config.getApiKeyHeader()%2C%20apiKey)%3B%0A%7D%0A%2F%2F%20%E9%80%9A%E8%BF%87%E5%85%8B%E9%9A%86%E6%A8%A1%E6%9D%BF%E6%9D%A5%E5%87%86%E5%A4%87%E8%AF%B7%E6%B1%82%E4%BD%93%0AMap%20requestBody%20%3D%20new%20HashMap(config.getRequestTemplate())%3B%0A%2F%2F%20%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%EF%BC%8C%E5%B0%86API%E5%AF%86%E9%92%A5%E6%B7%BB%E5%8A%A0%E5%88%B0%E8%AF%B7%E6%B1%82%E4%BD%93%E4%B8%AD%0Aif%20(%22body%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyBodyPath()%20!%3D%20null)%20%7B%0AJsonUtils.setValueByPath(requestBody%2C%20config.getApiKeyBodyPath()%2C%20apiKey)%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 根据放置策略将API密钥添加到请求头</span>
<span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;header&quot;</span>.equals(config.getApiKeyPlacement()) || config.getApiKeyPlacement() == <span class="hljs-literal inline">null</span>) {
    headers.put(<span class="hljs-string inline">&quot;Authorization&quot;</span>, <span class="hljs-string inline">&quot;Bearer &quot;</span> + apiKey);
} <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;custom_header&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyHeader() != <span class="hljs-literal inline">null</span>) {
    headers.put(config.getApiKeyHeader(), apiKey);
}

<span class="hljs-comment inline">// 通过克隆模板来准备请求体</span>
Map&lt;String, Object&gt; requestBody = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(config.getRequestTemplate());

<span class="hljs-comment inline">// 如果需要，将API密钥添加到请求体中</span>
<span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;body&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyBodyPath() != <span class="hljs-literal inline">null</span>) {
    JsonUtils.setValueByPath(requestBody, config.getApiKeyBodyPath(), apiKey);
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">策略模式</strong>：</p>
<p class="text-base leading-7 mb-4 text-foreground">每种放置方式都有其特定的处理逻辑：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="typescript" data-code="%2F%2F%20%E4%BC%AA%E4%BB%A3%E7%A0%81%E8%A1%A8%E7%A4%BA%E5%88%86%E6%B4%BE%E9%80%BB%E8%BE%91%0Aswitch(apiKeyPlacement)%20%7B%0Acase%20'header'%3A%0Aheaders%5B'Authorization'%5D%20%3D%20'Bearer%20'%20%2B%20apiKey%3B%0Abreak%3B%0Acase%20'custom_header'%3A%0Aheaders%5BapiKeyHeader%5D%20%3D%20apiKey%3B%0Abreak%3B%0Acase%20'body'%3A%0AsetValueByPath(requestBody%2C%20apiKeyBodyPath%2C%20apiKey)%3B%0Abreak%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">typescript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-typescript"><span class="hljs-comment inline">// 伪代码表示分派逻辑</span>
<span class="hljs-keyword inline">switch</span>(apiKeyPlacement) {
    <span class="hljs-keyword inline">case</span> <span class="hljs-string inline">&#x27;header&#x27;</span>:
        headers[<span class="hljs-string inline">&#x27;Authorization&#x27;</span>] = <span class="hljs-string inline">&#x27;Bearer &#x27;</span> + apiKey;
        <span class="hljs-keyword inline">break</span>;
    <span class="hljs-keyword inline">case</span> <span class="hljs-string inline">&#x27;custom_header&#x27;</span>:
        headers[apiKeyHeader] = apiKey;
        <span class="hljs-keyword inline">break</span>;
    <span class="hljs-keyword inline">case</span> <span class="hljs-string inline">&#x27;body&#x27;</span>:
        <span class="hljs-title function_ inline">setValueByPath</span>(requestBody, apiKeyBodyPath, apiKey);
        <span class="hljs-keyword inline">break</span>;
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">JsonUtils.setValueByPath路径设置</strong>：</p>
<p class="text-base leading-7 mb-4 text-foreground">这个方法能处理复杂的嵌套路径：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E8%B7%AF%E5%BE%84%20%22auth.credentials.api_key%22%20%E4%BC%9A%E8%A2%AB%E8%A7%A3%E6%9E%90%E4%B8%BA%EF%BC%9A%0A%2F%2F%20requestBody.auth.credentials.api_key%20%3D%20apiKey%0AJsonUtils.setValueByPath(requestBody%2C%20%22auth.credentials.api_key%22%2C%20apiKey)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 路径 &quot;auth.credentials.api_key&quot; 会被解析为：</span>
<span class="hljs-comment inline">// requestBody.auth.credentials.api_key = apiKey</span>
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;auth.credentials.api_key&quot;</span>, apiKey);
</code></pre>
            </div>
        
<h3 id="实用版本：对话历史处理" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#实用版本：对话历史处理" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 实用版本：对话历史处理">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            实用版本：对话历史处理
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="public%20static%20Map%20prepareRequestData(UserConfigDO%20config%2C%20String%20messageText%2C%20List%20conversationMessages)%20%7B%0A%2F%2F%20...%20%E5%89%8D%E9%9D%A2%E7%9A%84%E9%80%BB%E8%BE%91%E7%9B%B8%E5%90%8C%0A%2F%2F%20%E5%88%9B%E5%BB%BA%E6%B6%88%E6%81%AF%E7%BB%84%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%0Aif%20(StringUtils.hasText(config.getRequestMessageGroupPath())%20%26%26%20(conversationMessages%20!%3D%20null%20%7C%7C%20messageText%20!%3D%20null))%20%7B%0AList%3E%20messages%20%3D%20new%20ArrayList()%3B%0A%2F%2F%20%E6%B7%BB%E5%8A%A0%E4%B9%8B%E5%89%8D%E7%9A%84%E6%B6%88%E6%81%AF%0Aif%20(conversationMessages%20!%3D%20null)%20%7B%0Afor%20(ConversationMessageDO%20message%20%3A%20conversationMessages)%20%7B%0A%2F%2F%20%E8%B7%B3%E8%BF%87%E7%B3%BB%E7%BB%9F%E6%B6%88%E6%81%AF%0Aif%20(%22system%22.equals(message.getRole()))%20%7B%0Acontinue%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_ inline">prepareRequestData</span><span class="hljs-params inline">(UserConfigDO config, String messageText, List&lt;ConversationMessageDO&gt; conversationMessages)</span> {
    <span class="hljs-comment inline">// ... 前面的逻辑相同</span>
    
    <span class="hljs-comment inline">// 创建消息组并添加对话历史</span>
    <span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getRequestMessageGroupPath()) &amp;&amp; (conversationMessages != <span class="hljs-literal inline">null</span> || messageText != <span class="hljs-literal inline">null</span>)) {
        List&lt;Map&lt;String, Object&gt;&gt; messages = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment inline">// 添加之前的消息</span>
        <span class="hljs-keyword inline">if</span> (conversationMessages != <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">for</span> (ConversationMessageDO message : conversationMessages) {
                <span class="hljs-comment inline">// 跳过系统消息</span>
                <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;system&quot;</span>.equals(message.getRole())) {
                    <span class="hljs-keyword inline">continue</span>;
                }
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">对话历史处理的核心算法</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E8%A7%92%E8%89%B2%E6%98%A0%E5%B0%84%E7%AD%96%E7%95%A5%0AString%20userRoleValue%20%3D%20StringUtils.hasText(config.getRequestUserRoleField())%20%3F%0Aconfig.getRequestUserRoleField()%20%3A%20%22user%22%3B%0AString%20assistantRoleValue%20%3D%20StringUtils.hasText(config.getRequestAssistantField())%20%3F%0Aconfig.getRequestAssistantField()%20%3A%20%22assistant%22%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 角色映射策略</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">userRoleValue</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestUserRoleField()) ?
        config.getRequestUserRoleField() : <span class="hljs-string inline">&quot;user&quot;</span>;

<span class="hljs-type inline">String</span> <span class="hljs-variable inline">assistantRoleValue</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestAssistantField()) ?
        config.getRequestAssistantField() : <span class="hljs-string inline">&quot;assistant&quot;</span>;
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">这种映射机制解决了不同服务商角色字段差异的问题：</p>
<table class="w-full border-collapse mb-4 shadow-sm rounded-lg overflow-hidden">
<thead class="bg-surface">
<tr class="border-b border-gray-200"><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">服务商</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">User角色</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">Assistant角色</th></tr>
</thead>
<tbody class="bg-background divide-y divide-gray-200">
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">OpenAI</td><td class="px-4 py-3 text-sm text-foreground">“user”</td><td class="px-4 py-3 text-sm text-foreground">“assistant”</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Claude</td><td class="px-4 py-3 text-sm text-foreground">“user”</td><td class="px-4 py-3 text-sm text-foreground">“assistant”</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">自定义API</td><td class="px-4 py-3 text-sm text-foreground">“human”</td><td class="px-4 py-3 text-sm text-foreground">“ai”</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">某些API</td><td class="px-4 py-3 text-sm text-foreground">“customer”</td><td class="px-4 py-3 text-sm text-foreground">“agent”</td></tr>
</tbody>
</table>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">消息对象动态构建</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="Map%20messageObj%20%3D%20new%20HashMap()%3B%0A%2F%2F%20%E5%8A%A8%E6%80%81%E8%AE%BE%E7%BD%AE%E8%A7%92%E8%89%B2%E5%AD%97%E6%AE%B5%E5%90%8D%0Aif%20(%22user%22.equals(message.getRole()))%20%7B%0AmessageObj.put(rolePath%2C%20userRoleValue)%3B%0A%7D%20else%20if%20(%22assistant%22.equals(message.getRole()))%20%7B%0AmessageObj.put(rolePath%2C%20assistantRoleValue)%3B%0A%7D%0A%2F%2F%20%E5%8A%A8%E6%80%81%E8%AE%BE%E7%BD%AE%E5%86%85%E5%AE%B9%E5%AD%97%E6%AE%B5%E5%90%8D%0AmessageObj.put(textPath%2C%20message.getContent())%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java">Map&lt;String, Object&gt; messageObj = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
<span class="hljs-comment inline">// 动态设置角色字段名</span>
<span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;user&quot;</span>.equals(message.getRole())) {
    messageObj.put(rolePath, userRoleValue);
} <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;assistant&quot;</span>.equals(message.getRole())) {
    messageObj.put(rolePath, assistantRoleValue);
}
<span class="hljs-comment inline">// 动态设置内容字段名</span>
messageObj.put(textPath, message.getContent());
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">倘若某些API的用户和AI的角色字段并非默认的<code>user</code>和<code>assistant</code>，那么该功能便可支持用户和AI的字段名自定义配置。</p>
<h2 id="消息生成与发送逻辑篇：sendmessage的完整业务流程" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#消息生成与发送逻辑篇：sendmessage的完整业务流程" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 消息生成与发送逻辑篇：sendMessage的完整业务流程">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            消息生成与发送逻辑篇：sendMessage的完整业务流程
        </h2>
<p class="text-base leading-7 mb-4 text-foreground">消息发送是整个系统的最终目标，涉及权限验证、数据准备、HTTP调用、响应解析等多个环节。</p>
<h3 id="权限验证" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#权限验证" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 权限验证">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            权限验证
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E9%AA%8C%E8%AF%81%E5%AF%B9%E8%AF%9D%E6%98%AF%E5%90%A6%E5%B1%9E%E4%BA%8E%E8%AF%A5%E7%94%A8%E6%88%B7%0AConversationDO%20conversation%20%3D%20conversationService.getConversation(conversationId%2C%20userId)%3B%0Aif%20(conversation%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(CONVERSATION_NOT_EXISTS.getCode()%2C%20CONVERSATION_NOT_EXISTS.getMsg())%3B%0A%7D%0A%2F%2F%20%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%0AUserConfigDO%20config%20%3D%20userConfigService.getConfig(configId%2C%20userId)%3B%0Aif%20(config%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(CONFIGURATION_NOT_EXISTS.getCode()%2C%20CONFIGURATION_NOT_EXISTS.getMsg())%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 验证对话是否属于该用户</span>
<span class="hljs-type inline">ConversationDO</span> <span class="hljs-variable inline">conversation</span> <span class="hljs-operator inline">=</span> conversationService.getConversation(conversationId, userId);
<span class="hljs-keyword inline">if</span> (conversation == <span class="hljs-literal inline">null</span>) {
    <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONVERSATION_NOT_EXISTS.getCode(), CONVERSATION_NOT_EXISTS.getMsg());
}

<span class="hljs-comment inline">// 获取配置</span>
<span class="hljs-type inline">UserConfigDO</span> <span class="hljs-variable inline">config</span> <span class="hljs-operator inline">=</span> userConfigService.getConfig(configId, userId);
<span class="hljs-keyword inline">if</span> (config == <span class="hljs-literal inline">null</span>) {
    <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIGURATION_NOT_EXISTS.getCode(), CONFIGURATION_NOT_EXISTS.getMsg());
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">双重权限验证机制</strong>：</p>
<ol class="list-decimal list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">对话归属权验证</strong>：确保用户只能操作自己的对话</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">配置归属权验证</strong>：确保用户只能使用自己的配置</li>
</ol>
<p class="text-base leading-7 mb-4 text-foreground">这种设计防止了常见的安全问题：</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">水平权限提升</strong>：用户A不能访问用户B的对话</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">配置泄露</strong>：用户A不能使用用户B的API配置</li>
</ul>
<h3 id="消息创建策略：先创建不保存" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#消息创建策略：先创建不保存" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 消息创建策略：先创建不保存">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            消息创建策略：先创建不保存
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E6%B6%88%E6%81%AF%EF%BC%88%E4%BD%86%E6%9A%82%E6%97%B6%E4%B8%8D%E4%BF%9D%E5%AD%98%EF%BC%89%0AConversationMessageDO%20userMessageDO%20%3D%20new%20ConversationMessageDO()%0A.setConversationId(conversationId)%0A.setConfigId(configId)%0A.setRole(%22user%22)%0A.setContent(userMessage)%3B%0A%2F%2F%20%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%AF%9D%E4%B8%AD%E7%9A%84%E5%8E%86%E5%8F%B2%E6%B6%88%E6%81%AF%0AList%20previousMessages%20%3D%20list(new%20LambdaQueryWrapper()%0A.eq(ConversationMessageDO%3A%3AgetConversationId%2C%20conversationId)%0A.orderByAsc(ConversationMessageDO%3A%3AgetCreateTime))%3B%0A%2F%2F%20%E7%94%9F%E6%88%90%E5%8A%A9%E6%89%8B%E5%9B%9E%E5%A4%8D%0AConversationMessageDO%20assistantMessageDO%20%3D%20generateAssistantResponse(userMessage%2C%20config%2C%20conversationId%2C%20configId%2C%20previousMessages)%3B%0A%2F%2F%20%E5%A6%82%E6%9E%9C%E6%89%A7%E8%A1%8C%E5%88%B0%E8%BF%99%E9%87%8C%EF%BC%8C%E8%AF%B4%E6%98%8EAPI%E8%B0%83%E7%94%A8%E6%88%90%E5%8A%9F%EF%BC%8C%E7%8E%B0%E5%9C%A8%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E6%B6%88%E6%81%AF%0Asave(userMessageDO)%3B%0Asave(assistantMessageDO)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 创建用户消息（但暂时不保存）</span>
<span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">userMessageDO</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ConversationMessageDO</span>()
        .setConversationId(conversationId)
        .setConfigId(configId)
        .setRole(<span class="hljs-string inline">&quot;user&quot;</span>)
        .setContent(userMessage);

<span class="hljs-comment inline">// 获取对话中的历史消息</span>
List&lt;ConversationMessageDO&gt; previousMessages = list(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">LambdaQueryWrapper</span>&lt;ConversationMessageDO&gt;()
        .eq(ConversationMessageDO::getConversationId, conversationId)
        .orderByAsc(ConversationMessageDO::getCreateTime));

<span class="hljs-comment inline">// 生成助手回复</span>
<span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">assistantMessageDO</span> <span class="hljs-operator inline">=</span> generateAssistantResponse(userMessage, config, conversationId, configId, previousMessages);

<span class="hljs-comment inline">// 如果执行到这里，说明API调用成功，现在保存用户消息</span>
save(userMessageDO);
save(assistantMessageDO);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">为什么先创建用户消息但不保存</strong>？</p>
<p class="text-base leading-7 mb-4 text-foreground">这是一种事务性设计模式，遵循&quot;要么全成功，要么全失败&quot;的原则：</p>
<p class="text-base leading-7 mb-4 text-foreground">错误的做法：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9D%8C%20%E5%85%88%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E6%B6%88%E6%81%AF%EF%BC%8C%E5%A6%82%E6%9E%9CAPI%E8%B0%83%E7%94%A8%E5%A4%B1%E8%B4%A5%EF%BC%8C%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4%0Asave(userMessageDO)%3B%0Atry%20%7B%0AConversationMessageDO%20response%20%3D%20callAPI(...)%3B%0Asave(response)%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0A%2F%2F%20%E7%94%A8%E6%88%B7%E6%B6%88%E6%81%AF%E5%B7%B2%E4%BF%9D%E5%AD%98%EF%BC%8C%E4%BD%86%E6%B2%A1%E6%9C%89%E5%9B%9E%E5%A4%8D%20-%20%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4%EF%BC%81%0Athrow%20e%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ❌ 先保存用户消息，如果API调用失败，数据不一致</span>
save(userMessageDO);
<span class="hljs-keyword inline">try</span> {
    <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">response</span> <span class="hljs-operator inline">=</span> callAPI(...);
    save(response);
} <span class="hljs-keyword inline">catch</span> (Exception e) {
    <span class="hljs-comment inline">// 用户消息已保存，但没有回复 - 数据不一致！</span>
    <span class="hljs-keyword inline">throw</span> e;
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">正确的做法：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9C%85%20%E5%85%88%E5%B0%9D%E8%AF%95API%E8%B0%83%E7%94%A8%EF%BC%8C%E6%88%90%E5%8A%9F%E5%90%8E%E5%86%8D%E6%89%B9%E9%87%8F%E4%BF%9D%E5%AD%98%0AConversationMessageDO%20userMessageDO%20%3D%20createUserMessage(...)%3B%0AConversationMessageDO%20assistantResponse%20%3D%20callAPI(...)%3B%0A%2F%2F%20API%E6%88%90%E5%8A%9F%EF%BC%8C%E6%89%B9%E9%87%8F%E4%BF%9D%E5%AD%98%0Asave(userMessageDO)%3B%0Asave(assistantResponse)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ✅ 先尝试API调用，成功后再批量保存</span>
<span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">userMessageDO</span> <span class="hljs-operator inline">=</span> createUserMessage(...);
<span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">assistantResponse</span> <span class="hljs-operator inline">=</span> callAPI(...);
<span class="hljs-comment inline">// API成功，批量保存</span>
save(userMessageDO);
save(assistantResponse);
</code></pre>
            </div>
        
<h3 id="generateassistantresponse：http调用的核心引擎" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#generateassistantresponse：http调用的核心引擎" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to generateAssistantResponse：HTTP调用的核心引擎">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            generateAssistantResponse：HTTP调用的核心引擎
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="private%20ConversationMessageDO%20generateAssistantResponse(%0AString%20userMessage%2C%0AUserConfigDO%20config%2C%0ALong%20conversationId%2C%0ALong%20configId%2C%0AList%20conversationMessages)%20%7B%0A%2F%2F%20%E4%BD%BF%E7%94%A8%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95%E5%87%86%E5%A4%87%E5%8C%85%E5%90%AB%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%E7%9A%84%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%0AMap%20requestData%20%3D%20HttpUtils.prepareRequestData(config%2C%20userMessage%2C%20conversationMessages)%3B%0AMap%20headers%20%3D%20(Map)%20requestData.get(%22headers%22)%3B%0AMap%20requestBody%20%3D%20(Map)%20requestData.get(%22requestBody%22)%3B%0A%2F%2F%20%E6%89%A7%E8%A1%8C%E5%AE%9E%E9%99%85%E7%9A%84HTTP%E8%AF%B7%E6%B1%82%0AString%20requestBodyStr%20%3D%20JsonUtils.toJsonString(requestBody)%3B%0AString%20responseStr%20%3D%20HttpUtils.post(config.getApiUrl()%2C%20headers%2C%20requestBodyStr)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">private</span> ConversationMessageDO <span class="hljs-title function_ inline">generateAssistantResponse</span><span class="hljs-params inline">(
        String userMessage,
        UserConfigDO config,
        Long conversationId,
        Long configId,
        List&lt;ConversationMessageDO&gt; conversationMessages)</span> {

    <span class="hljs-comment inline">// 使用通用方法准备包含对话历史的请求数据</span>
    Map&lt;String, Object&gt; requestData = HttpUtils.prepareRequestData(config, userMessage, conversationMessages);
    Map&lt;String, String&gt; headers = (Map&lt;String, String&gt;) requestData.get(<span class="hljs-string inline">&quot;headers&quot;</span>);
    Map&lt;String, Object&gt; requestBody = (Map&lt;String, Object&gt;) requestData.get(<span class="hljs-string inline">&quot;requestBody&quot;</span>);

    <span class="hljs-comment inline">// 执行实际的HTTP请求</span>
    <span class="hljs-type inline">String</span> <span class="hljs-variable inline">requestBodyStr</span> <span class="hljs-operator inline">=</span> JsonUtils.toJsonString(requestBody);
    <span class="hljs-type inline">String</span> <span class="hljs-variable inline">responseStr</span> <span class="hljs-operator inline">=</span> HttpUtils.post(config.getApiUrl(), headers, requestBodyStr);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">HTTP请求的完整数据流</strong>：</p>
<div class="mermaid block" id="mermaid-1767322174127-fx6cdnn">sequenceDiagram
    participant Service as ConversationService
    participant Utils as HttpUtils
    participant API as AI_API
    participant Parser as JsonUtils

    Service->>Utils: prepareRequestData(config, message, history)
    Utils->>Utils: 解密API密钥
    Utils->>Utils: 构建请求头
    Utils->>Utils: 构建请求体
    Utils-->>Service: {headers, requestBody}
    
    Service->>Parser: toJsonString(requestBody)
    Parser-->>Service: requestBodyStr
    
    Service->>Utils: post(url, headers, body)
    Utils->>API: HTTP POST
    API-->>Utils: JSON Response
    Utils-->>Service: responseStr
    
    Service->>Parser: parseObject(responseStr)
    Parser-->>Service: responseMap
    
    Service->>Parser: extractValueFromPath(responseMap, textPath)
    Parser-->>Service: content</div>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">响应解析的双路径设计</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%AE%9A%E8%B7%AF%E5%BE%84%E4%BB%8E%E5%93%8D%E5%BA%94%E4%B8%AD%E6%8F%90%E5%8F%96%E5%86%85%E5%AE%B9%E5%92%8C%E6%80%9D%E8%80%83%E6%96%87%E6%9C%AC%0AString%20content%20%3D%20null%3B%0AString%20thinking%20%3D%20null%3B%0Aif%20(StringUtils.hasText(config.getResponseTextPath()))%20%7B%0Acontent%20%3D%20JsonUtils.extractValueFromPath(responseMap%2C%20config.getResponseTextPath())%3B%0A%7D%0Aif%20(StringUtils.hasText(config.getResponseThinkingTextPath()))%20%7B%0Athinking%20%3D%20JsonUtils.extractValueFromPath(responseMap%2C%20config.getResponseThinkingTextPath())%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 使用指定路径从响应中提取内容和思考文本</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">content</span> <span class="hljs-operator inline">=</span> <span class="hljs-literal inline">null</span>;
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">thinking</span> <span class="hljs-operator inline">=</span> <span class="hljs-literal inline">null</span>;

<span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getResponseTextPath())) {
    content = JsonUtils.extractValueFromPath(responseMap, config.getResponseTextPath());
}

<span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getResponseThinkingTextPath())) {
    thinking = JsonUtils.extractValueFromPath(responseMap, config.getResponseThinkingTextPath());
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">这种设计支持不同服务商的响应格式：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%2F%2F%20OpenAI%E6%A0%BC%E5%BC%8F%0A%7B%0A%22choices%22%3A%20%5B%0A%7B%0A%22message%22%3A%20%7B%0A%22content%22%3A%20%22%E8%BF%99%E6%98%AF%E5%9B%9E%E5%A4%8D%E5%86%85%E5%AE%B9%22%0A%7D%0A%7D%0A%5D%0A%7D%0A%2F%2F%20%E8%B7%AF%E5%BE%84%3A%20%22choices.0.message.content%22%0A%2F%2F%20Claude%E6%A0%BC%E5%BC%8F%0A%7B%0A%22content%22%3A%20%5B%0A%7B%0A%22text%22%3A%20%22%E8%BF%99%E6%98%AF%E5%9B%9E%E5%A4%8D%E5%86%85%E5%AE%B9%22%0A%7D%0A%5D%0A%7D%0A%2F%2F%20%E8%B7%AF%E5%BE%84%3A%20%22content.0.text%22%0A%2F%2F%20%E6%94%AF%E6%8C%81%E6%80%9D%E8%80%83%E8%BF%87%E7%A8%8B%E7%9A%84%E6%A0%BC%E5%BC%8F%0A%7B%0A%22response%22%3A%20%7B%0A%22content%22%3A%20%22%E8%BF%99%E6%98%AF%E5%9B%9E%E5%A4%8D%E5%86%85%E5%AE%B9%22%2C%0A%22thinking%22%3A%20%22%E8%BF%99%E6%98%AF%E6%80%9D%E8%80%83%E8%BF%87%E7%A8%8B%22%0A%7D%0A%7D%0A%2F%2F%20%E5%86%85%E5%AE%B9%E8%B7%AF%E5%BE%84%3A%20%22response.content%22%0A%2F%2F%20%E6%80%9D%E8%80%83%E8%B7%AF%E5%BE%84%3A%20%22response.thinking%22">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-comment inline">// OpenAI格式</span>
<span class="hljs-punctuation inline">{</span>
  <span class="hljs-attr inline">&quot;choices&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>
    <span class="hljs-punctuation inline">{</span>
      <span class="hljs-attr inline">&quot;message&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
        <span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;这是回复内容&quot;</span>
      <span class="hljs-punctuation inline">}</span>
    <span class="hljs-punctuation inline">}</span>
  <span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-comment inline">// 路径: &quot;choices.0.message.content&quot;</span>

<span class="hljs-comment inline">// Claude格式  </span>
<span class="hljs-punctuation inline">{</span>
  <span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>
    <span class="hljs-punctuation inline">{</span>
      <span class="hljs-attr inline">&quot;text&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;这是回复内容&quot;</span>
    <span class="hljs-punctuation inline">}</span>
  <span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-comment inline">// 路径: &quot;content.0.text&quot;</span>

<span class="hljs-comment inline">// 支持思考过程的格式</span>
<span class="hljs-punctuation inline">{</span>
  <span class="hljs-attr inline">&quot;response&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
    <span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;这是回复内容&quot;</span><span class="hljs-punctuation inline">,</span>
    <span class="hljs-attr inline">&quot;thinking&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;这是思考过程&quot;</span>
  <span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-comment inline">// 内容路径: &quot;response.content&quot;  </span>
<span class="hljs-comment inline">// 思考路径: &quot;response.thinking&quot;</span>
</code></pre>
            </div>
        
<h3 id="事务管理与缓存策略" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#事务管理与缓存策略" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 事务管理与缓存策略">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            事务管理与缓存策略
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40Override%0A%40Transactional%0A%40Caching(evict%20%3D%20%7B%0A%40CacheEvict(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0A%7D)">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@Override</span>
<span class="hljs-meta inline">@Transactional</span>
<span class="hljs-meta inline">@Caching(evict = {
        @CacheEvict(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)
})</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">@Transactional的回滚机制</strong>：</p>
<p class="text-base leading-7 mb-4 text-foreground">Spring的事务管理确保数据一致性：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40Transactional%0Apublic%20ConversationMessageDO%20sendMessage(...)%20%7B%0Atry%20%7B%0A%2F%2F%201.%20%E9%AA%8C%E8%AF%81%E6%9D%83%E9%99%90%0AvalidatePermissions()%3B%0A%2F%2F%202.%20%E8%B0%83%E7%94%A8API%0AConversationMessageDO%20response%20%3D%20callAPI()%3B%0A%2F%2F%203.%20%E4%BF%9D%E5%AD%98%E6%B6%88%E6%81%AF%0Asave(userMessage)%3B%0Asave(response)%3B%0A%2F%2F%204.%20%E6%9B%B4%E6%96%B0%E5%AF%B9%E8%AF%9D%E6%97%B6%E9%97%B4%0AupdateConversation()%3B%0Areturn%20response%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0A%2F%2F%20%E4%BB%BB%E4%BD%95%E5%BC%82%E5%B8%B8%E9%83%BD%E4%BC%9A%E8%A7%A6%E5%8F%91%E5%9B%9E%E6%BB%9A%EF%BC%8C%E4%BF%9D%E8%AF%81%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%0Athrow%20e%3B%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@Transactional</span>
<span class="hljs-keyword inline">public</span> ConversationMessageDO <span class="hljs-title function_ inline">sendMessage</span><span class="hljs-params inline">(...)</span> {
    <span class="hljs-keyword inline">try</span> {
        <span class="hljs-comment inline">// 1. 验证权限</span>
        validatePermissions();
        
        <span class="hljs-comment inline">// 2. 调用API  </span>
        <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">response</span> <span class="hljs-operator inline">=</span> callAPI();
        
        <span class="hljs-comment inline">// 3. 保存消息</span>
        save(userMessage);
        save(response);
        
        <span class="hljs-comment inline">// 4. 更新对话时间</span>
        updateConversation();
        
        <span class="hljs-keyword inline">return</span> response;
    } <span class="hljs-keyword inline">catch</span> (Exception e) {
        <span class="hljs-comment inline">// 任何异常都会触发回滚，保证数据一致性</span>
        <span class="hljs-keyword inline">throw</span> e;
    }
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">缓存失效策略的考虑</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40CacheEvict(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@CacheEvict(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">这个注解确保在新消息产生时，相关的缓存被清除。缓存键的设计考虑了：</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">对话隔离</strong>：不同对话的缓存独立</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">用户隔离</strong>：不同用户的缓存独立</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">精确失效</strong>：只清除相关缓存，不影响其他数据</li>
</ul>
<h3 id="配置监控：markconfigurationasavailable" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#配置监控：markconfigurationasavailable" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 配置监控：markConfigurationAsAvailable">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            配置监控：markConfigurationAsAvailable
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E6%A0%87%E8%AE%B0%E9%85%8D%E7%BD%AE%E4%B8%BA%E5%8F%AF%E7%94%A8%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%B7%B2%E6%88%90%E5%8A%9F%E4%BD%BF%E7%94%A8%0AmarkConfigurationAsAvailable(configId%2C%20userId)%3B%0A%40Override%0Apublic%20boolean%20markConfigurationAsAvailable(Long%20configId%2C%20Long%20userId)%20%7B%0AUserConfigDO%20config%20%3D%20userConfigService.getConfig(configId%2C%20userId)%3B%0Aif%20(config%20%3D%3D%20null)%20%7B%0Areturn%20false%3B%0A%7D%0A%2F%2F%20%E5%B0%86isAvailable%E8%AE%BE%E7%BD%AE%E4%B8%BAtrue%E5%B9%B6%E8%AE%BE%E7%BD%AElastUsedTime%E4%B8%BA%E5%BD%93%E5%89%8D%E6%97%B6%E9%97%B4%0AuserConfigService.setAvailableAndUpdateLastUsedTime(configId%2C%20true)%3B%0Areturn%20true%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 标记配置为可用，因为已成功使用</span>
markConfigurationAsAvailable(configId, userId);

<span class="hljs-meta inline">@Override</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">markConfigurationAsAvailable</span><span class="hljs-params inline">(Long configId, Long userId)</span> {
    <span class="hljs-type inline">UserConfigDO</span> <span class="hljs-variable inline">config</span> <span class="hljs-operator inline">=</span> userConfigService.getConfig(configId, userId);
    <span class="hljs-keyword inline">if</span> (config == <span class="hljs-literal inline">null</span>) {
        <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">false</span>;
    }

    <span class="hljs-comment inline">// 将isAvailable设置为true并设置lastUsedTime为当前时间</span>
    userConfigService.setAvailableAndUpdateLastUsedTime(configId, <span class="hljs-literal inline">true</span>);

    <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">true</span>;
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">可用性标记的业务价值</strong>：</p>
<p class="text-base leading-7 mb-4 text-foreground">这个看似简单的操作实际上承载了重要的业务逻辑：</p>
<ol class="list-decimal list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">健康检查</strong>：成功的API调用证明配置可用</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">使用统计</strong>：记录最后使用时间，便于分析</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">自动修复</strong>：将之前标记为不可用的配置重新激活</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">用户体验</strong>：让用户知道哪些配置是可用的</li>
</ol>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">lastUsedTime的统计价值</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="sql" data-code="--%20%E5%8F%AF%E4%BB%A5%E5%88%86%E6%9E%90%E7%94%A8%E6%88%B7%E7%9A%84%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%BC%8F%0ASELECT%20configId%2C%20COUNT(*)%20as%20usage_count%2C%0AMAX(lastUsedTime)%20as%20last_used%2C%0AAVG(TIMESTAMPDIFF(SECOND%2C%20createTime%2C%20lastUsedTime))%20as%20avg_response_time%0AFROM%20user_config%0AWHERE%20userId%20%3D%20%3F%0AGROUP%20BY%20configId%0AORDER%20BY%20usage_count%20DESC%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">sql</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-sql"><span class="hljs-comment inline">-- 可以分析用户的使用模式</span>
<span class="hljs-keyword inline">SELECT</span> configId, <span class="hljs-built_in inline">COUNT</span>(<span class="hljs-operator inline">*</span>) <span class="hljs-keyword inline">as</span> usage_count, 
       <span class="hljs-built_in inline">MAX</span>(lastUsedTime) <span class="hljs-keyword inline">as</span> last_used,
       <span class="hljs-built_in inline">AVG</span>(TIMESTAMPDIFF(<span class="hljs-keyword inline">SECOND</span>, createTime, lastUsedTime)) <span class="hljs-keyword inline">as</span> avg_response_time
<span class="hljs-keyword inline">FROM</span> user_config 
<span class="hljs-keyword inline">WHERE</span> userId <span class="hljs-operator inline">=</span> ? 
<span class="hljs-keyword inline">GROUP</span> <span class="hljs-keyword inline">BY</span> configId
<span class="hljs-keyword inline">ORDER</span> <span class="hljs-keyword inline">BY</span> usage_count <span class="hljs-keyword inline">DESC</span>;
</code></pre>
            </div>
        
<h2 id="json路径解析引擎篇：jsonutils的深度算法解析" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#json路径解析引擎篇：jsonutils的深度算法解析" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to JSON路径解析引擎篇：JsonUtils的深度算法解析">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            JSON路径解析引擎篇：JsonUtils的深度算法解析
        </h2>
<p class="text-base leading-7 mb-4 text-foreground"><del class="line-through opacity-60">最难的一集。</del></p>
<h3 id="路径解析的数学模型" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#路径解析的数学模型" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 路径解析的数学模型">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            路径解析的数学模型
        </h3>
<p class="text-base leading-7 mb-4 text-foreground">JSON路径解析本质上是一个<strong class="font-bold text-foreground">树遍历问题</strong>，我们需要将字符串路径转换为对象访问序列。</p>
<p class="text-base leading-7 mb-4 text-foreground">给定路径 <code>path = &quot;a.b[0].c.d[1].e&quot;</code>，解析算法可以表示为：</p>
<p class="text-base leading-7 mb-4 text-foreground"><span class="katex-display inline"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>T</mi><mi>r</mi><mi>a</mi><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>a</mi><mi>l</mi><mo stretchy="false">(</mo><mi>o</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo separator="true">,</mo><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>n</mi></munderover><mi>A</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mi>o</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><msub><mi>t</mi><mi>i</mi></msub><mo separator="true">,</mo><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><msub><mi>n</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">PathTraversal(object, path) = \prod_{i=0}^{n} Access(object_i, token_i)</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.13889em;">P</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">h</span><span class="mord mathnormal inline" style="margin-right:0.13889em;">T</span><span class="mord mathnormal inline" style="margin-right:0.02778em;">r</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline" style="margin-right:0.03588em;">v</span><span class="mord mathnormal inline">ers</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline" style="margin-right:0.01968em;">l</span><span class="mopen inline">(</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.05724em;">bj</span><span class="mord mathnormal inline">ec</span><span class="mord mathnormal inline">t</span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">h</span><span class="mclose inline">)</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;" class="inline"><span class="pstrut inline" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline"><span class="mord mathnormal mtight inline">i</span><span class="mrel mtight inline">=</span><span class="mord mtight inline">0</span></span></span></span><span style="top:-3.05em;" class="inline"><span class="pstrut inline" style="height:3.05em;"></span><span class="inline"><span class="mop op-symbol large-op inline">∏</span></span></span><span style="top:-4.3em;margin-left:0em;" class="inline"><span class="pstrut inline" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline"><span class="mord mathnormal mtight inline">n</span></span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:1.2777em;"><span class="inline"></span></span></span></span></span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline">A</span><span class="mord mathnormal inline">ccess</span><span class="mopen inline">(</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.05724em;">bj</span><span class="mord mathnormal inline">ec</span><span class="mord inline"><span class="mord mathnormal inline">t</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mathnormal mtight inline">i</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.03148em;">k</span><span class="mord mathnormal inline">e</span><span class="mord inline"><span class="mord mathnormal inline">n</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mathnormal mtight inline">i</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mclose inline">)</span></span></span></span></span></p>
<p class="text-base leading-7 mb-4 text-foreground">其中：</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><msub><mi>n</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">token_i</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.03148em;">k</span><span class="mord mathnormal inline">e</span><span class="mord inline"><span class="mord mathnormal inline">n</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mathnormal mtight inline">i</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span></span></span></span> 是路径中的第i个访问标记</li>
<li class="text-foreground leading-relaxed"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">Access</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.6833em;"></span><span class="mord mathnormal inline">A</span><span class="mord mathnormal inline">ccess</span></span></span></span> 函数根据标记类型选择不同的访问策略</li>
</ul>
<h3 id="extractvaluefrompath：路径提取的核心算法" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#extractvaluefrompath：路径提取的核心算法" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to extractValueFromPath：路径提取的核心算法">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            extractValueFromPath：路径提取的核心算法
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="public%20static%20String%20extractValueFromPath(Map%20data%2C%20String%20path)%20%7B%0AString%5B%5D%20parts%20%3D%20path.split(%22%5C%5C.%22)%3B%20%20%2F%2F%20%E6%8C%89%E7%82%B9%E5%8F%B7%E5%88%86%E5%89%B2%E8%B7%AF%E5%BE%84%0AObject%20current%20%3D%20data%3B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93%E5%89%8D%E9%81%8D%E5%8E%86%E7%9A%84%E5%AF%B9%E8%B1%A1%0Afor%20(String%20part%20%3A%20parts)%20%7B%0Aif%20(current%20%3D%3D%20null)%20%7B%0Areturn%20null%3B%20%20%2F%2F%20%E9%98%B2%E5%BE%A1%E6%80%A7%E6%A3%80%E6%9F%A5%EF%BC%9A%E4%B8%AD%E9%80%94%E9%81%87%E5%88%B0null%E7%AB%8B%E5%8D%B3%E8%BF%94%E5%9B%9E%0A%7D%0A%2F%2F%20%E5%A4%84%E7%90%86%E6%95%B0%E7%BB%84%E8%A1%A8%E7%A4%BA%E6%B3%95%EF%BC%8C%E5%A6%82%20choices%5B0%5D%0Aif%20(part.contains(%22%5B%22)%20%26%26%20part.contains(%22%5D%22))%20%7B%0A%2F%2F%20%E7%AE%97%E6%B3%95%E6%A0%B8%E5%BF%83%EF%BC%9A%E8%A7%A3%E6%9E%90%E6%95%B0%E7%BB%84%E5%90%8D%E7%A7%B0%E5%92%8C%E7%B4%A2%E5%BC%95%0AString%20arrayName%20%3D%20part.substring(0%2C%20part.indexOf('%5B'))%3B%0Aint%20index%20%3D%20Integer.parseInt(part.substring(part.indexOf('%5B')%20%2B%201%2C%20part.indexOf('%5D')))%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">extractValueFromPath</span><span class="hljs-params inline">(Map&lt;String, Object&gt; data, String path)</span> {
    String[] parts = path.split(<span class="hljs-string inline">&quot;\\.&quot;</span>);  <span class="hljs-comment inline">// 按点号分割路径</span>
    <span class="hljs-type inline">Object</span> <span class="hljs-variable inline">current</span> <span class="hljs-operator inline">=</span> data;              <span class="hljs-comment inline">// 当前遍历的对象</span>

    <span class="hljs-keyword inline">for</span> (String part : parts) {
        <span class="hljs-keyword inline">if</span> (current == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// 防御性检查：中途遇到null立即返回</span>
        }

        <span class="hljs-comment inline">// 处理数组表示法，如 choices[0]</span>
        <span class="hljs-keyword inline">if</span> (part.contains(<span class="hljs-string inline">&quot;[&quot;</span>) &amp;&amp; part.contains(<span class="hljs-string inline">&quot;]&quot;</span>)) {
            <span class="hljs-comment inline">// 算法核心：解析数组名称和索引</span>
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> part.substring(<span class="hljs-number inline">0</span>, part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>));
            <span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(part.substring(part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>) + <span class="hljs-number inline">1</span>, part.indexOf(<span class="hljs-string inline">&#x27;]&#x27;</span>)));
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">数组索引解析的算法分析</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E6%9E%90%E7%9A%84%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%88%86%E6%9E%90%0A%2F%2F%20part%20%3D%20%22choices%5B0%5D%22%0AString%20arrayName%20%3D%20part.substring(0%2C%20part.indexOf('%5B'))%3B%20%20%20%20%2F%2F%20O(n)%0Aint%20index%20%3D%20Integer.parseInt(part.substring(...))%3B%20%20%20%20%20%20%20%20%20%20%2F%2F%20O(1)">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 字符串解析的时间复杂度分析</span>
<span class="hljs-comment inline">// part = &quot;choices[0]&quot;</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> part.substring(<span class="hljs-number inline">0</span>, part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>));    <span class="hljs-comment inline">// O(n)</span>
<span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(part.substring(...));          <span class="hljs-comment inline">// O(1)</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">类型安全的访问策略</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="if%20(current%20instanceof%20Map)%20%7B%0AMap%20map%20%3D%20(Map)%20current%3B%0Aif%20(map.containsKey(arrayName)%20%26%26%20map.get(arrayName)%20instanceof%20List)%20%7B%0AList%20array%20%3D%20(List)%20map.get(arrayName)%3B%0Aif%20(index%20%2F%2F%20%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%0A%7D%20else%20%7B%0Areturn%20null%3B%20%20%2F%2F%20%E7%B4%A2%E5%BC%95%E8%B6%8A%E7%95%8C%EF%BC%8C%E8%BF%94%E5%9B%9Enull%0A%7D%0A%7D%20else%20%7B%0Areturn%20null%3B%20%20%2F%2F%20%E5%AD%97%E6%AE%B5%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%88%96%E7%B1%BB%E5%9E%8B%E4%B8%8D%E5%8C%B9%E9%85%8D%0A%7D%0A%7D%20else%20%7B%0Areturn%20null%3B%20%20%2F%2F%20%E5%BD%93%E5%89%8D%E5%AF%B9%E8%B1%A1%E4%B8%8D%E6%98%AFMap%E7%B1%BB%E5%9E%8B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">if</span> (current <span class="hljs-keyword inline">instanceof</span> Map) {
    Map&lt;String, Object&gt; map = (Map&lt;String, Object&gt;) current;
    <span class="hljs-keyword inline">if</span> (map.containsKey(arrayName) &amp;&amp; map.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List) {
        List&lt;Object&gt; array = (List&lt;Object&gt;) map.get(arrayName);
        <span class="hljs-keyword inline">if</span> (index &lt; array.size()) {
            current = array.get(index);  <span class="hljs-comment inline">// 安全访问数组元素</span>
        } <span class="hljs-keyword inline">else</span> {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// 索引越界，返回null</span>
        }
    } <span class="hljs-keyword inline">else</span> {
        <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// 字段不存在或类型不匹配</span>
    }
} <span class="hljs-keyword inline">else</span> {
    <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// 当前对象不是Map类型</span>
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">为什么需要这么多类型检查</strong>？</p>
<p class="text-base leading-7 mb-4 text-foreground">在动态类型的JSON世界中，我们无法保证数据结构的一致性：</p>
<p class="text-base leading-7 mb-4 text-foreground">错误的做法：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9D%8C%20%E5%8D%B1%E9%99%A9%E7%9A%84%E7%9B%B4%E6%8E%A5%E8%AE%BF%E9%97%AE%0AList%20array%20%3D%20(List)%20((Map)%20current).get(arrayName)%3B%0Acurrent%20%3D%20array.get(index)%3B%20%20%2F%2F%20%E5%8F%AF%E8%83%BD%E6%8A%9B%E5%87%BANullPointerException%E3%80%81ClassCastException%E3%80%81IndexOutOfBoundsException">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ❌ 危险的直接访问</span>
List&lt;Object&gt; array = (List&lt;Object&gt;) ((Map) current).get(arrayName);
current = array.get(index);  <span class="hljs-comment inline">// 可能抛出NullPointerException、ClassCastException、IndexOutOfBoundsException</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">正确的做法：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9C%85%20%E5%A4%9A%E9%87%8D%E9%98%B2%E6%8A%A4%E6%A3%80%E6%9F%A5%0Aif%20(current%20instanceof%20Map)%20%7B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%9F%A5%0AMap%20map%20%3D%20(Map)%20current%3B%0Aif%20(map.containsKey(arrayName)%20%26%26%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%AD%98%E5%9C%A8%E6%80%A7%E6%A3%80%E6%9F%A5%0Amap.get(arrayName)%20instanceof%20List)%20%7B%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%9F%A5%0AList%20array%20%3D%20(List)%20map.get(arrayName)%3B%0Aif%20(index%20%2F%2F%20%E8%BE%B9%E7%95%8C%E6%A3%80%E6%9F%A5%0Acurrent%20%3D%20array.get(index)%3B%0A%7D%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ✅ 多重防护检查</span>
<span class="hljs-keyword inline">if</span> (current <span class="hljs-keyword inline">instanceof</span> Map) {                           <span class="hljs-comment inline">// 类型检查</span>
    Map&lt;String, Object&gt; map = (Map&lt;String, Object&gt;) current;
    <span class="hljs-keyword inline">if</span> (map.containsKey(arrayName) &amp;&amp;                   <span class="hljs-comment inline">// 存在性检查</span>
        map.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List) {            <span class="hljs-comment inline">// 类型检查</span>
        List&lt;Object&gt; array = (List&lt;Object&gt;) map.get(arrayName);
        <span class="hljs-keyword inline">if</span> (index &lt; array.size()) {                      <span class="hljs-comment inline">// 边界检查</span>
            current = array.get(index);
        }
    }
}
</code></pre>
            </div>
        
<h3 id="setvaluebypath：路径设置的智能构建" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#setvaluebypath：路径设置的智能构建" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to setValueByPath：路径设置的智能构建">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            setValueByPath：路径设置的智能构建
        </h3>
<p class="text-base leading-7 mb-4 text-foreground">相比于<code>extractValueFromPath</code>的只读访问，<code>setValueByPath</code>需要解决更复杂的问题：<strong class="font-bold text-foreground">如何在不完整的JSON结构中智能构建路径</strong>。</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="public%20static%20void%20setValueByPath(Map%20data%2C%20String%20path%2C%20Object%20value)%20%7B%0AString%5B%5D%20parts%20%3D%20path.split(%22%5C%5C.%22)%3B%0AMap%20current%20%3D%20data%3B%0A%2F%2F%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E9%81%8D%E5%8E%86%E8%B7%AF%E5%BE%84%EF%BC%8C%E7%A1%AE%E4%BF%9D%E4%B8%AD%E9%97%B4%E7%BB%93%E6%9E%84%E5%AD%98%E5%9C%A8%0Afor%20(int%20i%20%3D%200%3B%20i%201%3B%20i%2B%2B)%20%7B%0AString%20part%20%3D%20parts%5Bi%5D%3B%0A%2F%2F%20%E5%A4%84%E7%90%86%E6%95%B0%E7%BB%84%E8%B7%AF%E5%BE%84%E6%AE%B5%0Aif%20(part.contains(%22%5B%22)%20%26%26%20part.contains(%22%5D%22))%20%7B%0AString%20arrayName%20%3D%20part.substring(0%2C%20part.indexOf('%5B'))%3B%0Aint%20index%20%3D%20Integer.parseInt(part.substring(part.indexOf('%5B')%20%2B%201%2C%20part.indexOf('%5D')))%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">setValueByPath</span><span class="hljs-params inline">(Map&lt;String, Object&gt; data, String path, Object value)</span> {
    String[] parts = path.split(<span class="hljs-string inline">&quot;\\.&quot;</span>);
    Map&lt;String, Object&gt; current = data;

    <span class="hljs-comment inline">// 步骤1：遍历路径，确保中间结构存在</span>
    <span class="hljs-keyword inline">for</span> (<span class="hljs-type inline">int</span> <span class="hljs-variable inline">i</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">0</span>; i &lt; parts.length - <span class="hljs-number inline">1</span>; i++) {
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">part</span> <span class="hljs-operator inline">=</span> parts[i];

        <span class="hljs-comment inline">// 处理数组路径段</span>
        <span class="hljs-keyword inline">if</span> (part.contains(<span class="hljs-string inline">&quot;[&quot;</span>) &amp;&amp; part.contains(<span class="hljs-string inline">&quot;]&quot;</span>)) {
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> part.substring(<span class="hljs-number inline">0</span>, part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>));
            <span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(part.substring(part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>) + <span class="hljs-number inline">1</span>, part.indexOf(<span class="hljs-string inline">&#x27;]&#x27;</span>)));
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">智能数组构建算法</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E5%A6%82%E6%9E%9C%E6%95%B0%E7%BB%84%E4%B8%8D%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%88%9B%E5%BB%BA%E6%96%B0%E6%95%B0%E7%BB%84%0Aif%20(!current.containsKey(arrayName)%20%7C%7C%20!(current.get(arrayName)%20instanceof%20List))%20%7B%0Acurrent.put(arrayName%2C%20new%20ArrayList())%3B%0A%7D%0AList%20array%20%3D%20(List)%20current.get(arrayName)%3B%0A%2F%2F%20%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95%EF%BC%9A%E6%95%B0%E7%BB%84%E6%89%A9%E5%AE%B9%E7%A1%AE%E4%BF%9D%E7%B4%A2%E5%BC%95%E5%8F%AF%E8%AE%BF%E9%97%AE%0Awhile%20(array.size()%20new%20HashMap())%3B%20%20%2F%2F%20%E7%94%A8%E7%A9%BA%E5%AF%B9%E8%B1%A1%E5%A1%AB%E5%85%85%0A%7D%0A%2F%2F%20%E7%A1%AE%E4%BF%9D%E7%B4%A2%E5%BC%95%E4%BD%8D%E7%BD%AE%E6%98%AFMap%E5%AF%B9%E8%B1%A1%EF%BC%88%E4%B8%BA%E4%B8%8B%E4%B8%80%E7%BA%A7%E8%B7%AF%E5%BE%84%E5%87%86%E5%A4%87%EF%BC%89%0Aif%20(!(array.get(index)%20instanceof%20Map))%20%7B%0Aarray.set(index%2C%20new%20HashMap())%3B%0A%7D%0Acurrent%20%3D%20(Map)%20array.get(index)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 如果数组不存在，创建新数组</span>
<span class="hljs-keyword inline">if</span> (!current.containsKey(arrayName) || !(current.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List)) {
    current.put(arrayName, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;());
}

List&lt;Object&gt; array = (List&lt;Object&gt;) current.get(arrayName);

<span class="hljs-comment inline">// 核心算法：数组扩容确保索引可访问</span>
<span class="hljs-keyword inline">while</span> (array.size() &lt;= index) {
    array.add(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;String, Object&gt;());  <span class="hljs-comment inline">// 用空对象填充</span>
}

<span class="hljs-comment inline">// 确保索引位置是Map对象（为下一级路径准备）</span>
<span class="hljs-keyword inline">if</span> (!(array.get(index) <span class="hljs-keyword inline">instanceof</span> Map)) {
    array.set(index, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;String, Object&gt;());
}

current = (Map&lt;String, Object&gt;) array.get(index);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">数组扩容的数学分析</strong>：</p>
<p class="text-base leading-7 mb-4 text-foreground">假设当前数组长度为 <span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.4306em;"></span><span class="mord mathnormal inline">n</span></span></span></span>，目标索引为 <span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.6944em;"></span><span class="mord mathnormal inline" style="margin-right:0.03148em;">k</span></span></span></span>，则：</p>
<p class="text-base leading-7 mb-4 text-foreground"><span class="katex-display inline"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>扩容次数</mtext><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi>k</mi><mo>−</mo><mi>n</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">扩容次数 = \max(0, k - n + 1)</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.6833em;"></span><span class="mord cjk_fallback inline">扩容次数</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mop inline">max</span><span class="mopen inline">(</span><span class="mord inline">0</span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline" style="margin-right:0.03148em;">k</span><span class="mspace inline" style="margin-right:0.2222em;"></span><span class="mbin inline">−</span><span class="mspace inline" style="margin-right:0.2222em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal inline">n</span><span class="mspace inline" style="margin-right:0.2222em;"></span><span class="mbin inline">+</span><span class="mspace inline" style="margin-right:0.2222em;"></span></span><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord inline">1</span><span class="mclose inline">)</span></span></span></span></span></p>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">为什么用HashMap填充而不是null</strong>？</p>
<p class="text-base leading-7 mb-4 text-foreground">这是一个设计权衡：</p>
<p class="text-base leading-7 mb-4 text-foreground">错误的做法：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9D%8C%20%E7%94%A8null%E5%A1%AB%E5%85%85%0Awhile%20(array.size()%20null)%3B%0A%7D%0A%2F%2F%20%E4%B8%8B%E4%B8%80%E6%AC%A1%E8%AE%BF%E9%97%AE%E6%97%B6%E5%8F%AF%E8%83%BD%E5%87%BA%E7%8E%B0NullPointerException">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ❌ 用null填充</span>
<span class="hljs-keyword inline">while</span> (array.size() &lt;= index) {
    array.add(<span class="hljs-literal inline">null</span>);
}
<span class="hljs-comment inline">// 下一次访问时可能出现NullPointerException</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">正确的做法：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9C%85%20%E7%94%A8%E7%A9%BA%E5%AF%B9%E8%B1%A1%E5%A1%AB%E5%85%85%0Awhile%20(array.size()%20new%20HashMap())%3B%0A%7D%0A%2F%2F%20%E7%A1%AE%E4%BF%9D%E5%90%8E%E7%BB%AD%E8%B7%AF%E5%BE%84%E5%8F%AF%E4%BB%A5%E7%BB%A7%E7%BB%AD%E6%9E%84%E5%BB%BA">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ✅ 用空对象填充</span>
<span class="hljs-keyword inline">while</span> (array.size() &lt;= index) {
    array.add(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;String, Object&gt;());
}
<span class="hljs-comment inline">// 确保后续路径可以继续构建</span>
</code></pre>
            </div>
        
<h3 id="路径解析的实际应用场景" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#路径解析的实际应用场景" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 路径解析的实际应用场景">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            路径解析的实际应用场景
        </h3>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">场景1：OpenAI响应解析</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%7B%0A%22choices%22%3A%20%5B%0A%7B%0A%22message%22%3A%20%7B%0A%22content%22%3A%20%22%E8%BF%99%E6%98%AFAI%E7%9A%84%E5%9B%9E%E5%A4%8D%22%2C%0A%22role%22%3A%20%22assistant%22%0A%7D%0A%7D%0A%5D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-punctuation inline">{</span>
  <span class="hljs-attr inline">&quot;choices&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>
    <span class="hljs-punctuation inline">{</span>
      <span class="hljs-attr inline">&quot;message&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
        <span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;这是AI的回复&quot;</span><span class="hljs-punctuation inline">,</span>
        <span class="hljs-attr inline">&quot;role&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;assistant&quot;</span>
      <span class="hljs-punctuation inline">}</span>
    <span class="hljs-punctuation inline">}</span>
  <span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>
</code></pre>
            </div>
        

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E6%8F%90%E5%8F%96%E5%9B%9E%E5%A4%8D%E5%86%85%E5%AE%B9%0AString%20content%20%3D%20JsonUtils.extractValueFromPath(response%2C%20%22choices%5B0%5D.message.content%22)%3B%0A%2F%2F%20%E7%BB%93%E6%9E%9C%EF%BC%9A%22%E8%BF%99%E6%98%AFAI%E7%9A%84%E5%9B%9E%E5%A4%8D%22">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 提取回复内容</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">content</span> <span class="hljs-operator inline">=</span> JsonUtils.extractValueFromPath(response, <span class="hljs-string inline">&quot;choices[0].message.content&quot;</span>);
<span class="hljs-comment inline">// 结果：&quot;这是AI的回复&quot;</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">场景2：Claude响应解析</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%7B%0A%22content%22%3A%20%5B%0A%7B%0A%22text%22%3A%20%22%E8%BF%99%E6%98%AFClaude%E7%9A%84%E5%9B%9E%E5%A4%8D%22%0A%7D%0A%5D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-punctuation inline">{</span>
  <span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>
    <span class="hljs-punctuation inline">{</span>
      <span class="hljs-attr inline">&quot;text&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;这是Claude的回复&quot;</span>
    <span class="hljs-punctuation inline">}</span>
  <span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>
</code></pre>
            </div>
        

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E6%8F%90%E5%8F%96%E5%9B%9E%E5%A4%8D%E5%86%85%E5%AE%B9%0AString%20content%20%3D%20JsonUtils.extractValueFromPath(response%2C%20%22content%5B0%5D.text%22)%3B%0A%2F%2F%20%E7%BB%93%E6%9E%9C%EF%BC%9A%22%E8%BF%99%E6%98%AFClaude%E7%9A%84%E5%9B%9E%E5%A4%8D%22">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 提取回复内容</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">content</span> <span class="hljs-operator inline">=</span> JsonUtils.extractValueFromPath(response, <span class="hljs-string inline">&quot;content[0].text&quot;</span>);
<span class="hljs-comment inline">// 结果：&quot;这是Claude的回复&quot;</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">场景3：复杂请求体构建</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E6%9E%84%E5%BB%BA%E5%A4%8D%E6%9D%82%E7%9A%84%E8%AF%B7%E6%B1%82%E4%BD%93%0AMap%20requestBody%20%3D%20new%20HashMap()%3B%0A%2F%2F%20%E8%AE%BE%E7%BD%AE%E6%A8%A1%E5%9E%8B%E4%BF%A1%E6%81%AF%0AJsonUtils.setValueByPath(requestBody%2C%20%22model%22%2C%20%22gpt-4%22)%3B%0A%2F%2F%20%E8%AE%BE%E7%BD%AE%E6%B6%88%E6%81%AF%E6%95%B0%E7%BB%84%0AJsonUtils.setValueByPath(requestBody%2C%20%22messages%5B0%5D.role%22%2C%20%22user%22)%3B%0AJsonUtils.setValueByPath(requestBody%2C%20%22messages%5B0%5D.content%22%2C%20%22Hello%22)%3B%0A%2F%2F%20%E8%AE%BE%E7%BD%AE%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%0AJsonUtils.setValueByPath(requestBody%2C%20%22config.temperature%22%2C%200.7)%3B%0AJsonUtils.setValueByPath(requestBody%2C%20%22config.max_tokens%22%2C%201000)%3B%0A%2F%2F%20%E7%BB%93%E6%9E%9C%EF%BC%9A%0A%7B%0A%22model%22%3A%20%22gpt-4%22%2C%0A%22messages%22%3A%20%5B%0A%7B%0A%22role%22%3A%20%22user%22%2C%0A%22content%22%3A%20%22Hello%22%0A%7D%0A%5D%2C%0A%22config%22%3A%20%7B%0A%22temperature%22%3A%200.7%2C%0A%22max_tokens%22%3A%201000%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 构建复杂的请求体</span>
Map&lt;String, Object&gt; requestBody = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();

<span class="hljs-comment inline">// 设置模型信息</span>
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;model&quot;</span>, <span class="hljs-string inline">&quot;gpt-4&quot;</span>);

<span class="hljs-comment inline">// 设置消息数组</span>
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;messages[0].role&quot;</span>, <span class="hljs-string inline">&quot;user&quot;</span>);
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;messages[0].content&quot;</span>, <span class="hljs-string inline">&quot;Hello&quot;</span>);

<span class="hljs-comment inline">// 设置配置参数</span>
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;config.temperature&quot;</span>, <span class="hljs-number inline">0.7</span>);
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;config.max_tokens&quot;</span>, <span class="hljs-number inline">1000</span>);

<span class="hljs-comment inline">// 结果：</span>
{
  <span class="hljs-string inline">&quot;model&quot;</span>: <span class="hljs-string inline">&quot;gpt-4&quot;</span>,
  <span class="hljs-string inline">&quot;messages&quot;</span>: [
    {
      <span class="hljs-string inline">&quot;role&quot;</span>: <span class="hljs-string inline">&quot;user&quot;</span>,
      <span class="hljs-string inline">&quot;content&quot;</span>: <span class="hljs-string inline">&quot;Hello&quot;</span>
    }
  ],
  <span class="hljs-string inline">&quot;config&quot;</span>: {
    <span class="hljs-string inline">&quot;temperature&quot;</span>: <span class="hljs-number inline">0.7</span>,
    <span class="hljs-string inline">&quot;max_tokens&quot;</span>: <span class="hljs-number inline">1000</span>
  }
}
</code></pre>
            </div>
        
<h3 id="边界情况处理的防御性设计" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#边界情况处理的防御性设计" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 边界情况处理的防御性设计">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            边界情况处理的防御性设计
        </h3>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">情况1：路径不存在</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E8%BE%93%E5%85%A5%EF%BC%9A%7B%22user%22%3A%20%7B%22name%22%3A%20%22%E5%BC%A0%E4%B8%89%22%7D%7D%0A%2F%2F%20%E8%B7%AF%E5%BE%84%EF%BC%9Auser.age%0AString%20age%20%3D%20JsonUtils.extractValueFromPath(data%2C%20%22user.age%22)%3B%0A%2F%2F%20%E7%BB%93%E6%9E%9C%EF%BC%9Anull%EF%BC%88%E4%B8%8D%E6%8A%9B%E5%BC%82%E5%B8%B8%EF%BC%89">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 输入：{&quot;user&quot;: {&quot;name&quot;: &quot;张三&quot;}}</span>
<span class="hljs-comment inline">// 路径：user.age</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">age</span> <span class="hljs-operator inline">=</span> JsonUtils.extractValueFromPath(data, <span class="hljs-string inline">&quot;user.age&quot;</span>);
<span class="hljs-comment inline">// 结果：null（不抛异常）</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">情况2：类型不匹配</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E8%BE%93%E5%85%A5%EF%BC%9A%7B%22user%22%3A%20%22%E5%BC%A0%E4%B8%89%22%7D%EF%BC%88user%E6%98%AF%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C%E4%B8%8D%E6%98%AF%E5%AF%B9%E8%B1%A1%EF%BC%89%0A%2F%2F%20%E8%B7%AF%E5%BE%84%EF%BC%9Auser.name%0AString%20name%20%3D%20JsonUtils.extractValueFromPath(data%2C%20%22user.name%22)%3B%0A%2F%2F%20%E7%BB%93%E6%9E%9C%EF%BC%9Anull%EF%BC%88%E4%B8%8D%E6%8A%9B%E5%BC%82%E5%B8%B8%EF%BC%89">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 输入：{&quot;user&quot;: &quot;张三&quot;}（user是字符串，不是对象）</span>
<span class="hljs-comment inline">// 路径：user.name</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">name</span> <span class="hljs-operator inline">=</span> JsonUtils.extractValueFromPath(data, <span class="hljs-string inline">&quot;user.name&quot;</span>);
<span class="hljs-comment inline">// 结果：null（不抛异常）</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">情况3：数组索引越界</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E8%BE%93%E5%85%A5%EF%BC%9A%7B%22items%22%3A%20%5B1%2C%202%2C%203%5D%7D%0A%2F%2F%20%E8%B7%AF%E5%BE%84%EF%BC%9Aitems%5B10%5D%0AString%20item%20%3D%20JsonUtils.extractValueFromPath(data%2C%20%22items%5B10%5D%22)%3B%0A%2F%2F%20%E7%BB%93%E6%9E%9C%EF%BC%9Anull%EF%BC%88%E4%B8%8D%E6%8A%9B%E5%BC%82%E5%B8%B8%EF%BC%89">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 输入：{&quot;items&quot;: [1, 2, 3]}</span>
<span class="hljs-comment inline">// 路径：items[10]</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">item</span> <span class="hljs-operator inline">=</span> JsonUtils.extractValueFromPath(data, <span class="hljs-string inline">&quot;items[10]&quot;</span>);
<span class="hljs-comment inline">// 结果：null（不抛异常）</span>
</code></pre>
            </div>
        
<h3 id="jsonutils的完整方法架构图" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#jsonutils的完整方法架构图" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to JsonUtils的完整方法架构图">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            JsonUtils的完整方法架构图
        </h3>
<div class="mermaid block" id="mermaid-1767322174127-tngezwc">graph TB
    A[JsonUtils工具类] --> B[基础序列化]
    A --> C[路径解析]
    A --> D[类型转换]
    
    B --> B1[toJsonString]
    B --> B2[parseObject]
    B --> B3[parseArray]
    
    C --> C1[extractValueFromPath]
    C --> C2[setValueByPath]
    
    D --> D1[类型安全转换]
    D --> D2[静默解析]
    
    C1 --> E[路径分割]
    C1 --> F[类型检查]
    C1 --> G[数组索引解析]
    
    C2 --> H[智能构建]
    C2 --> I[数组扩容]
    C2 --> J[递归路径创建]
    
    E --> E1["path.split('\\.')"]
    F --> F1[instanceof检查]
    G --> G1[字符串substring]
    
    H --> H1[防御性创建]
    I --> I2[while循环扩容]
    J --> J1[递归Map创建]</div>
<p class="text-base leading-7 mb-4 text-foreground">通过这种路径解析机制，ACOT实现了真正的<strong class="font-bold text-foreground">API格式无关性</strong>，无论AI服务商如何变化响应格式，只需要修改路径配置就能适配。</p>
<h2 id="完整系统架构图" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#完整系统架构图" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 完整系统架构图">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            完整系统架构图
        </h2>
<div class="mermaid block" id="mermaid-1767322174127-qn6wp9q">graph TB
    A[用户请求] --> B[sendMessage方法]
    B --> C[权限验证]
    C --> D[配置获取]
    D --> E[消息历史查询]
    E --> F[prepareRequestData]
    
    F --> G[API密钥解密]
    G --> H[请求头构建]
    H --> I[请求体构建]
    I --> J[消息组装配]
    
    J --> K[HTTP POST调用]
    K --> L[响应解析]
    L --> M[JsonUtils路径提取]
    M --> N[消息保存]
    N --> O[缓存更新]
    O --> P[配置标记]
    P --> Q[返回结果]
    
    subgraph "配置系统"
        D1[UserConfigDO]
        D2[灵活密钥放置]
        D3[JSON模板化]
        D4[路径配置]
    end
    
    subgraph "加密系统"  
        G1[CryptoJS兼容]
        G2[EVP_BytesToKey]
        G3[AES/CBC解密]
    end
    
    subgraph "数据处理"
        F1[测试版prepareRequestData]
        F2[实用版prepareRequestData]
        F3[消息历史处理]
        F4[角色映射]
    end
    
    subgraph "JSON解析引擎"
        M1[extractValueFromPath]
        M2[setValueByPath]
        M3[路径分割算法]
        M4[类型安全检查]
        M5[数组索引解析]
        M6[智能结构构建]
    end</div>
<h2 id="性能优化" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#性能优化" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 性能优化">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            性能优化
        </h2>
<h3 id="缓存策略的层次设计" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#缓存策略的层次设计" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 缓存策略的层次设计">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            缓存策略的层次设计
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40Cacheable(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20List%20getMessages(Long%20conversationId%2C%20Long%20userId)%20%7B%0A%2F%2F%20%E7%BC%93%E5%AD%98%E5%AF%B9%E8%AF%9D%E6%B6%88%E6%81%AF%E5%88%97%E8%A1%A8%EF%BC%8C%E5%87%8F%E5%B0%91%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%0A%7D%0A%40Cacheable(key%20%3D%20%22'id%3A'%20%2B%20%23id%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20ConversationMessageDO%20getMessage(Long%20id%2C%20Long%20userId)%20%7B%0A%2F%2F%20%E7%BC%93%E5%AD%98%E5%8D%95%E4%B8%AA%E6%B6%88%E6%81%AF%EF%BC%8C%E6%94%AF%E6%8C%81%E8%AF%A6%E6%83%85%E9%A1%B5%E5%BF%AB%E9%80%9F%E5%8A%A0%E8%BD%BD%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@Cacheable(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)</span>
<span class="hljs-keyword inline">public</span> List&lt;ConversationMessageDO&gt; <span class="hljs-title function_ inline">getMessages</span><span class="hljs-params inline">(Long conversationId, Long userId)</span> {
    <span class="hljs-comment inline">// 缓存对话消息列表，减少数据库查询</span>
}

<span class="hljs-meta inline">@Cacheable(key = &quot;&#x27;id:&#x27; + #id + &#x27;:user:&#x27; + #userId&quot;)</span> 
<span class="hljs-keyword inline">public</span> ConversationMessageDO <span class="hljs-title function_ inline">getMessage</span><span class="hljs-params inline">(Long id, Long userId)</span> {
    <span class="hljs-comment inline">// 缓存单个消息，支持详情页快速加载</span>
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">缓存键设计的考虑</strong>：</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">唯一性</strong>：确保不同数据有不同的键</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">可预测性</strong>：便于手动清除特定缓存</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">层次性</strong>：支持批量清除相关缓存</li>
</ul>
<h3 id="异常处理" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#异常处理" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 异常处理">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            异常处理
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="try%20%7B%0AConversationMessageDO%20assistantMessageDO%20%3D%20generateAssistantResponse(...)%3B%0Asave(userMessageDO)%3B%0Asave(assistantMessageDO)%3B%0Areturn%20assistantMessageDO%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22Error%20sending%20message%22%2C%20e)%3B%0A%2F%2F%20%E4%B8%8D%E5%86%8D%E5%88%9B%E5%BB%BA%E9%94%99%E8%AF%AF%E6%B6%88%E6%81%AF%EF%BC%8C%E7%9B%B4%E6%8E%A5%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%0Aif%20(e%20instanceof%20ServiceException)%20%7B%0Athrow%20e%3B%0A%7D%0Athrow%20new%20ServiceException(MESSAGE_SEND_FAILED.getCode()%2C%20e.getMessage())%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">try</span> {
    <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">assistantMessageDO</span> <span class="hljs-operator inline">=</span> generateAssistantResponse(...);
    save(userMessageDO);
    save(assistantMessageDO);
    <span class="hljs-keyword inline">return</span> assistantMessageDO;
} <span class="hljs-keyword inline">catch</span> (Exception e) {
    log.error(<span class="hljs-string inline">&quot;Error sending message&quot;</span>, e);
    
    <span class="hljs-comment inline">// 不再创建错误消息，直接抛出异常</span>
    <span class="hljs-keyword inline">if</span> (e <span class="hljs-keyword inline">instanceof</span> ServiceException) {
        <span class="hljs-keyword inline">throw</span> e;
    }
    <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(MESSAGE_SEND_FAILED.getCode(), e.getMessage());
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">异常处理的原则</strong>：</p>
<ol class="list-decimal list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">快速失败</strong>：发现错误立即终止</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">信息保留</strong>：记录详细的错误日志</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">类型保持</strong>：保持ServiceException的类型</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">避免脏数据</strong>：不保存不完整的对话</li>
</ol>
<h2 id="完整代码全解析" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#完整代码全解析" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 完整代码全解析">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            完整代码全解析
        </h2>
<h3 id="jsonutils：json解析工具类的完整实现" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#jsonutils：json解析工具类的完整实现" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to JsonUtils：JSON解析工具类的完整实现">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            JsonUtils：JSON解析工具类的完整实现
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="package%20com.chat.allchatonthis.common.util.json%3B%0Aimport%20cn.hutool.core.util.ArrayUtil%3B%0Aimport%20cn.hutool.core.util.StrUtil%3B%0Aimport%20cn.hutool.json.JSONUtil%3B%0Aimport%20com.fasterxml.jackson.annotation.JsonInclude%3B%0Aimport%20com.fasterxml.jackson.core.type.TypeReference%3B%0Aimport%20com.fasterxml.jackson.databind.DeserializationFeature%3B%0Aimport%20com.fasterxml.jackson.databind.JsonNode%3B%0Aimport%20com.fasterxml.jackson.databind.ObjectMapper%3B%0Aimport%20com.fasterxml.jackson.databind.SerializationFeature%3B%0Aimport%20com.fasterxml.jackson.datatype.jsr310.JavaTimeModule%3B%0Aimport%20lombok.SneakyThrows%3B%0Aimport%20lombok.extern.slf4j.Slf4j%3B%0Aimport%20java.io.IOException%3B%0Aimport%20java.lang.reflect.Type%3B%0Aimport%20java.util.ArrayList%3B%0Aimport%20java.util.HashMap%3B%0Aimport%20java.util.List%3B%0Aimport%20java.util.Map%3B%0A%2F**%0A*%20JSON%E5%B7%A5%E5%85%B7%E7%B1%BB%20-%20ACOT%E7%9A%84%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90%E6%A0%B8%E5%BF%83%E5%BC%95%E6%93%8E%0A*%2F%0A%40Slf4j%0Apublic%20class%20JsonUtils%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%20%E5%85%A8%E5%B1%80ObjectMapper%E5%AE%9E%E4%BE%8B%20-%20%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%EF%BC%8C%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%20*%2F%0Aprivate%20static%20ObjectMapper%20objectMapper%20%3D%20new%20ObjectMapper()%3B%0Astatic%20%7B%0A%2F%2F%20%E9%85%8D%E7%BD%AE%E5%BA%8F%E5%88%97%E5%8C%96%E8%A1%8C%E4%B8%BA%EF%BC%9A%E4%B8%8D%E5%9B%A0%E7%A9%BABean%E8%80%8C%E5%A4%B1%E8%B4%A5%0AobjectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS%2C%20false)%3B%0A%2F%2F%20%E9%85%8D%E7%BD%AE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%A1%8C%E4%B8%BA%EF%BC%9A%E5%BF%BD%E7%95%A5%E6%9C%AA%E7%9F%A5%E5%B1%9E%E6%80%A7%0AobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES%2C%20false)%3B%0A%2F%2F%20%E5%BF%BD%E7%95%A5null%E5%80%BC%EF%BC%8C%E5%87%8F%E5%B0%91%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E9%87%8F%0AobjectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL)%3B%0A%2F%2F%20%E6%94%AF%E6%8C%81Java%208%E6%97%B6%E9%97%B4%E7%B1%BB%E5%9E%8B%0AobjectMapper.registerModules(new%20JavaTimeModule())%3B%0A%7D%0A%2F**%0A*%20%E5%88%9D%E5%A7%8B%E5%8C%96ObjectMapper%20-%20%E6%94%AF%E6%8C%81Spring%20Boot%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%0A*%0A*%20%40param%20objectMapper%20Spring%E7%AE%A1%E7%90%86%E7%9A%84ObjectMapper%20Bean%0A*%2F%0Apublic%20static%20void%20init(ObjectMapper%20objectMapper)%20%7B%0AJsonUtils.objectMapper%20%3D%20objectMapper%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E5%9F%BA%E7%A1%80%E5%BA%8F%E5%88%97%E5%8C%96%E6%96%B9%E6%B3%95%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20%E5%AF%B9%E8%B1%A1%E8%BD%ACJSON%E5%AD%97%E7%AC%A6%E4%B8%B2%20-%20%E6%9C%80%E5%B8%B8%E7%94%A8%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E6%96%B9%E6%B3%95%0A*%0A*%20%40param%20object%20%E8%A6%81%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%AF%B9%E8%B1%A1%0A*%20%40return%20JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%2F%0A%40SneakyThrows%0Apublic%20static%20String%20toJsonString(Object%20object)%20%7B%0Areturn%20objectMapper.writeValueAsString(object)%3B%0A%7D%0A%2F**%0A*%20%E5%AF%B9%E8%B1%A1%E8%BD%ACJSON%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%20-%20%E9%80%82%E7%94%A8%E4%BA%8E%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%0A*%0A*%20%40param%20object%20%E8%A6%81%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%AF%B9%E8%B1%A1%0A*%20%40return%20JSON%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%0A*%2F%0A%40SneakyThrows%0Apublic%20static%20byte%5B%5D%20toJsonByte(Object%20object)%20%7B%0Areturn%20objectMapper.writeValueAsBytes(object)%3B%0A%7D%0A%2F**%0A*%20%E5%AF%B9%E8%B1%A1%E8%BD%AC%E6%A0%BC%E5%BC%8F%E5%8C%96JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%20-%20%E9%80%82%E7%94%A8%E4%BA%8E%E8%B0%83%E8%AF%95%E5%92%8C%E6%97%A5%E5%BF%97%0A*%0A*%20%40param%20object%20%E8%A6%81%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%AF%B9%E8%B1%A1%0A*%20%40return%20%E6%A0%BC%E5%BC%8F%E5%8C%96%E7%9A%84JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%2F%0A%40SneakyThrows%0Apublic%20static%20String%20toJsonPrettyString(Object%20object)%20%7B%0Areturn%20objectMapper.writerWithDefaultPrettyPrinter().writeValueAsString(object)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E5%9F%BA%E7%A1%80%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%96%B9%E6%B3%95%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E5%AF%B9%E8%B1%A1%20-%20%E6%A0%B8%E5%BF%83%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%96%B9%E6%B3%95%0A*%0A*%20%40param%20text%20JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%20%40param%20clazz%20%E7%9B%AE%E6%A0%87%E7%B1%BB%E5%9E%8B%0A*%20%40return%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E7%9A%84%E5%AF%B9%E8%B1%A1%0A*%2F%0Apublic%20static%20%20T%20parseObject(String%20text%2C%20Class%20clazz)%20%7B%0Aif%20(StrUtil.isEmpty(text))%20%7B%0Areturn%20null%3B%0A%7D%0Atry%20%7B%0Areturn%20objectMapper.readValue(text%2C%20clazz)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%2C%20json%3A%7B%7D%22%2C%20text%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20%E4%BB%8EJSON%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%8C%87%E5%AE%9A%E8%B7%AF%E5%BE%84%E8%A7%A3%E6%9E%90%E5%AF%B9%E8%B1%A1%20-%20%E6%94%AF%E6%8C%81%E5%B5%8C%E5%A5%97%E6%8F%90%E5%8F%96%0A*%0A*%20%40param%20text%20JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%20%40param%20path%20%E8%B7%AF%E5%BE%84%EF%BC%88%E5%A6%82%22data.user%22%EF%BC%89%0A*%20%40param%20clazz%20%E7%9B%AE%E6%A0%87%E7%B1%BB%E5%9E%8B%0A*%20%40return%20%E8%A7%A3%E6%9E%90%E5%90%8E%E7%9A%84%E5%AF%B9%E8%B1%A1%0A*%2F%0Apublic%20static%20%20T%20parseObject(String%20text%2C%20String%20path%2C%20Class%20clazz)%20%7B%0Aif%20(StrUtil.isEmpty(text))%20%7B%0Areturn%20null%3B%0A%7D%0Atry%20%7B%0AJsonNode%20treeNode%20%3D%20objectMapper.readTree(text)%3B%0AJsonNode%20pathNode%20%3D%20treeNode.path(path)%3B%0Areturn%20objectMapper.readValue(pathNode.toString()%2C%20clazz)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%E8%B7%AF%E5%BE%84%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%2C%20json%3A%7B%7D%2C%20path%3A%7B%7D%22%2C%20text%2C%20path%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%E8%BD%AC%E5%AF%B9%E8%B1%A1%20-%20%E9%80%82%E7%94%A8%E4%BA%8E%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%E6%95%B0%E6%8D%AE%0A*%0A*%20%40param%20bytes%20JSON%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%0A*%20%40param%20clazz%20%E7%9B%AE%E6%A0%87%E7%B1%BB%E5%9E%8B%0A*%20%40return%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E7%9A%84%E5%AF%B9%E8%B1%A1%0A*%2F%0Apublic%20static%20%20T%20parseObject(byte%5B%5D%20bytes%2C%20Class%20clazz)%20%7B%0Aif%20(ArrayUtil.isEmpty(bytes))%20%7B%0Areturn%20null%3B%0A%7D%0Atry%20%7B%0Areturn%20objectMapper.readValue(bytes%2C%20clazz)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%22%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20%E4%BD%BF%E7%94%A8TypeReference%E8%A7%A3%E6%9E%90%E5%A4%8D%E6%9D%82%E7%B1%BB%E5%9E%8B%20-%20%E6%94%AF%E6%8C%81%E6%B3%9B%E5%9E%8B%0A*%0A*%20%40param%20text%20JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%20%40param%20typeReference%20%E7%B1%BB%E5%9E%8B%E5%BC%95%E7%94%A8%0A*%20%40return%20%E8%A7%A3%E6%9E%90%E5%90%8E%E7%9A%84%E5%AF%B9%E8%B1%A1%0A*%2F%0Apublic%20static%20%20T%20parseObject(String%20text%2C%20TypeReference%20typeReference)%20%7B%0Atry%20%7B%0Areturn%20objectMapper.readValue(text%2C%20typeReference)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%20TypeReference%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%2C%20json%3A%7B%7D%22%2C%20text%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20%E9%9D%99%E9%BB%98%E8%A7%A3%E6%9E%90%20-%20%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%E6%97%B6%E8%BF%94%E5%9B%9Enull%E8%80%8C%E4%B8%8D%E6%8A%9B%E5%BC%82%E5%B8%B8%0A*%0A*%20%40param%20text%20JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%20%40param%20typeReference%20%E7%B1%BB%E5%9E%8B%E5%BC%95%E7%94%A8%0A*%20%40return%20%E8%A7%A3%E6%9E%90%E5%90%8E%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%88%96null%0A*%2F%0Apublic%20static%20%20T%20parseObjectQuietly(String%20text%2C%20TypeReference%20typeReference)%20%7B%0Atry%20%7B%0Areturn%20objectMapper.readValue(text%2C%20typeReference)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Areturn%20null%3B%0A%7D%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%95%B0%E7%BB%84%E8%A7%A3%E6%9E%90%E6%96%B9%E6%B3%95%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%ACList%20-%20%E5%A4%84%E7%90%86%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B%0A*%0A*%20%40param%20text%20JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%20%40param%20clazz%20%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E7%B1%BB%E5%9E%8B%0A*%20%40return%20List%E5%AF%B9%E8%B1%A1%0A*%2F%0Apublic%20static%20%20List%20parseArray(String%20text%2C%20Class%20clazz)%20%7B%0Aif%20(StrUtil.isEmpty(text))%20%7B%0Areturn%20new%20ArrayList()%3B%0A%7D%0Atry%20%7B%0Areturn%20objectMapper.readValue(text%2C%0AobjectMapper.getTypeFactory().constructCollectionType(List.class%2C%20clazz))%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%E6%95%B0%E7%BB%84%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%2C%20json%3A%7B%7D%22%2C%20text%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20%E4%BB%8E%E6%8C%87%E5%AE%9A%E8%B7%AF%E5%BE%84%E8%A7%A3%E6%9E%90%E6%95%B0%E7%BB%84%20-%20%E6%94%AF%E6%8C%81%E5%B5%8C%E5%A5%97%E6%95%B0%E7%BB%84%E6%8F%90%E5%8F%96%0A*%0A*%20%40param%20text%20JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%20%40param%20path%20%E8%B7%AF%E5%BE%84%EF%BC%88%E5%A6%82%22data.items%22%EF%BC%89%0A*%20%40param%20clazz%20%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E7%B1%BB%E5%9E%8B%0A*%20%40return%20List%E5%AF%B9%E8%B1%A1%0A*%2F%0Apublic%20static%20%20List%20parseArray(String%20text%2C%20String%20path%2C%20Class%20clazz)%20%7B%0Aif%20(StrUtil.isEmpty(text))%20%7B%0Areturn%20null%3B%0A%7D%0Atry%20%7B%0AJsonNode%20treeNode%20%3D%20objectMapper.readTree(text)%3B%0AJsonNode%20pathNode%20%3D%20treeNode.path(path)%3B%0Areturn%20objectMapper.readValue(pathNode.toString()%2C%0AobjectMapper.getTypeFactory().constructCollectionType(List.class%2C%20clazz))%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%E8%B7%AF%E5%BE%84%E6%95%B0%E7%BB%84%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%2C%20json%3A%7B%7D%2C%20path%3A%7B%7D%22%2C%20text%2C%20path%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%A0%91%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90%E6%96%B9%E6%B3%95%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20%E8%A7%A3%E6%9E%90%E4%B8%BAJsonNode%E6%A0%91%E7%BB%93%E6%9E%84%20-%20%E6%94%AF%E6%8C%81%E5%8A%A8%E6%80%81%E8%AE%BF%E9%97%AE%0A*%0A*%20%40param%20text%20JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%20%40return%20JsonNode%E6%A0%91%0A*%2F%0Apublic%20static%20JsonNode%20parseTree(String%20text)%20%7B%0Atry%20%7B%0Areturn%20objectMapper.readTree(text)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%E6%A0%91%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%2C%20json%3A%7B%7D%22%2C%20text%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%E8%A7%A3%E6%9E%90%E4%B8%BAJsonNode%E6%A0%91%E7%BB%93%E6%9E%84%0A*%0A*%20%40param%20text%20JSON%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%0A*%20%40return%20JsonNode%E6%A0%91%0A*%2F%0Apublic%20static%20JsonNode%20parseTree(byte%5B%5D%20text)%20%7B%0Atry%20%7B%0Areturn%20objectMapper.readTree(text)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%E6%A0%91%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%22%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E5%B7%A5%E5%85%B7%E6%96%B9%E6%B3%95%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20%E5%88%A4%E6%96%AD%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%98%AF%E5%90%A6%E4%B8%BAJSON%E6%A0%BC%E5%BC%8F%0A*%0A*%20%40param%20text%20%E5%BE%85%E6%A3%80%E6%B5%8B%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%20%40return%20%E6%98%AF%E5%90%A6%E4%B8%BAJSON%0A*%2F%0Apublic%20static%20boolean%20isJson(String%20text)%20%7B%0Areturn%20JSONUtil.isTypeJSON(text)%3B%0A%7D%0A%2F**%0A*%20%E5%88%A4%E6%96%AD%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%98%AF%E5%90%A6%E4%B8%BAJSON%E5%AF%B9%E8%B1%A1%E6%A0%BC%E5%BC%8F%0A*%0A*%20%40param%20str%20%E5%BE%85%E6%A3%80%E6%B5%8B%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%20%40return%20%E6%98%AF%E5%90%A6%E4%B8%BAJSON%E5%AF%B9%E8%B1%A1%0A*%2F%0Apublic%20static%20boolean%20isJsonObject(String%20str)%20%7B%0Areturn%20JSONUtil.isTypeJSONObject(str)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%A0%B8%E5%BF%83%E8%B7%AF%E5%BE%84%E8%A7%A3%E6%9E%90%E6%96%B9%E6%B3%95%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20%E4%BB%8E%E5%B5%8C%E5%A5%97JSON%E7%BB%93%E6%9E%84%E4%B8%AD%E6%8F%90%E5%8F%96%E5%80%BC%20-%20ACOT%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%0A*%0A*%20%E6%94%AF%E6%8C%81%E7%9A%84%E8%B7%AF%E5%BE%84%E6%A0%BC%E5%BC%8F%EF%BC%9A%0A*%20-%20%E7%AE%80%E5%8D%95%E8%B7%AF%E5%BE%84%EF%BC%9Auser.name%0A*%20-%20%E6%95%B0%E7%BB%84%E8%B7%AF%E5%BE%84%EF%BC%9Achoices%5B0%5D.message.content%0A*%20-%20%E6%B7%B7%E5%90%88%E8%B7%AF%E5%BE%84%EF%BC%9Adata.items%5B0%5D.details.info%0A*%0A*%20%40param%20data%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%0A*%20%40param%20path%20%E7%82%B9%E5%8F%B7%E5%88%86%E9%9A%94%E7%9A%84%E8%B7%AF%E5%BE%84%EF%BC%88%E6%94%AF%E6%8C%81%E6%95%B0%E7%BB%84%E4%B8%8B%E6%A0%87%EF%BC%89%0A*%20%40return%20%E6%8F%90%E5%8F%96%E7%9A%84%E5%80%BC%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A1%A8%E7%A4%BA%EF%BC%8C%E6%89%BE%E4%B8%8D%E5%88%B0%E5%88%99%E8%BF%94%E5%9B%9Enull%0A*%2F%0A%40SuppressWarnings(%22unchecked%22)%0Apublic%20static%20String%20extractValueFromPath(Map%20data%2C%20String%20path)%20%7B%0A%2F%2F%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E8%B7%AF%E5%BE%84%E5%88%86%E5%89%B2%0AString%5B%5D%20parts%20%3D%20path.split(%22%5C%5C.%22)%3B%0AObject%20current%20%3D%20data%3B%0A%2F%2F%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E9%80%90%E7%BA%A7%E9%81%8D%E5%8E%86%E8%B7%AF%E5%BE%84%0Afor%20(String%20part%20%3A%20parts)%20%7B%0A%2F%2F%20%E9%98%B2%E5%BE%A1%E6%80%A7%E6%A3%80%E6%9F%A5%EF%BC%9A%E4%B8%AD%E9%80%94%E9%81%87%E5%88%B0null%E7%AB%8B%E5%8D%B3%E8%BF%94%E5%9B%9E%0Aif%20(current%20%3D%3D%20null)%20%7B%0Areturn%20null%3B%0A%7D%0A%2F%2F%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E8%A7%A3%E6%9E%90%E5%BD%93%E5%89%8D%E8%B7%AF%E5%BE%84%E6%AE%B5%0Aif%20(part.contains(%22%5B%22)%20%26%26%20part.contains(%22%5D%22))%20%7B%0A%2F%2F%20%E6%95%B0%E7%BB%84%E8%AE%BF%E9%97%AE%E6%A8%A1%E5%BC%8F%EF%BC%9Achoices%5B0%5D%0AString%20arrayName%20%3D%20part.substring(0%2C%20part.indexOf('%5B'))%3B%0Aint%20index%20%3D%20Integer.parseInt(part.substring(part.indexOf('%5B')%20%2B%201%2C%20part.indexOf('%5D')))%3B%0A%2F%2F%20%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8%E7%9A%84%E6%95%B0%E7%BB%84%E8%AE%BF%E9%97%AE%0Aif%20(current%20instanceof%20Map)%20%7B%0AMap%20map%20%3D%20(Map)%20current%3B%0Aif%20(map.containsKey(arrayName)%20%26%26%20map.get(arrayName)%20instanceof%20List)%20%7B%0AList%20array%20%3D%20(List)%20map.get(arrayName)%3B%0Aif%20(index%20else%20%7B%0Areturn%20null%3B%20%20%2F%2F%20%E6%95%B0%E7%BB%84%E8%B6%8A%E7%95%8C%0A%7D%0A%7D%20else%20%7B%0Areturn%20null%3B%20%20%2F%2F%20%E5%AD%97%E6%AE%B5%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%88%96%E7%B1%BB%E5%9E%8B%E4%B8%8D%E5%8C%B9%E9%85%8D%0A%7D%0A%7D%20else%20%7B%0Areturn%20null%3B%20%20%2F%2F%20%E5%BD%93%E5%89%8D%E5%AF%B9%E8%B1%A1%E4%B8%8D%E6%98%AFMap%E7%B1%BB%E5%9E%8B%0A%7D%0A%7D%20else%20%7B%0A%2F%2F%20%E6%99%AE%E9%80%9A%E5%B1%9E%E6%80%A7%E8%AE%BF%E9%97%AE%E6%A8%A1%E5%BC%8F%EF%BC%9Auser.name%0Aif%20(current%20instanceof%20Map)%20%7B%0Acurrent%20%3D%20((Map)%20current).get(part)%3B%0A%7D%20else%20%7B%0Areturn%20null%3B%20%20%2F%2F%20%E5%BD%93%E5%89%8D%E5%AF%B9%E8%B1%A1%E4%B8%8D%E6%98%AFMap%E7%B1%BB%E5%9E%8B%0A%7D%0A%7D%0A%7D%0A%2F%2F%20%E6%AD%A5%E9%AA%A44%EF%BC%9A%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%0Areturn%20current%20!%3D%20null%20%3F%20current.toString()%20%3A%20null%3B%0A%7D%0A%2F**%0A*%20%E5%9C%A8%E5%B5%8C%E5%A5%97JSON%E7%BB%93%E6%9E%84%E4%B8%AD%E8%AE%BE%E7%BD%AE%E5%80%BC%20-%20ACOT%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%0A*%0A*%20%E7%89%B9%E7%82%B9%EF%BC%9A%0A*%20-%20%E6%99%BA%E8%83%BD%E8%B7%AF%E5%BE%84%E6%9E%84%E5%BB%BA%EF%BC%9A%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E4%B8%AD%E9%97%B4%E8%B7%AF%E5%BE%84%0A*%20-%20%E6%95%B0%E7%BB%84%E8%87%AA%E5%8A%A8%E6%89%A9%E5%AE%B9%EF%BC%9A%E7%A1%AE%E4%BF%9D%E6%95%B0%E7%BB%84%E7%B4%A2%E5%BC%95%E5%8F%AF%E8%AE%BF%E9%97%AE%0A*%20-%20%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8%EF%BC%9A%E9%98%B2%E6%AD%A2%E7%B1%BB%E5%9E%8B%E5%86%B2%E7%AA%81%0A*%0A*%20%40param%20data%20%E8%A6%81%E4%BF%AE%E6%94%B9%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%0A*%20%40param%20path%20%E7%82%B9%E5%8F%B7%E5%88%86%E9%9A%94%E7%9A%84%E8%B7%AF%E5%BE%84%EF%BC%88%E6%94%AF%E6%8C%81%E6%95%B0%E7%BB%84%E4%B8%8B%E6%A0%87%EF%BC%89%0A*%20%40param%20value%20%E8%A6%81%E8%AE%BE%E7%BD%AE%E7%9A%84%E5%80%BC%0A*%2F%0A%40SuppressWarnings(%22unchecked%22)%0Apublic%20static%20void%20setValueByPath(Map%20data%2C%20String%20path%2C%20Object%20value)%20%7B%0A%2F%2F%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E8%B7%AF%E5%BE%84%E5%88%86%E5%89%B2%0AString%5B%5D%20parts%20%3D%20path.split(%22%5C%5C.%22)%3B%0AMap%20current%20%3D%20data%3B%0A%2F%2F%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E9%81%8D%E5%8E%86%E8%B7%AF%E5%BE%84%EF%BC%8C%E7%A1%AE%E4%BF%9D%E4%B8%AD%E9%97%B4%E7%BB%93%E6%9E%84%E5%AD%98%E5%9C%A8%0Afor%20(int%20i%20%3D%200%3B%20i%201%3B%20i%2B%2B)%20%7B%0AString%20part%20%3D%20parts%5Bi%5D%3B%0Aif%20(part.contains(%22%5B%22)%20%26%26%20part.contains(%22%5D%22))%20%7B%0A%2F%2F%20%E6%95%B0%E7%BB%84%E8%B7%AF%E5%BE%84%E5%A4%84%E7%90%86%0AString%20arrayName%20%3D%20part.substring(0%2C%20part.indexOf('%5B'))%3B%0Aint%20index%20%3D%20Integer.parseInt(part.substring(part.indexOf('%5B')%20%2B%201%2C%20part.indexOf('%5D')))%3B%0A%2F%2F%20%E5%88%9B%E5%BB%BA%E6%95%B0%E7%BB%84%EF%BC%88%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%AD%98%E5%9C%A8%EF%BC%89%0Aif%20(!current.containsKey(arrayName)%20%7C%7C%20!(current.get(arrayName)%20instanceof%20List))%20%7B%0Acurrent.put(arrayName%2C%20new%20ArrayList())%3B%0A%7D%0AList%20array%20%3D%20(List)%20current.get(arrayName)%3B%0A%2F%2F%20%E6%95%B0%E7%BB%84%E6%89%A9%E5%AE%B9%EF%BC%9A%E7%A1%AE%E4%BF%9D%E7%B4%A2%E5%BC%95%E5%8F%AF%E8%AE%BF%E9%97%AE%0Awhile%20(array.size()%20new%20HashMap())%3B%0A%7D%0A%2F%2F%20%E7%A1%AE%E4%BF%9D%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E6%98%AFMap%E5%AF%B9%E8%B1%A1%EF%BC%88%E4%B8%BA%E4%B8%8B%E4%B8%80%E7%BA%A7%E8%B7%AF%E5%BE%84%E5%81%9A%E5%87%86%E5%A4%87%EF%BC%89%0Aif%20(!(array.get(index)%20instanceof%20Map))%20%7B%0Aarray.set(index%2C%20new%20HashMap())%3B%0A%7D%0Acurrent%20%3D%20(Map)%20array.get(index)%3B%0A%7D%20else%20%7B%0A%2F%2F%20%E6%99%AE%E9%80%9A%E5%B1%9E%E6%80%A7%E8%B7%AF%E5%BE%84%E5%A4%84%E7%90%86%0Aif%20(!current.containsKey(part)%20%7C%7C%20!(current.get(part)%20instanceof%20Map))%20%7B%0Acurrent.put(part%2C%20new%20HashMap())%3B%0A%7D%0Acurrent%20%3D%20(Map)%20current.get(part)%3B%0A%7D%0A%7D%0A%2F%2F%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E8%AE%BE%E7%BD%AE%E6%9C%80%E7%BB%88%E5%80%BC%0AString%20lastPart%20%3D%20parts%5Bparts.length%20-%201%5D%3B%0Aif%20(lastPart.contains(%22%5B%22)%20%26%26%20lastPart.contains(%22%5D%22))%20%7B%0A%2F%2F%20%E6%9C%80%E7%BB%88%E8%B7%AF%E5%BE%84%E6%98%AF%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%0AString%20arrayName%20%3D%20lastPart.substring(0%2C%20lastPart.indexOf('%5B'))%3B%0Aint%20index%20%3D%20Integer.parseInt(lastPart.substring(lastPart.indexOf('%5B')%20%2B%201%2C%20lastPart.indexOf('%5D')))%3B%0A%2F%2F%20%E5%88%9B%E5%BB%BA%E6%95%B0%E7%BB%84%EF%BC%88%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%AD%98%E5%9C%A8%EF%BC%89%0Aif%20(!current.containsKey(arrayName)%20%7C%7C%20!(current.get(arrayName)%20instanceof%20List))%20%7B%0Acurrent.put(arrayName%2C%20new%20ArrayList())%3B%0A%7D%0AList%20array%20%3D%20(List)%20current.get(arrayName)%3B%0A%2F%2F%20%E6%95%B0%E7%BB%84%E6%89%A9%E5%AE%B9%EF%BC%9A%E7%A1%AE%E4%BF%9D%E7%B4%A2%E5%BC%95%E5%8F%AF%E8%AE%BF%E9%97%AE%0Awhile%20(array.size()%20null)%3B%0A%7D%0A%2F%2F%20%E8%AE%BE%E7%BD%AE%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E5%80%BC%0Aarray.set(index%2C%20value)%3B%0A%7D%20else%20%7B%0A%2F%2F%20%E6%9C%80%E7%BB%88%E8%B7%AF%E5%BE%84%E6%98%AF%E6%99%AE%E9%80%9A%E5%B1%9E%E6%80%A7%0Acurrent.put(lastPart%2C%20value)%3B%0A%7D%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">package</span> com.chat.allchatonthis.common.util.json;

<span class="hljs-keyword inline">import</span> cn.hutool.core.util.ArrayUtil;
<span class="hljs-keyword inline">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword inline">import</span> cn.hutool.json.JSONUtil;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.annotation.JsonInclude;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.core.type.TypeReference;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.databind.DeserializationFeature;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.databind.JsonNode;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.databind.ObjectMapper;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.databind.SerializationFeature;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
<span class="hljs-keyword inline">import</span> lombok.SneakyThrows;
<span class="hljs-keyword inline">import</span> lombok.extern.slf4j.Slf4j;

<span class="hljs-keyword inline">import</span> java.io.IOException;
<span class="hljs-keyword inline">import</span> java.lang.reflect.Type;
<span class="hljs-keyword inline">import</span> java.util.ArrayList;
<span class="hljs-keyword inline">import</span> java.util.HashMap;
<span class="hljs-keyword inline">import</span> java.util.List;
<span class="hljs-keyword inline">import</span> java.util.Map;

<span class="hljs-comment inline">/**
 * JSON工具类 - ACOT的数据解析核心引擎
 */</span>
<span class="hljs-meta inline">@Slf4j</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">JsonUtils</span> {

    <span class="hljs-comment inline">// ==================== 核心配置 ====================</span>
    
    <span class="hljs-comment inline">/** 全局ObjectMapper实例 - 单例模式，线程安全 */</span>
    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">static</span> <span class="hljs-type inline">ObjectMapper</span> <span class="hljs-variable inline">objectMapper</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ObjectMapper</span>();

    <span class="hljs-keyword inline">static</span> {
        <span class="hljs-comment inline">// 配置序列化行为：不因空Bean而失败</span>
        objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class="hljs-literal inline">false</span>);
        <span class="hljs-comment inline">// 配置反序列化行为：忽略未知属性</span>
        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="hljs-literal inline">false</span>);
        <span class="hljs-comment inline">// 忽略null值，减少数据传输量</span>
        objectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
        <span class="hljs-comment inline">// 支持Java 8时间类型</span>
        objectMapper.registerModules(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">JavaTimeModule</span>());
    }

    <span class="hljs-comment inline">/**
     * 初始化ObjectMapper - 支持Spring Boot自动配置
     * 
     * <span class="hljs-doctag inline">@param</span> objectMapper Spring管理的ObjectMapper Bean
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">init</span><span class="hljs-params inline">(ObjectMapper objectMapper)</span> {
        JsonUtils.objectMapper = objectMapper;
    }

    <span class="hljs-comment inline">// ==================== 基础序列化方法 ====================</span>

    <span class="hljs-comment inline">/**
     * 对象转JSON字符串 - 最常用的序列化方法
     * 
     * <span class="hljs-doctag inline">@param</span> object 要序列化的对象
     * <span class="hljs-doctag inline">@return</span> JSON字符串
     */</span>
    <span class="hljs-meta inline">@SneakyThrows</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">toJsonString</span><span class="hljs-params inline">(Object object)</span> {
        <span class="hljs-keyword inline">return</span> objectMapper.writeValueAsString(object);
    }

    <span class="hljs-comment inline">/**
     * 对象转JSON字节数组 - 适用于网络传输
     * 
     * <span class="hljs-doctag inline">@param</span> object 要序列化的对象
     * <span class="hljs-doctag inline">@return</span> JSON字节数组
     */</span>
    <span class="hljs-meta inline">@SneakyThrows</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-type inline">byte</span>[] toJsonByte(Object object) {
        <span class="hljs-keyword inline">return</span> objectMapper.writeValueAsBytes(object);
    }

    <span class="hljs-comment inline">/**
     * 对象转格式化JSON字符串 - 适用于调试和日志
     * 
     * <span class="hljs-doctag inline">@param</span> object 要序列化的对象
     * <span class="hljs-doctag inline">@return</span> 格式化的JSON字符串
     */</span>
    <span class="hljs-meta inline">@SneakyThrows</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">toJsonPrettyString</span><span class="hljs-params inline">(Object object)</span> {
        <span class="hljs-keyword inline">return</span> objectMapper.writerWithDefaultPrettyPrinter().writeValueAsString(object);
    }

    <span class="hljs-comment inline">// ==================== 基础反序列化方法 ====================</span>

    <span class="hljs-comment inline">/**
     * JSON字符串转对象 - 核心反序列化方法
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON字符串
     * <span class="hljs-doctag inline">@param</span> clazz 目标类型
     * <span class="hljs-doctag inline">@return</span> 反序列化后的对象
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; T <span class="hljs-title function_ inline">parseObject</span><span class="hljs-params inline">(String text, Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword inline">if</span> (StrUtil.isEmpty(text)) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(text, clazz);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON解析失败, json:{}&quot;</span>, text, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * 从JSON字符串的指定路径解析对象 - 支持嵌套提取
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON字符串
     * <span class="hljs-doctag inline">@param</span> path 路径（如&quot;data.user&quot;）
     * <span class="hljs-doctag inline">@param</span> clazz 目标类型
     * <span class="hljs-doctag inline">@return</span> 解析后的对象
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; T <span class="hljs-title function_ inline">parseObject</span><span class="hljs-params inline">(String text, String path, Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword inline">if</span> (StrUtil.isEmpty(text)) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-type inline">JsonNode</span> <span class="hljs-variable inline">treeNode</span> <span class="hljs-operator inline">=</span> objectMapper.readTree(text);
            <span class="hljs-type inline">JsonNode</span> <span class="hljs-variable inline">pathNode</span> <span class="hljs-operator inline">=</span> treeNode.path(path);
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(pathNode.toString(), clazz);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON路径解析失败, json:{}, path:{}&quot;</span>, text, path, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * 字节数组转对象 - 适用于网络传输数据
     * 
     * <span class="hljs-doctag inline">@param</span> bytes JSON字节数组
     * <span class="hljs-doctag inline">@param</span> clazz 目标类型
     * <span class="hljs-doctag inline">@return</span> 反序列化后的对象
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; T <span class="hljs-title function_ inline">parseObject</span><span class="hljs-params inline">(<span class="hljs-type inline">byte</span>[] bytes, Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword inline">if</span> (ArrayUtil.isEmpty(bytes)) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(bytes, clazz);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON字节数组解析失败&quot;</span>, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * 使用TypeReference解析复杂类型 - 支持泛型
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON字符串
     * <span class="hljs-doctag inline">@param</span> typeReference 类型引用
     * <span class="hljs-doctag inline">@return</span> 解析后的对象
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; T <span class="hljs-title function_ inline">parseObject</span><span class="hljs-params inline">(String text, TypeReference&lt;T&gt; typeReference)</span> {
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(text, typeReference);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON TypeReference解析失败, json:{}&quot;</span>, text, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * 静默解析 - 解析失败时返回null而不抛异常
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON字符串
     * <span class="hljs-doctag inline">@param</span> typeReference 类型引用
     * <span class="hljs-doctag inline">@return</span> 解析后的对象或null
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; T <span class="hljs-title function_ inline">parseObjectQuietly</span><span class="hljs-params inline">(String text, TypeReference&lt;T&gt; typeReference)</span> {
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(text, typeReference);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }
    }

    <span class="hljs-comment inline">// ==================== 数组解析方法 ====================</span>

    <span class="hljs-comment inline">/**
     * JSON字符串转List - 处理数组类型
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON字符串
     * <span class="hljs-doctag inline">@param</span> clazz 数组元素类型
     * <span class="hljs-doctag inline">@return</span> List对象
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; List&lt;T&gt; <span class="hljs-title function_ inline">parseArray</span><span class="hljs-params inline">(String text, Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword inline">if</span> (StrUtil.isEmpty(text)) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;();
        }
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(text, 
                objectMapper.getTypeFactory().constructCollectionType(List.class, clazz));
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON数组解析失败, json:{}&quot;</span>, text, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * 从指定路径解析数组 - 支持嵌套数组提取
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON字符串
     * <span class="hljs-doctag inline">@param</span> path 路径（如&quot;data.items&quot;）
     * <span class="hljs-doctag inline">@param</span> clazz 数组元素类型
     * <span class="hljs-doctag inline">@return</span> List对象
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; List&lt;T&gt; <span class="hljs-title function_ inline">parseArray</span><span class="hljs-params inline">(String text, String path, Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword inline">if</span> (StrUtil.isEmpty(text)) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-type inline">JsonNode</span> <span class="hljs-variable inline">treeNode</span> <span class="hljs-operator inline">=</span> objectMapper.readTree(text);
            <span class="hljs-type inline">JsonNode</span> <span class="hljs-variable inline">pathNode</span> <span class="hljs-operator inline">=</span> treeNode.path(path);
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(pathNode.toString(), 
                objectMapper.getTypeFactory().constructCollectionType(List.class, clazz));
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON路径数组解析失败, json:{}, path:{}&quot;</span>, text, path, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">// ==================== 树结构解析方法 ====================</span>

    <span class="hljs-comment inline">/**
     * 解析为JsonNode树结构 - 支持动态访问
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON字符串
     * <span class="hljs-doctag inline">@return</span> JsonNode树
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> JsonNode <span class="hljs-title function_ inline">parseTree</span><span class="hljs-params inline">(String text)</span> {
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readTree(text);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON树解析失败, json:{}&quot;</span>, text, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * 字节数组解析为JsonNode树结构
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON字节数组
     * <span class="hljs-doctag inline">@return</span> JsonNode树
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> JsonNode <span class="hljs-title function_ inline">parseTree</span><span class="hljs-params inline">(<span class="hljs-type inline">byte</span>[] text)</span> {
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readTree(text);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON字节数组树解析失败&quot;</span>, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">// ==================== 工具方法 ====================</span>

    <span class="hljs-comment inline">/**
     * 判断字符串是否为JSON格式
     * 
     * <span class="hljs-doctag inline">@param</span> text 待检测字符串
     * <span class="hljs-doctag inline">@return</span> 是否为JSON
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">isJson</span><span class="hljs-params inline">(String text)</span> {
        <span class="hljs-keyword inline">return</span> JSONUtil.isTypeJSON(text);
    }

    <span class="hljs-comment inline">/**
     * 判断字符串是否为JSON对象格式
     * 
     * <span class="hljs-doctag inline">@param</span> str 待检测字符串
     * <span class="hljs-doctag inline">@return</span> 是否为JSON对象
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">isJsonObject</span><span class="hljs-params inline">(String str)</span> {
        <span class="hljs-keyword inline">return</span> JSONUtil.isTypeJSONObject(str);
    }

    <span class="hljs-comment inline">// ==================== 核心路径解析方法 ====================</span>

    <span class="hljs-comment inline">/**
     * 从嵌套JSON结构中提取值 - ACOT的核心功能
     * 
     * 支持的路径格式：
     * - 简单路径：user.name
     * - 数组路径：choices[0].message.content
     * - 混合路径：data.items[0].details.info
     * 
     * <span class="hljs-doctag inline">@param</span> data 数据结构
     * <span class="hljs-doctag inline">@param</span> path 点号分隔的路径（支持数组下标）
     * <span class="hljs-doctag inline">@return</span> 提取的值的字符串表示，找不到则返回null
     */</span>
    <span class="hljs-meta inline">@SuppressWarnings(&quot;unchecked&quot;)</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">extractValueFromPath</span><span class="hljs-params inline">(Map&lt;String, Object&gt; data, String path)</span> {
        <span class="hljs-comment inline">// 步骤1：路径分割</span>
        String[] parts = path.split(<span class="hljs-string inline">&quot;\\.&quot;</span>);
        <span class="hljs-type inline">Object</span> <span class="hljs-variable inline">current</span> <span class="hljs-operator inline">=</span> data;

        <span class="hljs-comment inline">// 步骤2：逐级遍历路径</span>
        <span class="hljs-keyword inline">for</span> (String part : parts) {
            <span class="hljs-comment inline">// 防御性检查：中途遇到null立即返回</span>
            <span class="hljs-keyword inline">if</span> (current == <span class="hljs-literal inline">null</span>) {
                <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
            }

            <span class="hljs-comment inline">// 步骤3：解析当前路径段</span>
            <span class="hljs-keyword inline">if</span> (part.contains(<span class="hljs-string inline">&quot;[&quot;</span>) &amp;&amp; part.contains(<span class="hljs-string inline">&quot;]&quot;</span>)) {
                <span class="hljs-comment inline">// 数组访问模式：choices[0]</span>
                <span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> part.substring(<span class="hljs-number inline">0</span>, part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>));
                <span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(part.substring(part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>) + <span class="hljs-number inline">1</span>, part.indexOf(<span class="hljs-string inline">&#x27;]&#x27;</span>)));

                <span class="hljs-comment inline">// 类型安全的数组访问</span>
                <span class="hljs-keyword inline">if</span> (current <span class="hljs-keyword inline">instanceof</span> Map) {
                    Map&lt;String, Object&gt; map = (Map&lt;String, Object&gt;) current;
                    <span class="hljs-keyword inline">if</span> (map.containsKey(arrayName) &amp;&amp; map.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List) {
                        List&lt;Object&gt; array = (List&lt;Object&gt;) map.get(arrayName);
                        <span class="hljs-keyword inline">if</span> (index &lt; array.size()) {
                            current = array.get(index);
                        } <span class="hljs-keyword inline">else</span> {
                            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// 数组越界</span>
                        }
                    } <span class="hljs-keyword inline">else</span> {
                        <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// 字段不存在或类型不匹配</span>
                    }
                } <span class="hljs-keyword inline">else</span> {
                    <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// 当前对象不是Map类型</span>
                }
            } <span class="hljs-keyword inline">else</span> {
                <span class="hljs-comment inline">// 普通属性访问模式：user.name</span>
                <span class="hljs-keyword inline">if</span> (current <span class="hljs-keyword inline">instanceof</span> Map) {
                    current = ((Map&lt;String, Object&gt;) current).get(part);
                } <span class="hljs-keyword inline">else</span> {
                    <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// 当前对象不是Map类型</span>
                }
            }
        }

        <span class="hljs-comment inline">// 步骤4：返回结果</span>
        <span class="hljs-keyword inline">return</span> current != <span class="hljs-literal inline">null</span> ? current.toString() : <span class="hljs-literal inline">null</span>;
    }

    <span class="hljs-comment inline">/**
     * 在嵌套JSON结构中设置值 - ACOT的核心功能
     * 
     * 特点：
     * - 智能路径构建：自动创建不存在的中间路径
     * - 数组自动扩容：确保数组索引可访问
     * - 类型安全：防止类型冲突
     * 
     * <span class="hljs-doctag inline">@param</span> data 要修改的数据结构
     * <span class="hljs-doctag inline">@param</span> path 点号分隔的路径（支持数组下标）
     * <span class="hljs-doctag inline">@param</span> value 要设置的值
     */</span>
    <span class="hljs-meta inline">@SuppressWarnings(&quot;unchecked&quot;)</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">setValueByPath</span><span class="hljs-params inline">(Map&lt;String, Object&gt; data, String path, Object value)</span> {
        <span class="hljs-comment inline">// 步骤1：路径分割</span>
        String[] parts = path.split(<span class="hljs-string inline">&quot;\\.&quot;</span>);
        Map&lt;String, Object&gt; current = data;

        <span class="hljs-comment inline">// 步骤2：遍历路径，确保中间结构存在</span>
        <span class="hljs-keyword inline">for</span> (<span class="hljs-type inline">int</span> <span class="hljs-variable inline">i</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">0</span>; i &lt; parts.length - <span class="hljs-number inline">1</span>; i++) {
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">part</span> <span class="hljs-operator inline">=</span> parts[i];

            <span class="hljs-keyword inline">if</span> (part.contains(<span class="hljs-string inline">&quot;[&quot;</span>) &amp;&amp; part.contains(<span class="hljs-string inline">&quot;]&quot;</span>)) {
                <span class="hljs-comment inline">// 数组路径处理</span>
                <span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> part.substring(<span class="hljs-number inline">0</span>, part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>));
                <span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(part.substring(part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>) + <span class="hljs-number inline">1</span>, part.indexOf(<span class="hljs-string inline">&#x27;]&#x27;</span>)));

                <span class="hljs-comment inline">// 创建数组（如果不存在）</span>
                <span class="hljs-keyword inline">if</span> (!current.containsKey(arrayName) || !(current.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List)) {
                    current.put(arrayName, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;());
                }

                List&lt;Object&gt; array = (List&lt;Object&gt;) current.get(arrayName);

                <span class="hljs-comment inline">// 数组扩容：确保索引可访问</span>
                <span class="hljs-keyword inline">while</span> (array.size() &lt;= index) {
                    array.add(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;String, Object&gt;());
                }

                <span class="hljs-comment inline">// 确保数组元素是Map对象（为下一级路径做准备）</span>
                <span class="hljs-keyword inline">if</span> (!(array.get(index) <span class="hljs-keyword inline">instanceof</span> Map)) {
                    array.set(index, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;String, Object&gt;());
                }

                current = (Map&lt;String, Object&gt;) array.get(index);
            } <span class="hljs-keyword inline">else</span> {
                <span class="hljs-comment inline">// 普通属性路径处理</span>
                <span class="hljs-keyword inline">if</span> (!current.containsKey(part) || !(current.get(part) <span class="hljs-keyword inline">instanceof</span> Map)) {
                    current.put(part, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;String, Object&gt;());
                }
                current = (Map&lt;String, Object&gt;) current.get(part);
            }
        }

        <span class="hljs-comment inline">// 步骤3：设置最终值</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">lastPart</span> <span class="hljs-operator inline">=</span> parts[parts.length - <span class="hljs-number inline">1</span>];

        <span class="hljs-keyword inline">if</span> (lastPart.contains(<span class="hljs-string inline">&quot;[&quot;</span>) &amp;&amp; lastPart.contains(<span class="hljs-string inline">&quot;]&quot;</span>)) {
            <span class="hljs-comment inline">// 最终路径是数组元素</span>
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> lastPart.substring(<span class="hljs-number inline">0</span>, lastPart.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>));
            <span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(lastPart.substring(lastPart.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>) + <span class="hljs-number inline">1</span>, lastPart.indexOf(<span class="hljs-string inline">&#x27;]&#x27;</span>)));

            <span class="hljs-comment inline">// 创建数组（如果不存在）</span>
            <span class="hljs-keyword inline">if</span> (!current.containsKey(arrayName) || !(current.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List)) {
                current.put(arrayName, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;());
            }

            List&lt;Object&gt; array = (List&lt;Object&gt;) current.get(arrayName);

            <span class="hljs-comment inline">// 数组扩容：确保索引可访问</span>
            <span class="hljs-keyword inline">while</span> (array.size() &lt;= index) {
                array.add(<span class="hljs-literal inline">null</span>);
            }

            <span class="hljs-comment inline">// 设置数组元素值</span>
            array.set(index, value);
        } <span class="hljs-keyword inline">else</span> {
            <span class="hljs-comment inline">// 最终路径是普通属性</span>
            current.put(lastPart, value);
        }
    }
}
</code></pre>
            </div>
        
<h3 id="userconfigdo：配置类的完整实现" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#userconfigdo：配置类的完整实现" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to UserConfigDO：配置类的完整实现">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            UserConfigDO：配置类的完整实现
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="package%20com.chat.allchatonthis.entity.dataobject%3B%0Aimport%20com.baomidou.mybatisplus.annotation.*%3B%0Aimport%20com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler%3B%0Aimport%20com.chat.allchatonthis.config.mybatis.core.dataobject.BaseDO%3B%0Aimport%20lombok.AllArgsConstructor%3B%0Aimport%20lombok.Data%3B%0Aimport%20lombok.EqualsAndHashCode%3B%0Aimport%20lombok.NoArgsConstructor%3B%0Aimport%20lombok.experimental.Accessors%3B%0Aimport%20java.time.LocalDateTime%3B%0Aimport%20java.util.Map%3B%0A%2F**%0A*%20%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%AF%B9%E8%B1%A1%20-%20%E6%94%AF%E6%8C%81%E5%A4%9A%E6%A0%B7%E5%8C%96AI%E6%9C%8D%E5%8A%A1%E5%95%86API%E9%85%8D%E7%BD%AE%0A*%0A*%20%E8%AE%BE%E8%AE%A1%E7%9B%AE%E6%A0%87%EF%BC%9A%0A*%201.%20%E7%81%B5%E6%B4%BB%E9%80%82%E9%85%8D%E4%B8%8D%E5%90%8CAI%E6%9C%8D%E5%8A%A1%E5%95%86%E7%9A%84%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F%0A*%202.%20%E6%94%AF%E6%8C%81%E5%A4%8D%E6%9D%82%E5%B5%8C%E5%A5%97%E7%9A%84JSON%E8%AF%B7%E6%B1%82%2F%E5%93%8D%E5%BA%94%E6%A0%BC%E5%BC%8F%0A*%203.%20%E6%8F%90%E4%BE%9B%E5%AE%8C%E6%95%B4%E7%9A%84%E6%B6%88%E6%81%AF%E8%B7%AF%E5%BE%84%E6%98%A0%E5%B0%84%E5%8A%9F%E8%83%BD%0A*%204.%20%E7%A1%AE%E4%BF%9D%E9%85%8D%E7%BD%AE%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E5%92%8C%E5%8F%AF%E7%94%A8%E6%80%A7%E7%9B%91%E6%8E%A7%0A*%2F%0A%40EqualsAndHashCode(callSuper%20%3D%20true)%0A%40Data%0A%40AllArgsConstructor%0A%40NoArgsConstructor%0A%40Accessors(chain%20%3D%20true)%20%20%2F%2F%20%E6%94%AF%E6%8C%81%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%EF%BC%8C%E6%8F%90%E5%8D%87%E4%BB%A3%E7%A0%81%E5%8F%AF%E8%AF%BB%E6%80%A7%0A%40TableName(value%20%3D%20%22user_config%22%2C%20autoResultMap%20%3D%20true)%0Apublic%20class%20UserConfigDO%20extends%20BaseDO%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E5%AD%97%E6%AE%B5%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%40TableId(type%20%3D%20IdType.AUTO)%0Aprivate%20Long%20id%3B%0A%2F**%20%E9%85%8D%E7%BD%AE%E6%98%AF%E5%90%A6%E5%8F%AF%E7%94%A8%20-%20%E7%94%A8%E4%BA%8E%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E5%92%8C%E7%94%A8%E6%88%B7%E7%95%8C%E9%9D%A2%E6%98%BE%E7%A4%BA%20*%2F%0Aprivate%20Boolean%20isAvailable%3B%0A%2F**%20%E5%A4%96%E9%94%AE%EF%BC%9A%E5%85%B3%E8%81%94%E7%94%A8%E6%88%B7ID%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%A4%9Ayonhg%E9%9A%94%E7%A6%BB%20*%2F%0Aprivate%20Long%20userId%3B%0A%2F**%20%E9%85%8D%E7%BD%AE%E5%90%8D%E7%A7%B0%20-%20%E7%94%A8%E6%88%B7%E8%87%AA%E5%AE%9A%E4%B9%89%EF%BC%8C%E4%BE%BF%E4%BA%8E%E7%AE%A1%E7%90%86%E5%A4%9A%E4%B8%AA%E9%85%8D%E7%BD%AE%20*%2F%0Aprivate%20String%20name%3B%0A%2F**%20API%E8%AF%B7%E6%B1%82URL%20-%20%E4%B8%8D%E5%90%8C%E6%9C%8D%E5%8A%A1%E5%95%86%E7%9A%84%E7%AB%AF%E7%82%B9%E5%9C%B0%E5%9D%80%20*%2F%0Aprivate%20String%20apiUrl%3B%0A%2F**%20API%E5%AF%86%E9%92%A5%20-%20%E6%94%AF%E6%8C%81%E6%98%8E%E6%96%87%E5%92%8C%E5%8A%A0%E5%AF%86%E5%AD%98%E5%82%A8%EF%BC%88enc%3A%E5%89%8D%E7%BC%80%E6%A0%87%E8%AF%86%E5%8A%A0%E5%AF%86%EF%BC%89%20*%2F%0Aprivate%20String%20apiKey%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20API%E5%AF%86%E9%92%A5%E6%94%BE%E7%BD%AE%E7%AD%96%E7%95%A5%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20API%E5%AF%86%E9%92%A5%E6%94%BE%E7%BD%AE%E7%AD%96%E7%95%A5%EF%BC%9A%0A*%20-%20'header'%3A%20%E6%94%BE%E5%9C%A8Authorization%20header%E4%B8%AD%EF%BC%88%E9%BB%98%E8%AE%A4%EF%BC%8C%E9%80%82%E7%94%A8%E4%BA%8EOpenAI%E7%AD%89%EF%BC%89%0A*%20-%20'body'%3A%20%E5%B5%8C%E5%85%A5%E8%AF%B7%E6%B1%82%E4%BD%93%E4%B8%AD%EF%BC%88%E9%80%82%E7%94%A8%E4%BA%8E%E6%9F%90%E4%BA%9B%E8%87%AA%E5%AE%9A%E4%B9%89API%EF%BC%89%0A*%20-%20'custom_header'%3A%20%E6%94%BE%E5%9C%A8%E8%87%AA%E5%AE%9A%E4%B9%89header%E4%B8%AD%EF%BC%88%E9%80%82%E7%94%A8%E4%BA%8EAnthropic%E7%AD%89%EF%BC%89%0A*%2F%0Aprivate%20String%20apiKeyPlacement%3B%0A%2F**%20%E8%87%AA%E5%AE%9A%E4%B9%89header%E5%90%8D%E7%A7%B0%20-%20%E5%BD%93apiKeyPlacement%3D'custom_header'%E6%97%B6%E4%BD%BF%E7%94%A8%20*%2F%0Aprivate%20String%20apiKeyHeader%3B%0A%2F**%20JSON%E8%B7%AF%E5%BE%84%20-%20%E5%BD%93apiKeyPlacement%3D'body'%E6%97%B6%EF%BC%8C%E6%8C%87%E5%AE%9AAPI%E5%AF%86%E9%92%A5%E5%9C%A8%E8%AF%B7%E6%B1%82%E4%BD%93%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE%20*%2F%0Aprivate%20String%20apiKeyBodyPath%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20JSON%E6%A8%A1%E6%9D%BF%E7%B3%BB%E7%BB%9F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20%E8%AF%B7%E6%B1%82%E6%A8%A1%E6%9D%BF%20-%20%E9%A2%84%E5%AE%9A%E4%B9%89%E7%9A%84JSON%E7%BB%93%E6%9E%84%0A*%20%E4%BD%BF%E7%94%A8JacksonTypeHandler%E8%87%AA%E5%8A%A8%E5%A4%84%E7%90%86MapJSON%E8%BD%AC%E6%8D%A2%0A*%20%E6%94%AF%E6%8C%81%E4%BB%BB%E6%84%8F%E5%A4%8D%E6%9D%82%E7%9A%84%E5%B5%8C%E5%A5%97%E7%BB%93%E6%9E%84%0A*%2F%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20requestTemplate%3B%0A%2F**%0A*%20%E5%93%8D%E5%BA%94%E6%A8%A1%E6%9D%BF%20-%20%E7%94%A8%E4%BA%8E%E5%93%8D%E5%BA%94%E6%A0%BC%E5%BC%8F%E9%AA%8C%E8%AF%81%E5%92%8C%E5%A4%84%E7%90%86%0A*%20%E7%9B%AE%E5%89%8D%E4%B8%BB%E8%A6%81%E7%94%A8%E4%BA%8E%E6%96%87%E6%A1%A3%E5%8C%96%EF%BC%8C%E6%9C%AA%E6%9D%A5%E5%8F%AF%E6%89%A9%E5%B1%95%E4%B8%BA%E5%93%8D%E5%BA%94%E9%AA%8C%E8%AF%81%0A*%2F%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20responseTemplate%3B%0A%2F**%0A*%20%E8%87%AA%E5%AE%9A%E4%B9%89HTTP%E5%A4%B4%20-%20%E6%94%AF%E6%8C%81%E6%B7%BB%E5%8A%A0%E9%A2%9D%E5%A4%96%E7%9A%84%E8%AF%B7%E6%B1%82%E5%A4%B4%0A*%20%E4%BE%8B%E5%A6%82%EF%BC%9AUser-Agent%E3%80%81Referer%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81%E5%A4%B4%E7%AD%89%0A*%2F%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20headers%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E8%A7%92%E8%89%B2%E5%AD%97%E6%AE%B5%E6%98%A0%E5%B0%84%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%20%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2%E5%AD%97%E6%AE%B5%E5%90%8D%20-%20%E4%B8%8D%E5%90%8CAPI%E4%B8%AD%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2%E7%9A%84%E5%AD%97%E6%AE%B5%E5%90%8D%EF%BC%88%E5%A6%82user%E3%80%81human%E3%80%81customer%EF%BC%89%20*%2F%0Aprivate%20String%20requestUserRoleField%3B%0A%2F**%20%E5%8A%A9%E6%89%8B%E8%A7%92%E8%89%B2%E5%AD%97%E6%AE%B5%E5%90%8D%20-%20%E4%B8%8D%E5%90%8CAPI%E4%B8%AD%E5%8A%A9%E6%89%8B%E8%A7%92%E8%89%B2%E7%9A%84%E5%AD%97%E6%AE%B5%E5%90%8D%EF%BC%88%E5%A6%82assistant%E3%80%81ai%E3%80%81agent%EF%BC%89%20*%2F%0Aprivate%20String%20requestAssistantField%3B%0A%2F**%20%E7%B3%BB%E7%BB%9F%E8%A7%92%E8%89%B2%E5%AD%97%E6%AE%B5%E5%90%8D%20-%20%E7%B3%BB%E7%BB%9F%E6%B6%88%E6%81%AF%E7%9A%84%E8%A7%92%E8%89%B2%E5%AD%97%E6%AE%B5%E5%90%8D%EF%BC%88%E5%A6%82system%E3%80%81instruction%EF%BC%89%20*%2F%0Aprivate%20String%20requestSystemField%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%B6%88%E6%81%AF%E8%B7%AF%E5%BE%84%E9%85%8D%E7%BD%AE%E7%B3%BB%E7%BB%9F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20%E6%B6%88%E6%81%AF%E7%BB%84%E8%B7%AF%E5%BE%84%20-%20%E6%8C%87%E5%AE%9A%E6%B6%88%E6%81%AF%E6%95%B0%E7%BB%84%E5%9C%A8%E8%AF%B7%E6%B1%82JSON%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE%0A*%20%E4%BE%8B%E5%A6%82%EF%BC%9A'messages'%20%E6%88%96%20'conversation.messages'%20%E6%88%96%20'data.chat.messages'%0A*%2F%0Aprivate%20String%20requestMessageGroupPath%3B%0A%2F**%0A*%20%E8%A7%92%E8%89%B2%E8%B7%AF%E5%BE%84%20-%20%E6%8C%87%E5%AE%9A%E5%8D%95%E4%B8%AA%E6%B6%88%E6%81%AF%E5%AF%B9%E8%B1%A1%E4%B8%AD%E8%A7%92%E8%89%B2%E5%AD%97%E6%AE%B5%E7%9A%84%E5%90%8D%E7%A7%B0%0A*%20%E4%BE%8B%E5%A6%82%EF%BC%9A'role'%20%E6%88%96%20'speaker'%20%E6%88%96%20'type'%0A*%2F%0Aprivate%20String%20requestRolePathFromGroup%3B%0A%2F**%0A*%20%E6%96%87%E6%9C%AC%E8%B7%AF%E5%BE%84%20-%20%E6%8C%87%E5%AE%9A%E5%8D%95%E4%B8%AA%E6%B6%88%E6%81%AF%E5%AF%B9%E8%B1%A1%E4%B8%AD%E5%86%85%E5%AE%B9%E5%AD%97%E6%AE%B5%E7%9A%84%E5%90%8D%E7%A7%B0%0A*%20%E4%BE%8B%E5%A6%82%EF%BC%9A'content'%20%E6%88%96%20'text'%20%E6%88%96%20'message'%0A*%2F%0Aprivate%20String%20requestTextPathFromGroup%3B%0A%2F**%0A*%20%E5%93%8D%E5%BA%94%E6%96%87%E6%9C%AC%E8%B7%AF%E5%BE%84%20-%20%E6%8C%87%E5%AE%9A%E5%A6%82%E4%BD%95%E4%BB%8E%E5%93%8D%E5%BA%94JSON%E4%B8%AD%E6%8F%90%E5%8F%96AI%E5%9B%9E%E5%A4%8D%E5%86%85%E5%AE%B9%0A*%20%E4%BE%8B%E5%A6%82%EF%BC%9A'choices.0.message.content'%20%E6%88%96%20'response.text'%0A*%2F%0Aprivate%20String%20responseTextPath%3B%0A%2F**%0A*%20%E6%80%9D%E8%80%83%E6%96%87%E6%9C%AC%E8%B7%AF%E5%BE%84%20-%20%E6%8C%87%E5%AE%9A%E5%A6%82%E4%BD%95%E6%8F%90%E5%8F%96AI%E7%9A%84%E6%80%9D%E8%80%83%E8%BF%87%E7%A8%8B%EF%BC%88%E5%A6%82%E6%9E%9C%E6%94%AF%E6%8C%81%EF%BC%89%0A*%20%E4%BE%8B%E5%A6%82%EF%BC%9A'choices.0.message.thinking'%20%E6%88%96%20'response.reasoning'%0A*%2F%0Aprivate%20String%20responseThinkingTextPath%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E7%9B%91%E6%8E%A7%E5%92%8C%E7%BB%9F%E8%AE%A1%E5%AD%97%E6%AE%B5%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%20%E6%9C%80%E5%90%8E%E4%BD%BF%E7%94%A8%E6%97%B6%E9%97%B4%20-%20%E7%94%A8%E4%BA%8E%E7%BB%9F%E8%AE%A1%E5%88%86%E6%9E%90%E5%92%8C%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%20*%2F%0Aprivate%20LocalDateTime%20lastUsedTime%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E4%B8%B4%E6%97%B6%E5%AD%97%E6%AE%B5%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20%E8%A7%A3%E5%AF%86%E5%AF%86%E9%92%A5%20-%20%E4%B8%B4%E6%97%B6%E5%AD%97%E6%AE%B5%EF%BC%8C%E4%B8%8D%E6%8C%81%E4%B9%85%E5%8C%96%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93%0A*%20%E7%94%A8%E4%BA%8E%E5%9C%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E8%A7%A3%E5%AF%86%E5%8A%A0%E5%AF%86%E7%9A%84API%E5%AF%86%E9%92%A5%0A*%2F%0A%40TableField(exist%20%3D%20false)%0Aprivate%20String%20secretKey%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">package</span> com.chat.allchatonthis.entity.dataobject;

<span class="hljs-keyword inline">import</span> com.baomidou.mybatisplus.annotation.*;
<span class="hljs-keyword inline">import</span> com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.config.mybatis.core.dataobject.BaseDO;
<span class="hljs-keyword inline">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword inline">import</span> lombok.Data;
<span class="hljs-keyword inline">import</span> lombok.EqualsAndHashCode;
<span class="hljs-keyword inline">import</span> lombok.NoArgsConstructor;
<span class="hljs-keyword inline">import</span> lombok.experimental.Accessors;

<span class="hljs-keyword inline">import</span> java.time.LocalDateTime;
<span class="hljs-keyword inline">import</span> java.util.Map;

<span class="hljs-comment inline">/**
 * 用户配置数据对象 - 支持多样化AI服务商API配置
 * 
 * 设计目标：
 * 1. 灵活适配不同AI服务商的认证方式
 * 2. 支持复杂嵌套的JSON请求/响应格式
 * 3. 提供完整的消息路径映射功能
 * 4. 确保配置的安全性和可用性监控
 */</span>
<span class="hljs-meta inline">@EqualsAndHashCode(callSuper = true)</span>
<span class="hljs-meta inline">@Data</span>
<span class="hljs-meta inline">@AllArgsConstructor</span>
<span class="hljs-meta inline">@NoArgsConstructor</span>
<span class="hljs-meta inline">@Accessors(chain = true)</span>  <span class="hljs-comment inline">// 支持链式调用，提升代码可读性</span>
<span class="hljs-meta inline">@TableName(value = &quot;user_config&quot;, autoResultMap = true)</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">UserConfigDO</span> <span class="hljs-keyword inline">extends</span> <span class="hljs-title class_ inline">BaseDO</span> {
    
    <span class="hljs-comment inline">// ==================== 基础配置字段 ====================</span>
    
    <span class="hljs-meta inline">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword inline">private</span> Long id;
    
    <span class="hljs-comment inline">/** 配置是否可用 - 用于健康检查和用户界面显示 */</span>
    <span class="hljs-keyword inline">private</span> Boolean isAvailable;
    
    <span class="hljs-comment inline">/** 外键：关联用户ID，实现多yonhg隔离 */</span>
    <span class="hljs-keyword inline">private</span> Long userId;
    
    <span class="hljs-comment inline">/** 配置名称 - 用户自定义，便于管理多个配置 */</span>
    <span class="hljs-keyword inline">private</span> String name;
    
    <span class="hljs-comment inline">/** API请求URL - 不同服务商的端点地址 */</span>
    <span class="hljs-keyword inline">private</span> String apiUrl;
    
    <span class="hljs-comment inline">/** API密钥 - 支持明文和加密存储（enc:前缀标识加密） */</span>
    <span class="hljs-keyword inline">private</span> String apiKey;

    <span class="hljs-comment inline">// ==================== API密钥放置策略 ====================</span>
    
    <span class="hljs-comment inline">/** 
     * API密钥放置策略：
     * - &#x27;header&#x27;: 放在Authorization header中（默认，适用于OpenAI等）
     * - &#x27;body&#x27;: 嵌入请求体中（适用于某些自定义API）
     * - &#x27;custom_header&#x27;: 放在自定义header中（适用于Anthropic等）
     */</span>
    <span class="hljs-keyword inline">private</span> String apiKeyPlacement;
    
    <span class="hljs-comment inline">/** 自定义header名称 - 当apiKeyPlacement=&#x27;custom_header&#x27;时使用 */</span>
    <span class="hljs-keyword inline">private</span> String apiKeyHeader;
    
    <span class="hljs-comment inline">/** JSON路径 - 当apiKeyPlacement=&#x27;body&#x27;时，指定API密钥在请求体中的位置 */</span>
    <span class="hljs-keyword inline">private</span> String apiKeyBodyPath;

    <span class="hljs-comment inline">// ==================== JSON模板系统 ====================</span>
    
    <span class="hljs-comment inline">/** 
     * 请求模板 - 预定义的JSON结构
     * 使用JacksonTypeHandler自动处理Map&lt;-&gt;JSON转换
     * 支持任意复杂的嵌套结构
     */</span>
    <span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
    <span class="hljs-keyword inline">private</span> Map&lt;String, Object&gt; requestTemplate;

    <span class="hljs-comment inline">/** 
     * 响应模板 - 用于响应格式验证和处理
     * 目前主要用于文档化，未来可扩展为响应验证
     */</span>
    <span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
    <span class="hljs-keyword inline">private</span> Map&lt;String, Object&gt; responseTemplate;

    <span class="hljs-comment inline">/** 
     * 自定义HTTP头 - 支持添加额外的请求头
     * 例如：User-Agent、Referer、自定义认证头等
     */</span>
    <span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
    <span class="hljs-keyword inline">private</span> Map&lt;String, String&gt; headers;

    <span class="hljs-comment inline">// ==================== 角色字段映射 ====================</span>
    
    <span class="hljs-comment inline">/** 用户角色字段名 - 不同API中用户角色的字段名（如user、human、customer） */</span>
    <span class="hljs-keyword inline">private</span> String requestUserRoleField;
    
    <span class="hljs-comment inline">/** 助手角色字段名 - 不同API中助手角色的字段名（如assistant、ai、agent） */</span>
    <span class="hljs-keyword inline">private</span> String requestAssistantField;
    
    <span class="hljs-comment inline">/** 系统角色字段名 - 系统消息的角色字段名（如system、instruction） */</span>
    <span class="hljs-keyword inline">private</span> String requestSystemField;

    <span class="hljs-comment inline">// ==================== 消息路径配置系统 ====================</span>
    
    <span class="hljs-comment inline">/** 
     * 消息组路径 - 指定消息数组在请求JSON中的位置
     * 例如：&#x27;messages&#x27; 或 &#x27;conversation.messages&#x27; 或 &#x27;data.chat.messages&#x27;
     */</span>
    <span class="hljs-keyword inline">private</span> String requestMessageGroupPath;
    
    <span class="hljs-comment inline">/** 
     * 角色路径 - 指定单个消息对象中角色字段的名称
     * 例如：&#x27;role&#x27; 或 &#x27;speaker&#x27; 或 &#x27;type&#x27;
     */</span>
    <span class="hljs-keyword inline">private</span> String requestRolePathFromGroup;
    
    <span class="hljs-comment inline">/** 
     * 文本路径 - 指定单个消息对象中内容字段的名称
     * 例如：&#x27;content&#x27; 或 &#x27;text&#x27; 或 &#x27;message&#x27;
     */</span>
    <span class="hljs-keyword inline">private</span> String requestTextPathFromGroup;
    
    <span class="hljs-comment inline">/** 
     * 响应文本路径 - 指定如何从响应JSON中提取AI回复内容
     * 例如：&#x27;choices.0.message.content&#x27; 或 &#x27;response.text&#x27;
     */</span>
    <span class="hljs-keyword inline">private</span> String responseTextPath;
    
    <span class="hljs-comment inline">/** 
     * 思考文本路径 - 指定如何提取AI的思考过程（如果支持）
     * 例如：&#x27;choices.0.message.thinking&#x27; 或 &#x27;response.reasoning&#x27;
     */</span>
    <span class="hljs-keyword inline">private</span> String responseThinkingTextPath;

    <span class="hljs-comment inline">// ==================== 监控和统计字段 ====================</span>
    
    <span class="hljs-comment inline">/** 最后使用时间 - 用于统计分析和健康检查 */</span>
    <span class="hljs-keyword inline">private</span> LocalDateTime lastUsedTime;

    <span class="hljs-comment inline">// ==================== 临时字段 ====================</span>
    
    <span class="hljs-comment inline">/** 
     * 解密密钥 - 临时字段，不持久化到数据库
     * 用于在运行时解密加密的API密钥
     */</span>
    <span class="hljs-meta inline">@TableField(exist = false)</span>
    <span class="hljs-keyword inline">private</span> String secretKey;
}
</code></pre>
            </div>
        
<h3 id="httputils：http请求处理的完整实现" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#httputils：http请求处理的完整实现" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to HttpUtils：HTTP请求处理的完整实现">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            HttpUtils：HTTP请求处理的完整实现
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="package%20com.chat.allchatonthis.common.util.http%3B%0Aimport%20cn.hutool.core.codec.Base64%3B%0Aimport%20cn.hutool.core.map.TableMap%3B%0Aimport%20cn.hutool.core.net.url.UrlBuilder%3B%0Aimport%20cn.hutool.core.util.ReflectUtil%3B%0Aimport%20cn.hutool.core.util.StrUtil%3B%0Aimport%20cn.hutool.http.HttpRequest%3B%0Aimport%20cn.hutool.http.HttpResponse%3B%0Aimport%20com.chat.allchatonthis.common.exception.ServiceException%3B%0Aimport%20com.chat.allchatonthis.common.util.json.JsonUtils%3B%0Aimport%20com.chat.allchatonthis.entity.dataobject.ConversationMessageDO%3B%0Aimport%20com.chat.allchatonthis.entity.dataobject.UserConfigDO%3B%0Aimport%20jakarta.servlet.http.HttpServletRequest%3B%0Aimport%20lombok.extern.slf4j.Slf4j%3B%0Aimport%20org.springframework.util.StringUtils%3B%0Aimport%20javax.crypto.Cipher%3B%0Aimport%20javax.crypto.spec.SecretKeySpec%3B%0Aimport%20java.nio.charset.StandardCharsets%3B%0Aimport%20java.security.MessageDigest%3B%0Aimport%20java.security.NoSuchAlgorithmException%3B%0Aimport%20java.util.ArrayList%3B%0Aimport%20java.util.HashMap%3B%0Aimport%20java.util.List%3B%0Aimport%20java.util.Map%3B%0Aimport%20static%20com.chat.allchatonthis.common.enums.ErrorCodeConstants.CONFIG_NOT_EXISTS%3B%0A%2F**%0A*%20HTTP%E5%B7%A5%E5%85%B7%E7%B1%BB%20-%20%E5%A4%84%E7%90%86API%E8%AF%B7%E6%B1%82%E7%9A%84%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91%0A*%2F%0A%40Slf4j%0Apublic%20class%20HttpUtils%20%7B%0A%2F**%0A*%20%E5%87%86%E5%A4%87%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%EF%BC%88%E7%AE%80%E5%8D%95%E7%89%88%E6%9C%AC%EF%BC%89-%20%E5%A4%84%E7%90%86%E5%8D%95%E4%B8%AA%E6%B6%88%E6%81%AF%0A*%0A*%20%40param%20config%20%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE%0A*%20%40param%20messageText%20%E6%B6%88%E6%81%AF%E6%96%87%E6%9C%AC%0A*%20%40return%20%E5%8C%85%E5%90%ABheaders%E5%92%8CrequestBody%E7%9A%84Map%0A*%2F%0Apublic%20static%20Map%20prepareRequestData(UserConfigDO%20config%2C%20String%20messageText)%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E6%9E%84%E5%BB%BA%E8%AF%B7%E6%B1%82%E5%A4%B4%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E9%98%B2%E5%BE%A1%E6%80%A7%E6%8B%B7%E8%B4%9D%EF%BC%9A%E9%81%BF%E5%85%8D%E4%BF%AE%E6%94%B9%E5%8E%9F%E5%A7%8B%E9%85%8D%E7%BD%AE%EF%BC%8C%E7%A1%AE%E4%BF%9D%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%0AMap%20headers%20%3D%20new%20HashMap(%0Aconfig.getHeaders()%20!%3D%20null%20%3F%20config.getHeaders()%20%3A%20new%20HashMap()%0A)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E5%A4%84%E7%90%86API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0AString%20apiKey%20%3D%20config.getApiKey()%3B%0A%2F%2F%20%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E4%B8%BA%E5%8A%A0%E5%AF%86%E5%AF%86%E9%92%A5%EF%BC%88enc%3A%E5%89%8D%E7%BC%80%EF%BC%89%E5%B9%B6%E4%B8%94%E6%9C%89%E8%A7%A3%E5%AF%86%E5%AF%86%E9%92%A5%0Aif%20(apiKey%20!%3D%20null%20%26%26%20apiKey.startsWith(%22enc%3A%22)%20%26%26%20StringUtils.hasText(config.getSecretKey()))%20%7B%0Atry%20%7B%0A%2F%2F%20%E5%8E%BB%E6%8E%89enc%3A%E5%89%8D%E7%BC%80%EF%BC%8C%E8%B0%83%E7%94%A8%E8%A7%A3%E5%AF%86%E6%96%B9%E6%B3%95%0AapiKey%20%3D%20decryptApiKey(apiKey.substring(4)%2C%20config.getSecretKey())%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%E5%A4%B1%E8%B4%A5%22%2C%20e)%3B%0Athrow%20new%20ServiceException(CONFIG_NOT_EXISTS%2C%20%22API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%E5%A4%B1%E8%B4%A5%3A%20%22%20%2B%20e.getMessage())%3B%0A%7D%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E6%A0%B9%E6%8D%AE%E7%AD%96%E7%95%A5%E6%94%BE%E7%BD%AEAPI%E5%AF%86%E9%92%A5%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E7%AD%96%E7%95%A51%EF%BC%9A%E6%94%BE%E5%9C%A8Authorization%20header%E4%B8%AD%EF%BC%88%E9%BB%98%E8%AE%A4%E7%AD%96%E7%95%A5%EF%BC%89%0Aif%20(%22header%22.equals(config.getApiKeyPlacement())%20%7C%7C%20config.getApiKeyPlacement()%20%3D%3D%20null)%20%7B%0Aheaders.put(%22Authorization%22%2C%20%22Bearer%20%22%20%2B%20apiKey)%3B%0A%7D%0A%2F%2F%20%E7%AD%96%E7%95%A52%EF%BC%9A%E6%94%BE%E5%9C%A8%E8%87%AA%E5%AE%9A%E4%B9%89header%E4%B8%AD%EF%BC%88%E5%A6%82x-api-key%EF%BC%89%0Aelse%20if%20(%22custom_header%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyHeader()%20!%3D%20null)%20%7B%0Aheaders.put(config.getApiKeyHeader()%2C%20apiKey)%3B%0A%7D%0A%2F%2F%20%E7%A1%AE%E4%BF%9DContent-Type%E5%AD%98%E5%9C%A8%EF%BC%88%E9%BB%98%E8%AE%A4%E4%B8%BAapplication%2Fjson%EF%BC%89%0Aif%20(!headers.containsKey(%22Content-Type%22))%20%7B%0Aheaders.put(%22Content-Type%22%2C%20%22application%2Fjson%22)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A44%EF%BC%9A%E6%9E%84%E5%BB%BA%E8%AF%B7%E6%B1%82%E4%BD%93%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E5%85%8B%E9%9A%86%E8%AF%B7%E6%B1%82%E6%A8%A1%E6%9D%BF%EF%BC%8C%E9%81%BF%E5%85%8D%E4%BF%AE%E6%94%B9%E5%8E%9F%E5%A7%8B%E9%85%8D%E7%BD%AE%0AMap%20requestBody%20%3D%20new%20HashMap(config.getRequestTemplate())%3B%0A%2F%2F%20%E7%AD%96%E7%95%A53%EF%BC%9A%E5%B0%86API%E5%AF%86%E9%92%A5%E6%94%BE%E5%9C%A8%E8%AF%B7%E6%B1%82%E4%BD%93%E4%B8%AD%0Aif%20(%22body%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyBodyPath()%20!%3D%20null)%20%7B%0AJsonUtils.setValueByPath(requestBody%2C%20config.getApiKeyBodyPath()%2C%20apiKey)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A45%EF%BC%9A%E5%A4%84%E7%90%86%E6%B6%88%E6%81%AF%E5%86%85%E5%AE%B9%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E5%A6%82%E6%9E%9C%E6%9C%89%E6%B6%88%E6%81%AF%E6%96%87%E6%9C%AC%E5%92%8C%E6%B6%88%E6%81%AF%E7%BB%84%E8%B7%AF%E5%BE%84%EF%BC%8C%E5%88%9B%E5%BB%BA%E6%B6%88%E6%81%AF%E5%AF%B9%E8%B1%A1%0Aif%20(StringUtils.hasText(messageText)%20%26%26%20StringUtils.hasText(config.getRequestMessageGroupPath()))%20%7B%0A%2F%2F%20%E8%8E%B7%E5%8F%96%E5%AD%97%E6%AE%B5%E5%90%8D%E9%85%8D%E7%BD%AE%EF%BC%88%E5%B8%A6%E9%BB%98%E8%AE%A4%E5%80%BC%EF%BC%89%0AString%20rolePath%20%3D%20StringUtils.hasText(config.getRequestRolePathFromGroup())%20%3F%0Aconfig.getRequestRolePathFromGroup()%20%3A%20%22role%22%3B%0AString%20textPath%20%3D%20StringUtils.hasText(config.getRequestTextPathFromGroup())%20%3F%0Aconfig.getRequestTextPathFromGroup()%20%3A%20%22content%22%3B%0AString%20roleValue%20%3D%20StringUtils.hasText(config.getRequestUserRoleField())%20%3F%0Aconfig.getRequestUserRoleField()%20%3A%20%22user%22%3B%0A%2F%2F%20%E6%9E%84%E5%BB%BA%E6%B6%88%E6%81%AF%E5%AF%B9%E8%B1%A1%0AMap%20messageObj%20%3D%20new%20HashMap()%3B%0AmessageObj.put(rolePath%2C%20roleValue)%3B%0AmessageObj.put(textPath%2C%20messageText)%3B%0A%2F%2F%20%E5%88%9B%E5%BB%BA%E6%B6%88%E6%81%AF%E6%95%B0%E7%BB%84%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%88%B0%E8%AF%B7%E6%B1%82%E4%BD%93%E4%B8%AD%0AList%3E%20messages%20%3D%20new%20ArrayList()%3B%0Amessages.add(messageObj)%3B%0AJsonUtils.setValueByPath(requestBody%2C%20config.getRequestMessageGroupPath()%2C%20messages)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A46%EF%BC%9A%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0AMap%20result%20%3D%20new%20HashMap()%3B%0Aresult.put(%22headers%22%2C%20headers)%3B%0Aresult.put(%22requestBody%22%2C%20requestBody)%3B%0Areturn%20result%3B%0A%7D%0A%2F**%0A*%20%E5%87%86%E5%A4%87%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%EF%BC%88%E5%AE%8C%E6%95%B4%E7%89%88%E6%9C%AC%EF%BC%89-%20%E5%A4%84%E7%90%86%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%0A*%0A*%20%40param%20config%20%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE%0A*%20%40param%20messageText%20%E6%96%B0%E6%B6%88%E6%81%AF%E6%96%87%E6%9C%AC%0A*%20%40param%20conversationMessages%20%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%0A*%20%40return%20%E5%8C%85%E5%90%ABheaders%E5%92%8CrequestBody%E7%9A%84Map%0A*%2F%0Apublic%20static%20Map%20prepareRequestData(UserConfigDO%20config%2C%20String%20messageText%2C%0AList%20conversationMessages)%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A41-4%EF%BC%9A%E5%A4%8D%E7%94%A8%E7%AE%80%E5%8D%95%E7%89%88%E6%9C%AC%E7%9A%84%E9%80%BB%E8%BE%91%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E6%9E%84%E5%BB%BA%E8%AF%B7%E6%B1%82%E5%A4%B4%0AMap%20headers%20%3D%20new%20HashMap(%0Aconfig.getHeaders()%20!%3D%20null%20%3F%20config.getHeaders()%20%3A%20new%20HashMap()%0A)%3B%0A%2F%2F%20%E5%A4%84%E7%90%86API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%0AString%20apiKey%20%3D%20config.getApiKey()%3B%0Aif%20(apiKey%20!%3D%20null%20%26%26%20apiKey.startsWith(%22enc%3A%22)%20%26%26%20StringUtils.hasText(config.getSecretKey()))%20%7B%0Atry%20%7B%0AapiKey%20%3D%20decryptApiKey(apiKey.substring(4)%2C%20config.getSecretKey())%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%E5%A4%B1%E8%B4%A5%22%2C%20e)%3B%0Athrow%20new%20ServiceException(CONFIG_NOT_EXISTS%2C%20%22API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%E5%A4%B1%E8%B4%A5%3A%20%22%20%2B%20e.getMessage())%3B%0A%7D%0A%7D%0A%2F%2F%20%E6%A0%B9%E6%8D%AE%E7%AD%96%E7%95%A5%E6%94%BE%E7%BD%AEAPI%E5%AF%86%E9%92%A5%0Aif%20(%22header%22.equals(config.getApiKeyPlacement())%20%7C%7C%20config.getApiKeyPlacement()%20%3D%3D%20null)%20%7B%0Aheaders.put(%22Authorization%22%2C%20%22Bearer%20%22%20%2B%20apiKey)%3B%0A%7D%20else%20if%20(%22custom_header%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyHeader()%20!%3D%20null)%20%7B%0Aheaders.put(config.getApiKeyHeader()%2C%20apiKey)%3B%0A%7D%0Aif%20(!headers.containsKey(%22Content-Type%22))%20%7B%0Aheaders.put(%22Content-Type%22%2C%20%22application%2Fjson%22)%3B%0A%7D%0A%2F%2F%20%E6%9E%84%E5%BB%BA%E8%AF%B7%E6%B1%82%E4%BD%93%0AMap%20requestBody%20%3D%20new%20HashMap(config.getRequestTemplate())%3B%0Aif%20(%22body%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyBodyPath()%20!%3D%20null)%20%7B%0AJsonUtils.setValueByPath(requestBody%2C%20config.getApiKeyBodyPath()%2C%20apiKey)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A45%EF%BC%9A%E5%A4%84%E7%90%86%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%EF%BC%88%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91%EF%BC%89%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E8%8E%B7%E5%8F%96%E5%AD%97%E6%AE%B5%E5%90%8D%E9%85%8D%E7%BD%AE%0AString%20rolePath%20%3D%20StringUtils.hasText(config.getRequestRolePathFromGroup())%20%3F%0Aconfig.getRequestRolePathFromGroup()%20%3A%20%22role%22%3B%0AString%20textPath%20%3D%20StringUtils.hasText(config.getRequestTextPathFromGroup())%20%3F%0Aconfig.getRequestTextPathFromGroup()%20%3A%20%22content%22%3B%0AString%20userRoleValue%20%3D%20StringUtils.hasText(config.getRequestUserRoleField())%20%3F%0Aconfig.getRequestUserRoleField()%20%3A%20%22user%22%3B%0AString%20assistantRoleValue%20%3D%20StringUtils.hasText(config.getRequestAssistantField())%20%3F%0Aconfig.getRequestAssistantField()%20%3A%20%22assistant%22%3B%0A%2F%2F%20%E6%9E%84%E5%BB%BA%E5%AE%8C%E6%95%B4%E7%9A%84%E6%B6%88%E6%81%AF%E7%BB%84%0Aif%20(StringUtils.hasText(config.getRequestMessageGroupPath())%20%26%26%0A(conversationMessages%20!%3D%20null%20%7C%7C%20messageText%20!%3D%20null))%20%7B%0AList%3E%20messages%20%3D%20new%20ArrayList()%3B%0A%2F%2F%20%E6%B7%BB%E5%8A%A0%E5%8E%86%E5%8F%B2%E6%B6%88%E6%81%AF%0Aif%20(conversationMessages%20!%3D%20null)%20%7B%0Afor%20(ConversationMessageDO%20message%20%3A%20conversationMessages)%20%7B%0A%2F%2F%20%E8%B7%B3%E8%BF%87%E7%B3%BB%E7%BB%9F%E6%B6%88%E6%81%AF%EF%BC%88%E7%B3%BB%E7%BB%9F%E6%B6%88%E6%81%AF%E9%80%9A%E5%B8%B8%E4%B8%8D%E5%8F%82%E4%B8%8E%E5%AF%B9%E8%AF%9D%E6%B5%81%EF%BC%89%0Aif%20(%22system%22.equals(message.getRole()))%20%7B%0Acontinue%3B%0A%7D%0AMap%20messageObj%20%3D%20new%20HashMap()%3B%0A%2F%2F%20%E8%A7%92%E8%89%B2%E6%98%A0%E5%B0%84%EF%BC%9A%E5%B0%86%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E8%A7%92%E8%89%B2%E6%98%A0%E5%B0%84%E4%B8%BAAPI%E6%89%80%E9%9C%80%E7%9A%84%E8%A7%92%E8%89%B2%0Aif%20(%22user%22.equals(message.getRole()))%20%7B%0AmessageObj.put(rolePath%2C%20userRoleValue)%3B%0A%7D%20else%20if%20(%22assistant%22.equals(message.getRole()))%20%7B%0AmessageObj.put(rolePath%2C%20assistantRoleValue)%3B%0A%7D%20else%20%7B%0A%2F%2F%20%E5%85%B6%E4%BB%96%E8%A7%92%E8%89%B2%E4%BF%9D%E6%8C%81%E5%8E%9F%E6%A0%B7%0AmessageObj.put(rolePath%2C%20message.getRole())%3B%0A%7D%0A%2F%2F%20%E8%AE%BE%E7%BD%AE%E6%B6%88%E6%81%AF%E5%86%85%E5%AE%B9%0AmessageObj.put(textPath%2C%20message.getContent())%3B%0Amessages.add(messageObj)%3B%0A%7D%0A%7D%0A%2F%2F%20%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E7%94%A8%E6%88%B7%E6%B6%88%E6%81%AF%0Aif%20(messageText%20!%3D%20null)%20%7B%0AMap%20userMessage%20%3D%20new%20HashMap()%3B%0AuserMessage.put(rolePath%2C%20userRoleValue)%3B%0AuserMessage.put(textPath%2C%20messageText)%3B%0Amessages.add(userMessage)%3B%0A%7D%0A%2F%2F%20%E5%B0%86%E6%B6%88%E6%81%AF%E7%BB%84%E8%AE%BE%E7%BD%AE%E5%88%B0%E8%AF%B7%E6%B1%82%E4%BD%93%E4%B8%AD%0AJsonUtils.setValueByPath(requestBody%2C%20config.getRequestMessageGroupPath()%2C%20messages)%3B%0A%7D%0A%2F%2F%20%E5%90%91%E5%90%8E%E5%85%BC%E5%AE%B9%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E6%B6%88%E6%81%AF%E7%BB%84%E8%B7%AF%E5%BE%84%EF%BC%8C%E7%9B%B4%E6%8E%A5%E8%AE%BE%E7%BD%AE%E6%96%87%E6%9C%AC%0Aelse%20if%20(messageText%20!%3D%20null%20%26%26%20StringUtils.hasText(config.getRequestTextPathFromGroup()))%20%7B%0AJsonUtils.setValueByPath(requestBody%2C%20config.getRequestTextPathFromGroup()%2C%20messageText)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A46%EF%BC%9A%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0AMap%20result%20%3D%20new%20HashMap()%3B%0Aresult.put(%22headers%22%2C%20headers)%3B%0Aresult.put(%22requestBody%22%2C%20requestBody)%3B%0Areturn%20result%3B%0A%7D%0A%2F**%0A*%20%E8%A7%A3%E5%AF%86API%E5%AF%86%E9%92%A5%20-%20%E5%85%BC%E5%AE%B9CryptoJS%E7%9A%84AES%E8%A7%A3%E5%AF%86%0A*%0A*%20%40param%20encryptedApiKey%20%E5%8A%A0%E5%AF%86%E7%9A%84API%E5%AF%86%E9%92%A5%EF%BC%88Base64%E6%A0%BC%E5%BC%8F%EF%BC%89%0A*%20%40param%20secretKey%20%E8%A7%A3%E5%AF%86%E5%AF%86%E9%92%A5%0A*%20%40return%20%E8%A7%A3%E5%AF%86%E5%90%8E%E7%9A%84API%E5%AF%86%E9%92%A5%0A*%2F%0Apublic%20static%20String%20decryptApiKey(String%20encryptedApiKey%2C%20String%20secretKey)%20%7B%0Atry%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A41%EF%BC%9ABase64%E8%A7%A3%E7%A0%81%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20CryptoJS%E4%BD%BF%E7%94%A8Base64%E7%BC%96%E7%A0%81%E4%BC%A0%E8%BE%93%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AE%0Abyte%5B%5D%20cipherData%20%3D%20java.util.Base64.getDecoder().decode(encryptedApiKey)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E8%A7%A3%E6%9E%90OpenSSL%E6%A0%BC%E5%BC%8F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20CryptoJS%E9%BB%98%E8%AE%A4%E4%BD%BF%E7%94%A8OpenSSL%E6%A0%BC%E5%BC%8F%3A%20%22Salted__%22%20%2B%208%E5%AD%97%E8%8A%82%E7%9B%90%20%2B%20%E5%AF%86%E6%96%87%0A%2F%2F%20%E6%80%BB%E5%85%B116%E5%AD%97%E8%8A%82%E7%9A%84%E5%89%8D%E7%BC%80%EF%BC%888%E5%AD%97%E8%8A%82%22Salted__%22%20%2B%208%E5%AD%97%E8%8A%82%E7%9B%90%E5%80%BC%EF%BC%89%0Abyte%5B%5D%20saltBytes%20%3D%20new%20byte%5B8%5D%3B%0Abyte%5B%5D%20cipherBytes%20%3D%20new%20byte%5BcipherData.length%20-%2016%5D%3B%0A%2F%2F%20%E6%8F%90%E5%8F%96%E7%9B%90%E5%80%BC%EF%BC%88%E8%B7%B3%E8%BF%87%E5%89%8D8%E5%AD%97%E8%8A%82%E7%9A%84%22Salted__%22%EF%BC%89%0ASystem.arraycopy(cipherData%2C%208%2C%20saltBytes%2C%200%2C%208)%3B%0A%2F%2F%20%E6%8F%90%E5%8F%96%E5%AE%9E%E9%99%85%E5%AF%86%E6%96%87%EF%BC%88%E8%B7%B3%E8%BF%87%E5%89%8D16%E5%AD%97%E8%8A%82%EF%BC%89%0ASystem.arraycopy(cipherData%2C%2016%2C%20cipherBytes%2C%200%2C%20cipherData.length%20-%2016)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E6%B4%BE%E7%94%9F%E5%AF%86%E9%92%A5%E5%92%8CIV%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E4%BD%BF%E7%94%A8EVP_BytesToKey%E7%AE%97%E6%B3%95%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E5%90%91%E9%87%8F%0Abyte%5B%5D%5B%5D%20keyAndIV%20%3D%20EVP_BytesToKey(32%2C%2016%2C%20secretKey.getBytes(StandardCharsets.UTF_8)%2C%20saltBytes%2C%201)%3B%0Abyte%5B%5D%20key%20%3D%20keyAndIV%5B0%5D%3B%20%20%2F%2F%2032%E5%AD%97%E8%8A%82%E5%AF%86%E9%92%A5%EF%BC%88AES-256%EF%BC%89%0Abyte%5B%5D%20iv%20%3D%20keyAndIV%5B1%5D%3B%20%20%20%2F%2F%2016%E5%AD%97%E8%8A%82IV%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A44%EF%BC%9AAES%E8%A7%A3%E5%AF%86%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E5%88%9B%E5%BB%BAAES%E5%AF%86%E9%92%A5%E8%A7%84%E8%8C%83%0ASecretKeySpec%20secretKeySpec%20%3D%20new%20SecretKeySpec(key%2C%20%22AES%22)%3B%0A%2F%2F%20%E5%88%9B%E5%BB%BAIV%E5%8F%82%E6%95%B0%E8%A7%84%E8%8C%83%0Ajavax.crypto.spec.IvParameterSpec%20ivSpec%20%3D%20new%20javax.crypto.spec.IvParameterSpec(iv)%3B%0A%2F%2F%20%E5%88%9D%E5%A7%8B%E5%8C%96%E8%A7%A3%E5%AF%86%E5%99%A8%EF%BC%9AAES%2FCBC%2FPKCS5Padding%EF%BC%88%E4%B8%8ECryptoJS%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE%E4%B8%80%E8%87%B4%EF%BC%89%0ACipher%20cipher%20%3D%20Cipher.getInstance(%22AES%2FCBC%2FPKCS5Padding%22)%3B%0Acipher.init(Cipher.DECRYPT_MODE%2C%20secretKeySpec%2C%20ivSpec)%3B%0A%2F%2F%20%E6%89%A7%E8%A1%8C%E8%A7%A3%E5%AF%86%0Abyte%5B%5D%20decryptedBytes%20%3D%20cipher.doFinal(cipherBytes)%3B%0A%2F%2F%20%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%B9%B6%E8%BF%94%E5%9B%9E%0Areturn%20new%20String(decryptedBytes%2C%20StandardCharsets.UTF_8)%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%E5%A4%B1%E8%B4%A5%22%2C%20e)%3B%0Athrow%20new%20ServiceException(CONFIG_NOT_EXISTS%2C%20%22API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%E5%A4%B1%E8%B4%A5%3A%20%22%20%2B%20e.getMessage())%3B%0A%7D%0A%7D%0A%2F**%0A*%20EVP_BytesToKey%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0%20-%20%E5%AF%86%E9%92%A5%E6%B4%BE%E7%94%9F%E5%87%BD%E6%95%B0%0A*%0A*%20%E8%BF%99%E6%98%AFOpenSSL%E6%A0%87%E5%87%86%E7%9A%84%E5%AF%86%E9%92%A5%E6%B4%BE%E7%94%9F%E7%AE%97%E6%B3%95%EF%BC%8C%E7%94%A8%E4%BA%8E%E4%BB%8E%E5%AF%86%E7%A0%81%E5%92%8C%E7%9B%90%E5%80%BC%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5%E5%92%8CIV%0A*%0A*%20%40param%20keyLen%20%E5%AF%86%E9%92%A5%E9%95%BF%E5%BA%A6%EF%BC%88%E5%AD%97%E8%8A%82%EF%BC%89%0A*%20%40param%20ivLen%20IV%E9%95%BF%E5%BA%A6%EF%BC%88%E5%AD%97%E8%8A%82%EF%BC%89%0A*%20%40param%20password%20%E5%AF%86%E7%A0%81%0A*%20%40param%20salt%20%E7%9B%90%E5%80%BC%0A*%20%40param%20iterations%20%E8%BF%AD%E4%BB%A3%E6%AC%A1%E6%95%B0%0A*%20%40return%20%5B%E5%AF%86%E9%92%A5%2C%20IV%5D%0A*%2F%0Aprivate%20static%20byte%5B%5D%5B%5D%20EVP_BytesToKey(int%20keyLen%2C%20int%20ivLen%2C%20byte%5B%5D%20password%2C%20byte%5B%5D%20salt%2C%20int%20iterations)%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0Abyte%5B%5D%20key%20%3D%20new%20byte%5BkeyLen%5D%3B%0Abyte%5B%5D%20iv%20%3D%20new%20byte%5BivLen%5D%3B%0Abyte%5B%5D%20concatenatedHashBytes%20%3D%20new%20byte%5B0%5D%3B%0A%2F%2F%20%E5%88%9D%E5%A7%8B%E5%8C%96MD5%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81%0AMessageDigest%20md5%3B%0Atry%20%7B%0Amd5%20%3D%20MessageDigest.getInstance(%22MD5%22)%3B%0A%7D%20catch%20(NoSuchAlgorithmException%20e)%20%7B%0Athrow%20new%20RuntimeException(%22MD5%E7%AE%97%E6%B3%95%E4%B8%8D%E5%8F%AF%E7%94%A8%22%2C%20e)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E8%AE%A1%E7%AE%97%E9%9C%80%E8%A6%81%E7%9A%84%E5%93%88%E5%B8%8C%E8%BD%AE%E6%95%B0%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0Aint%20hashLen%20%3D%2016%3B%20%2F%2F%20MD5%E8%BE%93%E5%87%BA%E9%95%BF%E5%BA%A6%0Aint%20keyAndIvLen%20%3D%20keyLen%20%2B%20ivLen%3B%0Aint%20numHashes%20%3D%20(keyAndIvLen%20%2B%20hashLen%20-%201)%20%2F%20hashLen%3B%20%2F%2F%20%E5%90%91%E4%B8%8A%E5%8F%96%E6%95%B4%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E7%94%9F%E6%88%90%E5%93%88%E5%B8%8C%E9%93%BE%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0Abyte%5B%5D%20result%20%3D%20new%20byte%5BnumHashes%20*%20hashLen%5D%3B%0Aint%20resultLen%20%3D%200%3B%0Afor%20(int%20i%20%3D%201%3B%20i%20%2F%2F%20%E7%AC%AC%E4%B8%80%E8%BD%AE%EF%BC%9A%E5%8F%AA%E4%BD%BF%E7%94%A8%E5%AF%86%E7%A0%81%E5%92%8C%E7%9B%90%0A%2F%2F%20%E5%90%8E%E7%BB%AD%E8%BD%AE%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%89%8D%E4%B8%80%E8%BD%AE%E7%9A%84%E7%BB%93%E6%9E%9C%20%2B%20%E5%AF%86%E7%A0%81%20%2B%20%E7%9B%90%0Amd5.reset()%3B%0Aif%20(i%20%3E%201)%20%7B%0Amd5.update(concatenatedHashBytes)%3B%0A%7D%0Amd5.update(password)%3B%0Aif%20(salt%20!%3D%20null)%20%7B%0Amd5.update(salt)%3B%0A%7D%0AconcatenatedHashBytes%20%3D%20md5.digest()%3B%0A%2F%2F%20%E6%89%A7%E8%A1%8C%E9%A2%9D%E5%A4%96%E7%9A%84%E8%BF%AD%E4%BB%A3%EF%BC%88%E9%80%9A%E5%B8%B8%E4%B8%BA1%EF%BC%8C%E5%8D%B3%E4%B8%8D%E9%A2%9D%E5%A4%96%E8%BF%AD%E4%BB%A3%EF%BC%89%0Afor%20(int%20j%20%3D%201%3B%20j%20%2F%2F%20%E5%B0%86%E5%93%88%E5%B8%8C%E7%BB%93%E6%9E%9C%E6%8B%B7%E8%B4%9D%E5%88%B0%E7%BB%93%E6%9E%9C%E6%95%B0%E7%BB%84%E4%B8%AD%0ASystem.arraycopy(%0AconcatenatedHashBytes%2C%200%2C%0Aresult%2C%20resultLen%2C%0AMath.min(concatenatedHashBytes.length%2C%20result.length%20-%20resultLen)%0A)%3B%0AresultLen%20%2B%3D%20concatenatedHashBytes.length%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A44%EF%BC%9A%E5%88%86%E7%A6%BB%E5%AF%86%E9%92%A5%E5%92%8CIV%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E4%BB%8E%E7%BB%93%E6%9E%9C%E4%B8%AD%E6%8F%90%E5%8F%96%E5%AF%86%E9%92%A5%0ASystem.arraycopy(result%2C%200%2C%20key%2C%200%2C%20keyLen)%3B%0A%2F%2F%20%E4%BB%8E%E7%BB%93%E6%9E%9C%E4%B8%AD%E6%8F%90%E5%8F%96IV%0ASystem.arraycopy(result%2C%20keyLen%2C%20iv%2C%200%2C%20ivLen)%3B%0Areturn%20new%20byte%5B%5D%5B%5D%7Bkey%2C%20iv%7D%3B%0A%7D%0A%2F**%0A*%20HTTP%20POST%E8%AF%B7%E6%B1%82%20-%20%E5%9F%BA%E4%BA%8EHuTool%E7%9A%84%E5%B0%81%E8%A3%85%0A*%0A*%20%40param%20url%20%E8%AF%B7%E6%B1%82URL%0A*%20%40param%20headers%20%E8%AF%B7%E6%B1%82%E5%A4%B4%0A*%20%40param%20requestBody%20%E8%AF%B7%E6%B1%82%E4%BD%93%0A*%20%40return%20%E5%93%8D%E5%BA%94%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%2F%0Apublic%20static%20String%20post(String%20url%2C%20Map%20headers%2C%20String%20requestBody)%20%7B%0Atry%20(HttpResponse%20response%20%3D%20HttpRequest.post(url)%0A.addHeaders(headers)%0A.body(requestBody)%0A.execute())%20%7B%0Areturn%20response.body()%3B%0A%7D%0A%7D%0A%2F**%0A*%20HTTP%20GET%E8%AF%B7%E6%B1%82%20-%20%E5%9F%BA%E4%BA%8EHuTool%E7%9A%84%E5%B0%81%E8%A3%85%0A*%0A*%20%40param%20url%20%E8%AF%B7%E6%B1%82URL%0A*%20%40param%20headers%20%E8%AF%B7%E6%B1%82%E5%A4%B4%0A*%20%40return%20%E5%93%8D%E5%BA%94%E5%AD%97%E7%AC%A6%E4%B8%B2%0A*%2F%0Apublic%20static%20String%20get(String%20url%2C%20Map%20headers)%20%7B%0Atry%20(HttpResponse%20response%20%3D%20HttpRequest.get(url)%0A.addHeaders(headers)%0A.execute())%20%7B%0Areturn%20response.body()%3B%0A%7D%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">package</span> com.chat.allchatonthis.common.util.http;

<span class="hljs-keyword inline">import</span> cn.hutool.core.codec.Base64;
<span class="hljs-keyword inline">import</span> cn.hutool.core.map.TableMap;
<span class="hljs-keyword inline">import</span> cn.hutool.core.net.url.UrlBuilder;
<span class="hljs-keyword inline">import</span> cn.hutool.core.util.ReflectUtil;
<span class="hljs-keyword inline">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword inline">import</span> cn.hutool.http.HttpRequest;
<span class="hljs-keyword inline">import</span> cn.hutool.http.HttpResponse;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.common.exception.ServiceException;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.common.util.json.JsonUtils;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.entity.dataobject.ConversationMessageDO;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.entity.dataobject.UserConfigDO;
<span class="hljs-keyword inline">import</span> jakarta.servlet.http.HttpServletRequest;
<span class="hljs-keyword inline">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword inline">import</span> org.springframework.util.StringUtils;

<span class="hljs-keyword inline">import</span> javax.crypto.Cipher;
<span class="hljs-keyword inline">import</span> javax.crypto.spec.SecretKeySpec;
<span class="hljs-keyword inline">import</span> java.nio.charset.StandardCharsets;
<span class="hljs-keyword inline">import</span> java.security.MessageDigest;
<span class="hljs-keyword inline">import</span> java.security.NoSuchAlgorithmException;
<span class="hljs-keyword inline">import</span> java.util.ArrayList;
<span class="hljs-keyword inline">import</span> java.util.HashMap;
<span class="hljs-keyword inline">import</span> java.util.List;
<span class="hljs-keyword inline">import</span> java.util.Map;

<span class="hljs-keyword inline">import</span> <span class="hljs-keyword inline">static</span> com.chat.allchatonthis.common.enums.ErrorCodeConstants.CONFIG_NOT_EXISTS;

<span class="hljs-comment inline">/**
 * HTTP工具类 - 处理API请求的核心逻辑
 */</span>
<span class="hljs-meta inline">@Slf4j</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">HttpUtils</span> {

    <span class="hljs-comment inline">/**
     * 准备请求数据（简单版本）- 处理单个消息
     * 
     * <span class="hljs-doctag inline">@param</span> config 用户配置
     * <span class="hljs-doctag inline">@param</span> messageText 消息文本
     * <span class="hljs-doctag inline">@return</span> 包含headers和requestBody的Map
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_ inline">prepareRequestData</span><span class="hljs-params inline">(UserConfigDO config, String messageText)</span> {
        <span class="hljs-comment inline">// ==================== 步骤1：构建请求头 ====================</span>
        
        <span class="hljs-comment inline">// 防御性拷贝：避免修改原始配置，确保线程安全</span>
        Map&lt;String, String&gt; headers = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(
            config.getHeaders() != <span class="hljs-literal inline">null</span> ? config.getHeaders() : <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;()
        );

        <span class="hljs-comment inline">// ==================== 步骤2：处理API密钥解密 ====================</span>
        
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">apiKey</span> <span class="hljs-operator inline">=</span> config.getApiKey();
        
        <span class="hljs-comment inline">// 检查是否为加密密钥（enc:前缀）并且有解密密钥</span>
        <span class="hljs-keyword inline">if</span> (apiKey != <span class="hljs-literal inline">null</span> &amp;&amp; apiKey.startsWith(<span class="hljs-string inline">&quot;enc:&quot;</span>) &amp;&amp; StringUtils.hasText(config.getSecretKey())) {
            <span class="hljs-keyword inline">try</span> {
                <span class="hljs-comment inline">// 去掉enc:前缀，调用解密方法</span>
                apiKey = decryptApiKey(apiKey.substring(<span class="hljs-number inline">4</span>), config.getSecretKey());
            } <span class="hljs-keyword inline">catch</span> (Exception e) {
                log.error(<span class="hljs-string inline">&quot;API密钥解密失败&quot;</span>, e);
                <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIG_NOT_EXISTS, <span class="hljs-string inline">&quot;API密钥解密失败: &quot;</span> + e.getMessage());
            }
        }

        <span class="hljs-comment inline">// ==================== 步骤3：根据策略放置API密钥 ====================</span>
        
        <span class="hljs-comment inline">// 策略1：放在Authorization header中（默认策略）</span>
        <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;header&quot;</span>.equals(config.getApiKeyPlacement()) || config.getApiKeyPlacement() == <span class="hljs-literal inline">null</span>) {
            headers.put(<span class="hljs-string inline">&quot;Authorization&quot;</span>, <span class="hljs-string inline">&quot;Bearer &quot;</span> + apiKey);
        } 
        <span class="hljs-comment inline">// 策略2：放在自定义header中（如x-api-key）</span>
        <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;custom_header&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyHeader() != <span class="hljs-literal inline">null</span>) {
            headers.put(config.getApiKeyHeader(), apiKey);
        }

        <span class="hljs-comment inline">// 确保Content-Type存在（默认为application/json）</span>
        <span class="hljs-keyword inline">if</span> (!headers.containsKey(<span class="hljs-string inline">&quot;Content-Type&quot;</span>)) {
            headers.put(<span class="hljs-string inline">&quot;Content-Type&quot;</span>, <span class="hljs-string inline">&quot;application/json&quot;</span>);
        }

        <span class="hljs-comment inline">// ==================== 步骤4：构建请求体 ====================</span>
        
        <span class="hljs-comment inline">// 克隆请求模板，避免修改原始配置</span>
        Map&lt;String, Object&gt; requestBody = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(config.getRequestTemplate());

        <span class="hljs-comment inline">// 策略3：将API密钥放在请求体中</span>
        <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;body&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyBodyPath() != <span class="hljs-literal inline">null</span>) {
            JsonUtils.setValueByPath(requestBody, config.getApiKeyBodyPath(), apiKey);
        }

        <span class="hljs-comment inline">// ==================== 步骤5：处理消息内容 ====================</span>
        
        <span class="hljs-comment inline">// 如果有消息文本和消息组路径，创建消息对象</span>
        <span class="hljs-keyword inline">if</span> (StringUtils.hasText(messageText) &amp;&amp; StringUtils.hasText(config.getRequestMessageGroupPath())) {
            
            <span class="hljs-comment inline">// 获取字段名配置（带默认值）</span>
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">rolePath</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestRolePathFromGroup()) ?
                    config.getRequestRolePathFromGroup() : <span class="hljs-string inline">&quot;role&quot;</span>;
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">textPath</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestTextPathFromGroup()) ?
                    config.getRequestTextPathFromGroup() : <span class="hljs-string inline">&quot;content&quot;</span>;
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">roleValue</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestUserRoleField()) ?
                    config.getRequestUserRoleField() : <span class="hljs-string inline">&quot;user&quot;</span>;

            <span class="hljs-comment inline">// 构建消息对象</span>
            Map&lt;String, Object&gt; messageObj = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
            messageObj.put(rolePath, roleValue);
            messageObj.put(textPath, messageText);

            <span class="hljs-comment inline">// 创建消息数组并设置到请求体中</span>
            List&lt;Map&lt;String, Object&gt;&gt; messages = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;();
            messages.add(messageObj);
            JsonUtils.setValueByPath(requestBody, config.getRequestMessageGroupPath(), messages);
        }

        <span class="hljs-comment inline">// ==================== 步骤6：返回结果 ====================</span>
        
        Map&lt;String, Object&gt; result = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
        result.put(<span class="hljs-string inline">&quot;headers&quot;</span>, headers);
        result.put(<span class="hljs-string inline">&quot;requestBody&quot;</span>, requestBody);

        <span class="hljs-keyword inline">return</span> result;
    }

    <span class="hljs-comment inline">/**
     * 准备请求数据（完整版本）- 处理对话历史
     * 
     * <span class="hljs-doctag inline">@param</span> config 用户配置
     * <span class="hljs-doctag inline">@param</span> messageText 新消息文本
     * <span class="hljs-doctag inline">@param</span> conversationMessages 对话历史
     * <span class="hljs-doctag inline">@return</span> 包含headers和requestBody的Map
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_ inline">prepareRequestData</span><span class="hljs-params inline">(UserConfigDO config, String messageText, 
                                                        List&lt;ConversationMessageDO&gt; conversationMessages)</span> {
        <span class="hljs-comment inline">// ==================== 步骤1-4：复用简单版本的逻辑 ====================</span>
        
        <span class="hljs-comment inline">// 构建请求头</span>
        Map&lt;String, String&gt; headers = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(
            config.getHeaders() != <span class="hljs-literal inline">null</span> ? config.getHeaders() : <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;()
        );

        <span class="hljs-comment inline">// 处理API密钥解密</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">apiKey</span> <span class="hljs-operator inline">=</span> config.getApiKey();
        <span class="hljs-keyword inline">if</span> (apiKey != <span class="hljs-literal inline">null</span> &amp;&amp; apiKey.startsWith(<span class="hljs-string inline">&quot;enc:&quot;</span>) &amp;&amp; StringUtils.hasText(config.getSecretKey())) {
            <span class="hljs-keyword inline">try</span> {
                apiKey = decryptApiKey(apiKey.substring(<span class="hljs-number inline">4</span>), config.getSecretKey());
            } <span class="hljs-keyword inline">catch</span> (Exception e) {
                log.error(<span class="hljs-string inline">&quot;API密钥解密失败&quot;</span>, e);
                <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIG_NOT_EXISTS, <span class="hljs-string inline">&quot;API密钥解密失败: &quot;</span> + e.getMessage());
            }
        }

        <span class="hljs-comment inline">// 根据策略放置API密钥</span>
        <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;header&quot;</span>.equals(config.getApiKeyPlacement()) || config.getApiKeyPlacement() == <span class="hljs-literal inline">null</span>) {
            headers.put(<span class="hljs-string inline">&quot;Authorization&quot;</span>, <span class="hljs-string inline">&quot;Bearer &quot;</span> + apiKey);
        } <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;custom_header&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyHeader() != <span class="hljs-literal inline">null</span>) {
            headers.put(config.getApiKeyHeader(), apiKey);
        }

        <span class="hljs-keyword inline">if</span> (!headers.containsKey(<span class="hljs-string inline">&quot;Content-Type&quot;</span>)) {
            headers.put(<span class="hljs-string inline">&quot;Content-Type&quot;</span>, <span class="hljs-string inline">&quot;application/json&quot;</span>);
        }

        <span class="hljs-comment inline">// 构建请求体</span>
        Map&lt;String, Object&gt; requestBody = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(config.getRequestTemplate());

        <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;body&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyBodyPath() != <span class="hljs-literal inline">null</span>) {
            JsonUtils.setValueByPath(requestBody, config.getApiKeyBodyPath(), apiKey);
        }

        <span class="hljs-comment inline">// ==================== 步骤5：处理对话历史（核心逻辑） ====================</span>
        
        <span class="hljs-comment inline">// 获取字段名配置</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">rolePath</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestRolePathFromGroup()) ?
                config.getRequestRolePathFromGroup() : <span class="hljs-string inline">&quot;role&quot;</span>;
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">textPath</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestTextPathFromGroup()) ?
                config.getRequestTextPathFromGroup() : <span class="hljs-string inline">&quot;content&quot;</span>;
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">userRoleValue</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestUserRoleField()) ?
                config.getRequestUserRoleField() : <span class="hljs-string inline">&quot;user&quot;</span>;
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">assistantRoleValue</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestAssistantField()) ?
                config.getRequestAssistantField() : <span class="hljs-string inline">&quot;assistant&quot;</span>;

        <span class="hljs-comment inline">// 构建完整的消息组</span>
        <span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getRequestMessageGroupPath()) &amp;&amp; 
            (conversationMessages != <span class="hljs-literal inline">null</span> || messageText != <span class="hljs-literal inline">null</span>)) {
            
            List&lt;Map&lt;String, Object&gt;&gt; messages = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;();

            <span class="hljs-comment inline">// 添加历史消息</span>
            <span class="hljs-keyword inline">if</span> (conversationMessages != <span class="hljs-literal inline">null</span>) {
                <span class="hljs-keyword inline">for</span> (ConversationMessageDO message : conversationMessages) {
                    <span class="hljs-comment inline">// 跳过系统消息（系统消息通常不参与对话流）</span>
                    <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;system&quot;</span>.equals(message.getRole())) {
                        <span class="hljs-keyword inline">continue</span>;
                    }

                    Map&lt;String, Object&gt; messageObj = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
                    
                    <span class="hljs-comment inline">// 角色映射：将数据库中的角色映射为API所需的角色</span>
                    <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;user&quot;</span>.equals(message.getRole())) {
                        messageObj.put(rolePath, userRoleValue);
                    } <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;assistant&quot;</span>.equals(message.getRole())) {
                        messageObj.put(rolePath, assistantRoleValue);
                    } <span class="hljs-keyword inline">else</span> {
                        <span class="hljs-comment inline">// 其他角色保持原样</span>
                        messageObj.put(rolePath, message.getRole());
                    }
                    
                    <span class="hljs-comment inline">// 设置消息内容</span>
                    messageObj.put(textPath, message.getContent());
                    messages.add(messageObj);
                }
            }

            <span class="hljs-comment inline">// 添加新的用户消息</span>
            <span class="hljs-keyword inline">if</span> (messageText != <span class="hljs-literal inline">null</span>) {
                Map&lt;String, Object&gt; userMessage = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
                userMessage.put(rolePath, userRoleValue);
                userMessage.put(textPath, messageText);
                messages.add(userMessage);
            }

            <span class="hljs-comment inline">// 将消息组设置到请求体中</span>
            JsonUtils.setValueByPath(requestBody, config.getRequestMessageGroupPath(), messages);
        }
        <span class="hljs-comment inline">// 向后兼容：如果没有消息组路径，直接设置文本</span>
        <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (messageText != <span class="hljs-literal inline">null</span> &amp;&amp; StringUtils.hasText(config.getRequestTextPathFromGroup())) {
            JsonUtils.setValueByPath(requestBody, config.getRequestTextPathFromGroup(), messageText);
        }

        <span class="hljs-comment inline">// ==================== 步骤6：返回结果 ====================</span>
        
        Map&lt;String, Object&gt; result = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
        result.put(<span class="hljs-string inline">&quot;headers&quot;</span>, headers);
        result.put(<span class="hljs-string inline">&quot;requestBody&quot;</span>, requestBody);

        <span class="hljs-keyword inline">return</span> result;
    }

    <span class="hljs-comment inline">/**
     * 解密API密钥 - 兼容CryptoJS的AES解密
     * 
     * <span class="hljs-doctag inline">@param</span> encryptedApiKey 加密的API密钥（Base64格式）
     * <span class="hljs-doctag inline">@param</span> secretKey 解密密钥
     * <span class="hljs-doctag inline">@return</span> 解密后的API密钥
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">decryptApiKey</span><span class="hljs-params inline">(String encryptedApiKey, String secretKey)</span> {
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-comment inline">// ==================== 步骤1：Base64解码 ====================</span>
            
            <span class="hljs-comment inline">// CryptoJS使用Base64编码传输加密数据</span>
            <span class="hljs-type inline">byte</span>[] cipherData = java.util.Base64.getDecoder().decode(encryptedApiKey);

            <span class="hljs-comment inline">// ==================== 步骤2：解析OpenSSL格式 ====================</span>
            
            <span class="hljs-comment inline">// CryptoJS默认使用OpenSSL格式: &quot;Salted__&quot; + 8字节盐 + 密文</span>
            <span class="hljs-comment inline">// 总共16字节的前缀（8字节&quot;Salted__&quot; + 8字节盐值）</span>
            <span class="hljs-type inline">byte</span>[] saltBytes = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[<span class="hljs-number inline">8</span>];
            <span class="hljs-type inline">byte</span>[] cipherBytes = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[cipherData.length - <span class="hljs-number inline">16</span>];

            <span class="hljs-comment inline">// 提取盐值（跳过前8字节的&quot;Salted__&quot;）</span>
            System.arraycopy(cipherData, <span class="hljs-number inline">8</span>, saltBytes, <span class="hljs-number inline">0</span>, <span class="hljs-number inline">8</span>);
            <span class="hljs-comment inline">// 提取实际密文（跳过前16字节）</span>
            System.arraycopy(cipherData, <span class="hljs-number inline">16</span>, cipherBytes, <span class="hljs-number inline">0</span>, cipherData.length - <span class="hljs-number inline">16</span>);

            <span class="hljs-comment inline">// ==================== 步骤3：派生密钥和IV ====================</span>
            
            <span class="hljs-comment inline">// 使用EVP_BytesToKey算法生成密钥和初始化向量</span>
            <span class="hljs-type inline">byte</span>[][] keyAndIV = EVP_BytesToKey(<span class="hljs-number inline">32</span>, <span class="hljs-number inline">16</span>, secretKey.getBytes(StandardCharsets.UTF_8), saltBytes, <span class="hljs-number inline">1</span>);
            <span class="hljs-type inline">byte</span>[] key = keyAndIV[<span class="hljs-number inline">0</span>];  <span class="hljs-comment inline">// 32字节密钥（AES-256）</span>
            <span class="hljs-type inline">byte</span>[] iv = keyAndIV[<span class="hljs-number inline">1</span>];   <span class="hljs-comment inline">// 16字节IV</span>

            <span class="hljs-comment inline">// ==================== 步骤4：AES解密 ====================</span>
            
            <span class="hljs-comment inline">// 创建AES密钥规范</span>
            <span class="hljs-type inline">SecretKeySpec</span> <span class="hljs-variable inline">secretKeySpec</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">SecretKeySpec</span>(key, <span class="hljs-string inline">&quot;AES&quot;</span>);
            <span class="hljs-comment inline">// 创建IV参数规范</span>
            javax.crypto.spec.<span class="hljs-type inline">IvParameterSpec</span> <span class="hljs-variable inline">ivSpec</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">javax</span>.crypto.spec.IvParameterSpec(iv);

            <span class="hljs-comment inline">// 初始化解密器：AES/CBC/PKCS5Padding（与CryptoJS默认设置一致）</span>
            <span class="hljs-type inline">Cipher</span> <span class="hljs-variable inline">cipher</span> <span class="hljs-operator inline">=</span> Cipher.getInstance(<span class="hljs-string inline">&quot;AES/CBC/PKCS5Padding&quot;</span>);
            cipher.init(Cipher.DECRYPT_MODE, secretKeySpec, ivSpec);

            <span class="hljs-comment inline">// 执行解密</span>
            <span class="hljs-type inline">byte</span>[] decryptedBytes = cipher.doFinal(cipherBytes);
            
            <span class="hljs-comment inline">// 转换为字符串并返回</span>
            <span class="hljs-keyword inline">return</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">String</span>(decryptedBytes, StandardCharsets.UTF_8);
            
        } <span class="hljs-keyword inline">catch</span> (Exception e) {
            log.error(<span class="hljs-string inline">&quot;API密钥解密失败&quot;</span>, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIG_NOT_EXISTS, <span class="hljs-string inline">&quot;API密钥解密失败: &quot;</span> + e.getMessage());
        }
    }

    <span class="hljs-comment inline">/**
     * EVP_BytesToKey算法实现 - 密钥派生函数
     * 
     * 这是OpenSSL标准的密钥派生算法，用于从密码和盐值生成密钥和IV
     * 
     * <span class="hljs-doctag inline">@param</span> keyLen 密钥长度（字节）
     * <span class="hljs-doctag inline">@param</span> ivLen IV长度（字节）
     * <span class="hljs-doctag inline">@param</span> password 密码
     * <span class="hljs-doctag inline">@param</span> salt 盐值
     * <span class="hljs-doctag inline">@param</span> iterations 迭代次数
     * <span class="hljs-doctag inline">@return</span> [密钥, IV]
     */</span>
    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">static</span> <span class="hljs-type inline">byte</span>[][] EVP_BytesToKey(<span class="hljs-type inline">int</span> keyLen, <span class="hljs-type inline">int</span> ivLen, <span class="hljs-type inline">byte</span>[] password, <span class="hljs-type inline">byte</span>[] salt, <span class="hljs-type inline">int</span> iterations) {
        <span class="hljs-comment inline">// ==================== 步骤1：初始化 ====================</span>
        
        <span class="hljs-type inline">byte</span>[] key = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[keyLen];
        <span class="hljs-type inline">byte</span>[] iv = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[ivLen];
        <span class="hljs-type inline">byte</span>[] concatenatedHashBytes = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[<span class="hljs-number inline">0</span>];

        <span class="hljs-comment inline">// 初始化MD5消息摘要</span>
        MessageDigest md5;
        <span class="hljs-keyword inline">try</span> {
            md5 = MessageDigest.getInstance(<span class="hljs-string inline">&quot;MD5&quot;</span>);
        } <span class="hljs-keyword inline">catch</span> (NoSuchAlgorithmException e) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(<span class="hljs-string inline">&quot;MD5算法不可用&quot;</span>, e);
        }

        <span class="hljs-comment inline">// ==================== 步骤2：计算需要的哈希轮数 ====================</span>
        
        <span class="hljs-type inline">int</span> <span class="hljs-variable inline">hashLen</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">16</span>; <span class="hljs-comment inline">// MD5输出长度</span>
        <span class="hljs-type inline">int</span> <span class="hljs-variable inline">keyAndIvLen</span> <span class="hljs-operator inline">=</span> keyLen + ivLen;
        <span class="hljs-type inline">int</span> <span class="hljs-variable inline">numHashes</span> <span class="hljs-operator inline">=</span> (keyAndIvLen + hashLen - <span class="hljs-number inline">1</span>) / hashLen; <span class="hljs-comment inline">// 向上取整</span>

        <span class="hljs-comment inline">// ==================== 步骤3：生成哈希链 ====================</span>
        
        <span class="hljs-type inline">byte</span>[] result = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[numHashes * hashLen];
        <span class="hljs-type inline">int</span> <span class="hljs-variable inline">resultLen</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">0</span>;

        <span class="hljs-keyword inline">for</span> (<span class="hljs-type inline">int</span> <span class="hljs-variable inline">i</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">1</span>; i &lt;= numHashes; i++) {
            <span class="hljs-comment inline">// 第一轮：只使用密码和盐</span>
            <span class="hljs-comment inline">// 后续轮：使用前一轮的结果 + 密码 + 盐</span>
            md5.reset();
            <span class="hljs-keyword inline">if</span> (i &gt; <span class="hljs-number inline">1</span>) {
                md5.update(concatenatedHashBytes);
            }
            md5.update(password);
            <span class="hljs-keyword inline">if</span> (salt != <span class="hljs-literal inline">null</span>) {
                md5.update(salt);
            }
            concatenatedHashBytes = md5.digest();

            <span class="hljs-comment inline">// 执行额外的迭代（通常为1，即不额外迭代）</span>
            <span class="hljs-keyword inline">for</span> (<span class="hljs-type inline">int</span> <span class="hljs-variable inline">j</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">1</span>; j &lt; iterations; j++) {
                md5.reset();
                md5.update(concatenatedHashBytes);
                concatenatedHashBytes = md5.digest();
            }

            <span class="hljs-comment inline">// 将哈希结果拷贝到结果数组中</span>
            System.arraycopy(
                concatenatedHashBytes, <span class="hljs-number inline">0</span>,
                result, resultLen,
                Math.min(concatenatedHashBytes.length, result.length - resultLen)
            );
            resultLen += concatenatedHashBytes.length;
        }

        <span class="hljs-comment inline">// ==================== 步骤4：分离密钥和IV ====================</span>
        
        <span class="hljs-comment inline">// 从结果中提取密钥</span>
        System.arraycopy(result, <span class="hljs-number inline">0</span>, key, <span class="hljs-number inline">0</span>, keyLen);
        <span class="hljs-comment inline">// 从结果中提取IV</span>
        System.arraycopy(result, keyLen, iv, <span class="hljs-number inline">0</span>, ivLen);

        <span class="hljs-keyword inline">return</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[][]{key, iv};
    }

    <span class="hljs-comment inline">/**
     * HTTP POST请求 - 基于HuTool的封装
     * 
     * <span class="hljs-doctag inline">@param</span> url 请求URL
     * <span class="hljs-doctag inline">@param</span> headers 请求头
     * <span class="hljs-doctag inline">@param</span> requestBody 请求体
     * <span class="hljs-doctag inline">@return</span> 响应字符串
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">post</span><span class="hljs-params inline">(String url, Map&lt;String, String&gt; headers, String requestBody)</span> {
        <span class="hljs-keyword inline">try</span> (<span class="hljs-type inline">HttpResponse</span> <span class="hljs-variable inline">response</span> <span class="hljs-operator inline">=</span> HttpRequest.post(url)
                .addHeaders(headers)
                .body(requestBody)
                .execute()) {
            <span class="hljs-keyword inline">return</span> response.body();
        }
    }

    <span class="hljs-comment inline">/**
     * HTTP GET请求 - 基于HuTool的封装
     * 
     * <span class="hljs-doctag inline">@param</span> url 请求URL  
     * <span class="hljs-doctag inline">@param</span> headers 请求头
     * <span class="hljs-doctag inline">@return</span> 响应字符串
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">get</span><span class="hljs-params inline">(String url, Map&lt;String, String&gt; headers)</span> {
        <span class="hljs-keyword inline">try</span> (<span class="hljs-type inline">HttpResponse</span> <span class="hljs-variable inline">response</span> <span class="hljs-operator inline">=</span> HttpRequest.get(url)
                .addHeaders(headers)
                .execute()) {
            <span class="hljs-keyword inline">return</span> response.body();
        }
    }
}
</code></pre>
            </div>
        
<h3 id="conversationmessageserviceimpl：消息服务的完整实现" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#conversationmessageserviceimpl：消息服务的完整实现" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to ConversationMessageServiceImpl：消息服务的完整实现">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            ConversationMessageServiceImpl：消息服务的完整实现
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="package%20com.chat.allchatonthis.service.core.impl%3B%0Aimport%20com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper%3B%0Aimport%20com.baomidou.mybatisplus.extension.service.impl.ServiceImpl%3B%0Aimport%20com.chat.allchatonthis.common.exception.ServiceException%3B%0Aimport%20com.chat.allchatonthis.common.util.http.HttpUtils%3B%0Aimport%20com.chat.allchatonthis.common.util.json.JsonUtils%3B%0Aimport%20com.chat.allchatonthis.entity.dataobject.ConversationDO%3B%0Aimport%20com.chat.allchatonthis.entity.dataobject.ConversationMessageDO%3B%0Aimport%20com.chat.allchatonthis.entity.dataobject.UserConfigDO%3B%0Aimport%20com.chat.allchatonthis.mapper.ConversationMessageMapper%3B%0Aimport%20com.chat.allchatonthis.service.core.ConversationMessageService%3B%0Aimport%20com.chat.allchatonthis.service.core.ConversationService%3B%0Aimport%20com.chat.allchatonthis.service.core.UserConfigService%3B%0Aimport%20lombok.AllArgsConstructor%3B%0Aimport%20lombok.extern.slf4j.Slf4j%3B%0Aimport%20org.springframework.cache.annotation.CacheConfig%3B%0Aimport%20org.springframework.cache.annotation.CacheEvict%3B%0Aimport%20org.springframework.cache.annotation.Cacheable%3B%0Aimport%20org.springframework.cache.annotation.Caching%3B%0Aimport%20org.springframework.data.redis.core.RedisTemplate%3B%0Aimport%20org.springframework.stereotype.Service%3B%0Aimport%20org.springframework.transaction.annotation.Transactional%3B%0Aimport%20org.springframework.util.StringUtils%3B%0Aimport%20java.util.List%3B%0Aimport%20java.util.Map%3B%0Aimport%20static%20com.chat.allchatonthis.common.enums.ErrorCodeConstants.*%3B%0A%2F**%0A*%20%E5%AF%B9%E8%AF%9D%E6%B6%88%E6%81%AF%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E7%B1%BB%20-%20%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E7%9A%84%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%0A*%2F%0A%40Service%0A%40AllArgsConstructor%0A%40Slf4j%0A%40CacheConfig(cacheNames%20%3D%20%22conversation_message%22)%0Apublic%20class%20ConversationMessageServiceImpl%20extends%20ServiceImpl%0Aimplements%20ConversationMessageService%20%7B%0Aprivate%20final%20ConversationService%20conversationService%3B%0Aprivate%20final%20UserConfigService%20userConfigService%3B%0Aprivate%20final%20RedisTemplate%20redisTemplate%3B%0A%2F**%0A*%20%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%20-%20%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1%E6%96%B9%E6%B3%95%0A*%0A*%20%40param%20userMessage%20%E7%94%A8%E6%88%B7%E6%B6%88%E6%81%AF%E5%86%85%E5%AE%B9%0A*%20%40param%20configId%20%E9%85%8D%E7%BD%AEID%0A*%20%40param%20conversationId%20%E5%AF%B9%E8%AF%9DID%0A*%20%40param%20userId%20%E7%94%A8%E6%88%B7ID%0A*%20%40param%20secretKey%20%E8%A7%A3%E5%AF%86%E5%AF%86%E9%92%A5%0A*%20%40return%20%E5%8A%A9%E6%89%8B%E5%9B%9E%E5%A4%8D%E6%B6%88%E6%81%AF%0A*%2F%0A%40Override%0A%40Transactional%20%20%2F%2F%20%E7%A1%AE%E4%BF%9D%E4%BA%8B%E5%8A%A1%E4%B8%80%E8%87%B4%E6%80%A7%0A%40Caching(evict%20%3D%20%7B%0A%40CacheEvict(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0A%7D)%0Apublic%20ConversationMessageDO%20sendMessage(String%20userMessage%2C%20Long%20configId%2C%20Long%20conversationId%2C%0ALong%20userId%2C%20String%20secretKey)%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E9%AA%8C%E8%AF%81%E5%AF%B9%E8%AF%9D%E5%BD%92%E5%B1%9E%E6%9D%83%EF%BC%9A%E7%A1%AE%E4%BF%9D%E7%94%A8%E6%88%B7%E5%8F%AA%E8%83%BD%E6%93%8D%E4%BD%9C%E8%87%AA%E5%B7%B1%E7%9A%84%E5%AF%B9%E8%AF%9D%0AConversationDO%20conversation%20%3D%20conversationService.getConversation(conversationId%2C%20userId)%3B%0Aif%20(conversation%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(CONVERSATION_NOT_EXISTS.getCode()%2C%20CONVERSATION_NOT_EXISTS.getMsg())%3B%0A%7D%0A%2F%2F%20%E9%AA%8C%E8%AF%81%E9%85%8D%E7%BD%AE%E5%BD%92%E5%B1%9E%E6%9D%83%EF%BC%9A%E7%A1%AE%E4%BF%9D%E7%94%A8%E6%88%B7%E5%8F%AA%E8%83%BD%E4%BD%BF%E7%94%A8%E8%87%AA%E5%B7%B1%E7%9A%84%E9%85%8D%E7%BD%AE%0AUserConfigDO%20config%20%3D%20userConfigService.getConfig(configId%2C%20userId)%3B%0Aif%20(config%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(CONFIGURATION_NOT_EXISTS.getCode()%2C%20CONFIGURATION_NOT_EXISTS.getMsg())%3B%0A%7D%0A%2F%2F%20%E8%AE%BE%E7%BD%AE%E4%B8%B4%E6%97%B6%E8%A7%A3%E5%AF%86%E5%AF%86%E9%92%A5%0Aif%20(StringUtils.hasText(secretKey))%20%7B%0Aconfig.setSecretKey(secretKey)%3B%0A%7D%0Atry%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E5%87%86%E5%A4%87%E6%B6%88%E6%81%AF%E5%AF%B9%E8%B1%A1%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E6%B6%88%E6%81%AF%E5%AF%B9%E8%B1%A1%EF%BC%88%E6%B3%A8%E6%84%8F%EF%BC%9A%E8%BF%99%E9%87%8C%E5%8F%AA%E6%98%AF%E5%88%9B%E5%BB%BA%EF%BC%8C%E4%B8%8D%E4%BF%9D%E5%AD%98%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%89%0A%2F%2F%20%E8%BF%99%E6%98%AF%E4%B8%80%E7%A7%8D%E4%BA%8B%E5%8A%A1%E6%80%A7%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%85%88%E7%A1%AE%E4%BF%9DAPI%E8%B0%83%E7%94%A8%E6%88%90%E5%8A%9F%EF%BC%8C%E5%86%8D%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE%0AConversationMessageDO%20userMessageDO%20%3D%20new%20ConversationMessageDO()%0A.setConversationId(conversationId)%0A.setConfigId(configId)%0A.setRole(%22user%22)%0A.setContent(userMessage)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%AF%B9%E8%AF%9D%E7%9A%84%E6%89%80%E6%9C%89%E5%8E%86%E5%8F%B2%E6%B6%88%E6%81%AF%EF%BC%8C%E7%94%A8%E4%BA%8E%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87%0AList%20previousMessages%20%3D%20list(new%20LambdaQueryWrapper()%0A.eq(ConversationMessageDO%3A%3AgetConversationId%2C%20conversationId)%0A.orderByAsc(ConversationMessageDO%3A%3AgetCreateTime))%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A44%EF%BC%9A%E8%B0%83%E7%94%A8AI%20API%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E8%B0%83%E7%94%A8AI%20API%E8%8E%B7%E5%8F%96%E5%9B%9E%E5%A4%8D%EF%BC%88%E8%BF%99%E6%98%AF%E5%85%B3%E9%94%AE%E6%AD%A5%E9%AA%A4%EF%BC%8C%E5%8F%AF%E8%83%BD%E5%A4%B1%E8%B4%A5%EF%BC%89%0AConversationMessageDO%20assistantMessageDO%20%3D%20generateAssistantResponse(%0AuserMessage%2C%20config%2C%20conversationId%2C%20configId%2C%20previousMessages%0A)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A45%EF%BC%9A%E4%BF%9D%E5%AD%98%E6%B6%88%E6%81%AF%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E5%8F%AA%E6%9C%89API%E8%B0%83%E7%94%A8%E6%88%90%E5%8A%9F%E6%89%8D%E4%BC%9A%E6%89%A7%E8%A1%8C%E5%88%B0%E8%BF%99%E9%87%8C%0A%2F%2F%20%E6%89%B9%E9%87%8F%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E6%B6%88%E6%81%AF%E5%92%8C%E5%8A%A9%E6%89%8B%E5%9B%9E%E5%A4%8D%EF%BC%8C%E7%A1%AE%E4%BF%9D%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%0Asave(userMessageDO)%3B%0Asave(assistantMessageDO)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A46%EF%BC%9A%E6%9B%B4%E6%96%B0%E5%AF%B9%E8%AF%9D%E7%8A%B6%E6%80%81%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E6%9B%B4%E6%96%B0%E5%AF%B9%E8%AF%9D%E7%9A%84%E6%9C%80%E5%90%8E%E6%9B%B4%E6%96%B0%E6%97%B6%E9%97%B4%0Aconversation.setUpdateTime(assistantMessageDO.getUpdateTime())%3B%0AconversationService.updateById(conversation)%3B%0A%2F%2F%20%E6%A0%87%E8%AE%B0%E9%85%8D%E7%BD%AE%E4%B8%BA%E5%8F%AF%E7%94%A8%EF%BC%88%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%EF%BC%89%0AmarkConfigurationAsAvailable(configId%2C%20userId)%3B%0Areturn%20assistantMessageDO%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E5%A4%B1%E8%B4%A5%22%2C%20e)%3B%0A%2F%2F%20%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%8D%E5%88%9B%E5%BB%BA%E9%94%99%E8%AF%AF%E6%B6%88%E6%81%AF%EF%BC%8C%E7%9B%B4%E6%8E%A5%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%0Aif%20(e%20instanceof%20ServiceException)%20%7B%0Athrow%20e%3B%0A%7D%0Athrow%20new%20ServiceException(MESSAGE_SEND_FAILED.getCode()%2C%20e.getMessage())%3B%0A%7D%0A%7D%0A%2F**%0A*%20%E7%94%9F%E6%88%90%E5%8A%A9%E6%89%8B%E5%9B%9E%E5%A4%8D%20-%20AI%20API%E8%B0%83%E7%94%A8%E7%9A%84%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91%0A*%0A*%20%40param%20userMessage%20%E7%94%A8%E6%88%B7%E6%B6%88%E6%81%AF%0A*%20%40param%20config%20%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%0A*%20%40param%20conversationId%20%E5%AF%B9%E8%AF%9DID%0A*%20%40param%20configId%20%E9%85%8D%E7%BD%AEID%0A*%20%40param%20conversationMessages%20%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%0A*%20%40return%20%E5%8A%A9%E6%89%8B%E5%9B%9E%E5%A4%8D%E6%B6%88%E6%81%AF%0A*%2F%0Aprivate%20ConversationMessageDO%20generateAssistantResponse(%0AString%20userMessage%2C%0AUserConfigDO%20config%2C%0ALong%20conversationId%2C%0ALong%20configId%2C%0AList%20conversationMessages)%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E5%87%86%E5%A4%87%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E4%BD%BF%E7%94%A8HttpUtils%E5%87%86%E5%A4%87%E5%AE%8C%E6%95%B4%E7%9A%84%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%EF%BC%88%E5%8C%85%E5%90%AB%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%EF%BC%89%0AMap%20requestData%20%3D%20HttpUtils.prepareRequestData(config%2C%20userMessage%2C%20conversationMessages)%3B%0A%2F%2F%20%E6%8F%90%E5%8F%96%E8%AF%B7%E6%B1%82%E5%A4%B4%E5%92%8C%E8%AF%B7%E6%B1%82%E4%BD%93%0AMap%20headers%20%3D%20(Map)%20requestData.get(%22headers%22)%3B%0AMap%20requestBody%20%3D%20(Map)%20requestData.get(%22requestBody%22)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E5%8F%91%E9%80%81HTTP%E8%AF%B7%E6%B1%82%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%B7%E6%B1%82%E4%BD%93%E4%B8%BAJSON%E5%AD%97%E7%AC%A6%E4%B8%B2%0AString%20requestBodyStr%20%3D%20JsonUtils.toJsonString(requestBody)%3B%0A%2F%2F%20%E5%8F%91%E9%80%81POST%E8%AF%B7%E6%B1%82%E5%88%B0AI%20API%0AString%20responseStr%20%3D%20HttpUtils.post(config.getApiUrl()%2C%20headers%2C%20requestBodyStr)%3B%0A%2F%2F%20%E6%A3%80%E6%9F%A5%E5%93%8D%E5%BA%94%E6%98%AF%E5%90%A6%E4%B8%BA%E7%A9%BA%0Aif%20(responseStr%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(API_CALL_FAILED.getCode()%2C%20%22API%E8%BF%94%E5%9B%9E%E7%A9%BA%E5%93%8D%E5%BA%94%22)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E8%A7%A3%E6%9E%90%E5%93%8D%E5%BA%94%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E8%A7%A3%E6%9E%90%E5%93%8D%E5%BA%94JSON%0AMap%20responseMap%20%3D%20JsonUtils.parseObject(responseStr%2C%20Map.class)%3B%0A%2F%2F%20%E6%8F%90%E5%8F%96AI%E5%9B%9E%E5%A4%8D%E5%86%85%E5%AE%B9%0AString%20content%20%3D%20null%3B%0AString%20thinking%20%3D%20null%3B%0A%2F%2F%20%E6%A0%B9%E6%8D%AE%E9%85%8D%E7%BD%AE%E7%9A%84%E8%B7%AF%E5%BE%84%E6%8F%90%E5%8F%96%E5%9B%9E%E5%A4%8D%E5%86%85%E5%AE%B9%0Aif%20(StringUtils.hasText(config.getResponseTextPath()))%20%7B%0Acontent%20%3D%20JsonUtils.extractValueFromPath(responseMap%2C%20config.getResponseTextPath())%3B%0A%7D%0A%2F%2F%20%E6%A0%B9%E6%8D%AE%E9%85%8D%E7%BD%AE%E7%9A%84%E8%B7%AF%E5%BE%84%E6%8F%90%E5%8F%96%E6%80%9D%E8%80%83%E8%BF%87%E7%A8%8B%EF%BC%88%E5%A6%82%E6%9E%9C%E6%94%AF%E6%8C%81%EF%BC%89%0Aif%20(StringUtils.hasText(config.getResponseThinkingTextPath()))%20%7B%0Athinking%20%3D%20JsonUtils.extractValueFromPath(responseMap%2C%20config.getResponseThinkingTextPath())%3B%0A%7D%0A%2F%2F%20%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%E6%8F%90%E5%8F%96%E5%88%B0%E5%86%85%E5%AE%B9%0Aif%20(content%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(API_CALL_FAILED.getCode()%2C%20%22%E6%97%A0%E6%B3%95%E4%BB%8E%E5%93%8D%E5%BA%94%E4%B8%AD%E6%8F%90%E5%8F%96%E5%86%85%E5%AE%B9%22)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A44%EF%BC%9A%E6%9E%84%E5%BB%BA%E5%9B%9E%E5%A4%8D%E6%B6%88%E6%81%AF%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E5%88%9B%E5%BB%BA%E5%8A%A9%E6%89%8B%E5%9B%9E%E5%A4%8D%E6%B6%88%E6%81%AF%E5%AF%B9%E8%B1%A1%0Areturn%20new%20ConversationMessageDO()%0A.setConversationId(conversationId)%0A.setConfigId(configId)%0A.setRole(%22assistant%22)%0A.setContent(content)%0A.setThinkingText(thinking)%3B%20%20%2F%2F%20%E6%80%9D%E8%80%83%E8%BF%87%E7%A8%8B%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89%0A%7D%0A%2F**%0A*%20%E6%A0%87%E8%AE%B0%E9%85%8D%E7%BD%AE%E4%B8%BA%E5%8F%AF%E7%94%A8%20-%20%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E5%92%8C%E7%9B%91%E6%8E%A7%0A*%0A*%20%40param%20configId%20%E9%85%8D%E7%BD%AEID%0A*%20%40param%20userId%20%E7%94%A8%E6%88%B7ID%0A*%20%40return%20%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%0A*%2F%0A%40Override%0Apublic%20boolean%20markConfigurationAsAvailable(Long%20configId%2C%20Long%20userId)%20%7B%0A%2F%2F%20%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%0AUserConfigDO%20config%20%3D%20userConfigService.getConfig(configId%2C%20userId)%3B%0Aif%20(config%20%3D%3D%20null)%20%7B%0Areturn%20false%3B%0A%7D%0A%2F%2F%20%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE%E7%8A%B6%E6%80%81%EF%BC%9A%E8%AE%BE%E7%BD%AE%E4%B8%BA%E5%8F%AF%E7%94%A8%EF%BC%8C%E5%B9%B6%E8%AE%B0%E5%BD%95%E6%9C%80%E5%90%8E%E4%BD%BF%E7%94%A8%E6%97%B6%E9%97%B4%0AuserConfigService.setAvailableAndUpdateLastUsedTime(configId%2C%20true)%3B%0Areturn%20true%3B%0A%7D%0A%2F**%0A*%20%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%AF%9D%E6%B6%88%E6%81%AF%E5%88%97%E8%A1%A8%20-%20%E5%B8%A6%E7%BC%93%E5%AD%98%0A*%0A*%20%40param%20conversationId%20%E5%AF%B9%E8%AF%9DID%0A*%20%40param%20userId%20%E7%94%A8%E6%88%B7ID%0A*%20%40return%20%E6%B6%88%E6%81%AF%E5%88%97%E8%A1%A8%0A*%2F%0A%40Override%0A%40Cacheable(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20List%20getMessages(Long%20conversationId%2C%20Long%20userId)%20%7B%0A%2F%2F%20%E9%AA%8C%E8%AF%81%E5%AF%B9%E8%AF%9D%E5%BD%92%E5%B1%9E%E6%9D%83%0AConversationDO%20conversation%20%3D%20conversationService.getConversation(conversationId%2C%20userId)%3B%0Aif%20(conversation%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(CONVERSATION_NOT_EXISTS.getCode()%2C%20CONVERSATION_NOT_EXISTS.getMsg())%3B%0A%7D%0A%2F%2F%20%E6%9F%A5%E8%AF%A2%E6%B6%88%E6%81%AF%EF%BC%8C%E6%8C%89%E6%97%B6%E9%97%B4%E5%8D%87%E5%BA%8F%E6%8E%92%E5%88%97%0Areturn%20list(new%20LambdaQueryWrapper()%0A.eq(ConversationMessageDO%3A%3AgetConversationId%2C%20conversationId)%0A.orderByAsc(ConversationMessageDO%3A%3AgetCreateTime)%0A.orderByAsc(ConversationMessageDO%3A%3AgetId)%0A)%3B%0A%7D%0A%2F**%0A*%20%E8%8E%B7%E5%8F%96%E5%8D%95%E4%B8%AA%E6%B6%88%E6%81%AF%20-%20%E5%B8%A6%E7%BC%93%E5%AD%98%0A*%0A*%20%40param%20id%20%E6%B6%88%E6%81%AFID%0A*%20%40param%20userId%20%E7%94%A8%E6%88%B7ID%0A*%20%40return%20%E6%B6%88%E6%81%AF%E5%AF%B9%E8%B1%A1%0A*%2F%0A%40Override%0A%40Cacheable(key%20%3D%20%22'id%3A'%20%2B%20%23id%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20ConversationMessageDO%20getMessage(Long%20id%2C%20Long%20userId)%20%7B%0AConversationMessageDO%20message%20%3D%20getById(id)%3B%0Aif%20(message%20%3D%3D%20null)%20%7B%0Areturn%20null%3B%0A%7D%0A%2F%2F%20%E9%AA%8C%E8%AF%81%E5%AF%B9%E8%AF%9D%E5%BD%92%E5%B1%9E%E6%9D%83%0AConversationDO%20conversation%20%3D%20conversationService.getConversation(message.getConversationId()%2C%20userId)%3B%0Aif%20(conversation%20%3D%3D%20null)%20%7B%0Areturn%20null%3B%0A%7D%0Areturn%20message%3B%0A%7D%0A%2F**%0A*%20%E5%88%A0%E9%99%A4%E6%B6%88%E6%81%AF%20-%20%E6%B8%85%E7%90%86%E7%BC%93%E5%AD%98%0A*%0A*%20%40param%20id%20%E6%B6%88%E6%81%AFID%0A*%20%40param%20userId%20%E7%94%A8%E6%88%B7ID%0A*%20%40return%20%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%0A*%2F%0A%40Override%0A%40Transactional%0A%40CacheEvict(key%20%3D%20%22'id%3A'%20%2B%20%23id%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20boolean%20deleteMessage(Long%20id%2C%20Long%20userId)%20%7B%0AConversationMessageDO%20message%20%3D%20getMessage(id%2C%20userId)%3B%0Aif%20(message%20%3D%3D%20null)%20%7B%0Areturn%20false%3B%0A%7D%0A%2F%2F%20%E6%89%8B%E5%8A%A8%E6%B8%85%E7%90%86%E7%9B%B8%E5%85%B3%E7%BC%93%E5%AD%98%0ALong%20conversationId%20%3D%20message.getConversationId()%3B%0AString%20cacheKey%20%3D%20%22acot_conversation_message%3A%3Aconversation%3A%22%20%2B%20conversationId%20%2B%20%22%3Auser%3A%22%20%2B%20userId%3B%0AredisTemplate.delete(cacheKey)%3B%0Areturn%20removeById(id)%3B%0A%7D%0A%2F**%0A*%20%E5%88%A0%E9%99%A4%E5%AF%B9%E8%AF%9D%E7%9A%84%E6%89%80%E6%9C%89%E6%B6%88%E6%81%AF%20-%20%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%0A*%0A*%20%40param%20conversationId%20%E5%AF%B9%E8%AF%9DID%0A*%20%40param%20userId%20%E7%94%A8%E6%88%B7ID%0A*%20%40return%20%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%0A*%2F%0A%40Override%0A%40Transactional%0A%40CacheEvict(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20boolean%20deleteMessagesByConversationId(Long%20conversationId%2C%20Long%20userId)%20%7B%0A%2F%2F%20%E9%AA%8C%E8%AF%81%E5%AF%B9%E8%AF%9D%E5%BD%92%E5%B1%9E%E6%9D%83%0AConversationDO%20conversation%20%3D%20conversationService.getConversation(conversationId%2C%20userId)%3B%0Aif%20(conversation%20%3D%3D%20null)%20%7B%0Areturn%20false%3B%0A%7D%0A%2F%2F%20%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%E6%B6%88%E6%81%AF%0Areturn%20remove(new%20LambdaQueryWrapper()%0A.eq(ConversationMessageDO%3A%3AgetConversationId%2C%20conversationId))%3B%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">package</span> com.chat.allchatonthis.service.core.impl;

<span class="hljs-keyword inline">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
<span class="hljs-keyword inline">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.common.exception.ServiceException;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.common.util.http.HttpUtils;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.common.util.json.JsonUtils;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.entity.dataobject.ConversationDO;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.entity.dataobject.ConversationMessageDO;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.entity.dataobject.UserConfigDO;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.mapper.ConversationMessageMapper;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.service.core.ConversationMessageService;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.service.core.ConversationService;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.service.core.UserConfigService;
<span class="hljs-keyword inline">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword inline">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword inline">import</span> org.springframework.cache.annotation.CacheConfig;
<span class="hljs-keyword inline">import</span> org.springframework.cache.annotation.CacheEvict;
<span class="hljs-keyword inline">import</span> org.springframework.cache.annotation.Cacheable;
<span class="hljs-keyword inline">import</span> org.springframework.cache.annotation.Caching;
<span class="hljs-keyword inline">import</span> org.springframework.data.redis.core.RedisTemplate;
<span class="hljs-keyword inline">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword inline">import</span> org.springframework.transaction.annotation.Transactional;
<span class="hljs-keyword inline">import</span> org.springframework.util.StringUtils;

<span class="hljs-keyword inline">import</span> java.util.List;
<span class="hljs-keyword inline">import</span> java.util.Map;

<span class="hljs-keyword inline">import</span> <span class="hljs-keyword inline">static</span> com.chat.allchatonthis.common.enums.ErrorCodeConstants.*;

<span class="hljs-comment inline">/**
 * 对话消息服务实现类 - 消息处理的核心业务逻辑
 */</span>
<span class="hljs-meta inline">@Service</span>
<span class="hljs-meta inline">@AllArgsConstructor</span>
<span class="hljs-meta inline">@Slf4j</span>
<span class="hljs-meta inline">@CacheConfig(cacheNames = &quot;conversation_message&quot;)</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">ConversationMessageServiceImpl</span> <span class="hljs-keyword inline">extends</span> <span class="hljs-title class_ inline">ServiceImpl</span>&lt;ConversationMessageMapper, ConversationMessageDO&gt; 
        <span class="hljs-keyword inline">implements</span> <span class="hljs-title class_ inline">ConversationMessageService</span> {

    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> ConversationService conversationService;
    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> UserConfigService userConfigService;
    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-comment inline">/**
     * 发送消息 - 系统的核心业务方法
     * 
     * <span class="hljs-doctag inline">@param</span> userMessage 用户消息内容
     * <span class="hljs-doctag inline">@param</span> configId 配置ID
     * <span class="hljs-doctag inline">@param</span> conversationId 对话ID
     * <span class="hljs-doctag inline">@param</span> userId 用户ID
     * <span class="hljs-doctag inline">@param</span> secretKey 解密密钥
     * <span class="hljs-doctag inline">@return</span> 助手回复消息
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-meta inline">@Transactional</span>  <span class="hljs-comment inline">// 确保事务一致性</span>
    <span class="hljs-meta inline">@Caching(evict = {
            @CacheEvict(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)
    })</span>
    <span class="hljs-keyword inline">public</span> ConversationMessageDO <span class="hljs-title function_ inline">sendMessage</span><span class="hljs-params inline">(String userMessage, Long configId, Long conversationId, 
                                           Long userId, String secretKey)</span> {
        <span class="hljs-comment inline">// ==================== 步骤1：权限验证 ====================</span>
        
        <span class="hljs-comment inline">// 验证对话归属权：确保用户只能操作自己的对话</span>
        <span class="hljs-type inline">ConversationDO</span> <span class="hljs-variable inline">conversation</span> <span class="hljs-operator inline">=</span> conversationService.getConversation(conversationId, userId);
        <span class="hljs-keyword inline">if</span> (conversation == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONVERSATION_NOT_EXISTS.getCode(), CONVERSATION_NOT_EXISTS.getMsg());
        }

        <span class="hljs-comment inline">// 验证配置归属权：确保用户只能使用自己的配置</span>
        <span class="hljs-type inline">UserConfigDO</span> <span class="hljs-variable inline">config</span> <span class="hljs-operator inline">=</span> userConfigService.getConfig(configId, userId);
        <span class="hljs-keyword inline">if</span> (config == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIGURATION_NOT_EXISTS.getCode(), CONFIGURATION_NOT_EXISTS.getMsg());
        }

        <span class="hljs-comment inline">// 设置临时解密密钥</span>
        <span class="hljs-keyword inline">if</span> (StringUtils.hasText(secretKey)) {
            config.setSecretKey(secretKey);
        }

        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-comment inline">// ==================== 步骤2：准备消息对象 ====================</span>
            
            <span class="hljs-comment inline">// 创建用户消息对象（注意：这里只是创建，不保存到数据库）</span>
            <span class="hljs-comment inline">// 这是一种事务性设计：先确保API调用成功，再保存数据</span>
            <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">userMessageDO</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ConversationMessageDO</span>()
                    .setConversationId(conversationId)
                    .setConfigId(configId)
                    .setRole(<span class="hljs-string inline">&quot;user&quot;</span>)
                    .setContent(userMessage);

            <span class="hljs-comment inline">// ==================== 步骤3：获取对话历史 ====================</span>
            
            <span class="hljs-comment inline">// 获取当前对话的所有历史消息，用于构建上下文</span>
            List&lt;ConversationMessageDO&gt; previousMessages = list(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">LambdaQueryWrapper</span>&lt;ConversationMessageDO&gt;()
                    .eq(ConversationMessageDO::getConversationId, conversationId)
                    .orderByAsc(ConversationMessageDO::getCreateTime));

            <span class="hljs-comment inline">// ==================== 步骤4：调用AI API ====================</span>
            
            <span class="hljs-comment inline">// 调用AI API获取回复（这是关键步骤，可能失败）</span>
            <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">assistantMessageDO</span> <span class="hljs-operator inline">=</span> generateAssistantResponse(
                userMessage, config, conversationId, configId, previousMessages
            );

            <span class="hljs-comment inline">// ==================== 步骤5：保存消息 ====================</span>
            
            <span class="hljs-comment inline">// 只有API调用成功才会执行到这里</span>
            <span class="hljs-comment inline">// 批量保存用户消息和助手回复，确保数据一致性</span>
            save(userMessageDO);
            save(assistantMessageDO);

            <span class="hljs-comment inline">// ==================== 步骤6：更新对话状态 ====================</span>
            
            <span class="hljs-comment inline">// 更新对话的最后更新时间</span>
            conversation.setUpdateTime(assistantMessageDO.getUpdateTime());
            conversationService.updateById(conversation);

            <span class="hljs-comment inline">// 标记配置为可用（健康检查）</span>
            markConfigurationAsAvailable(configId, userId);

            <span class="hljs-keyword inline">return</span> assistantMessageDO;
            
        } <span class="hljs-keyword inline">catch</span> (Exception e) {
            log.error(<span class="hljs-string inline">&quot;消息发送失败&quot;</span>, e);

            <span class="hljs-comment inline">// 统一异常处理：不创建错误消息，直接抛出异常</span>
            <span class="hljs-keyword inline">if</span> (e <span class="hljs-keyword inline">instanceof</span> ServiceException) {
                <span class="hljs-keyword inline">throw</span> e;
            }
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(MESSAGE_SEND_FAILED.getCode(), e.getMessage());
        }
    }

    <span class="hljs-comment inline">/**
     * 生成助手回复 - AI API调用的核心逻辑
     * 
     * <span class="hljs-doctag inline">@param</span> userMessage 用户消息
     * <span class="hljs-doctag inline">@param</span> config 配置信息
     * <span class="hljs-doctag inline">@param</span> conversationId 对话ID
     * <span class="hljs-doctag inline">@param</span> configId 配置ID
     * <span class="hljs-doctag inline">@param</span> conversationMessages 对话历史
     * <span class="hljs-doctag inline">@return</span> 助手回复消息
     */</span>
    <span class="hljs-keyword inline">private</span> ConversationMessageDO <span class="hljs-title function_ inline">generateAssistantResponse</span><span class="hljs-params inline">(
            String userMessage,
            UserConfigDO config,
            Long conversationId,
            Long configId,
            List&lt;ConversationMessageDO&gt; conversationMessages)</span> {

        <span class="hljs-comment inline">// ==================== 步骤1：准备请求数据 ====================</span>
        
        <span class="hljs-comment inline">// 使用HttpUtils准备完整的请求数据（包含对话历史）</span>
        Map&lt;String, Object&gt; requestData = HttpUtils.prepareRequestData(config, userMessage, conversationMessages);
        
        <span class="hljs-comment inline">// 提取请求头和请求体</span>
        Map&lt;String, String&gt; headers = (Map&lt;String, String&gt;) requestData.get(<span class="hljs-string inline">&quot;headers&quot;</span>);
        Map&lt;String, Object&gt; requestBody = (Map&lt;String, Object&gt;) requestData.get(<span class="hljs-string inline">&quot;requestBody&quot;</span>);

        <span class="hljs-comment inline">// ==================== 步骤2：发送HTTP请求 ====================</span>
        
        <span class="hljs-comment inline">// 序列化请求体为JSON字符串</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">requestBodyStr</span> <span class="hljs-operator inline">=</span> JsonUtils.toJsonString(requestBody);
        
        <span class="hljs-comment inline">// 发送POST请求到AI API</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">responseStr</span> <span class="hljs-operator inline">=</span> HttpUtils.post(config.getApiUrl(), headers, requestBodyStr);

        <span class="hljs-comment inline">// 检查响应是否为空</span>
        <span class="hljs-keyword inline">if</span> (responseStr == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(API_CALL_FAILED.getCode(), <span class="hljs-string inline">&quot;API返回空响应&quot;</span>);
        }

        <span class="hljs-comment inline">// ==================== 步骤3：解析响应 ====================</span>
        
        <span class="hljs-comment inline">// 解析响应JSON</span>
        Map&lt;String, Object&gt; responseMap = JsonUtils.parseObject(responseStr, Map.class);

        <span class="hljs-comment inline">// 提取AI回复内容</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">content</span> <span class="hljs-operator inline">=</span> <span class="hljs-literal inline">null</span>;
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">thinking</span> <span class="hljs-operator inline">=</span> <span class="hljs-literal inline">null</span>;

        <span class="hljs-comment inline">// 根据配置的路径提取回复内容</span>
        <span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getResponseTextPath())) {
            content = JsonUtils.extractValueFromPath(responseMap, config.getResponseTextPath());
        }

        <span class="hljs-comment inline">// 根据配置的路径提取思考过程（如果支持）</span>
        <span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getResponseThinkingTextPath())) {
            thinking = JsonUtils.extractValueFromPath(responseMap, config.getResponseThinkingTextPath());
        }

        <span class="hljs-comment inline">// 验证是否成功提取到内容</span>
        <span class="hljs-keyword inline">if</span> (content == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(API_CALL_FAILED.getCode(), <span class="hljs-string inline">&quot;无法从响应中提取内容&quot;</span>);
        }

        <span class="hljs-comment inline">// ==================== 步骤4：构建回复消息 ====================</span>
        
        <span class="hljs-comment inline">// 创建助手回复消息对象</span>
        <span class="hljs-keyword inline">return</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ConversationMessageDO</span>()
                .setConversationId(conversationId)
                .setConfigId(configId)
                .setRole(<span class="hljs-string inline">&quot;assistant&quot;</span>)
                .setContent(content)
                .setThinkingText(thinking);  <span class="hljs-comment inline">// 思考过程（可选）</span>
    }

    <span class="hljs-comment inline">/**
     * 标记配置为可用 - 健康检查和监控
     * 
     * <span class="hljs-doctag inline">@param</span> configId 配置ID
     * <span class="hljs-doctag inline">@param</span> userId 用户ID
     * <span class="hljs-doctag inline">@return</span> 是否成功
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">markConfigurationAsAvailable</span><span class="hljs-params inline">(Long configId, Long userId)</span> {
        <span class="hljs-comment inline">// 获取配置信息</span>
        <span class="hljs-type inline">UserConfigDO</span> <span class="hljs-variable inline">config</span> <span class="hljs-operator inline">=</span> userConfigService.getConfig(configId, userId);
        <span class="hljs-keyword inline">if</span> (config == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">false</span>;
        }

        <span class="hljs-comment inline">// 更新配置状态：设置为可用，并记录最后使用时间</span>
        userConfigService.setAvailableAndUpdateLastUsedTime(configId, <span class="hljs-literal inline">true</span>);

        <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">true</span>;
    }

    <span class="hljs-comment inline">/**
     * 获取对话消息列表 - 带缓存
     * 
     * <span class="hljs-doctag inline">@param</span> conversationId 对话ID
     * <span class="hljs-doctag inline">@param</span> userId 用户ID
     * <span class="hljs-doctag inline">@return</span> 消息列表
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-meta inline">@Cacheable(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)</span>
    <span class="hljs-keyword inline">public</span> List&lt;ConversationMessageDO&gt; <span class="hljs-title function_ inline">getMessages</span><span class="hljs-params inline">(Long conversationId, Long userId)</span> {
        <span class="hljs-comment inline">// 验证对话归属权</span>
        <span class="hljs-type inline">ConversationDO</span> <span class="hljs-variable inline">conversation</span> <span class="hljs-operator inline">=</span> conversationService.getConversation(conversationId, userId);
        <span class="hljs-keyword inline">if</span> (conversation == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONVERSATION_NOT_EXISTS.getCode(), CONVERSATION_NOT_EXISTS.getMsg());
        }

        <span class="hljs-comment inline">// 查询消息，按时间升序排列</span>
        <span class="hljs-keyword inline">return</span> list(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">LambdaQueryWrapper</span>&lt;ConversationMessageDO&gt;()
                .eq(ConversationMessageDO::getConversationId, conversationId)
                .orderByAsc(ConversationMessageDO::getCreateTime)
                .orderByAsc(ConversationMessageDO::getId)
        );
    }

    <span class="hljs-comment inline">/**
     * 获取单个消息 - 带缓存
     * 
     * <span class="hljs-doctag inline">@param</span> id 消息ID
     * <span class="hljs-doctag inline">@param</span> userId 用户ID
     * <span class="hljs-doctag inline">@return</span> 消息对象
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-meta inline">@Cacheable(key = &quot;&#x27;id:&#x27; + #id + &#x27;:user:&#x27; + #userId&quot;)</span>
    <span class="hljs-keyword inline">public</span> ConversationMessageDO <span class="hljs-title function_ inline">getMessage</span><span class="hljs-params inline">(Long id, Long userId)</span> {
        <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">message</span> <span class="hljs-operator inline">=</span> getById(id);
        <span class="hljs-keyword inline">if</span> (message == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }

        <span class="hljs-comment inline">// 验证对话归属权</span>
        <span class="hljs-type inline">ConversationDO</span> <span class="hljs-variable inline">conversation</span> <span class="hljs-operator inline">=</span> conversationService.getConversation(message.getConversationId(), userId);
        <span class="hljs-keyword inline">if</span> (conversation == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }

        <span class="hljs-keyword inline">return</span> message;
    }

    <span class="hljs-comment inline">/**
     * 删除消息 - 清理缓存
     * 
     * <span class="hljs-doctag inline">@param</span> id 消息ID
     * <span class="hljs-doctag inline">@param</span> userId 用户ID
     * <span class="hljs-doctag inline">@return</span> 是否成功
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-meta inline">@Transactional</span>
    <span class="hljs-meta inline">@CacheEvict(key = &quot;&#x27;id:&#x27; + #id + &#x27;:user:&#x27; + #userId&quot;)</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">deleteMessage</span><span class="hljs-params inline">(Long id, Long userId)</span> {
        <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">message</span> <span class="hljs-operator inline">=</span> getMessage(id, userId);
        <span class="hljs-keyword inline">if</span> (message == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">false</span>;
        }

        <span class="hljs-comment inline">// 手动清理相关缓存</span>
        <span class="hljs-type inline">Long</span> <span class="hljs-variable inline">conversationId</span> <span class="hljs-operator inline">=</span> message.getConversationId();
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">cacheKey</span> <span class="hljs-operator inline">=</span> <span class="hljs-string inline">&quot;acot_conversation_message::conversation:&quot;</span> + conversationId + <span class="hljs-string inline">&quot;:user:&quot;</span> + userId;
        redisTemplate.delete(cacheKey);

        <span class="hljs-keyword inline">return</span> removeById(id);
    }

    <span class="hljs-comment inline">/**
     * 删除对话的所有消息 - 批量删除
     * 
     * <span class="hljs-doctag inline">@param</span> conversationId 对话ID
     * <span class="hljs-doctag inline">@param</span> userId 用户ID
     * <span class="hljs-doctag inline">@return</span> 是否成功
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-meta inline">@Transactional</span>
    <span class="hljs-meta inline">@CacheEvict(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">deleteMessagesByConversationId</span><span class="hljs-params inline">(Long conversationId, Long userId)</span> {
        <span class="hljs-comment inline">// 验证对话归属权</span>
        <span class="hljs-type inline">ConversationDO</span> <span class="hljs-variable inline">conversation</span> <span class="hljs-operator inline">=</span> conversationService.getConversation(conversationId, userId);
        <span class="hljs-keyword inline">if</span> (conversation == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">false</span>;
        }

        <span class="hljs-comment inline">// 批量删除消息</span>
        <span class="hljs-keyword inline">return</span> remove(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">LambdaQueryWrapper</span>&lt;ConversationMessageDO&gt;()
                .eq(ConversationMessageDO::getConversationId, conversationId));
    }
}
</code></pre>
            </div>
        
<h2 id="写在最后" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#写在最后" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 写在最后">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            写在最后
        </h2>
<p class="text-base leading-7 mb-4 text-foreground">消息的构建、提取和发送是ACOT项目中最复杂的环节，同时也是它的核心功能，借由该平台，用户理论上可以对接任何一个可供调用的大模型API（甚至都可以不是大模型的API）。通过将用户自定义的配置文件保存在平台，该平台可以成为用户的大模型自定义对接器。</p>
<p class="text-base leading-7 mb-4 text-foreground">好，接下来又到了我最爱的许愿环节！💫</p>
<p class="text-base leading-7 mb-4 text-foreground"><em class="italic text-foreground">愿各API结构如细溪汇聚，宽广的河流包容源于五湖四海的样貌。容纳万物的算法能够让一切潜藏之物被人发掘。</em> ✨</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E8%AE%B8%E6%84%BF%EF%BC%88%E4%BB%A3%E7%A0%81%E7%89%88%EF%BC%89%0Awhile%20(bugs.exist())%20%7B%0Adebug()%3B%0Aif%20(fixed)%20%7B%0Acelebrate()%3B%20%F0%9F%8E%89%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 许愿（代码版）</span>
<span class="hljs-keyword inline">while</span> (bugs.exist()) {
    debug();
    <span class="hljs-keyword inline">if</span> (fixed) {
        celebrate(); 🎉
    }
}
</code></pre>
            </div>
        
d:["$","$L1d",null,{"htmlContent":"$1e","frontMatter":{"title":"All-Chat-on-This 配置解析功能实现原理：从配置到消息的完整数据流","description":"深度解析 UserConfigDO 类设计、prepareRequestData 数据处理逻辑、以及 sendMessage 消息生成发送的完整实现原理","date":"2025-01-15","author":"MilkWind","tags":["Spring Boot","API配置","JSON解析"],"references":{}},"readingTime":"53 min read","category":"all-chat-on-this","tocItems":[{"id":"all-chat-on-this-配置解析功能实现原理：从配置到消息的完整数据流","text":"All-Chat-on-This 配置解析功能实现原理：从配置到消息的完整数据流","level":1},{"id":"配置类设计篇：userconfigdo的灵活架构","text":"配置类设计篇：UserConfigDO的灵活架构","level":2},{"id":"灵活的api密钥放置策略","text":"灵活的API密钥放置策略","level":3},{"id":"json模板化设计：统一处理","text":"JSON模板化设计：统一处理","level":3},{"id":"消息路径配置设计：支持复杂嵌套结构","text":"消息路径配置设计：支持复杂嵌套结构","level":3},{"id":"userconfigdo完整结构图","text":"UserConfigDO完整结构图","level":3},{"id":"数据解析逻辑篇：preparerequestdata的双重奏","text":"数据解析逻辑篇：prepareRequestData的双重奏","level":2},{"id":"测试版本：单消息处理的基础逻辑","text":"测试版本：单消息处理的基础逻辑","level":3},{"id":"api密钥放置的三重分派","text":"API密钥放置的三重分派","level":3},{"id":"实用版本：对话历史处理","text":"实用版本：对话历史处理","level":3},{"id":"消息生成与发送逻辑篇：sendmessage的完整业务流程","text":"消息生成与发送逻辑篇：sendMessage的完整业务流程","level":2},{"id":"权限验证","text":"权限验证","level":3},{"id":"消息创建策略：先创建不保存","text":"消息创建策略：先创建不保存","level":3},{"id":"generateassistantresponse：http调用的核心引擎","text":"generateAssistantResponse：HTTP调用的核心引擎","level":3},{"id":"事务管理与缓存策略","text":"事务管理与缓存策略","level":3},{"id":"配置监控：markconfigurationasavailable","text":"配置监控：markConfigurationAsAvailable","level":3},{"id":"json路径解析引擎篇：jsonutils的深度算法解析","text":"JSON路径解析引擎篇：JsonUtils的深度算法解析","level":2},{"id":"路径解析的数学模型","text":"路径解析的数学模型","level":3},{"id":"extractvaluefrompath：路径提取的核心算法","text":"extractValueFromPath：路径提取的核心算法","level":3},{"id":"setvaluebypath：路径设置的智能构建","text":"setValueByPath：路径设置的智能构建","level":3},{"id":"路径解析的实际应用场景","text":"路径解析的实际应用场景","level":3},{"id":"边界情况处理的防御性设计","text":"边界情况处理的防御性设计","level":3},{"id":"jsonutils的完整方法架构图","text":"JsonUtils的完整方法架构图","level":3},{"id":"完整系统架构图","text":"完整系统架构图","level":2},{"id":"性能优化","text":"性能优化","level":2},{"id":"缓存策略的层次设计","text":"缓存策略的层次设计","level":3},{"id":"异常处理","text":"异常处理","level":3},{"id":"完整代码全解析","text":"完整代码全解析","level":2},{"id":"jsonutils：json解析工具类的完整实现","text":"JsonUtils：JSON解析工具类的完整实现","level":3},{"id":"userconfigdo：配置类的完整实现","text":"UserConfigDO：配置类的完整实现","level":3},{"id":"httputils：http请求处理的完整实现","text":"HttpUtils：HTTP请求处理的完整实现","level":3},{"id":"conversationmessageserviceimpl：消息服务的完整实现","text":"ConversationMessageServiceImpl：消息服务的完整实现","level":3},{"id":"写在最后","text":"写在最后","level":2}],"translations":{"common":{"welcome":"欢迎","loading":"加载中...","error":"出现了一些问题","retry":"重试","theme":"主题","language":"语言","light":"浅色","dark":"深色"},"navigation":{"home":"首页","personal":"个人","works":"作品","contributions":"贡献","documents":"文档","about":"关于","contact":"联系"},"personal":{"technicalSkills":"技术技能","email":"邮箱","github":"代码仓库","resume":"简历","codeRepository":"代码仓库","loadingPersonalInfo":"加载个人信息中...","loadingResume":"加载简历中...","closeResume":"关闭简历","emailCopied":"邮箱已复制到剪贴板！","galaxyDefaultDescription":"精通全栈开发技术，具备跨平台架构能力，擅长AI技术整合与高性能系统优化","skillGalaxy":"技能星系","stirGalaxy":"搅动星系","stirring":"搅动中...","fullStackEngineer":"MilkWind - 全栈工程师","professionalProfile":"关于我"},"documents":{"technicalDocuments":"技术文档","description":"基本原理、代码拆分以及一些碎碎念。","articles":"文章","categories":"分类","allCategories":"所有分类","noArticlesFound":"未找到文章","noArticlesAvailable":"中文暂无文章。","noArticlesInCategory":"该分类下未找到文章。","readMore":"阅读更多","loadingDocuments":"加载文档中...","backToDocuments":"← 返回文档","documentNotFound":"文档未找到","documentNotFoundDescription":"请求的文档无法找到。","technicalInsights":"技术拆解","untitledDocument":"无标题文档","byAuthor":"作者：","search":"搜索文章...","searchByTags":"按标签筛选","searching":"搜索中...","noSearchResults":"没有找到符合搜索条件的文章","clearSearch":"清除搜索","selectedTags":"已选标签","allTags":"所有标签","searchInTitle":"在标题、描述和内容中搜索","enterImmersiveMode":"沉浸阅读","exitImmersiveMode":"退出沉浸模式","immersiveReading":"沉浸阅读模式","exploreContent":"按分类探索内容","browseBy":"浏览方式","exploreAll":"所有内容汇总","categoryDescription":"该分类下的文章","totalArticles":"文章","totalCategories":"分类","foundArticles":"找到文章","categoriesWithResults":"有结果的分类"},"works":{"workCases":"作品案例","projects":"作品集","loadingProjects":"加载项目中...","grid":"网格","stack":"堆叠","of":"共","workCasesPageTitle":"作品案例页面","pageWorkingCorrectly":"此页面运行正常！路由配置正确。","try3DVersion":"尝试3D版本","dragToScroll":"拖拽滚动","dragToChange":"拖拽切换","swipeCards":"切换卡片","keyboardNav":"键盘导航"},"contributions":{"contributionCases":"开源项目","contributions":"贡献","loadingContributions":"加载贡献中...","grid":"网格","stack":"堆叠","of":"共","contributionCasesPageTitle":"贡献案例页面","pageWorkingCorrectly":"此页面运行正常！路由配置正确。","try3DVersion":"尝试3D版本","dragToScroll":"拖拽滚动","dragToChange":"拖拽切换","swipeCards":"切换卡片","keyboardNav":"键盘导航"},"contribution":{"contributionPreview":"贡献预览","accessible":"可访问","code":"代码","maintenance":"维护","enhancement":"增强","documentation":"文档","community":"社区","moreItems":"更多","technicalDetails":"技术详情","technologies":"技术栈：","contributionDetail":"贡献详情","description":"描述：","seeDetails":"查看详情","github":"代码仓库","viewContribution":"查看贡献","viewCode":"查看代码"},"project":{"projectPreview":"项目预览","accessible":"可访问","tool":"工具","plugin":"插件","toy":"小玩意","moreItems":"更多","technicalDetails":"技术详情","technologies":"技术栈：","description":"描述：","seeDetails":"查看详情","github":"GitHub","gitee":"Gitee","viewLiveDemo":"查看演示","viewCode":"查看代码","access":"访问","videos":"视频","watchVideo":"观看视频","hasVideo":"有视频"},"codeblock":{"copy":"复制","copySuccess":"代码已复制到剪贴板！","copyError":"复制代码失败","copyTooltip":"复制代码"},"toc":{"contents":"目录","autoScroll":"自动滚动到章节","collapse":"折叠","expand":"展开"},"loading":{"loading":"加载中","preparingExperience":"准备体验中"}},"lang":"zh","theme":"light"}]
12:null
18:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
11:null
1c:{"metadata":[["$","title","0",{"children":"All-Chat-on-This 配置解析功能实现原理：从配置到消息的完整数据流 | Interactive Portfolio"}],["$","meta","1",{"name":"description","content":"深度解析 UserConfigDO 类设计、prepareRequestData 数据处理逻辑、以及 sendMessage 消息生成发送的完整实现原理"}],["$","meta","2",{"name":"author","content":"Developer"}],["$","meta","3",{"name":"keywords","content":"portfolio,3D,interactive,web development,Three.js,Next.js"}],["$","meta","4",{"property":"og:title","content":"All-Chat-on-This 配置解析功能实现原理：从配置到消息的完整数据流 | Interactive Portfolio"}],["$","meta","5",{"property":"og:description","content":"深度解析 UserConfigDO 类设计、prepareRequestData 数据处理逻辑、以及 sendMessage 消息生成发送的完整实现原理"}],["$","meta","6",{"property":"og:type","content":"article"}],["$","meta","7",{"property":"article:published_time","content":"2025-01-15"}],["$","meta","8",{"property":"article:tag","content":"Spring Boot"}],["$","meta","9",{"property":"article:tag","content":"API配置"}],["$","meta","10",{"property":"article:tag","content":"JSON解析"}],["$","meta","11",{"name":"twitter:card","content":"summary_large_image"}],["$","meta","12",{"name":"twitter:title","content":"All-Chat-on-This 配置解析功能实现原理：从配置到消息的完整数据流 | Interactive Portfolio"}],["$","meta","13",{"name":"twitter:description","content":"深度解析 UserConfigDO 类设计、prepareRequestData 数据处理逻辑、以及 sendMessage 消息生成发送的完整实现原理"}],["$","link","14",{"rel":"icon","href":"/MilkWind-Website/favicon.ico","type":"image/x-icon","sizes":"32x32"}]],"error":null,"digest":"$undefined"}
14:{"metadata":"$1c:metadata","error":null,"digest":"$undefined"}
