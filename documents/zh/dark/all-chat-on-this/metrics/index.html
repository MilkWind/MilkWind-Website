<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/MilkWind-Website/_next/static/css/f034c804622acb16.css" data-precedence="next"/><link rel="stylesheet" href="/MilkWind-Website/_next/static/css/276b387d8ca46690.css" data-precedence="next"/><link rel="stylesheet" href="/MilkWind-Website/_next/static/css/5eacd01f773eed7f.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/MilkWind-Website/_next/static/chunks/webpack-4924e903218f1830.js"/><script src="/MilkWind-Website/_next/static/chunks/4bd1b696-5119e10e90c1bd1b.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/1684-794bcba02d6f7373.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/main-app-c5f95d71e93250dc.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/46-268e24d727b280ef.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/app/layout-af4a6e723c0ff668.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/app/error-dda32be1d095a86c.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/6874-fbe9a08eb79b991c.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/app/not-found-9ff98b2ccf24cac7.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/206-4f4cbf4d7156f437.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/app/documents/layout-28408791defde09e.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/2415-689c103fb3d2c28d.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/8610-7bd3f91f3cf2a4d6.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/app/documents/loading-1fa3f98b6e5a8e78.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/app/loading-68f227fb49b3ac8c.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/b498d07c-095637f0f10883c6.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/9554-b714f9de28e85d30.js" async=""></script><script src="/MilkWind-Website/_next/static/chunks/app/documents/%5B...slug%5D/page-8f3efa7e6c6c5377.js" async=""></script><title>All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态 | Interactive Portfolio</title><meta name="description" content="深度解析 Spring Boot 应用中端点监控、指标收集、用户活动跟踪的完整实现原理，涵盖 AOP、Micrometer、Prometheus 的技术栈"/><meta name="author" content="Developer"/><meta name="keywords" content="portfolio,3D,interactive,web development,Three.js,Next.js"/><meta property="og:title" content="All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态 | Interactive Portfolio"/><meta property="og:description" content="深度解析 Spring Boot 应用中端点监控、指标收集、用户活动跟踪的完整实现原理，涵盖 AOP、Micrometer、Prometheus 的技术栈"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2025-01-15"/><meta property="article:tag" content="Spring Boot"/><meta property="article:tag" content="监控系统"/><meta property="article:tag" content="Prometheus"/><meta property="article:tag" content="Micrometer"/><meta property="article:tag" content="AOP"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态 | Interactive Portfolio"/><meta name="twitter:description" content="深度解析 Spring Boot 应用中端点监控、指标收集、用户活动跟踪的完整实现原理，涵盖 AOP、Micrometer、Prometheus 的技术栈"/><link rel="icon" href="/MilkWind-Website/favicon.ico" type="image/x-icon" sizes="32x32"/><script>document.querySelectorAll('body link[rel="icon"], body link[rel="apple-touch-icon"]').forEach(el => document.head.appendChild(el))</script><script src="/MilkWind-Website/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__variable_9b7fb1 __variable_ca2a15 __variable_591dcc font-sans antialiased min-h-screen bg-background text-foreground"><div class="fixed inset-0 w-full h-full overflow-hidden pointer-events-none z-0" style="background:linear-gradient(135deg, hsl(210, 80%, 60%), hsl(180, 40%, 50%))"></div><div class="fixed top-20 right-5 z-50"><div class="w-16 h-16 rounded-full backdrop-blur-md border animate-pulse bg-surface/60 border-surface/40"></div></div><!--$--><style>
:root {
  --bprogress-color: #0066cc;
  --bprogress-height: 4px;
  --bprogress-spinner-size: 18px;
  --bprogress-spinner-animation-duration: 400ms;
  --bprogress-spinner-border-size: 2px;
  --bprogress-box-shadow: 0 0 10px #0066cc, 0 0 5px #0066cc;
  --bprogress-z-index: 99999;
  --bprogress-spinner-top: 15px;
  --bprogress-spinner-bottom: auto;
  --bprogress-spinner-right: 15px;
  --bprogress-spinner-left: auto;
}

.bprogress {
  width: 0;
  height: 0;
  pointer-events: none;
  z-index: var(--bprogress-z-index);
}

.bprogress .bar {
  background: var(--bprogress-color);
  position: fixed;
  z-index: var(--bprogress-z-index);
  top: 0;
  left: 0;
  width: 100%;
  height: var(--bprogress-height);
}

/* Fancy blur effect */
.bprogress .peg {
  display: block;
  position: absolute;
  right: 0;
  width: 100px;
  height: 100%;
  box-shadow: var(--bprogress-box-shadow);
  opacity: 1.0;
  transform: rotate(3deg) translate(0px, -4px);
}

/* Remove these to get rid of the spinner */
.bprogress .spinner {
  display: block;
  position: fixed;
  z-index: var(--bprogress-z-index);
  top: var(--bprogress-spinner-top);
  bottom: var(--bprogress-spinner-bottom);
  right: var(--bprogress-spinner-right);
  left: var(--bprogress-spinner-left);
}

.bprogress .spinner-icon {
  width: var(--bprogress-spinner-size);
  height: var(--bprogress-spinner-size);
  box-sizing: border-box;
  border: solid var(--bprogress-spinner-border-size) transparent;
  border-top-color: var(--bprogress-color);
  border-left-color: var(--bprogress-color);
  border-radius: 50%;
  -webkit-animation: bprogress-spinner var(--bprogress-spinner-animation-duration) linear infinite;
  animation: bprogress-spinner var(--bprogress-spinner-animation-duration) linear infinite;
}

.bprogress-custom-parent {
  overflow: hidden;
  position: relative;
}

.bprogress-custom-parent .bprogress .spinner,
.bprogress-custom-parent .bprogress .bar {
  position: absolute;
}

.bprogress .indeterminate {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: var(--bprogress-height);
  overflow: hidden;
}

.bprogress .indeterminate .inc,
.bprogress .indeterminate .dec {
  position: absolute;
  top: 0;
  height: 100%;
  background-color: var(--bprogress-color);
}

.bprogress .indeterminate .inc {
  animation: bprogress-indeterminate-increase 2s infinite;
}

.bprogress .indeterminate .dec {
  animation: bprogress-indeterminate-decrease 2s 0.5s infinite;
}

@-webkit-keyframes bprogress-spinner {
  0%   { -webkit-transform: rotate(0deg); transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
}

@keyframes bprogress-spinner {
  0%   { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes bprogress-indeterminate-increase {
  from { left: -5%; width: 5%; }
  to { left: 130%; width: 100%; }
}

@keyframes bprogress-indeterminate-decrease {
  from { left: -80%; width: 80%; }
  to { left: 110%; width: 10%; }
}
</style><!--$!--><template data-dgst="BAILOUT_TO_CLIENT_SIDE_RENDERING"></template><!--/$--><!--$--><div class="relative z-30 min-h-screen bg-background "><div class="container mx-auto px-4 py-8 max-w-4xl"><div class="mb-8"><a class="inline-flex items-center text-primary hover:text-primary/80 transition-colors" href="/MilkWind-Website/documents/">documents.backToDocuments</a></div><header class="mb-12"><div class="flex items-center gap-4 mb-4 text-sm text-foreground/60"><span class="px-3 py-1 bg-primary/20 text-primary rounded-full capitalize">all chat-on-this</span><span>21 min read</span></div><h1 class="font-bold mb-4 bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent text-4xl md:text-5xl">All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态</h1><p class="text-xl text-foreground/80 max-w-3xl">深度解析 Spring Boot 应用中端点监控、指标收集、用户活动跟踪的完整实现原理，涵盖 AOP、Micrometer、Prometheus 的技术栈</p><div class="flex flex-wrap gap-2 mt-6"><span class="px-3 py-1 text-sm bg-accent/20 text-accent rounded-full">Spring Boot</span><span class="px-3 py-1 text-sm bg-accent/20 text-accent rounded-full">监控系统</span><span class="px-3 py-1 text-sm bg-accent/20 text-accent rounded-full">Prometheus</span><span class="px-3 py-1 text-sm bg-accent/20 text-accent rounded-full">Micrometer</span><span class="px-3 py-1 text-sm bg-accent/20 text-accent rounded-full">AOP</span></div></header><article class="prose prose-headings:mt-8 prose-headings:font-semibold prose-headings:text-foreground prose-h1:text-5xl prose-h2:text-4xl prose-h3:text-3xl prose-h4:text-2xl prose-h5:text-xl prose-h6:text-lg max-w-none "><div class="prose-pre:p-4 prose-pre:bg-surface w-full"><h1 id="all-chat-on-this-端点监控与暴露功能实现原理：从aop切面到prometheus的完整监控生态" class="group relative text-4xl font-bold mt-8 mb-4 text-foreground leading-tight">
            <a href="#all-chat-on-this-端点监控与暴露功能实现原理：从aop切面到prometheus的完整监控生态" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态
        </h1>
<p class="text-base leading-7 mb-4 text-foreground">“让我看看用户都在做什么” （让我访问！）</p>
<p class="text-base leading-7 mb-4 text-foreground">ACOT的监控系统设计比较简单，目前仅监控了接口调用次数和在线人数，不过我们可以从这简单的应用中窥见从数据收集到可视化展示的完整监控生态系统流程。</p>
<h2 id="监控架构篇：四层分离设计" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#监控架构篇：四层分离设计" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 监控架构篇：四层分离设计">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            监控架构篇：四层分离设计
        </h2>
<h3 id="分层架构概述：数据流的生命周期" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#分层架构概述：数据流的生命周期" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 分层架构概述：数据流的生命周期">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            分层架构概述：数据流的生命周期
        </h3>
<p class="text-base leading-7 mb-4 text-foreground">ACOT的监控系统采用了典型的<strong class="font-bold text-foreground">四层分离架构</strong>，每一层都有其独特的职责和技术选型：</p>
<div class="mermaid block" id="mermaid-1767525094481-n6elza2">graph TB
    A[数据收集层] --> B[指标存储层]
    B --> C[数据暴露层]
    C --> D[监控可视化层]
    
    A1[AOP切面拦截] --> A
    A2[Spring Security事件] --> A
    A3[HTTP Session监听] --> A
    
    B1[Micrometer核心] --> B
    B2[Counter计数器] --> B
    B3[Gauge仪表盘] --> B
    
    C1[Spring Boot Actuator] --> C
    C2[Actuator Prometheus] --> C
    C3[Actuator Metrics] --> C
    
    D1[Prometheus时序数据库] --> D
    D2[Grafana可视化] --> D
    D3[告警系统] --> D</div>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">为什么要分层</strong>？</p>
<p class="text-base leading-7 mb-4 text-foreground">这种分层设计遵循了<strong class="font-bold text-foreground">关注点分离</strong>的原则：</p>
<p class="text-base leading-7 mb-4 text-foreground"><span class="katex-display inline"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>监控系统</mtext><mo>=</mo><mtext>数据收集</mtext><mo>⊕</mo><mtext>指标存储</mtext><mo>⊕</mo><mtext>数据暴露</mtext><mo>⊕</mo><mtext>可视化展示</mtext></mrow><annotation encoding="application/x-tex">监控系统 = 数据收集 \oplus 指标存储 \oplus 数据暴露 \oplus 可视化展示</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.6833em;"></span><span class="mord cjk_fallback inline">监控系统</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord cjk_fallback inline">数据收集</span><span class="mspace inline" style="margin-right:0.2222em;"></span><span class="mbin inline">⊕</span><span class="mspace inline" style="margin-right:0.2222em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord cjk_fallback inline">指标存储</span><span class="mspace inline" style="margin-right:0.2222em;"></span><span class="mbin inline">⊕</span><span class="mspace inline" style="margin-right:0.2222em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord cjk_fallback inline">数据暴露</span><span class="mspace inline" style="margin-right:0.2222em;"></span><span class="mbin inline">⊕</span><span class="mspace inline" style="margin-right:0.2222em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.6833em;"></span><span class="mord cjk_fallback inline">可视化展示</span></span></span></span></span></p>
<p class="text-base leading-7 mb-4 text-foreground">每一层的技术选型都可以独立演进，比如：</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed">数据收集层：可以从AOP切换到Filter或者Interceptor</li>
<li class="text-foreground leading-relaxed">指标存储层：可以从Micrometer切换到其他指标库</li>
<li class="text-foreground leading-relaxed">数据暴露层：可以支持多种格式（Prometheus、JSON、XML等）</li>
<li class="text-foreground leading-relaxed">可视化层：可以从Grafana切换到其他监控平台</li>
</ul>
<h2 id="端点监控的核心原理篇：aop" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#端点监控的核心原理篇：aop" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 端点监控的核心原理篇：AOP">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            端点监控的核心原理篇：AOP
        </h2>
<h3 id="aop切面编程：神秘下料男" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#aop切面编程：神秘下料男" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to AOP切面编程：神秘下料男">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            AOP切面编程：神秘下料男
        </h3>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">什么是AOP？</strong></p>
<p class="text-base leading-7 mb-4 text-foreground">AOP（Aspect-Oriented Programming）面向切面编程，简单来说就是在不修改原有代码的情况下，给方法&quot;加料&quot;。</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E5%8E%9F%E6%9D%A5%E7%9A%84%E4%B8%9A%E5%8A%A1%E6%96%B9%E6%B3%95%0Apublic%20String%20getUserInfo(Long%20userId)%20%7B%0Areturn%20userService.getUser(userId)%3B%0A%7D%0A%2F%2F%20AOP%E9%AD%94%E6%B3%95%E5%90%8E%E7%9A%84%E5%AE%9E%E9%99%85%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%0Apublic%20String%20getUserInfo(Long%20userId)%20%7B%0A%2F%2F%20%E2%86%93%20AOP%E5%89%8D%E7%BD%AE%E9%80%9A%E7%9F%A5%EF%BC%9A%E8%AE%B0%E5%BD%95%E8%B0%83%E7%94%A8%E7%BB%9F%E8%AE%A1%0AendpointMetrics.incrementEndpointCount(%22UserController%22%2C%20%22getUserInfo%22)%3B%0A%2F%2F%20%E2%86%93%20%E5%8E%9F%E5%A7%8B%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%0AString%20result%20%3D%20userService.getUser(userId)%3B%0A%2F%2F%20%E2%86%93%20AOP%E5%90%8E%E7%BD%AE%E9%80%9A%E7%9F%A5%EF%BC%9A%E8%AE%B0%E5%BD%95%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%E3%80%81%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%AD%89%0Areturn%20result%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 原来的业务方法</span>
<span class="hljs-keyword inline">public</span> String <span class="hljs-title function_ inline">getUserInfo</span><span class="hljs-params inline">(Long userId)</span> {
    <span class="hljs-keyword inline">return</span> userService.getUser(userId);
}

<span class="hljs-comment inline">// AOP魔法后的实际执行流程</span>
<span class="hljs-keyword inline">public</span> String <span class="hljs-title function_ inline">getUserInfo</span><span class="hljs-params inline">(Long userId)</span> {
    <span class="hljs-comment inline">// ↓ AOP前置通知：记录调用统计</span>
    endpointMetrics.incrementEndpointCount(<span class="hljs-string inline">&quot;UserController&quot;</span>, <span class="hljs-string inline">&quot;getUserInfo&quot;</span>);
    
    <span class="hljs-comment inline">// ↓ 原始业务逻辑</span>
    <span class="hljs-type inline">String</span> <span class="hljs-variable inline">result</span> <span class="hljs-operator inline">=</span> userService.getUser(userId);
    
    <span class="hljs-comment inline">// ↓ AOP后置通知：记录响应时间、异常处理等</span>
    <span class="hljs-keyword inline">return</span> result;
}
</code></pre>
            </div>
        
<h3 id="endpointmetricsaspect：切面拦截" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#endpointmetricsaspect：切面拦截" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to EndpointMetricsAspect：切面拦截">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            EndpointMetricsAspect：切面拦截
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40Aspect%0A%40Component%0A%40RequiredArgsConstructor%0A%40Slf4j%0Apublic%20class%20EndpointMetricsAspect%20%7B%0Aprivate%20final%20EndpointMetrics%20endpointMetrics%3B%0A%2F**%0A*%20%E5%88%87%E7%82%B9%E5%AE%9A%E4%B9%89%EF%BC%9A%E5%8F%AA%E6%8B%A6%E6%88%AA%40RestController%E6%A0%87%E6%B3%A8%E7%9A%84%E7%B1%BB%0A*%0A*%20%40within%20vs%20%40target%20%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A%0A*%20-%20%40within%EF%BC%9A%E7%B1%BB%E7%BA%A7%E5%88%AB%E5%8C%B9%E9%85%8D%EF%BC%8C%E7%BC%96%E8%AF%91%E6%97%B6%E7%A1%AE%E5%AE%9A%0A*%20-%20%40target%EF%BC%9A%E5%AF%B9%E8%B1%A1%E7%BA%A7%E5%88%AB%E5%8C%B9%E9%85%8D%EF%BC%8C%E8%BF%90%E8%A1%8C%E6%97%B6%E7%A1%AE%E5%AE%9A%0A*%0A*%20%E9%80%89%E6%8B%A9%40within%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%9A%E6%80%A7%E8%83%BD%E6%9B%B4%E5%A5%BD%EF%BC%8C%E7%BC%96%E8%AF%91%E6%97%B6%E5%B0%B1%E8%83%BD%E7%A1%AE%E5%AE%9A%E5%88%87%E5%85%A5%E7%82%B9%0A*%2F%0A%40Pointcut(%22%40within(org.springframework.web.bind.annotation.RestController)%22)%0Apublic%20void%20controllerPointcut()%20%7B%0A%2F%2F%20%E5%88%87%E7%82%B9%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95%EF%BC%8C%E6%97%A0%E9%9C%80%E5%AE%9E%E7%8E%B0%E4%BD%93%0A%7D%0A%2F**%0A*%20%E5%89%8D%E7%BD%AE%E9%80%9A%E7%9F%A5%EF%BC%9A%E5%9C%A8%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E5%89%8D%E7%BB%9F%E8%AE%A1%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%0A*%0A*%20%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9%40Before%E8%80%8C%E4%B8%8D%E6%98%AF%40Around%EF%BC%9F%0A*%20-%20%40Before%EF%BC%9A%E8%BD%BB%E9%87%8F%E7%BA%A7%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E8%AE%B0%E5%BD%95%E8%B0%83%E7%94%A8%E5%8D%B3%E5%8F%AF%0A*%20-%20%40Around%EF%BC%9A%E9%87%8D%E9%87%8F%E7%BA%A7%EF%BC%8C%E9%9C%80%E8%A6%81%E6%8E%A7%E5%88%B6%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%0A*%2F%0A%40Before(%22controllerPointcut()%22)%0Apublic%20void%20beforeControllerMethod(JoinPoint%20joinPoint)%20%7B%0Atry%20%7B%0A%2F%2F%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95%E7%AD%BE%E5%90%8D%E4%BF%A1%E6%81%AF%0AMethodSignature%20signature%20%3D%20(MethodSignature)%20joinPoint.getSignature()%3B%0AMethod%20method%20%3D%20signature.getMethod()%3B%0AClass%20controllerClass%20%3D%20method.getDeclaringClass()%3B%0A%2F%2F%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E6%8F%90%E5%8F%96%E7%B1%BB%E5%90%8D%E5%92%8C%E6%96%B9%E6%B3%95%E5%90%8D%0AString%20controllerName%20%3D%20controllerClass.getSimpleName()%3B%20%20%2F%2F%20UserController%0AString%20methodName%20%3D%20method.getName()%3B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20getUserInfo%0A%2F%2F%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E4%B8%BAHTTP%E7%AB%AF%E7%82%B9%EF%BC%88%E9%81%BF%E5%85%8D%E6%8B%A6%E6%88%AA%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%EF%BC%89%0Aif%20(isHttpEndpoint(method))%20%7B%0A%2F%2F%20%E6%AD%A5%E9%AA%A44%EF%BC%9A%E8%AE%B0%E5%BD%95%E7%AB%AF%E7%82%B9%E8%B0%83%E7%94%A8%E7%BB%9F%E8%AE%A1%0AendpointMetrics.incrementEndpointCount(controllerName%2C%20methodName)%3B%0Alog.debug(%22%E7%AB%AF%E7%82%B9%E8%B0%83%E7%94%A8%3A%20%7B%7D.%7B%7D%22%2C%20controllerName%2C%20methodName)%3B%0A%7D%0A%7D%20catch%20(Exception%20e)%20%7B%0A%2F%2F%20%E5%85%B3%E9%94%AE%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%BC%82%E5%B8%B8%E9%9A%94%E7%A6%BB%EF%BC%8C%E7%9B%91%E6%8E%A7%E5%A4%B1%E8%B4%A5%E4%B8%8D%E5%BD%B1%E5%93%8D%E4%B8%9A%E5%8A%A1%0Alog.error(%22%E7%AB%AF%E7%82%B9%E6%8C%87%E6%A0%87%E8%AE%B0%E5%BD%95%E5%A4%B1%E8%B4%A5%22%2C%20e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20HTTP%E7%AB%AF%E7%82%B9%E8%AF%86%E5%88%AB%E7%AE%97%E6%B3%95%EF%BC%9A%E6%94%AF%E6%8C%81%E6%89%80%E6%9C%89Spring%20Web%E6%B3%A8%E8%A7%A3%0A*%0A*%20%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%BF%99%E4%B8%AA%E6%A3%80%E6%9F%A5%EF%BC%9F%0A*%20-%20%40RestController%E7%B1%BB%E4%B8%AD%E5%8F%AF%E8%83%BD%E6%9C%89%E9%9D%9EHTTP%E6%96%B9%E6%B3%95%EF%BC%88%E5%A6%82private%20helper%E6%96%B9%E6%B3%95%EF%BC%89%0A*%20-%20%E5%8F%AA%E6%9C%89%E7%9C%9F%E6%AD%A3%E7%9A%84HTTP%E7%AB%AF%E7%82%B9%E6%89%8D%E9%9C%80%E8%A6%81%E7%BB%9F%E8%AE%A1%0A*%2F%0Aprivate%20boolean%20isHttpEndpoint(Method%20method)%20%7B%0Areturn%20method.isAnnotationPresent(RequestMapping.class)%20%7C%7C%20%20%20%20%20%20%2F%2F%20%E9%80%9A%E7%94%A8%E6%98%A0%E5%B0%84%0Amethod.isAnnotationPresent(GetMapping.class)%20%7C%7C%20%20%20%20%20%20%20%20%20%2F%2F%20GET%E8%AF%B7%E6%B1%82%0Amethod.isAnnotationPresent(PostMapping.class)%20%7C%7C%20%20%20%20%20%20%20%20%2F%2F%20POST%E8%AF%B7%E6%B1%82%0Amethod.isAnnotationPresent(PutMapping.class)%20%7C%7C%20%20%20%20%20%20%20%20%20%2F%2F%20PUT%E8%AF%B7%E6%B1%82%0Amethod.isAnnotationPresent(DeleteMapping.class)%20%7C%7C%20%20%20%20%20%20%2F%2F%20DELETE%E8%AF%B7%E6%B1%82%0Amethod.isAnnotationPresent(PatchMapping.class)%3B%20%20%20%20%20%20%20%20%20%2F%2F%20PATCH%E8%AF%B7%E6%B1%82%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@Aspect</span>
<span class="hljs-meta inline">@Component</span>
<span class="hljs-meta inline">@RequiredArgsConstructor</span>
<span class="hljs-meta inline">@Slf4j</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">EndpointMetricsAspect</span> {

    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> EndpointMetrics endpointMetrics;

    <span class="hljs-comment inline">/**
     * 切点定义：只拦截<span class="hljs-doctag inline">@RestController</span>标注的类
     * 
     * <span class="hljs-doctag inline">@within</span> vs <span class="hljs-doctag inline">@target</span> 的区别：
     * - <span class="hljs-doctag inline">@within</span>：类级别匹配，编译时确定
     * - <span class="hljs-doctag inline">@target</span>：对象级别匹配，运行时确定
     * 
     * 选择<span class="hljs-doctag inline">@within</span>的原因：性能更好，编译时就能确定切入点
     */</span>
    <span class="hljs-meta inline">@Pointcut(&quot;@within(org.springframework.web.bind.annotation.RestController)&quot;)</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">controllerPointcut</span><span class="hljs-params inline">()</span> {
        <span class="hljs-comment inline">// 切点定义方法，无需实现体</span>
    }

    <span class="hljs-comment inline">/**
     * 前置通知：在方法执行前统计调用次数
     * 
     * 为什么选择<span class="hljs-doctag inline">@Before</span>而不是<span class="hljs-doctag inline">@Around</span>？
     * - <span class="hljs-doctag inline">@Before</span>：轻量级，只需要记录调用即可
     * - <span class="hljs-doctag inline">@Around</span>：重量级，需要控制方法执行流程
     */</span>
    <span class="hljs-meta inline">@Before(&quot;controllerPointcut()&quot;)</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">beforeControllerMethod</span><span class="hljs-params inline">(JoinPoint joinPoint)</span> {
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-comment inline">// 步骤1：获取方法签名信息</span>
            <span class="hljs-type inline">MethodSignature</span> <span class="hljs-variable inline">signature</span> <span class="hljs-operator inline">=</span> (MethodSignature) joinPoint.getSignature();
            <span class="hljs-type inline">Method</span> <span class="hljs-variable inline">method</span> <span class="hljs-operator inline">=</span> signature.getMethod();
            Class&lt;?&gt; controllerClass = method.getDeclaringClass();
            
            <span class="hljs-comment inline">// 步骤2：提取类名和方法名</span>
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">controllerName</span> <span class="hljs-operator inline">=</span> controllerClass.getSimpleName();  <span class="hljs-comment inline">// UserController</span>
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">methodName</span> <span class="hljs-operator inline">=</span> method.getName();                     <span class="hljs-comment inline">// getUserInfo</span>

            <span class="hljs-comment inline">// 步骤3：验证是否为HTTP端点（避免拦截内部方法）</span>
            <span class="hljs-keyword inline">if</span> (isHttpEndpoint(method)) {
                <span class="hljs-comment inline">// 步骤4：记录端点调用统计</span>
                endpointMetrics.incrementEndpointCount(controllerName, methodName);
                log.debug(<span class="hljs-string inline">&quot;端点调用: {}.{}&quot;</span>, controllerName, methodName);
            }
        } <span class="hljs-keyword inline">catch</span> (Exception e) {
            <span class="hljs-comment inline">// 关键设计：异常隔离，监控失败不影响业务</span>
            log.error(<span class="hljs-string inline">&quot;端点指标记录失败&quot;</span>, e);
        }
    }

    <span class="hljs-comment inline">/**
     * HTTP端点识别算法：支持所有Spring Web注解
     * 
     * 为什么需要这个检查？
     * - <span class="hljs-doctag inline">@RestController</span>类中可能有非HTTP方法（如private helper方法）
     * - 只有真正的HTTP端点才需要统计
     */</span>
    <span class="hljs-keyword inline">private</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">isHttpEndpoint</span><span class="hljs-params inline">(Method method)</span> {
        <span class="hljs-keyword inline">return</span> method.isAnnotationPresent(RequestMapping.class) ||      <span class="hljs-comment inline">// 通用映射</span>
                method.isAnnotationPresent(GetMapping.class) ||         <span class="hljs-comment inline">// GET请求</span>
                method.isAnnotationPresent(PostMapping.class) ||        <span class="hljs-comment inline">// POST请求</span>
                method.isAnnotationPresent(PutMapping.class) ||         <span class="hljs-comment inline">// PUT请求</span>
                method.isAnnotationPresent(DeleteMapping.class) ||      <span class="hljs-comment inline">// DELETE请求</span>
                method.isAnnotationPresent(PatchMapping.class);         <span class="hljs-comment inline">// PATCH请求</span>
    }
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">JoinPoint的信息提取链</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20JoinPoint%E4%BF%A1%E6%81%AF%E6%8F%90%E5%8F%96%E7%9A%84%E5%AE%8C%E6%95%B4%E9%93%BE%E8%B7%AF%0AJoinPoint%20joinPoint%20%3D%20%2F%2F%20AOP%E6%A1%86%E6%9E%B6%E6%B3%A8%E5%85%A5%0A%E2%86%93%0AMethodSignature%20signature%20%3D%20(MethodSignature)%20joinPoint.getSignature()%3B%0A%E2%86%93%0AMethod%20method%20%3D%20signature.getMethod()%3B%20%20%2F%2F%20%E8%8E%B7%E5%8F%96Method%E5%AF%B9%E8%B1%A1%0A%E2%86%93%0AClass%20clazz%20%3D%20method.getDeclaringClass()%3B%20%20%2F%2F%20%E8%8E%B7%E5%8F%96%E5%A3%B0%E6%98%8E%E7%B1%BB%0A%E2%86%93%0AString%20className%20%3D%20clazz.getSimpleName()%3B%20%20%20%20%20%2F%2F%20UserController%0AString%20methodName%20%3D%20method.getName()%3B%20%20%20%20%20%20%20%20%20%2F%2F%20getUserInfo">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// JoinPoint信息提取的完整链路</span>
<span class="hljs-type inline">JoinPoint</span> <span class="hljs-variable inline">joinPoint</span> <span class="hljs-operator inline">=</span> <span class="hljs-comment inline">// AOP框架注入</span>
    ↓
<span class="hljs-type inline">MethodSignature</span> <span class="hljs-variable inline">signature</span> <span class="hljs-operator inline">=</span> (MethodSignature) joinPoint.getSignature();
    ↓
<span class="hljs-type inline">Method</span> <span class="hljs-variable inline">method</span> <span class="hljs-operator inline">=</span> signature.getMethod();  <span class="hljs-comment inline">// 获取Method对象</span>
    ↓
Class&lt;?&gt; clazz = method.getDeclaringClass();  <span class="hljs-comment inline">// 获取声明类</span>
    ↓
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">className</span> <span class="hljs-operator inline">=</span> clazz.getSimpleName();     <span class="hljs-comment inline">// UserController</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">methodName</span> <span class="hljs-operator inline">=</span> method.getName();         <span class="hljs-comment inline">// getUserInfo</span>
</code></pre>
            </div>
        
<h3 id="线程安全的计数器设计：endpointmetrics并发" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#线程安全的计数器设计：endpointmetrics并发" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 线程安全的计数器设计：EndpointMetrics并发">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            线程安全的计数器设计：EndpointMetrics并发
        </h3>
<p class="text-base leading-7 mb-4 text-foreground">在高并发环境下，如何确保计数器的准确性？请看VCR——（不是）</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40Component%0Apublic%20class%20EndpointMetrics%20%7B%0A%2F%2F%20%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%EF%BC%9AMicrometer%E7%9A%84%E5%BA%A6%E9%87%8F%E6%B3%A8%E5%86%8C%E8%A1%A8%0Aprivate%20final%20MeterRegistry%20meterRegistry%3B%0A%2F%2F%20%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84%E8%AE%A1%E6%95%B0%E5%99%A8%E7%BC%93%E5%AD%98%EF%BC%9A%E9%81%BF%E5%85%8D%E9%87%8D%E5%A4%8D%E5%88%9B%E5%BB%BACounter%0Aprivate%20final%20Map%20endpointCounters%20%3D%20new%20ConcurrentHashMap()%3B%0A%2F%2F%20%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%9A%84%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E8%AE%A1%E6%95%B0%E5%99%A8%0Aprivate%20final%20AtomicInteger%20onlineUsers%20%3D%20new%20AtomicInteger(0)%3B%0A%2F**%0A*%20%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%EF%BC%9A%E6%B3%A8%E5%86%8C%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%E7%9A%84Gauge%E6%8C%87%E6%A0%87%0A*%0A*%20Gauge%20vs%20Counter%20%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A%0A*%20-%20Gauge%EF%BC%9A%E7%9E%AC%E6%97%B6%E5%80%BC%E6%8C%87%E6%A0%87%EF%BC%8C%E5%A6%82%E5%BD%93%E5%89%8D%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%E3%80%81%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F%0A*%20-%20Counter%EF%BC%9A%E7%B4%AF%E5%8A%A0%E6%8C%87%E6%A0%87%EF%BC%8C%E5%A6%82API%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%E3%80%81%E9%94%99%E8%AF%AF%E6%95%B0%E9%87%8F%0A*%2F%0Apublic%20EndpointMetrics(MeterRegistry%20meterRegistry)%20%7B%0Athis.meterRegistry%20%3D%20meterRegistry%3B%0A%2F%2F%20%E6%B3%A8%E5%86%8CGauge%EF%BC%9A%E5%AE%9E%E6%97%B6%E5%8F%8D%E6%98%A0%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0AGauge.builder(%22acot.online.users%22%2C%20onlineUsers%3A%3Aget)%20%20%2F%2F%20%E5%BC%95%E7%94%A8%E5%8E%9F%E5%AD%90%E7%B1%BB%E7%9A%84get%E6%96%B9%E6%B3%95%0A.description(%22%E5%BD%93%E5%89%8D%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%22)%0A.register(meterRegistry)%3B%0A%7D%0A%2F**%0A*%20%E9%80%92%E5%A2%9E%E7%AB%AF%E7%82%B9%E8%B0%83%E7%94%A8%E8%AE%A1%E6%95%B0%EF%BC%9A%E6%A0%B8%E5%BF%83%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AE%97%E6%B3%95%0A*%0A*%20%40param%20controllerName%20%E6%8E%A7%E5%88%B6%E5%99%A8%E5%90%8D%E7%A7%B0%0A*%20%40param%20methodName%20%E6%96%B9%E6%B3%95%E5%90%8D%E7%A7%B0%0A*%2F%0Apublic%20void%20incrementEndpointCount(String%20controllerName%2C%20String%20methodName)%20%7B%0A%2F%2F%20%E6%9E%84%E9%80%A0%E7%AB%AF%E7%82%B9%E6%A0%87%E8%AF%86%E7%AC%A6%0AString%20endpoint%20%3D%20controllerName%20%2B%20%22.%22%20%2B%20methodName%3B%0A%2F%2F%20%E5%85%B3%E9%94%AE%E7%AE%97%E6%B3%95%EF%BC%9AcomputeIfAbsent%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E4%BF%9D%E8%AF%81%0ACounter%20counter%20%3D%20endpointCounters.computeIfAbsent(endpoint%2C%20k%20-%3E%0ACounter.builder(%22acot.endpoint.calls%22)%0A%2F%2F%20%E5%A4%9A%E7%BB%B4%E5%BA%A6%E6%A0%87%E7%AD%BE%EF%BC%9A%E6%94%AF%E6%8C%81Prometheus%E7%9A%84%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2%0A.tags(Arrays.asList(%0ATag.of(%22controller%22%2C%20controllerName)%2C%20%20%2F%2F%20%E6%8C%89%E6%8E%A7%E5%88%B6%E5%99%A8%E5%88%86%E7%BB%84%0ATag.of(%22method%22%2C%20methodName)))%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%8C%89%E6%96%B9%E6%B3%95%E5%88%86%E7%BB%84%0A.description(%22%E7%AB%AF%E7%82%B9%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%E7%BB%9F%E8%AE%A1%22)%0A.register(meterRegistry))%3B%20%20%2F%2F%20%E6%B3%A8%E5%86%8C%E5%88%B0Micrometer%0A%2F%2F%20%E5%8E%9F%E5%AD%90%E9%80%92%E5%A2%9E%E6%93%8D%E4%BD%9C%0Acounter.increment()%3B%0A%7D%0A%2F**%0A*%20%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%EF%BC%9A%E5%8E%9F%E5%AD%90%E9%80%92%E5%A2%9E%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0A*%2F%0Apublic%20void%20userLoggedIn()%20%7B%0AonlineUsers.incrementAndGet()%3B%20%20%2F%2F%20%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%EF%BC%9Acurrent%20%2B%201%0A%7D%0A%2F**%0A*%20%E7%94%A8%E6%88%B7%E7%99%BB%E5%87%BA%EF%BC%9A%E5%B8%A6%E8%BE%B9%E7%95%8C%E6%A3%80%E6%9F%A5%E7%9A%84%E5%8E%9F%E5%AD%90%E9%80%92%E5%87%8F%0A*%2F%0Apublic%20void%20userLoggedOut()%20%7B%0A%2F%2F%20%E9%98%B2%E6%AD%A2%E8%B4%9F%E6%95%B0%E7%9A%84%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%EF%BC%9Amax(0%2C%20current%20-%201)%0AonlineUsers.updateAndGet(current%20-%3E%20Math.max(0%2C%20current%20-%201))%3B%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@Component</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">EndpointMetrics</span> {
    
    <span class="hljs-comment inline">// 核心组件：Micrometer的度量注册表</span>
    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> MeterRegistry meterRegistry;
    
    <span class="hljs-comment inline">// 线程安全的计数器缓存：避免重复创建Counter</span>
    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> Map&lt;String, Counter&gt; endpointCounters = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-comment inline">// 原子操作的在线用户计数器</span>
    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> <span class="hljs-type inline">AtomicInteger</span> <span class="hljs-variable inline">onlineUsers</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">AtomicInteger</span>(<span class="hljs-number inline">0</span>);

    <span class="hljs-comment inline">/**
     * 构造函数：注册在线用户数的Gauge指标
     * 
     * Gauge vs Counter 的区别：
     * - Gauge：瞬时值指标，如当前在线用户数、内存使用量
     * - Counter：累加指标，如API调用次数、错误数量
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-title function_ inline">EndpointMetrics</span><span class="hljs-params inline">(MeterRegistry meterRegistry)</span> {
        <span class="hljs-built_in inline">this</span>.meterRegistry = meterRegistry;
        
        <span class="hljs-comment inline">// 注册Gauge：实时反映在线用户数</span>
        Gauge.builder(<span class="hljs-string inline">&quot;acot.online.users&quot;</span>, onlineUsers::get)  <span class="hljs-comment inline">// 引用原子类的get方法</span>
                .description(<span class="hljs-string inline">&quot;当前在线用户数&quot;</span>)
                .register(meterRegistry);
    }

    <span class="hljs-comment inline">/**
     * 递增端点调用计数：核心的线程安全算法
     * 
     * <span class="hljs-doctag inline">@param</span> controllerName 控制器名称
     * <span class="hljs-doctag inline">@param</span> methodName 方法名称
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">incrementEndpointCount</span><span class="hljs-params inline">(String controllerName, String methodName)</span> {
        <span class="hljs-comment inline">// 构造端点标识符</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">endpoint</span> <span class="hljs-operator inline">=</span> controllerName + <span class="hljs-string inline">&quot;.&quot;</span> + methodName;
        
        <span class="hljs-comment inline">// 关键算法：computeIfAbsent的原子性保证</span>
        <span class="hljs-type inline">Counter</span> <span class="hljs-variable inline">counter</span> <span class="hljs-operator inline">=</span> endpointCounters.computeIfAbsent(endpoint, k -&gt;
                Counter.builder(<span class="hljs-string inline">&quot;acot.endpoint.calls&quot;</span>)
                        <span class="hljs-comment inline">// 多维度标签：支持Prometheus的复杂查询</span>
                        .tags(Arrays.asList(
                                Tag.of(<span class="hljs-string inline">&quot;controller&quot;</span>, controllerName),  <span class="hljs-comment inline">// 按控制器分组</span>
                                Tag.of(<span class="hljs-string inline">&quot;method&quot;</span>, methodName)))         <span class="hljs-comment inline">// 按方法分组</span>
                        .description(<span class="hljs-string inline">&quot;端点调用次数统计&quot;</span>)
                        .register(meterRegistry));  <span class="hljs-comment inline">// 注册到Micrometer</span>
        
        <span class="hljs-comment inline">// 原子递增操作</span>
        counter.increment();
    }

    <span class="hljs-comment inline">/**
     * 用户登录：原子递增在线用户数
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">userLoggedIn</span><span class="hljs-params inline">()</span> {
        onlineUsers.incrementAndGet();  <span class="hljs-comment inline">// 原子操作：current + 1</span>
    }

    <span class="hljs-comment inline">/**
     * 用户登出：带边界检查的原子递减
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">userLoggedOut</span><span class="hljs-params inline">()</span> {
        <span class="hljs-comment inline">// 防止负数的原子操作：max(0, current - 1)</span>
        onlineUsers.updateAndGet(current -&gt; Math.max(<span class="hljs-number inline">0</span>, current - <span class="hljs-number inline">1</span>));
    }
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">为什么选择ConcurrentHashMap + computeIfAbsent？</strong></p>
<p class="text-base leading-7 mb-4 text-foreground">这种组合的优势在于：</p>
<p class="text-base leading-7 mb-4 text-foreground">错误的做法：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9D%8C%20%E5%AD%98%E5%9C%A8%E7%AB%9E%E6%80%81%E6%9D%A1%E4%BB%B6%E7%9A%84%E9%94%99%E8%AF%AF%E5%AE%9E%E7%8E%B0%0Aif%20(!endpointCounters.containsKey(endpoint))%20%7B%0A%2F%2F%20%E9%97%AE%E9%A2%98%EF%BC%9A%E4%B8%A4%E4%B8%AA%E7%BA%BF%E7%A8%8B%E5%8F%AF%E8%83%BD%E5%90%8C%E6%97%B6%E6%89%A7%E8%A1%8C%E5%88%B0%E8%BF%99%E9%87%8C%0AendpointCounters.put(endpoint%2C%20createNewCounter(endpoint))%3B%0A%7D%0ACounter%20counter%20%3D%20endpointCounters.get(endpoint)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ❌ 存在竞态条件的错误实现</span>
<span class="hljs-keyword inline">if</span> (!endpointCounters.containsKey(endpoint)) {
    <span class="hljs-comment inline">// 问题：两个线程可能同时执行到这里</span>
    endpointCounters.put(endpoint, createNewCounter(endpoint));
}
<span class="hljs-type inline">Counter</span> <span class="hljs-variable inline">counter</span> <span class="hljs-operator inline">=</span> endpointCounters.get(endpoint);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">正确的做法：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9C%85%20%E5%8E%9F%E5%AD%90%E6%80%A7%E6%93%8D%E4%BD%9C%EF%BC%8C%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%0ACounter%20counter%20%3D%20endpointCounters.computeIfAbsent(endpoint%2C%20k%20-%3E%20createNewCounter(k))%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ✅ 原子性操作，线程安全</span>
<span class="hljs-type inline">Counter</span> <span class="hljs-variable inline">counter</span> <span class="hljs-operator inline">=</span> endpointCounters.computeIfAbsent(endpoint, k -&gt; createNewCounter(k));
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">computeIfAbsent的时间复杂度分析</strong>：</p>
<p class="text-base leading-7 mb-4 text-foreground">在理想情况下：</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed">首次访问：<span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.02778em;">O</span><span class="mopen inline">(</span><span class="mord inline">1</span><span class="mclose inline">)</span></span></span></span> 创建 + <span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.02778em;">O</span><span class="mopen inline">(</span><span class="mord inline">1</span><span class="mclose inline">)</span></span></span></span> 插入 = <span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.02778em;">O</span><span class="mopen inline">(</span><span class="mord inline">1</span><span class="mclose inline">)</span></span></span></span></li>
<li class="text-foreground leading-relaxed">后续访问：<span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.02778em;">O</span><span class="mopen inline">(</span><span class="mord inline">1</span><span class="mclose inline">)</span></span></span></span> 查找</li>
</ul>
<h3 id="在线用户统计的双重保障机制" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#在线用户统计的双重保障机制" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 在线用户统计的双重保障机制">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            在线用户统计的双重保障机制
        </h3>
<p class="text-base leading-7 mb-4 text-foreground">ACOT实现了一套&quot;双保险&quot;的用户统计系统：</p>
<div class="mermaid block" id="mermaid-1767525094481-wkdc84c">sequenceDiagram
    participant User as 用户
    participant Security as Spring Security
    participant Session as HTTP Session
    participant Listener1 as UserActivityMetricsConfig
    participant Listener2 as SessionEventListener
    participant Metrics as EndpointMetrics

    User->>Security: 登录
    Security->>Listener1: AuthenticationSuccessEvent
    Listener1->>Metrics: userLoggedIn() [+1]
    
    User->>Security: 正常登出
    Security->>Listener1: LogoutSuccessEvent
    Listener1->>Metrics: userLoggedOut() [-1]
    
    Note over Session: 会话超时或异常断开
    Session->>Listener2: sessionDestroyed
    Listener2->>Metrics: userLoggedOut() [-1]</div>
<h3 id="useractivitymetricsconfig：spring-security事件处理" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#useractivitymetricsconfig：spring-security事件处理" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to UserActivityMetricsConfig：Spring Security事件处理">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            UserActivityMetricsConfig：Spring Security事件处理
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40Configuration%0A%40RequiredArgsConstructor%0A%40Slf4j%0Apublic%20class%20UserActivityMetricsConfig%20%7B%0Aprivate%20final%20EndpointMetrics%20endpointMetrics%3B%0A%2F**%0A*%20%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%0A*%0A*%20Spring%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BC%98%E5%8A%BF%EF%BC%9A%0A*%20-%20%E6%9D%BE%E8%80%A6%E5%90%88%EF%BC%9A%E7%9B%91%E5%90%AC%E5%99%A8%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%8F%91%E5%B8%83%E8%80%85%E6%97%A0%E7%9B%B4%E6%8E%A5%E4%BE%9D%E8%B5%96%0A*%20-%20%E5%BC%82%E6%AD%A5%E6%94%AF%E6%8C%81%EF%BC%9A%E5%8F%AF%E9%85%8D%E7%BD%AE%E4%B8%BA%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%0A*%20-%20%E5%A4%9A%E7%9B%91%E5%90%AC%E5%99%A8%EF%BC%9A%E5%90%8C%E4%B8%80%E4%BA%8B%E4%BB%B6%E5%8F%AF%E4%BB%A5%E6%9C%89%E5%A4%9A%E4%B8%AA%E7%9B%91%E5%90%AC%E5%99%A8%0A*%2F%0A%40EventListener%0Apublic%20void%20handleAuthenticationSuccess(AuthenticationSuccessEvent%20event)%20%7B%0AAuthentication%20authentication%20%3D%20event.getAuthentication()%3B%0AString%20username%20%3D%20authentication.getName()%3B%0Alog.debug(%22%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%3A%20%7B%7D%22%2C%20username)%3B%0A%2F%2F%20%E9%80%92%E5%A2%9E%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0AendpointMetrics.userLoggedIn()%3B%0A%7D%0A%2F**%0A*%20%E7%99%BB%E5%87%BA%E6%88%90%E5%8A%9F%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%0A*%0A*%20%E6%B3%A8%E6%84%8F%EF%BC%9A%E6%9F%90%E4%BA%9B%E7%99%BB%E5%87%BA%E5%9C%BA%E6%99%AF%E4%B8%8Bauthentication%E5%8F%AF%E8%83%BD%E4%B8%BAnull%0A*%20%E4%BE%8B%E5%A6%82%EF%BC%9Asession%E8%B6%85%E6%97%B6%E5%90%8E%E7%9A%84%E4%B8%BB%E5%8A%A8%E7%99%BB%E5%87%BA%0A*%2F%0A%40EventListener%0Apublic%20void%20handleLogout(LogoutSuccessEvent%20event)%20%7B%0AAuthentication%20authentication%20%3D%20event.getAuthentication()%3B%0Aif%20(authentication%20!%3D%20null)%20%7B%0AString%20username%20%3D%20authentication.getName()%3B%0Alog.debug(%22%E7%94%A8%E6%88%B7%E7%99%BB%E5%87%BA%3A%20%7B%7D%22%2C%20username)%3B%0A%7D%0A%2F%2F%20%E9%80%92%E5%87%8F%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%EF%BC%88%E6%97%A0%E8%AE%BAauthentication%E6%98%AF%E5%90%A6%E4%B8%BAnull%EF%BC%89%0AendpointMetrics.userLoggedOut()%3B%0A%7D%0A%2F**%0A*%20%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81%E6%88%90%E5%8A%9F%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%9A%E9%81%BF%E5%85%8D%E9%87%8D%E5%A4%8D%E7%BB%9F%E8%AE%A1%0A*%0A*%20%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%BF%99%E4%B8%AABean%EF%BC%9F%0A*%20-%20%E6%9F%90%E4%BA%9B%E6%83%85%E5%86%B5%E4%B8%8B%E5%8F%AF%E8%83%BD%E9%9C%80%E8%A6%81form-based%E7%99%BB%E5%BD%95%0A*%20-%20%E8%BF%99%E4%B8%AAhandler%E5%8F%AA%E8%B4%9F%E8%B4%A3%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%EF%BC%8C%E4%B8%8D%E9%87%8D%E5%A4%8D%E7%BB%9F%E8%AE%A1%E6%8C%87%E6%A0%87%0A*%2F%0A%40Bean%0Apublic%20AuthenticationSuccessHandler%20loggingAuthenticationSuccessHandler()%20%7B%0Areturn%20(request%2C%20response%2C%20authentication)%20-%3E%20%7B%0AString%20username%20%3D%20authentication.getName()%3B%0Alog.debug(%22%E8%A1%A8%E5%8D%95%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%3A%20%7B%7D%22%2C%20username)%3B%0A%2F%2F%20%E6%B3%A8%E6%84%8F%EF%BC%9A%E8%BF%99%E9%87%8C%E4%B8%8D%E8%B0%83%E7%94%A8endpointMetrics.userLoggedIn()%0A%2F%2F%20%E5%9B%A0%E4%B8%BA%40EventListener%E5%B7%B2%E7%BB%8F%E5%A4%84%E7%90%86%E4%BA%86%E7%BB%9F%E8%AE%A1%0A%7D%3B%0A%7D%0A%2F**%0A*%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%87%BA%E6%88%90%E5%8A%9F%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%9A%E9%81%BF%E5%85%8D%E9%87%8D%E5%A4%8D%E7%BB%9F%E8%AE%A1%0A*%2F%0A%40Bean%0Apublic%20LogoutSuccessHandler%20loggingLogoutSuccessHandler()%20%7B%0Areturn%20(request%2C%20response%2C%20authentication)%20-%3E%20%7B%0Aif%20(authentication%20!%3D%20null)%20%7B%0AString%20username%20%3D%20authentication.getName()%3B%0Alog.debug(%22%E8%A1%A8%E5%8D%95%E7%99%BB%E5%87%BA%E6%88%90%E5%8A%9F%3A%20%7B%7D%22%2C%20username)%3B%0A%7D%0A%2F%2F%20%E6%B3%A8%E6%84%8F%EF%BC%9A%E8%BF%99%E9%87%8C%E4%B8%8D%E8%B0%83%E7%94%A8endpointMetrics.userLoggedOut()%0A%2F%2F%20%E5%9B%A0%E4%B8%BA%40EventListener%E5%B7%B2%E7%BB%8F%E5%A4%84%E7%90%86%E4%BA%86%E7%BB%9F%E8%AE%A1%0A%7D%3B%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@Configuration</span>
<span class="hljs-meta inline">@RequiredArgsConstructor</span>
<span class="hljs-meta inline">@Slf4j</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">UserActivityMetricsConfig</span> {

    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> EndpointMetrics endpointMetrics;

    <span class="hljs-comment inline">/**
     * 登录成功事件监听
     * 
     * Spring事件机制的优势：
     * - 松耦合：监听器和事件发布者无直接依赖
     * - 异步支持：可配置为异步处理
     * - 多监听器：同一事件可以有多个监听器
     */</span>
    <span class="hljs-meta inline">@EventListener</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">handleAuthenticationSuccess</span><span class="hljs-params inline">(AuthenticationSuccessEvent event)</span> {
        <span class="hljs-type inline">Authentication</span> <span class="hljs-variable inline">authentication</span> <span class="hljs-operator inline">=</span> event.getAuthentication();
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">username</span> <span class="hljs-operator inline">=</span> authentication.getName();
        
        log.debug(<span class="hljs-string inline">&quot;用户登录: {}&quot;</span>, username);
        
        <span class="hljs-comment inline">// 递增在线用户数</span>
        endpointMetrics.userLoggedIn();
    }

    <span class="hljs-comment inline">/**
     * 登出成功事件监听
     * 
     * 注意：某些登出场景下authentication可能为null
     * 例如：session超时后的主动登出
     */</span>
    <span class="hljs-meta inline">@EventListener</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">handleLogout</span><span class="hljs-params inline">(LogoutSuccessEvent event)</span> {
        <span class="hljs-type inline">Authentication</span> <span class="hljs-variable inline">authentication</span> <span class="hljs-operator inline">=</span> event.getAuthentication();
        
        <span class="hljs-keyword inline">if</span> (authentication != <span class="hljs-literal inline">null</span>) {
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">username</span> <span class="hljs-operator inline">=</span> authentication.getName();
            log.debug(<span class="hljs-string inline">&quot;用户登出: {}&quot;</span>, username);
        }
        
        <span class="hljs-comment inline">// 递减在线用户数（无论authentication是否为null）</span>
        endpointMetrics.userLoggedOut();
    }

    <span class="hljs-comment inline">/**
     * 自定义认证成功处理器：避免重复统计
     * 
     * 为什么需要这个Bean？
     * - 某些情况下可能需要form-based登录
     * - 这个handler只负责日志记录，不重复统计指标
     */</span>
    <span class="hljs-meta inline">@Bean</span>
    <span class="hljs-keyword inline">public</span> AuthenticationSuccessHandler <span class="hljs-title function_ inline">loggingAuthenticationSuccessHandler</span><span class="hljs-params inline">()</span> {
        <span class="hljs-keyword inline">return</span> (request, response, authentication) -&gt; {
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">username</span> <span class="hljs-operator inline">=</span> authentication.getName();
            log.debug(<span class="hljs-string inline">&quot;表单登录成功: {}&quot;</span>, username);
            <span class="hljs-comment inline">// 注意：这里不调用endpointMetrics.userLoggedIn()</span>
            <span class="hljs-comment inline">// 因为@EventListener已经处理了统计</span>
        };
    }

    <span class="hljs-comment inline">/**
     * 自定义登出成功处理器：避免重复统计
     */</span>
    <span class="hljs-meta inline">@Bean</span>
    <span class="hljs-keyword inline">public</span> LogoutSuccessHandler <span class="hljs-title function_ inline">loggingLogoutSuccessHandler</span><span class="hljs-params inline">()</span> {
        <span class="hljs-keyword inline">return</span> (request, response, authentication) -&gt; {
            <span class="hljs-keyword inline">if</span> (authentication != <span class="hljs-literal inline">null</span>) {
                <span class="hljs-type inline">String</span> <span class="hljs-variable inline">username</span> <span class="hljs-operator inline">=</span> authentication.getName();
                log.debug(<span class="hljs-string inline">&quot;表单登出成功: {}&quot;</span>, username);
            }
            <span class="hljs-comment inline">// 注意：这里不调用endpointMetrics.userLoggedOut()</span>
            <span class="hljs-comment inline">// 因为@EventListener已经处理了统计</span>
        };
    }
}
</code></pre>
            </div>
        
<h3 id="sessioneventlistener：会话生命周期的兜底机制" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#sessioneventlistener：会话生命周期的兜底机制" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to SessionEventListener：会话生命周期的兜底机制">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            SessionEventListener：会话生命周期的兜底机制
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40Component%0A%40Slf4j%0A%40RequiredArgsConstructor%0Apublic%20class%20SessionEventListener%20implements%20HttpSessionListener%20%7B%0Aprivate%20final%20EndpointMetrics%20endpointMetrics%3B%0A%2F**%0A*%20%E4%BC%9A%E8%AF%9D%E9%94%80%E6%AF%81%E7%9B%91%E5%90%AC%EF%BC%9A%E5%A4%84%E7%90%86%22%E9%9D%99%E9%BB%98%E7%A6%BB%E5%BC%80%22%E7%9A%84%E7%94%A8%E6%88%B7%0A*%0A*%20%E4%BC%9A%E8%AF%9D%E9%94%80%E6%AF%81%E7%9A%84%E8%A7%A6%E5%8F%91%E5%9C%BA%E6%99%AF%EF%BC%9A%0A*%201.%20%E4%BC%9A%E8%AF%9D%E8%B6%85%E6%97%B6%EF%BC%88%E6%9C%80%E5%B8%B8%E8%A7%81%EF%BC%89%0A*%202.%20%E7%94%A8%E6%88%B7%E4%B8%BB%E5%8A%A8%E5%85%B3%E9%97%AD%E6%B5%8F%E8%A7%88%E5%99%A8%0A*%203.%20%E8%B0%83%E7%94%A8session.invalidate()%0A*%204.%20%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%85%B3%E9%97%AD%0A*%2F%0A%40Override%0Apublic%20void%20sessionDestroyed(HttpSessionEvent%20se)%20%7B%0AString%20sessionId%20%3D%20se.getSession().getId()%3B%0Alog.debug(%22%E4%BC%9A%E8%AF%9D%E9%94%80%E6%AF%81%3A%20%7B%7D%22%2C%20sessionId)%3B%0A%2F%2F%20%E5%85%9C%E5%BA%95%E6%9C%BA%E5%88%B6%EF%BC%9A%E7%A1%AE%E4%BF%9D%E7%94%A8%E6%88%B7%E6%95%B0%E7%BB%9F%E8%AE%A1%E5%87%86%E7%A1%AE%0AendpointMetrics.userLoggedOut()%3B%0A%7D%0A%2F%2F%20%E6%B3%A8%E6%84%8F%EF%BC%9A%E8%BF%99%E9%87%8C%E6%B2%A1%E6%9C%89%E5%AE%9E%E7%8E%B0sessionCreated%E6%96%B9%E6%B3%95%0A%2F%2F%20%E5%9B%A0%E4%B8%BAsession%E5%88%9B%E5%BB%BA%E4%B8%8D%E7%AD%89%E4%BA%8E%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%0A%2F%2F%20%E5%8C%BF%E5%90%8D%E7%94%A8%E6%88%B7%E4%B9%9F%E4%BC%9A%E5%88%9B%E5%BB%BAsession%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@Component</span>
<span class="hljs-meta inline">@Slf4j</span>
<span class="hljs-meta inline">@RequiredArgsConstructor</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">SessionEventListener</span> <span class="hljs-keyword inline">implements</span> <span class="hljs-title class_ inline">HttpSessionListener</span> {

    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> EndpointMetrics endpointMetrics;

    <span class="hljs-comment inline">/**
     * 会话销毁监听：处理&quot;静默离开&quot;的用户
     * 
     * 会话销毁的触发场景：
     * 1. 会话超时（最常见）
     * 2. 用户主动关闭浏览器
     * 3. 调用session.invalidate()
     * 4. 应用服务器关闭
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">sessionDestroyed</span><span class="hljs-params inline">(HttpSessionEvent se)</span> {
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">sessionId</span> <span class="hljs-operator inline">=</span> se.getSession().getId();
        log.debug(<span class="hljs-string inline">&quot;会话销毁: {}&quot;</span>, sessionId);
        
        <span class="hljs-comment inline">// 兜底机制：确保用户数统计准确</span>
        endpointMetrics.userLoggedOut();
    }

    <span class="hljs-comment inline">// 注意：这里没有实现sessionCreated方法</span>
    <span class="hljs-comment inline">// 因为session创建不等于用户登录</span>
    <span class="hljs-comment inline">// 匿名用户也会创建session</span>
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">为什么需要SessionEventListener？</strong></p>
<p class="text-base leading-7 mb-4 text-foreground">Spring Security事件监听有一个盲区：用户&quot;静默离开&quot;。</p>
<table class="w-full border-collapse mb-4 shadow-sm rounded-lg overflow-hidden">
<thead class="bg-surface">
<tr class="border-b border-gray-200"><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">离开方式</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">Spring Security事件</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">Session事件</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">统计准确性</th></tr>
</thead>
<tbody class="bg-background divide-y divide-gray-200">
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">正常登出</td><td class="px-4 py-3 text-sm text-foreground">✅ LogoutSuccessEvent</td><td class="px-4 py-3 text-sm text-foreground">✅ sessionDestroyed</td><td class="px-4 py-3 text-sm text-foreground">✅ 双重保障</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">关闭浏览器</td><td class="px-4 py-3 text-sm text-foreground">❌ 无事件</td><td class="px-4 py-3 text-sm text-foreground">✅ sessionDestroyed (延迟)</td><td class="px-4 py-3 text-sm text-foreground">✅ 兜底机制</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">网络断开</td><td class="px-4 py-3 text-sm text-foreground">❌ 无事件</td><td class="px-4 py-3 text-sm text-foreground">✅ sessionDestroyed (延迟)</td><td class="px-4 py-3 text-sm text-foreground">✅ 兜底机制</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">会话超时</td><td class="px-4 py-3 text-sm text-foreground">❌ 无事件</td><td class="px-4 py-3 text-sm text-foreground">✅ sessionDestroyed</td><td class="px-4 py-3 text-sm text-foreground">✅ 兜底机制</td></tr>
</tbody>
</table>
<h2 id="prometheus篇：时序数据库" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#prometheus篇：时序数据库" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Prometheus篇：时序数据库">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Prometheus篇：时序数据库
        </h2>
<h3 id="为什么选择prometheus？" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#为什么选择prometheus？" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 为什么选择Prometheus？">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            为什么选择Prometheus？
        </h3>
<p class="text-base leading-7 mb-4 text-foreground">Prometheus不仅仅是一个监控系统，它更像是一个&quot;时间魔法师&quot;，能够将瞬息万变的系统状态记录成可查询、可分析的时序数据。</p>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Prometheus的核心优势</strong>：</p>
<ol class="list-decimal list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Pull模式的优雅性</strong>：</p>
<div class="mermaid block" id="mermaid-1767525094481-2m7irsa">graph LR
    A[Prometheus Server] -->|Pull每15秒| B[ACOT应用1:8080/actuator/prometheus]
    A -->|Pull每15秒| C[ACOT应用2:8081/actuator/prometheus]
    A -->|Pull每15秒| D[其他服务:9090/metrics]</div></li>
<li class="text-foreground leading-relaxed"><p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">多维度标签系统</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="promql" data-code="%23%20%E6%9F%A5%E8%AF%A2%E7%89%B9%E5%AE%9A%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%0Aacot_endpoint_calls_total%7Bcontroller%3D%22UserController%22%7D%0A%23%20%E6%9F%A5%E8%AF%A2%E7%89%B9%E5%AE%9A%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%0Aacot_endpoint_calls_total%7Bmethod%3D%22getUserInfo%22%7D%0A%23%20%E6%9F%A5%E8%AF%A2%E7%89%B9%E5%AE%9A%E6%8E%A7%E5%88%B6%E5%99%A8%2B%E6%96%B9%E6%B3%95%E7%9A%84%E7%BB%84%E5%90%88%0Aacot_endpoint_calls_total%7Bcontroller%3D%22UserController%22%2C%20method%3D%22getUserInfo%22%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">promql</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-promql"><span class="hljs-comment inline"># 查询特定控制器的调用次数</span>
acot_endpoint_calls_total{<span class="hljs-attribute inline">controller</span>=<span class="hljs-string inline">&quot;UserController&quot;</span>}

<span class="hljs-comment inline"># 查询特定方法的调用次数</span>
acot_endpoint_calls_total{<span class="hljs-attribute inline">method</span>=<span class="hljs-string inline">&quot;getUserInfo&quot;</span>}

<span class="hljs-comment inline"># 查询特定控制器+方法的组合</span>
acot_endpoint_calls_total{<span class="hljs-attribute inline">controller</span>=<span class="hljs-string inline">&quot;UserController&quot;</span>, <span class="hljs-attribute inline">method</span>=<span class="hljs-string inline">&quot;getUserInfo&quot;</span>}
</code></pre>
            </div>
        </li>
<li class="text-foreground leading-relaxed"><p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">强大的查询语言PromQL</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="promql" data-code="%23%20%E6%9F%A5%E8%AF%A2%E8%BF%87%E5%8E%BB5%E5%88%86%E9%92%9F%E7%9A%84%E5%B9%B3%E5%9D%87%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0Aavg_over_time(acot_online_users%5B5m%5D)%0A%23%20%E6%9F%A5%E8%AF%A2API%E8%B0%83%E7%94%A8%E5%A2%9E%E9%95%BF%E7%8E%87%0Arate(acot_endpoint_calls_total%5B5m%5D)%0A%23%20%E6%9F%A5%E8%AF%A2%E6%9C%80%E7%B9%81%E5%BF%99%E7%9A%84%E7%AB%AF%E7%82%B9%0Atopk(10%2C%20rate(acot_endpoint_calls_total%5B1h%5D))">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">promql</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-promql"><span class="hljs-comment inline"># 查询过去5分钟的平均在线用户数</span>
<span class="hljs-attribute inline">avg_over_time</span>(acot_online_users[<span class="hljs-number inline">5</span>m])

<span class="hljs-comment inline"># 查询API调用增长率</span>
<span class="hljs-attribute inline">rate</span>(acot_endpoint_calls_total[<span class="hljs-number inline">5</span>m])

<span class="hljs-comment inline"># 查询最繁忙的端点</span>
<span class="hljs-attribute inline">topk</span>(<span class="hljs-number inline">10</span>, rate(acot_endpoint_calls_total[<span class="hljs-number inline">1</span>h]))
</code></pre>
            </div>
        </li>
</ol>
<h3 id="时序数据模型：时间戳设计根本" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#时序数据模型：时间戳设计根本" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 时序数据模型：时间戳设计根本">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            时序数据模型：时间戳设计根本
        </h3>
<p class="text-base leading-7 mb-4 text-foreground">Prometheus的数据模型可以用数学公式表示：</p>
<p class="text-base leading-7 mb-4 text-foreground"><span class="katex-display inline"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>M</mi><mi>e</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>c</mi><mo>=</mo><mi>M</mi><mi>e</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>N</mi><mi>a</mi><mi>m</mi><mi>e</mi><mo stretchy="false">{</mo><mi>l</mi><mi>a</mi><mi>b</mi><mi>e</mi><msub><mi>l</mi><mn>1</mn></msub><mo>=</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><msub><mi>e</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>l</mi><mi>a</mi><mi>b</mi><mi>e</mi><msub><mi>l</mi><mn>2</mn></msub><mo>=</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><msub><mi>e</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo stretchy="false">}</mo><mo>→</mo><mo stretchy="false">(</mo><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>m</mi><mi>p</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Metric = MetricName\{label_1=value_1, label_2=value_2, ...\} \rightarrow (timestamp, value)</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.6833em;"></span><span class="mord mathnormal inline" style="margin-right:0.10903em;">M</span><span class="mord mathnormal inline">e</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline" style="margin-right:0.02778em;">r</span><span class="mord mathnormal inline">i</span><span class="mord mathnormal inline">c</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.10903em;">M</span><span class="mord mathnormal inline">e</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline" style="margin-right:0.02778em;">r</span><span class="mord mathnormal inline">i</span><span class="mord mathnormal inline">c</span><span class="mord mathnormal inline" style="margin-right:0.10903em;">N</span><span class="mord mathnormal inline">am</span><span class="mord mathnormal inline">e</span><span class="mopen inline">{</span><span class="mord mathnormal inline" style="margin-right:0.01968em;">l</span><span class="mord mathnormal inline">ab</span><span class="mord mathnormal inline">e</span><span class="mord inline"><span class="mord mathnormal inline" style="margin-right:0.01968em;">l</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">1</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal inline" style="margin-right:0.03588em;">v</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline" style="margin-right:0.01968em;">l</span><span class="mord mathnormal inline">u</span><span class="mord inline"><span class="mord mathnormal inline">e</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">1</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline" style="margin-right:0.01968em;">l</span><span class="mord mathnormal inline">ab</span><span class="mord mathnormal inline">e</span><span class="mord inline"><span class="mord mathnormal inline" style="margin-right:0.01968em;">l</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">2</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.03588em;">v</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline" style="margin-right:0.01968em;">l</span><span class="mord mathnormal inline">u</span><span class="mord inline"><span class="mord mathnormal inline">e</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">2</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord inline">...</span><span class="mclose inline">}</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">→</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen inline">(</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">im</span><span class="mord mathnormal inline">es</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">am</span><span class="mord mathnormal inline">p</span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline" style="margin-right:0.03588em;">v</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline" style="margin-right:0.01968em;">l</span><span class="mord mathnormal inline">u</span><span class="mord mathnormal inline">e</span><span class="mclose inline">)</span></span></span></span></span></p>
<p class="text-base leading-7 mb-4 text-foreground">例如：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="" data-code="acot_endpoint_calls_total%7Bcontroller%3D%22UserController%22%2C%20method%3D%22getUserInfo%22%7D%2042%20%401234567890">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">code</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code>acot_endpoint_calls_total{<span class="hljs-attribute inline">controller</span>=<span class="hljs-string inline">&quot;UserController&quot;</span>, <span class="hljs-attribute inline">method</span>=<span class="hljs-string inline">&quot;getUserInfo&quot;</span>} 42 @1234567890
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">数据类型的选择策略</strong>：</p>
<table class="w-full border-collapse mb-4 shadow-sm rounded-lg overflow-hidden">
<thead class="bg-surface">
<tr class="border-b border-gray-200"><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">指标类型</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">适用场景</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">ACOT中的应用</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">数学特性</th></tr>
</thead>
<tbody class="bg-background divide-y divide-gray-200">
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Counter</td><td class="px-4 py-3 text-sm text-foreground">单调递增</td><td class="px-4 py-3 text-sm text-foreground">API调用次数</td><td class="px-4 py-3 text-sm text-foreground"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msub><mi>t</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>≥</mo><mi>f</mi><mo stretchy="false">(</mo><msub><mi>t</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(t_2) \geq f(t_1)</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.10764em;">f</span><span class="mopen inline">(</span><span class="mord inline"><span class="mord mathnormal inline">t</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">2</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mclose inline">)</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">≥</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.10764em;">f</span><span class="mopen inline">(</span><span class="mord inline"><span class="mord mathnormal inline">t</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">1</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mclose inline">)</span></span></span></span> 当 <span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mn>2</mn></msub><mo>&gt;</mo><msub><mi>t</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">t_2 &gt; t_1</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord inline"><span class="mord mathnormal inline">t</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">2</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">&gt;</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord inline"><span class="mord mathnormal inline">t</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">1</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span></span></span></span></td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Gauge</td><td class="px-4 py-3 text-sm text-foreground">瞬时值</td><td class="px-4 py-3 text-sm text-foreground">在线用户数</td><td class="px-4 py-3 text-sm text-foreground"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(t)</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.10764em;">f</span><span class="mopen inline">(</span><span class="mord mathnormal inline">t</span><span class="mclose inline">)</span></span></span></span> 可任意变化</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Histogram</td><td class="px-4 py-3 text-sm text-foreground">分布统计</td><td class="px-4 py-3 text-sm text-foreground">响应时间分布</td><td class="px-4 py-3 text-sm text-foreground"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><mi>b</mi><mi>u</mi><mi>c</mi><mi>k</mi><mi>e</mi><msub><mi>t</mi><mi>i</mi></msub><mo>=</mo><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">\sum_{i=1}^{n} bucket_i = total</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mop inline"><span class="mop op-symbol small-op inline" style="position:relative;top:0em;">∑</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline"><span class="mord mathnormal mtight inline">i</span><span class="mrel mtight inline">=</span><span class="mord mtight inline">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline"><span class="mord mathnormal mtight inline">n</span></span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.2997em;"><span class="inline"></span></span></span></span></span></span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline">b</span><span class="mord mathnormal inline">u</span><span class="mord mathnormal inline">c</span><span class="mord mathnormal inline" style="margin-right:0.03148em;">k</span><span class="mord mathnormal inline">e</span><span class="mord inline"><span class="mord mathnormal inline">t</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mathnormal mtight inline">i</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.6944em;"></span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline" style="margin-right:0.01968em;">l</span></span></span></span></td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Summary</td><td class="px-4 py-3 text-sm text-foreground">分位数统计</td><td class="px-4 py-3 text-sm text-foreground">响应时间百分位</td><td class="px-4 py-3 text-sm text-foreground"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mn>50</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>90</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>99</mn></msub></mrow><annotation encoding="application/x-tex">P_{50}, P_{90}, P_{99}</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord inline"><span class="mord mathnormal inline" style="margin-right:0.13889em;">P</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline"><span class="mord mtight inline">50</span></span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord inline"><span class="mord mathnormal inline" style="margin-right:0.13889em;">P</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline"><span class="mord mtight inline">90</span></span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord inline"><span class="mord mathnormal inline" style="margin-right:0.13889em;">P</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline"><span class="mord mtight inline">99</span></span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span></span></span></span></td></tr>
</tbody>
</table>
<h3 id="spring-boot与prometheus的集成" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#spring-boot与prometheus的集成" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Spring Boot与Prometheus的集成">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Spring Boot与Prometheus的集成
        </h3>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Maven依赖配置</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="xml" data-code="dependency%3E%0AgroupId%3Eorg.springframework.bootgroupId%3E%0AartifactId%3Espring-boot-starter-actuatorartifactId%3E%0Adependency%3E%0Adependency%3E%0AgroupId%3Eio.micrometergroupId%3E%0AartifactId%3Emicrometer-registry-prometheusartifactId%3E%0Adependency%3E%0Adependency%3E%0AgroupId%3Eorg.springframework.bootgroupId%3E%0AartifactId%3Espring-boot-starter-aopartifactId%3E%0Adependency%3E">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">xml</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-xml"><span class="hljs-comment inline">&lt;!-- Spring Boot Actuator：生产级别的应用监控 --&gt;</span>
<span class="hljs-tag inline">&lt;<span class="hljs-name inline">dependency</span>&gt;</span>
    <span class="hljs-tag inline">&lt;<span class="hljs-name inline">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag inline">&lt;/<span class="hljs-name inline">groupId</span>&gt;</span>
    <span class="hljs-tag inline">&lt;<span class="hljs-name inline">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag inline">&lt;/<span class="hljs-name inline">artifactId</span>&gt;</span>
<span class="hljs-tag inline">&lt;/<span class="hljs-name inline">dependency</span>&gt;</span>

<span class="hljs-comment inline">&lt;!-- Micrometer Prometheus：度量指标的Prometheus导出器 --&gt;</span>
<span class="hljs-tag inline">&lt;<span class="hljs-name inline">dependency</span>&gt;</span>
    <span class="hljs-tag inline">&lt;<span class="hljs-name inline">groupId</span>&gt;</span>io.micrometer<span class="hljs-tag inline">&lt;/<span class="hljs-name inline">groupId</span>&gt;</span>
    <span class="hljs-tag inline">&lt;<span class="hljs-name inline">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="hljs-tag inline">&lt;/<span class="hljs-name inline">artifactId</span>&gt;</span>
<span class="hljs-tag inline">&lt;/<span class="hljs-name inline">dependency</span>&gt;</span>

<span class="hljs-comment inline">&lt;!-- Spring AOP：切面编程支持 --&gt;</span>
<span class="hljs-tag inline">&lt;<span class="hljs-name inline">dependency</span>&gt;</span>
    <span class="hljs-tag inline">&lt;<span class="hljs-name inline">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag inline">&lt;/<span class="hljs-name inline">groupId</span>&gt;</span>
    <span class="hljs-tag inline">&lt;<span class="hljs-name inline">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag inline">&lt;/<span class="hljs-name inline">artifactId</span>&gt;</span>
<span class="hljs-tag inline">&lt;/<span class="hljs-name inline">dependency</span>&gt;</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">application.yaml配置</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="yaml" data-code="management%3A%0Aendpoints%3A%0Aweb%3A%0Aexposure%3A%0A%23%20%E5%AE%89%E5%85%A8%E8%80%83%E8%99%91%EF%BC%9A%E5%8F%AA%E6%9A%B4%E9%9C%B2%E5%BF%85%E8%A6%81%E7%9A%84%E7%AB%AF%E7%82%B9%0Ainclude%3A%20%22health%2Cinfo%2Cmetrics%2Cprometheus%2Cenv%2Cthreaddump%2Cloggers%22%0Abase-path%3A%20%2Factuator%0Acors%3A%0A%23%20%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%EF%BC%8C%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%9C%80%E8%A6%81%E9%99%90%E5%88%B6%0Aallowed-origins%3A%20%22*%22%0Aallowed-methods%3A%20GET%2CPOST%2CPUT%2CDELETE%2COPTIONS%2CHEAD%0Aallowed-headers%3A%20%22*%22%0Aendpoint%3A%0Aprometheus%3A%0A%23%20%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%BB%BA%E8%AE%AE%E8%AE%BE%E7%BD%AE%E4%B8%BA%20%22when_authorized%22%0Aaccess%3A%20unrestricted%0Ametrics%3A%0Aaccess%3A%20unrestricted%0Ametrics%3A%0Adistribution%3A%0Apercentiles-histogram%3A%0A%23%20%E5%90%AF%E7%94%A8HTTP%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%E7%9A%84%E7%9B%B4%E6%96%B9%E5%9B%BE%E7%BB%9F%E8%AE%A1%0Ahttp.server.requests%3A%20true%0Atags%3A%0A%23%20%E4%B8%BA%E6%89%80%E6%9C%89%E6%8C%87%E6%A0%87%E6%B7%BB%E5%8A%A0%E5%BA%94%E7%94%A8%E6%A0%87%E8%AF%86%E6%A0%87%E7%AD%BE%0Aapplication%3A%20%24%7Bspring.application.name%7D%0Aprometheus%3A%0Ametrics%3A%0Aexport%3A%0Aenabled%3A%20true%0A%23%20%E5%8F%AF%E9%85%8D%E7%BD%AE%E6%8E%A8%E9%80%81%E9%97%B4%E9%9A%94%EF%BC%8C%E9%BB%98%E8%AE%A4%E4%B8%BA%E6%8B%89%E5%8F%96%E6%A8%A1%E5%BC%8F%E4%B8%8D%E9%9C%80%E8%A6%81%0A%23%20step%3A%2015s%0Ahealth%3A%0Adiskspace%3A%0Aenabled%3A%20true%0Adb%3A%0Aenabled%3A%20true%0A%23%20%E5%BC%80%E5%90%AF%E8%B0%83%E8%AF%95%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B%E6%8C%87%E6%A0%87%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B%0Alogging%3A%0Alevel%3A%0Acom.chat.allchatonthis.config.metrics%3A%20debug">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">yaml</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-yaml"><span class="hljs-attr inline">management:</span>
  <span class="hljs-attr inline">endpoints:</span>
    <span class="hljs-attr inline">web:</span>
      <span class="hljs-attr inline">exposure:</span>
        <span class="hljs-comment inline"># 安全考虑：只暴露必要的端点</span>
        <span class="hljs-attr inline">include:</span> <span class="hljs-string inline">&quot;health,info,metrics,prometheus,env,threaddump,loggers&quot;</span>
        <span class="hljs-attr inline">base-path:</span> <span class="hljs-string inline">/actuator</span>
      <span class="hljs-attr inline">cors:</span>
        <span class="hljs-comment inline"># 开发环境配置，生产环境需要限制</span>
        <span class="hljs-attr inline">allowed-origins:</span> <span class="hljs-string inline">&quot;*&quot;</span>
        <span class="hljs-attr inline">allowed-methods:</span> <span class="hljs-string inline">GET,POST,PUT,DELETE,OPTIONS,HEAD</span>
        <span class="hljs-attr inline">allowed-headers:</span> <span class="hljs-string inline">&quot;*&quot;</span>
  
  <span class="hljs-attr inline">endpoint:</span>
    <span class="hljs-attr inline">prometheus:</span>
      <span class="hljs-comment inline"># 生产环境建议设置为 &quot;when_authorized&quot;</span>
      <span class="hljs-attr inline">access:</span> <span class="hljs-string inline">unrestricted</span>
    <span class="hljs-attr inline">metrics:</span>
      <span class="hljs-attr inline">access:</span> <span class="hljs-string inline">unrestricted</span>
  
  <span class="hljs-attr inline">metrics:</span>
    <span class="hljs-attr inline">distribution:</span>
      <span class="hljs-attr inline">percentiles-histogram:</span>
        <span class="hljs-comment inline"># 启用HTTP请求响应时间的直方图统计</span>
        <span class="hljs-attr inline">http.server.requests:</span> <span class="hljs-literal inline">true</span>
    <span class="hljs-attr inline">tags:</span>
      <span class="hljs-comment inline"># 为所有指标添加应用标识标签</span>
      <span class="hljs-attr inline">application:</span> <span class="hljs-string inline">${spring.application.name}</span>
    
  <span class="hljs-attr inline">prometheus:</span>
    <span class="hljs-attr inline">metrics:</span>
      <span class="hljs-attr inline">export:</span>
        <span class="hljs-attr inline">enabled:</span> <span class="hljs-literal inline">true</span>
        <span class="hljs-comment inline"># 可配置推送间隔，默认为拉取模式不需要</span>
        <span class="hljs-comment inline"># step: 15s</span>
  
  <span class="hljs-attr inline">health:</span>
    <span class="hljs-attr inline">diskspace:</span>
      <span class="hljs-attr inline">enabled:</span> <span class="hljs-literal inline">true</span>
    <span class="hljs-attr inline">db:</span>
      <span class="hljs-attr inline">enabled:</span> <span class="hljs-literal inline">true</span>

<span class="hljs-comment inline"># 开启调试日志查看指标注册过程</span>
<span class="hljs-attr inline">logging:</span>
  <span class="hljs-attr inline">level:</span>
    <span class="hljs-attr inline">com.chat.allchatonthis.config.metrics:</span> <span class="hljs-string inline">debug</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Prometheus配置示例</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="yaml" data-code="%23%20prometheus.yml%0Aglobal%3A%0Ascrape_interval%3A%2015s%0Aevaluation_interval%3A%2015s%0Ascrape_configs%3A%0A-%20job_name%3A%20'acot-backend'%0Ametrics_path%3A%20'%2Factuator%2Fprometheus'%0Astatic_configs%3A%0A-%20targets%3A%20%5B'localhost%3A8080'%5D%0Ascrape_interval%3A%2010s%0Ascrape_timeout%3A%205s">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">yaml</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-yaml"><span class="hljs-comment inline"># prometheus.yml</span>
<span class="hljs-attr inline">global:</span>
  <span class="hljs-attr inline">scrape_interval:</span> <span class="hljs-string inline">15s</span>
  <span class="hljs-attr inline">evaluation_interval:</span> <span class="hljs-string inline">15s</span>

<span class="hljs-attr inline">scrape_configs:</span>
  <span class="hljs-bullet inline">-</span> <span class="hljs-attr inline">job_name:</span> <span class="hljs-string inline">&#x27;acot-backend&#x27;</span>
    <span class="hljs-attr inline">metrics_path:</span> <span class="hljs-string inline">&#x27;/actuator/prometheus&#x27;</span>
    <span class="hljs-attr inline">static_configs:</span>
      <span class="hljs-bullet inline">-</span> <span class="hljs-attr inline">targets:</span> [<span class="hljs-string inline">&#x27;localhost:8080&#x27;</span>]
    <span class="hljs-attr inline">scrape_interval:</span> <span class="hljs-string inline">10s</span>
    <span class="hljs-attr inline">scrape_timeout:</span> <span class="hljs-string inline">5s</span>
</code></pre>
            </div>
        
<h2 id="grafana篇：数据可视化" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#grafana篇：数据可视化" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Grafana篇：数据可视化">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Grafana篇：数据可视化
        </h2>
<h3 id="grafana的核心价值" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#grafana的核心价值" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Grafana的核心价值">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Grafana的核心价值
        </h3>
<p class="text-base leading-7 mb-4 text-foreground">如果说Prometheus是&quot;数据收集家&quot;，那么Grafana就是&quot;数据艺术家&quot;。它能够将冰冷的数字转化为直观的图表，让监控数据&quot;开口说话&quot;。</p>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">ACOT监控仪表板的构建思路</strong>：</p>
<div class="mermaid block" id="mermaid-1767525094481-3dkh331">graph TB
    subgraph "ACOT Grafana仪表板"
        A[系统概览面板] --> A1[在线用户数实时曲线]
        A --> A2[总API调用次数]
        A --> A3[系统健康状态]
        
        B[API调用统计面板] --> B1[热门API排行榜]
        B --> B2[API调用趋势图]
        B --> B3[错误率统计]
        
        C[用户活动面板] --> C1[用户登录/登出趋势]
        C --> C2[用户活跃时段分析]
        C --> C3[会话持续时间分布]
        
        D[性能指标面板] --> D1[响应时间分布]
        D --> D2[JVM内存使用情况]
        D --> D3[数据库连接池状态]
        
        E[告警状态面板]
    end</div>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">关键PromQL查询语句</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="promql" data-code="%23%201.%20%E5%BD%93%E5%89%8D%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0Aacot_online_users%0A%23%202.%20API%E8%B0%83%E7%94%A8%E9%80%9F%E7%8E%87%20(%E6%AF%8F%E7%A7%92)%0Arate(acot_endpoint_calls_total%5B5m%5D)%0A%23%203.%20%E6%9C%80%E5%8F%97%E6%AC%A2%E8%BF%8E%E7%9A%84API%E7%AB%AF%E7%82%B9%20(Top%2010)%0Atopk(10%2C%20increase(acot_endpoint_calls_total%5B1h%5D))%0A%23%204.%20%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E9%80%9F%E7%8E%87%0Arate(acot_online_users%5B5m%5D)%20%3E%200%0A%23%205.%20%E7%B3%BB%E7%BB%9F%E5%B9%B3%E5%9D%87%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%0Arate(http_server_requests_seconds_sum%5B5m%5D)%20%2F%20rate(http_server_requests_seconds_count%5B5m%5D)%0A%23%206.%20%E9%94%99%E8%AF%AF%E7%8E%87%E7%BB%9F%E8%AE%A1%0Arate(http_server_requests_seconds_count%7Bstatus%3D~%224..%7C5..%22%7D%5B5m%5D)%20%2F%0Arate(http_server_requests_seconds_count%5B5m%5D)%20*%20100">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">promql</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-promql"><span class="hljs-comment inline"># 1. 当前在线用户数</span>
<span class="hljs-attribute inline">acot_online_users</span>

<span class="hljs-comment inline"># 2. API调用速率 (每秒)</span>
<span class="hljs-attribute inline">rate</span>(acot_endpoint_calls_total[<span class="hljs-number inline">5</span>m])

<span class="hljs-comment inline"># 3. 最受欢迎的API端点 (Top 10)</span>
<span class="hljs-attribute inline">topk</span>(<span class="hljs-number inline">10</span>, increase(acot_endpoint_calls_total[<span class="hljs-number inline">1</span>h]))

<span class="hljs-comment inline"># 4. 用户登录速率</span>
<span class="hljs-attribute inline">rate</span>(acot_online_users[<span class="hljs-number inline">5</span>m]) &gt; <span class="hljs-number inline">0</span>

<span class="hljs-comment inline"># 5. 系统平均响应时间</span>
<span class="hljs-attribute inline">rate</span>(http_server_requests_seconds_sum[<span class="hljs-number inline">5</span>m]) / rate(http_server_requests_seconds_count[<span class="hljs-number inline">5</span>m])

<span class="hljs-comment inline"># 6. 错误率统计</span>
<span class="hljs-attribute inline">rate</span>(http_server_requests_seconds_count{status=~<span class="hljs-string inline">&quot;4..|5..&quot;</span>}[<span class="hljs-number inline">5</span>m]) / 
<span class="hljs-attribute inline">rate</span>(http_server_requests_seconds_count[<span class="hljs-number inline">5</span>m]) * <span class="hljs-number inline">100</span>
</code></pre>
            </div>
        
<h2 id="代码深度解析篇：逐行剖析监控的实现细节" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#代码深度解析篇：逐行剖析监控的实现细节" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 代码深度解析篇：逐行剖析监控的实现细节">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            代码深度解析篇：逐行剖析监控的实现细节
        </h2>
<h3 id="metricscontroller：监控数据的http暴露接口" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#metricscontroller：监控数据的http暴露接口" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to MetricsController：监控数据的HTTP暴露接口">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            MetricsController：监控数据的HTTP暴露接口
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40RestController%0A%40RequestMapping(%22%2Fmetrics%22)%0A%40RequiredArgsConstructor%0A%40Slf4j%0Apublic%20class%20MetricsController%20%7B%0Aprivate%20final%20MeterRegistry%20meterRegistry%3B%0A%2F**%0A*%20%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0A*%0A*%20%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9A%0A*%201.%20%E9%80%9A%E8%BF%87MeterRegistry%E6%9F%A5%E6%89%BE%E5%90%8D%E4%B8%BA%22acot.online.users%22%E7%9A%84Gauge%0A*%202.%20%E8%B0%83%E7%94%A8gauge().value()%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%9E%AC%E6%97%B6%E5%80%BC%0A*%203.%20%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%95%B4%E6%95%B0%E8%BF%94%E5%9B%9E%0A*%2F%0A%40GetMapping(%22%2Fonline-users%22)%0Apublic%20CommonResult%20getOnlineUsers()%20%7B%0A%2F%2F%20MeterRegistry.get()%E6%96%B9%E6%B3%95%E7%9A%84%E6%9F%A5%E6%89%BE%E9%93%BE%EF%BC%9A%0A%2F%2F%201.%20%E6%8C%89%E5%90%8D%E7%A7%B0%E6%9F%A5%E6%89%BE%E5%B7%B2%E6%B3%A8%E5%86%8C%E7%9A%84Meter%0A%2F%2F%202.%20%E8%BF%94%E5%9B%9E%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8C%B9%E9%85%8D%E7%9A%84Meter%0A%2F%2F%203.%20%E5%A6%82%E6%9E%9C%E6%89%BE%E4%B8%8D%E5%88%B0%EF%BC%8C%E6%8A%9B%E5%87%BAMeterNotFoundException%0AInteger%20onlineUsers%20%3D%20(int)%20meterRegistry.get(%22acot.online.users%22).gauge().value()%3B%0Areturn%20CommonResult.success(onlineUsers)%3B%0A%7D%0A%2F**%0A*%20%E8%8E%B7%E5%8F%96%E7%AB%AF%E7%82%B9%E8%B0%83%E7%94%A8%E7%BB%9F%E8%AE%A1%0A*%0A*%20%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E5%B1%95%E7%A4%BA%E4%BA%86Micrometer%20Search%20API%E7%9A%84%E5%BC%BA%E5%A4%A7%E5%8A%9F%E8%83%BD%0A*%2F%0A%40GetMapping(%22%2Fendpoints%22)%0Apublic%20CommonResult%3E%20getEndpointStats()%20%7B%0AMap%20stats%20%3D%20new%20HashMap()%3B%0A%2F%2F%20Micrometer%20Search%20API%E7%9A%84%E6%B5%81%E5%BC%8F%E6%9F%A5%E8%AF%A2%0ASearch.in(meterRegistry)%0A.name(%22acot.endpoint.calls%22)%20%20%2F%2F%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E6%8C%89%E5%90%8D%E7%A7%B0%E8%BF%87%E6%BB%A4%0A.counters()%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E5%8F%AA%E4%BF%9D%E7%95%99Counter%E7%B1%BB%E5%9E%8B%0A.forEach(counter%20-%3E%20%7B%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E9%81%8D%E5%8E%86%E6%89%80%E6%9C%89%E5%8C%B9%E9%85%8D%E7%9A%84Counter%0A%2F%2F%20%E6%8F%90%E5%8F%96Counter%E7%9A%84%E6%A0%87%E7%AD%BE%E4%BF%A1%E6%81%AF%0AIterable%20tags%20%3D%20counter.getId().getTags()%3B%0AString%20controller%20%3D%20%22%22%3B%0AString%20method%20%3D%20%22%22%3B%0A%2F%2F%20%E9%81%8D%E5%8E%86%E6%A0%87%E7%AD%BE%EF%BC%8C%E6%8F%90%E5%8F%96controller%E5%92%8Cmethod%E4%BF%A1%E6%81%AF%0Afor%20(Tag%20tag%20%3A%20tags)%20%7B%0Aif%20(%22controller%22.equals(tag.getKey()))%20%7B%0Acontroller%20%3D%20tag.getValue()%3B%0A%7D%20else%20if%20(%22method%22.equals(tag.getKey()))%20%7B%0Amethod%20%3D%20tag.getValue()%3B%0A%7D%0A%7D%0A%2F%2F%20%E6%9E%84%E9%80%A0%E7%AB%AF%E7%82%B9%E6%A0%87%E8%AF%86%E5%B9%B6%E8%AE%B0%E5%BD%95%E8%AE%A1%E6%95%B0%E5%80%BC%0AString%20endpoint%20%3D%20controller%20%2B%20%22.%22%20%2B%20method%3B%0Astats.put(endpoint%2C%20(int)%20counter.count())%3B%0A%7D)%3B%0Areturn%20CommonResult.success(stats)%3B%0A%7D%0A%2F**%0A*%20%E8%8E%B7%E5%8F%96%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E6%91%98%E8%A6%81%0A*%0A*%20%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E5%B1%95%E7%A4%BA%E4%BA%86%E5%A6%82%E4%BD%95%E8%81%9A%E5%90%88%E5%A4%9A%E4%B8%AA%E6%8C%87%E6%A0%87%0A*%2F%0A%40GetMapping(%22%2Fsummary%22)%0Apublic%20CommonResult%3E%20getMetricsSummary()%20%7B%0AMap%20summary%20%3D%20new%20HashMap()%3B%0A%2F%2F%20%E8%8E%B7%E5%8F%96%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0AInteger%20onlineUsers%20%3D%20(int)%20meterRegistry.get(%22acot.online.users%22).gauge().value()%3B%0Asummary.put(%22onlineUsers%22%2C%20onlineUsers)%3B%0A%2F%2F%20%E8%AE%A1%E7%AE%97%E6%80%BBAPI%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%EF%BC%88%E6%89%80%E6%9C%89%E7%AB%AF%E7%82%B9%E8%AE%A1%E6%95%B0%E5%99%A8%E7%9A%84%E6%80%BB%E5%92%8C%EF%BC%89%0Adouble%20totalApiCalls%20%3D%20Search.in(meterRegistry)%0A.name(%22acot.endpoint.calls%22)%0A.counters()%0A.stream()%0A.mapToDouble(counter%20-%3E%20counter.count())%20%20%2F%2F%20%E6%8F%90%E5%8F%96%E6%AF%8F%E4%B8%AA%E8%AE%A1%E6%95%B0%E5%99%A8%E7%9A%84%E5%80%BC%0A.sum()%3B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%B1%82%E5%92%8C%0Asummary.put(%22totalApiCalls%22%2C%20(int)%20totalApiCalls)%3B%0Areturn%20CommonResult.success(summary)%3B%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@RestController</span>
<span class="hljs-meta inline">@RequestMapping(&quot;/metrics&quot;)</span>
<span class="hljs-meta inline">@RequiredArgsConstructor</span>
<span class="hljs-meta inline">@Slf4j</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">MetricsController</span> {

    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> MeterRegistry meterRegistry;

    <span class="hljs-comment inline">/**
     * 获取当前在线用户数
     * 
     * 实现原理：
     * 1. 通过MeterRegistry查找名为&quot;acot.online.users&quot;的Gauge
     * 2. 调用gauge().value()获取当前瞬时值
     * 3. 转换为整数返回
     */</span>
    <span class="hljs-meta inline">@GetMapping(&quot;/online-users&quot;)</span>
    <span class="hljs-keyword inline">public</span> CommonResult&lt;Integer&gt; <span class="hljs-title function_ inline">getOnlineUsers</span><span class="hljs-params inline">()</span> {
        <span class="hljs-comment inline">// MeterRegistry.get()方法的查找链：</span>
        <span class="hljs-comment inline">// 1. 按名称查找已注册的Meter</span>
        <span class="hljs-comment inline">// 2. 返回第一个匹配的Meter</span>
        <span class="hljs-comment inline">// 3. 如果找不到，抛出MeterNotFoundException</span>
        <span class="hljs-type inline">Integer</span> <span class="hljs-variable inline">onlineUsers</span> <span class="hljs-operator inline">=</span> (<span class="hljs-type inline">int</span>) meterRegistry.get(<span class="hljs-string inline">&quot;acot.online.users&quot;</span>).gauge().value();
        
        <span class="hljs-keyword inline">return</span> CommonResult.success(onlineUsers);
    }

    <span class="hljs-comment inline">/**
     * 获取端点调用统计
     * 
     * 这个方法展示了Micrometer Search API的强大功能
     */</span>
    <span class="hljs-meta inline">@GetMapping(&quot;/endpoints&quot;)</span>
    <span class="hljs-keyword inline">public</span> CommonResult&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_ inline">getEndpointStats</span><span class="hljs-params inline">()</span> {
        Map&lt;String, Object&gt; stats = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment inline">// Micrometer Search API的流式查询</span>
        Search.in(meterRegistry)
            .name(<span class="hljs-string inline">&quot;acot.endpoint.calls&quot;</span>)  <span class="hljs-comment inline">// 步骤1：按名称过滤</span>
            .counters()                   <span class="hljs-comment inline">// 步骤2：只保留Counter类型</span>
            .forEach(counter -&gt; {         <span class="hljs-comment inline">// 步骤3：遍历所有匹配的Counter</span>
                <span class="hljs-comment inline">// 提取Counter的标签信息</span>
                Iterable&lt;Tag&gt; tags = counter.getId().getTags();
                
                <span class="hljs-type inline">String</span> <span class="hljs-variable inline">controller</span> <span class="hljs-operator inline">=</span> <span class="hljs-string inline">&quot;&quot;</span>;
                <span class="hljs-type inline">String</span> <span class="hljs-variable inline">method</span> <span class="hljs-operator inline">=</span> <span class="hljs-string inline">&quot;&quot;</span>;
                
                <span class="hljs-comment inline">// 遍历标签，提取controller和method信息</span>
                <span class="hljs-keyword inline">for</span> (Tag tag : tags) {
                    <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;controller&quot;</span>.equals(tag.getKey())) {
                        controller = tag.getValue();
                    } <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;method&quot;</span>.equals(tag.getKey())) {
                        method = tag.getValue();
                    }
                }
                
                <span class="hljs-comment inline">// 构造端点标识并记录计数值</span>
                <span class="hljs-type inline">String</span> <span class="hljs-variable inline">endpoint</span> <span class="hljs-operator inline">=</span> controller + <span class="hljs-string inline">&quot;.&quot;</span> + method;
                stats.put(endpoint, (<span class="hljs-type inline">int</span>) counter.count());
            });
        
        <span class="hljs-keyword inline">return</span> CommonResult.success(stats);
    }

    <span class="hljs-comment inline">/**
     * 获取监控数据摘要
     * 
     * 这个方法展示了如何聚合多个指标
     */</span>
    <span class="hljs-meta inline">@GetMapping(&quot;/summary&quot;)</span>
    <span class="hljs-keyword inline">public</span> CommonResult&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_ inline">getMetricsSummary</span><span class="hljs-params inline">()</span> {
        Map&lt;String, Object&gt; summary = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment inline">// 获取在线用户数</span>
        <span class="hljs-type inline">Integer</span> <span class="hljs-variable inline">onlineUsers</span> <span class="hljs-operator inline">=</span> (<span class="hljs-type inline">int</span>) meterRegistry.get(<span class="hljs-string inline">&quot;acot.online.users&quot;</span>).gauge().value();
        summary.put(<span class="hljs-string inline">&quot;onlineUsers&quot;</span>, onlineUsers);
        
        <span class="hljs-comment inline">// 计算总API调用次数（所有端点计数器的总和）</span>
        <span class="hljs-type inline">double</span> <span class="hljs-variable inline">totalApiCalls</span> <span class="hljs-operator inline">=</span> Search.in(meterRegistry)
            .name(<span class="hljs-string inline">&quot;acot.endpoint.calls&quot;</span>)
            .counters()
            .stream()
            .mapToDouble(counter -&gt; counter.count())  <span class="hljs-comment inline">// 提取每个计数器的值</span>
            .sum();                                   <span class="hljs-comment inline">// 求和</span>
        summary.put(<span class="hljs-string inline">&quot;totalApiCalls&quot;</span>, (<span class="hljs-type inline">int</span>) totalApiCalls);
        
        <span class="hljs-keyword inline">return</span> CommonResult.success(summary);
    }
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">MeterRegistry的内部工作机制</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20MeterRegistry%E7%9A%84%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95%EF%BC%88%E7%AE%80%E5%8C%96%E7%89%88%EF%BC%89%0Apublic%20Meter%20get(String%20name)%20%7B%0Afor%20(Meter%20meter%20%3A%20this.meters)%20%7B%0Aif%20(meter.getId().getName().equals(name))%20%7B%0Areturn%20meter%3B%0A%7D%0A%7D%0Athrow%20new%20MeterNotFoundException(%22%E6%89%BE%E4%B8%8D%E5%88%B0%E5%90%8D%E4%B8%BA%20%22%20%2B%20name%20%2B%20%22%20%E7%9A%84%E6%8C%87%E6%A0%87%22)%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// MeterRegistry的查找算法（简化版）</span>
<span class="hljs-keyword inline">public</span> Meter <span class="hljs-title function_ inline">get</span><span class="hljs-params inline">(String name)</span> {
    <span class="hljs-keyword inline">for</span> (Meter meter : <span class="hljs-built_in inline">this</span>.meters) {
        <span class="hljs-keyword inline">if</span> (meter.getId().getName().equals(name)) {
            <span class="hljs-keyword inline">return</span> meter;
        }
    }
    <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">MeterNotFoundException</span>(<span class="hljs-string inline">&quot;找不到名为 &quot;</span> + name + <span class="hljs-string inline">&quot; 的指标&quot;</span>);
}
</code></pre>
            </div>
        
<h3 id="完整的指标数据流分析" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#完整的指标数据流分析" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 完整的指标数据流分析">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            完整的指标数据流分析
        </h3>
<div class="mermaid block" id="mermaid-1767525094481-2ydbibb">sequenceDiagram
    participant Client as 客户端
    participant Controller as RestController
    participant Aspect as EndpointMetricsAspect
    participant Metrics as EndpointMetrics
    participant Registry as MeterRegistry
    participant Prometheus as Prometheus端点

    Client->>Controller: HTTP请求
    Controller->>Aspect: 方法调用 (AOP拦截)
    Aspect->>Metrics: incrementEndpointCount()
    Metrics->>Registry: counter.increment()
    Controller->>Client: 返回响应
    
    Note over Registry: 指标数据持续累积
    
    Prometheus->>Controller: GET /actuator/prometheus
    Controller->>Registry: 获取所有指标
    Registry->>Prometheus: 返回Prometheus格式数据</div>
<h3 id="配置文件的深层解析" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#配置文件的深层解析" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 配置文件的深层解析">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            配置文件的深层解析
        </h3>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">为什么需要这些配置？</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="yaml" data-code="management%3A%0Aendpoints%3A%0Aweb%3A%0Aexposure%3A%0A%23%20%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AA%E6%9A%B4%E9%9C%B2%E8%BF%99%E4%BA%9B%E7%AB%AF%E7%82%B9%EF%BC%9F%0Ainclude%3A%20%22health%2Cinfo%2Cmetrics%2Cprometheus%2Cenv%2Cthreaddump%2Cloggers%22%0A%23%20%E5%AE%89%E5%85%A8%E8%80%83%E8%99%91%EF%BC%9A%0A%23%20-%20health%3A%20%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%EF%BC%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9C%80%E8%A6%81%0A%23%20-%20metrics%3A%20%E5%86%85%E9%83%A8%E7%9B%91%E6%8E%A7%E6%9F%A5%E8%AF%A2%0A%23%20-%20prometheus%3A%20%E5%A4%96%E9%83%A8%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E6%8B%89%E5%8F%96%0A%23%20-%20%E5%85%B6%E4%BB%96%E6%95%8F%E6%84%9F%E7%AB%AF%E7%82%B9%E4%B8%8D%E6%9A%B4%E9%9C%B2%EF%BC%8C%E9%81%BF%E5%85%8D%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">yaml</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-yaml"><span class="hljs-attr inline">management:</span>
  <span class="hljs-attr inline">endpoints:</span>
    <span class="hljs-attr inline">web:</span>
      <span class="hljs-attr inline">exposure:</span>
        <span class="hljs-comment inline"># 为什么只暴露这些端点？</span>
        <span class="hljs-attr inline">include:</span> <span class="hljs-string inline">&quot;health,info,metrics,prometheus,env,threaddump,loggers&quot;</span>
        <span class="hljs-comment inline"># 安全考虑：</span>
        <span class="hljs-comment inline"># - health: 健康检查，负载均衡需要</span>
        <span class="hljs-comment inline"># - metrics: 内部监控查询</span>
        <span class="hljs-comment inline"># - prometheus: 外部监控系统拉取</span>
        <span class="hljs-comment inline"># - 其他敏感端点不暴露，避免信息泄露</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">生产环境的安全配置</strong>：</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="yaml" data-code="management%3A%0Aendpoints%3A%0Aweb%3A%0Aexposure%3A%0Ainclude%3A%20%22health%2Cprometheus%22%20%20%23%20%E6%9C%80%E5%B0%8F%E6%9A%B4%E9%9C%B2%E5%8E%9F%E5%88%99%0Abase-path%3A%20%2Finternal%2Factuator%20%20%23%20%E5%86%85%E9%83%A8%E8%B7%AF%E5%BE%84%EF%BC%8C%E4%BE%BF%E4%BA%8E%E7%BD%91%E5%85%B3%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6%0Aendpoint%3A%0Aprometheus%3A%0Aaccess%3A%20when_authorized%20%20%23%20%E9%9C%80%E8%A6%81%E8%AE%A4%E8%AF%81%0Ahealth%3A%0Ashow-details%3A%20when_authorized%20%20%23%20%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF%E9%9C%80%E8%A6%81%E8%AE%A4%E8%AF%81%0Aserver%3A%0Aport%3A%209090%20%20%23%20%E7%8B%AC%E7%AB%8B%E7%9A%84%E7%AE%A1%E7%90%86%E7%AB%AF%E5%8F%A3%EF%BC%8C%E4%BE%BF%E4%BA%8E%E9%98%B2%E7%81%AB%E5%A2%99%E7%AD%96%E7%95%A5">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">yaml</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-yaml"><span class="hljs-attr inline">management:</span>
  <span class="hljs-attr inline">endpoints:</span>
    <span class="hljs-attr inline">web:</span>
      <span class="hljs-attr inline">exposure:</span>
        <span class="hljs-attr inline">include:</span> <span class="hljs-string inline">&quot;health,prometheus&quot;</span>  <span class="hljs-comment inline"># 最小暴露原则</span>
        <span class="hljs-attr inline">base-path:</span> <span class="hljs-string inline">/internal/actuator</span>  <span class="hljs-comment inline"># 内部路径，便于网关路由控制</span>
  <span class="hljs-attr inline">endpoint:</span>
    <span class="hljs-attr inline">prometheus:</span>
      <span class="hljs-attr inline">access:</span> <span class="hljs-string inline">when_authorized</span>  <span class="hljs-comment inline"># 需要认证</span>
    <span class="hljs-attr inline">health:</span>
      <span class="hljs-attr inline">show-details:</span> <span class="hljs-string inline">when_authorized</span>  <span class="hljs-comment inline"># 详细信息需要认证</span>
  <span class="hljs-attr inline">server:</span>
    <span class="hljs-attr inline">port:</span> <span class="hljs-number inline">9090</span>  <span class="hljs-comment inline"># 独立的管理端口，便于防火墙策略</span>
</code></pre>
            </div>
        
<h2 id="写在最后" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#写在最后" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to 写在最后">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            写在最后
        </h2>
<p class="text-base leading-7 mb-4 text-foreground">相比起使用监控系统来关注系统运行的健康程度，其实我更喜欢使用监控系统来进行用户行为分析。诚然，安全比个性更重要，但安全的目的不就是为了之后更多的可能性吗？</p>
<p class="text-base leading-7 mb-4 text-foreground">ACOT的监控系统设计是相对简单的，但它展现出了一个系统的长期可持续发展能力——对于用户需求的敏锐嗅觉。毕竟，能解决用户需求的系统才是好系统。</p>
<p class="text-base leading-7 mb-4 text-foreground"><em class="italic text-foreground">愿未来的系统形如灵智的精灵，倾心聆听来访者的声音，化身他们手中披荆斩棘的利刃，担任成为未来的算子，让人类的智慧在宇宙中闪烁。</em> ✨</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E8%AE%B8%E6%84%BF%EF%BC%88%E7%9B%91%E6%8E%A7%E7%89%88%EF%BC%89%0Awhile%20(system.isRunning())%20%7B%0Amonitor.collect()%3B%0Aif%20(anomaly.detected())%20%7B%0Aalert.send()%3B%20%F0%9F%9A%A8%0Aengineer.fix()%3B%0A%7D%0Adashboard.update()%3B%20%F0%9F%93%8A%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="复制代码">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">复制</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// 许愿（监控版）</span>
<span class="hljs-keyword inline">while</span> (system.isRunning()) {
    monitor.collect();
    <span class="hljs-keyword inline">if</span> (anomaly.detected()) {
        alert.send(); 🚨
        engineer.fix();
    }
    dashboard.update(); 📊
}
</code></pre>
            </div>
        
</div></article><footer class="mt-16 pt-8 border-t border-foreground/20"><div class="flex items-center justify-between"><a class="inline-flex items-center px-4 py-2 bg-primary text-foreground rounded-lg hover:bg-primary/90 transition-colors" href="/MilkWind-Website/documents/">documents.backToDocuments</a><div class="text-sm text-foreground/60"><span>documents.byAuthor<!-- --> <!-- -->MilkWind</span></div></div></footer></div></div><!--$--><!--/$--><!--$--><!--/$--><!--/$--><!--/$--><script src="/MilkWind-Website/_next/static/chunks/webpack-4924e903218f1830.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[38735,[\"46\",\"static/chunks/46-268e24d727b280ef.js\",\"7177\",\"static/chunks/app/layout-af4a6e723c0ff668.js\"],\"default\"]\n3:I[19945,[\"46\",\"static/chunks/46-268e24d727b280ef.js\",\"7177\",\"static/chunks/app/layout-af4a6e723c0ff668.js\"],\"default\"]\n4:I[65337,[\"46\",\"static/chunks/46-268e24d727b280ef.js\",\"7177\",\"static/chunks/app/layout-af4a6e723c0ff668.js\"],\"default\"]\n5:I[96190,[\"46\",\"static/chunks/46-268e24d727b280ef.js\",\"7177\",\"static/chunks/app/layout-af4a6e723c0ff668.js\"],\"ClientProviders\"]\n6:I[87555,[],\"\"]\n7:I[51901,[\"8039\",\"static/chunks/app/error-dda32be1d095a86c.js\"],\"default\"]\n8:I[31295,[],\"\"]\n9:I[6874,[\"6874\",\"static/chunks/6874-fbe9a08eb79b991c.js\",\"4345\",\"static/chunks/app/not-found-9ff98b2ccf24cac7.js\"],\"\"]\na:I[94970,[],\"ClientSegmentRoot\"]\nb:I[44065,[\"206\",\"static/chunks/206-4f4cbf4d7156f437.js\",\"3092\",\"static/chunks/app/documents/layout-28408791defde09e.js\"],\"default\"]\ne:I[59665,[],\"MetadataBoundary\"]\n10:I[59665,[],\"OutletBoundary\"]\n13:I[74911,[],\"AsyncMetadataOutlet\"]\n15:I[39460,[\"2415\",\"static/chunks/2415-689c103fb3d2c28d.js\",\"8610\",\"static/chunks/8610-7bd3f91f3cf2a4d6.js\",\"5650\",\"static/chunks/app/documents/loading-1fa3f98b6e5a8e78.js\"],\"default\"]\n16:I[88610,[\"2415\",\"static/chunks/2415-689c103fb3d2c28d.js\",\"8610\",\"static/chunks/8610-7bd3f91f3cf2a4d6.js\",\"4209\",\"static/chunks/app/loading-68f227fb49b3ac8c.js\"],\"default\"]\n17:I[59665,[],\"ViewportBoundary\"]\n19:I[26614,[],\"\"]\n:HL[\"/MilkWind-Website/_next/static/css/f034c804622acb16.css\",\"style\"]\n:HL[\"/MilkWind-Website/_next/static/css/276b387d8ca46690.css\",\"style\"]\n:HL[\"/MilkWind-Website/_next/static/css/5eacd01f773eed7f.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"BJpk_sL_vr43bGNqBw4uH\",\"p\":\"/MilkWind-Website\",\"c\":[\"\",\"documents\",\"zh\",\"dark\",\"all-chat-on-this\",\"metrics\",\"\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"documents\",{\"children\":[[\"slug\",\"zh/dark/all-chat-on-this/metrics\",\"c\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/MilkWind-Website/_next/static/css/f034c804622acb16.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/MilkWind-Website/_next/static/css/276b387d8ca46690.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"__variable_9b7fb1 __variable_ca2a15 __variable_591dcc font-sans antialiased min-h-screen bg-background text-foreground\",\"suppressHydrationWarning\":true,\"children\":[[\"$\",\"$L2\",null,{}],[\"$\",\"$L3\",null,{}],[\"$\",\"$L4\",null,{}],[\"$\",\"$L5\",null,{\"children\":[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$7\",\"errorStyles\":[],\"errorScripts\":[],\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"div\",null,{\"className\":\"z-10 relative min-h-screen flex items-center justify-center bg-background p-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"text-center max-w-md\",\"children\":[[\"$\",\"div\",null,{\"className\":\"text-8xl font-bold text-primary mb-4\",\"children\":\"404\"}],[\"$\",\"h2\",null,{\"className\":\"text-2xl font-bold text-foreground mb-4\",\"children\":\"Page Not Found\"}],[\"$\",\"p\",null,{\"className\":\"text-foreground/70 mb-8\",\"children\":\"The page you're looking for doesn't exist or has been moved to a different location.\"}],[\"$\",\"div\",null,{\"className\":\"flex flex-col sm:flex-row gap-4 justify-center\",\"children\":[[\"$\",\"$L9\",null,{\"href\":\"/\",\"className\":\"px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors\",\"children\":\"Go Home\"}],[\"$\",\"$L9\",null,{\"href\":\"/works\",\"className\":\"px-6 py-2 border border-primary text-primary rounded-lg hover:bg-primary/10 transition-colors\",\"children\":\"View Works\"}]]}],[\"$\",\"div\",null,{\"className\":\"absolute inset-0 overflow-hidden pointer-events-none -z-10\",\"children\":[[\"$\",\"div\",null,{\"className\":\"absolute top-1/4 left-1/4 w-2 h-2 bg-primary/20 rounded-full animate-float\"}],[\"$\",\"div\",null,{\"className\":\"absolute top-3/4 right-1/4 w-3 h-3 bg-accent/20 rounded-full animate-float\",\"style\":{\"animationDelay\":\"1s\"}}],[\"$\",\"div\",null,{\"className\":\"absolute bottom-1/4 left-1/3 w-1 h-1 bg-secondary/20 rounded-full animate-float\",\"style\":{\"animationDelay\":\"2s\"}}]]}]]}]}],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]]}]}]]}],{\"children\":[\"documents\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$La\",null,{\"Component\":\"$b\",\"slots\":{\"children\":[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]},\"params\":{},\"promise\":\"$@c\"}]]}],{\"children\":[[\"slug\",\"zh/dark/all-chat-on-this/metrics\",\"c\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$Ld\",[\"$\",\"$Le\",null,{\"children\":\"$Lf\"}],[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/MilkWind-Website/_next/static/css/5eacd01f773eed7f.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$L10\",null,{\"children\":[\"$L11\",\"$L12\",[\"$\",\"$L13\",null,{\"promise\":\"$@14\"}]]}]]}],{},null,false]},null,false]},[[\"$\",\"$L15\",\"l\",{}],[],[]],false]},[[\"$\",\"$L16\",\"l\",{}],[],[]],false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"-r_9_25nScn26cHiBx5ny\",{\"children\":[[\"$\",\"$L17\",null,{\"children\":\"$L18\"}],null]}],null]}],false]],\"m\":\"$undefined\",\"G\":[\"$19\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"1a:\"$Sreact.suspense\"\n1b:I[74911,[],\"AsyncMetadata\"]\nc:{}\nf:[\"$\",\"$1a\",null,{\"fallback\":null,\"children\":[\"$\",\"$L1b\",null,{\"promise\":\"$@1c\"}]}]\n"])</script><script>self.__next_f.push([1,"1d:I[57340,[\"5584\",\"static/chunks/b498d07c-095637f0f10883c6.js\",\"2415\",\"static/chunks/2415-689c103fb3d2c28d.js\",\"6874\",\"static/chunks/6874-fbe9a08eb79b991c.js\",\"9554\",\"static/chunks/9554-b714f9de28e85d30.js\",\"1873\",\"static/chunks/app/documents/%5B...slug%5D/page-8f3efa7e6c6c5377.js\"],\"DocumentPageClient\"]\n1e:T280a1,"])</script><script>self.__next_f.push([1,"\u003ch1 id=\"all-chat-on-this-端点监控与暴露功能实现原理：从aop切面到prometheus的完整监控生态\" class=\"group relative text-4xl font-bold mt-8 mb-4 text-foreground leading-tight\"\u003e\n            \u003ca href=\"#all-chat-on-this-端点监控与暴露功能实现原理：从aop切面到prometheus的完整监控生态\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态\n        \u003c/h1\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e“让我看看用户都在做什么” （让我访问！）\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003eACOT的监控系统设计比较简单，目前仅监控了接口调用次数和在线人数，不过我们可以从这简单的应用中窥见从数据收集到可视化展示的完整监控生态系统流程。\u003c/p\u003e\n\u003ch2 id=\"监控架构篇：四层分离设计\" class=\"group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight\"\u003e\n            \u003ca href=\"#监控架构篇：四层分离设计\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to 监控架构篇：四层分离设计\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            监控架构篇：四层分离设计\n        \u003c/h2\u003e\n\u003ch3 id=\"分层架构概述：数据流的生命周期\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#分层架构概述：数据流的生命周期\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to 分层架构概述：数据流的生命周期\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            分层架构概述：数据流的生命周期\n        \u003c/h3\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003eACOT的监控系统采用了典型的\u003cstrong class=\"font-bold text-foreground\"\u003e四层分离架构\u003c/strong\u003e，每一层都有其独特的职责和技术选型：\u003c/p\u003e\n\u003cdiv class=\"mermaid block\" id=\"mermaid-1767525094481-n6elza2\"\u003egraph TB\n    A[数据收集层] --\u003e B[指标存储层]\n    B --\u003e C[数据暴露层]\n    C --\u003e D[监控可视化层]\n    \n    A1[AOP切面拦截] --\u003e A\n    A2[Spring Security事件] --\u003e A\n    A3[HTTP Session监听] --\u003e A\n    \n    B1[Micrometer核心] --\u003e B\n    B2[Counter计数器] --\u003e B\n    B3[Gauge仪表盘] --\u003e B\n    \n    C1[Spring Boot Actuator] --\u003e C\n    C2[Actuator Prometheus] --\u003e C\n    C3[Actuator Metrics] --\u003e C\n    \n    D1[Prometheus时序数据库] --\u003e D\n    D2[Grafana可视化] --\u003e D\n    D3[告警系统] --\u003e D\u003c/div\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003e为什么要分层\u003c/strong\u003e？\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e这种分层设计遵循了\u003cstrong class=\"font-bold text-foreground\"\u003e关注点分离\u003c/strong\u003e的原则：\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cspan class=\"katex-display inline\"\u003e\u003cspan class=\"katex inline\"\u003e\u003cspan class=\"katex-mathml inline\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmtext\u003e监控系统\u003c/mtext\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmtext\u003e数据收集\u003c/mtext\u003e\u003cmo\u003e⊕\u003c/mo\u003e\u003cmtext\u003e指标存储\u003c/mtext\u003e\u003cmo\u003e⊕\u003c/mo\u003e\u003cmtext\u003e数据暴露\u003c/mtext\u003e\u003cmo\u003e⊕\u003c/mo\u003e\u003cmtext\u003e可视化展示\u003c/mtext\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003e监控系统 = 数据收集 \\oplus 指标存储 \\oplus 数据暴露 \\oplus 可视化展示\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html inline\" aria-hidden=\"true\" style=\"display:none\"\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:0.6833em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord cjk_fallback inline\"\u003e监控系统\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel inline\"\u003e=\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:0.7667em;vertical-align:-0.0833em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord cjk_fallback inline\"\u003e数据收集\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2222em;\"\u003e\u003c/span\u003e\u003cspan class=\"mbin inline\"\u003e⊕\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2222em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:0.7667em;vertical-align:-0.0833em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord cjk_fallback inline\"\u003e指标存储\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2222em;\"\u003e\u003c/span\u003e\u003cspan class=\"mbin inline\"\u003e⊕\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2222em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:0.7667em;vertical-align:-0.0833em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord cjk_fallback inline\"\u003e数据暴露\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2222em;\"\u003e\u003c/span\u003e\u003cspan class=\"mbin inline\"\u003e⊕\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2222em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:0.6833em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord cjk_fallback inline\"\u003e可视化展示\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e每一层的技术选型都可以独立演进，比如：\u003c/p\u003e\n\u003cul class=\"list-disc list-inside mb-4 pl-6 space-y-2\"\u003e\n\u003cli class=\"text-foreground leading-relaxed\"\u003e数据收集层：可以从AOP切换到Filter或者Interceptor\u003c/li\u003e\n\u003cli class=\"text-foreground leading-relaxed\"\u003e指标存储层：可以从Micrometer切换到其他指标库\u003c/li\u003e\n\u003cli class=\"text-foreground leading-relaxed\"\u003e数据暴露层：可以支持多种格式（Prometheus、JSON、XML等）\u003c/li\u003e\n\u003cli class=\"text-foreground leading-relaxed\"\u003e可视化层：可以从Grafana切换到其他监控平台\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"端点监控的核心原理篇：aop\" class=\"group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight\"\u003e\n            \u003ca href=\"#端点监控的核心原理篇：aop\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to 端点监控的核心原理篇：AOP\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            端点监控的核心原理篇：AOP\n        \u003c/h2\u003e\n\u003ch3 id=\"aop切面编程：神秘下料男\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#aop切面编程：神秘下料男\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to AOP切面编程：神秘下料男\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            AOP切面编程：神秘下料男\n        \u003c/h3\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003e什么是AOP？\u003c/strong\u003e\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003eAOP（Aspect-Oriented Programming）面向切面编程，简单来说就是在不修改原有代码的情况下，给方法\u0026quot;加料\u0026quot;。\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"java\" data-code=\"%2F%2F%20%E5%8E%9F%E6%9D%A5%E7%9A%84%E4%B8%9A%E5%8A%A1%E6%96%B9%E6%B3%95%0Apublic%20String%20getUserInfo(Long%20userId)%20%7B%0Areturn%20userService.getUser(userId)%3B%0A%7D%0A%2F%2F%20AOP%E9%AD%94%E6%B3%95%E5%90%8E%E7%9A%84%E5%AE%9E%E9%99%85%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%0Apublic%20String%20getUserInfo(Long%20userId)%20%7B%0A%2F%2F%20%E2%86%93%20AOP%E5%89%8D%E7%BD%AE%E9%80%9A%E7%9F%A5%EF%BC%9A%E8%AE%B0%E5%BD%95%E8%B0%83%E7%94%A8%E7%BB%9F%E8%AE%A1%0AendpointMetrics.incrementEndpointCount(%22UserController%22%2C%20%22getUserInfo%22)%3B%0A%2F%2F%20%E2%86%93%20%E5%8E%9F%E5%A7%8B%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%0AString%20result%20%3D%20userService.getUser(userId)%3B%0A%2F%2F%20%E2%86%93%20AOP%E5%90%8E%E7%BD%AE%E9%80%9A%E7%9F%A5%EF%BC%9A%E8%AE%B0%E5%BD%95%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%E3%80%81%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%AD%89%0Areturn%20result%3B%0A%7D\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ejava\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"hljs-comment inline\"\u003e// 原来的业务方法\u003c/span\u003e\n\u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e String \u003cspan class=\"hljs-title function_ inline\"\u003egetUserInfo\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e(Long userId)\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword inline\"\u003ereturn\u003c/span\u003e userService.getUser(userId);\n}\n\n\u003cspan class=\"hljs-comment inline\"\u003e// AOP魔法后的实际执行流程\u003c/span\u003e\n\u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e String \u003cspan class=\"hljs-title function_ inline\"\u003egetUserInfo\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e(Long userId)\u003c/span\u003e {\n    \u003cspan class=\"hljs-comment inline\"\u003e// ↓ AOP前置通知：记录调用统计\u003c/span\u003e\n    endpointMetrics.incrementEndpointCount(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;UserController\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string inline\"\u003e\u0026quot;getUserInfo\u0026quot;\u003c/span\u003e);\n    \n    \u003cspan class=\"hljs-comment inline\"\u003e// ↓ 原始业务逻辑\u003c/span\u003e\n    \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eresult\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e userService.getUser(userId);\n    \n    \u003cspan class=\"hljs-comment inline\"\u003e// ↓ AOP后置通知：记录响应时间、异常处理等\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003ereturn\u003c/span\u003e result;\n}\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003ch3 id=\"endpointmetricsaspect：切面拦截\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#endpointmetricsaspect：切面拦截\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to EndpointMetricsAspect：切面拦截\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            EndpointMetricsAspect：切面拦截\n        \u003c/h3\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"java\" data-code=\"%40Aspect%0A%40Component%0A%40RequiredArgsConstructor%0A%40Slf4j%0Apublic%20class%20EndpointMetricsAspect%20%7B%0Aprivate%20final%20EndpointMetrics%20endpointMetrics%3B%0A%2F**%0A*%20%E5%88%87%E7%82%B9%E5%AE%9A%E4%B9%89%EF%BC%9A%E5%8F%AA%E6%8B%A6%E6%88%AA%40RestController%E6%A0%87%E6%B3%A8%E7%9A%84%E7%B1%BB%0A*%0A*%20%40within%20vs%20%40target%20%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A%0A*%20-%20%40within%EF%BC%9A%E7%B1%BB%E7%BA%A7%E5%88%AB%E5%8C%B9%E9%85%8D%EF%BC%8C%E7%BC%96%E8%AF%91%E6%97%B6%E7%A1%AE%E5%AE%9A%0A*%20-%20%40target%EF%BC%9A%E5%AF%B9%E8%B1%A1%E7%BA%A7%E5%88%AB%E5%8C%B9%E9%85%8D%EF%BC%8C%E8%BF%90%E8%A1%8C%E6%97%B6%E7%A1%AE%E5%AE%9A%0A*%0A*%20%E9%80%89%E6%8B%A9%40within%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%9A%E6%80%A7%E8%83%BD%E6%9B%B4%E5%A5%BD%EF%BC%8C%E7%BC%96%E8%AF%91%E6%97%B6%E5%B0%B1%E8%83%BD%E7%A1%AE%E5%AE%9A%E5%88%87%E5%85%A5%E7%82%B9%0A*%2F%0A%40Pointcut(%22%40within(org.springframework.web.bind.annotation.RestController)%22)%0Apublic%20void%20controllerPointcut()%20%7B%0A%2F%2F%20%E5%88%87%E7%82%B9%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95%EF%BC%8C%E6%97%A0%E9%9C%80%E5%AE%9E%E7%8E%B0%E4%BD%93%0A%7D%0A%2F**%0A*%20%E5%89%8D%E7%BD%AE%E9%80%9A%E7%9F%A5%EF%BC%9A%E5%9C%A8%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E5%89%8D%E7%BB%9F%E8%AE%A1%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%0A*%0A*%20%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9%40Before%E8%80%8C%E4%B8%8D%E6%98%AF%40Around%EF%BC%9F%0A*%20-%20%40Before%EF%BC%9A%E8%BD%BB%E9%87%8F%E7%BA%A7%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E8%AE%B0%E5%BD%95%E8%B0%83%E7%94%A8%E5%8D%B3%E5%8F%AF%0A*%20-%20%40Around%EF%BC%9A%E9%87%8D%E9%87%8F%E7%BA%A7%EF%BC%8C%E9%9C%80%E8%A6%81%E6%8E%A7%E5%88%B6%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%0A*%2F%0A%40Before(%22controllerPointcut()%22)%0Apublic%20void%20beforeControllerMethod(JoinPoint%20joinPoint)%20%7B%0Atry%20%7B%0A%2F%2F%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95%E7%AD%BE%E5%90%8D%E4%BF%A1%E6%81%AF%0AMethodSignature%20signature%20%3D%20(MethodSignature)%20joinPoint.getSignature()%3B%0AMethod%20method%20%3D%20signature.getMethod()%3B%0AClass%20controllerClass%20%3D%20method.getDeclaringClass()%3B%0A%2F%2F%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E6%8F%90%E5%8F%96%E7%B1%BB%E5%90%8D%E5%92%8C%E6%96%B9%E6%B3%95%E5%90%8D%0AString%20controllerName%20%3D%20controllerClass.getSimpleName()%3B%20%20%2F%2F%20UserController%0AString%20methodName%20%3D%20method.getName()%3B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20getUserInfo%0A%2F%2F%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E4%B8%BAHTTP%E7%AB%AF%E7%82%B9%EF%BC%88%E9%81%BF%E5%85%8D%E6%8B%A6%E6%88%AA%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%EF%BC%89%0Aif%20(isHttpEndpoint(method))%20%7B%0A%2F%2F%20%E6%AD%A5%E9%AA%A44%EF%BC%9A%E8%AE%B0%E5%BD%95%E7%AB%AF%E7%82%B9%E8%B0%83%E7%94%A8%E7%BB%9F%E8%AE%A1%0AendpointMetrics.incrementEndpointCount(controllerName%2C%20methodName)%3B%0Alog.debug(%22%E7%AB%AF%E7%82%B9%E8%B0%83%E7%94%A8%3A%20%7B%7D.%7B%7D%22%2C%20controllerName%2C%20methodName)%3B%0A%7D%0A%7D%20catch%20(Exception%20e)%20%7B%0A%2F%2F%20%E5%85%B3%E9%94%AE%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%BC%82%E5%B8%B8%E9%9A%94%E7%A6%BB%EF%BC%8C%E7%9B%91%E6%8E%A7%E5%A4%B1%E8%B4%A5%E4%B8%8D%E5%BD%B1%E5%93%8D%E4%B8%9A%E5%8A%A1%0Alog.error(%22%E7%AB%AF%E7%82%B9%E6%8C%87%E6%A0%87%E8%AE%B0%E5%BD%95%E5%A4%B1%E8%B4%A5%22%2C%20e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20HTTP%E7%AB%AF%E7%82%B9%E8%AF%86%E5%88%AB%E7%AE%97%E6%B3%95%EF%BC%9A%E6%94%AF%E6%8C%81%E6%89%80%E6%9C%89Spring%20Web%E6%B3%A8%E8%A7%A3%0A*%0A*%20%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%BF%99%E4%B8%AA%E6%A3%80%E6%9F%A5%EF%BC%9F%0A*%20-%20%40RestController%E7%B1%BB%E4%B8%AD%E5%8F%AF%E8%83%BD%E6%9C%89%E9%9D%9EHTTP%E6%96%B9%E6%B3%95%EF%BC%88%E5%A6%82private%20helper%E6%96%B9%E6%B3%95%EF%BC%89%0A*%20-%20%E5%8F%AA%E6%9C%89%E7%9C%9F%E6%AD%A3%E7%9A%84HTTP%E7%AB%AF%E7%82%B9%E6%89%8D%E9%9C%80%E8%A6%81%E7%BB%9F%E8%AE%A1%0A*%2F%0Aprivate%20boolean%20isHttpEndpoint(Method%20method)%20%7B%0Areturn%20method.isAnnotationPresent(RequestMapping.class)%20%7C%7C%20%20%20%20%20%20%2F%2F%20%E9%80%9A%E7%94%A8%E6%98%A0%E5%B0%84%0Amethod.isAnnotationPresent(GetMapping.class)%20%7C%7C%20%20%20%20%20%20%20%20%20%2F%2F%20GET%E8%AF%B7%E6%B1%82%0Amethod.isAnnotationPresent(PostMapping.class)%20%7C%7C%20%20%20%20%20%20%20%20%2F%2F%20POST%E8%AF%B7%E6%B1%82%0Amethod.isAnnotationPresent(PutMapping.class)%20%7C%7C%20%20%20%20%20%20%20%20%20%2F%2F%20PUT%E8%AF%B7%E6%B1%82%0Amethod.isAnnotationPresent(DeleteMapping.class)%20%7C%7C%20%20%20%20%20%20%2F%2F%20DELETE%E8%AF%B7%E6%B1%82%0Amethod.isAnnotationPresent(PatchMapping.class)%3B%20%20%20%20%20%20%20%20%20%2F%2F%20PATCH%E8%AF%B7%E6%B1%82%0A%7D%0A%7D\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ejava\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"hljs-meta inline\"\u003e@Aspect\u003c/span\u003e\n\u003cspan class=\"hljs-meta inline\"\u003e@Component\u003c/span\u003e\n\u003cspan class=\"hljs-meta inline\"\u003e@RequiredArgsConstructor\u003c/span\u003e\n\u003cspan class=\"hljs-meta inline\"\u003e@Slf4j\u003c/span\u003e\n\u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_ inline\"\u003eEndpointMetricsAspect\u003c/span\u003e {\n\n    \u003cspan class=\"hljs-keyword inline\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003efinal\u003c/span\u003e EndpointMetrics endpointMetrics;\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 切点定义：只拦截\u003cspan class=\"hljs-doctag inline\"\u003e@RestController\u003c/span\u003e标注的类\n     * \n     * \u003cspan class=\"hljs-doctag inline\"\u003e@within\u003c/span\u003e vs \u003cspan class=\"hljs-doctag inline\"\u003e@target\u003c/span\u003e 的区别：\n     * - \u003cspan class=\"hljs-doctag inline\"\u003e@within\u003c/span\u003e：类级别匹配，编译时确定\n     * - \u003cspan class=\"hljs-doctag inline\"\u003e@target\u003c/span\u003e：对象级别匹配，运行时确定\n     * \n     * 选择\u003cspan class=\"hljs-doctag inline\"\u003e@within\u003c/span\u003e的原因：性能更好，编译时就能确定切入点\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-meta inline\"\u003e@Pointcut(\u0026quot;@within(org.springframework.web.bind.annotation.RestController)\u0026quot;)\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title function_ inline\"\u003econtrollerPointcut\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e()\u003c/span\u003e {\n        \u003cspan class=\"hljs-comment inline\"\u003e// 切点定义方法，无需实现体\u003c/span\u003e\n    }\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 前置通知：在方法执行前统计调用次数\n     * \n     * 为什么选择\u003cspan class=\"hljs-doctag inline\"\u003e@Before\u003c/span\u003e而不是\u003cspan class=\"hljs-doctag inline\"\u003e@Around\u003c/span\u003e？\n     * - \u003cspan class=\"hljs-doctag inline\"\u003e@Before\u003c/span\u003e：轻量级，只需要记录调用即可\n     * - \u003cspan class=\"hljs-doctag inline\"\u003e@Around\u003c/span\u003e：重量级，需要控制方法执行流程\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-meta inline\"\u003e@Before(\u0026quot;controllerPointcut()\u0026quot;)\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title function_ inline\"\u003ebeforeControllerMethod\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e(JoinPoint joinPoint)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword inline\"\u003etry\u003c/span\u003e {\n            \u003cspan class=\"hljs-comment inline\"\u003e// 步骤1：获取方法签名信息\u003c/span\u003e\n            \u003cspan class=\"hljs-type inline\"\u003eMethodSignature\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003esignature\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e (MethodSignature) joinPoint.getSignature();\n            \u003cspan class=\"hljs-type inline\"\u003eMethod\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003emethod\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e signature.getMethod();\n            Class\u0026lt;?\u0026gt; controllerClass = method.getDeclaringClass();\n            \n            \u003cspan class=\"hljs-comment inline\"\u003e// 步骤2：提取类名和方法名\u003c/span\u003e\n            \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003econtrollerName\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e controllerClass.getSimpleName();  \u003cspan class=\"hljs-comment inline\"\u003e// UserController\u003c/span\u003e\n            \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003emethodName\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e method.getName();                     \u003cspan class=\"hljs-comment inline\"\u003e// getUserInfo\u003c/span\u003e\n\n            \u003cspan class=\"hljs-comment inline\"\u003e// 步骤3：验证是否为HTTP端点（避免拦截内部方法）\u003c/span\u003e\n            \u003cspan class=\"hljs-keyword inline\"\u003eif\u003c/span\u003e (isHttpEndpoint(method)) {\n                \u003cspan class=\"hljs-comment inline\"\u003e// 步骤4：记录端点调用统计\u003c/span\u003e\n                endpointMetrics.incrementEndpointCount(controllerName, methodName);\n                log.debug(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;端点调用: {}.{}\u0026quot;\u003c/span\u003e, controllerName, methodName);\n            }\n        } \u003cspan class=\"hljs-keyword inline\"\u003ecatch\u003c/span\u003e (Exception e) {\n            \u003cspan class=\"hljs-comment inline\"\u003e// 关键设计：异常隔离，监控失败不影响业务\u003c/span\u003e\n            log.error(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;端点指标记录失败\u0026quot;\u003c/span\u003e, e);\n        }\n    }\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * HTTP端点识别算法：支持所有Spring Web注解\n     * \n     * 为什么需要这个检查？\n     * - \u003cspan class=\"hljs-doctag inline\"\u003e@RestController\u003c/span\u003e类中可能有非HTTP方法（如private helper方法）\n     * - 只有真正的HTTP端点才需要统计\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-type inline\"\u003eboolean\u003c/span\u003e \u003cspan class=\"hljs-title function_ inline\"\u003eisHttpEndpoint\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e(Method method)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword inline\"\u003ereturn\u003c/span\u003e method.isAnnotationPresent(RequestMapping.class) ||      \u003cspan class=\"hljs-comment inline\"\u003e// 通用映射\u003c/span\u003e\n                method.isAnnotationPresent(GetMapping.class) ||         \u003cspan class=\"hljs-comment inline\"\u003e// GET请求\u003c/span\u003e\n                method.isAnnotationPresent(PostMapping.class) ||        \u003cspan class=\"hljs-comment inline\"\u003e// POST请求\u003c/span\u003e\n                method.isAnnotationPresent(PutMapping.class) ||         \u003cspan class=\"hljs-comment inline\"\u003e// PUT请求\u003c/span\u003e\n                method.isAnnotationPresent(DeleteMapping.class) ||      \u003cspan class=\"hljs-comment inline\"\u003e// DELETE请求\u003c/span\u003e\n                method.isAnnotationPresent(PatchMapping.class);         \u003cspan class=\"hljs-comment inline\"\u003e// PATCH请求\u003c/span\u003e\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003eJoinPoint的信息提取链\u003c/strong\u003e：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"java\" data-code=\"%2F%2F%20JoinPoint%E4%BF%A1%E6%81%AF%E6%8F%90%E5%8F%96%E7%9A%84%E5%AE%8C%E6%95%B4%E9%93%BE%E8%B7%AF%0AJoinPoint%20joinPoint%20%3D%20%2F%2F%20AOP%E6%A1%86%E6%9E%B6%E6%B3%A8%E5%85%A5%0A%E2%86%93%0AMethodSignature%20signature%20%3D%20(MethodSignature)%20joinPoint.getSignature()%3B%0A%E2%86%93%0AMethod%20method%20%3D%20signature.getMethod()%3B%20%20%2F%2F%20%E8%8E%B7%E5%8F%96Method%E5%AF%B9%E8%B1%A1%0A%E2%86%93%0AClass%20clazz%20%3D%20method.getDeclaringClass()%3B%20%20%2F%2F%20%E8%8E%B7%E5%8F%96%E5%A3%B0%E6%98%8E%E7%B1%BB%0A%E2%86%93%0AString%20className%20%3D%20clazz.getSimpleName()%3B%20%20%20%20%20%2F%2F%20UserController%0AString%20methodName%20%3D%20method.getName()%3B%20%20%20%20%20%20%20%20%20%2F%2F%20getUserInfo\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ejava\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"hljs-comment inline\"\u003e// JoinPoint信息提取的完整链路\u003c/span\u003e\n\u003cspan class=\"hljs-type inline\"\u003eJoinPoint\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003ejoinPoint\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-comment inline\"\u003e// AOP框架注入\u003c/span\u003e\n    ↓\n\u003cspan class=\"hljs-type inline\"\u003eMethodSignature\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003esignature\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e (MethodSignature) joinPoint.getSignature();\n    ↓\n\u003cspan class=\"hljs-type inline\"\u003eMethod\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003emethod\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e signature.getMethod();  \u003cspan class=\"hljs-comment inline\"\u003e// 获取Method对象\u003c/span\u003e\n    ↓\nClass\u0026lt;?\u0026gt; clazz = method.getDeclaringClass();  \u003cspan class=\"hljs-comment inline\"\u003e// 获取声明类\u003c/span\u003e\n    ↓\n\u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eclassName\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e clazz.getSimpleName();     \u003cspan class=\"hljs-comment inline\"\u003e// UserController\u003c/span\u003e\n\u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003emethodName\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e method.getName();         \u003cspan class=\"hljs-comment inline\"\u003e// getUserInfo\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003ch3 id=\"线程安全的计数器设计：endpointmetrics并发\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#线程安全的计数器设计：endpointmetrics并发\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to 线程安全的计数器设计：EndpointMetrics并发\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            线程安全的计数器设计：EndpointMetrics并发\n        \u003c/h3\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e在高并发环境下，如何确保计数器的准确性？请看VCR——（不是）\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"java\" data-code=\"%40Component%0Apublic%20class%20EndpointMetrics%20%7B%0A%2F%2F%20%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%EF%BC%9AMicrometer%E7%9A%84%E5%BA%A6%E9%87%8F%E6%B3%A8%E5%86%8C%E8%A1%A8%0Aprivate%20final%20MeterRegistry%20meterRegistry%3B%0A%2F%2F%20%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84%E8%AE%A1%E6%95%B0%E5%99%A8%E7%BC%93%E5%AD%98%EF%BC%9A%E9%81%BF%E5%85%8D%E9%87%8D%E5%A4%8D%E5%88%9B%E5%BB%BACounter%0Aprivate%20final%20Map%20endpointCounters%20%3D%20new%20ConcurrentHashMap()%3B%0A%2F%2F%20%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%9A%84%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E8%AE%A1%E6%95%B0%E5%99%A8%0Aprivate%20final%20AtomicInteger%20onlineUsers%20%3D%20new%20AtomicInteger(0)%3B%0A%2F**%0A*%20%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%EF%BC%9A%E6%B3%A8%E5%86%8C%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%E7%9A%84Gauge%E6%8C%87%E6%A0%87%0A*%0A*%20Gauge%20vs%20Counter%20%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A%0A*%20-%20Gauge%EF%BC%9A%E7%9E%AC%E6%97%B6%E5%80%BC%E6%8C%87%E6%A0%87%EF%BC%8C%E5%A6%82%E5%BD%93%E5%89%8D%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%E3%80%81%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F%0A*%20-%20Counter%EF%BC%9A%E7%B4%AF%E5%8A%A0%E6%8C%87%E6%A0%87%EF%BC%8C%E5%A6%82API%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%E3%80%81%E9%94%99%E8%AF%AF%E6%95%B0%E9%87%8F%0A*%2F%0Apublic%20EndpointMetrics(MeterRegistry%20meterRegistry)%20%7B%0Athis.meterRegistry%20%3D%20meterRegistry%3B%0A%2F%2F%20%E6%B3%A8%E5%86%8CGauge%EF%BC%9A%E5%AE%9E%E6%97%B6%E5%8F%8D%E6%98%A0%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0AGauge.builder(%22acot.online.users%22%2C%20onlineUsers%3A%3Aget)%20%20%2F%2F%20%E5%BC%95%E7%94%A8%E5%8E%9F%E5%AD%90%E7%B1%BB%E7%9A%84get%E6%96%B9%E6%B3%95%0A.description(%22%E5%BD%93%E5%89%8D%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%22)%0A.register(meterRegistry)%3B%0A%7D%0A%2F**%0A*%20%E9%80%92%E5%A2%9E%E7%AB%AF%E7%82%B9%E8%B0%83%E7%94%A8%E8%AE%A1%E6%95%B0%EF%BC%9A%E6%A0%B8%E5%BF%83%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AE%97%E6%B3%95%0A*%0A*%20%40param%20controllerName%20%E6%8E%A7%E5%88%B6%E5%99%A8%E5%90%8D%E7%A7%B0%0A*%20%40param%20methodName%20%E6%96%B9%E6%B3%95%E5%90%8D%E7%A7%B0%0A*%2F%0Apublic%20void%20incrementEndpointCount(String%20controllerName%2C%20String%20methodName)%20%7B%0A%2F%2F%20%E6%9E%84%E9%80%A0%E7%AB%AF%E7%82%B9%E6%A0%87%E8%AF%86%E7%AC%A6%0AString%20endpoint%20%3D%20controllerName%20%2B%20%22.%22%20%2B%20methodName%3B%0A%2F%2F%20%E5%85%B3%E9%94%AE%E7%AE%97%E6%B3%95%EF%BC%9AcomputeIfAbsent%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E4%BF%9D%E8%AF%81%0ACounter%20counter%20%3D%20endpointCounters.computeIfAbsent(endpoint%2C%20k%20-%3E%0ACounter.builder(%22acot.endpoint.calls%22)%0A%2F%2F%20%E5%A4%9A%E7%BB%B4%E5%BA%A6%E6%A0%87%E7%AD%BE%EF%BC%9A%E6%94%AF%E6%8C%81Prometheus%E7%9A%84%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2%0A.tags(Arrays.asList(%0ATag.of(%22controller%22%2C%20controllerName)%2C%20%20%2F%2F%20%E6%8C%89%E6%8E%A7%E5%88%B6%E5%99%A8%E5%88%86%E7%BB%84%0ATag.of(%22method%22%2C%20methodName)))%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%8C%89%E6%96%B9%E6%B3%95%E5%88%86%E7%BB%84%0A.description(%22%E7%AB%AF%E7%82%B9%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%E7%BB%9F%E8%AE%A1%22)%0A.register(meterRegistry))%3B%20%20%2F%2F%20%E6%B3%A8%E5%86%8C%E5%88%B0Micrometer%0A%2F%2F%20%E5%8E%9F%E5%AD%90%E9%80%92%E5%A2%9E%E6%93%8D%E4%BD%9C%0Acounter.increment()%3B%0A%7D%0A%2F**%0A*%20%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%EF%BC%9A%E5%8E%9F%E5%AD%90%E9%80%92%E5%A2%9E%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0A*%2F%0Apublic%20void%20userLoggedIn()%20%7B%0AonlineUsers.incrementAndGet()%3B%20%20%2F%2F%20%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%EF%BC%9Acurrent%20%2B%201%0A%7D%0A%2F**%0A*%20%E7%94%A8%E6%88%B7%E7%99%BB%E5%87%BA%EF%BC%9A%E5%B8%A6%E8%BE%B9%E7%95%8C%E6%A3%80%E6%9F%A5%E7%9A%84%E5%8E%9F%E5%AD%90%E9%80%92%E5%87%8F%0A*%2F%0Apublic%20void%20userLoggedOut()%20%7B%0A%2F%2F%20%E9%98%B2%E6%AD%A2%E8%B4%9F%E6%95%B0%E7%9A%84%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%EF%BC%9Amax(0%2C%20current%20-%201)%0AonlineUsers.updateAndGet(current%20-%3E%20Math.max(0%2C%20current%20-%201))%3B%0A%7D%0A%7D\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ejava\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"hljs-meta inline\"\u003e@Component\u003c/span\u003e\n\u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_ inline\"\u003eEndpointMetrics\u003c/span\u003e {\n    \n    \u003cspan class=\"hljs-comment inline\"\u003e// 核心组件：Micrometer的度量注册表\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003efinal\u003c/span\u003e MeterRegistry meterRegistry;\n    \n    \u003cspan class=\"hljs-comment inline\"\u003e// 线程安全的计数器缓存：避免重复创建Counter\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003efinal\u003c/span\u003e Map\u0026lt;String, Counter\u0026gt; endpointCounters = \u003cspan class=\"hljs-keyword inline\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_ inline\"\u003eConcurrentHashMap\u003c/span\u003e\u0026lt;\u0026gt;();\n    \n    \u003cspan class=\"hljs-comment inline\"\u003e// 原子操作的在线用户计数器\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003efinal\u003c/span\u003e \u003cspan class=\"hljs-type inline\"\u003eAtomicInteger\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eonlineUsers\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_ inline\"\u003eAtomicInteger\u003c/span\u003e(\u003cspan class=\"hljs-number inline\"\u003e0\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 构造函数：注册在线用户数的Gauge指标\n     * \n     * Gauge vs Counter 的区别：\n     * - Gauge：瞬时值指标，如当前在线用户数、内存使用量\n     * - Counter：累加指标，如API调用次数、错误数量\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-title function_ inline\"\u003eEndpointMetrics\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e(MeterRegistry meterRegistry)\u003c/span\u003e {\n        \u003cspan class=\"hljs-built_in inline\"\u003ethis\u003c/span\u003e.meterRegistry = meterRegistry;\n        \n        \u003cspan class=\"hljs-comment inline\"\u003e// 注册Gauge：实时反映在线用户数\u003c/span\u003e\n        Gauge.builder(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;acot.online.users\u0026quot;\u003c/span\u003e, onlineUsers::get)  \u003cspan class=\"hljs-comment inline\"\u003e// 引用原子类的get方法\u003c/span\u003e\n                .description(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;当前在线用户数\u0026quot;\u003c/span\u003e)\n                .register(meterRegistry);\n    }\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 递增端点调用计数：核心的线程安全算法\n     * \n     * \u003cspan class=\"hljs-doctag inline\"\u003e@param\u003c/span\u003e controllerName 控制器名称\n     * \u003cspan class=\"hljs-doctag inline\"\u003e@param\u003c/span\u003e methodName 方法名称\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title function_ inline\"\u003eincrementEndpointCount\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e(String controllerName, String methodName)\u003c/span\u003e {\n        \u003cspan class=\"hljs-comment inline\"\u003e// 构造端点标识符\u003c/span\u003e\n        \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eendpoint\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e controllerName + \u003cspan class=\"hljs-string inline\"\u003e\u0026quot;.\u0026quot;\u003c/span\u003e + methodName;\n        \n        \u003cspan class=\"hljs-comment inline\"\u003e// 关键算法：computeIfAbsent的原子性保证\u003c/span\u003e\n        \u003cspan class=\"hljs-type inline\"\u003eCounter\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003ecounter\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e endpointCounters.computeIfAbsent(endpoint, k -\u0026gt;\n                Counter.builder(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;acot.endpoint.calls\u0026quot;\u003c/span\u003e)\n                        \u003cspan class=\"hljs-comment inline\"\u003e// 多维度标签：支持Prometheus的复杂查询\u003c/span\u003e\n                        .tags(Arrays.asList(\n                                Tag.of(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;controller\u0026quot;\u003c/span\u003e, controllerName),  \u003cspan class=\"hljs-comment inline\"\u003e// 按控制器分组\u003c/span\u003e\n                                Tag.of(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;method\u0026quot;\u003c/span\u003e, methodName)))         \u003cspan class=\"hljs-comment inline\"\u003e// 按方法分组\u003c/span\u003e\n                        .description(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;端点调用次数统计\u0026quot;\u003c/span\u003e)\n                        .register(meterRegistry));  \u003cspan class=\"hljs-comment inline\"\u003e// 注册到Micrometer\u003c/span\u003e\n        \n        \u003cspan class=\"hljs-comment inline\"\u003e// 原子递增操作\u003c/span\u003e\n        counter.increment();\n    }\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 用户登录：原子递增在线用户数\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title function_ inline\"\u003euserLoggedIn\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e()\u003c/span\u003e {\n        onlineUsers.incrementAndGet();  \u003cspan class=\"hljs-comment inline\"\u003e// 原子操作：current + 1\u003c/span\u003e\n    }\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 用户登出：带边界检查的原子递减\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title function_ inline\"\u003euserLoggedOut\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e()\u003c/span\u003e {\n        \u003cspan class=\"hljs-comment inline\"\u003e// 防止负数的原子操作：max(0, current - 1)\u003c/span\u003e\n        onlineUsers.updateAndGet(current -\u0026gt; Math.max(\u003cspan class=\"hljs-number inline\"\u003e0\u003c/span\u003e, current - \u003cspan class=\"hljs-number inline\"\u003e1\u003c/span\u003e));\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003e为什么选择ConcurrentHashMap + computeIfAbsent？\u003c/strong\u003e\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e这种组合的优势在于：\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e错误的做法：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"java\" data-code=\"%2F%2F%20%E2%9D%8C%20%E5%AD%98%E5%9C%A8%E7%AB%9E%E6%80%81%E6%9D%A1%E4%BB%B6%E7%9A%84%E9%94%99%E8%AF%AF%E5%AE%9E%E7%8E%B0%0Aif%20(!endpointCounters.containsKey(endpoint))%20%7B%0A%2F%2F%20%E9%97%AE%E9%A2%98%EF%BC%9A%E4%B8%A4%E4%B8%AA%E7%BA%BF%E7%A8%8B%E5%8F%AF%E8%83%BD%E5%90%8C%E6%97%B6%E6%89%A7%E8%A1%8C%E5%88%B0%E8%BF%99%E9%87%8C%0AendpointCounters.put(endpoint%2C%20createNewCounter(endpoint))%3B%0A%7D%0ACounter%20counter%20%3D%20endpointCounters.get(endpoint)%3B\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ejava\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"hljs-comment inline\"\u003e// ❌ 存在竞态条件的错误实现\u003c/span\u003e\n\u003cspan class=\"hljs-keyword inline\"\u003eif\u003c/span\u003e (!endpointCounters.containsKey(endpoint)) {\n    \u003cspan class=\"hljs-comment inline\"\u003e// 问题：两个线程可能同时执行到这里\u003c/span\u003e\n    endpointCounters.put(endpoint, createNewCounter(endpoint));\n}\n\u003cspan class=\"hljs-type inline\"\u003eCounter\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003ecounter\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e endpointCounters.get(endpoint);\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e正确的做法：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"java\" data-code=\"%2F%2F%20%E2%9C%85%20%E5%8E%9F%E5%AD%90%E6%80%A7%E6%93%8D%E4%BD%9C%EF%BC%8C%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%0ACounter%20counter%20%3D%20endpointCounters.computeIfAbsent(endpoint%2C%20k%20-%3E%20createNewCounter(k))%3B\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ejava\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"hljs-comment inline\"\u003e// ✅ 原子性操作，线程安全\u003c/span\u003e\n\u003cspan class=\"hljs-type inline\"\u003eCounter\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003ecounter\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e endpointCounters.computeIfAbsent(endpoint, k -\u0026gt; createNewCounter(k));\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003ecomputeIfAbsent的时间复杂度分析\u003c/strong\u003e：\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e在理想情况下：\u003c/p\u003e\n\u003cul class=\"list-disc list-inside mb-4 pl-6 space-y-2\"\u003e\n\u003cli class=\"text-foreground leading-relaxed\"\u003e首次访问：\u003cspan class=\"katex inline\"\u003e\u003cspan class=\"katex-mathml inline\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003eO\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e(\u003c/mo\u003e\u003cmn\u003e1\u003c/mn\u003e\u003cmo stretchy=\"false\"\u003e)\u003c/mo\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eO(1)\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html inline\" aria-hidden=\"true\" style=\"display:none\"\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:1em;vertical-align:-0.25em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.02778em;\"\u003eO\u003c/span\u003e\u003cspan class=\"mopen inline\"\u003e(\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e1\u003c/span\u003e\u003cspan class=\"mclose inline\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e 创建 + \u003cspan class=\"katex inline\"\u003e\u003cspan class=\"katex-mathml inline\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003eO\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e(\u003c/mo\u003e\u003cmn\u003e1\u003c/mn\u003e\u003cmo stretchy=\"false\"\u003e)\u003c/mo\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eO(1)\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html inline\" aria-hidden=\"true\" style=\"display:none\"\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:1em;vertical-align:-0.25em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.02778em;\"\u003eO\u003c/span\u003e\u003cspan class=\"mopen inline\"\u003e(\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e1\u003c/span\u003e\u003cspan class=\"mclose inline\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e 插入 = \u003cspan class=\"katex inline\"\u003e\u003cspan class=\"katex-mathml inline\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003eO\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e(\u003c/mo\u003e\u003cmn\u003e1\u003c/mn\u003e\u003cmo stretchy=\"false\"\u003e)\u003c/mo\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eO(1)\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html inline\" aria-hidden=\"true\" style=\"display:none\"\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:1em;vertical-align:-0.25em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.02778em;\"\u003eO\u003c/span\u003e\u003cspan class=\"mopen inline\"\u003e(\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e1\u003c/span\u003e\u003cspan class=\"mclose inline\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/li\u003e\n\u003cli class=\"text-foreground leading-relaxed\"\u003e后续访问：\u003cspan class=\"katex inline\"\u003e\u003cspan class=\"katex-mathml inline\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003eO\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e(\u003c/mo\u003e\u003cmn\u003e1\u003c/mn\u003e\u003cmo stretchy=\"false\"\u003e)\u003c/mo\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eO(1)\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html inline\" aria-hidden=\"true\" style=\"display:none\"\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:1em;vertical-align:-0.25em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.02778em;\"\u003eO\u003c/span\u003e\u003cspan class=\"mopen inline\"\u003e(\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e1\u003c/span\u003e\u003cspan class=\"mclose inline\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e 查找\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"在线用户统计的双重保障机制\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#在线用户统计的双重保障机制\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to 在线用户统计的双重保障机制\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            在线用户统计的双重保障机制\n        \u003c/h3\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003eACOT实现了一套\u0026quot;双保险\u0026quot;的用户统计系统：\u003c/p\u003e\n\u003cdiv class=\"mermaid block\" id=\"mermaid-1767525094481-wkdc84c\"\u003esequenceDiagram\n    participant User as 用户\n    participant Security as Spring Security\n    participant Session as HTTP Session\n    participant Listener1 as UserActivityMetricsConfig\n    participant Listener2 as SessionEventListener\n    participant Metrics as EndpointMetrics\n\n    User-\u003e\u003eSecurity: 登录\n    Security-\u003e\u003eListener1: AuthenticationSuccessEvent\n    Listener1-\u003e\u003eMetrics: userLoggedIn() [+1]\n    \n    User-\u003e\u003eSecurity: 正常登出\n    Security-\u003e\u003eListener1: LogoutSuccessEvent\n    Listener1-\u003e\u003eMetrics: userLoggedOut() [-1]\n    \n    Note over Session: 会话超时或异常断开\n    Session-\u003e\u003eListener2: sessionDestroyed\n    Listener2-\u003e\u003eMetrics: userLoggedOut() [-1]\u003c/div\u003e\n\u003ch3 id=\"useractivitymetricsconfig：spring-security事件处理\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#useractivitymetricsconfig：spring-security事件处理\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to UserActivityMetricsConfig：Spring Security事件处理\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            UserActivityMetricsConfig：Spring Security事件处理\n        \u003c/h3\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"java\" data-code=\"%40Configuration%0A%40RequiredArgsConstructor%0A%40Slf4j%0Apublic%20class%20UserActivityMetricsConfig%20%7B%0Aprivate%20final%20EndpointMetrics%20endpointMetrics%3B%0A%2F**%0A*%20%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%0A*%0A*%20Spring%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BC%98%E5%8A%BF%EF%BC%9A%0A*%20-%20%E6%9D%BE%E8%80%A6%E5%90%88%EF%BC%9A%E7%9B%91%E5%90%AC%E5%99%A8%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%8F%91%E5%B8%83%E8%80%85%E6%97%A0%E7%9B%B4%E6%8E%A5%E4%BE%9D%E8%B5%96%0A*%20-%20%E5%BC%82%E6%AD%A5%E6%94%AF%E6%8C%81%EF%BC%9A%E5%8F%AF%E9%85%8D%E7%BD%AE%E4%B8%BA%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%0A*%20-%20%E5%A4%9A%E7%9B%91%E5%90%AC%E5%99%A8%EF%BC%9A%E5%90%8C%E4%B8%80%E4%BA%8B%E4%BB%B6%E5%8F%AF%E4%BB%A5%E6%9C%89%E5%A4%9A%E4%B8%AA%E7%9B%91%E5%90%AC%E5%99%A8%0A*%2F%0A%40EventListener%0Apublic%20void%20handleAuthenticationSuccess(AuthenticationSuccessEvent%20event)%20%7B%0AAuthentication%20authentication%20%3D%20event.getAuthentication()%3B%0AString%20username%20%3D%20authentication.getName()%3B%0Alog.debug(%22%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%3A%20%7B%7D%22%2C%20username)%3B%0A%2F%2F%20%E9%80%92%E5%A2%9E%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0AendpointMetrics.userLoggedIn()%3B%0A%7D%0A%2F**%0A*%20%E7%99%BB%E5%87%BA%E6%88%90%E5%8A%9F%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%0A*%0A*%20%E6%B3%A8%E6%84%8F%EF%BC%9A%E6%9F%90%E4%BA%9B%E7%99%BB%E5%87%BA%E5%9C%BA%E6%99%AF%E4%B8%8Bauthentication%E5%8F%AF%E8%83%BD%E4%B8%BAnull%0A*%20%E4%BE%8B%E5%A6%82%EF%BC%9Asession%E8%B6%85%E6%97%B6%E5%90%8E%E7%9A%84%E4%B8%BB%E5%8A%A8%E7%99%BB%E5%87%BA%0A*%2F%0A%40EventListener%0Apublic%20void%20handleLogout(LogoutSuccessEvent%20event)%20%7B%0AAuthentication%20authentication%20%3D%20event.getAuthentication()%3B%0Aif%20(authentication%20!%3D%20null)%20%7B%0AString%20username%20%3D%20authentication.getName()%3B%0Alog.debug(%22%E7%94%A8%E6%88%B7%E7%99%BB%E5%87%BA%3A%20%7B%7D%22%2C%20username)%3B%0A%7D%0A%2F%2F%20%E9%80%92%E5%87%8F%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%EF%BC%88%E6%97%A0%E8%AE%BAauthentication%E6%98%AF%E5%90%A6%E4%B8%BAnull%EF%BC%89%0AendpointMetrics.userLoggedOut()%3B%0A%7D%0A%2F**%0A*%20%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81%E6%88%90%E5%8A%9F%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%9A%E9%81%BF%E5%85%8D%E9%87%8D%E5%A4%8D%E7%BB%9F%E8%AE%A1%0A*%0A*%20%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%BF%99%E4%B8%AABean%EF%BC%9F%0A*%20-%20%E6%9F%90%E4%BA%9B%E6%83%85%E5%86%B5%E4%B8%8B%E5%8F%AF%E8%83%BD%E9%9C%80%E8%A6%81form-based%E7%99%BB%E5%BD%95%0A*%20-%20%E8%BF%99%E4%B8%AAhandler%E5%8F%AA%E8%B4%9F%E8%B4%A3%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%EF%BC%8C%E4%B8%8D%E9%87%8D%E5%A4%8D%E7%BB%9F%E8%AE%A1%E6%8C%87%E6%A0%87%0A*%2F%0A%40Bean%0Apublic%20AuthenticationSuccessHandler%20loggingAuthenticationSuccessHandler()%20%7B%0Areturn%20(request%2C%20response%2C%20authentication)%20-%3E%20%7B%0AString%20username%20%3D%20authentication.getName()%3B%0Alog.debug(%22%E8%A1%A8%E5%8D%95%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%3A%20%7B%7D%22%2C%20username)%3B%0A%2F%2F%20%E6%B3%A8%E6%84%8F%EF%BC%9A%E8%BF%99%E9%87%8C%E4%B8%8D%E8%B0%83%E7%94%A8endpointMetrics.userLoggedIn()%0A%2F%2F%20%E5%9B%A0%E4%B8%BA%40EventListener%E5%B7%B2%E7%BB%8F%E5%A4%84%E7%90%86%E4%BA%86%E7%BB%9F%E8%AE%A1%0A%7D%3B%0A%7D%0A%2F**%0A*%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%87%BA%E6%88%90%E5%8A%9F%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%9A%E9%81%BF%E5%85%8D%E9%87%8D%E5%A4%8D%E7%BB%9F%E8%AE%A1%0A*%2F%0A%40Bean%0Apublic%20LogoutSuccessHandler%20loggingLogoutSuccessHandler()%20%7B%0Areturn%20(request%2C%20response%2C%20authentication)%20-%3E%20%7B%0Aif%20(authentication%20!%3D%20null)%20%7B%0AString%20username%20%3D%20authentication.getName()%3B%0Alog.debug(%22%E8%A1%A8%E5%8D%95%E7%99%BB%E5%87%BA%E6%88%90%E5%8A%9F%3A%20%7B%7D%22%2C%20username)%3B%0A%7D%0A%2F%2F%20%E6%B3%A8%E6%84%8F%EF%BC%9A%E8%BF%99%E9%87%8C%E4%B8%8D%E8%B0%83%E7%94%A8endpointMetrics.userLoggedOut()%0A%2F%2F%20%E5%9B%A0%E4%B8%BA%40EventListener%E5%B7%B2%E7%BB%8F%E5%A4%84%E7%90%86%E4%BA%86%E7%BB%9F%E8%AE%A1%0A%7D%3B%0A%7D%0A%7D\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ejava\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"hljs-meta inline\"\u003e@Configuration\u003c/span\u003e\n\u003cspan class=\"hljs-meta inline\"\u003e@RequiredArgsConstructor\u003c/span\u003e\n\u003cspan class=\"hljs-meta inline\"\u003e@Slf4j\u003c/span\u003e\n\u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_ inline\"\u003eUserActivityMetricsConfig\u003c/span\u003e {\n\n    \u003cspan class=\"hljs-keyword inline\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003efinal\u003c/span\u003e EndpointMetrics endpointMetrics;\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 登录成功事件监听\n     * \n     * Spring事件机制的优势：\n     * - 松耦合：监听器和事件发布者无直接依赖\n     * - 异步支持：可配置为异步处理\n     * - 多监听器：同一事件可以有多个监听器\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-meta inline\"\u003e@EventListener\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title function_ inline\"\u003ehandleAuthenticationSuccess\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e(AuthenticationSuccessEvent event)\u003c/span\u003e {\n        \u003cspan class=\"hljs-type inline\"\u003eAuthentication\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eauthentication\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e event.getAuthentication();\n        \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eusername\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e authentication.getName();\n        \n        log.debug(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;用户登录: {}\u0026quot;\u003c/span\u003e, username);\n        \n        \u003cspan class=\"hljs-comment inline\"\u003e// 递增在线用户数\u003c/span\u003e\n        endpointMetrics.userLoggedIn();\n    }\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 登出成功事件监听\n     * \n     * 注意：某些登出场景下authentication可能为null\n     * 例如：session超时后的主动登出\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-meta inline\"\u003e@EventListener\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title function_ inline\"\u003ehandleLogout\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e(LogoutSuccessEvent event)\u003c/span\u003e {\n        \u003cspan class=\"hljs-type inline\"\u003eAuthentication\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eauthentication\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e event.getAuthentication();\n        \n        \u003cspan class=\"hljs-keyword inline\"\u003eif\u003c/span\u003e (authentication != \u003cspan class=\"hljs-literal inline\"\u003enull\u003c/span\u003e) {\n            \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eusername\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e authentication.getName();\n            log.debug(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;用户登出: {}\u0026quot;\u003c/span\u003e, username);\n        }\n        \n        \u003cspan class=\"hljs-comment inline\"\u003e// 递减在线用户数（无论authentication是否为null）\u003c/span\u003e\n        endpointMetrics.userLoggedOut();\n    }\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 自定义认证成功处理器：避免重复统计\n     * \n     * 为什么需要这个Bean？\n     * - 某些情况下可能需要form-based登录\n     * - 这个handler只负责日志记录，不重复统计指标\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-meta inline\"\u003e@Bean\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e AuthenticationSuccessHandler \u003cspan class=\"hljs-title function_ inline\"\u003eloggingAuthenticationSuccessHandler\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e()\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword inline\"\u003ereturn\u003c/span\u003e (request, response, authentication) -\u0026gt; {\n            \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eusername\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e authentication.getName();\n            log.debug(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;表单登录成功: {}\u0026quot;\u003c/span\u003e, username);\n            \u003cspan class=\"hljs-comment inline\"\u003e// 注意：这里不调用endpointMetrics.userLoggedIn()\u003c/span\u003e\n            \u003cspan class=\"hljs-comment inline\"\u003e// 因为@EventListener已经处理了统计\u003c/span\u003e\n        };\n    }\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 自定义登出成功处理器：避免重复统计\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-meta inline\"\u003e@Bean\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e LogoutSuccessHandler \u003cspan class=\"hljs-title function_ inline\"\u003eloggingLogoutSuccessHandler\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e()\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword inline\"\u003ereturn\u003c/span\u003e (request, response, authentication) -\u0026gt; {\n            \u003cspan class=\"hljs-keyword inline\"\u003eif\u003c/span\u003e (authentication != \u003cspan class=\"hljs-literal inline\"\u003enull\u003c/span\u003e) {\n                \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eusername\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e authentication.getName();\n                log.debug(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;表单登出成功: {}\u0026quot;\u003c/span\u003e, username);\n            }\n            \u003cspan class=\"hljs-comment inline\"\u003e// 注意：这里不调用endpointMetrics.userLoggedOut()\u003c/span\u003e\n            \u003cspan class=\"hljs-comment inline\"\u003e// 因为@EventListener已经处理了统计\u003c/span\u003e\n        };\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003ch3 id=\"sessioneventlistener：会话生命周期的兜底机制\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#sessioneventlistener：会话生命周期的兜底机制\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to SessionEventListener：会话生命周期的兜底机制\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            SessionEventListener：会话生命周期的兜底机制\n        \u003c/h3\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"java\" data-code=\"%40Component%0A%40Slf4j%0A%40RequiredArgsConstructor%0Apublic%20class%20SessionEventListener%20implements%20HttpSessionListener%20%7B%0Aprivate%20final%20EndpointMetrics%20endpointMetrics%3B%0A%2F**%0A*%20%E4%BC%9A%E8%AF%9D%E9%94%80%E6%AF%81%E7%9B%91%E5%90%AC%EF%BC%9A%E5%A4%84%E7%90%86%22%E9%9D%99%E9%BB%98%E7%A6%BB%E5%BC%80%22%E7%9A%84%E7%94%A8%E6%88%B7%0A*%0A*%20%E4%BC%9A%E8%AF%9D%E9%94%80%E6%AF%81%E7%9A%84%E8%A7%A6%E5%8F%91%E5%9C%BA%E6%99%AF%EF%BC%9A%0A*%201.%20%E4%BC%9A%E8%AF%9D%E8%B6%85%E6%97%B6%EF%BC%88%E6%9C%80%E5%B8%B8%E8%A7%81%EF%BC%89%0A*%202.%20%E7%94%A8%E6%88%B7%E4%B8%BB%E5%8A%A8%E5%85%B3%E9%97%AD%E6%B5%8F%E8%A7%88%E5%99%A8%0A*%203.%20%E8%B0%83%E7%94%A8session.invalidate()%0A*%204.%20%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%85%B3%E9%97%AD%0A*%2F%0A%40Override%0Apublic%20void%20sessionDestroyed(HttpSessionEvent%20se)%20%7B%0AString%20sessionId%20%3D%20se.getSession().getId()%3B%0Alog.debug(%22%E4%BC%9A%E8%AF%9D%E9%94%80%E6%AF%81%3A%20%7B%7D%22%2C%20sessionId)%3B%0A%2F%2F%20%E5%85%9C%E5%BA%95%E6%9C%BA%E5%88%B6%EF%BC%9A%E7%A1%AE%E4%BF%9D%E7%94%A8%E6%88%B7%E6%95%B0%E7%BB%9F%E8%AE%A1%E5%87%86%E7%A1%AE%0AendpointMetrics.userLoggedOut()%3B%0A%7D%0A%2F%2F%20%E6%B3%A8%E6%84%8F%EF%BC%9A%E8%BF%99%E9%87%8C%E6%B2%A1%E6%9C%89%E5%AE%9E%E7%8E%B0sessionCreated%E6%96%B9%E6%B3%95%0A%2F%2F%20%E5%9B%A0%E4%B8%BAsession%E5%88%9B%E5%BB%BA%E4%B8%8D%E7%AD%89%E4%BA%8E%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%0A%2F%2F%20%E5%8C%BF%E5%90%8D%E7%94%A8%E6%88%B7%E4%B9%9F%E4%BC%9A%E5%88%9B%E5%BB%BAsession%0A%7D\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ejava\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"hljs-meta inline\"\u003e@Component\u003c/span\u003e\n\u003cspan class=\"hljs-meta inline\"\u003e@Slf4j\u003c/span\u003e\n\u003cspan class=\"hljs-meta inline\"\u003e@RequiredArgsConstructor\u003c/span\u003e\n\u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_ inline\"\u003eSessionEventListener\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003eimplements\u003c/span\u003e \u003cspan class=\"hljs-title class_ inline\"\u003eHttpSessionListener\u003c/span\u003e {\n\n    \u003cspan class=\"hljs-keyword inline\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003efinal\u003c/span\u003e EndpointMetrics endpointMetrics;\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 会话销毁监听：处理\u0026quot;静默离开\u0026quot;的用户\n     * \n     * 会话销毁的触发场景：\n     * 1. 会话超时（最常见）\n     * 2. 用户主动关闭浏览器\n     * 3. 调用session.invalidate()\n     * 4. 应用服务器关闭\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-meta inline\"\u003e@Override\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title function_ inline\"\u003esessionDestroyed\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e(HttpSessionEvent se)\u003c/span\u003e {\n        \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003esessionId\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e se.getSession().getId();\n        log.debug(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;会话销毁: {}\u0026quot;\u003c/span\u003e, sessionId);\n        \n        \u003cspan class=\"hljs-comment inline\"\u003e// 兜底机制：确保用户数统计准确\u003c/span\u003e\n        endpointMetrics.userLoggedOut();\n    }\n\n    \u003cspan class=\"hljs-comment inline\"\u003e// 注意：这里没有实现sessionCreated方法\u003c/span\u003e\n    \u003cspan class=\"hljs-comment inline\"\u003e// 因为session创建不等于用户登录\u003c/span\u003e\n    \u003cspan class=\"hljs-comment inline\"\u003e// 匿名用户也会创建session\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003e为什么需要SessionEventListener？\u003c/strong\u003e\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003eSpring Security事件监听有一个盲区：用户\u0026quot;静默离开\u0026quot;。\u003c/p\u003e\n\u003ctable class=\"w-full border-collapse mb-4 shadow-sm rounded-lg overflow-hidden\"\u003e\n\u003cthead class=\"bg-surface\"\u003e\n\u003ctr class=\"border-b border-gray-200\"\u003e\u003cth class=\"px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface\"\u003e离开方式\u003c/th\u003e\u003cth class=\"px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface\"\u003eSpring Security事件\u003c/th\u003e\u003cth class=\"px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface\"\u003eSession事件\u003c/th\u003e\u003cth class=\"px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface\"\u003e统计准确性\u003c/th\u003e\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody class=\"bg-background divide-y divide-gray-200\"\u003e\n\u003ctr class=\"border-b border-gray-200\"\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e正常登出\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e✅ LogoutSuccessEvent\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e✅ sessionDestroyed\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e✅ 双重保障\u003c/td\u003e\u003c/tr\u003e\n\u003ctr class=\"border-b border-gray-200\"\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e关闭浏览器\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e❌ 无事件\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e✅ sessionDestroyed (延迟)\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e✅ 兜底机制\u003c/td\u003e\u003c/tr\u003e\n\u003ctr class=\"border-b border-gray-200\"\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e网络断开\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e❌ 无事件\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e✅ sessionDestroyed (延迟)\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e✅ 兜底机制\u003c/td\u003e\u003c/tr\u003e\n\u003ctr class=\"border-b border-gray-200\"\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e会话超时\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e❌ 无事件\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e✅ sessionDestroyed\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e✅ 兜底机制\u003c/td\u003e\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch2 id=\"prometheus篇：时序数据库\" class=\"group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight\"\u003e\n            \u003ca href=\"#prometheus篇：时序数据库\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to Prometheus篇：时序数据库\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            Prometheus篇：时序数据库\n        \u003c/h2\u003e\n\u003ch3 id=\"为什么选择prometheus？\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#为什么选择prometheus？\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to 为什么选择Prometheus？\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            为什么选择Prometheus？\n        \u003c/h3\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003ePrometheus不仅仅是一个监控系统，它更像是一个\u0026quot;时间魔法师\u0026quot;，能够将瞬息万变的系统状态记录成可查询、可分析的时序数据。\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003ePrometheus的核心优势\u003c/strong\u003e：\u003c/p\u003e\n\u003col class=\"list-decimal list-inside mb-4 pl-6 space-y-2\"\u003e\n\u003cli class=\"text-foreground leading-relaxed\"\u003e\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003ePull模式的优雅性\u003c/strong\u003e：\u003c/p\u003e\n\u003cdiv class=\"mermaid block\" id=\"mermaid-1767525094481-2m7irsa\"\u003egraph LR\n    A[Prometheus Server] --\u003e|Pull每15秒| B[ACOT应用1:8080/actuator/prometheus]\n    A --\u003e|Pull每15秒| C[ACOT应用2:8081/actuator/prometheus]\n    A --\u003e|Pull每15秒| D[其他服务:9090/metrics]\u003c/div\u003e\u003c/li\u003e\n\u003cli class=\"text-foreground leading-relaxed\"\u003e\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003e多维度标签系统\u003c/strong\u003e：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"promql\" data-code=\"%23%20%E6%9F%A5%E8%AF%A2%E7%89%B9%E5%AE%9A%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%0Aacot_endpoint_calls_total%7Bcontroller%3D%22UserController%22%7D%0A%23%20%E6%9F%A5%E8%AF%A2%E7%89%B9%E5%AE%9A%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%0Aacot_endpoint_calls_total%7Bmethod%3D%22getUserInfo%22%7D%0A%23%20%E6%9F%A5%E8%AF%A2%E7%89%B9%E5%AE%9A%E6%8E%A7%E5%88%B6%E5%99%A8%2B%E6%96%B9%E6%B3%95%E7%9A%84%E7%BB%84%E5%90%88%0Aacot_endpoint_calls_total%7Bcontroller%3D%22UserController%22%2C%20method%3D%22getUserInfo%22%7D\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003epromql\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-promql\"\u003e\u003cspan class=\"hljs-comment inline\"\u003e# 查询特定控制器的调用次数\u003c/span\u003e\nacot_endpoint_calls_total{\u003cspan class=\"hljs-attribute inline\"\u003econtroller\u003c/span\u003e=\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;UserController\u0026quot;\u003c/span\u003e}\n\n\u003cspan class=\"hljs-comment inline\"\u003e# 查询特定方法的调用次数\u003c/span\u003e\nacot_endpoint_calls_total{\u003cspan class=\"hljs-attribute inline\"\u003emethod\u003c/span\u003e=\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;getUserInfo\u0026quot;\u003c/span\u003e}\n\n\u003cspan class=\"hljs-comment inline\"\u003e# 查询特定控制器+方法的组合\u003c/span\u003e\nacot_endpoint_calls_total{\u003cspan class=\"hljs-attribute inline\"\u003econtroller\u003c/span\u003e=\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;UserController\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-attribute inline\"\u003emethod\u003c/span\u003e=\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;getUserInfo\u0026quot;\u003c/span\u003e}\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \u003c/li\u003e\n\u003cli class=\"text-foreground leading-relaxed\"\u003e\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003e强大的查询语言PromQL\u003c/strong\u003e：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"promql\" data-code=\"%23%20%E6%9F%A5%E8%AF%A2%E8%BF%87%E5%8E%BB5%E5%88%86%E9%92%9F%E7%9A%84%E5%B9%B3%E5%9D%87%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0Aavg_over_time(acot_online_users%5B5m%5D)%0A%23%20%E6%9F%A5%E8%AF%A2API%E8%B0%83%E7%94%A8%E5%A2%9E%E9%95%BF%E7%8E%87%0Arate(acot_endpoint_calls_total%5B5m%5D)%0A%23%20%E6%9F%A5%E8%AF%A2%E6%9C%80%E7%B9%81%E5%BF%99%E7%9A%84%E7%AB%AF%E7%82%B9%0Atopk(10%2C%20rate(acot_endpoint_calls_total%5B1h%5D))\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003epromql\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-promql\"\u003e\u003cspan class=\"hljs-comment inline\"\u003e# 查询过去5分钟的平均在线用户数\u003c/span\u003e\n\u003cspan class=\"hljs-attribute inline\"\u003eavg_over_time\u003c/span\u003e(acot_online_users[\u003cspan class=\"hljs-number inline\"\u003e5\u003c/span\u003em])\n\n\u003cspan class=\"hljs-comment inline\"\u003e# 查询API调用增长率\u003c/span\u003e\n\u003cspan class=\"hljs-attribute inline\"\u003erate\u003c/span\u003e(acot_endpoint_calls_total[\u003cspan class=\"hljs-number inline\"\u003e5\u003c/span\u003em])\n\n\u003cspan class=\"hljs-comment inline\"\u003e# 查询最繁忙的端点\u003c/span\u003e\n\u003cspan class=\"hljs-attribute inline\"\u003etopk\u003c/span\u003e(\u003cspan class=\"hljs-number inline\"\u003e10\u003c/span\u003e, rate(acot_endpoint_calls_total[\u003cspan class=\"hljs-number inline\"\u003e1\u003c/span\u003eh]))\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"时序数据模型：时间戳设计根本\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#时序数据模型：时间戳设计根本\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to 时序数据模型：时间戳设计根本\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            时序数据模型：时间戳设计根本\n        \u003c/h3\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003ePrometheus的数据模型可以用数学公式表示：\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cspan class=\"katex-display inline\"\u003e\u003cspan class=\"katex inline\"\u003e\u003cspan class=\"katex-mathml inline\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003eM\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003er\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmi\u003eM\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003er\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmi\u003eN\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e{\u003c/mo\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003eb\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmsub\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmi\u003ev\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmi\u003eu\u003c/mi\u003e\u003cmsub\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003eb\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmsub\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msub\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmi\u003ev\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmi\u003eu\u003c/mi\u003e\u003cmsub\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msub\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmi mathvariant=\"normal\"\u003e.\u003c/mi\u003e\u003cmi mathvariant=\"normal\"\u003e.\u003c/mi\u003e\u003cmi mathvariant=\"normal\"\u003e.\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e}\u003c/mo\u003e\u003cmo\u003e→\u003c/mo\u003e\u003cmo stretchy=\"false\"\u003e(\u003c/mo\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003es\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ep\u003c/mi\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmi\u003ev\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmi\u003eu\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e)\u003c/mo\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eMetric = MetricName\\{label_1=value_1, label_2=value_2, ...\\} \\rightarrow (timestamp, value)\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html inline\" aria-hidden=\"true\" style=\"display:none\"\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:0.6833em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.10903em;\"\u003eM\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ee\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.02778em;\"\u003er\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ec\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel inline\"\u003e=\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:1em;vertical-align:-0.25em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.10903em;\"\u003eM\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ee\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.02778em;\"\u003er\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ec\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.10903em;\"\u003eN\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003eam\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ee\u003c/span\u003e\u003cspan class=\"mopen inline\"\u003e{\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003eab\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ee\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel inline\"\u003e=\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:0.8889em;vertical-align:-0.1944em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.03588em;\"\u003ev\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ea\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003eu\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\"\u003ee\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mpunct inline\"\u003e,\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.1667em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003eab\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ee\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel inline\"\u003e=\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:1em;vertical-align:-0.25em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.03588em;\"\u003ev\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ea\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003eu\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\"\u003ee\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mpunct inline\"\u003e,\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.1667em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e...\u003c/span\u003e\u003cspan class=\"mclose inline\"\u003e}\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel inline\"\u003e→\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:1em;vertical-align:-0.25em;\"\u003e\u003c/span\u003e\u003cspan class=\"mopen inline\"\u003e(\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003eim\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ees\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003eam\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ep\u003c/span\u003e\u003cspan class=\"mpunct inline\"\u003e,\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.1667em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.03588em;\"\u003ev\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ea\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003eu\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ee\u003c/span\u003e\u003cspan class=\"mclose inline\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e例如：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"\" data-code=\"acot_endpoint_calls_total%7Bcontroller%3D%22UserController%22%2C%20method%3D%22getUserInfo%22%7D%2042%20%401234567890\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ecode\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode\u003eacot_endpoint_calls_total{\u003cspan class=\"hljs-attribute inline\"\u003econtroller\u003c/span\u003e=\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;UserController\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-attribute inline\"\u003emethod\u003c/span\u003e=\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;getUserInfo\u0026quot;\u003c/span\u003e} 42 @1234567890\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003e数据类型的选择策略\u003c/strong\u003e：\u003c/p\u003e\n\u003ctable class=\"w-full border-collapse mb-4 shadow-sm rounded-lg overflow-hidden\"\u003e\n\u003cthead class=\"bg-surface\"\u003e\n\u003ctr class=\"border-b border-gray-200\"\u003e\u003cth class=\"px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface\"\u003e指标类型\u003c/th\u003e\u003cth class=\"px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface\"\u003e适用场景\u003c/th\u003e\u003cth class=\"px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface\"\u003eACOT中的应用\u003c/th\u003e\u003cth class=\"px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface\"\u003e数学特性\u003c/th\u003e\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody class=\"bg-background divide-y divide-gray-200\"\u003e\n\u003ctr class=\"border-b border-gray-200\"\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003eCounter\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e单调递增\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003eAPI调用次数\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e\u003cspan class=\"katex inline\"\u003e\u003cspan class=\"katex-mathml inline\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003ef\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e(\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msub\u003e\u003cmo stretchy=\"false\"\u003e)\u003c/mo\u003e\u003cmo\u003e≥\u003c/mo\u003e\u003cmi\u003ef\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e(\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003cmo stretchy=\"false\"\u003e)\u003c/mo\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003ef(t_2) \\geq f(t_1)\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html inline\" aria-hidden=\"true\" style=\"display:none\"\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:1em;vertical-align:-0.25em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.10764em;\"\u003ef\u003c/span\u003e\u003cspan class=\"mopen inline\"\u003e(\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mclose inline\"\u003e)\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel inline\"\u003e≥\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:1em;vertical-align:-0.25em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.10764em;\"\u003ef\u003c/span\u003e\u003cspan class=\"mopen inline\"\u003e(\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mclose inline\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e 当 \u003cspan class=\"katex inline\"\u003e\u003cspan class=\"katex-mathml inline\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsub\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msub\u003e\u003cmo\u003e\u0026gt;\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003et_2 \u0026gt; t_1\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html inline\" aria-hidden=\"true\" style=\"display:none\"\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:0.7651em;vertical-align:-0.15em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel inline\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:0.7651em;vertical-align:-0.15em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/td\u003e\u003c/tr\u003e\n\u003ctr class=\"border-b border-gray-200\"\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003eGauge\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e瞬时值\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e在线用户数\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e\u003cspan class=\"katex inline\"\u003e\u003cspan class=\"katex-mathml inline\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003ef\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e(\u003c/mo\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e)\u003c/mo\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003ef(t)\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html inline\" aria-hidden=\"true\" style=\"display:none\"\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:1em;vertical-align:-0.25em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.10764em;\"\u003ef\u003c/span\u003e\u003cspan class=\"mopen inline\"\u003e(\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"mclose inline\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e 可任意变化\u003c/td\u003e\u003c/tr\u003e\n\u003ctr class=\"border-b border-gray-200\"\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003eHistogram\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e分布统计\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e响应时间分布\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e\u003cspan class=\"katex inline\"\u003e\u003cspan class=\"katex-mathml inline\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsubsup\u003e\u003cmo\u003e∑\u003c/mo\u003e\u003cmrow\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/mrow\u003e\u003cmi\u003en\u003c/mi\u003e\u003c/msubsup\u003e\u003cmi\u003eb\u003c/mi\u003e\u003cmi\u003eu\u003c/mi\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmi\u003ek\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmsub\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003c/msub\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003eo\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003el\u003c/mi\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003e\\sum_{i=1}^{n} bucket_i = total\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html inline\" aria-hidden=\"true\" style=\"display:none\"\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:1.104em;vertical-align:-0.2997em;\"\u003e\u003c/span\u003e\u003cspan class=\"mop inline\"\u003e\u003cspan class=\"mop op-symbol small-op inline\" style=\"position:relative;top:0em;\"\u003e∑\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.8043em;\"\u003e\u003cspan style=\"top:-2.4003em;margin-left:0em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e\u003cspan class=\"mord mathnormal mtight inline\"\u003ei\u003c/span\u003e\u003cspan class=\"mrel mtight inline\"\u003e=\u003c/span\u003e\u003cspan class=\"mord mtight inline\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-3.2029em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e\u003cspan class=\"mord mathnormal mtight inline\"\u003en\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.2997em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.1667em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003eb\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003eu\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ec\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.03148em;\"\u003ek\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ee\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3117em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mathnormal mtight inline\"\u003ei\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel inline\"\u003e=\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:0.6944em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003eo\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\"\u003ea\u003c/span\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/td\u003e\u003c/tr\u003e\n\u003ctr class=\"border-b border-gray-200\"\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003eSummary\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e分位数统计\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e响应时间百分位\u003c/td\u003e\u003ctd class=\"px-4 py-3 text-sm text-foreground\"\u003e\u003cspan class=\"katex inline\"\u003e\u003cspan class=\"katex-mathml inline\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsub\u003e\u003cmi\u003eP\u003c/mi\u003e\u003cmn\u003e50\u003c/mn\u003e\u003c/msub\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003eP\u003c/mi\u003e\u003cmn\u003e90\u003c/mn\u003e\u003c/msub\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003eP\u003c/mi\u003e\u003cmn\u003e99\u003c/mn\u003e\u003c/msub\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eP_{50}, P_{90}, P_{99}\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html inline\" aria-hidden=\"true\" style=\"display:none\"\u003e\u003cspan class=\"base inline\"\u003e\u003cspan class=\"strut inline\" style=\"height:0.8778em;vertical-align:-0.1944em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.13889em;\"\u003eP\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e50\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mpunct inline\"\u003e,\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.1667em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.13889em;\"\u003eP\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e90\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mpunct inline\"\u003e,\u003c/span\u003e\u003cspan class=\"mspace inline\" style=\"margin-right:0.1667em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord inline\"\u003e\u003cspan class=\"mord mathnormal inline\" style=\"margin-right:0.13889em;\"\u003eP\u003c/span\u003e\u003cspan class=\"msupsub inline\"\u003e\u003cspan class=\"vlist-t vlist-t2 inline\"\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\" class=\"inline\"\u003e\u003cspan class=\"pstrut inline\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e\u003cspan class=\"mord mtight inline\"\u003e99\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s inline\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r inline\"\u003e\u003cspan class=\"vlist inline\" style=\"height:0.15em;\"\u003e\u003cspan class=\"inline\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/td\u003e\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"spring-boot与prometheus的集成\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#spring-boot与prometheus的集成\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to Spring Boot与Prometheus的集成\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            Spring Boot与Prometheus的集成\n        \u003c/h3\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003eMaven依赖配置\u003c/strong\u003e：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"xml\" data-code=\"dependency%3E%0AgroupId%3Eorg.springframework.bootgroupId%3E%0AartifactId%3Espring-boot-starter-actuatorartifactId%3E%0Adependency%3E%0Adependency%3E%0AgroupId%3Eio.micrometergroupId%3E%0AartifactId%3Emicrometer-registry-prometheusartifactId%3E%0Adependency%3E%0Adependency%3E%0AgroupId%3Eorg.springframework.bootgroupId%3E%0AartifactId%3Espring-boot-starter-aopartifactId%3E%0Adependency%3E\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003exml\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-xml\"\u003e\u003cspan class=\"hljs-comment inline\"\u003e\u0026lt;!-- Spring Boot Actuator：生产级别的应用监控 --\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;\u003cspan class=\"hljs-name inline\"\u003edependency\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;\u003cspan class=\"hljs-name inline\"\u003egroupId\u003c/span\u003e\u0026gt;\u003c/span\u003eorg.springframework.boot\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;/\u003cspan class=\"hljs-name inline\"\u003egroupId\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;\u003cspan class=\"hljs-name inline\"\u003eartifactId\u003c/span\u003e\u0026gt;\u003c/span\u003espring-boot-starter-actuator\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;/\u003cspan class=\"hljs-name inline\"\u003eartifactId\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;/\u003cspan class=\"hljs-name inline\"\u003edependency\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment inline\"\u003e\u0026lt;!-- Micrometer Prometheus：度量指标的Prometheus导出器 --\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;\u003cspan class=\"hljs-name inline\"\u003edependency\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;\u003cspan class=\"hljs-name inline\"\u003egroupId\u003c/span\u003e\u0026gt;\u003c/span\u003eio.micrometer\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;/\u003cspan class=\"hljs-name inline\"\u003egroupId\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;\u003cspan class=\"hljs-name inline\"\u003eartifactId\u003c/span\u003e\u0026gt;\u003c/span\u003emicrometer-registry-prometheus\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;/\u003cspan class=\"hljs-name inline\"\u003eartifactId\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;/\u003cspan class=\"hljs-name inline\"\u003edependency\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment inline\"\u003e\u0026lt;!-- Spring AOP：切面编程支持 --\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;\u003cspan class=\"hljs-name inline\"\u003edependency\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;\u003cspan class=\"hljs-name inline\"\u003egroupId\u003c/span\u003e\u0026gt;\u003c/span\u003eorg.springframework.boot\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;/\u003cspan class=\"hljs-name inline\"\u003egroupId\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;\u003cspan class=\"hljs-name inline\"\u003eartifactId\u003c/span\u003e\u0026gt;\u003c/span\u003espring-boot-starter-aop\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;/\u003cspan class=\"hljs-name inline\"\u003eartifactId\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag inline\"\u003e\u0026lt;/\u003cspan class=\"hljs-name inline\"\u003edependency\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003eapplication.yaml配置\u003c/strong\u003e：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"yaml\" data-code=\"management%3A%0Aendpoints%3A%0Aweb%3A%0Aexposure%3A%0A%23%20%E5%AE%89%E5%85%A8%E8%80%83%E8%99%91%EF%BC%9A%E5%8F%AA%E6%9A%B4%E9%9C%B2%E5%BF%85%E8%A6%81%E7%9A%84%E7%AB%AF%E7%82%B9%0Ainclude%3A%20%22health%2Cinfo%2Cmetrics%2Cprometheus%2Cenv%2Cthreaddump%2Cloggers%22%0Abase-path%3A%20%2Factuator%0Acors%3A%0A%23%20%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%EF%BC%8C%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%9C%80%E8%A6%81%E9%99%90%E5%88%B6%0Aallowed-origins%3A%20%22*%22%0Aallowed-methods%3A%20GET%2CPOST%2CPUT%2CDELETE%2COPTIONS%2CHEAD%0Aallowed-headers%3A%20%22*%22%0Aendpoint%3A%0Aprometheus%3A%0A%23%20%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%BB%BA%E8%AE%AE%E8%AE%BE%E7%BD%AE%E4%B8%BA%20%22when_authorized%22%0Aaccess%3A%20unrestricted%0Ametrics%3A%0Aaccess%3A%20unrestricted%0Ametrics%3A%0Adistribution%3A%0Apercentiles-histogram%3A%0A%23%20%E5%90%AF%E7%94%A8HTTP%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%E7%9A%84%E7%9B%B4%E6%96%B9%E5%9B%BE%E7%BB%9F%E8%AE%A1%0Ahttp.server.requests%3A%20true%0Atags%3A%0A%23%20%E4%B8%BA%E6%89%80%E6%9C%89%E6%8C%87%E6%A0%87%E6%B7%BB%E5%8A%A0%E5%BA%94%E7%94%A8%E6%A0%87%E8%AF%86%E6%A0%87%E7%AD%BE%0Aapplication%3A%20%24%7Bspring.application.name%7D%0Aprometheus%3A%0Ametrics%3A%0Aexport%3A%0Aenabled%3A%20true%0A%23%20%E5%8F%AF%E9%85%8D%E7%BD%AE%E6%8E%A8%E9%80%81%E9%97%B4%E9%9A%94%EF%BC%8C%E9%BB%98%E8%AE%A4%E4%B8%BA%E6%8B%89%E5%8F%96%E6%A8%A1%E5%BC%8F%E4%B8%8D%E9%9C%80%E8%A6%81%0A%23%20step%3A%2015s%0Ahealth%3A%0Adiskspace%3A%0Aenabled%3A%20true%0Adb%3A%0Aenabled%3A%20true%0A%23%20%E5%BC%80%E5%90%AF%E8%B0%83%E8%AF%95%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B%E6%8C%87%E6%A0%87%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B%0Alogging%3A%0Alevel%3A%0Acom.chat.allchatonthis.config.metrics%3A%20debug\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003eyaml\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"hljs-attr inline\"\u003emanagement:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr inline\"\u003eendpoints:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003eweb:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003eexposure:\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e# 安全考虑：只暴露必要的端点\u003c/span\u003e\n        \u003cspan class=\"hljs-attr inline\"\u003einclude:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e\u0026quot;health,info,metrics,prometheus,env,threaddump,loggers\u0026quot;\u003c/span\u003e\n        \u003cspan class=\"hljs-attr inline\"\u003ebase-path:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e/actuator\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003ecors:\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e# 开发环境配置，生产环境需要限制\u003c/span\u003e\n        \u003cspan class=\"hljs-attr inline\"\u003eallowed-origins:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e\u0026quot;*\u0026quot;\u003c/span\u003e\n        \u003cspan class=\"hljs-attr inline\"\u003eallowed-methods:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003eGET,POST,PUT,DELETE,OPTIONS,HEAD\u003c/span\u003e\n        \u003cspan class=\"hljs-attr inline\"\u003eallowed-headers:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e\u0026quot;*\u0026quot;\u003c/span\u003e\n  \n  \u003cspan class=\"hljs-attr inline\"\u003eendpoint:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003eprometheus:\u003c/span\u003e\n      \u003cspan class=\"hljs-comment inline\"\u003e# 生产环境建议设置为 \u0026quot;when_authorized\u0026quot;\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003eaccess:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003eunrestricted\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003emetrics:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003eaccess:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003eunrestricted\u003c/span\u003e\n  \n  \u003cspan class=\"hljs-attr inline\"\u003emetrics:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003edistribution:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003epercentiles-histogram:\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e# 启用HTTP请求响应时间的直方图统计\u003c/span\u003e\n        \u003cspan class=\"hljs-attr inline\"\u003ehttp.server.requests:\u003c/span\u003e \u003cspan class=\"hljs-literal inline\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003etags:\u003c/span\u003e\n      \u003cspan class=\"hljs-comment inline\"\u003e# 为所有指标添加应用标识标签\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003eapplication:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e${spring.application.name}\u003c/span\u003e\n    \n  \u003cspan class=\"hljs-attr inline\"\u003eprometheus:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003emetrics:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003eexport:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr inline\"\u003eenabled:\u003c/span\u003e \u003cspan class=\"hljs-literal inline\"\u003etrue\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e# 可配置推送间隔，默认为拉取模式不需要\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e# step: 15s\u003c/span\u003e\n  \n  \u003cspan class=\"hljs-attr inline\"\u003ehealth:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003ediskspace:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003eenabled:\u003c/span\u003e \u003cspan class=\"hljs-literal inline\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003edb:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003eenabled:\u003c/span\u003e \u003cspan class=\"hljs-literal inline\"\u003etrue\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment inline\"\u003e# 开启调试日志查看指标注册过程\u003c/span\u003e\n\u003cspan class=\"hljs-attr inline\"\u003elogging:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr inline\"\u003elevel:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003ecom.chat.allchatonthis.config.metrics:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003edebug\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003ePrometheus配置示例\u003c/strong\u003e：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"yaml\" data-code=\"%23%20prometheus.yml%0Aglobal%3A%0Ascrape_interval%3A%2015s%0Aevaluation_interval%3A%2015s%0Ascrape_configs%3A%0A-%20job_name%3A%20'acot-backend'%0Ametrics_path%3A%20'%2Factuator%2Fprometheus'%0Astatic_configs%3A%0A-%20targets%3A%20%5B'localhost%3A8080'%5D%0Ascrape_interval%3A%2010s%0Ascrape_timeout%3A%205s\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003eyaml\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"hljs-comment inline\"\u003e# prometheus.yml\u003c/span\u003e\n\u003cspan class=\"hljs-attr inline\"\u003eglobal:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr inline\"\u003escrape_interval:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e15s\u003c/span\u003e\n  \u003cspan class=\"hljs-attr inline\"\u003eevaluation_interval:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e15s\u003c/span\u003e\n\n\u003cspan class=\"hljs-attr inline\"\u003escrape_configs:\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet inline\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr inline\"\u003ejob_name:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e\u0026#x27;acot-backend\u0026#x27;\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003emetrics_path:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e\u0026#x27;/actuator/prometheus\u0026#x27;\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003estatic_configs:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet inline\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr inline\"\u003etargets:\u003c/span\u003e [\u003cspan class=\"hljs-string inline\"\u003e\u0026#x27;localhost:8080\u0026#x27;\u003c/span\u003e]\n    \u003cspan class=\"hljs-attr inline\"\u003escrape_interval:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e10s\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003escrape_timeout:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e5s\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003ch2 id=\"grafana篇：数据可视化\" class=\"group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight\"\u003e\n            \u003ca href=\"#grafana篇：数据可视化\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to Grafana篇：数据可视化\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            Grafana篇：数据可视化\n        \u003c/h2\u003e\n\u003ch3 id=\"grafana的核心价值\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#grafana的核心价值\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to Grafana的核心价值\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            Grafana的核心价值\n        \u003c/h3\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e如果说Prometheus是\u0026quot;数据收集家\u0026quot;，那么Grafana就是\u0026quot;数据艺术家\u0026quot;。它能够将冰冷的数字转化为直观的图表，让监控数据\u0026quot;开口说话\u0026quot;。\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003eACOT监控仪表板的构建思路\u003c/strong\u003e：\u003c/p\u003e\n\u003cdiv class=\"mermaid block\" id=\"mermaid-1767525094481-3dkh331\"\u003egraph TB\n    subgraph \"ACOT Grafana仪表板\"\n        A[系统概览面板] --\u003e A1[在线用户数实时曲线]\n        A --\u003e A2[总API调用次数]\n        A --\u003e A3[系统健康状态]\n        \n        B[API调用统计面板] --\u003e B1[热门API排行榜]\n        B --\u003e B2[API调用趋势图]\n        B --\u003e B3[错误率统计]\n        \n        C[用户活动面板] --\u003e C1[用户登录/登出趋势]\n        C --\u003e C2[用户活跃时段分析]\n        C --\u003e C3[会话持续时间分布]\n        \n        D[性能指标面板] --\u003e D1[响应时间分布]\n        D --\u003e D2[JVM内存使用情况]\n        D --\u003e D3[数据库连接池状态]\n        \n        E[告警状态面板]\n    end\u003c/div\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003e关键PromQL查询语句\u003c/strong\u003e：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"promql\" data-code=\"%23%201.%20%E5%BD%93%E5%89%8D%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0Aacot_online_users%0A%23%202.%20API%E8%B0%83%E7%94%A8%E9%80%9F%E7%8E%87%20(%E6%AF%8F%E7%A7%92)%0Arate(acot_endpoint_calls_total%5B5m%5D)%0A%23%203.%20%E6%9C%80%E5%8F%97%E6%AC%A2%E8%BF%8E%E7%9A%84API%E7%AB%AF%E7%82%B9%20(Top%2010)%0Atopk(10%2C%20increase(acot_endpoint_calls_total%5B1h%5D))%0A%23%204.%20%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E9%80%9F%E7%8E%87%0Arate(acot_online_users%5B5m%5D)%20%3E%200%0A%23%205.%20%E7%B3%BB%E7%BB%9F%E5%B9%B3%E5%9D%87%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%0Arate(http_server_requests_seconds_sum%5B5m%5D)%20%2F%20rate(http_server_requests_seconds_count%5B5m%5D)%0A%23%206.%20%E9%94%99%E8%AF%AF%E7%8E%87%E7%BB%9F%E8%AE%A1%0Arate(http_server_requests_seconds_count%7Bstatus%3D~%224..%7C5..%22%7D%5B5m%5D)%20%2F%0Arate(http_server_requests_seconds_count%5B5m%5D)%20*%20100\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003epromql\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-promql\"\u003e\u003cspan class=\"hljs-comment inline\"\u003e# 1. 当前在线用户数\u003c/span\u003e\n\u003cspan class=\"hljs-attribute inline\"\u003eacot_online_users\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment inline\"\u003e# 2. API调用速率 (每秒)\u003c/span\u003e\n\u003cspan class=\"hljs-attribute inline\"\u003erate\u003c/span\u003e(acot_endpoint_calls_total[\u003cspan class=\"hljs-number inline\"\u003e5\u003c/span\u003em])\n\n\u003cspan class=\"hljs-comment inline\"\u003e# 3. 最受欢迎的API端点 (Top 10)\u003c/span\u003e\n\u003cspan class=\"hljs-attribute inline\"\u003etopk\u003c/span\u003e(\u003cspan class=\"hljs-number inline\"\u003e10\u003c/span\u003e, increase(acot_endpoint_calls_total[\u003cspan class=\"hljs-number inline\"\u003e1\u003c/span\u003eh]))\n\n\u003cspan class=\"hljs-comment inline\"\u003e# 4. 用户登录速率\u003c/span\u003e\n\u003cspan class=\"hljs-attribute inline\"\u003erate\u003c/span\u003e(acot_online_users[\u003cspan class=\"hljs-number inline\"\u003e5\u003c/span\u003em]) \u0026gt; \u003cspan class=\"hljs-number inline\"\u003e0\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment inline\"\u003e# 5. 系统平均响应时间\u003c/span\u003e\n\u003cspan class=\"hljs-attribute inline\"\u003erate\u003c/span\u003e(http_server_requests_seconds_sum[\u003cspan class=\"hljs-number inline\"\u003e5\u003c/span\u003em]) / rate(http_server_requests_seconds_count[\u003cspan class=\"hljs-number inline\"\u003e5\u003c/span\u003em])\n\n\u003cspan class=\"hljs-comment inline\"\u003e# 6. 错误率统计\u003c/span\u003e\n\u003cspan class=\"hljs-attribute inline\"\u003erate\u003c/span\u003e(http_server_requests_seconds_count{status=~\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;4..|5..\u0026quot;\u003c/span\u003e}[\u003cspan class=\"hljs-number inline\"\u003e5\u003c/span\u003em]) / \n\u003cspan class=\"hljs-attribute inline\"\u003erate\u003c/span\u003e(http_server_requests_seconds_count[\u003cspan class=\"hljs-number inline\"\u003e5\u003c/span\u003em]) * \u003cspan class=\"hljs-number inline\"\u003e100\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003ch2 id=\"代码深度解析篇：逐行剖析监控的实现细节\" class=\"group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight\"\u003e\n            \u003ca href=\"#代码深度解析篇：逐行剖析监控的实现细节\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to 代码深度解析篇：逐行剖析监控的实现细节\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            代码深度解析篇：逐行剖析监控的实现细节\n        \u003c/h2\u003e\n\u003ch3 id=\"metricscontroller：监控数据的http暴露接口\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#metricscontroller：监控数据的http暴露接口\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to MetricsController：监控数据的HTTP暴露接口\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            MetricsController：监控数据的HTTP暴露接口\n        \u003c/h3\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"java\" data-code=\"%40RestController%0A%40RequestMapping(%22%2Fmetrics%22)%0A%40RequiredArgsConstructor%0A%40Slf4j%0Apublic%20class%20MetricsController%20%7B%0Aprivate%20final%20MeterRegistry%20meterRegistry%3B%0A%2F**%0A*%20%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0A*%0A*%20%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9A%0A*%201.%20%E9%80%9A%E8%BF%87MeterRegistry%E6%9F%A5%E6%89%BE%E5%90%8D%E4%B8%BA%22acot.online.users%22%E7%9A%84Gauge%0A*%202.%20%E8%B0%83%E7%94%A8gauge().value()%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%9E%AC%E6%97%B6%E5%80%BC%0A*%203.%20%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%95%B4%E6%95%B0%E8%BF%94%E5%9B%9E%0A*%2F%0A%40GetMapping(%22%2Fonline-users%22)%0Apublic%20CommonResult%20getOnlineUsers()%20%7B%0A%2F%2F%20MeterRegistry.get()%E6%96%B9%E6%B3%95%E7%9A%84%E6%9F%A5%E6%89%BE%E9%93%BE%EF%BC%9A%0A%2F%2F%201.%20%E6%8C%89%E5%90%8D%E7%A7%B0%E6%9F%A5%E6%89%BE%E5%B7%B2%E6%B3%A8%E5%86%8C%E7%9A%84Meter%0A%2F%2F%202.%20%E8%BF%94%E5%9B%9E%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8C%B9%E9%85%8D%E7%9A%84Meter%0A%2F%2F%203.%20%E5%A6%82%E6%9E%9C%E6%89%BE%E4%B8%8D%E5%88%B0%EF%BC%8C%E6%8A%9B%E5%87%BAMeterNotFoundException%0AInteger%20onlineUsers%20%3D%20(int)%20meterRegistry.get(%22acot.online.users%22).gauge().value()%3B%0Areturn%20CommonResult.success(onlineUsers)%3B%0A%7D%0A%2F**%0A*%20%E8%8E%B7%E5%8F%96%E7%AB%AF%E7%82%B9%E8%B0%83%E7%94%A8%E7%BB%9F%E8%AE%A1%0A*%0A*%20%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E5%B1%95%E7%A4%BA%E4%BA%86Micrometer%20Search%20API%E7%9A%84%E5%BC%BA%E5%A4%A7%E5%8A%9F%E8%83%BD%0A*%2F%0A%40GetMapping(%22%2Fendpoints%22)%0Apublic%20CommonResult%3E%20getEndpointStats()%20%7B%0AMap%20stats%20%3D%20new%20HashMap()%3B%0A%2F%2F%20Micrometer%20Search%20API%E7%9A%84%E6%B5%81%E5%BC%8F%E6%9F%A5%E8%AF%A2%0ASearch.in(meterRegistry)%0A.name(%22acot.endpoint.calls%22)%20%20%2F%2F%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E6%8C%89%E5%90%8D%E7%A7%B0%E8%BF%87%E6%BB%A4%0A.counters()%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E5%8F%AA%E4%BF%9D%E7%95%99Counter%E7%B1%BB%E5%9E%8B%0A.forEach(counter%20-%3E%20%7B%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E9%81%8D%E5%8E%86%E6%89%80%E6%9C%89%E5%8C%B9%E9%85%8D%E7%9A%84Counter%0A%2F%2F%20%E6%8F%90%E5%8F%96Counter%E7%9A%84%E6%A0%87%E7%AD%BE%E4%BF%A1%E6%81%AF%0AIterable%20tags%20%3D%20counter.getId().getTags()%3B%0AString%20controller%20%3D%20%22%22%3B%0AString%20method%20%3D%20%22%22%3B%0A%2F%2F%20%E9%81%8D%E5%8E%86%E6%A0%87%E7%AD%BE%EF%BC%8C%E6%8F%90%E5%8F%96controller%E5%92%8Cmethod%E4%BF%A1%E6%81%AF%0Afor%20(Tag%20tag%20%3A%20tags)%20%7B%0Aif%20(%22controller%22.equals(tag.getKey()))%20%7B%0Acontroller%20%3D%20tag.getValue()%3B%0A%7D%20else%20if%20(%22method%22.equals(tag.getKey()))%20%7B%0Amethod%20%3D%20tag.getValue()%3B%0A%7D%0A%7D%0A%2F%2F%20%E6%9E%84%E9%80%A0%E7%AB%AF%E7%82%B9%E6%A0%87%E8%AF%86%E5%B9%B6%E8%AE%B0%E5%BD%95%E8%AE%A1%E6%95%B0%E5%80%BC%0AString%20endpoint%20%3D%20controller%20%2B%20%22.%22%20%2B%20method%3B%0Astats.put(endpoint%2C%20(int)%20counter.count())%3B%0A%7D)%3B%0Areturn%20CommonResult.success(stats)%3B%0A%7D%0A%2F**%0A*%20%E8%8E%B7%E5%8F%96%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E6%91%98%E8%A6%81%0A*%0A*%20%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E5%B1%95%E7%A4%BA%E4%BA%86%E5%A6%82%E4%BD%95%E8%81%9A%E5%90%88%E5%A4%9A%E4%B8%AA%E6%8C%87%E6%A0%87%0A*%2F%0A%40GetMapping(%22%2Fsummary%22)%0Apublic%20CommonResult%3E%20getMetricsSummary()%20%7B%0AMap%20summary%20%3D%20new%20HashMap()%3B%0A%2F%2F%20%E8%8E%B7%E5%8F%96%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%0AInteger%20onlineUsers%20%3D%20(int)%20meterRegistry.get(%22acot.online.users%22).gauge().value()%3B%0Asummary.put(%22onlineUsers%22%2C%20onlineUsers)%3B%0A%2F%2F%20%E8%AE%A1%E7%AE%97%E6%80%BBAPI%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%EF%BC%88%E6%89%80%E6%9C%89%E7%AB%AF%E7%82%B9%E8%AE%A1%E6%95%B0%E5%99%A8%E7%9A%84%E6%80%BB%E5%92%8C%EF%BC%89%0Adouble%20totalApiCalls%20%3D%20Search.in(meterRegistry)%0A.name(%22acot.endpoint.calls%22)%0A.counters()%0A.stream()%0A.mapToDouble(counter%20-%3E%20counter.count())%20%20%2F%2F%20%E6%8F%90%E5%8F%96%E6%AF%8F%E4%B8%AA%E8%AE%A1%E6%95%B0%E5%99%A8%E7%9A%84%E5%80%BC%0A.sum()%3B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%B1%82%E5%92%8C%0Asummary.put(%22totalApiCalls%22%2C%20(int)%20totalApiCalls)%3B%0Areturn%20CommonResult.success(summary)%3B%0A%7D%0A%7D\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ejava\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"hljs-meta inline\"\u003e@RestController\u003c/span\u003e\n\u003cspan class=\"hljs-meta inline\"\u003e@RequestMapping(\u0026quot;/metrics\u0026quot;)\u003c/span\u003e\n\u003cspan class=\"hljs-meta inline\"\u003e@RequiredArgsConstructor\u003c/span\u003e\n\u003cspan class=\"hljs-meta inline\"\u003e@Slf4j\u003c/span\u003e\n\u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_ inline\"\u003eMetricsController\u003c/span\u003e {\n\n    \u003cspan class=\"hljs-keyword inline\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003efinal\u003c/span\u003e MeterRegistry meterRegistry;\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 获取当前在线用户数\n     * \n     * 实现原理：\n     * 1. 通过MeterRegistry查找名为\u0026quot;acot.online.users\u0026quot;的Gauge\n     * 2. 调用gauge().value()获取当前瞬时值\n     * 3. 转换为整数返回\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-meta inline\"\u003e@GetMapping(\u0026quot;/online-users\u0026quot;)\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e CommonResult\u0026lt;Integer\u0026gt; \u003cspan class=\"hljs-title function_ inline\"\u003egetOnlineUsers\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e()\u003c/span\u003e {\n        \u003cspan class=\"hljs-comment inline\"\u003e// MeterRegistry.get()方法的查找链：\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e// 1. 按名称查找已注册的Meter\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e// 2. 返回第一个匹配的Meter\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e// 3. 如果找不到，抛出MeterNotFoundException\u003c/span\u003e\n        \u003cspan class=\"hljs-type inline\"\u003eInteger\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eonlineUsers\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e (\u003cspan class=\"hljs-type inline\"\u003eint\u003c/span\u003e) meterRegistry.get(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;acot.online.users\u0026quot;\u003c/span\u003e).gauge().value();\n        \n        \u003cspan class=\"hljs-keyword inline\"\u003ereturn\u003c/span\u003e CommonResult.success(onlineUsers);\n    }\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 获取端点调用统计\n     * \n     * 这个方法展示了Micrometer Search API的强大功能\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-meta inline\"\u003e@GetMapping(\u0026quot;/endpoints\u0026quot;)\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e CommonResult\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; \u003cspan class=\"hljs-title function_ inline\"\u003egetEndpointStats\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e()\u003c/span\u003e {\n        Map\u0026lt;String, Object\u0026gt; stats = \u003cspan class=\"hljs-keyword inline\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_ inline\"\u003eHashMap\u003c/span\u003e\u0026lt;\u0026gt;();\n        \n        \u003cspan class=\"hljs-comment inline\"\u003e// Micrometer Search API的流式查询\u003c/span\u003e\n        Search.in(meterRegistry)\n            .name(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;acot.endpoint.calls\u0026quot;\u003c/span\u003e)  \u003cspan class=\"hljs-comment inline\"\u003e// 步骤1：按名称过滤\u003c/span\u003e\n            .counters()                   \u003cspan class=\"hljs-comment inline\"\u003e// 步骤2：只保留Counter类型\u003c/span\u003e\n            .forEach(counter -\u0026gt; {         \u003cspan class=\"hljs-comment inline\"\u003e// 步骤3：遍历所有匹配的Counter\u003c/span\u003e\n                \u003cspan class=\"hljs-comment inline\"\u003e// 提取Counter的标签信息\u003c/span\u003e\n                Iterable\u0026lt;Tag\u0026gt; tags = counter.getId().getTags();\n                \n                \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003econtroller\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e;\n                \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003emethod\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e;\n                \n                \u003cspan class=\"hljs-comment inline\"\u003e// 遍历标签，提取controller和method信息\u003c/span\u003e\n                \u003cspan class=\"hljs-keyword inline\"\u003efor\u003c/span\u003e (Tag tag : tags) {\n                    \u003cspan class=\"hljs-keyword inline\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;controller\u0026quot;\u003c/span\u003e.equals(tag.getKey())) {\n                        controller = tag.getValue();\n                    } \u003cspan class=\"hljs-keyword inline\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;method\u0026quot;\u003c/span\u003e.equals(tag.getKey())) {\n                        method = tag.getValue();\n                    }\n                }\n                \n                \u003cspan class=\"hljs-comment inline\"\u003e// 构造端点标识并记录计数值\u003c/span\u003e\n                \u003cspan class=\"hljs-type inline\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eendpoint\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e controller + \u003cspan class=\"hljs-string inline\"\u003e\u0026quot;.\u0026quot;\u003c/span\u003e + method;\n                stats.put(endpoint, (\u003cspan class=\"hljs-type inline\"\u003eint\u003c/span\u003e) counter.count());\n            });\n        \n        \u003cspan class=\"hljs-keyword inline\"\u003ereturn\u003c/span\u003e CommonResult.success(stats);\n    }\n\n    \u003cspan class=\"hljs-comment inline\"\u003e/**\n     * 获取监控数据摘要\n     * \n     * 这个方法展示了如何聚合多个指标\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-meta inline\"\u003e@GetMapping(\u0026quot;/summary\u0026quot;)\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e CommonResult\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; \u003cspan class=\"hljs-title function_ inline\"\u003egetMetricsSummary\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e()\u003c/span\u003e {\n        Map\u0026lt;String, Object\u0026gt; summary = \u003cspan class=\"hljs-keyword inline\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_ inline\"\u003eHashMap\u003c/span\u003e\u0026lt;\u0026gt;();\n        \n        \u003cspan class=\"hljs-comment inline\"\u003e// 获取在线用户数\u003c/span\u003e\n        \u003cspan class=\"hljs-type inline\"\u003eInteger\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003eonlineUsers\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e (\u003cspan class=\"hljs-type inline\"\u003eint\u003c/span\u003e) meterRegistry.get(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;acot.online.users\u0026quot;\u003c/span\u003e).gauge().value();\n        summary.put(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;onlineUsers\u0026quot;\u003c/span\u003e, onlineUsers);\n        \n        \u003cspan class=\"hljs-comment inline\"\u003e// 计算总API调用次数（所有端点计数器的总和）\u003c/span\u003e\n        \u003cspan class=\"hljs-type inline\"\u003edouble\u003c/span\u003e \u003cspan class=\"hljs-variable inline\"\u003etotalApiCalls\u003c/span\u003e \u003cspan class=\"hljs-operator inline\"\u003e=\u003c/span\u003e Search.in(meterRegistry)\n            .name(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;acot.endpoint.calls\u0026quot;\u003c/span\u003e)\n            .counters()\n            .stream()\n            .mapToDouble(counter -\u0026gt; counter.count())  \u003cspan class=\"hljs-comment inline\"\u003e// 提取每个计数器的值\u003c/span\u003e\n            .sum();                                   \u003cspan class=\"hljs-comment inline\"\u003e// 求和\u003c/span\u003e\n        summary.put(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;totalApiCalls\u0026quot;\u003c/span\u003e, (\u003cspan class=\"hljs-type inline\"\u003eint\u003c/span\u003e) totalApiCalls);\n        \n        \u003cspan class=\"hljs-keyword inline\"\u003ereturn\u003c/span\u003e CommonResult.success(summary);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003eMeterRegistry的内部工作机制\u003c/strong\u003e：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"java\" data-code=\"%2F%2F%20MeterRegistry%E7%9A%84%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95%EF%BC%88%E7%AE%80%E5%8C%96%E7%89%88%EF%BC%89%0Apublic%20Meter%20get(String%20name)%20%7B%0Afor%20(Meter%20meter%20%3A%20this.meters)%20%7B%0Aif%20(meter.getId().getName().equals(name))%20%7B%0Areturn%20meter%3B%0A%7D%0A%7D%0Athrow%20new%20MeterNotFoundException(%22%E6%89%BE%E4%B8%8D%E5%88%B0%E5%90%8D%E4%B8%BA%20%22%20%2B%20name%20%2B%20%22%20%E7%9A%84%E6%8C%87%E6%A0%87%22)%3B%0A%7D\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ejava\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"hljs-comment inline\"\u003e// MeterRegistry的查找算法（简化版）\u003c/span\u003e\n\u003cspan class=\"hljs-keyword inline\"\u003epublic\u003c/span\u003e Meter \u003cspan class=\"hljs-title function_ inline\"\u003eget\u003c/span\u003e\u003cspan class=\"hljs-params inline\"\u003e(String name)\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword inline\"\u003efor\u003c/span\u003e (Meter meter : \u003cspan class=\"hljs-built_in inline\"\u003ethis\u003c/span\u003e.meters) {\n        \u003cspan class=\"hljs-keyword inline\"\u003eif\u003c/span\u003e (meter.getId().getName().equals(name)) {\n            \u003cspan class=\"hljs-keyword inline\"\u003ereturn\u003c/span\u003e meter;\n        }\n    }\n    \u003cspan class=\"hljs-keyword inline\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword inline\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_ inline\"\u003eMeterNotFoundException\u003c/span\u003e(\u003cspan class=\"hljs-string inline\"\u003e\u0026quot;找不到名为 \u0026quot;\u003c/span\u003e + name + \u003cspan class=\"hljs-string inline\"\u003e\u0026quot; 的指标\u0026quot;\u003c/span\u003e);\n}\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003ch3 id=\"完整的指标数据流分析\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#完整的指标数据流分析\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to 完整的指标数据流分析\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            完整的指标数据流分析\n        \u003c/h3\u003e\n\u003cdiv class=\"mermaid block\" id=\"mermaid-1767525094481-2ydbibb\"\u003esequenceDiagram\n    participant Client as 客户端\n    participant Controller as RestController\n    participant Aspect as EndpointMetricsAspect\n    participant Metrics as EndpointMetrics\n    participant Registry as MeterRegistry\n    participant Prometheus as Prometheus端点\n\n    Client-\u003e\u003eController: HTTP请求\n    Controller-\u003e\u003eAspect: 方法调用 (AOP拦截)\n    Aspect-\u003e\u003eMetrics: incrementEndpointCount()\n    Metrics-\u003e\u003eRegistry: counter.increment()\n    Controller-\u003e\u003eClient: 返回响应\n    \n    Note over Registry: 指标数据持续累积\n    \n    Prometheus-\u003e\u003eController: GET /actuator/prometheus\n    Controller-\u003e\u003eRegistry: 获取所有指标\n    Registry-\u003e\u003ePrometheus: 返回Prometheus格式数据\u003c/div\u003e\n\u003ch3 id=\"配置文件的深层解析\" class=\"group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug\"\u003e\n            \u003ca href=\"#配置文件的深层解析\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to 配置文件的深层解析\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            配置文件的深层解析\n        \u003c/h3\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003e为什么需要这些配置？\u003c/strong\u003e\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"yaml\" data-code=\"management%3A%0Aendpoints%3A%0Aweb%3A%0Aexposure%3A%0A%23%20%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AA%E6%9A%B4%E9%9C%B2%E8%BF%99%E4%BA%9B%E7%AB%AF%E7%82%B9%EF%BC%9F%0Ainclude%3A%20%22health%2Cinfo%2Cmetrics%2Cprometheus%2Cenv%2Cthreaddump%2Cloggers%22%0A%23%20%E5%AE%89%E5%85%A8%E8%80%83%E8%99%91%EF%BC%9A%0A%23%20-%20health%3A%20%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%EF%BC%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9C%80%E8%A6%81%0A%23%20-%20metrics%3A%20%E5%86%85%E9%83%A8%E7%9B%91%E6%8E%A7%E6%9F%A5%E8%AF%A2%0A%23%20-%20prometheus%3A%20%E5%A4%96%E9%83%A8%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E6%8B%89%E5%8F%96%0A%23%20-%20%E5%85%B6%E4%BB%96%E6%95%8F%E6%84%9F%E7%AB%AF%E7%82%B9%E4%B8%8D%E6%9A%B4%E9%9C%B2%EF%BC%8C%E9%81%BF%E5%85%8D%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003eyaml\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"hljs-attr inline\"\u003emanagement:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr inline\"\u003eendpoints:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003eweb:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003eexposure:\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e# 为什么只暴露这些端点？\u003c/span\u003e\n        \u003cspan class=\"hljs-attr inline\"\u003einclude:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e\u0026quot;health,info,metrics,prometheus,env,threaddump,loggers\u0026quot;\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e# 安全考虑：\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e# - health: 健康检查，负载均衡需要\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e# - metrics: 内部监控查询\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e# - prometheus: 外部监控系统拉取\u003c/span\u003e\n        \u003cspan class=\"hljs-comment inline\"\u003e# - 其他敏感端点不暴露，避免信息泄露\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cstrong class=\"font-bold text-foreground\"\u003e生产环境的安全配置\u003c/strong\u003e：\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"yaml\" data-code=\"management%3A%0Aendpoints%3A%0Aweb%3A%0Aexposure%3A%0Ainclude%3A%20%22health%2Cprometheus%22%20%20%23%20%E6%9C%80%E5%B0%8F%E6%9A%B4%E9%9C%B2%E5%8E%9F%E5%88%99%0Abase-path%3A%20%2Finternal%2Factuator%20%20%23%20%E5%86%85%E9%83%A8%E8%B7%AF%E5%BE%84%EF%BC%8C%E4%BE%BF%E4%BA%8E%E7%BD%91%E5%85%B3%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6%0Aendpoint%3A%0Aprometheus%3A%0Aaccess%3A%20when_authorized%20%20%23%20%E9%9C%80%E8%A6%81%E8%AE%A4%E8%AF%81%0Ahealth%3A%0Ashow-details%3A%20when_authorized%20%20%23%20%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF%E9%9C%80%E8%A6%81%E8%AE%A4%E8%AF%81%0Aserver%3A%0Aport%3A%209090%20%20%23%20%E7%8B%AC%E7%AB%8B%E7%9A%84%E7%AE%A1%E7%90%86%E7%AB%AF%E5%8F%A3%EF%BC%8C%E4%BE%BF%E4%BA%8E%E9%98%B2%E7%81%AB%E5%A2%99%E7%AD%96%E7%95%A5\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003eyaml\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"hljs-attr inline\"\u003emanagement:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr inline\"\u003eendpoints:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003eweb:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003eexposure:\u003c/span\u003e\n        \u003cspan class=\"hljs-attr inline\"\u003einclude:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e\u0026quot;health,prometheus\u0026quot;\u003c/span\u003e  \u003cspan class=\"hljs-comment inline\"\u003e# 最小暴露原则\u003c/span\u003e\n        \u003cspan class=\"hljs-attr inline\"\u003ebase-path:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003e/internal/actuator\u003c/span\u003e  \u003cspan class=\"hljs-comment inline\"\u003e# 内部路径，便于网关路由控制\u003c/span\u003e\n  \u003cspan class=\"hljs-attr inline\"\u003eendpoint:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003eprometheus:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003eaccess:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003ewhen_authorized\u003c/span\u003e  \u003cspan class=\"hljs-comment inline\"\u003e# 需要认证\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003ehealth:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr inline\"\u003eshow-details:\u003c/span\u003e \u003cspan class=\"hljs-string inline\"\u003ewhen_authorized\u003c/span\u003e  \u003cspan class=\"hljs-comment inline\"\u003e# 详细信息需要认证\u003c/span\u003e\n  \u003cspan class=\"hljs-attr inline\"\u003eserver:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr inline\"\u003eport:\u003c/span\u003e \u003cspan class=\"hljs-number inline\"\u003e9090\u003c/span\u003e  \u003cspan class=\"hljs-comment inline\"\u003e# 独立的管理端口，便于防火墙策略\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n\u003ch2 id=\"写在最后\" class=\"group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight\"\u003e\n            \u003ca href=\"#写在最后\" class=\"absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary\" aria-label=\"Link to 写在最后\"\u003e\n                \u003csvg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                    \u003cpath fill-rule=\"evenodd\" d=\"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z\" clip-rule=\"evenodd\" /\u003e\n                \u003c/svg\u003e\n            \u003c/a\u003e\n            写在最后\n        \u003c/h2\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e相比起使用监控系统来关注系统运行的健康程度，其实我更喜欢使用监控系统来进行用户行为分析。诚然，安全比个性更重要，但安全的目的不就是为了之后更多的可能性吗？\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003eACOT的监控系统设计是相对简单的，但它展现出了一个系统的长期可持续发展能力——对于用户需求的敏锐嗅觉。毕竟，能解决用户需求的系统才是好系统。\u003c/p\u003e\n\u003cp class=\"text-base leading-7 mb-4 text-foreground\"\u003e\u003cem class=\"italic text-foreground\"\u003e愿未来的系统形如灵智的精灵，倾心聆听来访者的声音，化身他们手中披荆斩棘的利刃，担任成为未来的算子，让人类的智慧在宇宙中闪烁。\u003c/em\u003e ✨\u003c/p\u003e\n\n            \u003cdiv class=\"enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm\" data-enhanced-codeblock=\"true\" data-language=\"java\" data-code=\"%2F%2F%20%E8%AE%B8%E6%84%BF%EF%BC%88%E7%9B%91%E6%8E%A7%E7%89%88%EF%BC%89%0Awhile%20(system.isRunning())%20%7B%0Amonitor.collect()%3B%0Aif%20(anomaly.detected())%20%7B%0Aalert.send()%3B%20%F0%9F%9A%A8%0Aengineer.fix()%3B%0A%7D%0Adashboard.update()%3B%20%F0%9F%93%8A%0A%7D\"\u003e\n                \u003cdiv class=\"codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700\"\u003e\n                    \u003cspan class=\"codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline\"\u003ejava\u003c/span\u003e\n                    \u003cbutton class=\"codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95\" title=\"复制代码\"\u003e\n                        \u003csvg class=\"copy-icon w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath d=\"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z\" /\u003e\n                            \u003cpath d=\"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z\" /\u003e\n                        \u003c/svg\u003e\n                        \u003csvg class=\"copied-icon w-4 h-4 hidden\" fill=\"currentColor\" viewBox=\"0 0 20 20\"\u003e\n                            \u003cpath fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /\u003e\n                        \u003c/svg\u003e\n                        \u003cspan class=\"copy-text inline\"\u003e复制\u003c/span\u003e\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cpre class=\"codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"hljs-comment inline\"\u003e// 许愿（监控版）\u003c/span\u003e\n\u003cspan class=\"hljs-keyword inline\"\u003ewhile\u003c/span\u003e (system.isRunning()) {\n    monitor.collect();\n    \u003cspan class=\"hljs-keyword inline\"\u003eif\u003c/span\u003e (anomaly.detected()) {\n        alert.send(); 🚨\n        engineer.fix();\n    }\n    dashboard.update(); 📊\n}\n\u003c/code\u003e\u003c/pre\u003e\n            \u003c/div\u003e\n        \n"])</script><script>self.__next_f.push([1,"d:[\"$\",\"$L1d\",null,{\"htmlContent\":\"$1e\",\"frontMatter\":{\"title\":\"All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态\",\"description\":\"深度解析 Spring Boot 应用中端点监控、指标收集、用户活动跟踪的完整实现原理，涵盖 AOP、Micrometer、Prometheus 的技术栈\",\"date\":\"2025-01-15\",\"author\":\"MilkWind\",\"tags\":[\"Spring Boot\",\"监控系统\",\"Prometheus\",\"Micrometer\",\"AOP\"],\"references\":{}},\"readingTime\":\"21 min read\",\"category\":\"all-chat-on-this\",\"tocItems\":[{\"id\":\"all-chat-on-this-端点监控与暴露功能实现原理：从aop切面到prometheus的完整监控生态\",\"text\":\"All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态\",\"level\":1},{\"id\":\"监控架构篇：四层分离设计\",\"text\":\"监控架构篇：四层分离设计\",\"level\":2},{\"id\":\"分层架构概述：数据流的生命周期\",\"text\":\"分层架构概述：数据流的生命周期\",\"level\":3},{\"id\":\"端点监控的核心原理篇：aop\",\"text\":\"端点监控的核心原理篇：AOP\",\"level\":2},{\"id\":\"aop切面编程：神秘下料男\",\"text\":\"AOP切面编程：神秘下料男\",\"level\":3},{\"id\":\"endpointmetricsaspect：切面拦截\",\"text\":\"EndpointMetricsAspect：切面拦截\",\"level\":3},{\"id\":\"线程安全的计数器设计：endpointmetrics并发\",\"text\":\"线程安全的计数器设计：EndpointMetrics并发\",\"level\":3},{\"id\":\"在线用户统计的双重保障机制\",\"text\":\"在线用户统计的双重保障机制\",\"level\":3},{\"id\":\"useractivitymetricsconfig：spring-security事件处理\",\"text\":\"UserActivityMetricsConfig：Spring Security事件处理\",\"level\":3},{\"id\":\"sessioneventlistener：会话生命周期的兜底机制\",\"text\":\"SessionEventListener：会话生命周期的兜底机制\",\"level\":3},{\"id\":\"prometheus篇：时序数据库\",\"text\":\"Prometheus篇：时序数据库\",\"level\":2},{\"id\":\"为什么选择prometheus？\",\"text\":\"为什么选择Prometheus？\",\"level\":3},{\"id\":\"时序数据模型：时间戳设计根本\",\"text\":\"时序数据模型：时间戳设计根本\",\"level\":3},{\"id\":\"spring-boot与prometheus的集成\",\"text\":\"Spring Boot与Prometheus的集成\",\"level\":3},{\"id\":\"grafana篇：数据可视化\",\"text\":\"Grafana篇：数据可视化\",\"level\":2},{\"id\":\"grafana的核心价值\",\"text\":\"Grafana的核心价值\",\"level\":3},{\"id\":\"代码深度解析篇：逐行剖析监控的实现细节\",\"text\":\"代码深度解析篇：逐行剖析监控的实现细节\",\"level\":2},{\"id\":\"metricscontroller：监控数据的http暴露接口\",\"text\":\"MetricsController：监控数据的HTTP暴露接口\",\"level\":3},{\"id\":\"完整的指标数据流分析\",\"text\":\"完整的指标数据流分析\",\"level\":3},{\"id\":\"配置文件的深层解析\",\"text\":\"配置文件的深层解析\",\"level\":3},{\"id\":\"写在最后\",\"text\":\"写在最后\",\"level\":2}],\"translations\":{\"common\":{\"welcome\":\"欢迎\",\"loading\":\"加载中...\",\"error\":\"出现了一些问题\",\"retry\":\"重试\",\"theme\":\"主题\",\"language\":\"语言\",\"light\":\"浅色\",\"dark\":\"深色\"},\"navigation\":{\"home\":\"首页\",\"personal\":\"个人\",\"works\":\"作品\",\"contributions\":\"贡献\",\"documents\":\"文档\",\"about\":\"关于\",\"contact\":\"联系\"},\"personal\":{\"technicalSkills\":\"技术技能\",\"email\":\"邮箱\",\"github\":\"代码仓库\",\"resume\":\"简历\",\"codeRepository\":\"代码仓库\",\"loadingPersonalInfo\":\"加载个人信息中...\",\"loadingResume\":\"加载简历中...\",\"closeResume\":\"关闭简历\",\"emailCopied\":\"邮箱已复制到剪贴板！\",\"galaxyDefaultDescription\":\"精通全栈开发技术，具备跨平台架构能力，擅长AI技术整合与高性能系统优化\",\"skillGalaxy\":\"技能星系\",\"stirGalaxy\":\"搅动星系\",\"stirring\":\"搅动中...\",\"fullStackEngineer\":\"MilkWind - 全栈工程师\",\"professionalProfile\":\"关于我\"},\"documents\":{\"technicalDocuments\":\"技术文档\",\"description\":\"基本原理、代码拆分以及一些碎碎念。\",\"articles\":\"文章\",\"categories\":\"分类\",\"allCategories\":\"所有分类\",\"noArticlesFound\":\"未找到文章\",\"noArticlesAvailable\":\"中文暂无文章。\",\"noArticlesInCategory\":\"该分类下未找到文章。\",\"readMore\":\"阅读更多\",\"loadingDocuments\":\"加载文档中...\",\"backToDocuments\":\"← 返回文档\",\"documentNotFound\":\"文档未找到\",\"documentNotFoundDescription\":\"请求的文档无法找到。\",\"technicalInsights\":\"技术拆解\",\"untitledDocument\":\"无标题文档\",\"byAuthor\":\"作者：\",\"search\":\"搜索文章...\",\"searchByTags\":\"按标签筛选\",\"searching\":\"搜索中...\",\"noSearchResults\":\"没有找到符合搜索条件的文章\",\"clearSearch\":\"清除搜索\",\"selectedTags\":\"已选标签\",\"allTags\":\"所有标签\",\"searchInTitle\":\"在标题、描述和内容中搜索\",\"enterImmersiveMode\":\"沉浸阅读\",\"exitImmersiveMode\":\"退出沉浸模式\",\"immersiveReading\":\"沉浸阅读模式\",\"exploreContent\":\"按分类探索内容\",\"browseBy\":\"浏览方式\",\"exploreAll\":\"所有内容汇总\",\"categoryDescription\":\"该分类下的文章\",\"totalArticles\":\"文章\",\"totalCategories\":\"分类\",\"foundArticles\":\"找到文章\",\"categoriesWithResults\":\"有结果的分类\"},\"works\":{\"workCases\":\"作品案例\",\"projects\":\"作品集\",\"loadingProjects\":\"加载项目中...\",\"grid\":\"网格\",\"stack\":\"堆叠\",\"of\":\"共\",\"workCasesPageTitle\":\"作品案例页面\",\"pageWorkingCorrectly\":\"此页面运行正常！路由配置正确。\",\"try3DVersion\":\"尝试3D版本\",\"dragToScroll\":\"拖拽滚动\",\"dragToChange\":\"拖拽切换\",\"swipeCards\":\"切换卡片\",\"keyboardNav\":\"键盘导航\"},\"contributions\":{\"contributionCases\":\"开源项目\",\"contributions\":\"贡献\",\"loadingContributions\":\"加载贡献中...\",\"grid\":\"网格\",\"stack\":\"堆叠\",\"of\":\"共\",\"contributionCasesPageTitle\":\"贡献案例页面\",\"pageWorkingCorrectly\":\"此页面运行正常！路由配置正确。\",\"try3DVersion\":\"尝试3D版本\",\"dragToScroll\":\"拖拽滚动\",\"dragToChange\":\"拖拽切换\",\"swipeCards\":\"切换卡片\",\"keyboardNav\":\"键盘导航\"},\"contribution\":{\"contributionPreview\":\"贡献预览\",\"accessible\":\"可访问\",\"code\":\"代码\",\"maintenance\":\"维护\",\"enhancement\":\"增强\",\"documentation\":\"文档\",\"community\":\"社区\",\"moreItems\":\"更多\",\"technicalDetails\":\"技术详情\",\"technologies\":\"技术栈：\",\"contributionDetail\":\"贡献详情\",\"description\":\"描述：\",\"seeDetails\":\"查看详情\",\"github\":\"代码仓库\",\"viewContribution\":\"查看贡献\",\"viewCode\":\"查看代码\"},\"project\":{\"projectPreview\":\"项目预览\",\"accessible\":\"可访问\",\"tool\":\"工具\",\"plugin\":\"插件\",\"toy\":\"小玩意\",\"moreItems\":\"更多\",\"technicalDetails\":\"技术详情\",\"technologies\":\"技术栈：\",\"description\":\"描述：\",\"seeDetails\":\"查看详情\",\"github\":\"GitHub\",\"gitee\":\"Gitee\",\"viewLiveDemo\":\"查看演示\",\"viewCode\":\"查看代码\",\"access\":\"访问\",\"videos\":\"视频\",\"watchVideo\":\"观看视频\",\"hasVideo\":\"有视频\"},\"codeblock\":{\"copy\":\"复制\",\"copySuccess\":\"代码已复制到剪贴板！\",\"copyError\":\"复制代码失败\",\"copyTooltip\":\"复制代码\"},\"toc\":{\"contents\":\"目录\",\"autoScroll\":\"自动滚动到章节\",\"collapse\":\"折叠\",\"expand\":\"展开\"},\"loading\":{\"loading\":\"加载中\",\"preparingExperience\":\"准备体验中\"}},\"lang\":\"zh\",\"theme\":\"dark\"}]\n"])</script><script>self.__next_f.push([1,"12:null\n"])</script><script>self.__next_f.push([1,"18:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n11:null\n"])</script><script>self.__next_f.push([1,"1c:{\"metadata\":[[\"$\",\"title\",\"0\",{\"children\":\"All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态 | Interactive Portfolio\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"深度解析 Spring Boot 应用中端点监控、指标收集、用户活动跟踪的完整实现原理，涵盖 AOP、Micrometer、Prometheus 的技术栈\"}],[\"$\",\"meta\",\"2\",{\"name\":\"author\",\"content\":\"Developer\"}],[\"$\",\"meta\",\"3\",{\"name\":\"keywords\",\"content\":\"portfolio,3D,interactive,web development,Three.js,Next.js\"}],[\"$\",\"meta\",\"4\",{\"property\":\"og:title\",\"content\":\"All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态 | Interactive Portfolio\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:description\",\"content\":\"深度解析 Spring Boot 应用中端点监控、指标收集、用户活动跟踪的完整实现原理，涵盖 AOP、Micrometer、Prometheus 的技术栈\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:type\",\"content\":\"article\"}],[\"$\",\"meta\",\"7\",{\"property\":\"article:published_time\",\"content\":\"2025-01-15\"}],[\"$\",\"meta\",\"8\",{\"property\":\"article:tag\",\"content\":\"Spring Boot\"}],[\"$\",\"meta\",\"9\",{\"property\":\"article:tag\",\"content\":\"监控系统\"}],[\"$\",\"meta\",\"10\",{\"property\":\"article:tag\",\"content\":\"Prometheus\"}],[\"$\",\"meta\",\"11\",{\"property\":\"article:tag\",\"content\":\"Micrometer\"}],[\"$\",\"meta\",\"12\",{\"property\":\"article:tag\",\"content\":\"AOP\"}],[\"$\",\"meta\",\"13\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"14\",{\"name\":\"twitter:title\",\"content\":\"All-Chat-on-This 端点监控与暴露功能实现原理：从AOP切面到Prometheus的完整监控生态 | Interactive Portfolio\"}],[\"$\",\"meta\",\"15\",{\"name\":\"twitter:description\",\"content\":\"深度解析 Spring Boot 应用中端点监控、指标收集、用户活动跟踪的完整实现原理，涵盖 AOP、Micrometer、Prometheus 的技术栈\"}],[\"$\",\"link\",\"16\",{\"rel\":\"icon\",\"href\":\"/MilkWind-Website/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"32x32\"}]],\"error\":null,\"digest\":\"$undefined\"}\n14:{"])</script><script>self.__next_f.push([1,"\"metadata\":\"$1c:metadata\",\"error\":null,\"digest\":\"$undefined\"}\n"])</script></body></html>