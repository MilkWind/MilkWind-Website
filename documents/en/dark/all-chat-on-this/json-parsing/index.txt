1:"$Sreact.fragment"
2:I[38735,["46","static/chunks/46-268e24d727b280ef.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"default"]
3:I[19945,["46","static/chunks/46-268e24d727b280ef.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"default"]
4:I[65337,["46","static/chunks/46-268e24d727b280ef.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"default"]
5:I[96190,["46","static/chunks/46-268e24d727b280ef.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"ClientProviders"]
6:I[87555,[],""]
7:I[51901,["8039","static/chunks/app/error-dda32be1d095a86c.js"],"default"]
8:I[31295,[],""]
9:I[6874,["6874","static/chunks/6874-fbe9a08eb79b991c.js","4345","static/chunks/app/not-found-9ff98b2ccf24cac7.js"],""]
a:I[94970,[],"ClientSegmentRoot"]
b:I[44065,["206","static/chunks/206-4f4cbf4d7156f437.js","3092","static/chunks/app/documents/layout-28408791defde09e.js"],"default"]
e:I[59665,[],"MetadataBoundary"]
10:I[59665,[],"OutletBoundary"]
13:I[74911,[],"AsyncMetadataOutlet"]
15:I[39460,["2415","static/chunks/2415-689c103fb3d2c28d.js","8610","static/chunks/8610-7bd3f91f3cf2a4d6.js","5650","static/chunks/app/documents/loading-1fa3f98b6e5a8e78.js"],"default"]
16:I[88610,["2415","static/chunks/2415-689c103fb3d2c28d.js","8610","static/chunks/8610-7bd3f91f3cf2a4d6.js","4209","static/chunks/app/loading-68f227fb49b3ac8c.js"],"default"]
17:I[59665,[],"ViewportBoundary"]
19:I[26614,[],""]
:HL["/MilkWind-Website/_next/static/css/704956702722271c.css","style"]
:HL["/MilkWind-Website/_next/static/css/276b387d8ca46690.css","style"]
:HL["/MilkWind-Website/_next/static/css/5eacd01f773eed7f.css","style"]
0:{"P":null,"b":"hDcQihbPrZmyDn13A-ujS","p":"/MilkWind-Website","c":["","documents","en","dark","all-chat-on-this","json-parsing",""],"i":false,"f":[[["",{"children":["documents",{"children":[["slug","en/dark/all-chat-on-this/json-parsing","c"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/MilkWind-Website/_next/static/css/704956702722271c.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","link","1",{"rel":"stylesheet","href":"/MilkWind-Website/_next/static/css/276b387d8ca46690.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","suppressHydrationWarning":true,"children":["$","body",null,{"className":"__variable_9b7fb1 __variable_ca2a15 __variable_591dcc font-sans antialiased min-h-screen bg-background text-foreground","suppressHydrationWarning":true,"children":[["$","$L2",null,{}],["$","$L3",null,{}],["$","$L4",null,{}],["$","$L5",null,{"children":["$","$L6",null,{"parallelRouterKey":"children","error":"$7","errorStyles":[],"errorScripts":[],"template":["$","$L8",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","div",null,{"className":"z-10 relative min-h-screen flex items-center justify-center bg-background p-8","children":["$","div",null,{"className":"text-center max-w-md","children":[["$","div",null,{"className":"text-8xl font-bold text-primary mb-4","children":"404"}],["$","h2",null,{"className":"text-2xl font-bold text-foreground mb-4","children":"Page Not Found"}],["$","p",null,{"className":"text-foreground/70 mb-8","children":"The page you're looking for doesn't exist or has been moved to a different location."}],["$","div",null,{"className":"flex flex-col sm:flex-row gap-4 justify-center","children":[["$","$L9",null,{"href":"/","className":"px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors","children":"Go Home"}],["$","$L9",null,{"href":"/works","className":"px-6 py-2 border border-primary text-primary rounded-lg hover:bg-primary/10 transition-colors","children":"View Works"}]]}],["$","div",null,{"className":"absolute inset-0 overflow-hidden pointer-events-none -z-10","children":[["$","div",null,{"className":"absolute top-1/4 left-1/4 w-2 h-2 bg-primary/20 rounded-full animate-float"}],["$","div",null,{"className":"absolute top-3/4 right-1/4 w-3 h-3 bg-accent/20 rounded-full animate-float","style":{"animationDelay":"1s"}}],["$","div",null,{"className":"absolute bottom-1/4 left-1/3 w-1 h-1 bg-secondary/20 rounded-full animate-float","style":{"animationDelay":"2s"}}]]}]]}]}],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}]]}]}]]}],{"children":["documents",["$","$1","c",{"children":[null,["$","$La",null,{"Component":"$b","slots":{"children":["$","$L6",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L8",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]},"params":{},"promise":"$@c"}]]}],{"children":[["slug","en/dark/all-chat-on-this/json-parsing","c"],["$","$1","c",{"children":[null,["$","$L6",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L8",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$Ld",["$","$Le",null,{"children":"$Lf"}],[["$","link","0",{"rel":"stylesheet","href":"/MilkWind-Website/_next/static/css/5eacd01f773eed7f.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","$L10",null,{"children":["$L11","$L12",["$","$L13",null,{"promise":"$@14"}]]}]]}],{},null,false]},null,false]},[["$","$L15","l",{}],[],[]],false]},[["$","$L16","l",{}],[],[]],false],["$","$1","h",{"children":[null,["$","$1","FhqTjSMms0Mz7yeWyDU4Z",{"children":[["$","$L17",null,{"children":"$L18"}],null]}],null]}],false]],"m":"$undefined","G":["$19","$undefined"],"s":false,"S":true}
1a:"$Sreact.suspense"
1b:I[74911,[],"AsyncMetadata"]
c:{}
f:["$","$1a",null,{"fallback":null,"children":["$","$L1b",null,{"promise":"$@1c"}]}]
1d:I[57340,["5584","static/chunks/b498d07c-095637f0f10883c6.js","2415","static/chunks/2415-689c103fb3d2c28d.js","6874","static/chunks/6874-fbe9a08eb79b991c.js","9554","static/chunks/9554-b714f9de28e85d30.js","1873","static/chunks/app/documents/%5B...slug%5D/page-8f3efa7e6c6c5377.js"],"DocumentPageClient"]
1e:T631e1,<h1 id="all-chat-on-this-configuration-parsing-implementation-complete-data-flow-from-configuration-to-messages" class="group relative text-4xl font-bold mt-8 mb-4 text-foreground leading-tight">
            <a href="#all-chat-on-this-configuration-parsing-implementation-complete-data-flow-from-configuration-to-messages" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to All-Chat-on-This Configuration Parsing Implementation: Complete Data Flow from Configuration to Messages">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            All-Chat-on-This Configuration Parsing Implementation: Complete Data Flow from Configuration to Messages
        </h1>
<p class="text-base leading-7 mb-4 text-foreground">Handling API differences across various AI service providers is like dealing with a “United Nations of data formats,” and ACOT is specifically designed to solve this problem.</p>
<p class="text-base leading-7 mb-4 text-foreground">This article will deeply analyze every aspect from the UserConfigDO configuration class to sendMessage message transmission, comprehensively deconstructing this data processing system that unifies different AI service provider APIs.</p>
<h2 id="configuration-class-design-userconfigdo’s-flexible-architecture" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#configuration-class-design-userconfigdo’s-flexible-architecture" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Configuration Class Design: UserConfigDO’s Flexible Architecture">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Configuration Class Design: UserConfigDO’s Flexible Architecture
        </h2>
<p class="text-base leading-7 mb-4 text-foreground">When dealing with diverse AI service provider APIs, the main challenge isn’t calling the API itself, but designing a sufficiently flexible configuration system to adapt to vastly different authentication methods and data formats.</p>
<h3 id="flexible-api-key-placement-strategy" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#flexible-api-key-placement-strategy" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Flexible API Key Placement Strategy">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Flexible API Key Placement Strategy
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20API%20key%20placement%20strategy%0Aprivate%20String%20apiKeyPlacement%3B%20%2F%2F%20'header'%2C%20'body'%2C%20or%20'custom_header'%0Aprivate%20String%20apiKeyHeader%3B%20%2F%2F%20Custom%20header%20name%20when%20apiKeyPlacement%3D'custom_header'%0Aprivate%20String%20apiKeyBodyPath%3B%20%2F%2F%20JSON%20path%20when%20apiKeyPlacement%3D'body'">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// API key placement strategy</span>
<span class="hljs-keyword inline">private</span> String apiKeyPlacement; <span class="hljs-comment inline">// &#x27;header&#x27;, &#x27;body&#x27;, or &#x27;custom_header&#x27;</span>
<span class="hljs-keyword inline">private</span> String apiKeyHeader; <span class="hljs-comment inline">// Custom header name when apiKeyPlacement=&#x27;custom_header&#x27;</span>
<span class="hljs-keyword inline">private</span> String apiKeyBodyPath; <span class="hljs-comment inline">// JSON path when apiKeyPlacement=&#x27;body&#x27;</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Why do we need three strategies?</strong></p>
<p class="text-base leading-7 mb-4 text-foreground">Let’s look at the diversity of AI service providers in reality:</p>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Header Strategy (Most Common)</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="http" data-code="%23%20OpenAI%20style%0AAuthorization%3A%20Bearer%20sk-xxxxxxxxxxxx%0A%23%20Anthropic%20style%0Ax-api-key%3A%20sk-ant-xxxxxxxxxxxx%0A%23%20Google%20style%0AX-Goog-Api-Key%3A%20AIzaxxxxxxxxxxxx">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">http</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-http"># OpenAI style
<span class="hljs-attribute inline">Authorization</span><span class="hljs-punctuation inline">: </span>Bearer sk-xxxxxxxxxxxx

# Anthropic style
<span class="hljs-attribute inline">x-api-key</span><span class="hljs-punctuation inline">: </span>sk-ant-xxxxxxxxxxxx

# Google style
<span class="hljs-attribute inline">X-Goog-Api-Key</span><span class="hljs-punctuation inline">: </span>AIzaxxxxxxxxxxxx
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Body Strategy (Embedded)</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%7B%0A%22api_key%22%3A%20%22sk-xxxxxxxxxxxx%22%2C%0A%22messages%22%3A%20%5B...%5D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;api_key&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;sk-xxxxxxxxxxxx&quot;</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;messages&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>...<span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Custom Header Strategy (Personalized)</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="http" data-code="Custom-Auth-Token%3A%20xxxxxxxxxxxx%0AX-Custom-Key%3A%20xxxxxxxxxxxx">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">http</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-http"><span class="hljs-attribute inline">Custom-Auth-Token</span><span class="hljs-punctuation inline">: </span>xxxxxxxxxxxx
<span class="hljs-attribute inline">X-Custom-Key</span><span class="hljs-punctuation inline">: </span>xxxxxxxxxxxx
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">The mathematical expression of this design:<br class="block">
<span class="katex-display inline"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mi>P</mi><mi>I</mi><mi>A</mi><mi>u</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>S</mi><mi>t</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>g</mi><mi>y</mi><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>H</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>if placement = ’header’</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>B</mi><mi>o</mi><mi>d</mi><mi>y</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>if placement = ’body’</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>C</mi><mi>u</mi><mi>s</mi><mi>t</mi><mi>o</mi><mi>m</mi><mi>H</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>if placement = ’custom_header’</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">API Authentication Strategy = \begin{cases} Header &amp; \text{if placement = &#x27;header&#x27;} \\ Body &amp; \text{if placement = &#x27;body&#x27;} \\ CustomHeader &amp; \text{if placement = &#x27;custom\_header&#x27;} \end{cases}</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal inline">A</span><span class="mord mathnormal inline" style="margin-right:0.13889em;">P</span><span class="mord mathnormal inline" style="margin-right:0.07847em;">I</span><span class="mord mathnormal inline">A</span><span class="mord mathnormal inline">u</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">h</span><span class="mord mathnormal inline">e</span><span class="mord mathnormal inline">n</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">i</span><span class="mord mathnormal inline">c</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">i</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline">n</span><span class="mord mathnormal inline">St</span><span class="mord mathnormal inline" style="margin-right:0.02778em;">r</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">e</span><span class="mord mathnormal inline" style="margin-right:0.03588em;">g</span><span class="mord mathnormal inline" style="margin-right:0.03588em;">y</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:4.32em;vertical-align:-1.91em;"></span><span class="minner inline"><span class="mopen inline"><span class="delimsizing mult inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:2.35em;"><span style="top:-2.2em;" class="inline"><span class="pstrut inline" style="height:3.15em;"></span><span class="delimsizinginner delim-size4 inline"><span class="inline">⎩</span></span></span><span style="top:-2.192em;" class="inline"><span class="pstrut inline" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;" class="inline"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;" class="inline"><span class="pstrut inline" style="height:3.15em;"></span><span class="delimsizinginner delim-size4 inline"><span class="inline">⎨</span></span></span><span style="top:-4.292em;" class="inline"><span class="pstrut inline" style="height:3.15em;"></span><span style="height:0.316em;width:0.8889em;" class="inline"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;" class="inline"><span class="pstrut inline" style="height:3.15em;"></span><span class="delimsizinginner delim-size4 inline"><span class="inline">⎧</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:1.85em;"><span class="inline"></span></span></span></span></span></span><span class="mord inline"><span class="mtable inline"><span class="col-align-l inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:2.41em;"><span style="top:-4.41em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord mathnormal inline">He</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">d</span><span class="mord mathnormal inline" style="margin-right:0.02778em;">er</span></span></span><span style="top:-2.97em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord mathnormal inline" style="margin-right:0.05017em;">B</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline">d</span><span class="mord mathnormal inline" style="margin-right:0.03588em;">y</span></span></span><span style="top:-1.53em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord mathnormal inline" style="margin-right:0.07153em;">C</span><span class="mord mathnormal inline">u</span><span class="mord mathnormal inline">s</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline">m</span><span class="mord mathnormal inline">He</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">d</span><span class="mord mathnormal inline" style="margin-right:0.02778em;">er</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:1.91em;"><span class="inline"></span></span></span></span></span><span class="arraycolsep inline" style="width:1em;"></span><span class="col-align-l inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:2.41em;"><span style="top:-4.41em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord text inline"><span class="mord inline">if placement = ’header’</span></span></span></span><span style="top:-2.97em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord text inline"><span class="mord inline">if placement = ’body’</span></span></span></span><span style="top:-1.53em;" class="inline"><span class="pstrut inline" style="height:3.008em;"></span><span class="mord inline"><span class="mord text inline"><span class="mord inline">if placement = ’custom_header’</span></span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:1.91em;"><span class="inline"></span></span></span></span></span></span></span><span class="mclose nulldelimiter inline"></span></span></span></span></span></span></p>
<h3 id="json-template-design-unified-processing" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#json-template-design-unified-processing" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to JSON Template Design: Unified Processing">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            JSON Template Design: Unified Processing
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20JSON%20templates%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20requestTemplate%3B%20%2F%2F%20Request%20JSON%20template%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20responseTemplate%3B%20%2F%2F%20Response%20processing%20JSON%20template">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// JSON templates</span>
<span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
<span class="hljs-keyword inline">private</span> Map requestTemplate; <span class="hljs-comment inline">// Request JSON template</span>

<span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
<span class="hljs-keyword inline">private</span> Map responseTemplate; <span class="hljs-comment inline">// Response processing JSON template</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Why use JacksonTypeHandler?</strong></p>
<p class="text-base leading-7 mb-4 text-foreground">This is MyBatis Plus’s elegant solution for handling complex objects:</p>
<p class="text-base leading-7 mb-4 text-foreground">Wrong approach:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9D%8C%20Manual%20serialization%2C%20error-prone%0Aprivate%20String%20requestTemplateJson%3B%0A%2F%2F%20Requires%20manual%20conversion%20when%20used%0AObjectMapper%20mapper%20%3D%20new%20ObjectMapper()%3B%0AMap%20template%20%3D%20mapper.readValue(requestTemplateJson%2C%20Map.class)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ❌ Manual serialization, error-prone</span>
<span class="hljs-keyword inline">private</span> String requestTemplateJson;

<span class="hljs-comment inline">// Requires manual conversion when used</span>
<span class="hljs-type inline">ObjectMapper</span> <span class="hljs-variable inline">mapper</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ObjectMapper</span>();
<span class="hljs-type inline">Map</span> <span class="hljs-variable inline">template</span> <span class="hljs-operator inline">=</span> mapper.readValue(requestTemplateJson, Map.class);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">Correct approach:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9C%85%20Automatic%20serialization%2C%20type-safe%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20requestTemplate%3B%0A%2F%2F%20Direct%20use%2C%20no%20conversion%20needed%0Atemplate.put(%22model%22%2C%20%22gpt-4%22)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ✅ Automatic serialization, type-safe</span>
<span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
<span class="hljs-keyword inline">private</span> Map requestTemplate;

<span class="hljs-comment inline">// Direct use, no conversion needed</span>
template.put(<span class="hljs-string inline">&quot;model&quot;</span>, <span class="hljs-string inline">&quot;gpt-4&quot;</span>);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Template compatibility measures</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">Different service providers may have vastly different request formats:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%2F%2F%20OpenAI%20format%0A%7B%0A%22model%22%3A%20%22gpt-4%22%2C%0A%22messages%22%3A%20%5B...%5D%2C%0A%22temperature%22%3A%200.7%0A%7D%0A%2F%2F%20Claude%20format%0A%7B%0A%22model%22%3A%20%22claude-3-sonnet-20240229%22%2C%0A%22max_tokens%22%3A%201024%2C%0A%22messages%22%3A%20%5B...%5D%0A%7D%0A%2F%2F%20Custom%20API%20format%0A%7B%0A%22engine%22%3A%20%22custom-model%22%2C%0A%22prompt%22%3A%20%22...%22%2C%0A%22config%22%3A%20%7B%0A%22temperature%22%3A%200.7%2C%0A%22max_length%22%3A%202048%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-comment inline">// OpenAI format</span>
<span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;model&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;gpt-4&quot;</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;messages&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>...<span class="hljs-punctuation inline">]</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;temperature&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-number inline">0.7</span>
<span class="hljs-punctuation inline">}</span>

<span class="hljs-comment inline">// Claude format</span>
<span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;model&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;claude-3-sonnet-20240229&quot;</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;max_tokens&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-number inline">1024</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;messages&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>...<span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>

<span class="hljs-comment inline">// Custom API format</span>
<span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;engine&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;custom-model&quot;</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;prompt&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;...&quot;</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;config&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;temperature&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-number inline">0.7</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;max_length&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-number inline">2048</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">}</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">Through templating, we can preset any format and then dynamically fill in message content.</p>
<h3 id="message-path-configuration-design-supporting-complex-nested-structures" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#message-path-configuration-design-supporting-complex-nested-structures" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Message Path Configuration Design: Supporting Complex Nested Structures">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Message Path Configuration Design: Supporting Complex Nested Structures
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Request%20and%20response%20processing%20strategies%0Aprivate%20String%20requestMessageGroupPath%3B%20%2F%2F%20JSON%20path%20for%20message%20groups%0Aprivate%20String%20requestRolePathFromGroup%3B%20%2F%2F%20JSON%20path%20for%20role%20in%20message%20group%0Aprivate%20String%20requestTextPathFromGroup%3B%20%2F%2F%20JSON%20path%20for%20request%20text%0Aprivate%20String%20responseTextPath%3B%20%2F%2F%20JSON%20path%20for%20response%20text%0Aprivate%20String%20responseThinkingTextPath%3B%20%2F%2F%20JSON%20path%20for%20thinking%20text%20in%20response">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Request and response processing strategies</span>
<span class="hljs-keyword inline">private</span> String requestMessageGroupPath; <span class="hljs-comment inline">// JSON path for message groups</span>
<span class="hljs-keyword inline">private</span> String requestRolePathFromGroup; <span class="hljs-comment inline">// JSON path for role in message group</span>
<span class="hljs-keyword inline">private</span> String requestTextPathFromGroup; <span class="hljs-comment inline">// JSON path for request text</span>
<span class="hljs-keyword inline">private</span> String responseTextPath; <span class="hljs-comment inline">// JSON path for response text</span>
<span class="hljs-keyword inline">private</span> String responseThinkingTextPath; <span class="hljs-comment inline">// JSON path for thinking text in response</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">How does the path system work?</strong></p>
<p class="text-base leading-7 mb-4 text-foreground">Take a complex API format as an example:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%7B%0A%22model%22%3A%20%22gpt-4%22%2C%0A%22parameters%22%3A%20%7B%0A%22conversation%22%3A%20%7B%0A%22messages%22%3A%20%5B%0A%7B%0A%22role%22%3A%20%22user%22%2C%0A%22content%22%3A%20%22Hello%22%0A%7D%0A%5D%0A%7D%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;model&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;gpt-4&quot;</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;parameters&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;conversation&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;messages&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>
<span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;role&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;user&quot;</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;Hello&quot;</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">}</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">Corresponding path configuration:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><code>requestMessageGroupPath</code>: <code>&quot;parameters.conversation.messages&quot;</code></li>
<li class="text-foreground leading-relaxed"><code>requestRolePathFromGroup</code>: <code>&quot;role&quot;</code></li>
<li class="text-foreground leading-relaxed"><code>requestTextPathFromGroup</code>: <code>&quot;content&quot;</code></li>
</ul>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Mathematical expression of JsonPath</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">The path parsing algorithm can be expressed as:<br class="block">
<span class="katex-display inline"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>J</mi><mi>s</mi><mi>o</mi><mi>n</mi><mi>P</mi><mi>a</mi><mi>t</mi><mi>h</mi><mo stretchy="false">(</mo><mi>o</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo separator="true">,</mo><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mo stretchy="false">)</mo><mo>=</mo><mi>o</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy="false">[</mo><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mn>0</mn></msub><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mn>1</mn></msub><mo stretchy="false">]</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo stretchy="false">[</mo><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mi>n</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">JsonPath(object, path) = object[path_0][path_1]...[path_n]</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.09618em;">J</span><span class="mord mathnormal inline">so</span><span class="mord mathnormal inline">n</span><span class="mord mathnormal inline" style="margin-right:0.13889em;">P</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">h</span><span class="mopen inline">(</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.05724em;">bj</span><span class="mord mathnormal inline">ec</span><span class="mord mathnormal inline">t</span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">h</span><span class="mclose inline">)</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.05724em;">bj</span><span class="mord mathnormal inline">ec</span><span class="mord mathnormal inline">t</span><span class="mopen inline">[</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">0</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mclose inline">]</span><span class="mopen inline">[</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">1</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mclose inline">]</span><span class="mord inline">...</span><span class="mopen inline">[</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mathnormal mtight inline">n</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mclose inline">]</span></span></span></span></span></p>
<p class="text-base leading-7 mb-4 text-foreground">Where <span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mo>=</mo><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mn>0</mn></msub><mi mathvariant="normal">.</mi><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mn>1</mn></msub><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi>p</mi><mi>a</mi><mi>t</mi><msub><mi>h</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">path = path_0.path_1...path_n</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">h</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">0</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mord inline">.</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline">1</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mord inline">...</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord inline"><span class="mord mathnormal inline">h</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mathnormal mtight inline">n</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span></span></span></span></p>
<h3 id="complete-userconfigdo-structure-diagram" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#complete-userconfigdo-structure-diagram" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Complete UserConfigDO Structure Diagram">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Complete UserConfigDO Structure Diagram
        </h3>
<div class="mermaid block" id="mermaid-1765781087513-hokd4n3">classDiagram
class UserConfigDO {
+Long id
+Boolean isAvailable
+String name
+String apiUrl
+String apiKey

+String apiKeyPlacement
+String apiKeyHeader
+String apiKeyBodyPath

+Map requestTemplate
+Map responseTemplate
+Map headers

+String requestMessageGroupPath
+String requestRolePathFromGroup
+String requestTextPathFromGroup
+String responseTextPath
+String responseThinkingTextPath

+String requestUserRoleField
+String requestAssistantField
+String requestSystemField

+LocalDateTime lastUsedTime
+String secretKey
}</div>
<h2 id="data-parsing-logic-the-dual-performance-of-preparerequestdata" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#data-parsing-logic-the-dual-performance-of-preparerequestdata" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Data Parsing Logic: The Dual Performance of prepareRequestData">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Data Parsing Logic: The Dual Performance of prepareRequestData
        </h2>
<p class="text-base leading-7 mb-4 text-foreground">Data preparation is the core of the entire system, requiring conversion of user configuration into sendable HTTP requests. ACOT provides two overloaded methods to handle different scenarios.</p>
<h3 id="test-version-basic-logic-for-single-message-processing" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#test-version-basic-logic-for-single-message-processing" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Test Version: Basic Logic for Single Message Processing">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Test Version: Basic Logic for Single Message Processing
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="public%20static%20Map%20prepareRequestData(UserConfigDO%20config%2C%20String%20messageText)%20%7B%0A%2F%2F%20Prepare%20request%20headers%0AMap%20headers%20%3D%20new%20HashMap(config.getHeaders()%20!%3D%20null%20%3F%20config.getHeaders()%20%3A%20new%20HashMap())%3B%0A%2F%2F%20Check%20if%20API%20key%20is%20encrypted%2C%20decrypt%20if%20needed%0AString%20apiKey%20%3D%20config.getApiKey()%3B%0Aif%20(apiKey%20!%3D%20null%20%26%26%20apiKey.startsWith(%22enc%3A%22)%20%26%26%20StringUtils.hasText(config.getSecretKey()))%20%7B%0Atry%20%7B%0AapiKey%20%3D%20decryptApiKey(apiKey.substring(4)%2C%20config.getSecretKey())%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22Error%20decrypting%20API%20key%22%2C%20e)%3B%0Athrow%20new%20ServiceException(CONFIG_NOT_EXISTS%2C%20%22Failed%20to%20decrypt%20API%20key%3A%20%22%20%2B%20e.getMessage())%3B%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> Map <span class="hljs-title function_ inline">prepareRequestData</span><span class="hljs-params inline">(UserConfigDO config, String messageText)</span> {
<span class="hljs-comment inline">// Prepare request headers</span>
<span class="hljs-type inline">Map</span> <span class="hljs-variable inline">headers</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(config.getHeaders() != <span class="hljs-literal inline">null</span> ? config.getHeaders() : <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;());

<span class="hljs-comment inline">// Check if API key is encrypted, decrypt if needed</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">apiKey</span> <span class="hljs-operator inline">=</span> config.getApiKey();
<span class="hljs-keyword inline">if</span> (apiKey != <span class="hljs-literal inline">null</span> &amp;&amp; apiKey.startsWith(<span class="hljs-string inline">&quot;enc:&quot;</span>) &amp;&amp; StringUtils.hasText(config.getSecretKey())) {
<span class="hljs-keyword inline">try</span> {
apiKey = decryptApiKey(apiKey.substring(<span class="hljs-number inline">4</span>), config.getSecretKey());
} <span class="hljs-keyword inline">catch</span> (Exception e) {
log.error(<span class="hljs-string inline">&quot;Error decrypting API key&quot;</span>, e);
<span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIG_NOT_EXISTS, <span class="hljs-string inline">&quot;Failed to decrypt API key: &quot;</span> + e.getMessage());
}
}
</code></pre>
            </div>
        
<h3 id="triple-dispatch-for-api-key-placement" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#triple-dispatch-for-api-key-placement" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Triple Dispatch for API Key Placement">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Triple Dispatch for API Key Placement
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Add%20API%20key%20to%20request%20headers%20based%20on%20placement%20strategy%0Aif%20(%22header%22.equals(config.getApiKeyPlacement())%20%7C%7C%20config.getApiKeyPlacement()%20%3D%3D%20null)%20%7B%0Aheaders.put(%22Authorization%22%2C%20%22Bearer%20%22%20%2B%20apiKey)%3B%0A%7D%20else%20if%20(%22custom_header%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyHeader()%20!%3D%20null)%20%7B%0Aheaders.put(config.getApiKeyHeader()%2C%20apiKey)%3B%0A%7D%0A%2F%2F%20Prepare%20request%20body%20by%20cloning%20template%0AMap%20requestBody%20%3D%20new%20HashMap(config.getRequestTemplate())%3B%0A%2F%2F%20Add%20API%20key%20to%20request%20body%20if%20needed%0Aif%20(%22body%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyBodyPath()%20!%3D%20null)%20%7B%0AJsonUtils.setValueByPath(requestBody%2C%20config.getApiKeyBodyPath()%2C%20apiKey)%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Add API key to request headers based on placement strategy</span>
<span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;header&quot;</span>.equals(config.getApiKeyPlacement()) || config.getApiKeyPlacement() == <span class="hljs-literal inline">null</span>) {
headers.put(<span class="hljs-string inline">&quot;Authorization&quot;</span>, <span class="hljs-string inline">&quot;Bearer &quot;</span> + apiKey);
} <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;custom_header&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyHeader() != <span class="hljs-literal inline">null</span>) {
headers.put(config.getApiKeyHeader(), apiKey);
}

<span class="hljs-comment inline">// Prepare request body by cloning template</span>
<span class="hljs-type inline">Map</span> <span class="hljs-variable inline">requestBody</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(config.getRequestTemplate());

<span class="hljs-comment inline">// Add API key to request body if needed</span>
<span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;body&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyBodyPath() != <span class="hljs-literal inline">null</span>) {
JsonUtils.setValueByPath(requestBody, config.getApiKeyBodyPath(), apiKey);
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Strategy Pattern</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">Each placement method has its specific processing logic:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="typescript" data-code="%2F%2F%20Pseudocode%20representation%20of%20dispatch%20logic%0Aswitch(apiKeyPlacement)%20%7B%0Acase%20'header'%3A%0Aheaders%5B'Authorization'%5D%20%3D%20'Bearer%20'%20%2B%20apiKey%3B%0Abreak%3B%0Acase%20'custom_header'%3A%0Aheaders%5BapiKeyHeader%5D%20%3D%20apiKey%3B%0Abreak%3B%0Acase%20'body'%3A%0AsetValueByPath(requestBody%2C%20apiKeyBodyPath%2C%20apiKey)%3B%0Abreak%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">typescript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-typescript"><span class="hljs-comment inline">// Pseudocode representation of dispatch logic</span>
<span class="hljs-keyword inline">switch</span>(apiKeyPlacement) {
<span class="hljs-keyword inline">case</span> <span class="hljs-string inline">&#x27;header&#x27;</span>:
headers[<span class="hljs-string inline">&#x27;Authorization&#x27;</span>] = <span class="hljs-string inline">&#x27;Bearer &#x27;</span> + apiKey;
<span class="hljs-keyword inline">break</span>;
<span class="hljs-keyword inline">case</span> <span class="hljs-string inline">&#x27;custom_header&#x27;</span>:
headers[apiKeyHeader] = apiKey;
<span class="hljs-keyword inline">break</span>;
<span class="hljs-keyword inline">case</span> <span class="hljs-string inline">&#x27;body&#x27;</span>:
<span class="hljs-title function_ inline">setValueByPath</span>(requestBody, apiKeyBodyPath, apiKey);
<span class="hljs-keyword inline">break</span>;
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">JsonUtils.setValueByPath path setting</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">This method can handle complex nested paths:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Path%20%22auth.credentials.api_key%22%20will%20be%20resolved%20as%3A%0A%2F%2F%20requestBody.auth.credentials.api_key%20%3D%20apiKey%0AJsonUtils.setValueByPath(requestBody%2C%20%22auth.credentials.api_key%22%2C%20apiKey)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Path &quot;auth.credentials.api_key&quot; will be resolved as:</span>
<span class="hljs-comment inline">// requestBody.auth.credentials.api_key = apiKey</span>
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;auth.credentials.api_key&quot;</span>, apiKey);
</code></pre>
            </div>
        
<h3 id="production-version-conversation-history-processing" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#production-version-conversation-history-processing" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Production Version: Conversation History Processing">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Production Version: Conversation History Processing
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="public%20static%20Map%20prepareRequestData(UserConfigDO%20config%2C%20String%20messageText%2C%20List%20conversationMessages)%20%7B%0A%2F%2F%20...%20same%20logic%20as%20before%0A%2F%2F%20Create%20message%20group%20and%20add%20conversation%20history%0Aif%20(StringUtils.hasText(config.getRequestMessageGroupPath())%20%26%26%20(conversationMessages%20!%3D%20null%20%7C%7C%20messageText%20!%3D%20null))%20%7B%0AList%3E%20messages%20%3D%20new%20ArrayList()%3B%0A%2F%2F%20Add%20previous%20messages%0Aif%20(conversationMessages%20!%3D%20null)%20%7B%0Afor%20(ConversationMessageDO%20message%20%3A%20conversationMessages)%20%7B%0A%2F%2F%20Skip%20system%20messages%0Aif%20(%22system%22.equals(message.getRole()))%20%7B%0Acontinue%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> Map <span class="hljs-title function_ inline">prepareRequestData</span><span class="hljs-params inline">(UserConfigDO config, String messageText, List conversationMessages)</span> {
<span class="hljs-comment inline">// ... same logic as before</span>

<span class="hljs-comment inline">// Create message group and add conversation history</span>
<span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getRequestMessageGroupPath()) &amp;&amp; (conversationMessages != <span class="hljs-literal inline">null</span> || messageText != <span class="hljs-literal inline">null</span>)) {
List&gt; messages = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;();

<span class="hljs-comment inline">// Add previous messages</span>
<span class="hljs-keyword inline">if</span> (conversationMessages != <span class="hljs-literal inline">null</span>) {
<span class="hljs-keyword inline">for</span> (ConversationMessageDO message : conversationMessages) {
<span class="hljs-comment inline">// Skip system messages</span>
<span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;system&quot;</span>.equals(message.getRole())) {
<span class="hljs-keyword inline">continue</span>;
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Core algorithm for conversation history processing</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Role%20mapping%20strategy%0AString%20userRoleValue%20%3D%20StringUtils.hasText(config.getRequestUserRoleField())%20%3F%0Aconfig.getRequestUserRoleField()%20%3A%20%22user%22%3B%0AString%20assistantRoleValue%20%3D%20StringUtils.hasText(config.getRequestAssistantField())%20%3F%0Aconfig.getRequestAssistantField()%20%3A%20%22assistant%22%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Role mapping strategy</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">userRoleValue</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestUserRoleField()) ?
config.getRequestUserRoleField() : <span class="hljs-string inline">&quot;user&quot;</span>;

<span class="hljs-type inline">String</span> <span class="hljs-variable inline">assistantRoleValue</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestAssistantField()) ?
config.getRequestAssistantField() : <span class="hljs-string inline">&quot;assistant&quot;</span>;
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">This mapping mechanism solves the problem of different role field differences among service providers:</p>
<table class="w-full border-collapse mb-4 shadow-sm rounded-lg overflow-hidden">
<thead class="bg-surface">
<tr class="border-b border-gray-200"><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">Service Provider</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">User Role</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">Assistant Role</th></tr>
</thead>
<tbody class="bg-background divide-y divide-gray-200">
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">OpenAI</td><td class="px-4 py-3 text-sm text-foreground">“user”</td><td class="px-4 py-3 text-sm text-foreground">“assistant”</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Claude</td><td class="px-4 py-3 text-sm text-foreground">“user”</td><td class="px-4 py-3 text-sm text-foreground">“assistant”</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Custom API</td><td class="px-4 py-3 text-sm text-foreground">“human”</td><td class="px-4 py-3 text-sm text-foreground">“ai”</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Some APIs</td><td class="px-4 py-3 text-sm text-foreground">“customer”</td><td class="px-4 py-3 text-sm text-foreground">“agent”</td></tr>
</tbody>
</table>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Dynamic message object construction</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="Map%20messageObj%20%3D%20new%20HashMap()%3B%0A%2F%2F%20Dynamically%20set%20role%20field%20name%0Aif%20(%22user%22.equals(message.getRole()))%20%7B%0AmessageObj.put(rolePath%2C%20userRoleValue)%3B%0A%7D%20else%20if%20(%22assistant%22.equals(message.getRole()))%20%7B%0AmessageObj.put(rolePath%2C%20assistantRoleValue)%3B%0A%7D%0A%2F%2F%20Dynamically%20set%20content%20field%20name%0AmessageObj.put(textPath%2C%20message.getContent())%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-type inline">Map</span> <span class="hljs-variable inline">messageObj</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
<span class="hljs-comment inline">// Dynamically set role field name</span>
<span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;user&quot;</span>.equals(message.getRole())) {
messageObj.put(rolePath, userRoleValue);
} <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;assistant&quot;</span>.equals(message.getRole())) {
messageObj.put(rolePath, assistantRoleValue);
}
<span class="hljs-comment inline">// Dynamically set content field name</span>
messageObj.put(textPath, message.getContent());
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">If certain APIs have user and AI role fields that aren’t the default <code>user</code> and <code>assistant</code>, this functionality can support custom configuration of user and AI field names.</p>
<h2 id="message-generation-and-transmission-logic-complete-business-process-of-sendmessage" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#message-generation-and-transmission-logic-complete-business-process-of-sendmessage" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Message Generation and Transmission Logic: Complete Business Process of sendMessage">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Message Generation and Transmission Logic: Complete Business Process of sendMessage
        </h2>
<p class="text-base leading-7 mb-4 text-foreground">Message transmission is the ultimate goal of the entire system, involving permission verification, data preparation, HTTP calls, response parsing, and other multiple aspects.</p>
<h3 id="permission-verification" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#permission-verification" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Permission Verification">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Permission Verification
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Verify%20conversation%20belongs%20to%20this%20user%0AConversationDO%20conversation%20%3D%20conversationService.getConversation(conversationId%2C%20userId)%3B%0Aif%20(conversation%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(CONVERSATION_NOT_EXISTS.getCode()%2C%20CONVERSATION_NOT_EXISTS.getMsg())%3B%0A%7D%0A%2F%2F%20Get%20configuration%0AUserConfigDO%20config%20%3D%20userConfigService.getConfig(configId%2C%20userId)%3B%0Aif%20(config%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(CONFIGURATION_NOT_EXISTS.getCode()%2C%20CONFIGURATION_NOT_EXISTS.getMsg())%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Verify conversation belongs to this user</span>
<span class="hljs-type inline">ConversationDO</span> <span class="hljs-variable inline">conversation</span> <span class="hljs-operator inline">=</span> conversationService.getConversation(conversationId, userId);
<span class="hljs-keyword inline">if</span> (conversation == <span class="hljs-literal inline">null</span>) {
<span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONVERSATION_NOT_EXISTS.getCode(), CONVERSATION_NOT_EXISTS.getMsg());
}

<span class="hljs-comment inline">// Get configuration</span>
<span class="hljs-type inline">UserConfigDO</span> <span class="hljs-variable inline">config</span> <span class="hljs-operator inline">=</span> userConfigService.getConfig(configId, userId);
<span class="hljs-keyword inline">if</span> (config == <span class="hljs-literal inline">null</span>) {
<span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIGURATION_NOT_EXISTS.getCode(), CONFIGURATION_NOT_EXISTS.getMsg());
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Dual permission verification mechanism</strong>:</p>
<ol class="list-decimal list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Conversation ownership verification</strong>: Ensures users can only operate their own conversations</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Configuration ownership verification</strong>: Ensures users can only use their own configurations</li>
</ol>
<p class="text-base leading-7 mb-4 text-foreground">This design prevents common security issues:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Horizontal privilege escalation</strong>: User A cannot access User B’s conversations</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Configuration leakage</strong>: User A cannot use User B’s API configurations</li>
</ul>
<h3 id="message-creation-strategy-create-first-save-later" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#message-creation-strategy-create-first-save-later" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Message Creation Strategy: Create First, Save Later">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Message Creation Strategy: Create First, Save Later
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Create%20user%20message%20(but%20don't%20save%20yet)%0AConversationMessageDO%20userMessageDO%20%3D%20new%20ConversationMessageDO()%0A.setConversationId(conversationId)%0A.setConfigId(configId)%0A.setRole(%22user%22)%0A.setContent(userMessage)%3B%0A%2F%2F%20Get%20historical%20messages%20in%20conversation%0AList%20previousMessages%20%3D%20list(new%20LambdaQueryWrapper()%0A.eq(ConversationMessageDO%3A%3AgetConversationId%2C%20conversationId)%0A.orderByAsc(ConversationMessageDO%3A%3AgetCreateTime))%3B%0A%2F%2F%20Generate%20assistant%20reply%0AConversationMessageDO%20assistantMessageDO%20%3D%20generateAssistantResponse(userMessage%2C%20config%2C%20conversationId%2C%20configId%2C%20previousMessages)%3B%0A%2F%2F%20If%20execution%20reaches%20here%2C%20API%20call%20was%20successful%2C%20now%20save%20user%20message%0Asave(userMessageDO)%3B%0Asave(assistantMessageDO)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Create user message (but don&#x27;t save yet)</span>
<span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">userMessageDO</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ConversationMessageDO</span>()
.setConversationId(conversationId)
.setConfigId(configId)
.setRole(<span class="hljs-string inline">&quot;user&quot;</span>)
.setContent(userMessage);

<span class="hljs-comment inline">// Get historical messages in conversation</span>
<span class="hljs-type inline">List</span> <span class="hljs-variable inline">previousMessages</span> <span class="hljs-operator inline">=</span> list(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">LambdaQueryWrapper</span>()
.eq(ConversationMessageDO::getConversationId, conversationId)
.orderByAsc(ConversationMessageDO::getCreateTime));

<span class="hljs-comment inline">// Generate assistant reply</span>
<span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">assistantMessageDO</span> <span class="hljs-operator inline">=</span> generateAssistantResponse(userMessage, config, conversationId, configId, previousMessages);

<span class="hljs-comment inline">// If execution reaches here, API call was successful, now save user message</span>
save(userMessageDO);
save(assistantMessageDO);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Why create user message first but don’t save?</strong></p>
<p class="text-base leading-7 mb-4 text-foreground">This is a transactional design pattern, following the “all succeed or all fail” principle:</p>
<p class="text-base leading-7 mb-4 text-foreground">Wrong approach:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9D%8C%20Save%20user%20message%20first%2C%20if%20API%20call%20fails%2C%20data%20inconsistency%0Asave(userMessageDO)%3B%0Atry%20%7B%0AConversationMessageDO%20response%20%3D%20callAPI(...)%3B%0Asave(response)%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0A%2F%2F%20User%20message%20saved%20but%20no%20reply%20-%20data%20inconsistency!%0Athrow%20e%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ❌ Save user message first, if API call fails, data inconsistency</span>
save(userMessageDO);
<span class="hljs-keyword inline">try</span> {
<span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">response</span> <span class="hljs-operator inline">=</span> callAPI(...);
save(response);
} <span class="hljs-keyword inline">catch</span> (Exception e) {
<span class="hljs-comment inline">// User message saved but no reply - data inconsistency!</span>
<span class="hljs-keyword inline">throw</span> e;
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">Correct approach:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9C%85%20Try%20API%20call%20first%2C%20batch%20save%20after%20success%0AConversationMessageDO%20userMessageDO%20%3D%20createUserMessage(...)%3B%0AConversationMessageDO%20assistantResponse%20%3D%20callAPI(...)%3B%0A%2F%2F%20API%20successful%2C%20batch%20save%0Asave(userMessageDO)%3B%0Asave(assistantResponse)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ✅ Try API call first, batch save after success</span>
<span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">userMessageDO</span> <span class="hljs-operator inline">=</span> createUserMessage(...);
<span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">assistantResponse</span> <span class="hljs-operator inline">=</span> callAPI(...);
<span class="hljs-comment inline">// API successful, batch save</span>
save(userMessageDO);
save(assistantResponse);
</code></pre>
            </div>
        
<h3 id="generateassistantresponse-core-engine-for-http-calls" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#generateassistantresponse-core-engine-for-http-calls" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to generateAssistantResponse: Core Engine for HTTP Calls">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            generateAssistantResponse: Core Engine for HTTP Calls
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="private%20ConversationMessageDO%20generateAssistantResponse(%0AString%20userMessage%2C%0AUserConfigDO%20config%2C%0ALong%20conversationId%2C%0ALong%20configId%2C%0AList%20conversationMessages)%20%7B%0A%2F%2F%20Use%20general%20method%20to%20prepare%20request%20data%20including%20conversation%20history%0AMap%20requestData%20%3D%20HttpUtils.prepareRequestData(config%2C%20userMessage%2C%20conversationMessages)%3B%0AMap%20headers%20%3D%20(Map)%20requestData.get(%22headers%22)%3B%0AMap%20requestBody%20%3D%20(Map)%20requestData.get(%22requestBody%22)%3B%0A%2F%2F%20Execute%20actual%20HTTP%20request%0AString%20requestBodyStr%20%3D%20JsonUtils.toJsonString(requestBody)%3B%0AString%20responseStr%20%3D%20HttpUtils.post(config.getApiUrl()%2C%20headers%2C%20requestBodyStr)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">private</span> ConversationMessageDO <span class="hljs-title function_ inline">generateAssistantResponse</span><span class="hljs-params inline">(
String userMessage,
UserConfigDO config,
Long conversationId,
Long configId,
List conversationMessages)</span> {

<span class="hljs-comment inline">// Use general method to prepare request data including conversation history</span>
<span class="hljs-type inline">Map</span> <span class="hljs-variable inline">requestData</span> <span class="hljs-operator inline">=</span> HttpUtils.prepareRequestData(config, userMessage, conversationMessages);
<span class="hljs-type inline">Map</span> <span class="hljs-variable inline">headers</span> <span class="hljs-operator inline">=</span> (Map) requestData.get(<span class="hljs-string inline">&quot;headers&quot;</span>);
<span class="hljs-type inline">Map</span> <span class="hljs-variable inline">requestBody</span> <span class="hljs-operator inline">=</span> (Map) requestData.get(<span class="hljs-string inline">&quot;requestBody&quot;</span>);

<span class="hljs-comment inline">// Execute actual HTTP request</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">requestBodyStr</span> <span class="hljs-operator inline">=</span> JsonUtils.toJsonString(requestBody);
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">responseStr</span> <span class="hljs-operator inline">=</span> HttpUtils.post(config.getApiUrl(), headers, requestBodyStr);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Complete data flow of HTTP request</strong>:</p>
<div class="mermaid block" id="mermaid-1765781087513-i0asdrq">sequenceDiagram
participant Service as ConversationService
participant Utils as HttpUtils
participant API as AI_API
participant Parser as JsonUtils

Service->>Utils: prepareRequestData(config, message, history)
Utils->>Utils: Decrypt API key
Utils->>Utils: Build request headers
Utils->>Utils: Build request body
Utils-->>Service: {headers, requestBody}

Service->>Parser: toJsonString(requestBody)
Parser-->>Service: requestBodyStr

Service->>Utils: post(url, headers, body)
Utils->>API: HTTP POST
API-->>Utils: JSON Response
Utils-->>Service: responseStr

Service->>Parser: parseObject(responseStr)
Parser-->>Service: responseMap

Service->>Parser: extractValueFromPath(responseMap, textPath)
Parser-->>Service: content</div>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Dual-path design for response parsing</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Extract%20content%20and%20thinking%20text%20from%20response%20using%20specified%20paths%0AString%20content%20%3D%20null%3B%0AString%20thinking%20%3D%20null%3B%0Aif%20(StringUtils.hasText(config.getResponseTextPath()))%20%7B%0Acontent%20%3D%20JsonUtils.extractValueFromPath(responseMap%2C%20config.getResponseTextPath())%3B%0A%7D%0Aif%20(StringUtils.hasText(config.getResponseThinkingTextPath()))%20%7B%0Athinking%20%3D%20JsonUtils.extractValueFromPath(responseMap%2C%20config.getResponseThinkingTextPath())%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Extract content and thinking text from response using specified paths</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">content</span> <span class="hljs-operator inline">=</span> <span class="hljs-literal inline">null</span>;
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">thinking</span> <span class="hljs-operator inline">=</span> <span class="hljs-literal inline">null</span>;

<span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getResponseTextPath())) {
content = JsonUtils.extractValueFromPath(responseMap, config.getResponseTextPath());
}

<span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getResponseThinkingTextPath())) {
thinking = JsonUtils.extractValueFromPath(responseMap, config.getResponseThinkingTextPath());
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">This design supports different service provider response formats:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%2F%2F%20OpenAI%20format%0A%7B%0A%22choices%22%3A%20%5B%0A%7B%0A%22message%22%3A%20%7B%0A%22content%22%3A%20%22This%20is%20the%20reply%20content%22%0A%7D%0A%7D%0A%5D%0A%7D%0A%2F%2F%20Path%3A%20%22choices.0.message.content%22%0A%2F%2F%20Claude%20format%0A%7B%0A%22content%22%3A%20%5B%0A%7B%0A%22text%22%3A%20%22This%20is%20Claude's%20reply%22%0A%7D%0A%5D%0A%7D%0A%2F%2F%20Path%3A%20%22content.0.text%22%0A%2F%2F%20Format%20supporting%20thinking%20process%0A%7B%0A%22response%22%3A%20%7B%0A%22content%22%3A%20%22This%20is%20the%20reply%20content%22%2C%0A%22thinking%22%3A%20%22This%20is%20the%20thinking%20process%22%0A%7D%0A%7D%0A%2F%2F%20Content%20path%3A%20%22response.content%22%0A%2F%2F%20Thinking%20path%3A%20%22response.thinking%22">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-comment inline">// OpenAI format</span>
<span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;choices&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>
<span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;message&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;This is the reply content&quot;</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-comment inline">// Path: &quot;choices.0.message.content&quot;</span>

<span class="hljs-comment inline">// Claude format</span>
<span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>
<span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;text&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;This is Claude&#x27;s reply&quot;</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-comment inline">// Path: &quot;content.0.text&quot;</span>

<span class="hljs-comment inline">// Format supporting thinking process</span>
<span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;response&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;This is the reply content&quot;</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;thinking&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;This is the thinking process&quot;</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-comment inline">// Content path: &quot;response.content&quot;</span>
<span class="hljs-comment inline">// Thinking path: &quot;response.thinking&quot;</span>
</code></pre>
            </div>
        
<h3 id="transaction-management-and-caching-strategy" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#transaction-management-and-caching-strategy" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Transaction Management and Caching Strategy">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Transaction Management and Caching Strategy
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40Override%0A%40Transactional%0A%40Caching(evict%20%3D%20%7B%0A%40CacheEvict(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0A%7D)">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@Override</span>
<span class="hljs-meta inline">@Transactional</span>
<span class="hljs-meta inline">@Caching(evict = {
@CacheEvict(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)
})</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">@Transactional rollback mechanism</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">Spring’s transaction management ensures data consistency:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40Transactional%0Apublic%20ConversationMessageDO%20sendMessage(...)%20%7B%0Atry%20%7B%0A%2F%2F%201.%20Verify%20permissions%0AvalidatePermissions()%3B%0A%2F%2F%202.%20Call%20API%0AConversationMessageDO%20response%20%3D%20callAPI()%3B%0A%2F%2F%203.%20Save%20messages%0Asave(userMessage)%3B%0Asave(response)%3B%0A%2F%2F%204.%20Update%20conversation%20time%0AupdateConversation()%3B%0Areturn%20response%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0A%2F%2F%20Any%20exception%20will%20trigger%20rollback%2C%20ensuring%20data%20consistency%0Athrow%20e%3B%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@Transactional</span>
<span class="hljs-keyword inline">public</span> ConversationMessageDO <span class="hljs-title function_ inline">sendMessage</span><span class="hljs-params inline">(...)</span> {
<span class="hljs-keyword inline">try</span> {
<span class="hljs-comment inline">// 1. Verify permissions</span>
validatePermissions();

<span class="hljs-comment inline">// 2. Call API</span>
<span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">response</span> <span class="hljs-operator inline">=</span> callAPI();

<span class="hljs-comment inline">// 3. Save messages</span>
save(userMessage);
save(response);

<span class="hljs-comment inline">// 4. Update conversation time</span>
updateConversation();

<span class="hljs-keyword inline">return</span> response;
} <span class="hljs-keyword inline">catch</span> (Exception e) {
<span class="hljs-comment inline">// Any exception will trigger rollback, ensuring data consistency</span>
<span class="hljs-keyword inline">throw</span> e;
}
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Considerations for cache invalidation strategy</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40CacheEvict(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@CacheEvict(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">This annotation ensures that when new messages are generated, related caches are cleared. Cache key design considers:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Conversation isolation</strong>: Different conversation caches are independent</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">User isolation</strong>: Different user caches are independent</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Precise invalidation</strong>: Only clear related caches, don’t affect other data</li>
</ul>
<h3 id="configuration-monitoring-markconfigurationasavailable" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#configuration-monitoring-markconfigurationasavailable" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Configuration Monitoring: markConfigurationAsAvailable">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Configuration Monitoring: markConfigurationAsAvailable
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Mark%20configuration%20as%20available%20because%20it%20was%20successfully%20used%0AmarkConfigurationAsAvailable(configId%2C%20userId)%3B%0A%40Override%0Apublic%20boolean%20markConfigurationAsAvailable(Long%20configId%2C%20Long%20userId)%20%7B%0AUserConfigDO%20config%20%3D%20userConfigService.getConfig(configId%2C%20userId)%3B%0Aif%20(config%20%3D%3D%20null)%20%7B%0Areturn%20false%3B%0A%7D%0A%2F%2F%20Set%20isAvailable%20to%20true%20and%20set%20lastUsedTime%20to%20current%20time%0AuserConfigService.setAvailableAndUpdateLastUsedTime(configId%2C%20true)%3B%0Areturn%20true%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Mark configuration as available because it was successfully used</span>
markConfigurationAsAvailable(configId, userId);

<span class="hljs-meta inline">@Override</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">markConfigurationAsAvailable</span><span class="hljs-params inline">(Long configId, Long userId)</span> {
<span class="hljs-type inline">UserConfigDO</span> <span class="hljs-variable inline">config</span> <span class="hljs-operator inline">=</span> userConfigService.getConfig(configId, userId);
<span class="hljs-keyword inline">if</span> (config == <span class="hljs-literal inline">null</span>) {
<span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">false</span>;
}

<span class="hljs-comment inline">// Set isAvailable to true and set lastUsedTime to current time</span>
userConfigService.setAvailableAndUpdateLastUsedTime(configId, <span class="hljs-literal inline">true</span>);

<span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">true</span>;
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Business value of availability marking</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">This seemingly simple operation actually carries important business logic:</p>
<ol class="list-decimal list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Health check</strong>: Successful API calls prove configuration is available</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Usage statistics</strong>: Record last usage time for analysis</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Auto-repair</strong>: Reactivate configurations previously marked as unavailable</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">User experience</strong>: Let users know which configurations are available</li>
</ol>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Statistical value of lastUsedTime</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="sql" data-code="--%20Can%20analyze%20user%20usage%20patterns%0ASELECT%20configId%2C%20COUNT(*)%20as%20usage_count%2C%0AMAX(lastUsedTime)%20as%20last_used%2C%0AAVG(TIMESTAMPDIFF(SECOND%2C%20createTime%2C%20lastUsedTime))%20as%20avg_response_time%0AFROM%20user_config%0AWHERE%20userId%20%3D%20%3F%0AGROUP%20BY%20configId%0AORDER%20BY%20usage_count%20DESC%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">sql</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-sql"><span class="hljs-comment inline">-- Can analyze user usage patterns</span>
<span class="hljs-keyword inline">SELECT</span> configId, <span class="hljs-built_in inline">COUNT</span>(<span class="hljs-operator inline">*</span>) <span class="hljs-keyword inline">as</span> usage_count,
<span class="hljs-built_in inline">MAX</span>(lastUsedTime) <span class="hljs-keyword inline">as</span> last_used,
<span class="hljs-built_in inline">AVG</span>(TIMESTAMPDIFF(<span class="hljs-keyword inline">SECOND</span>, createTime, lastUsedTime)) <span class="hljs-keyword inline">as</span> avg_response_time
<span class="hljs-keyword inline">FROM</span> user_config
<span class="hljs-keyword inline">WHERE</span> userId <span class="hljs-operator inline">=</span> ?
<span class="hljs-keyword inline">GROUP</span> <span class="hljs-keyword inline">BY</span> configId
<span class="hljs-keyword inline">ORDER</span> <span class="hljs-keyword inline">BY</span> usage_count <span class="hljs-keyword inline">DESC</span>;
</code></pre>
            </div>
        
<h2 id="json-path-parsing-engine-deep-algorithm-analysis-of-jsonutils" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#json-path-parsing-engine-deep-algorithm-analysis-of-jsonutils" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to JSON Path Parsing Engine: Deep Algorithm Analysis of JsonUtils">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            JSON Path Parsing Engine: Deep Algorithm Analysis of JsonUtils
        </h2>
<p class="text-base leading-7 mb-4 text-foreground"><del class="line-through opacity-60">The hardest episode.</del></p>
<h3 id="mathematical-model-of-path-parsing" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#mathematical-model-of-path-parsing" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Mathematical Model of Path Parsing">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Mathematical Model of Path Parsing
        </h3>
<p class="text-base leading-7 mb-4 text-foreground">JSON path parsing is essentially a <strong class="font-bold text-foreground">tree traversal problem</strong>, where we need to convert string paths into object access sequences.</p>
<p class="text-base leading-7 mb-4 text-foreground">Given path <code>path = &quot;a.b[0].c.d[1].e&quot;</code>, the parsing algorithm can be expressed as:</p>
<p class="text-base leading-7 mb-4 text-foreground"><span class="katex-display inline"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>T</mi><mi>r</mi><mi>a</mi><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>a</mi><mi>l</mi><mo stretchy="false">(</mo><mi>o</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo separator="true">,</mo><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>n</mi></munderover><mi>A</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mi>o</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><msub><mi>t</mi><mi>i</mi></msub><mo separator="true">,</mo><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><msub><mi>n</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">PathTraversal(object, path) = \prod_{i=0}^{n} Access(object_i, token_i)</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal inline" style="margin-right:0.13889em;">P</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">h</span><span class="mord mathnormal inline" style="margin-right:0.13889em;">T</span><span class="mord mathnormal inline" style="margin-right:0.02778em;">r</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline" style="margin-right:0.03588em;">v</span><span class="mord mathnormal inline">ers</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline" style="margin-right:0.01968em;">l</span><span class="mopen inline">(</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.05724em;">bj</span><span class="mord mathnormal inline">ec</span><span class="mord mathnormal inline">t</span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">a</span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">h</span><span class="mclose inline">)</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;" class="inline"><span class="pstrut inline" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline"><span class="mord mathnormal mtight inline">i</span><span class="mrel mtight inline">=</span><span class="mord mtight inline">0</span></span></span></span><span style="top:-3.05em;" class="inline"><span class="pstrut inline" style="height:3.05em;"></span><span class="inline"><span class="mop op-symbol large-op inline">∏</span></span></span><span style="top:-4.3em;margin-left:0em;" class="inline"><span class="pstrut inline" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mtight inline"><span class="mord mathnormal mtight inline">n</span></span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:1.2777em;"><span class="inline"></span></span></span></span></span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline">A</span><span class="mord mathnormal inline">ccess</span><span class="mopen inline">(</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.05724em;">bj</span><span class="mord mathnormal inline">ec</span><span class="mord inline"><span class="mord mathnormal inline">t</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mathnormal mtight inline">i</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.03148em;">k</span><span class="mord mathnormal inline">e</span><span class="mord inline"><span class="mord mathnormal inline">n</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mathnormal mtight inline">i</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span><span class="mclose inline">)</span></span></span></span></span></p>
<p class="text-base leading-7 mb-4 text-foreground">Where:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><msub><mi>n</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">token_i</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal inline">t</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline" style="margin-right:0.03148em;">k</span><span class="mord mathnormal inline">e</span><span class="mord inline"><span class="mord mathnormal inline">n</span><span class="msupsub inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;" class="inline"><span class="pstrut inline" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight inline"><span class="mord mathnormal mtight inline">i</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.15em;"><span class="inline"></span></span></span></span></span></span></span></span></span> is the i-th access token in the path</li>
<li class="text-foreground leading-relaxed"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">Access</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.6833em;"></span><span class="mord mathnormal inline">A</span><span class="mord mathnormal inline">ccess</span></span></span></span> function chooses different access strategies based on token type</li>
</ul>
<h3 id="extractvaluefrompath-core-algorithm-for-path-extraction" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#extractvaluefrompath-core-algorithm-for-path-extraction" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to extractValueFromPath: Core Algorithm for Path Extraction">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            extractValueFromPath: Core Algorithm for Path Extraction
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="public%20static%20String%20extractValueFromPath(Map%20data%2C%20String%20path)%20%7B%0AString%5B%5D%20parts%20%3D%20path.split(%22%5C%5C.%22)%3B%20%2F%2F%20Split%20path%20by%20dots%0AObject%20current%20%3D%20data%3B%20%2F%2F%20Current%20traversed%20object%0Afor%20(String%20part%20%3A%20parts)%20%7B%0Aif%20(current%20%3D%3D%20null)%20%7B%0Areturn%20null%3B%20%2F%2F%20Defensive%20check%3A%20return%20immediately%20if%20null%20encountered%0A%7D%0A%2F%2F%20Handle%20array%20notation%2C%20like%20choices%5B0%5D%0Aif%20(part.contains(%22%5B%22)%20%26%26%20part.contains(%22%5D%22))%20%7B%0A%2F%2F%20Algorithm%20core%3A%20parse%20array%20name%20and%20index%0AString%20arrayName%20%3D%20part.substring(0%2C%20part.indexOf('%5B'))%3B%0Aint%20index%20%3D%20Integer.parseInt(part.substring(part.indexOf('%5B')%20%2B%201%2C%20part.indexOf('%5D')))%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">extractValueFromPath</span><span class="hljs-params inline">(Map data, String path)</span> {
String[] parts = path.split(<span class="hljs-string inline">&quot;\\.&quot;</span>); <span class="hljs-comment inline">// Split path by dots</span>
<span class="hljs-type inline">Object</span> <span class="hljs-variable inline">current</span> <span class="hljs-operator inline">=</span> data; <span class="hljs-comment inline">// Current traversed object</span>

<span class="hljs-keyword inline">for</span> (String part : parts) {
<span class="hljs-keyword inline">if</span> (current == <span class="hljs-literal inline">null</span>) {
<span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>; <span class="hljs-comment inline">// Defensive check: return immediately if null encountered</span>
}

<span class="hljs-comment inline">// Handle array notation, like choices[0]</span>
<span class="hljs-keyword inline">if</span> (part.contains(<span class="hljs-string inline">&quot;[&quot;</span>) &amp;&amp; part.contains(<span class="hljs-string inline">&quot;]&quot;</span>)) {
<span class="hljs-comment inline">// Algorithm core: parse array name and index</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> part.substring(<span class="hljs-number inline">0</span>, part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>));
<span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(part.substring(part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>) + <span class="hljs-number inline">1</span>, part.indexOf(<span class="hljs-string inline">&#x27;]&#x27;</span>)));
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Algorithm analysis of array index parsing</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Time%20complexity%20analysis%20of%20string%20parsing%0A%2F%2F%20part%20%3D%20%22choices%5B0%5D%22%0AString%20arrayName%20%3D%20part.substring(0%2C%20part.indexOf('%5B'))%3B%20%2F%2F%20O(n)%0Aint%20index%20%3D%20Integer.parseInt(part.substring(...))%3B%20%2F%2F%20O(1)">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Time complexity analysis of string parsing</span>
<span class="hljs-comment inline">// part = &quot;choices[0]&quot;</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> part.substring(<span class="hljs-number inline">0</span>, part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>)); <span class="hljs-comment inline">// O(n)</span>
<span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(part.substring(...)); <span class="hljs-comment inline">// O(1)</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Type-safe access strategy</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="if%20(current%20instanceof%20Map)%20%7B%0AMap%20map%20%3D%20(Map)%20current%3B%0Aif%20(map.containsKey(arrayName)%20%26%26%20map.get(arrayName)%20instanceof%20List)%20%7B%0AList%20array%20%3D%20(List)%20map.get(arrayName)%3B%0Aif%20(index%20%2F%2F%20Safe%20array%20element%20access%0A%7D%20else%20%7B%0Areturn%20null%3B%20%2F%2F%20Index%20out%20of%20bounds%2C%20return%20null%0A%7D%0A%7D%20else%20%7B%0Areturn%20null%3B%20%2F%2F%20Field%20doesn't%20exist%20or%20type%20mismatch%0A%7D%0A%7D%20else%20%7B%0Areturn%20null%3B%20%2F%2F%20Current%20object%20is%20not%20Map%20type%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">if</span> (current <span class="hljs-keyword inline">instanceof</span> Map) {
<span class="hljs-type inline">Map</span> <span class="hljs-variable inline">map</span> <span class="hljs-operator inline">=</span> (Map) current;
<span class="hljs-keyword inline">if</span> (map.containsKey(arrayName) &amp;&amp; map.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List) {
<span class="hljs-type inline">List</span> <span class="hljs-variable inline">array</span> <span class="hljs-operator inline">=</span> (List) map.get(arrayName);
<span class="hljs-keyword inline">if</span> (index &lt; array.size()) {
current = array.get(index); <span class="hljs-comment inline">// Safe array element access</span>
} <span class="hljs-keyword inline">else</span> {
<span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>; <span class="hljs-comment inline">// Index out of bounds, return null</span>
}
} <span class="hljs-keyword inline">else</span> {
<span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>; <span class="hljs-comment inline">// Field doesn&#x27;t exist or type mismatch</span>
}
} <span class="hljs-keyword inline">else</span> {
<span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>; <span class="hljs-comment inline">// Current object is not Map type</span>
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Why do we need so many type checks?</strong></p>
<p class="text-base leading-7 mb-4 text-foreground">In the dynamically typed JSON world, we cannot guarantee data structure consistency:</p>
<p class="text-base leading-7 mb-4 text-foreground">Wrong approach:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9D%8C%20Dangerous%20direct%20access%0AList%20array%20%3D%20(List)%20((Map)%20current).get(arrayName)%3B%0Acurrent%20%3D%20array.get(index)%3B%20%2F%2F%20May%20throw%20NullPointerException%2C%20ClassCastException%2C%20IndexOutOfBoundsException">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ❌ Dangerous direct access</span>
<span class="hljs-type inline">List</span> <span class="hljs-variable inline">array</span> <span class="hljs-operator inline">=</span> (List) ((Map) current).get(arrayName);
current = array.get(index); <span class="hljs-comment inline">// May throw NullPointerException, ClassCastException, IndexOutOfBoundsException</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">Correct approach:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9C%85%20Multiple%20protective%20checks%0Aif%20(current%20instanceof%20Map)%20%7B%20%2F%2F%20Type%20check%0AMap%20map%20%3D%20(Map)%20current%3B%0Aif%20(map.containsKey(arrayName)%20%26%26%20%2F%2F%20Existence%20check%0Amap.get(arrayName)%20instanceof%20List)%20%7B%20%2F%2F%20Type%20check%0AList%20array%20%3D%20(List)%20map.get(arrayName)%3B%0Aif%20(index%20%2F%2F%20Boundary%20check%0Acurrent%20%3D%20array.get(index)%3B%0A%7D%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ✅ Multiple protective checks</span>
<span class="hljs-keyword inline">if</span> (current <span class="hljs-keyword inline">instanceof</span> Map) { <span class="hljs-comment inline">// Type check</span>
<span class="hljs-type inline">Map</span> <span class="hljs-variable inline">map</span> <span class="hljs-operator inline">=</span> (Map) current;
<span class="hljs-keyword inline">if</span> (map.containsKey(arrayName) &amp;&amp; <span class="hljs-comment inline">// Existence check</span>
map.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List) { <span class="hljs-comment inline">// Type check</span>
<span class="hljs-type inline">List</span> <span class="hljs-variable inline">array</span> <span class="hljs-operator inline">=</span> (List) map.get(arrayName);
<span class="hljs-keyword inline">if</span> (index &lt; array.size()) { <span class="hljs-comment inline">// Boundary check</span>
current = array.get(index);
}
}
}
</code></pre>
            </div>
        
<h3 id="setvaluebypath-intelligent-construction-for-path-setting" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#setvaluebypath-intelligent-construction-for-path-setting" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to setValueByPath: Intelligent Construction for Path Setting">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            setValueByPath: Intelligent Construction for Path Setting
        </h3>
<p class="text-base leading-7 mb-4 text-foreground">Compared to the read-only access of <code>extractValueFromPath</code>, <code>setValueByPath</code> needs to solve a more complex problem: <strong class="font-bold text-foreground">how to intelligently construct paths in incomplete JSON structures</strong>.</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="public%20static%20void%20setValueByPath(Map%20data%2C%20String%20path%2C%20Object%20value)%20%7B%0AString%5B%5D%20parts%20%3D%20path.split(%22%5C%5C.%22)%3B%0AMap%20current%20%3D%20data%3B%0A%2F%2F%20Step%201%3A%20Traverse%20path%2C%20ensure%20intermediate%20structures%20exist%0Afor%20(int%20i%20%3D%200%3B%20i%201%3B%20i%2B%2B)%20%7B%0AString%20part%20%3D%20parts%5Bi%5D%3B%0A%2F%2F%20Handle%20array%20path%20segments%0Aif%20(part.contains(%22%5B%22)%20%26%26%20part.contains(%22%5D%22))%20%7B%0AString%20arrayName%20%3D%20part.substring(0%2C%20part.indexOf('%5B'))%3B%0Aint%20index%20%3D%20Integer.parseInt(part.substring(part.indexOf('%5B')%20%2B%201%2C%20part.indexOf('%5D')))%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">setValueByPath</span><span class="hljs-params inline">(Map data, String path, Object value)</span> {
String[] parts = path.split(<span class="hljs-string inline">&quot;\\.&quot;</span>);
<span class="hljs-type inline">Map</span> <span class="hljs-variable inline">current</span> <span class="hljs-operator inline">=</span> data;

<span class="hljs-comment inline">// Step 1: Traverse path, ensure intermediate structures exist</span>
<span class="hljs-keyword inline">for</span> (<span class="hljs-type inline">int</span> <span class="hljs-variable inline">i</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">0</span>; i &lt; parts.length - <span class="hljs-number inline">1</span>; i++) {
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">part</span> <span class="hljs-operator inline">=</span> parts[i];

<span class="hljs-comment inline">// Handle array path segments</span>
<span class="hljs-keyword inline">if</span> (part.contains(<span class="hljs-string inline">&quot;[&quot;</span>) &amp;&amp; part.contains(<span class="hljs-string inline">&quot;]&quot;</span>)) {
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> part.substring(<span class="hljs-number inline">0</span>, part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>));
<span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(part.substring(part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>) + <span class="hljs-number inline">1</span>, part.indexOf(<span class="hljs-string inline">&#x27;]&#x27;</span>)));
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Intelligent array construction algorithm</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Create%20new%20array%20if%20it%20doesn't%20exist%0Aif%20(!current.containsKey(arrayName)%20%7C%7C%20!(current.get(arrayName)%20instanceof%20List))%20%7B%0Acurrent.put(arrayName%2C%20new%20ArrayList())%3B%0A%7D%0AList%20array%20%3D%20(List)%20current.get(arrayName)%3B%0A%2F%2F%20Core%20algorithm%3A%20array%20expansion%20to%20ensure%20index%20accessibility%0Awhile%20(array.size()%20new%20HashMap())%3B%20%2F%2F%20Fill%20with%20empty%20objects%0A%7D%0A%2F%2F%20Ensure%20index%20position%20is%20Map%20object%20(prepare%20for%20next%20level%20path)%0Aif%20(!(array.get(index)%20instanceof%20Map))%20%7B%0Aarray.set(index%2C%20new%20HashMap())%3B%0A%7D%0Acurrent%20%3D%20(Map)%20array.get(index)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Create new array if it doesn&#x27;t exist</span>
<span class="hljs-keyword inline">if</span> (!current.containsKey(arrayName) || !(current.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List)) {
current.put(arrayName, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;());
}

<span class="hljs-type inline">List</span> <span class="hljs-variable inline">array</span> <span class="hljs-operator inline">=</span> (List) current.get(arrayName);

<span class="hljs-comment inline">// Core algorithm: array expansion to ensure index accessibility</span>
<span class="hljs-keyword inline">while</span> (array.size() &lt;= index) {
array.add(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>()); <span class="hljs-comment inline">// Fill with empty objects</span>
}

<span class="hljs-comment inline">// Ensure index position is Map object (prepare for next level path)</span>
<span class="hljs-keyword inline">if</span> (!(array.get(index) <span class="hljs-keyword inline">instanceof</span> Map)) {
array.set(index, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>());
}

current = (Map) array.get(index);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Mathematical analysis of array expansion</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">Assuming current array length is <span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.4306em;"></span><span class="mord mathnormal inline">n</span></span></span></span>, target index is <span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.6944em;"></span><span class="mord mathnormal inline" style="margin-right:0.03148em;">k</span></span></span></span>, then:</p>
<p class="text-base leading-7 mb-4 text-foreground"><span class="katex-display inline"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mi>x</mi><mi>p</mi><mi>a</mi><mi>n</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi>k</mi><mo>−</mo><mi>n</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Expansion Count = \max(0, k - n + 1)</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal inline" style="margin-right:0.05764em;">E</span><span class="mord mathnormal inline">x</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">an</span><span class="mord mathnormal inline">s</span><span class="mord mathnormal inline">i</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline">n</span><span class="mord mathnormal inline" style="margin-right:0.07153em;">C</span><span class="mord mathnormal inline">o</span><span class="mord mathnormal inline">u</span><span class="mord mathnormal inline">n</span><span class="mord mathnormal inline">t</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mop inline">max</span><span class="mopen inline">(</span><span class="mord inline">0</span><span class="mpunct inline">,</span><span class="mspace inline" style="margin-right:0.1667em;"></span><span class="mord mathnormal inline" style="margin-right:0.03148em;">k</span><span class="mspace inline" style="margin-right:0.2222em;"></span><span class="mbin inline">−</span><span class="mspace inline" style="margin-right:0.2222em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal inline">n</span><span class="mspace inline" style="margin-right:0.2222em;"></span><span class="mbin inline">+</span><span class="mspace inline" style="margin-right:0.2222em;"></span></span><span class="base inline"><span class="strut inline" style="height:1em;vertical-align:-0.25em;"></span><span class="mord inline">1</span><span class="mclose inline">)</span></span></span></span></span></p>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Why fill with HashMap instead of null?</strong></p>
<p class="text-base leading-7 mb-4 text-foreground">This is a design trade-off:</p>
<p class="text-base leading-7 mb-4 text-foreground">Wrong approach:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9D%8C%20Fill%20with%20null%0Awhile%20(array.size()%20null)%3B%0A%7D%0A%2F%2F%20May%20cause%20NullPointerException%20on%20next%20access">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ❌ Fill with null</span>
<span class="hljs-keyword inline">while</span> (array.size() &lt;= index) {
array.add(<span class="hljs-literal inline">null</span>);
}
<span class="hljs-comment inline">// May cause NullPointerException on next access</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">Correct approach:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20%E2%9C%85%20Fill%20with%20empty%20objects%0Awhile%20(array.size()%20new%20HashMap())%3B%0A%7D%0A%2F%2F%20Ensure%20subsequent%20paths%20can%20continue%20building">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// ✅ Fill with empty objects</span>
<span class="hljs-keyword inline">while</span> (array.size() &lt;= index) {
array.add(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>());
}
<span class="hljs-comment inline">// Ensure subsequent paths can continue building</span>
</code></pre>
            </div>
        
<h3 id="practical-application-scenarios-of-path-parsing" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#practical-application-scenarios-of-path-parsing" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Practical Application Scenarios of Path Parsing">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Practical Application Scenarios of Path Parsing
        </h3>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Scenario 1: OpenAI Response Parsing</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%7B%0A%22choices%22%3A%20%5B%0A%7B%0A%22message%22%3A%20%7B%0A%22content%22%3A%20%22This%20is%20AI's%20reply%22%2C%0A%22role%22%3A%20%22assistant%22%0A%7D%0A%7D%0A%5D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;choices&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>
<span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;message&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;This is AI&#x27;s reply&quot;</span><span class="hljs-punctuation inline">,</span>
<span class="hljs-attr inline">&quot;role&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;assistant&quot;</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>
</code></pre>
            </div>
        

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Extract%20reply%20content%0AString%20content%20%3D%20JsonUtils.extractValueFromPath(response%2C%20%22choices%5B0%5D.message.content%22)%3B%0A%2F%2F%20Result%3A%20%22This%20is%20AI's%20reply%22">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Extract reply content</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">content</span> <span class="hljs-operator inline">=</span> JsonUtils.extractValueFromPath(response, <span class="hljs-string inline">&quot;choices[0].message.content&quot;</span>);
<span class="hljs-comment inline">// Result: &quot;This is AI&#x27;s reply&quot;</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Scenario 2: Claude Response Parsing</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="json" data-code="%7B%0A%22content%22%3A%20%5B%0A%7B%0A%22text%22%3A%20%22This%20is%20Claude's%20reply%22%0A%7D%0A%5D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">json</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-json"><span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;content&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-punctuation inline">[</span>
<span class="hljs-punctuation inline">{</span>
<span class="hljs-attr inline">&quot;text&quot;</span><span class="hljs-punctuation inline">:</span> <span class="hljs-string inline">&quot;This is Claude&#x27;s reply&quot;</span>
<span class="hljs-punctuation inline">}</span>
<span class="hljs-punctuation inline">]</span>
<span class="hljs-punctuation inline">}</span>
</code></pre>
            </div>
        

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Extract%20reply%20content%0AString%20content%20%3D%20JsonUtils.extractValueFromPath(response%2C%20%22content%5B0%5D.text%22)%3B%0A%2F%2F%20Result%3A%20%22This%20is%20Claude's%20reply%22">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Extract reply content</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">content</span> <span class="hljs-operator inline">=</span> JsonUtils.extractValueFromPath(response, <span class="hljs-string inline">&quot;content[0].text&quot;</span>);
<span class="hljs-comment inline">// Result: &quot;This is Claude&#x27;s reply&quot;</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Scenario 3: Complex Request Body Construction</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Build%20complex%20request%20body%0AMap%20requestBody%20%3D%20new%20HashMap()%3B%0A%2F%2F%20Set%20model%20information%0AJsonUtils.setValueByPath(requestBody%2C%20%22model%22%2C%20%22gpt-4%22)%3B%0A%2F%2F%20Set%20message%20array%0AJsonUtils.setValueByPath(requestBody%2C%20%22messages%5B0%5D.role%22%2C%20%22user%22)%3B%0AJsonUtils.setValueByPath(requestBody%2C%20%22messages%5B0%5D.content%22%2C%20%22Hello%22)%3B%0A%2F%2F%20Set%20configuration%20parameters%0AJsonUtils.setValueByPath(requestBody%2C%20%22config.temperature%22%2C%200.7)%3B%0AJsonUtils.setValueByPath(requestBody%2C%20%22config.max_tokens%22%2C%201000)%3B%0A%2F%2F%20Result%3A%0A%7B%0A%22model%22%3A%20%22gpt-4%22%2C%0A%22messages%22%3A%20%5B%0A%7B%0A%22role%22%3A%20%22user%22%2C%0A%22content%22%3A%20%22Hello%22%0A%7D%0A%5D%2C%0A%22config%22%3A%20%7B%0A%22temperature%22%3A%200.7%2C%0A%22max_tokens%22%3A%201000%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Build complex request body</span>
<span class="hljs-type inline">Map</span> <span class="hljs-variable inline">requestBody</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();

<span class="hljs-comment inline">// Set model information</span>
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;model&quot;</span>, <span class="hljs-string inline">&quot;gpt-4&quot;</span>);

<span class="hljs-comment inline">// Set message array</span>
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;messages[0].role&quot;</span>, <span class="hljs-string inline">&quot;user&quot;</span>);
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;messages[0].content&quot;</span>, <span class="hljs-string inline">&quot;Hello&quot;</span>);

<span class="hljs-comment inline">// Set configuration parameters</span>
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;config.temperature&quot;</span>, <span class="hljs-number inline">0.7</span>);
JsonUtils.setValueByPath(requestBody, <span class="hljs-string inline">&quot;config.max_tokens&quot;</span>, <span class="hljs-number inline">1000</span>);

<span class="hljs-comment inline">// Result:</span>
{
<span class="hljs-string inline">&quot;model&quot;</span>: <span class="hljs-string inline">&quot;gpt-4&quot;</span>,
<span class="hljs-string inline">&quot;messages&quot;</span>: [
{
<span class="hljs-string inline">&quot;role&quot;</span>: <span class="hljs-string inline">&quot;user&quot;</span>,
<span class="hljs-string inline">&quot;content&quot;</span>: <span class="hljs-string inline">&quot;Hello&quot;</span>
}
],
<span class="hljs-string inline">&quot;config&quot;</span>: {
<span class="hljs-string inline">&quot;temperature&quot;</span>: <span class="hljs-number inline">0.7</span>,
<span class="hljs-string inline">&quot;max_tokens&quot;</span>: <span class="hljs-number inline">1000</span>
}
}
</code></pre>
            </div>
        
<h3 id="defensive-design-for-edge-case-handling" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#defensive-design-for-edge-case-handling" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Defensive Design for Edge Case Handling">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Defensive Design for Edge Case Handling
        </h3>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Case 1: Path doesn’t exist</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Input%3A%20%7B%22user%22%3A%20%7B%22name%22%3A%20%22Zhang%20San%22%7D%7D%0A%2F%2F%20Path%3A%20user.age%0AString%20age%20%3D%20JsonUtils.extractValueFromPath(data%2C%20%22user.age%22)%3B%0A%2F%2F%20Result%3A%20null%20(no%20exception%20thrown)">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Input: {&quot;user&quot;: {&quot;name&quot;: &quot;Zhang San&quot;}}</span>
<span class="hljs-comment inline">// Path: user.age</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">age</span> <span class="hljs-operator inline">=</span> JsonUtils.extractValueFromPath(data, <span class="hljs-string inline">&quot;user.age&quot;</span>);
<span class="hljs-comment inline">// Result: null (no exception thrown)</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Case 2: Type mismatch</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Input%3A%20%7B%22user%22%3A%20%22Zhang%20San%22%7D%20(user%20is%20string%2C%20not%20object)%0A%2F%2F%20Path%3A%20user.name%0AString%20name%20%3D%20JsonUtils.extractValueFromPath(data%2C%20%22user.name%22)%3B%0A%2F%2F%20Result%3A%20null%20(no%20exception%20thrown)">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Input: {&quot;user&quot;: &quot;Zhang San&quot;} (user is string, not object)</span>
<span class="hljs-comment inline">// Path: user.name</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">name</span> <span class="hljs-operator inline">=</span> JsonUtils.extractValueFromPath(data, <span class="hljs-string inline">&quot;user.name&quot;</span>);
<span class="hljs-comment inline">// Result: null (no exception thrown)</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Case 3: Array index out of bounds</strong></p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Input%3A%20%7B%22items%22%3A%20%5B1%2C%202%2C%203%5D%7D%0A%2F%2F%20Path%3A%20items%5B10%5D%0AString%20item%20%3D%20JsonUtils.extractValueFromPath(data%2C%20%22items%5B10%5D%22)%3B%0A%2F%2F%20Result%3A%20null%20(no%20exception%20thrown)">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Input: {&quot;items&quot;: [1, 2, 3]}</span>
<span class="hljs-comment inline">// Path: items[10]</span>
<span class="hljs-type inline">String</span> <span class="hljs-variable inline">item</span> <span class="hljs-operator inline">=</span> JsonUtils.extractValueFromPath(data, <span class="hljs-string inline">&quot;items[10]&quot;</span>);
<span class="hljs-comment inline">// Result: null (no exception thrown)</span>
</code></pre>
            </div>
        
<h3 id="complete-method-architecture-diagram-of-jsonutils" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#complete-method-architecture-diagram-of-jsonutils" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Complete Method Architecture Diagram of JsonUtils">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Complete Method Architecture Diagram of JsonUtils
        </h3>
<div class="mermaid block" id="mermaid-1765781087513-52rvxq9">graph TB
A[JsonUtils Utility Class] --> B[Basic Serialization]
A --> C[Path Parsing]
A --> D[Type Conversion]

B --> B1[toJsonString]
B --> B2[parseObject]
B --> B3[parseArray]

C --> C1[extractValueFromPath]
C --> C2[setValueByPath]

D --> D1[Type-safe Conversion]
D --> D2[Silent Parsing]

C1 --> E[Path Splitting]
C1 --> F[Type Checking]
C1 --> G[Array Index Parsing]

C2 --> H[Intelligent Construction]
C2 --> I[Array Expansion]
C2 --> J[Recursive Path Creation]

E --> E1["path.split('\\.')"]
F --> F1[instanceof Check]
G --> G1[String substring]

H --> H1[Defensive Creation]
I --> I2[While Loop Expansion]
J --> J1[Recursive Map Creation]</div>
<p class="text-base leading-7 mb-4 text-foreground">Through this path parsing mechanism, ACOT achieves true <strong class="font-bold text-foreground">API format independence</strong>. No matter how AI service providers change their response formats, they can be</p>
<h2 id="complete-system-architecture-diagram" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#complete-system-architecture-diagram" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Complete System Architecture Diagram">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Complete System Architecture Diagram
        </h2>
<div class="mermaid block" id="mermaid-1765781087513-4zgi843">graph TB
    A[User Request] --> B[sendMessage Method]
    B --> C[Permission Verification]
    C --> D[Configuration Retrieval]
    D --> E[Message History Query]
    E --> F[prepareRequestData]
    
    F --> G[API Key Decryption]
    G --> H[Request Header Construction]
    H --> I[Request Body Construction]
    I --> J[Message Group Assembly]
    
    J --> K[HTTP POST Call]
    K --> L[Response Parsing]
    L --> M[JsonUtils Path Extraction]
    M --> N[Message Saving]
    N --> O[Cache Update]
    O --> P[Configuration Marking]
    P --> Q[Return Result]
    
    subgraph "Configuration System"
        D1[UserConfigDO]
        D2[Flexible Key Placement]
        D3[JSON Templating]
        D4[Path Configuration]
    end
    
    subgraph "Encryption System"  
        G1[CryptoJS Compatible]
        G2[EVP_BytesToKey]
        G3[AES/CBC Decryption]
    end
    
    subgraph "Data Processing"
        F1[Test Version prepareRequestData]
        F2[Production Version prepareRequestData]
        F3[Message History Processing]
        F4[Role Mapping]
    end
    
    subgraph "JSON Parsing Engine"
        M1[extractValueFromPath]
        M2[setValueByPath]
        M3[Path Splitting Algorithm]
        M4[Type Safety Check]
        M5[Array Index Parsing]
        M6[Intelligent Structure Building]
    end</div>
<h2 id="performance-optimization" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#performance-optimization" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Performance Optimization">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Performance Optimization
        </h2>
<h3 id="hierarchical-cache-strategy-design" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#hierarchical-cache-strategy-design" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Hierarchical Cache Strategy Design">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Hierarchical Cache Strategy Design
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%40Cacheable(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20List%20getMessages(Long%20conversationId%2C%20Long%20userId)%20%7B%0A%2F%2F%20Cache%20conversation%20message%20list%2C%20reduce%20database%20queries%0A%7D%0A%40Cacheable(key%20%3D%20%22'id%3A'%20%2B%20%23id%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20ConversationMessageDO%20getMessage(Long%20id%2C%20Long%20userId)%20%7B%0A%2F%2F%20Cache%20single%20message%2C%20support%20fast%20loading%20for%20detail%20pages%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-meta inline">@Cacheable(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)</span>
<span class="hljs-keyword inline">public</span> List&lt;ConversationMessageDO&gt; <span class="hljs-title function_ inline">getMessages</span><span class="hljs-params inline">(Long conversationId, Long userId)</span> {
    <span class="hljs-comment inline">// Cache conversation message list, reduce database queries</span>
}

<span class="hljs-meta inline">@Cacheable(key = &quot;&#x27;id:&#x27; + #id + &#x27;:user:&#x27; + #userId&quot;)</span> 
<span class="hljs-keyword inline">public</span> ConversationMessageDO <span class="hljs-title function_ inline">getMessage</span><span class="hljs-params inline">(Long id, Long userId)</span> {
    <span class="hljs-comment inline">// Cache single message, support fast loading for detail pages</span>
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Cache key design considerations</strong>:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Uniqueness</strong>: Ensure different data has different keys</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Predictability</strong>: Easy to manually clear specific caches</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Hierarchy</strong>: Support batch clearing of related caches</li>
</ul>
<h3 id="exception-handling" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#exception-handling" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Exception Handling">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Exception Handling
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="try%20%7B%0AConversationMessageDO%20assistantMessageDO%20%3D%20generateAssistantResponse(...)%3B%0Asave(userMessageDO)%3B%0Asave(assistantMessageDO)%3B%0Areturn%20assistantMessageDO%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22Error%20sending%20message%22%2C%20e)%3B%0A%2F%2F%20No%20longer%20create%20error%20messages%2C%20throw%20exception%20directly%0Aif%20(e%20instanceof%20ServiceException)%20%7B%0Athrow%20e%3B%0A%7D%0Athrow%20new%20ServiceException(MESSAGE_SEND_FAILED.getCode()%2C%20e.getMessage())%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">try</span> {
    <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">assistantMessageDO</span> <span class="hljs-operator inline">=</span> generateAssistantResponse(...);
    save(userMessageDO);
    save(assistantMessageDO);
    <span class="hljs-keyword inline">return</span> assistantMessageDO;
} <span class="hljs-keyword inline">catch</span> (Exception e) {
    log.error(<span class="hljs-string inline">&quot;Error sending message&quot;</span>, e);
    
    <span class="hljs-comment inline">// No longer create error messages, throw exception directly</span>
    <span class="hljs-keyword inline">if</span> (e <span class="hljs-keyword inline">instanceof</span> ServiceException) {
        <span class="hljs-keyword inline">throw</span> e;
    }
    <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(MESSAGE_SEND_FAILED.getCode(), e.getMessage());
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Exception handling principles</strong>:</p>
<ol class="list-decimal list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Fail fast</strong>: Terminate immediately when errors are found</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Information preservation</strong>: Record detailed error logs</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Type preservation</strong>: Maintain ServiceException type</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Avoid dirty data</strong>: Don’t save incomplete conversations</li>
</ol>
<h2 id="complete-code-analysis" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#complete-code-analysis" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Complete Code Analysis">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Complete Code Analysis
        </h2>
<h3 id="jsonutils-complete-implementation-of-json-parsing-utility-class" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#jsonutils-complete-implementation-of-json-parsing-utility-class" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to JsonUtils: Complete Implementation of JSON Parsing Utility Class">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            JsonUtils: Complete Implementation of JSON Parsing Utility Class
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="package%20com.chat.allchatonthis.common.util.json%3B%0Aimport%20cn.hutool.core.util.ArrayUtil%3B%0Aimport%20cn.hutool.core.util.StrUtil%3B%0Aimport%20cn.hutool.json.JSONUtil%3B%0Aimport%20com.fasterxml.jackson.annotation.JsonInclude%3B%0Aimport%20com.fasterxml.jackson.core.type.TypeReference%3B%0Aimport%20com.fasterxml.jackson.databind.DeserializationFeature%3B%0Aimport%20com.fasterxml.jackson.databind.JsonNode%3B%0Aimport%20com.fasterxml.jackson.databind.ObjectMapper%3B%0Aimport%20com.fasterxml.jackson.databind.SerializationFeature%3B%0Aimport%20com.fasterxml.jackson.datatype.jsr310.JavaTimeModule%3B%0Aimport%20lombok.SneakyThrows%3B%0Aimport%20lombok.extern.slf4j.Slf4j%3B%0Aimport%20java.io.IOException%3B%0Aimport%20java.lang.reflect.Type%3B%0Aimport%20java.util.ArrayList%3B%0Aimport%20java.util.HashMap%3B%0Aimport%20java.util.List%3B%0Aimport%20java.util.Map%3B%0A%2F**%0A*%20JSON%20Utility%20Class%20-%20ACOT's%20Core%20Data%20Parsing%20Engine%0A*%2F%0A%40Slf4j%0Apublic%20class%20JsonUtils%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Core%20Configuration%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%20Global%20ObjectMapper%20instance%20-%20Singleton%20pattern%2C%20thread-safe%20*%2F%0Aprivate%20static%20ObjectMapper%20objectMapper%20%3D%20new%20ObjectMapper()%3B%0Astatic%20%7B%0A%2F%2F%20Configure%20serialization%20behavior%3A%20don't%20fail%20on%20empty%20beans%0AobjectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS%2C%20false)%3B%0A%2F%2F%20Configure%20deserialization%20behavior%3A%20ignore%20unknown%20properties%0AobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES%2C%20false)%3B%0A%2F%2F%20Ignore%20null%20values%2C%20reduce%20data%20transmission%20volume%0AobjectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL)%3B%0A%2F%2F%20Support%20Java%208%20time%20types%0AobjectMapper.registerModules(new%20JavaTimeModule())%3B%0A%7D%0A%2F**%0A*%20Initialize%20ObjectMapper%20-%20Support%20Spring%20Boot%20auto-configuration%0A*%0A*%20%40param%20objectMapper%20Spring-managed%20ObjectMapper%20Bean%0A*%2F%0Apublic%20static%20void%20init(ObjectMapper%20objectMapper)%20%7B%0AJsonUtils.objectMapper%20%3D%20objectMapper%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Basic%20Serialization%20Methods%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20Object%20to%20JSON%20string%20-%20Most%20commonly%20used%20serialization%20method%0A*%0A*%20%40param%20object%20Object%20to%20serialize%0A*%20%40return%20JSON%20string%0A*%2F%0A%40SneakyThrows%0Apublic%20static%20String%20toJsonString(Object%20object)%20%7B%0Areturn%20objectMapper.writeValueAsString(object)%3B%0A%7D%0A%2F**%0A*%20Object%20to%20JSON%20byte%20array%20-%20Suitable%20for%20network%20transmission%0A*%0A*%20%40param%20object%20Object%20to%20serialize%0A*%20%40return%20JSON%20byte%20array%0A*%2F%0A%40SneakyThrows%0Apublic%20static%20byte%5B%5D%20toJsonByte(Object%20object)%20%7B%0Areturn%20objectMapper.writeValueAsBytes(object)%3B%0A%7D%0A%2F**%0A*%20Object%20to%20formatted%20JSON%20string%20-%20Suitable%20for%20debugging%20and%20logging%0A*%0A*%20%40param%20object%20Object%20to%20serialize%0A*%20%40return%20Formatted%20JSON%20string%0A*%2F%0A%40SneakyThrows%0Apublic%20static%20String%20toJsonPrettyString(Object%20object)%20%7B%0Areturn%20objectMapper.writerWithDefaultPrettyPrinter().writeValueAsString(object)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Basic%20Deserialization%20Methods%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20JSON%20string%20to%20object%20-%20Core%20deserialization%20method%0A*%0A*%20%40param%20text%20JSON%20string%0A*%20%40param%20clazz%20Target%20type%0A*%20%40return%20Deserialized%20object%0A*%2F%0Apublic%20static%20%20T%20parseObject(String%20text%2C%20Class%20clazz)%20%7B%0Aif%20(StrUtil.isEmpty(text))%20%7B%0Areturn%20null%3B%0A%7D%0Atry%20%7B%0Areturn%20objectMapper.readValue(text%2C%20clazz)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%20parsing%20failed%2C%20json%3A%7B%7D%22%2C%20text%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20Parse%20object%20from%20specified%20path%20in%20JSON%20string%20-%20Support%20nested%20extraction%0A*%0A*%20%40param%20text%20JSON%20string%0A*%20%40param%20path%20Path%20(e.g.%2C%20%22data.user%22)%0A*%20%40param%20clazz%20Target%20type%0A*%20%40return%20Parsed%20object%0A*%2F%0Apublic%20static%20%20T%20parseObject(String%20text%2C%20String%20path%2C%20Class%20clazz)%20%7B%0Aif%20(StrUtil.isEmpty(text))%20%7B%0Areturn%20null%3B%0A%7D%0Atry%20%7B%0AJsonNode%20treeNode%20%3D%20objectMapper.readTree(text)%3B%0AJsonNode%20pathNode%20%3D%20treeNode.path(path)%3B%0Areturn%20objectMapper.readValue(pathNode.toString()%2C%20clazz)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%20path%20parsing%20failed%2C%20json%3A%7B%7D%2C%20path%3A%7B%7D%22%2C%20text%2C%20path%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20Byte%20array%20to%20object%20-%20Suitable%20for%20network%20transmission%20data%0A*%0A*%20%40param%20bytes%20JSON%20byte%20array%0A*%20%40param%20clazz%20Target%20type%0A*%20%40return%20Deserialized%20object%0A*%2F%0Apublic%20static%20%20T%20parseObject(byte%5B%5D%20bytes%2C%20Class%20clazz)%20%7B%0Aif%20(ArrayUtil.isEmpty(bytes))%20%7B%0Areturn%20null%3B%0A%7D%0Atry%20%7B%0Areturn%20objectMapper.readValue(bytes%2C%20clazz)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%20byte%20array%20parsing%20failed%22%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20Parse%20complex%20types%20using%20TypeReference%20-%20Support%20generics%0A*%0A*%20%40param%20text%20JSON%20string%0A*%20%40param%20typeReference%20Type%20reference%0A*%20%40return%20Parsed%20object%0A*%2F%0Apublic%20static%20%20T%20parseObject(String%20text%2C%20TypeReference%20typeReference)%20%7B%0Atry%20%7B%0Areturn%20objectMapper.readValue(text%2C%20typeReference)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%20TypeReference%20parsing%20failed%2C%20json%3A%7B%7D%22%2C%20text%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20Silent%20parsing%20-%20Return%20null%20instead%20of%20throwing%20exception%20when%20parsing%20fails%0A*%0A*%20%40param%20text%20JSON%20string%0A*%20%40param%20typeReference%20Type%20reference%0A*%20%40return%20Parsed%20object%20or%20null%0A*%2F%0Apublic%20static%20%20T%20parseObjectQuietly(String%20text%2C%20TypeReference%20typeReference)%20%7B%0Atry%20%7B%0Areturn%20objectMapper.readValue(text%2C%20typeReference)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Areturn%20null%3B%0A%7D%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Array%20Parsing%20Methods%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20JSON%20string%20to%20List%20-%20Handle%20array%20types%0A*%0A*%20%40param%20text%20JSON%20string%0A*%20%40param%20clazz%20Array%20element%20type%0A*%20%40return%20List%20object%0A*%2F%0Apublic%20static%20%20List%20parseArray(String%20text%2C%20Class%20clazz)%20%7B%0Aif%20(StrUtil.isEmpty(text))%20%7B%0Areturn%20new%20ArrayList()%3B%0A%7D%0Atry%20%7B%0Areturn%20objectMapper.readValue(text%2C%0AobjectMapper.getTypeFactory().constructCollectionType(List.class%2C%20clazz))%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%20array%20parsing%20failed%2C%20json%3A%7B%7D%22%2C%20text%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20Parse%20array%20from%20specified%20path%20-%20Support%20nested%20array%20extraction%0A*%0A*%20%40param%20text%20JSON%20string%0A*%20%40param%20path%20Path%20(e.g.%2C%20%22data.items%22)%0A*%20%40param%20clazz%20Array%20element%20type%0A*%20%40return%20List%20object%0A*%2F%0Apublic%20static%20%20List%20parseArray(String%20text%2C%20String%20path%2C%20Class%20clazz)%20%7B%0Aif%20(StrUtil.isEmpty(text))%20%7B%0Areturn%20null%3B%0A%7D%0Atry%20%7B%0AJsonNode%20treeNode%20%3D%20objectMapper.readTree(text)%3B%0AJsonNode%20pathNode%20%3D%20treeNode.path(path)%3B%0Areturn%20objectMapper.readValue(pathNode.toString()%2C%0AobjectMapper.getTypeFactory().constructCollectionType(List.class%2C%20clazz))%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%20path%20array%20parsing%20failed%2C%20json%3A%7B%7D%2C%20path%3A%7B%7D%22%2C%20text%2C%20path%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Tree%20Structure%20Parsing%20Methods%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20Parse%20to%20JsonNode%20tree%20structure%20-%20Support%20dynamic%20access%0A*%0A*%20%40param%20text%20JSON%20string%0A*%20%40return%20JsonNode%20tree%0A*%2F%0Apublic%20static%20JsonNode%20parseTree(String%20text)%20%7B%0Atry%20%7B%0Areturn%20objectMapper.readTree(text)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%20tree%20parsing%20failed%2C%20json%3A%7B%7D%22%2C%20text%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F**%0A*%20Parse%20byte%20array%20to%20JsonNode%20tree%20structure%0A*%0A*%20%40param%20text%20JSON%20byte%20array%0A*%20%40return%20JsonNode%20tree%0A*%2F%0Apublic%20static%20JsonNode%20parseTree(byte%5B%5D%20text)%20%7B%0Atry%20%7B%0Areturn%20objectMapper.readTree(text)%3B%0A%7D%20catch%20(IOException%20e)%20%7B%0Alog.error(%22JSON%20byte%20array%20tree%20parsing%20failed%22%2C%20e)%3B%0Athrow%20new%20RuntimeException(e)%3B%0A%7D%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Utility%20Methods%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20Check%20if%20string%20is%20JSON%20format%0A*%0A*%20%40param%20text%20String%20to%20check%0A*%20%40return%20Whether%20it's%20JSON%0A*%2F%0Apublic%20static%20boolean%20isJson(String%20text)%20%7B%0Areturn%20JSONUtil.isTypeJSON(text)%3B%0A%7D%0A%2F**%0A*%20Check%20if%20string%20is%20JSON%20object%20format%0A*%0A*%20%40param%20str%20String%20to%20check%0A*%20%40return%20Whether%20it's%20JSON%20object%0A*%2F%0Apublic%20static%20boolean%20isJsonObject(String%20str)%20%7B%0Areturn%20JSONUtil.isTypeJSONObject(str)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Core%20Path%20Parsing%20Methods%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20Extract%20value%20from%20nested%20JSON%20structure%20-%20ACOT's%20core%20functionality%0A*%0A*%20Supported%20path%20formats%3A%0A*%20-%20Simple%20path%3A%20user.name%0A*%20-%20Array%20path%3A%20choices%5B0%5D.message.content%0A*%20-%20Mixed%20path%3A%20data.items%5B0%5D.details.info%0A*%0A*%20%40param%20data%20Data%20structure%0A*%20%40param%20path%20Dot-separated%20path%20(supports%20array%20subscripts)%0A*%20%40return%20String%20representation%20of%20extracted%20value%2C%20returns%20null%20if%20not%20found%0A*%2F%0A%40SuppressWarnings(%22unchecked%22)%0Apublic%20static%20String%20extractValueFromPath(Map%20data%2C%20String%20path)%20%7B%0A%2F%2F%20Step%201%3A%20Path%20splitting%0AString%5B%5D%20parts%20%3D%20path.split(%22%5C%5C.%22)%3B%0AObject%20current%20%3D%20data%3B%0A%2F%2F%20Step%202%3A%20Traverse%20path%20level%20by%20level%0Afor%20(String%20part%20%3A%20parts)%20%7B%0A%2F%2F%20Defensive%20check%3A%20return%20immediately%20if%20null%20encountered%0Aif%20(current%20%3D%3D%20null)%20%7B%0Areturn%20null%3B%0A%7D%0A%2F%2F%20Step%203%3A%20Parse%20current%20path%20segment%0Aif%20(part.contains(%22%5B%22)%20%26%26%20part.contains(%22%5D%22))%20%7B%0A%2F%2F%20Array%20access%20pattern%3A%20choices%5B0%5D%0AString%20arrayName%20%3D%20part.substring(0%2C%20part.indexOf('%5B'))%3B%0Aint%20index%20%3D%20Integer.parseInt(part.substring(part.indexOf('%5B')%20%2B%201%2C%20part.indexOf('%5D')))%3B%0A%2F%2F%20Type-safe%20array%20access%0Aif%20(current%20instanceof%20Map)%20%7B%0AMap%20map%20%3D%20(Map)%20current%3B%0Aif%20(map.containsKey(arrayName)%20%26%26%20map.get(arrayName)%20instanceof%20List)%20%7B%0AList%20array%20%3D%20(List)%20map.get(arrayName)%3B%0Aif%20(index%20else%20%7B%0Areturn%20null%3B%20%20%2F%2F%20Array%20out%20of%20bounds%0A%7D%0A%7D%20else%20%7B%0Areturn%20null%3B%20%20%2F%2F%20Field%20doesn't%20exist%20or%20type%20mismatch%0A%7D%0A%7D%20else%20%7B%0Areturn%20null%3B%20%20%2F%2F%20Current%20object%20is%20not%20Map%20type%0A%7D%0A%7D%20else%20%7B%0A%2F%2F%20Ordinary%20property%20access%20pattern%3A%20user.name%0Aif%20(current%20instanceof%20Map)%20%7B%0Acurrent%20%3D%20((Map)%20current).get(part)%3B%0A%7D%20else%20%7B%0Areturn%20null%3B%20%20%2F%2F%20Current%20object%20is%20not%20Map%20type%0A%7D%0A%7D%0A%7D%0A%2F%2F%20Step%204%3A%20Return%20result%0Areturn%20current%20!%3D%20null%20%3F%20current.toString()%20%3A%20null%3B%0A%7D%0A%2F**%0A*%20Set%20value%20in%20nested%20JSON%20structure%20-%20ACOT's%20core%20functionality%0A*%0A*%20Features%3A%0A*%20-%20Intelligent%20path%20building%3A%20Automatically%20create%20non-existent%20intermediate%20paths%0A*%20-%20Array%20auto-expansion%3A%20Ensure%20array%20index%20accessibility%0A*%20-%20Type%20safety%3A%20Prevent%20type%20conflicts%0A*%0A*%20%40param%20data%20Data%20structure%20to%20modify%0A*%20%40param%20path%20Dot-separated%20path%20(supports%20array%20subscripts)%0A*%20%40param%20value%20Value%20to%20set%0A*%2F%0A%40SuppressWarnings(%22unchecked%22)%0Apublic%20static%20void%20setValueByPath(Map%20data%2C%20String%20path%2C%20Object%20value)%20%7B%0A%2F%2F%20Step%201%3A%20Path%20splitting%0AString%5B%5D%20parts%20%3D%20path.split(%22%5C%5C.%22)%3B%0AMap%20current%20%3D%20data%3B%0A%2F%2F%20Step%202%3A%20Traverse%20path%2C%20ensure%20intermediate%20structures%20exist%0Afor%20(int%20i%20%3D%200%3B%20i%201%3B%20i%2B%2B)%20%7B%0AString%20part%20%3D%20parts%5Bi%5D%3B%0Aif%20(part.contains(%22%5B%22)%20%26%26%20part.contains(%22%5D%22))%20%7B%0A%2F%2F%20Array%20path%20processing%0AString%20arrayName%20%3D%20part.substring(0%2C%20part.indexOf('%5B'))%3B%0Aint%20index%20%3D%20Integer.parseInt(part.substring(part.indexOf('%5B')%20%2B%201%2C%20part.indexOf('%5D')))%3B%0A%2F%2F%20Create%20array%20(if%20doesn't%20exist)%0Aif%20(!current.containsKey(arrayName)%20%7C%7C%20!(current.get(arrayName)%20instanceof%20List))%20%7B%0Acurrent.put(arrayName%2C%20new%20ArrayList())%3B%0A%7D%0AList%20array%20%3D%20(List)%20current.get(arrayName)%3B%0A%2F%2F%20Array%20expansion%3A%20ensure%20index%20accessibility%0Awhile%20(array.size()%20new%20HashMap())%3B%0A%7D%0A%2F%2F%20Ensure%20array%20element%20is%20Map%20object%20(prepare%20for%20next%20level%20path)%0Aif%20(!(array.get(index)%20instanceof%20Map))%20%7B%0Aarray.set(index%2C%20new%20HashMap())%3B%0A%7D%0Acurrent%20%3D%20(Map)%20array.get(index)%3B%0A%7D%20else%20%7B%0A%2F%2F%20Ordinary%20property%20path%20processing%0Aif%20(!current.containsKey(part)%20%7C%7C%20!(current.get(part)%20instanceof%20Map))%20%7B%0Acurrent.put(part%2C%20new%20HashMap())%3B%0A%7D%0Acurrent%20%3D%20(Map)%20current.get(part)%3B%0A%7D%0A%7D%0A%2F%2F%20Step%203%3A%20Set%20final%20value%0AString%20lastPart%20%3D%20parts%5Bparts.length%20-%201%5D%3B%0Aif%20(lastPart.contains(%22%5B%22)%20%26%26%20lastPart.contains(%22%5D%22))%20%7B%0A%2F%2F%20Final%20path%20is%20array%20element%0AString%20arrayName%20%3D%20lastPart.substring(0%2C%20lastPart.indexOf('%5B'))%3B%0Aint%20index%20%3D%20Integer.parseInt(lastPart.substring(lastPart.indexOf('%5B')%20%2B%201%2C%20lastPart.indexOf('%5D')))%3B%0A%2F%2F%20Create%20array%20(if%20doesn't%20exist)%0Aif%20(!current.containsKey(arrayName)%20%7C%7C%20!(current.get(arrayName)%20instanceof%20List))%20%7B%0Acurrent.put(arrayName%2C%20new%20ArrayList())%3B%0A%7D%0AList%20array%20%3D%20(List)%20current.get(arrayName)%3B%0A%2F%2F%20Array%20expansion%3A%20ensure%20index%20accessibility%0Awhile%20(array.size()%20null)%3B%0A%7D%0A%2F%2F%20Set%20array%20element%20value%0Aarray.set(index%2C%20value)%3B%0A%7D%20else%20%7B%0A%2F%2F%20Final%20path%20is%20ordinary%20property%0Acurrent.put(lastPart%2C%20value)%3B%0A%7D%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">package</span> com.chat.allchatonthis.common.util.json;

<span class="hljs-keyword inline">import</span> cn.hutool.core.util.ArrayUtil;
<span class="hljs-keyword inline">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword inline">import</span> cn.hutool.json.JSONUtil;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.annotation.JsonInclude;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.core.type.TypeReference;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.databind.DeserializationFeature;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.databind.JsonNode;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.databind.ObjectMapper;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.databind.SerializationFeature;
<span class="hljs-keyword inline">import</span> com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
<span class="hljs-keyword inline">import</span> lombok.SneakyThrows;
<span class="hljs-keyword inline">import</span> lombok.extern.slf4j.Slf4j;

<span class="hljs-keyword inline">import</span> java.io.IOException;
<span class="hljs-keyword inline">import</span> java.lang.reflect.Type;
<span class="hljs-keyword inline">import</span> java.util.ArrayList;
<span class="hljs-keyword inline">import</span> java.util.HashMap;
<span class="hljs-keyword inline">import</span> java.util.List;
<span class="hljs-keyword inline">import</span> java.util.Map;

<span class="hljs-comment inline">/**
 * JSON Utility Class - ACOT&#x27;s Core Data Parsing Engine
 */</span>
<span class="hljs-meta inline">@Slf4j</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">JsonUtils</span> {

    <span class="hljs-comment inline">// ==================== Core Configuration ====================</span>
    
    <span class="hljs-comment inline">/** Global ObjectMapper instance - Singleton pattern, thread-safe */</span>
    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">static</span> <span class="hljs-type inline">ObjectMapper</span> <span class="hljs-variable inline">objectMapper</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ObjectMapper</span>();

    <span class="hljs-keyword inline">static</span> {
        <span class="hljs-comment inline">// Configure serialization behavior: don&#x27;t fail on empty beans</span>
        objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class="hljs-literal inline">false</span>);
        <span class="hljs-comment inline">// Configure deserialization behavior: ignore unknown properties</span>
        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="hljs-literal inline">false</span>);
        <span class="hljs-comment inline">// Ignore null values, reduce data transmission volume</span>
        objectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
        <span class="hljs-comment inline">// Support Java 8 time types</span>
        objectMapper.registerModules(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">JavaTimeModule</span>());
    }

    <span class="hljs-comment inline">/**
     * Initialize ObjectMapper - Support Spring Boot auto-configuration
     * 
     * <span class="hljs-doctag inline">@param</span> objectMapper Spring-managed ObjectMapper Bean
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">init</span><span class="hljs-params inline">(ObjectMapper objectMapper)</span> {
        JsonUtils.objectMapper = objectMapper;
    }

    <span class="hljs-comment inline">// ==================== Basic Serialization Methods ====================</span>

    <span class="hljs-comment inline">/**
     * Object to JSON string - Most commonly used serialization method
     * 
     * <span class="hljs-doctag inline">@param</span> object Object to serialize
     * <span class="hljs-doctag inline">@return</span> JSON string
     */</span>
    <span class="hljs-meta inline">@SneakyThrows</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">toJsonString</span><span class="hljs-params inline">(Object object)</span> {
        <span class="hljs-keyword inline">return</span> objectMapper.writeValueAsString(object);
    }

    <span class="hljs-comment inline">/**
     * Object to JSON byte array - Suitable for network transmission
     * 
     * <span class="hljs-doctag inline">@param</span> object Object to serialize
     * <span class="hljs-doctag inline">@return</span> JSON byte array
     */</span>
    <span class="hljs-meta inline">@SneakyThrows</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-type inline">byte</span>[] toJsonByte(Object object) {
        <span class="hljs-keyword inline">return</span> objectMapper.writeValueAsBytes(object);
    }

    <span class="hljs-comment inline">/**
     * Object to formatted JSON string - Suitable for debugging and logging
     * 
     * <span class="hljs-doctag inline">@param</span> object Object to serialize
     * <span class="hljs-doctag inline">@return</span> Formatted JSON string
     */</span>
    <span class="hljs-meta inline">@SneakyThrows</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">toJsonPrettyString</span><span class="hljs-params inline">(Object object)</span> {
        <span class="hljs-keyword inline">return</span> objectMapper.writerWithDefaultPrettyPrinter().writeValueAsString(object);
    }

    <span class="hljs-comment inline">// ==================== Basic Deserialization Methods ====================</span>

    <span class="hljs-comment inline">/**
     * JSON string to object - Core deserialization method
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON string
     * <span class="hljs-doctag inline">@param</span> clazz Target type
     * <span class="hljs-doctag inline">@return</span> Deserialized object
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; T <span class="hljs-title function_ inline">parseObject</span><span class="hljs-params inline">(String text, Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword inline">if</span> (StrUtil.isEmpty(text)) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(text, clazz);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON parsing failed, json:{}&quot;</span>, text, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * Parse object from specified path in JSON string - Support nested extraction
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON string
     * <span class="hljs-doctag inline">@param</span> path Path (e.g., &quot;data.user&quot;)
     * <span class="hljs-doctag inline">@param</span> clazz Target type
     * <span class="hljs-doctag inline">@return</span> Parsed object
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; T <span class="hljs-title function_ inline">parseObject</span><span class="hljs-params inline">(String text, String path, Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword inline">if</span> (StrUtil.isEmpty(text)) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-type inline">JsonNode</span> <span class="hljs-variable inline">treeNode</span> <span class="hljs-operator inline">=</span> objectMapper.readTree(text);
            <span class="hljs-type inline">JsonNode</span> <span class="hljs-variable inline">pathNode</span> <span class="hljs-operator inline">=</span> treeNode.path(path);
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(pathNode.toString(), clazz);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON path parsing failed, json:{}, path:{}&quot;</span>, text, path, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * Byte array to object - Suitable for network transmission data
     * 
     * <span class="hljs-doctag inline">@param</span> bytes JSON byte array
     * <span class="hljs-doctag inline">@param</span> clazz Target type
     * <span class="hljs-doctag inline">@return</span> Deserialized object
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; T <span class="hljs-title function_ inline">parseObject</span><span class="hljs-params inline">(<span class="hljs-type inline">byte</span>[] bytes, Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword inline">if</span> (ArrayUtil.isEmpty(bytes)) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(bytes, clazz);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON byte array parsing failed&quot;</span>, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * Parse complex types using TypeReference - Support generics
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON string
     * <span class="hljs-doctag inline">@param</span> typeReference Type reference
     * <span class="hljs-doctag inline">@return</span> Parsed object
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; T <span class="hljs-title function_ inline">parseObject</span><span class="hljs-params inline">(String text, TypeReference&lt;T&gt; typeReference)</span> {
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(text, typeReference);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON TypeReference parsing failed, json:{}&quot;</span>, text, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * Silent parsing - Return null instead of throwing exception when parsing fails
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON string
     * <span class="hljs-doctag inline">@param</span> typeReference Type reference
     * <span class="hljs-doctag inline">@return</span> Parsed object or null
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; T <span class="hljs-title function_ inline">parseObjectQuietly</span><span class="hljs-params inline">(String text, TypeReference&lt;T&gt; typeReference)</span> {
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(text, typeReference);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }
    }

    <span class="hljs-comment inline">// ==================== Array Parsing Methods ====================</span>

    <span class="hljs-comment inline">/**
     * JSON string to List - Handle array types
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON string
     * <span class="hljs-doctag inline">@param</span> clazz Array element type
     * <span class="hljs-doctag inline">@return</span> List object
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; List&lt;T&gt; <span class="hljs-title function_ inline">parseArray</span><span class="hljs-params inline">(String text, Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword inline">if</span> (StrUtil.isEmpty(text)) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;();
        }
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(text, 
                objectMapper.getTypeFactory().constructCollectionType(List.class, clazz));
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON array parsing failed, json:{}&quot;</span>, text, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * Parse array from specified path - Support nested array extraction
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON string
     * <span class="hljs-doctag inline">@param</span> path Path (e.g., &quot;data.items&quot;)
     * <span class="hljs-doctag inline">@param</span> clazz Array element type
     * <span class="hljs-doctag inline">@return</span> List object
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> &lt;T&gt; List&lt;T&gt; <span class="hljs-title function_ inline">parseArray</span><span class="hljs-params inline">(String text, String path, Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword inline">if</span> (StrUtil.isEmpty(text)) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-type inline">JsonNode</span> <span class="hljs-variable inline">treeNode</span> <span class="hljs-operator inline">=</span> objectMapper.readTree(text);
            <span class="hljs-type inline">JsonNode</span> <span class="hljs-variable inline">pathNode</span> <span class="hljs-operator inline">=</span> treeNode.path(path);
            <span class="hljs-keyword inline">return</span> objectMapper.readValue(pathNode.toString(), 
                objectMapper.getTypeFactory().constructCollectionType(List.class, clazz));
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON path array parsing failed, json:{}, path:{}&quot;</span>, text, path, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">// ==================== Tree Structure Parsing Methods ====================</span>

    <span class="hljs-comment inline">/**
     * Parse to JsonNode tree structure - Support dynamic access
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON string
     * <span class="hljs-doctag inline">@return</span> JsonNode tree
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> JsonNode <span class="hljs-title function_ inline">parseTree</span><span class="hljs-params inline">(String text)</span> {
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readTree(text);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON tree parsing failed, json:{}&quot;</span>, text, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">/**
     * Parse byte array to JsonNode tree structure
     * 
     * <span class="hljs-doctag inline">@param</span> text JSON byte array
     * <span class="hljs-doctag inline">@return</span> JsonNode tree
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> JsonNode <span class="hljs-title function_ inline">parseTree</span><span class="hljs-params inline">(<span class="hljs-type inline">byte</span>[] text)</span> {
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-keyword inline">return</span> objectMapper.readTree(text);
        } <span class="hljs-keyword inline">catch</span> (IOException e) {
            log.error(<span class="hljs-string inline">&quot;JSON byte array tree parsing failed&quot;</span>, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(e);
        }
    }

    <span class="hljs-comment inline">// ==================== Utility Methods ====================</span>

    <span class="hljs-comment inline">/**
     * Check if string is JSON format
     * 
     * <span class="hljs-doctag inline">@param</span> text String to check
     * <span class="hljs-doctag inline">@return</span> Whether it&#x27;s JSON
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">isJson</span><span class="hljs-params inline">(String text)</span> {
        <span class="hljs-keyword inline">return</span> JSONUtil.isTypeJSON(text);
    }

    <span class="hljs-comment inline">/**
     * Check if string is JSON object format
     * 
     * <span class="hljs-doctag inline">@param</span> str String to check
     * <span class="hljs-doctag inline">@return</span> Whether it&#x27;s JSON object
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">isJsonObject</span><span class="hljs-params inline">(String str)</span> {
        <span class="hljs-keyword inline">return</span> JSONUtil.isTypeJSONObject(str);
    }

    <span class="hljs-comment inline">// ==================== Core Path Parsing Methods ====================</span>

    <span class="hljs-comment inline">/**
     * Extract value from nested JSON structure - ACOT&#x27;s core functionality
     * 
     * Supported path formats:
     * - Simple path: user.name
     * - Array path: choices[0].message.content
     * - Mixed path: data.items[0].details.info
     * 
     * <span class="hljs-doctag inline">@param</span> data Data structure
     * <span class="hljs-doctag inline">@param</span> path Dot-separated path (supports array subscripts)
     * <span class="hljs-doctag inline">@return</span> String representation of extracted value, returns null if not found
     */</span>
    <span class="hljs-meta inline">@SuppressWarnings(&quot;unchecked&quot;)</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">extractValueFromPath</span><span class="hljs-params inline">(Map&lt;String, Object&gt; data, String path)</span> {
        <span class="hljs-comment inline">// Step 1: Path splitting</span>
        String[] parts = path.split(<span class="hljs-string inline">&quot;\\.&quot;</span>);
        <span class="hljs-type inline">Object</span> <span class="hljs-variable inline">current</span> <span class="hljs-operator inline">=</span> data;

        <span class="hljs-comment inline">// Step 2: Traverse path level by level</span>
        <span class="hljs-keyword inline">for</span> (String part : parts) {
            <span class="hljs-comment inline">// Defensive check: return immediately if null encountered</span>
            <span class="hljs-keyword inline">if</span> (current == <span class="hljs-literal inline">null</span>) {
                <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
            }

            <span class="hljs-comment inline">// Step 3: Parse current path segment</span>
            <span class="hljs-keyword inline">if</span> (part.contains(<span class="hljs-string inline">&quot;[&quot;</span>) &amp;&amp; part.contains(<span class="hljs-string inline">&quot;]&quot;</span>)) {
                <span class="hljs-comment inline">// Array access pattern: choices[0]</span>
                <span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> part.substring(<span class="hljs-number inline">0</span>, part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>));
                <span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(part.substring(part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>) + <span class="hljs-number inline">1</span>, part.indexOf(<span class="hljs-string inline">&#x27;]&#x27;</span>)));

                <span class="hljs-comment inline">// Type-safe array access</span>
                <span class="hljs-keyword inline">if</span> (current <span class="hljs-keyword inline">instanceof</span> Map) {
                    Map&lt;String, Object&gt; map = (Map&lt;String, Object&gt;) current;
                    <span class="hljs-keyword inline">if</span> (map.containsKey(arrayName) &amp;&amp; map.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List) {
                        List&lt;Object&gt; array = (List&lt;Object&gt;) map.get(arrayName);
                        <span class="hljs-keyword inline">if</span> (index &lt; array.size()) {
                            current = array.get(index);
                        } <span class="hljs-keyword inline">else</span> {
                            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// Array out of bounds</span>
                        }
                    } <span class="hljs-keyword inline">else</span> {
                        <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// Field doesn&#x27;t exist or type mismatch</span>
                    }
                } <span class="hljs-keyword inline">else</span> {
                    <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// Current object is not Map type</span>
                }
            } <span class="hljs-keyword inline">else</span> {
                <span class="hljs-comment inline">// Ordinary property access pattern: user.name</span>
                <span class="hljs-keyword inline">if</span> (current <span class="hljs-keyword inline">instanceof</span> Map) {
                    current = ((Map&lt;String, Object&gt;) current).get(part);
                } <span class="hljs-keyword inline">else</span> {
                    <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;  <span class="hljs-comment inline">// Current object is not Map type</span>
                }
            }
        }

        <span class="hljs-comment inline">// Step 4: Return result</span>
        <span class="hljs-keyword inline">return</span> current != <span class="hljs-literal inline">null</span> ? current.toString() : <span class="hljs-literal inline">null</span>;
    }

    <span class="hljs-comment inline">/**
     * Set value in nested JSON structure - ACOT&#x27;s core functionality
     * 
     * Features:
     * - Intelligent path building: Automatically create non-existent intermediate paths
     * - Array auto-expansion: Ensure array index accessibility
     * - Type safety: Prevent type conflicts
     * 
     * <span class="hljs-doctag inline">@param</span> data Data structure to modify
     * <span class="hljs-doctag inline">@param</span> path Dot-separated path (supports array subscripts)
     * <span class="hljs-doctag inline">@param</span> value Value to set
     */</span>
    <span class="hljs-meta inline">@SuppressWarnings(&quot;unchecked&quot;)</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> <span class="hljs-keyword inline">void</span> <span class="hljs-title function_ inline">setValueByPath</span><span class="hljs-params inline">(Map&lt;String, Object&gt; data, String path, Object value)</span> {
        <span class="hljs-comment inline">// Step 1: Path splitting</span>
        String[] parts = path.split(<span class="hljs-string inline">&quot;\\.&quot;</span>);
        Map&lt;String, Object&gt; current = data;

        <span class="hljs-comment inline">// Step 2: Traverse path, ensure intermediate structures exist</span>
        <span class="hljs-keyword inline">for</span> (<span class="hljs-type inline">int</span> <span class="hljs-variable inline">i</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">0</span>; i &lt; parts.length - <span class="hljs-number inline">1</span>; i++) {
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">part</span> <span class="hljs-operator inline">=</span> parts[i];

            <span class="hljs-keyword inline">if</span> (part.contains(<span class="hljs-string inline">&quot;[&quot;</span>) &amp;&amp; part.contains(<span class="hljs-string inline">&quot;]&quot;</span>)) {
                <span class="hljs-comment inline">// Array path processing</span>
                <span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> part.substring(<span class="hljs-number inline">0</span>, part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>));
                <span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(part.substring(part.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>) + <span class="hljs-number inline">1</span>, part.indexOf(<span class="hljs-string inline">&#x27;]&#x27;</span>)));

                <span class="hljs-comment inline">// Create array (if doesn&#x27;t exist)</span>
                <span class="hljs-keyword inline">if</span> (!current.containsKey(arrayName) || !(current.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List)) {
                    current.put(arrayName, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;());
                }

                List&lt;Object&gt; array = (List&lt;Object&gt;) current.get(arrayName);

                <span class="hljs-comment inline">// Array expansion: ensure index accessibility</span>
                <span class="hljs-keyword inline">while</span> (array.size() &lt;= index) {
                    array.add(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;String, Object&gt;());
                }

                <span class="hljs-comment inline">// Ensure array element is Map object (prepare for next level path)</span>
                <span class="hljs-keyword inline">if</span> (!(array.get(index) <span class="hljs-keyword inline">instanceof</span> Map)) {
                    array.set(index, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;String, Object&gt;());
                }

                current = (Map&lt;String, Object&gt;) array.get(index);
            } <span class="hljs-keyword inline">else</span> {
                <span class="hljs-comment inline">// Ordinary property path processing</span>
                <span class="hljs-keyword inline">if</span> (!current.containsKey(part) || !(current.get(part) <span class="hljs-keyword inline">instanceof</span> Map)) {
                    current.put(part, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;String, Object&gt;());
                }
                current = (Map&lt;String, Object&gt;) current.get(part);
            }
        }

        <span class="hljs-comment inline">// Step 3: Set final value</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">lastPart</span> <span class="hljs-operator inline">=</span> parts[parts.length - <span class="hljs-number inline">1</span>];

        <span class="hljs-keyword inline">if</span> (lastPart.contains(<span class="hljs-string inline">&quot;[&quot;</span>) &amp;&amp; lastPart.contains(<span class="hljs-string inline">&quot;]&quot;</span>)) {
            <span class="hljs-comment inline">// Final path is array element</span>
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">arrayName</span> <span class="hljs-operator inline">=</span> lastPart.substring(<span class="hljs-number inline">0</span>, lastPart.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>));
            <span class="hljs-type inline">int</span> <span class="hljs-variable inline">index</span> <span class="hljs-operator inline">=</span> Integer.parseInt(lastPart.substring(lastPart.indexOf(<span class="hljs-string inline">&#x27;[&#x27;</span>) + <span class="hljs-number inline">1</span>, lastPart.indexOf(<span class="hljs-string inline">&#x27;]&#x27;</span>)));

            <span class="hljs-comment inline">// Create array (if doesn&#x27;t exist)</span>
            <span class="hljs-keyword inline">if</span> (!current.containsKey(arrayName) || !(current.get(arrayName) <span class="hljs-keyword inline">instanceof</span> List)) {
                current.put(arrayName, <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;());
            }

            List&lt;Object&gt; array = (List&lt;Object&gt;) current.get(arrayName);

            <span class="hljs-comment inline">// Array expansion: ensure index accessibility</span>
            <span class="hljs-keyword inline">while</span> (array.size() &lt;= index) {
                array.add(<span class="hljs-literal inline">null</span>);
            }

            <span class="hljs-comment inline">// Set array element value</span>
            array.set(index, value);
        } <span class="hljs-keyword inline">else</span> {
            <span class="hljs-comment inline">// Final path is ordinary property</span>
            current.put(lastPart, value);
        }
    }
}
</code></pre>
            </div>
        
<h3 id="userconfigdo：配置类的完整实现" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#userconfigdo：配置类的完整实现" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to UserConfigDO：配置类的完整实现">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            UserConfigDO：配置类的完整实现
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="package%20com.chat.allchatonthis.entity.dataobject%3B%0Aimport%20com.baomidou.mybatisplus.annotation.*%3B%0Aimport%20com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler%3B%0Aimport%20com.chat.allchatonthis.config.mybatis.core.dataobject.BaseDO%3B%0Aimport%20lombok.AllArgsConstructor%3B%0Aimport%20lombok.Data%3B%0Aimport%20lombok.EqualsAndHashCode%3B%0Aimport%20lombok.NoArgsConstructor%3B%0Aimport%20lombok.experimental.Accessors%3B%0Aimport%20java.time.LocalDateTime%3B%0Aimport%20java.util.Map%3B%0A%2F**%0A*%20%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%AF%B9%E8%B1%A1%20-%20%E6%94%AF%E6%8C%81%E5%A4%9A%E6%A0%B7%E5%8C%96AI%E6%9C%8D%E5%8A%A1%E5%95%86API%E9%85%8D%E7%BD%AE%0A*%0A*%20%E8%AE%BE%E8%AE%A1%E7%9B%AE%E6%A0%87%EF%BC%9A%0A*%201.%20%E7%81%B5%E6%B4%BB%E9%80%82%E9%85%8D%E4%B8%8D%E5%90%8CAI%E6%9C%8D%E5%8A%A1%E5%95%86%E7%9A%84%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F%0A*%202.%20%E6%94%AF%E6%8C%81%E5%A4%8D%E6%9D%82%E5%B5%8C%E5%A5%97%E7%9A%84JSON%E8%AF%B7%E6%B1%82%2F%E5%93%8D%E5%BA%94%E6%A0%BC%E5%BC%8F%0A*%203.%20%E6%8F%90%E4%BE%9B%E5%AE%8C%E6%95%B4%E7%9A%84%E6%B6%88%E6%81%AF%E8%B7%AF%E5%BE%84%E6%98%A0%E5%B0%84%E5%8A%9F%E8%83%BD%0A*%204.%20%E7%A1%AE%E4%BF%9D%E9%85%8D%E7%BD%AE%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E5%92%8C%E5%8F%AF%E7%94%A8%E6%80%A7%E7%9B%91%E6%8E%A7%0A*%2F%0A%40EqualsAndHashCode(callSuper%20%3D%20true)%0A%40Data%0A%40AllArgsConstructor%0A%40NoArgsConstructor%0A%40Accessors(chain%20%3D%20true)%20%20%2F%2F%20Support%20chained%20calls%2C%20improve%20code%20readability%0A%40TableName(value%20%3D%20%22user_config%22%2C%20autoResultMap%20%3D%20true)%0Apublic%20class%20UserConfigDO%20extends%20BaseDO%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Basic%20Configuration%20Fields%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%40TableId(type%20%3D%20IdType.AUTO)%0Aprivate%20Long%20id%3B%0A%2F**%20Whether%20configuration%20is%20available%20-%20Used%20for%20health%20checks%20and%20UI%20display%20*%2F%0Aprivate%20Boolean%20isAvailable%3B%0A%2F**%20Foreign%20key%3A%20Associated%20user%20ID%2C%20implements%20multi-user%20isolation%20*%2F%0Aprivate%20Long%20userId%3B%0A%2F**%20Configuration%20name%20-%20User-defined%2C%20convenient%20for%20managing%20multiple%20configurations%20*%2F%0Aprivate%20String%20name%3B%0A%2F**%20API%20request%20URL%20-%20Endpoint%20addresses%20of%20different%20service%20providers%20*%2F%0Aprivate%20String%20apiUrl%3B%0A%2F**%20API%20key%20-%20Supports%20plaintext%20and%20encrypted%20storage%20(enc%3A%20prefix%20identifies%20encryption)%20*%2F%0Aprivate%20String%20apiKey%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20API%20Key%20Placement%20Strategy%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20API%20key%20placement%20strategy%3A%0A*%20-%20'header'%3A%20Place%20in%20Authorization%20header%20(default%2C%20suitable%20for%20OpenAI%2C%20etc.)%0A*%20-%20'body'%3A%20Embed%20in%20request%20body%20(suitable%20for%20some%20custom%20APIs)%0A*%20-%20'custom_header'%3A%20Place%20in%20custom%20header%20(suitable%20for%20Anthropic%2C%20etc.)%0A*%2F%0Aprivate%20String%20apiKeyPlacement%3B%0A%2F**%20Custom%20header%20name%20-%20Used%20when%20apiKeyPlacement%3D'custom_header'%20*%2F%0Aprivate%20String%20apiKeyHeader%3B%0A%2F**%20JSON%20path%20-%20When%20apiKeyPlacement%3D'body'%2C%20specifies%20the%20position%20of%20API%20key%20in%20request%20body%20*%2F%0Aprivate%20String%20apiKeyBodyPath%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20JSON%20Template%20System%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20Request%20template%20-%20Predefined%20JSON%20structure%0A*%20Uses%20JacksonTypeHandler%20to%20automatically%20handle%20MapJSON%20conversion%0A*%20Supports%20arbitrarily%20complex%20nested%20structures%0A*%2F%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20requestTemplate%3B%0A%2F**%0A*%20Response%20template%20-%20Used%20for%20response%20format%20validation%20and%20processing%0A*%20Currently%20mainly%20used%20for%20documentation%2C%20can%20be%20extended%20to%20response%20validation%20in%20the%20future%0A*%2F%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20responseTemplate%3B%0A%2F**%0A*%20Custom%20HTTP%20headers%20-%20Support%20adding%20additional%20request%20headers%0A*%20Examples%3A%20User-Agent%2C%20Referer%2C%20custom%20authentication%20headers%2C%20etc.%0A*%2F%0A%40TableField(typeHandler%20%3D%20JacksonTypeHandler.class)%0Aprivate%20Map%20headers%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Role%20Field%20Mapping%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%20User%20role%20field%20name%20-%20Field%20name%20for%20user%20role%20in%20different%20APIs%20(e.g.%2C%20user%2C%20human%2C%20customer)%20*%2F%0Aprivate%20String%20requestUserRoleField%3B%0A%2F**%20Assistant%20role%20field%20name%20-%20Field%20name%20for%20assistant%20role%20in%20different%20APIs%20(e.g.%2C%20assistant%2C%20ai%2C%20agent)%20*%2F%0Aprivate%20String%20requestAssistantField%3B%0A%2F**%20System%20role%20field%20name%20-%20Field%20name%20for%20system%20message%20role%20(e.g.%2C%20system%2C%20instruction)%20*%2F%0Aprivate%20String%20requestSystemField%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Message%20Path%20Configuration%20System%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20Message%20group%20path%20-%20Specifies%20the%20position%20of%20message%20array%20in%20request%20JSON%0A*%20Examples%3A%20'messages'%20or%20'conversation.messages'%20or%20'data.chat.messages'%0A*%2F%0Aprivate%20String%20requestMessageGroupPath%3B%0A%2F**%0A*%20Role%20path%20-%20Specifies%20the%20name%20of%20role%20field%20in%20individual%20message%20objects%0A*%20Examples%3A%20'role'%20or%20'speaker'%20or%20'type'%0A*%2F%0Aprivate%20String%20requestRolePathFromGroup%3B%0A%2F**%0A*%20Text%20path%20-%20Specifies%20the%20name%20of%20content%20field%20in%20individual%20message%20objects%0A*%20Examples%3A%20'content'%20or%20'text'%20or%20'message'%0A*%2F%0Aprivate%20String%20requestTextPathFromGroup%3B%0A%2F**%0A*%20Response%20text%20path%20-%20Specifies%20how%20to%20extract%20AI%20reply%20content%20from%20response%20JSON%0A*%20Examples%3A%20'choices.0.message.content'%20or%20'response.text'%0A*%2F%0Aprivate%20String%20responseTextPath%3B%0A%2F**%0A*%20Thinking%20text%20path%20-%20Specifies%20how%20to%20extract%20AI's%20thinking%20process%20(if%20supported)%0A*%20Examples%3A%20'choices.0.message.thinking'%20or%20'response.reasoning'%0A*%2F%0Aprivate%20String%20responseThinkingTextPath%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Monitoring%20and%20Statistics%20Fields%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%20Last%20usage%20time%20-%20Used%20for%20statistical%20analysis%20and%20health%20checks%20*%2F%0Aprivate%20LocalDateTime%20lastUsedTime%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Temporary%20Fields%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F**%0A*%20Decryption%20key%20-%20Temporary%20field%2C%20not%20persisted%20to%20database%0A*%20Used%20to%20decrypt%20encrypted%20API%20keys%20at%20runtime%0A*%2F%0A%40TableField(exist%20%3D%20false)%0Aprivate%20String%20secretKey%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">package</span> com.chat.allchatonthis.entity.dataobject;

<span class="hljs-keyword inline">import</span> com.baomidou.mybatisplus.annotation.*;
<span class="hljs-keyword inline">import</span> com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.config.mybatis.core.dataobject.BaseDO;
<span class="hljs-keyword inline">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword inline">import</span> lombok.Data;
<span class="hljs-keyword inline">import</span> lombok.EqualsAndHashCode;
<span class="hljs-keyword inline">import</span> lombok.NoArgsConstructor;
<span class="hljs-keyword inline">import</span> lombok.experimental.Accessors;

<span class="hljs-keyword inline">import</span> java.time.LocalDateTime;
<span class="hljs-keyword inline">import</span> java.util.Map;

<span class="hljs-comment inline">/**
 * 用户配置数据对象 - 支持多样化AI服务商API配置
 * 
 * 设计目标：
 * 1. 灵活适配不同AI服务商的认证方式
 * 2. 支持复杂嵌套的JSON请求/响应格式
 * 3. 提供完整的消息路径映射功能
 * 4. 确保配置的安全性和可用性监控
 */</span>
<span class="hljs-meta inline">@EqualsAndHashCode(callSuper = true)</span>
<span class="hljs-meta inline">@Data</span>
<span class="hljs-meta inline">@AllArgsConstructor</span>
<span class="hljs-meta inline">@NoArgsConstructor</span>
<span class="hljs-meta inline">@Accessors(chain = true)</span>  <span class="hljs-comment inline">// Support chained calls, improve code readability</span>
<span class="hljs-meta inline">@TableName(value = &quot;user_config&quot;, autoResultMap = true)</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">UserConfigDO</span> <span class="hljs-keyword inline">extends</span> <span class="hljs-title class_ inline">BaseDO</span> {
    
    <span class="hljs-comment inline">// ==================== Basic Configuration Fields ====================</span>
    
    <span class="hljs-meta inline">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword inline">private</span> Long id;
    
    <span class="hljs-comment inline">/** Whether configuration is available - Used for health checks and UI display */</span>
    <span class="hljs-keyword inline">private</span> Boolean isAvailable;
    
    <span class="hljs-comment inline">/** Foreign key: Associated user ID, implements multi-user isolation */</span>
    <span class="hljs-keyword inline">private</span> Long userId;
    
    <span class="hljs-comment inline">/** Configuration name - User-defined, convenient for managing multiple configurations */</span>
    <span class="hljs-keyword inline">private</span> String name;
    
    <span class="hljs-comment inline">/** API request URL - Endpoint addresses of different service providers */</span>
    <span class="hljs-keyword inline">private</span> String apiUrl;
    
    <span class="hljs-comment inline">/** API key - Supports plaintext and encrypted storage (enc: prefix identifies encryption) */</span>
    <span class="hljs-keyword inline">private</span> String apiKey;

    <span class="hljs-comment inline">// ==================== API Key Placement Strategy ====================</span>
    
    <span class="hljs-comment inline">/** 
     * API key placement strategy:
     * - &#x27;header&#x27;: Place in Authorization header (default, suitable for OpenAI, etc.)
     * - &#x27;body&#x27;: Embed in request body (suitable for some custom APIs)
     * - &#x27;custom_header&#x27;: Place in custom header (suitable for Anthropic, etc.)
     */</span>
    <span class="hljs-keyword inline">private</span> String apiKeyPlacement;
    
    <span class="hljs-comment inline">/** Custom header name - Used when apiKeyPlacement=&#x27;custom_header&#x27; */</span>
    <span class="hljs-keyword inline">private</span> String apiKeyHeader;
    
    <span class="hljs-comment inline">/** JSON path - When apiKeyPlacement=&#x27;body&#x27;, specifies the position of API key in request body */</span>
    <span class="hljs-keyword inline">private</span> String apiKeyBodyPath;

    <span class="hljs-comment inline">// ==================== JSON Template System ====================</span>
    
    <span class="hljs-comment inline">/** 
     * Request template - Predefined JSON structure
     * Uses JacksonTypeHandler to automatically handle Map&lt;-&gt;JSON conversion
     * Supports arbitrarily complex nested structures
     */</span>
    <span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
    <span class="hljs-keyword inline">private</span> Map&lt;String, Object&gt; requestTemplate;

    <span class="hljs-comment inline">/** 
     * Response template - Used for response format validation and processing
     * Currently mainly used for documentation, can be extended to response validation in the future
     */</span>
    <span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
    <span class="hljs-keyword inline">private</span> Map&lt;String, Object&gt; responseTemplate;

    <span class="hljs-comment inline">/** 
     * Custom HTTP headers - Support adding additional request headers
     * Examples: User-Agent, Referer, custom authentication headers, etc.
     */</span>
    <span class="hljs-meta inline">@TableField(typeHandler = JacksonTypeHandler.class)</span>
    <span class="hljs-keyword inline">private</span> Map&lt;String, String&gt; headers;

    <span class="hljs-comment inline">// ==================== Role Field Mapping ====================</span>
    
    <span class="hljs-comment inline">/** User role field name - Field name for user role in different APIs (e.g., user, human, customer) */</span>
    <span class="hljs-keyword inline">private</span> String requestUserRoleField;
    
    <span class="hljs-comment inline">/** Assistant role field name - Field name for assistant role in different APIs (e.g., assistant, ai, agent) */</span>
    <span class="hljs-keyword inline">private</span> String requestAssistantField;
    
    <span class="hljs-comment inline">/** System role field name - Field name for system message role (e.g., system, instruction) */</span>
    <span class="hljs-keyword inline">private</span> String requestSystemField;

    <span class="hljs-comment inline">// ==================== Message Path Configuration System ====================</span>
    
    <span class="hljs-comment inline">/** 
     * Message group path - Specifies the position of message array in request JSON
     * Examples: &#x27;messages&#x27; or &#x27;conversation.messages&#x27; or &#x27;data.chat.messages&#x27;
     */</span>
    <span class="hljs-keyword inline">private</span> String requestMessageGroupPath;
    
    <span class="hljs-comment inline">/** 
     * Role path - Specifies the name of role field in individual message objects
     * Examples: &#x27;role&#x27; or &#x27;speaker&#x27; or &#x27;type&#x27;
     */</span>
    <span class="hljs-keyword inline">private</span> String requestRolePathFromGroup;
    
    <span class="hljs-comment inline">/** 
     * Text path - Specifies the name of content field in individual message objects
     * Examples: &#x27;content&#x27; or &#x27;text&#x27; or &#x27;message&#x27;
     */</span>
    <span class="hljs-keyword inline">private</span> String requestTextPathFromGroup;
    
    <span class="hljs-comment inline">/** 
     * Response text path - Specifies how to extract AI reply content from response JSON
     * Examples: &#x27;choices.0.message.content&#x27; or &#x27;response.text&#x27;
     */</span>
    <span class="hljs-keyword inline">private</span> String responseTextPath;
    
    <span class="hljs-comment inline">/** 
     * Thinking text path - Specifies how to extract AI&#x27;s thinking process (if supported)
     * Examples: &#x27;choices.0.message.thinking&#x27; or &#x27;response.reasoning&#x27;
     */</span>
    <span class="hljs-keyword inline">private</span> String responseThinkingTextPath;

    <span class="hljs-comment inline">// ==================== Monitoring and Statistics Fields ====================</span>
    
    <span class="hljs-comment inline">/** Last usage time - Used for statistical analysis and health checks */</span>
    <span class="hljs-keyword inline">private</span> LocalDateTime lastUsedTime;

    <span class="hljs-comment inline">// ==================== Temporary Fields ====================</span>
    
    <span class="hljs-comment inline">/** 
     * Decryption key - Temporary field, not persisted to database
     * Used to decrypt encrypted API keys at runtime
     */</span>
    <span class="hljs-meta inline">@TableField(exist = false)</span>
    <span class="hljs-keyword inline">private</span> String secretKey;
}
</code></pre>
            </div>
        
<h3 id="httputils-complete-implementation-of-http-request-processing" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#httputils-complete-implementation-of-http-request-processing" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to HttpUtils: Complete Implementation of HTTP Request Processing">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            HttpUtils: Complete Implementation of HTTP Request Processing
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="package%20com.chat.allchatonthis.common.util.http%3B%0Aimport%20cn.hutool.core.codec.Base64%3B%0Aimport%20cn.hutool.core.map.TableMap%3B%0Aimport%20cn.hutool.core.net.url.UrlBuilder%3B%0Aimport%20cn.hutool.core.util.ReflectUtil%3B%0Aimport%20cn.hutool.core.util.StrUtil%3B%0Aimport%20cn.hutool.http.HttpRequest%3B%0Aimport%20cn.hutool.http.HttpResponse%3B%0Aimport%20com.chat.allchatonthis.common.exception.ServiceException%3B%0Aimport%20com.chat.allchatonthis.common.util.json.JsonUtils%3B%0Aimport%20com.chat.allchatonthis.entity.dataobject.ConversationMessageDO%3B%0Aimport%20com.chat.allchatonthis.entity.dataobject.UserConfigDO%3B%0Aimport%20jakarta.servlet.http.HttpServletRequest%3B%0Aimport%20lombok.extern.slf4j.Slf4j%3B%0Aimport%20org.springframework.util.StringUtils%3B%0Aimport%20javax.crypto.Cipher%3B%0Aimport%20javax.crypto.spec.SecretKeySpec%3B%0Aimport%20java.nio.charset.StandardCharsets%3B%0Aimport%20java.security.MessageDigest%3B%0Aimport%20java.security.NoSuchAlgorithmException%3B%0Aimport%20java.util.ArrayList%3B%0Aimport%20java.util.HashMap%3B%0Aimport%20java.util.List%3B%0Aimport%20java.util.Map%3B%0Aimport%20static%20com.chat.allchatonthis.common.enums.ErrorCodeConstants.CONFIG_NOT_EXISTS%3B%0A%2F**%0A*%20HTTP%20Utility%20Class%20-%20Core%20logic%20for%20processing%20API%20requests%0A*%2F%0A%40Slf4j%0Apublic%20class%20HttpUtils%20%7B%0A%2F**%0A*%20Prepare%20request%20data%20(simple%20version)%20-%20Process%20single%20message%0A*%0A*%20%40param%20config%20User%20configuration%0A*%20%40param%20messageText%20Message%20text%0A*%20%40return%20Map%20containing%20headers%20and%20requestBody%0A*%2F%0Apublic%20static%20Map%20prepareRequestData(UserConfigDO%20config%2C%20String%20messageText)%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%201%3A%20Build%20request%20headers%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Defensive%20copy%3A%20avoid%20modifying%20original%20configuration%2C%20ensure%20thread%20safety%0AMap%20headers%20%3D%20new%20HashMap(%0Aconfig.getHeaders()%20!%3D%20null%20%3F%20config.getHeaders()%20%3A%20new%20HashMap()%0A)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%202%3A%20Handle%20API%20key%20decryption%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0AString%20apiKey%20%3D%20config.getApiKey()%3B%0A%2F%2F%20Check%20if%20it's%20an%20encrypted%20key%20(enc%3A%20prefix)%20and%20has%20decryption%20key%0Aif%20(apiKey%20!%3D%20null%20%26%26%20apiKey.startsWith(%22enc%3A%22)%20%26%26%20StringUtils.hasText(config.getSecretKey()))%20%7B%0Atry%20%7B%0A%2F%2F%20Remove%20enc%3A%20prefix%2C%20call%20decryption%20method%0AapiKey%20%3D%20decryptApiKey(apiKey.substring(4)%2C%20config.getSecretKey())%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22API%20key%20decryption%20failed%22%2C%20e)%3B%0Athrow%20new%20ServiceException(CONFIG_NOT_EXISTS%2C%20%22API%20key%20decryption%20failed%3A%20%22%20%2B%20e.getMessage())%3B%0A%7D%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%203%3A%20Place%20API%20key%20according%20to%20strategy%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Strategy%201%3A%20Place%20in%20Authorization%20header%20(default%20strategy)%0Aif%20(%22header%22.equals(config.getApiKeyPlacement())%20%7C%7C%20config.getApiKeyPlacement()%20%3D%3D%20null)%20%7B%0Aheaders.put(%22Authorization%22%2C%20%22Bearer%20%22%20%2B%20apiKey)%3B%0A%7D%0A%2F%2F%20Strategy%202%3A%20Place%20in%20custom%20header%20(like%20x-api-key)%0Aelse%20if%20(%22custom_header%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyHeader()%20!%3D%20null)%20%7B%0Aheaders.put(config.getApiKeyHeader()%2C%20apiKey)%3B%0A%7D%0A%2F%2F%20Ensure%20Content-Type%20exists%20(default%20is%20application%2Fjson)%0Aif%20(!headers.containsKey(%22Content-Type%22))%20%7B%0Aheaders.put(%22Content-Type%22%2C%20%22application%2Fjson%22)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%204%3A%20Build%20request%20body%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Clone%20request%20template%2C%20avoid%20modifying%20original%20configuration%0AMap%20requestBody%20%3D%20new%20HashMap(config.getRequestTemplate())%3B%0A%2F%2F%20Strategy%203%3A%20Place%20API%20key%20in%20request%20body%0Aif%20(%22body%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyBodyPath()%20!%3D%20null)%20%7B%0AJsonUtils.setValueByPath(requestBody%2C%20config.getApiKeyBodyPath()%2C%20apiKey)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%205%3A%20Process%20message%20content%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20If%20there's%20message%20text%20and%20message%20group%20path%2C%20create%20message%20object%0Aif%20(StringUtils.hasText(messageText)%20%26%26%20StringUtils.hasText(config.getRequestMessageGroupPath()))%20%7B%0A%2F%2F%20Get%20field%20name%20configuration%20(with%20defaults)%0AString%20rolePath%20%3D%20StringUtils.hasText(config.getRequestRolePathFromGroup())%20%3F%0Aconfig.getRequestRolePathFromGroup()%20%3A%20%22role%22%3B%0AString%20textPath%20%3D%20StringUtils.hasText(config.getRequestTextPathFromGroup())%20%3F%0Aconfig.getRequestTextPathFromGroup()%20%3A%20%22content%22%3B%0AString%20roleValue%20%3D%20StringUtils.hasText(config.getRequestUserRoleField())%20%3F%0Aconfig.getRequestUserRoleField()%20%3A%20%22user%22%3B%0A%2F%2F%20Build%20message%20object%0AMap%20messageObj%20%3D%20new%20HashMap()%3B%0AmessageObj.put(rolePath%2C%20roleValue)%3B%0AmessageObj.put(textPath%2C%20messageText)%3B%0A%2F%2F%20Create%20message%20array%20and%20set%20to%20request%20body%0AList%3E%20messages%20%3D%20new%20ArrayList()%3B%0Amessages.add(messageObj)%3B%0AJsonUtils.setValueByPath(requestBody%2C%20config.getRequestMessageGroupPath()%2C%20messages)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%206%3A%20Return%20result%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0AMap%20result%20%3D%20new%20HashMap()%3B%0Aresult.put(%22headers%22%2C%20headers)%3B%0Aresult.put(%22requestBody%22%2C%20requestBody)%3B%0Areturn%20result%3B%0A%7D%0A%2F**%0A*%20%E5%87%86%E5%A4%87%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%EF%BC%88%E5%AE%8C%E6%95%B4%E7%89%88%E6%9C%AC%EF%BC%89-%20%E5%A4%84%E7%90%86%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%0A*%0A*%20%40param%20config%20%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE%0A*%20%40param%20messageText%20%E6%96%B0%E6%B6%88%E6%81%AF%E6%96%87%E6%9C%AC%0A*%20%40param%20conversationMessages%20%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%0A*%20%40return%20%E5%8C%85%E5%90%ABheaders%E5%92%8CrequestBody%E7%9A%84Map%0A*%2F%0Apublic%20static%20Map%20prepareRequestData(UserConfigDO%20config%2C%20String%20messageText%2C%0AList%20conversationMessages)%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A41-4%EF%BC%9A%E5%A4%8D%E7%94%A8%E7%AE%80%E5%8D%95%E7%89%88%E6%9C%AC%E7%9A%84%E9%80%BB%E8%BE%91%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E6%9E%84%E5%BB%BA%E8%AF%B7%E6%B1%82%E5%A4%B4%0AMap%20headers%20%3D%20new%20HashMap(%0Aconfig.getHeaders()%20!%3D%20null%20%3F%20config.getHeaders()%20%3A%20new%20HashMap()%0A)%3B%0A%2F%2F%20%E5%A4%84%E7%90%86API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%0AString%20apiKey%20%3D%20config.getApiKey()%3B%0Aif%20(apiKey%20!%3D%20null%20%26%26%20apiKey.startsWith(%22enc%3A%22)%20%26%26%20StringUtils.hasText(config.getSecretKey()))%20%7B%0Atry%20%7B%0AapiKey%20%3D%20decryptApiKey(apiKey.substring(4)%2C%20config.getSecretKey())%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%E5%A4%B1%E8%B4%A5%22%2C%20e)%3B%0Athrow%20new%20ServiceException(CONFIG_NOT_EXISTS%2C%20%22API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%E5%A4%B1%E8%B4%A5%3A%20%22%20%2B%20e.getMessage())%3B%0A%7D%0A%7D%0A%2F%2F%20%E6%A0%B9%E6%8D%AE%E7%AD%96%E7%95%A5%E6%94%BE%E7%BD%AEAPI%E5%AF%86%E9%92%A5%0Aif%20(%22header%22.equals(config.getApiKeyPlacement())%20%7C%7C%20config.getApiKeyPlacement()%20%3D%3D%20null)%20%7B%0Aheaders.put(%22Authorization%22%2C%20%22Bearer%20%22%20%2B%20apiKey)%3B%0A%7D%20else%20if%20(%22custom_header%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyHeader()%20!%3D%20null)%20%7B%0Aheaders.put(config.getApiKeyHeader()%2C%20apiKey)%3B%0A%7D%0Aif%20(!headers.containsKey(%22Content-Type%22))%20%7B%0Aheaders.put(%22Content-Type%22%2C%20%22application%2Fjson%22)%3B%0A%7D%0A%2F%2F%20%E6%9E%84%E5%BB%BA%E8%AF%B7%E6%B1%82%E4%BD%93%0AMap%20requestBody%20%3D%20new%20HashMap(config.getRequestTemplate())%3B%0Aif%20(%22body%22.equals(config.getApiKeyPlacement())%20%26%26%20config.getApiKeyBodyPath()%20!%3D%20null)%20%7B%0AJsonUtils.setValueByPath(requestBody%2C%20config.getApiKeyBodyPath()%2C%20apiKey)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A45%EF%BC%9A%E5%A4%84%E7%90%86%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%EF%BC%88%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91%EF%BC%89%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E8%8E%B7%E5%8F%96%E5%AD%97%E6%AE%B5%E5%90%8D%E9%85%8D%E7%BD%AE%0AString%20rolePath%20%3D%20StringUtils.hasText(config.getRequestRolePathFromGroup())%20%3F%0Aconfig.getRequestRolePathFromGroup()%20%3A%20%22role%22%3B%0AString%20textPath%20%3D%20StringUtils.hasText(config.getRequestTextPathFromGroup())%20%3F%0Aconfig.getRequestTextPathFromGroup()%20%3A%20%22content%22%3B%0AString%20userRoleValue%20%3D%20StringUtils.hasText(config.getRequestUserRoleField())%20%3F%0Aconfig.getRequestUserRoleField()%20%3A%20%22user%22%3B%0AString%20assistantRoleValue%20%3D%20StringUtils.hasText(config.getRequestAssistantField())%20%3F%0Aconfig.getRequestAssistantField()%20%3A%20%22assistant%22%3B%0A%2F%2F%20%E6%9E%84%E5%BB%BA%E5%AE%8C%E6%95%B4%E7%9A%84%E6%B6%88%E6%81%AF%E7%BB%84%0Aif%20(StringUtils.hasText(config.getRequestMessageGroupPath())%20%26%26%0A(conversationMessages%20!%3D%20null%20%7C%7C%20messageText%20!%3D%20null))%20%7B%0AList%3E%20messages%20%3D%20new%20ArrayList()%3B%0A%2F%2F%20%E6%B7%BB%E5%8A%A0%E5%8E%86%E5%8F%B2%E6%B6%88%E6%81%AF%0Aif%20(conversationMessages%20!%3D%20null)%20%7B%0Afor%20(ConversationMessageDO%20message%20%3A%20conversationMessages)%20%7B%0A%2F%2F%20%E8%B7%B3%E8%BF%87%E7%B3%BB%E7%BB%9F%E6%B6%88%E6%81%AF%EF%BC%88%E7%B3%BB%E7%BB%9F%E6%B6%88%E6%81%AF%E9%80%9A%E5%B8%B8%E4%B8%8D%E5%8F%82%E4%B8%8E%E5%AF%B9%E8%AF%9D%E6%B5%81%EF%BC%89%0Aif%20(%22system%22.equals(message.getRole()))%20%7B%0Acontinue%3B%0A%7D%0AMap%20messageObj%20%3D%20new%20HashMap()%3B%0A%2F%2F%20%E8%A7%92%E8%89%B2%E6%98%A0%E5%B0%84%EF%BC%9A%E5%B0%86%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E8%A7%92%E8%89%B2%E6%98%A0%E5%B0%84%E4%B8%BAAPI%E6%89%80%E9%9C%80%E7%9A%84%E8%A7%92%E8%89%B2%0Aif%20(%22user%22.equals(message.getRole()))%20%7B%0AmessageObj.put(rolePath%2C%20userRoleValue)%3B%0A%7D%20else%20if%20(%22assistant%22.equals(message.getRole()))%20%7B%0AmessageObj.put(rolePath%2C%20assistantRoleValue)%3B%0A%7D%20else%20%7B%0A%2F%2F%20%E5%85%B6%E4%BB%96%E8%A7%92%E8%89%B2%E4%BF%9D%E6%8C%81%E5%8E%9F%E6%A0%B7%0AmessageObj.put(rolePath%2C%20message.getRole())%3B%0A%7D%0A%2F%2F%20%E8%AE%BE%E7%BD%AE%E6%B6%88%E6%81%AF%E5%86%85%E5%AE%B9%0AmessageObj.put(textPath%2C%20message.getContent())%3B%0Amessages.add(messageObj)%3B%0A%7D%0A%7D%0A%2F%2F%20%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E7%94%A8%E6%88%B7%E6%B6%88%E6%81%AF%0Aif%20(messageText%20!%3D%20null)%20%7B%0AMap%20userMessage%20%3D%20new%20HashMap()%3B%0AuserMessage.put(rolePath%2C%20userRoleValue)%3B%0AuserMessage.put(textPath%2C%20messageText)%3B%0Amessages.add(userMessage)%3B%0A%7D%0A%2F%2F%20%E5%B0%86%E6%B6%88%E6%81%AF%E7%BB%84%E8%AE%BE%E7%BD%AE%E5%88%B0%E8%AF%B7%E6%B1%82%E4%BD%93%E4%B8%AD%0AJsonUtils.setValueByPath(requestBody%2C%20config.getRequestMessageGroupPath()%2C%20messages)%3B%0A%7D%0A%2F%2F%20%E5%90%91%E5%90%8E%E5%85%BC%E5%AE%B9%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E6%B6%88%E6%81%AF%E7%BB%84%E8%B7%AF%E5%BE%84%EF%BC%8C%E7%9B%B4%E6%8E%A5%E8%AE%BE%E7%BD%AE%E6%96%87%E6%9C%AC%0Aelse%20if%20(messageText%20!%3D%20null%20%26%26%20StringUtils.hasText(config.getRequestTextPathFromGroup()))%20%7B%0AJsonUtils.setValueByPath(requestBody%2C%20config.getRequestTextPathFromGroup()%2C%20messageText)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A46%EF%BC%9A%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0AMap%20result%20%3D%20new%20HashMap()%3B%0Aresult.put(%22headers%22%2C%20headers)%3B%0Aresult.put(%22requestBody%22%2C%20requestBody)%3B%0Areturn%20result%3B%0A%7D%0A%2F**%0A*%20%E8%A7%A3%E5%AF%86API%E5%AF%86%E9%92%A5%20-%20%E5%85%BC%E5%AE%B9CryptoJS%E7%9A%84AES%E8%A7%A3%E5%AF%86%0A*%0A*%20%40param%20encryptedApiKey%20%E5%8A%A0%E5%AF%86%E7%9A%84API%E5%AF%86%E9%92%A5%EF%BC%88Base64%E6%A0%BC%E5%BC%8F%EF%BC%89%0A*%20%40param%20secretKey%20%E8%A7%A3%E5%AF%86%E5%AF%86%E9%92%A5%0A*%20%40return%20%E8%A7%A3%E5%AF%86%E5%90%8E%E7%9A%84API%E5%AF%86%E9%92%A5%0A*%2F%0Apublic%20static%20String%20decryptApiKey(String%20encryptedApiKey%2C%20String%20secretKey)%20%7B%0Atry%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A41%EF%BC%9ABase64%E8%A7%A3%E7%A0%81%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20CryptoJS%E4%BD%BF%E7%94%A8Base64%E7%BC%96%E7%A0%81%E4%BC%A0%E8%BE%93%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AE%0Abyte%5B%5D%20cipherData%20%3D%20java.util.Base64.getDecoder().decode(encryptedApiKey)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E8%A7%A3%E6%9E%90OpenSSL%E6%A0%BC%E5%BC%8F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20CryptoJS%E9%BB%98%E8%AE%A4%E4%BD%BF%E7%94%A8OpenSSL%E6%A0%BC%E5%BC%8F%3A%20%22Salted__%22%20%2B%208%E5%AD%97%E8%8A%82%E7%9B%90%20%2B%20%E5%AF%86%E6%96%87%0A%2F%2F%20%E6%80%BB%E5%85%B116%E5%AD%97%E8%8A%82%E7%9A%84%E5%89%8D%E7%BC%80%EF%BC%888%E5%AD%97%E8%8A%82%22Salted__%22%20%2B%208%E5%AD%97%E8%8A%82%E7%9B%90%E5%80%BC%EF%BC%89%0Abyte%5B%5D%20saltBytes%20%3D%20new%20byte%5B8%5D%3B%0Abyte%5B%5D%20cipherBytes%20%3D%20new%20byte%5BcipherData.length%20-%2016%5D%3B%0A%2F%2F%20%E6%8F%90%E5%8F%96%E7%9B%90%E5%80%BC%EF%BC%88%E8%B7%B3%E8%BF%87%E5%89%8D8%E5%AD%97%E8%8A%82%E7%9A%84%22Salted__%22%EF%BC%89%0ASystem.arraycopy(cipherData%2C%208%2C%20saltBytes%2C%200%2C%208)%3B%0A%2F%2F%20%E6%8F%90%E5%8F%96%E5%AE%9E%E9%99%85%E5%AF%86%E6%96%87%EF%BC%88%E8%B7%B3%E8%BF%87%E5%89%8D16%E5%AD%97%E8%8A%82%EF%BC%89%0ASystem.arraycopy(cipherData%2C%2016%2C%20cipherBytes%2C%200%2C%20cipherData.length%20-%2016)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E6%B4%BE%E7%94%9F%E5%AF%86%E9%92%A5%E5%92%8CIV%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E4%BD%BF%E7%94%A8EVP_BytesToKey%E7%AE%97%E6%B3%95%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E5%90%91%E9%87%8F%0Abyte%5B%5D%5B%5D%20keyAndIV%20%3D%20EVP_BytesToKey(32%2C%2016%2C%20secretKey.getBytes(StandardCharsets.UTF_8)%2C%20saltBytes%2C%201)%3B%0Abyte%5B%5D%20key%20%3D%20keyAndIV%5B0%5D%3B%20%20%2F%2F%2032%E5%AD%97%E8%8A%82%E5%AF%86%E9%92%A5%EF%BC%88AES-256%EF%BC%89%0Abyte%5B%5D%20iv%20%3D%20keyAndIV%5B1%5D%3B%20%20%20%2F%2F%2016%E5%AD%97%E8%8A%82IV%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A44%EF%BC%9AAES%E8%A7%A3%E5%AF%86%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E5%88%9B%E5%BB%BAAES%E5%AF%86%E9%92%A5%E8%A7%84%E8%8C%83%0ASecretKeySpec%20secretKeySpec%20%3D%20new%20SecretKeySpec(key%2C%20%22AES%22)%3B%0A%2F%2F%20%E5%88%9B%E5%BB%BAIV%E5%8F%82%E6%95%B0%E8%A7%84%E8%8C%83%0Ajavax.crypto.spec.IvParameterSpec%20ivSpec%20%3D%20new%20javax.crypto.spec.IvParameterSpec(iv)%3B%0A%2F%2F%20%E5%88%9D%E5%A7%8B%E5%8C%96%E8%A7%A3%E5%AF%86%E5%99%A8%EF%BC%9AAES%2FCBC%2FPKCS5Padding%EF%BC%88%E4%B8%8ECryptoJS%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE%E4%B8%80%E8%87%B4%EF%BC%89%0ACipher%20cipher%20%3D%20Cipher.getInstance(%22AES%2FCBC%2FPKCS5Padding%22)%3B%0Acipher.init(Cipher.DECRYPT_MODE%2C%20secretKeySpec%2C%20ivSpec)%3B%0A%2F%2F%20%E6%89%A7%E8%A1%8C%E8%A7%A3%E5%AF%86%0Abyte%5B%5D%20decryptedBytes%20%3D%20cipher.doFinal(cipherBytes)%3B%0A%2F%2F%20%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%B9%B6%E8%BF%94%E5%9B%9E%0Areturn%20new%20String(decryptedBytes%2C%20StandardCharsets.UTF_8)%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%E5%A4%B1%E8%B4%A5%22%2C%20e)%3B%0Athrow%20new%20ServiceException(CONFIG_NOT_EXISTS%2C%20%22API%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86%E5%A4%B1%E8%B4%A5%3A%20%22%20%2B%20e.getMessage())%3B%0A%7D%0A%7D%0A%2F**%0A*%20EVP_BytesToKey%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0%20-%20%E5%AF%86%E9%92%A5%E6%B4%BE%E7%94%9F%E5%87%BD%E6%95%B0%0A*%0A*%20%E8%BF%99%E6%98%AFOpenSSL%E6%A0%87%E5%87%86%E7%9A%84%E5%AF%86%E9%92%A5%E6%B4%BE%E7%94%9F%E7%AE%97%E6%B3%95%EF%BC%8C%E7%94%A8%E4%BA%8E%E4%BB%8E%E5%AF%86%E7%A0%81%E5%92%8C%E7%9B%90%E5%80%BC%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5%E5%92%8CIV%0A*%0A*%20%40param%20keyLen%20%E5%AF%86%E9%92%A5%E9%95%BF%E5%BA%A6%EF%BC%88%E5%AD%97%E8%8A%82%EF%BC%89%0A*%20%40param%20ivLen%20IV%E9%95%BF%E5%BA%A6%EF%BC%88%E5%AD%97%E8%8A%82%EF%BC%89%0A*%20%40param%20password%20%E5%AF%86%E7%A0%81%0A*%20%40param%20salt%20%E7%9B%90%E5%80%BC%0A*%20%40param%20iterations%20%E8%BF%AD%E4%BB%A3%E6%AC%A1%E6%95%B0%0A*%20%40return%20%5B%E5%AF%86%E9%92%A5%2C%20IV%5D%0A*%2F%0Aprivate%20static%20byte%5B%5D%5B%5D%20EVP_BytesToKey(int%20keyLen%2C%20int%20ivLen%2C%20byte%5B%5D%20password%2C%20byte%5B%5D%20salt%2C%20int%20iterations)%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A41%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0Abyte%5B%5D%20key%20%3D%20new%20byte%5BkeyLen%5D%3B%0Abyte%5B%5D%20iv%20%3D%20new%20byte%5BivLen%5D%3B%0Abyte%5B%5D%20concatenatedHashBytes%20%3D%20new%20byte%5B0%5D%3B%0A%2F%2F%20%E5%88%9D%E5%A7%8B%E5%8C%96MD5%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81%0AMessageDigest%20md5%3B%0Atry%20%7B%0Amd5%20%3D%20MessageDigest.getInstance(%22MD5%22)%3B%0A%7D%20catch%20(NoSuchAlgorithmException%20e)%20%7B%0Athrow%20new%20RuntimeException(%22MD5%E7%AE%97%E6%B3%95%E4%B8%8D%E5%8F%AF%E7%94%A8%22%2C%20e)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A42%EF%BC%9A%E8%AE%A1%E7%AE%97%E9%9C%80%E8%A6%81%E7%9A%84%E5%93%88%E5%B8%8C%E8%BD%AE%E6%95%B0%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0Aint%20hashLen%20%3D%2016%3B%20%2F%2F%20MD5%E8%BE%93%E5%87%BA%E9%95%BF%E5%BA%A6%0Aint%20keyAndIvLen%20%3D%20keyLen%20%2B%20ivLen%3B%0Aint%20numHashes%20%3D%20(keyAndIvLen%20%2B%20hashLen%20-%201)%20%2F%20hashLen%3B%20%2F%2F%20%E5%90%91%E4%B8%8A%E5%8F%96%E6%95%B4%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A43%EF%BC%9A%E7%94%9F%E6%88%90%E5%93%88%E5%B8%8C%E9%93%BE%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0Abyte%5B%5D%20result%20%3D%20new%20byte%5BnumHashes%20*%20hashLen%5D%3B%0Aint%20resultLen%20%3D%200%3B%0Afor%20(int%20i%20%3D%201%3B%20i%20%2F%2F%20%E7%AC%AC%E4%B8%80%E8%BD%AE%EF%BC%9A%E5%8F%AA%E4%BD%BF%E7%94%A8%E5%AF%86%E7%A0%81%E5%92%8C%E7%9B%90%0A%2F%2F%20%E5%90%8E%E7%BB%AD%E8%BD%AE%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%89%8D%E4%B8%80%E8%BD%AE%E7%9A%84%E7%BB%93%E6%9E%9C%20%2B%20%E5%AF%86%E7%A0%81%20%2B%20%E7%9B%90%0Amd5.reset()%3B%0Aif%20(i%20%3E%201)%20%7B%0Amd5.update(concatenatedHashBytes)%3B%0A%7D%0Amd5.update(password)%3B%0Aif%20(salt%20!%3D%20null)%20%7B%0Amd5.update(salt)%3B%0A%7D%0AconcatenatedHashBytes%20%3D%20md5.digest()%3B%0A%2F%2F%20%E6%89%A7%E8%A1%8C%E9%A2%9D%E5%A4%96%E7%9A%84%E8%BF%AD%E4%BB%A3%EF%BC%88%E9%80%9A%E5%B8%B8%E4%B8%BA1%EF%BC%8C%E5%8D%B3%E4%B8%8D%E9%A2%9D%E5%A4%96%E8%BF%AD%E4%BB%A3%EF%BC%89%0Afor%20(int%20j%20%3D%201%3B%20j%20%2F%2F%20%E5%B0%86%E5%93%88%E5%B8%8C%E7%BB%93%E6%9E%9C%E6%8B%B7%E8%B4%9D%E5%88%B0%E7%BB%93%E6%9E%9C%E6%95%B0%E7%BB%84%E4%B8%AD%0ASystem.arraycopy(%0AconcatenatedHashBytes%2C%200%2C%0Aresult%2C%20resultLen%2C%0AMath.min(concatenatedHashBytes.length%2C%20result.length%20-%20resultLen)%0A)%3B%0AresultLen%20%2B%3D%20concatenatedHashBytes.length%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20%E6%AD%A5%E9%AA%A44%EF%BC%9A%E5%88%86%E7%A6%BB%E5%AF%86%E9%92%A5%E5%92%8CIV%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20%E4%BB%8E%E7%BB%93%E6%9E%9C%E4%B8%AD%E6%8F%90%E5%8F%96%E5%AF%86%E9%92%A5%0ASystem.arraycopy(result%2C%200%2C%20key%2C%200%2C%20keyLen)%3B%0A%2F%2F%20%E4%BB%8E%E7%BB%93%E6%9E%9C%E4%B8%AD%E6%8F%90%E5%8F%96IV%0ASystem.arraycopy(result%2C%20keyLen%2C%20iv%2C%200%2C%20ivLen)%3B%0Areturn%20new%20byte%5B%5D%5B%5D%7Bkey%2C%20iv%7D%3B%0A%7D%0A%2F**%0A*%20HTTP%20POST%20request%20-%20HuTool-based%20wrapper%0A*%0A*%20%40param%20url%20Request%20URL%0A*%20%40param%20headers%20Request%20headers%0A*%20%40param%20requestBody%20Request%20body%0A*%20%40return%20Response%20string%0A*%2F%0Apublic%20static%20String%20post(String%20url%2C%20Map%20headers%2C%20String%20requestBody)%20%7B%0Atry%20(HttpResponse%20response%20%3D%20HttpRequest.post(url)%0A.addHeaders(headers)%0A.body(requestBody)%0A.execute())%20%7B%0Areturn%20response.body()%3B%0A%7D%0A%7D%0A%2F**%0A*%20HTTP%20GET%20request%20-%20HuTool-based%20wrapper%0A*%0A*%20%40param%20url%20Request%20URL%0A*%20%40param%20headers%20Request%20headers%0A*%20%40return%20Response%20string%0A*%2F%0Apublic%20static%20String%20get(String%20url%2C%20Map%20headers)%20%7B%0Atry%20(HttpResponse%20response%20%3D%20HttpRequest.get(url)%0A.addHeaders(headers)%0A.execute())%20%7B%0Areturn%20response.body()%3B%0A%7D%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">package</span> com.chat.allchatonthis.common.util.http;

<span class="hljs-keyword inline">import</span> cn.hutool.core.codec.Base64;
<span class="hljs-keyword inline">import</span> cn.hutool.core.map.TableMap;
<span class="hljs-keyword inline">import</span> cn.hutool.core.net.url.UrlBuilder;
<span class="hljs-keyword inline">import</span> cn.hutool.core.util.ReflectUtil;
<span class="hljs-keyword inline">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword inline">import</span> cn.hutool.http.HttpRequest;
<span class="hljs-keyword inline">import</span> cn.hutool.http.HttpResponse;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.common.exception.ServiceException;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.common.util.json.JsonUtils;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.entity.dataobject.ConversationMessageDO;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.entity.dataobject.UserConfigDO;
<span class="hljs-keyword inline">import</span> jakarta.servlet.http.HttpServletRequest;
<span class="hljs-keyword inline">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword inline">import</span> org.springframework.util.StringUtils;

<span class="hljs-keyword inline">import</span> javax.crypto.Cipher;
<span class="hljs-keyword inline">import</span> javax.crypto.spec.SecretKeySpec;
<span class="hljs-keyword inline">import</span> java.nio.charset.StandardCharsets;
<span class="hljs-keyword inline">import</span> java.security.MessageDigest;
<span class="hljs-keyword inline">import</span> java.security.NoSuchAlgorithmException;
<span class="hljs-keyword inline">import</span> java.util.ArrayList;
<span class="hljs-keyword inline">import</span> java.util.HashMap;
<span class="hljs-keyword inline">import</span> java.util.List;
<span class="hljs-keyword inline">import</span> java.util.Map;

<span class="hljs-keyword inline">import</span> <span class="hljs-keyword inline">static</span> com.chat.allchatonthis.common.enums.ErrorCodeConstants.CONFIG_NOT_EXISTS;

<span class="hljs-comment inline">/**
 * HTTP Utility Class - Core logic for processing API requests
 */</span>
<span class="hljs-meta inline">@Slf4j</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">HttpUtils</span> {

    <span class="hljs-comment inline">/**
     * Prepare request data (simple version) - Process single message
     * 
     * <span class="hljs-doctag inline">@param</span> config User configuration
     * <span class="hljs-doctag inline">@param</span> messageText Message text
     * <span class="hljs-doctag inline">@return</span> Map containing headers and requestBody
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_ inline">prepareRequestData</span><span class="hljs-params inline">(UserConfigDO config, String messageText)</span> {
        <span class="hljs-comment inline">// ==================== Step 1: Build request headers ====================</span>
        
        <span class="hljs-comment inline">// Defensive copy: avoid modifying original configuration, ensure thread safety</span>
        Map&lt;String, String&gt; headers = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(
            config.getHeaders() != <span class="hljs-literal inline">null</span> ? config.getHeaders() : <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;()
        );

        <span class="hljs-comment inline">// ==================== Step 2: Handle API key decryption ====================</span>
        
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">apiKey</span> <span class="hljs-operator inline">=</span> config.getApiKey();
        
        <span class="hljs-comment inline">// Check if it&#x27;s an encrypted key (enc: prefix) and has decryption key</span>
        <span class="hljs-keyword inline">if</span> (apiKey != <span class="hljs-literal inline">null</span> &amp;&amp; apiKey.startsWith(<span class="hljs-string inline">&quot;enc:&quot;</span>) &amp;&amp; StringUtils.hasText(config.getSecretKey())) {
            <span class="hljs-keyword inline">try</span> {
                <span class="hljs-comment inline">// Remove enc: prefix, call decryption method</span>
                apiKey = decryptApiKey(apiKey.substring(<span class="hljs-number inline">4</span>), config.getSecretKey());
            } <span class="hljs-keyword inline">catch</span> (Exception e) {
                log.error(<span class="hljs-string inline">&quot;API key decryption failed&quot;</span>, e);
                <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIG_NOT_EXISTS, <span class="hljs-string inline">&quot;API key decryption failed: &quot;</span> + e.getMessage());
            }
        }

        <span class="hljs-comment inline">// ==================== Step 3: Place API key according to strategy ====================</span>
        
        <span class="hljs-comment inline">// Strategy 1: Place in Authorization header (default strategy)</span>
        <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;header&quot;</span>.equals(config.getApiKeyPlacement()) || config.getApiKeyPlacement() == <span class="hljs-literal inline">null</span>) {
            headers.put(<span class="hljs-string inline">&quot;Authorization&quot;</span>, <span class="hljs-string inline">&quot;Bearer &quot;</span> + apiKey);
        } 
        <span class="hljs-comment inline">// Strategy 2: Place in custom header (like x-api-key)</span>
        <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;custom_header&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyHeader() != <span class="hljs-literal inline">null</span>) {
            headers.put(config.getApiKeyHeader(), apiKey);
        }

        <span class="hljs-comment inline">// Ensure Content-Type exists (default is application/json)</span>
        <span class="hljs-keyword inline">if</span> (!headers.containsKey(<span class="hljs-string inline">&quot;Content-Type&quot;</span>)) {
            headers.put(<span class="hljs-string inline">&quot;Content-Type&quot;</span>, <span class="hljs-string inline">&quot;application/json&quot;</span>);
        }

        <span class="hljs-comment inline">// ==================== Step 4: Build request body ====================</span>
        
        <span class="hljs-comment inline">// Clone request template, avoid modifying original configuration</span>
        Map&lt;String, Object&gt; requestBody = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(config.getRequestTemplate());

        <span class="hljs-comment inline">// Strategy 3: Place API key in request body</span>
        <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;body&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyBodyPath() != <span class="hljs-literal inline">null</span>) {
            JsonUtils.setValueByPath(requestBody, config.getApiKeyBodyPath(), apiKey);
        }

        <span class="hljs-comment inline">// ==================== Step 5: Process message content ====================</span>
        
        <span class="hljs-comment inline">// If there&#x27;s message text and message group path, create message object</span>
        <span class="hljs-keyword inline">if</span> (StringUtils.hasText(messageText) &amp;&amp; StringUtils.hasText(config.getRequestMessageGroupPath())) {
            
            <span class="hljs-comment inline">// Get field name configuration (with defaults)</span>
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">rolePath</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestRolePathFromGroup()) ?
                    config.getRequestRolePathFromGroup() : <span class="hljs-string inline">&quot;role&quot;</span>;
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">textPath</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestTextPathFromGroup()) ?
                    config.getRequestTextPathFromGroup() : <span class="hljs-string inline">&quot;content&quot;</span>;
            <span class="hljs-type inline">String</span> <span class="hljs-variable inline">roleValue</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestUserRoleField()) ?
                    config.getRequestUserRoleField() : <span class="hljs-string inline">&quot;user&quot;</span>;

            <span class="hljs-comment inline">// Build message object</span>
            Map&lt;String, Object&gt; messageObj = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
            messageObj.put(rolePath, roleValue);
            messageObj.put(textPath, messageText);

            <span class="hljs-comment inline">// Create message array and set to request body</span>
            List&lt;Map&lt;String, Object&gt;&gt; messages = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;();
            messages.add(messageObj);
            JsonUtils.setValueByPath(requestBody, config.getRequestMessageGroupPath(), messages);
        }

        <span class="hljs-comment inline">// ==================== Step 6: Return result ====================</span>
        
        Map&lt;String, Object&gt; result = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
        result.put(<span class="hljs-string inline">&quot;headers&quot;</span>, headers);
        result.put(<span class="hljs-string inline">&quot;requestBody&quot;</span>, requestBody);

        <span class="hljs-keyword inline">return</span> result;
    }

    <span class="hljs-comment inline">/**
     * 准备请求数据（完整版本）- 处理对话历史
     * 
     * <span class="hljs-doctag inline">@param</span> config 用户配置
     * <span class="hljs-doctag inline">@param</span> messageText 新消息文本
     * <span class="hljs-doctag inline">@param</span> conversationMessages 对话历史
     * <span class="hljs-doctag inline">@return</span> 包含headers和requestBody的Map
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_ inline">prepareRequestData</span><span class="hljs-params inline">(UserConfigDO config, String messageText, 
                                                        List&lt;ConversationMessageDO&gt; conversationMessages)</span> {
        <span class="hljs-comment inline">// ==================== 步骤1-4：复用简单版本的逻辑 ====================</span>
        
        <span class="hljs-comment inline">// 构建请求头</span>
        Map&lt;String, String&gt; headers = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(
            config.getHeaders() != <span class="hljs-literal inline">null</span> ? config.getHeaders() : <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;()
        );

        <span class="hljs-comment inline">// 处理API密钥解密</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">apiKey</span> <span class="hljs-operator inline">=</span> config.getApiKey();
        <span class="hljs-keyword inline">if</span> (apiKey != <span class="hljs-literal inline">null</span> &amp;&amp; apiKey.startsWith(<span class="hljs-string inline">&quot;enc:&quot;</span>) &amp;&amp; StringUtils.hasText(config.getSecretKey())) {
            <span class="hljs-keyword inline">try</span> {
                apiKey = decryptApiKey(apiKey.substring(<span class="hljs-number inline">4</span>), config.getSecretKey());
            } <span class="hljs-keyword inline">catch</span> (Exception e) {
                log.error(<span class="hljs-string inline">&quot;API密钥解密失败&quot;</span>, e);
                <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIG_NOT_EXISTS, <span class="hljs-string inline">&quot;API密钥解密失败: &quot;</span> + e.getMessage());
            }
        }

        <span class="hljs-comment inline">// 根据策略放置API密钥</span>
        <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;header&quot;</span>.equals(config.getApiKeyPlacement()) || config.getApiKeyPlacement() == <span class="hljs-literal inline">null</span>) {
            headers.put(<span class="hljs-string inline">&quot;Authorization&quot;</span>, <span class="hljs-string inline">&quot;Bearer &quot;</span> + apiKey);
        } <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;custom_header&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyHeader() != <span class="hljs-literal inline">null</span>) {
            headers.put(config.getApiKeyHeader(), apiKey);
        }

        <span class="hljs-keyword inline">if</span> (!headers.containsKey(<span class="hljs-string inline">&quot;Content-Type&quot;</span>)) {
            headers.put(<span class="hljs-string inline">&quot;Content-Type&quot;</span>, <span class="hljs-string inline">&quot;application/json&quot;</span>);
        }

        <span class="hljs-comment inline">// 构建请求体</span>
        Map&lt;String, Object&gt; requestBody = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;(config.getRequestTemplate());

        <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;body&quot;</span>.equals(config.getApiKeyPlacement()) &amp;&amp; config.getApiKeyBodyPath() != <span class="hljs-literal inline">null</span>) {
            JsonUtils.setValueByPath(requestBody, config.getApiKeyBodyPath(), apiKey);
        }

        <span class="hljs-comment inline">// ==================== 步骤5：处理对话历史（核心逻辑） ====================</span>
        
        <span class="hljs-comment inline">// 获取字段名配置</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">rolePath</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestRolePathFromGroup()) ?
                config.getRequestRolePathFromGroup() : <span class="hljs-string inline">&quot;role&quot;</span>;
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">textPath</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestTextPathFromGroup()) ?
                config.getRequestTextPathFromGroup() : <span class="hljs-string inline">&quot;content&quot;</span>;
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">userRoleValue</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestUserRoleField()) ?
                config.getRequestUserRoleField() : <span class="hljs-string inline">&quot;user&quot;</span>;
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">assistantRoleValue</span> <span class="hljs-operator inline">=</span> StringUtils.hasText(config.getRequestAssistantField()) ?
                config.getRequestAssistantField() : <span class="hljs-string inline">&quot;assistant&quot;</span>;

        <span class="hljs-comment inline">// 构建完整的消息组</span>
        <span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getRequestMessageGroupPath()) &amp;&amp; 
            (conversationMessages != <span class="hljs-literal inline">null</span> || messageText != <span class="hljs-literal inline">null</span>)) {
            
            List&lt;Map&lt;String, Object&gt;&gt; messages = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ArrayList</span>&lt;&gt;();

            <span class="hljs-comment inline">// 添加历史消息</span>
            <span class="hljs-keyword inline">if</span> (conversationMessages != <span class="hljs-literal inline">null</span>) {
                <span class="hljs-keyword inline">for</span> (ConversationMessageDO message : conversationMessages) {
                    <span class="hljs-comment inline">// 跳过系统消息（系统消息通常不参与对话流）</span>
                    <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;system&quot;</span>.equals(message.getRole())) {
                        <span class="hljs-keyword inline">continue</span>;
                    }

                    Map&lt;String, Object&gt; messageObj = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
                    
                    <span class="hljs-comment inline">// 角色映射：将数据库中的角色映射为API所需的角色</span>
                    <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;user&quot;</span>.equals(message.getRole())) {
                        messageObj.put(rolePath, userRoleValue);
                    } <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (<span class="hljs-string inline">&quot;assistant&quot;</span>.equals(message.getRole())) {
                        messageObj.put(rolePath, assistantRoleValue);
                    } <span class="hljs-keyword inline">else</span> {
                        <span class="hljs-comment inline">// 其他角色保持原样</span>
                        messageObj.put(rolePath, message.getRole());
                    }
                    
                    <span class="hljs-comment inline">// 设置消息内容</span>
                    messageObj.put(textPath, message.getContent());
                    messages.add(messageObj);
                }
            }

            <span class="hljs-comment inline">// 添加新的用户消息</span>
            <span class="hljs-keyword inline">if</span> (messageText != <span class="hljs-literal inline">null</span>) {
                Map&lt;String, Object&gt; userMessage = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
                userMessage.put(rolePath, userRoleValue);
                userMessage.put(textPath, messageText);
                messages.add(userMessage);
            }

            <span class="hljs-comment inline">// 将消息组设置到请求体中</span>
            JsonUtils.setValueByPath(requestBody, config.getRequestMessageGroupPath(), messages);
        }
        <span class="hljs-comment inline">// 向后兼容：如果没有消息组路径，直接设置文本</span>
        <span class="hljs-keyword inline">else</span> <span class="hljs-keyword inline">if</span> (messageText != <span class="hljs-literal inline">null</span> &amp;&amp; StringUtils.hasText(config.getRequestTextPathFromGroup())) {
            JsonUtils.setValueByPath(requestBody, config.getRequestTextPathFromGroup(), messageText);
        }

        <span class="hljs-comment inline">// ==================== 步骤6：返回结果 ====================</span>
        
        Map&lt;String, Object&gt; result = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">HashMap</span>&lt;&gt;();
        result.put(<span class="hljs-string inline">&quot;headers&quot;</span>, headers);
        result.put(<span class="hljs-string inline">&quot;requestBody&quot;</span>, requestBody);

        <span class="hljs-keyword inline">return</span> result;
    }

    <span class="hljs-comment inline">/**
     * 解密API密钥 - 兼容CryptoJS的AES解密
     * 
     * <span class="hljs-doctag inline">@param</span> encryptedApiKey 加密的API密钥（Base64格式）
     * <span class="hljs-doctag inline">@param</span> secretKey 解密密钥
     * <span class="hljs-doctag inline">@return</span> 解密后的API密钥
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">decryptApiKey</span><span class="hljs-params inline">(String encryptedApiKey, String secretKey)</span> {
        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-comment inline">// ==================== 步骤1：Base64解码 ====================</span>
            
            <span class="hljs-comment inline">// CryptoJS使用Base64编码传输加密数据</span>
            <span class="hljs-type inline">byte</span>[] cipherData = java.util.Base64.getDecoder().decode(encryptedApiKey);

            <span class="hljs-comment inline">// ==================== 步骤2：解析OpenSSL格式 ====================</span>
            
            <span class="hljs-comment inline">// CryptoJS默认使用OpenSSL格式: &quot;Salted__&quot; + 8字节盐 + 密文</span>
            <span class="hljs-comment inline">// 总共16字节的前缀（8字节&quot;Salted__&quot; + 8字节盐值）</span>
            <span class="hljs-type inline">byte</span>[] saltBytes = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[<span class="hljs-number inline">8</span>];
            <span class="hljs-type inline">byte</span>[] cipherBytes = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[cipherData.length - <span class="hljs-number inline">16</span>];

            <span class="hljs-comment inline">// 提取盐值（跳过前8字节的&quot;Salted__&quot;）</span>
            System.arraycopy(cipherData, <span class="hljs-number inline">8</span>, saltBytes, <span class="hljs-number inline">0</span>, <span class="hljs-number inline">8</span>);
            <span class="hljs-comment inline">// 提取实际密文（跳过前16字节）</span>
            System.arraycopy(cipherData, <span class="hljs-number inline">16</span>, cipherBytes, <span class="hljs-number inline">0</span>, cipherData.length - <span class="hljs-number inline">16</span>);

            <span class="hljs-comment inline">// ==================== 步骤3：派生密钥和IV ====================</span>
            
            <span class="hljs-comment inline">// 使用EVP_BytesToKey算法生成密钥和初始化向量</span>
            <span class="hljs-type inline">byte</span>[][] keyAndIV = EVP_BytesToKey(<span class="hljs-number inline">32</span>, <span class="hljs-number inline">16</span>, secretKey.getBytes(StandardCharsets.UTF_8), saltBytes, <span class="hljs-number inline">1</span>);
            <span class="hljs-type inline">byte</span>[] key = keyAndIV[<span class="hljs-number inline">0</span>];  <span class="hljs-comment inline">// 32字节密钥（AES-256）</span>
            <span class="hljs-type inline">byte</span>[] iv = keyAndIV[<span class="hljs-number inline">1</span>];   <span class="hljs-comment inline">// 16字节IV</span>

            <span class="hljs-comment inline">// ==================== 步骤4：AES解密 ====================</span>
            
            <span class="hljs-comment inline">// 创建AES密钥规范</span>
            <span class="hljs-type inline">SecretKeySpec</span> <span class="hljs-variable inline">secretKeySpec</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">SecretKeySpec</span>(key, <span class="hljs-string inline">&quot;AES&quot;</span>);
            <span class="hljs-comment inline">// 创建IV参数规范</span>
            javax.crypto.spec.<span class="hljs-type inline">IvParameterSpec</span> <span class="hljs-variable inline">ivSpec</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">javax</span>.crypto.spec.IvParameterSpec(iv);

            <span class="hljs-comment inline">// 初始化解密器：AES/CBC/PKCS5Padding（与CryptoJS默认设置一致）</span>
            <span class="hljs-type inline">Cipher</span> <span class="hljs-variable inline">cipher</span> <span class="hljs-operator inline">=</span> Cipher.getInstance(<span class="hljs-string inline">&quot;AES/CBC/PKCS5Padding&quot;</span>);
            cipher.init(Cipher.DECRYPT_MODE, secretKeySpec, ivSpec);

            <span class="hljs-comment inline">// 执行解密</span>
            <span class="hljs-type inline">byte</span>[] decryptedBytes = cipher.doFinal(cipherBytes);
            
            <span class="hljs-comment inline">// 转换为字符串并返回</span>
            <span class="hljs-keyword inline">return</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">String</span>(decryptedBytes, StandardCharsets.UTF_8);
            
        } <span class="hljs-keyword inline">catch</span> (Exception e) {
            log.error(<span class="hljs-string inline">&quot;API密钥解密失败&quot;</span>, e);
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIG_NOT_EXISTS, <span class="hljs-string inline">&quot;API密钥解密失败: &quot;</span> + e.getMessage());
        }
    }

    <span class="hljs-comment inline">/**
     * EVP_BytesToKey算法实现 - 密钥派生函数
     * 
     * 这是OpenSSL标准的密钥派生算法，用于从密码和盐值生成密钥和IV
     * 
     * <span class="hljs-doctag inline">@param</span> keyLen 密钥长度（字节）
     * <span class="hljs-doctag inline">@param</span> ivLen IV长度（字节）
     * <span class="hljs-doctag inline">@param</span> password 密码
     * <span class="hljs-doctag inline">@param</span> salt 盐值
     * <span class="hljs-doctag inline">@param</span> iterations 迭代次数
     * <span class="hljs-doctag inline">@return</span> [密钥, IV]
     */</span>
    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">static</span> <span class="hljs-type inline">byte</span>[][] EVP_BytesToKey(<span class="hljs-type inline">int</span> keyLen, <span class="hljs-type inline">int</span> ivLen, <span class="hljs-type inline">byte</span>[] password, <span class="hljs-type inline">byte</span>[] salt, <span class="hljs-type inline">int</span> iterations) {
        <span class="hljs-comment inline">// ==================== 步骤1：初始化 ====================</span>
        
        <span class="hljs-type inline">byte</span>[] key = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[keyLen];
        <span class="hljs-type inline">byte</span>[] iv = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[ivLen];
        <span class="hljs-type inline">byte</span>[] concatenatedHashBytes = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[<span class="hljs-number inline">0</span>];

        <span class="hljs-comment inline">// 初始化MD5消息摘要</span>
        MessageDigest md5;
        <span class="hljs-keyword inline">try</span> {
            md5 = MessageDigest.getInstance(<span class="hljs-string inline">&quot;MD5&quot;</span>);
        } <span class="hljs-keyword inline">catch</span> (NoSuchAlgorithmException e) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">RuntimeException</span>(<span class="hljs-string inline">&quot;MD5算法不可用&quot;</span>, e);
        }

        <span class="hljs-comment inline">// ==================== 步骤2：计算需要的哈希轮数 ====================</span>
        
        <span class="hljs-type inline">int</span> <span class="hljs-variable inline">hashLen</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">16</span>; <span class="hljs-comment inline">// MD5输出长度</span>
        <span class="hljs-type inline">int</span> <span class="hljs-variable inline">keyAndIvLen</span> <span class="hljs-operator inline">=</span> keyLen + ivLen;
        <span class="hljs-type inline">int</span> <span class="hljs-variable inline">numHashes</span> <span class="hljs-operator inline">=</span> (keyAndIvLen + hashLen - <span class="hljs-number inline">1</span>) / hashLen; <span class="hljs-comment inline">// 向上取整</span>

        <span class="hljs-comment inline">// ==================== 步骤3：生成哈希链 ====================</span>
        
        <span class="hljs-type inline">byte</span>[] result = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[numHashes * hashLen];
        <span class="hljs-type inline">int</span> <span class="hljs-variable inline">resultLen</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">0</span>;

        <span class="hljs-keyword inline">for</span> (<span class="hljs-type inline">int</span> <span class="hljs-variable inline">i</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">1</span>; i &lt;= numHashes; i++) {
            <span class="hljs-comment inline">// 第一轮：只使用密码和盐</span>
            <span class="hljs-comment inline">// 后续轮：使用前一轮的结果 + 密码 + 盐</span>
            md5.reset();
            <span class="hljs-keyword inline">if</span> (i &gt; <span class="hljs-number inline">1</span>) {
                md5.update(concatenatedHashBytes);
            }
            md5.update(password);
            <span class="hljs-keyword inline">if</span> (salt != <span class="hljs-literal inline">null</span>) {
                md5.update(salt);
            }
            concatenatedHashBytes = md5.digest();

            <span class="hljs-comment inline">// 执行额外的迭代（通常为1，即不额外迭代）</span>
            <span class="hljs-keyword inline">for</span> (<span class="hljs-type inline">int</span> <span class="hljs-variable inline">j</span> <span class="hljs-operator inline">=</span> <span class="hljs-number inline">1</span>; j &lt; iterations; j++) {
                md5.reset();
                md5.update(concatenatedHashBytes);
                concatenatedHashBytes = md5.digest();
            }

            <span class="hljs-comment inline">// 将哈希结果拷贝到结果数组中</span>
            System.arraycopy(
                concatenatedHashBytes, <span class="hljs-number inline">0</span>,
                result, resultLen,
                Math.min(concatenatedHashBytes.length, result.length - resultLen)
            );
            resultLen += concatenatedHashBytes.length;
        }

        <span class="hljs-comment inline">// ==================== 步骤4：分离密钥和IV ====================</span>
        
        <span class="hljs-comment inline">// 从结果中提取密钥</span>
        System.arraycopy(result, <span class="hljs-number inline">0</span>, key, <span class="hljs-number inline">0</span>, keyLen);
        <span class="hljs-comment inline">// 从结果中提取IV</span>
        System.arraycopy(result, keyLen, iv, <span class="hljs-number inline">0</span>, ivLen);

        <span class="hljs-keyword inline">return</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">byte</span>[][]{key, iv};
    }

    <span class="hljs-comment inline">/**
     * HTTP POST request - HuTool-based wrapper
     * 
     * <span class="hljs-doctag inline">@param</span> url Request URL
     * <span class="hljs-doctag inline">@param</span> headers Request headers
     * <span class="hljs-doctag inline">@param</span> requestBody Request body
     * <span class="hljs-doctag inline">@return</span> Response string
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">post</span><span class="hljs-params inline">(String url, Map&lt;String, String&gt; headers, String requestBody)</span> {
        <span class="hljs-keyword inline">try</span> (<span class="hljs-type inline">HttpResponse</span> <span class="hljs-variable inline">response</span> <span class="hljs-operator inline">=</span> HttpRequest.post(url)
                .addHeaders(headers)
                .body(requestBody)
                .execute()) {
            <span class="hljs-keyword inline">return</span> response.body();
        }
    }

    <span class="hljs-comment inline">/**
     * HTTP GET request - HuTool-based wrapper
     * 
     * <span class="hljs-doctag inline">@param</span> url Request URL  
     * <span class="hljs-doctag inline">@param</span> headers Request headers
     * <span class="hljs-doctag inline">@return</span> Response string
     */</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">static</span> String <span class="hljs-title function_ inline">get</span><span class="hljs-params inline">(String url, Map&lt;String, String&gt; headers)</span> {
        <span class="hljs-keyword inline">try</span> (<span class="hljs-type inline">HttpResponse</span> <span class="hljs-variable inline">response</span> <span class="hljs-operator inline">=</span> HttpRequest.get(url)
                .addHeaders(headers)
                .execute()) {
            <span class="hljs-keyword inline">return</span> response.body();
        }
    }
}
</code></pre>
            </div>
        
<h3 id="conversationmessageserviceimpl-complete-implementation-of-message-service" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#conversationmessageserviceimpl-complete-implementation-of-message-service" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to ConversationMessageServiceImpl: Complete Implementation of Message Service">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            ConversationMessageServiceImpl: Complete Implementation of Message Service
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="package%20com.chat.allchatonthis.service.core.impl%3B%0Aimport%20com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper%3B%0Aimport%20com.baomidou.mybatisplus.extension.service.impl.ServiceImpl%3B%0Aimport%20com.chat.allchatonthis.common.exception.ServiceException%3B%0Aimport%20com.chat.allchatonthis.common.util.http.HttpUtils%3B%0Aimport%20com.chat.allchatonthis.common.util.json.JsonUtils%3B%0Aimport%20com.chat.allchatonthis.entity.dataobject.ConversationDO%3B%0Aimport%20com.chat.allchatonthis.entity.dataobject.ConversationMessageDO%3B%0Aimport%20com.chat.allchatonthis.entity.dataobject.UserConfigDO%3B%0Aimport%20com.chat.allchatonthis.mapper.ConversationMessageMapper%3B%0Aimport%20com.chat.allchatonthis.service.core.ConversationMessageService%3B%0Aimport%20com.chat.allchatonthis.service.core.ConversationService%3B%0Aimport%20com.chat.allchatonthis.service.core.UserConfigService%3B%0Aimport%20lombok.AllArgsConstructor%3B%0Aimport%20lombok.extern.slf4j.Slf4j%3B%0Aimport%20org.springframework.cache.annotation.CacheConfig%3B%0Aimport%20org.springframework.cache.annotation.CacheEvict%3B%0Aimport%20org.springframework.cache.annotation.Cacheable%3B%0Aimport%20org.springframework.cache.annotation.Caching%3B%0Aimport%20org.springframework.data.redis.core.RedisTemplate%3B%0Aimport%20org.springframework.stereotype.Service%3B%0Aimport%20org.springframework.transaction.annotation.Transactional%3B%0Aimport%20org.springframework.util.StringUtils%3B%0Aimport%20java.util.List%3B%0Aimport%20java.util.Map%3B%0Aimport%20static%20com.chat.allchatonthis.common.enums.ErrorCodeConstants.*%3B%0A%2F**%0A*%20Conversation%20Message%20Service%20Implementation%20Class%20-%20Core%20business%20logic%20for%20message%20processing%0A*%2F%0A%40Service%0A%40AllArgsConstructor%0A%40Slf4j%0A%40CacheConfig(cacheNames%20%3D%20%22conversation_message%22)%0Apublic%20class%20ConversationMessageServiceImpl%20extends%20ServiceImpl%0Aimplements%20ConversationMessageService%20%7B%0Aprivate%20final%20ConversationService%20conversationService%3B%0Aprivate%20final%20UserConfigService%20userConfigService%3B%0Aprivate%20final%20RedisTemplate%20redisTemplate%3B%0A%2F**%0A*%20Send%20message%20-%20Core%20business%20method%20of%20the%20system%0A*%0A*%20%40param%20userMessage%20User%20message%20content%0A*%20%40param%20configId%20Configuration%20ID%0A*%20%40param%20conversationId%20Conversation%20ID%0A*%20%40param%20userId%20User%20ID%0A*%20%40param%20secretKey%20Decryption%20key%0A*%20%40return%20Assistant%20reply%20message%0A*%2F%0A%40Override%0A%40Transactional%20%20%2F%2F%20Ensure%20transaction%20consistency%0A%40Caching(evict%20%3D%20%7B%0A%40CacheEvict(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0A%7D)%0Apublic%20ConversationMessageDO%20sendMessage(String%20userMessage%2C%20Long%20configId%2C%20Long%20conversationId%2C%0ALong%20userId%2C%20String%20secretKey)%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%201%3A%20Permission%20verification%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Verify%20conversation%20ownership%3A%20ensure%20users%20can%20only%20operate%20their%20own%20conversations%0AConversationDO%20conversation%20%3D%20conversationService.getConversation(conversationId%2C%20userId)%3B%0Aif%20(conversation%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(CONVERSATION_NOT_EXISTS.getCode()%2C%20CONVERSATION_NOT_EXISTS.getMsg())%3B%0A%7D%0A%2F%2F%20Verify%20configuration%20ownership%3A%20ensure%20users%20can%20only%20use%20their%20own%20configurations%0AUserConfigDO%20config%20%3D%20userConfigService.getConfig(configId%2C%20userId)%3B%0Aif%20(config%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(CONFIGURATION_NOT_EXISTS.getCode()%2C%20CONFIGURATION_NOT_EXISTS.getMsg())%3B%0A%7D%0A%2F%2F%20Set%20temporary%20decryption%20key%0Aif%20(StringUtils.hasText(secretKey))%20%7B%0Aconfig.setSecretKey(secretKey)%3B%0A%7D%0Atry%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%202%3A%20Prepare%20message%20objects%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Create%20user%20message%20object%20(Note%3A%20only%20create%20here%2C%20don't%20save%20to%20database%20yet)%0A%2F%2F%20This%20is%20a%20transactional%20design%3A%20ensure%20API%20call%20succeeds%20first%2C%20then%20save%20data%0AConversationMessageDO%20userMessageDO%20%3D%20new%20ConversationMessageDO()%0A.setConversationId(conversationId)%0A.setConfigId(configId)%0A.setRole(%22user%22)%0A.setContent(userMessage)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%203%3A%20Get%20conversation%20history%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Get%20all%20historical%20messages%20of%20current%20conversation%20for%20building%20context%0AList%20previousMessages%20%3D%20list(new%20LambdaQueryWrapper()%0A.eq(ConversationMessageDO%3A%3AgetConversationId%2C%20conversationId)%0A.orderByAsc(ConversationMessageDO%3A%3AgetCreateTime))%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%204%3A%20Call%20AI%20API%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Call%20AI%20API%20to%20get%20reply%20(this%20is%20the%20key%20step%2C%20may%20fail)%0AConversationMessageDO%20assistantMessageDO%20%3D%20generateAssistantResponse(%0AuserMessage%2C%20config%2C%20conversationId%2C%20configId%2C%20previousMessages%0A)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%205%3A%20Save%20messages%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Only%20execute%20here%20if%20API%20call%20succeeds%0A%2F%2F%20Batch%20save%20user%20message%20and%20assistant%20reply%2C%20ensure%20data%20consistency%0Asave(userMessageDO)%3B%0Asave(assistantMessageDO)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%206%3A%20Update%20conversation%20status%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Update%20conversation's%20last%20update%20time%0Aconversation.setUpdateTime(assistantMessageDO.getUpdateTime())%3B%0AconversationService.updateById(conversation)%3B%0A%2F%2F%20Mark%20configuration%20as%20available%20(health%20check)%0AmarkConfigurationAsAvailable(configId%2C%20userId)%3B%0Areturn%20assistantMessageDO%3B%0A%7D%20catch%20(Exception%20e)%20%7B%0Alog.error(%22Message%20sending%20failed%22%2C%20e)%3B%0A%2F%2F%20Unified%20exception%20handling%3A%20don't%20create%20error%20messages%2C%20throw%20exception%20directly%0Aif%20(e%20instanceof%20ServiceException)%20%7B%0Athrow%20e%3B%0A%7D%0Athrow%20new%20ServiceException(MESSAGE_SEND_FAILED.getCode()%2C%20e.getMessage())%3B%0A%7D%0A%7D%0A%2F**%0A*%20Generate%20assistant%20reply%20-%20Core%20logic%20for%20AI%20API%20calls%0A*%0A*%20%40param%20userMessage%20User%20message%0A*%20%40param%20config%20Configuration%20information%0A*%20%40param%20conversationId%20Conversation%20ID%0A*%20%40param%20configId%20Configuration%20ID%0A*%20%40param%20conversationMessages%20Conversation%20history%0A*%20%40return%20Assistant%20reply%20message%0A*%2F%0Aprivate%20ConversationMessageDO%20generateAssistantResponse(%0AString%20userMessage%2C%0AUserConfigDO%20config%2C%0ALong%20conversationId%2C%0ALong%20configId%2C%0AList%20conversationMessages)%20%7B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%201%3A%20Prepare%20request%20data%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Use%20HttpUtils%20to%20prepare%20complete%20request%20data%20(including%20conversation%20history)%0AMap%20requestData%20%3D%20HttpUtils.prepareRequestData(config%2C%20userMessage%2C%20conversationMessages)%3B%0A%2F%2F%20Extract%20request%20headers%20and%20request%20body%0AMap%20headers%20%3D%20(Map)%20requestData.get(%22headers%22)%3B%0AMap%20requestBody%20%3D%20(Map)%20requestData.get(%22requestBody%22)%3B%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%202%3A%20Send%20HTTP%20request%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Serialize%20request%20body%20to%20JSON%20string%0AString%20requestBodyStr%20%3D%20JsonUtils.toJsonString(requestBody)%3B%0A%2F%2F%20Send%20POST%20request%20to%20AI%20API%0AString%20responseStr%20%3D%20HttpUtils.post(config.getApiUrl()%2C%20headers%2C%20requestBodyStr)%3B%0A%2F%2F%20Check%20if%20response%20is%20empty%0Aif%20(responseStr%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(API_CALL_FAILED.getCode()%2C%20%22API%20returned%20empty%20response%22)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%203%3A%20Parse%20response%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Parse%20response%20JSON%0AMap%20responseMap%20%3D%20JsonUtils.parseObject(responseStr%2C%20Map.class)%3B%0A%2F%2F%20Extract%20AI%20reply%20content%0AString%20content%20%3D%20null%3B%0AString%20thinking%20%3D%20null%3B%0A%2F%2F%20Extract%20reply%20content%20according%20to%20configured%20path%0Aif%20(StringUtils.hasText(config.getResponseTextPath()))%20%7B%0Acontent%20%3D%20JsonUtils.extractValueFromPath(responseMap%2C%20config.getResponseTextPath())%3B%0A%7D%0A%2F%2F%20Extract%20thinking%20process%20according%20to%20configured%20path%20(if%20supported)%0Aif%20(StringUtils.hasText(config.getResponseThinkingTextPath()))%20%7B%0Athinking%20%3D%20JsonUtils.extractValueFromPath(responseMap%2C%20config.getResponseThinkingTextPath())%3B%0A%7D%0A%2F%2F%20Verify%20if%20content%20was%20successfully%20extracted%0Aif%20(content%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(API_CALL_FAILED.getCode()%2C%20%22Unable%20to%20extract%20content%20from%20response%22)%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Step%204%3A%20Build%20reply%20message%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Create%20assistant%20reply%20message%20object%0Areturn%20new%20ConversationMessageDO()%0A.setConversationId(conversationId)%0A.setConfigId(configId)%0A.setRole(%22assistant%22)%0A.setContent(content)%0A.setThinkingText(thinking)%3B%20%20%2F%2F%20Thinking%20process%20(optional)%0A%7D%0A%2F**%0A*%20Mark%20configuration%20as%20available%20-%20Health%20check%20and%20monitoring%0A*%0A*%20%40param%20configId%20Configuration%20ID%0A*%20%40param%20userId%20User%20ID%0A*%20%40return%20Whether%20successful%0A*%2F%0A%40Override%0Apublic%20boolean%20markConfigurationAsAvailable(Long%20configId%2C%20Long%20userId)%20%7B%0A%2F%2F%20Get%20configuration%20information%0AUserConfigDO%20config%20%3D%20userConfigService.getConfig(configId%2C%20userId)%3B%0Aif%20(config%20%3D%3D%20null)%20%7B%0Areturn%20false%3B%0A%7D%0A%2F%2F%20Update%20configuration%20status%3A%20set%20as%20available%20and%20record%20last%20usage%20time%0AuserConfigService.setAvailableAndUpdateLastUsedTime(configId%2C%20true)%3B%0Areturn%20true%3B%0A%7D%0A%2F**%0A*%20Get%20conversation%20message%20list%20-%20With%20caching%0A*%0A*%20%40param%20conversationId%20Conversation%20ID%0A*%20%40param%20userId%20User%20ID%0A*%20%40return%20Message%20list%0A*%2F%0A%40Override%0A%40Cacheable(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20List%20getMessages(Long%20conversationId%2C%20Long%20userId)%20%7B%0A%2F%2F%20Verify%20conversation%20ownership%0AConversationDO%20conversation%20%3D%20conversationService.getConversation(conversationId%2C%20userId)%3B%0Aif%20(conversation%20%3D%3D%20null)%20%7B%0Athrow%20new%20ServiceException(CONVERSATION_NOT_EXISTS.getCode()%2C%20CONVERSATION_NOT_EXISTS.getMsg())%3B%0A%7D%0A%2F%2F%20Query%20messages%2C%20ordered%20by%20creation%20time%20ascending%0Areturn%20list(new%20LambdaQueryWrapper()%0A.eq(ConversationMessageDO%3A%3AgetConversationId%2C%20conversationId)%0A.orderByAsc(ConversationMessageDO%3A%3AgetCreateTime)%0A.orderByAsc(ConversationMessageDO%3A%3AgetId)%0A)%3B%0A%7D%0A%2F**%0A*%20Get%20single%20message%20-%20With%20caching%0A*%0A*%20%40param%20id%20Message%20ID%0A*%20%40param%20userId%20User%20ID%0A*%20%40return%20Message%20object%0A*%2F%0A%40Override%0A%40Cacheable(key%20%3D%20%22'id%3A'%20%2B%20%23id%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20ConversationMessageDO%20getMessage(Long%20id%2C%20Long%20userId)%20%7B%0AConversationMessageDO%20message%20%3D%20getById(id)%3B%0Aif%20(message%20%3D%3D%20null)%20%7B%0Areturn%20null%3B%0A%7D%0A%2F%2F%20Verify%20conversation%20ownership%0AConversationDO%20conversation%20%3D%20conversationService.getConversation(message.getConversationId()%2C%20userId)%3B%0Aif%20(conversation%20%3D%3D%20null)%20%7B%0Areturn%20null%3B%0A%7D%0Areturn%20message%3B%0A%7D%0A%2F**%0A*%20Delete%20message%20-%20Clear%20cache%0A*%0A*%20%40param%20id%20Message%20ID%0A*%20%40param%20userId%20User%20ID%0A*%20%40return%20Whether%20successful%0A*%2F%0A%40Override%0A%40Transactional%0A%40CacheEvict(key%20%3D%20%22'id%3A'%20%2B%20%23id%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20boolean%20deleteMessage(Long%20id%2C%20Long%20userId)%20%7B%0AConversationMessageDO%20message%20%3D%20getMessage(id%2C%20userId)%3B%0Aif%20(message%20%3D%3D%20null)%20%7B%0Areturn%20false%3B%0A%7D%0A%2F%2F%20Manually%20clear%20related%20cache%0ALong%20conversationId%20%3D%20message.getConversationId()%3B%0AString%20cacheKey%20%3D%20%22acot_conversation_message%3A%3Aconversation%3A%22%20%2B%20conversationId%20%2B%20%22%3Auser%3A%22%20%2B%20userId%3B%0AredisTemplate.delete(cacheKey)%3B%0Areturn%20removeById(id)%3B%0A%7D%0A%2F**%0A*%20Delete%20all%20messages%20of%20conversation%20-%20Batch%20delete%0A*%0A*%20%40param%20conversationId%20Conversation%20ID%0A*%20%40param%20userId%20User%20ID%0A*%20%40return%20Whether%20successful%0A*%2F%0A%40Override%0A%40Transactional%0A%40CacheEvict(key%20%3D%20%22'conversation%3A'%20%2B%20%23conversationId%20%2B%20'%3Auser%3A'%20%2B%20%23userId%22)%0Apublic%20boolean%20deleteMessagesByConversationId(Long%20conversationId%2C%20Long%20userId)%20%7B%0A%2F%2F%20Verify%20conversation%20ownership%0AConversationDO%20conversation%20%3D%20conversationService.getConversation(conversationId%2C%20userId)%3B%0Aif%20(conversation%20%3D%3D%20null)%20%7B%0Areturn%20false%3B%0A%7D%0A%2F%2F%20Batch%20delete%20messages%0Areturn%20remove(new%20LambdaQueryWrapper()%0A.eq(ConversationMessageDO%3A%3AgetConversationId%2C%20conversationId))%3B%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-keyword inline">package</span> com.chat.allchatonthis.service.core.impl;

<span class="hljs-keyword inline">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
<span class="hljs-keyword inline">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.common.exception.ServiceException;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.common.util.http.HttpUtils;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.common.util.json.JsonUtils;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.entity.dataobject.ConversationDO;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.entity.dataobject.ConversationMessageDO;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.entity.dataobject.UserConfigDO;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.mapper.ConversationMessageMapper;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.service.core.ConversationMessageService;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.service.core.ConversationService;
<span class="hljs-keyword inline">import</span> com.chat.allchatonthis.service.core.UserConfigService;
<span class="hljs-keyword inline">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword inline">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword inline">import</span> org.springframework.cache.annotation.CacheConfig;
<span class="hljs-keyword inline">import</span> org.springframework.cache.annotation.CacheEvict;
<span class="hljs-keyword inline">import</span> org.springframework.cache.annotation.Cacheable;
<span class="hljs-keyword inline">import</span> org.springframework.cache.annotation.Caching;
<span class="hljs-keyword inline">import</span> org.springframework.data.redis.core.RedisTemplate;
<span class="hljs-keyword inline">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword inline">import</span> org.springframework.transaction.annotation.Transactional;
<span class="hljs-keyword inline">import</span> org.springframework.util.StringUtils;

<span class="hljs-keyword inline">import</span> java.util.List;
<span class="hljs-keyword inline">import</span> java.util.Map;

<span class="hljs-keyword inline">import</span> <span class="hljs-keyword inline">static</span> com.chat.allchatonthis.common.enums.ErrorCodeConstants.*;

<span class="hljs-comment inline">/**
 * Conversation Message Service Implementation Class - Core business logic for message processing
 */</span>
<span class="hljs-meta inline">@Service</span>
<span class="hljs-meta inline">@AllArgsConstructor</span>
<span class="hljs-meta inline">@Slf4j</span>
<span class="hljs-meta inline">@CacheConfig(cacheNames = &quot;conversation_message&quot;)</span>
<span class="hljs-keyword inline">public</span> <span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">ConversationMessageServiceImpl</span> <span class="hljs-keyword inline">extends</span> <span class="hljs-title class_ inline">ServiceImpl</span>&lt;ConversationMessageMapper, ConversationMessageDO&gt; 
        <span class="hljs-keyword inline">implements</span> <span class="hljs-title class_ inline">ConversationMessageService</span> {

    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> ConversationService conversationService;
    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> UserConfigService userConfigService;
    <span class="hljs-keyword inline">private</span> <span class="hljs-keyword inline">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-comment inline">/**
     * Send message - Core business method of the system
     * 
     * <span class="hljs-doctag inline">@param</span> userMessage User message content
     * <span class="hljs-doctag inline">@param</span> configId Configuration ID
     * <span class="hljs-doctag inline">@param</span> conversationId Conversation ID
     * <span class="hljs-doctag inline">@param</span> userId User ID
     * <span class="hljs-doctag inline">@param</span> secretKey Decryption key
     * <span class="hljs-doctag inline">@return</span> Assistant reply message
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-meta inline">@Transactional</span>  <span class="hljs-comment inline">// Ensure transaction consistency</span>
    <span class="hljs-meta inline">@Caching(evict = {
            @CacheEvict(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)
    })</span>
    <span class="hljs-keyword inline">public</span> ConversationMessageDO <span class="hljs-title function_ inline">sendMessage</span><span class="hljs-params inline">(String userMessage, Long configId, Long conversationId, 
                                           Long userId, String secretKey)</span> {
        <span class="hljs-comment inline">// ==================== Step 1: Permission verification ====================</span>
        
        <span class="hljs-comment inline">// Verify conversation ownership: ensure users can only operate their own conversations</span>
        <span class="hljs-type inline">ConversationDO</span> <span class="hljs-variable inline">conversation</span> <span class="hljs-operator inline">=</span> conversationService.getConversation(conversationId, userId);
        <span class="hljs-keyword inline">if</span> (conversation == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONVERSATION_NOT_EXISTS.getCode(), CONVERSATION_NOT_EXISTS.getMsg());
        }

        <span class="hljs-comment inline">// Verify configuration ownership: ensure users can only use their own configurations</span>
        <span class="hljs-type inline">UserConfigDO</span> <span class="hljs-variable inline">config</span> <span class="hljs-operator inline">=</span> userConfigService.getConfig(configId, userId);
        <span class="hljs-keyword inline">if</span> (config == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONFIGURATION_NOT_EXISTS.getCode(), CONFIGURATION_NOT_EXISTS.getMsg());
        }

        <span class="hljs-comment inline">// Set temporary decryption key</span>
        <span class="hljs-keyword inline">if</span> (StringUtils.hasText(secretKey)) {
            config.setSecretKey(secretKey);
        }

        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-comment inline">// ==================== Step 2: Prepare message objects ====================</span>
            
            <span class="hljs-comment inline">// Create user message object (Note: only create here, don&#x27;t save to database yet)</span>
            <span class="hljs-comment inline">// This is a transactional design: ensure API call succeeds first, then save data</span>
            <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">userMessageDO</span> <span class="hljs-operator inline">=</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ConversationMessageDO</span>()
                    .setConversationId(conversationId)
                    .setConfigId(configId)
                    .setRole(<span class="hljs-string inline">&quot;user&quot;</span>)
                    .setContent(userMessage);

            <span class="hljs-comment inline">// ==================== Step 3: Get conversation history ====================</span>
            
            <span class="hljs-comment inline">// Get all historical messages of current conversation for building context</span>
            List&lt;ConversationMessageDO&gt; previousMessages = list(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">LambdaQueryWrapper</span>&lt;ConversationMessageDO&gt;()
                    .eq(ConversationMessageDO::getConversationId, conversationId)
                    .orderByAsc(ConversationMessageDO::getCreateTime));

            <span class="hljs-comment inline">// ==================== Step 4: Call AI API ====================</span>
            
            <span class="hljs-comment inline">// Call AI API to get reply (this is the key step, may fail)</span>
            <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">assistantMessageDO</span> <span class="hljs-operator inline">=</span> generateAssistantResponse(
                userMessage, config, conversationId, configId, previousMessages
            );

            <span class="hljs-comment inline">// ==================== Step 5: Save messages ====================</span>
            
            <span class="hljs-comment inline">// Only execute here if API call succeeds</span>
            <span class="hljs-comment inline">// Batch save user message and assistant reply, ensure data consistency</span>
            save(userMessageDO);
            save(assistantMessageDO);

            <span class="hljs-comment inline">// ==================== Step 6: Update conversation status ====================</span>
            
            <span class="hljs-comment inline">// Update conversation&#x27;s last update time</span>
            conversation.setUpdateTime(assistantMessageDO.getUpdateTime());
            conversationService.updateById(conversation);

            <span class="hljs-comment inline">// Mark configuration as available (health check)</span>
            markConfigurationAsAvailable(configId, userId);

            <span class="hljs-keyword inline">return</span> assistantMessageDO;
            
        } <span class="hljs-keyword inline">catch</span> (Exception e) {
            log.error(<span class="hljs-string inline">&quot;Message sending failed&quot;</span>, e);

            <span class="hljs-comment inline">// Unified exception handling: don&#x27;t create error messages, throw exception directly</span>
            <span class="hljs-keyword inline">if</span> (e <span class="hljs-keyword inline">instanceof</span> ServiceException) {
                <span class="hljs-keyword inline">throw</span> e;
            }
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(MESSAGE_SEND_FAILED.getCode(), e.getMessage());
        }
    }

    <span class="hljs-comment inline">/**
     * Generate assistant reply - Core logic for AI API calls
     * 
     * <span class="hljs-doctag inline">@param</span> userMessage User message
     * <span class="hljs-doctag inline">@param</span> config Configuration information
     * <span class="hljs-doctag inline">@param</span> conversationId Conversation ID
     * <span class="hljs-doctag inline">@param</span> configId Configuration ID
     * <span class="hljs-doctag inline">@param</span> conversationMessages Conversation history
     * <span class="hljs-doctag inline">@return</span> Assistant reply message
     */</span>
    <span class="hljs-keyword inline">private</span> ConversationMessageDO <span class="hljs-title function_ inline">generateAssistantResponse</span><span class="hljs-params inline">(
            String userMessage,
            UserConfigDO config,
            Long conversationId,
            Long configId,
            List&lt;ConversationMessageDO&gt; conversationMessages)</span> {

        <span class="hljs-comment inline">// ==================== Step 1: Prepare request data ====================</span>
        
        <span class="hljs-comment inline">// Use HttpUtils to prepare complete request data (including conversation history)</span>
        Map&lt;String, Object&gt; requestData = HttpUtils.prepareRequestData(config, userMessage, conversationMessages);
        
        <span class="hljs-comment inline">// Extract request headers and request body</span>
        Map&lt;String, String&gt; headers = (Map&lt;String, String&gt;) requestData.get(<span class="hljs-string inline">&quot;headers&quot;</span>);
        Map&lt;String, Object&gt; requestBody = (Map&lt;String, Object&gt;) requestData.get(<span class="hljs-string inline">&quot;requestBody&quot;</span>);

        <span class="hljs-comment inline">// ==================== Step 2: Send HTTP request ====================</span>
        
        <span class="hljs-comment inline">// Serialize request body to JSON string</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">requestBodyStr</span> <span class="hljs-operator inline">=</span> JsonUtils.toJsonString(requestBody);
        
        <span class="hljs-comment inline">// Send POST request to AI API</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">responseStr</span> <span class="hljs-operator inline">=</span> HttpUtils.post(config.getApiUrl(), headers, requestBodyStr);

        <span class="hljs-comment inline">// Check if response is empty</span>
        <span class="hljs-keyword inline">if</span> (responseStr == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(API_CALL_FAILED.getCode(), <span class="hljs-string inline">&quot;API returned empty response&quot;</span>);
        }

        <span class="hljs-comment inline">// ==================== Step 3: Parse response ====================</span>
        
        <span class="hljs-comment inline">// Parse response JSON</span>
        Map&lt;String, Object&gt; responseMap = JsonUtils.parseObject(responseStr, Map.class);

        <span class="hljs-comment inline">// Extract AI reply content</span>
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">content</span> <span class="hljs-operator inline">=</span> <span class="hljs-literal inline">null</span>;
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">thinking</span> <span class="hljs-operator inline">=</span> <span class="hljs-literal inline">null</span>;

        <span class="hljs-comment inline">// Extract reply content according to configured path</span>
        <span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getResponseTextPath())) {
            content = JsonUtils.extractValueFromPath(responseMap, config.getResponseTextPath());
        }

        <span class="hljs-comment inline">// Extract thinking process according to configured path (if supported)</span>
        <span class="hljs-keyword inline">if</span> (StringUtils.hasText(config.getResponseThinkingTextPath())) {
            thinking = JsonUtils.extractValueFromPath(responseMap, config.getResponseThinkingTextPath());
        }

        <span class="hljs-comment inline">// Verify if content was successfully extracted</span>
        <span class="hljs-keyword inline">if</span> (content == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(API_CALL_FAILED.getCode(), <span class="hljs-string inline">&quot;Unable to extract content from response&quot;</span>);
        }

        <span class="hljs-comment inline">// ==================== Step 4: Build reply message ====================</span>
        
        <span class="hljs-comment inline">// Create assistant reply message object</span>
        <span class="hljs-keyword inline">return</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ConversationMessageDO</span>()
                .setConversationId(conversationId)
                .setConfigId(configId)
                .setRole(<span class="hljs-string inline">&quot;assistant&quot;</span>)
                .setContent(content)
                .setThinkingText(thinking);  <span class="hljs-comment inline">// Thinking process (optional)</span>
    }

    <span class="hljs-comment inline">/**
     * Mark configuration as available - Health check and monitoring
     * 
     * <span class="hljs-doctag inline">@param</span> configId Configuration ID
     * <span class="hljs-doctag inline">@param</span> userId User ID
     * <span class="hljs-doctag inline">@return</span> Whether successful
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">markConfigurationAsAvailable</span><span class="hljs-params inline">(Long configId, Long userId)</span> {
        <span class="hljs-comment inline">// Get configuration information</span>
        <span class="hljs-type inline">UserConfigDO</span> <span class="hljs-variable inline">config</span> <span class="hljs-operator inline">=</span> userConfigService.getConfig(configId, userId);
        <span class="hljs-keyword inline">if</span> (config == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">false</span>;
        }

        <span class="hljs-comment inline">// Update configuration status: set as available and record last usage time</span>
        userConfigService.setAvailableAndUpdateLastUsedTime(configId, <span class="hljs-literal inline">true</span>);

        <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">true</span>;
    }

    <span class="hljs-comment inline">/**
     * Get conversation message list - With caching
     * 
     * <span class="hljs-doctag inline">@param</span> conversationId Conversation ID
     * <span class="hljs-doctag inline">@param</span> userId User ID
     * <span class="hljs-doctag inline">@return</span> Message list
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-meta inline">@Cacheable(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)</span>
    <span class="hljs-keyword inline">public</span> List&lt;ConversationMessageDO&gt; <span class="hljs-title function_ inline">getMessages</span><span class="hljs-params inline">(Long conversationId, Long userId)</span> {
        <span class="hljs-comment inline">// Verify conversation ownership</span>
        <span class="hljs-type inline">ConversationDO</span> <span class="hljs-variable inline">conversation</span> <span class="hljs-operator inline">=</span> conversationService.getConversation(conversationId, userId);
        <span class="hljs-keyword inline">if</span> (conversation == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">ServiceException</span>(CONVERSATION_NOT_EXISTS.getCode(), CONVERSATION_NOT_EXISTS.getMsg());
        }

        <span class="hljs-comment inline">// Query messages, ordered by creation time ascending</span>
        <span class="hljs-keyword inline">return</span> list(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">LambdaQueryWrapper</span>&lt;ConversationMessageDO&gt;()
                .eq(ConversationMessageDO::getConversationId, conversationId)
                .orderByAsc(ConversationMessageDO::getCreateTime)
                .orderByAsc(ConversationMessageDO::getId)
        );
    }

    <span class="hljs-comment inline">/**
     * Get single message - With caching
     * 
     * <span class="hljs-doctag inline">@param</span> id Message ID
     * <span class="hljs-doctag inline">@param</span> userId User ID
     * <span class="hljs-doctag inline">@return</span> Message object
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-meta inline">@Cacheable(key = &quot;&#x27;id:&#x27; + #id + &#x27;:user:&#x27; + #userId&quot;)</span>
    <span class="hljs-keyword inline">public</span> ConversationMessageDO <span class="hljs-title function_ inline">getMessage</span><span class="hljs-params inline">(Long id, Long userId)</span> {
        <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">message</span> <span class="hljs-operator inline">=</span> getById(id);
        <span class="hljs-keyword inline">if</span> (message == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }

        <span class="hljs-comment inline">// Verify conversation ownership</span>
        <span class="hljs-type inline">ConversationDO</span> <span class="hljs-variable inline">conversation</span> <span class="hljs-operator inline">=</span> conversationService.getConversation(message.getConversationId(), userId);
        <span class="hljs-keyword inline">if</span> (conversation == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>;
        }

        <span class="hljs-keyword inline">return</span> message;
    }

    <span class="hljs-comment inline">/**
     * Delete message - Clear cache
     * 
     * <span class="hljs-doctag inline">@param</span> id Message ID
     * <span class="hljs-doctag inline">@param</span> userId User ID
     * <span class="hljs-doctag inline">@return</span> Whether successful
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-meta inline">@Transactional</span>
    <span class="hljs-meta inline">@CacheEvict(key = &quot;&#x27;id:&#x27; + #id + &#x27;:user:&#x27; + #userId&quot;)</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">deleteMessage</span><span class="hljs-params inline">(Long id, Long userId)</span> {
        <span class="hljs-type inline">ConversationMessageDO</span> <span class="hljs-variable inline">message</span> <span class="hljs-operator inline">=</span> getMessage(id, userId);
        <span class="hljs-keyword inline">if</span> (message == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">false</span>;
        }

        <span class="hljs-comment inline">// Manually clear related cache</span>
        <span class="hljs-type inline">Long</span> <span class="hljs-variable inline">conversationId</span> <span class="hljs-operator inline">=</span> message.getConversationId();
        <span class="hljs-type inline">String</span> <span class="hljs-variable inline">cacheKey</span> <span class="hljs-operator inline">=</span> <span class="hljs-string inline">&quot;acot_conversation_message::conversation:&quot;</span> + conversationId + <span class="hljs-string inline">&quot;:user:&quot;</span> + userId;
        redisTemplate.delete(cacheKey);

        <span class="hljs-keyword inline">return</span> removeById(id);
    }

    <span class="hljs-comment inline">/**
     * Delete all messages of conversation - Batch delete
     * 
     * <span class="hljs-doctag inline">@param</span> conversationId Conversation ID
     * <span class="hljs-doctag inline">@param</span> userId User ID
     * <span class="hljs-doctag inline">@return</span> Whether successful
     */</span>
    <span class="hljs-meta inline">@Override</span>
    <span class="hljs-meta inline">@Transactional</span>
    <span class="hljs-meta inline">@CacheEvict(key = &quot;&#x27;conversation:&#x27; + #conversationId + &#x27;:user:&#x27; + #userId&quot;)</span>
    <span class="hljs-keyword inline">public</span> <span class="hljs-type inline">boolean</span> <span class="hljs-title function_ inline">deleteMessagesByConversationId</span><span class="hljs-params inline">(Long conversationId, Long userId)</span> {
        <span class="hljs-comment inline">// Verify conversation ownership</span>
        <span class="hljs-type inline">ConversationDO</span> <span class="hljs-variable inline">conversation</span> <span class="hljs-operator inline">=</span> conversationService.getConversation(conversationId, userId);
        <span class="hljs-keyword inline">if</span> (conversation == <span class="hljs-literal inline">null</span>) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">false</span>;
        }

        <span class="hljs-comment inline">// Batch delete messages</span>
        <span class="hljs-keyword inline">return</span> remove(<span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">LambdaQueryWrapper</span>&lt;ConversationMessageDO&gt;()
                .eq(ConversationMessageDO::getConversationId, conversationId));
    }
}
</code></pre>
            </div>
        
<h2 id="final-words" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#final-words" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Final Words">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Final Words
        </h2>
<p class="text-base leading-7 mb-4 text-foreground">Message construction, extraction, and transmission are the most complex aspects of the ACOT project, while also being its core functionality. Through this platform, users can theoretically connect to any available large model API (or even APIs that aren’t large models). By saving user-defined configuration files on the platform, this platform can become users’ custom large model connector.</p>
<p class="text-base leading-7 mb-4 text-foreground">Well, now it’s time for my favorite wishing session! 💫</p>
<p class="text-base leading-7 mb-4 text-foreground"><em class="italic text-foreground">May the structures of various APIs converge like streams, and the broad river embrace forms from all corners of the world. May the algorithms that accommodate all things enable everything hidden to be discovered by people.</em> ✨</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="java" data-code="%2F%2F%20Wish%20(Code%20Version)%0Awhile%20(bugs.exist())%20%7B%0Adebug()%3B%0Aif%20(fixed)%20%7B%0Acelebrate()%3B%20%F0%9F%8E%89%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">java</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-java"><span class="hljs-comment inline">// Wish (Code Version)</span>
<span class="hljs-keyword inline">while</span> (bugs.exist()) {
    debug();
    <span class="hljs-keyword inline">if</span> (fixed) {
        celebrate(); 🎉
    }
}
</code></pre>
            </div>
        
d:["$","$L1d",null,{"htmlContent":"$1e","frontMatter":{"title":"All-Chat-on-This Configuration Parsing Implementation: Complete Data Flow from Configuration to Messages","description":"Deep analysis of UserConfigDO class design, prepareRequestData data processing logic, and complete implementation principles of sendMessage message generation and transmission","date":"2025-01-15","author":"MilkWind","tags":["Spring Boot","API Configuration","JSON Parsing"],"references":{}},"readingTime":"42 min read","category":"all-chat-on-this","tocItems":[{"id":"all-chat-on-this-configuration-parsing-implementation-complete-data-flow-from-configuration-to-messages","text":"All-Chat-on-This Configuration Parsing Implementation: Complete Data Flow from Configuration to Messages","level":1},{"id":"configuration-class-design-userconfigdo’s-flexible-architecture","text":"Configuration Class Design: UserConfigDO’s Flexible Architecture","level":2},{"id":"flexible-api-key-placement-strategy","text":"Flexible API Key Placement Strategy","level":3},{"id":"json-template-design-unified-processing","text":"JSON Template Design: Unified Processing","level":3},{"id":"message-path-configuration-design-supporting-complex-nested-structures","text":"Message Path Configuration Design: Supporting Complex Nested Structures","level":3},{"id":"complete-userconfigdo-structure-diagram","text":"Complete UserConfigDO Structure Diagram","level":3},{"id":"data-parsing-logic-the-dual-performance-of-preparerequestdata","text":"Data Parsing Logic: The Dual Performance of prepareRequestData","level":2},{"id":"test-version-basic-logic-for-single-message-processing","text":"Test Version: Basic Logic for Single Message Processing","level":3},{"id":"triple-dispatch-for-api-key-placement","text":"Triple Dispatch for API Key Placement","level":3},{"id":"production-version-conversation-history-processing","text":"Production Version: Conversation History Processing","level":3},{"id":"message-generation-and-transmission-logic-complete-business-process-of-sendmessage","text":"Message Generation and Transmission Logic: Complete Business Process of sendMessage","level":2},{"id":"permission-verification","text":"Permission Verification","level":3},{"id":"message-creation-strategy-create-first-save-later","text":"Message Creation Strategy: Create First, Save Later","level":3},{"id":"generateassistantresponse-core-engine-for-http-calls","text":"generateAssistantResponse: Core Engine for HTTP Calls","level":3},{"id":"transaction-management-and-caching-strategy","text":"Transaction Management and Caching Strategy","level":3},{"id":"configuration-monitoring-markconfigurationasavailable","text":"Configuration Monitoring: markConfigurationAsAvailable","level":3},{"id":"json-path-parsing-engine-deep-algorithm-analysis-of-jsonutils","text":"JSON Path Parsing Engine: Deep Algorithm Analysis of JsonUtils","level":2},{"id":"mathematical-model-of-path-parsing","text":"Mathematical Model of Path Parsing","level":3},{"id":"extractvaluefrompath-core-algorithm-for-path-extraction","text":"extractValueFromPath: Core Algorithm for Path Extraction","level":3},{"id":"setvaluebypath-intelligent-construction-for-path-setting","text":"setValueByPath: Intelligent Construction for Path Setting","level":3},{"id":"practical-application-scenarios-of-path-parsing","text":"Practical Application Scenarios of Path Parsing","level":3},{"id":"defensive-design-for-edge-case-handling","text":"Defensive Design for Edge Case Handling","level":3},{"id":"complete-method-architecture-diagram-of-jsonutils","text":"Complete Method Architecture Diagram of JsonUtils","level":3},{"id":"complete-system-architecture-diagram","text":"Complete System Architecture Diagram","level":2},{"id":"performance-optimization","text":"Performance Optimization","level":2},{"id":"hierarchical-cache-strategy-design","text":"Hierarchical Cache Strategy Design","level":3},{"id":"exception-handling","text":"Exception Handling","level":3},{"id":"complete-code-analysis","text":"Complete Code Analysis","level":2},{"id":"jsonutils-complete-implementation-of-json-parsing-utility-class","text":"JsonUtils: Complete Implementation of JSON Parsing Utility Class","level":3},{"id":"userconfigdo：配置类的完整实现","text":"UserConfigDO：配置类的完整实现","level":3},{"id":"httputils-complete-implementation-of-http-request-processing","text":"HttpUtils: Complete Implementation of HTTP Request Processing","level":3},{"id":"conversationmessageserviceimpl-complete-implementation-of-message-service","text":"ConversationMessageServiceImpl: Complete Implementation of Message Service","level":3},{"id":"final-words","text":"Final Words","level":2}],"translations":{"common":{"welcome":"Welcome","loading":"Loading...","error":"Something went wrong","retry":"Try again","theme":"Theme","language":"Language","light":"Light","dark":"Dark"},"navigation":{"home":"Home","personal":"Personal","works":"Works","contributions":"Contributions","documents":"Documents","about":"About","contact":"Contact"},"personal":{"technicalSkills":"Technical Skills","email":"Email","github":"GitHub","resume":"Resume","codeRepository":"Code Repository","loadingPersonalInfo":"Loading personal information...","loadingResume":"Loading resume...","closeResume":"Close Resume","emailCopied":"Email copied to clipboard!","galaxyDefaultDescription":"Expert in full-stack development, cross-platform architecture, AI technology integration, and high-performance system optimization","skillGalaxy":"Skill Galaxy","stirGalaxy":"Stir Galaxy","stirring":"Stirring...","fullStackEngineer":"MilkWind - Full Stack Engineer","professionalProfile":"About Me"},"documents":{"technicalDocuments":"Technical Documents","description":"Basic principles, code splitting, and some random thoughts.","articles":"Articles","categories":"Categories","allCategories":"All Categories","noArticlesFound":"No articles found","noArticlesAvailable":"No articles available in English.","noArticlesInCategory":"No articles found in the category.","readMore":"Read more","loadingDocuments":"Loading documents...","backToDocuments":"← Back to Documents","documentNotFound":"Document Not Found","documentNotFoundDescription":"The requested document could not be found.","technicalInsights":"Insights","untitledDocument":"Untitled Document","byAuthor":"By","search":"Search articles...","searchByTags":"Filter by tags","searching":"Searching...","noSearchResults":"No articles match your search criteria","clearSearch":"Clear search","selectedTags":"Selected tags","allTags":"All tags","searchInTitle":"Search in titles, descriptions, and content","enterImmersiveMode":"Immersive Reading","exitImmersiveMode":"Exit Immersive Mode","immersiveReading":"Immersive Reading Mode","exploreContent":"Explore content by category","browseBy":"Browse by","exploreAll":"All content in one place","categoryDescription":"Articles in this category","totalArticles":"Articles","totalCategories":"Categories","foundArticles":"Found articles","categoriesWithResults":"Categories with results"},"works":{"workCases":"Work Cases","projects":"Portfolio","loadingProjects":"Loading projects...","grid":"Grid","stack":"Stack","of":"of","workCasesPageTitle":"Work Cases Page","pageWorkingCorrectly":"This page is working! The routing is correct.","try3DVersion":"Try 3D Version","dragToScroll":"Drag to scroll","dragToChange":"Drag to change","swipeCards":"Swipe cards","keyboardNav":"Keyboard navigation"},"contributions":{"contributionCases":"Open Source","contributions":"Contributions","loadingContributions":"Loading contributions...","grid":"Grid","stack":"Stack","of":"of","contributionCasesPageTitle":"Contribution Cases Page","pageWorkingCorrectly":"This page is working! The routing is correct.","try3DVersion":"Try 3D Version","dragToScroll":"Drag to scroll","dragToChange":"Drag to change","swipeCards":"Swipe cards","keyboardNav":"Keyboard navigation"},"contribution":{"contributionPreview":"Contribution Preview","accessible":"Accessible","code":"Code","maintenance":"Maintenance","enhancement":"Enhancement","documentation":"Documentation","community":"Community","moreItems":"more","technicalDetails":"Technical Details","technologies":"Technologies:","contributionDetail":"Contribution Detail","description":"Description:","seeDetails":"See Details","github":"GitHub","viewContribution":"View Contribution","viewCode":"View Code"},"project":{"projectPreview":"Project Preview","accessible":"Accessible","tool":"Tool","plugin":"Plugin","toy":"Toy","moreItems":"more","technicalDetails":"Technical Details","technologies":"Technologies:","description":"Description:","seeDetails":"See Details","github":"GitHub","gitee":"Gitee","viewLiveDemo":"View Live Demo","viewCode":"View Code","access":"Access","videos":"Videos","watchVideo":"Watch Video","hasVideo":"Has Video"},"codeblock":{"copy":"Copy","copySuccess":"Code copied to clipboard!","copyError":"Failed to copy code","copyTooltip":"Copy code"},"toc":{"contents":"Contents","autoScroll":"Auto-scroll to section","collapse":"Collapse","expand":"Expand"},"loading":{"loading":"LOADING","preparingExperience":"Preparing experience"}},"lang":"en","theme":"dark"}]
12:null
18:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
11:null
1c:{"metadata":[["$","title","0",{"children":"All-Chat-on-This Configuration Parsing Implementation: Complete Data Flow from Configuration to Messages | Interactive Portfolio"}],["$","meta","1",{"name":"description","content":"Deep analysis of UserConfigDO class design, prepareRequestData data processing logic, and complete implementation principles of sendMessage message generation and transmission"}],["$","meta","2",{"name":"author","content":"Developer"}],["$","meta","3",{"name":"keywords","content":"portfolio,3D,interactive,web development,Three.js,Next.js"}],["$","meta","4",{"property":"og:title","content":"All-Chat-on-This Configuration Parsing Implementation: Complete Data Flow from Configuration to Messages | Interactive Portfolio"}],["$","meta","5",{"property":"og:description","content":"Deep analysis of UserConfigDO class design, prepareRequestData data processing logic, and complete implementation principles of sendMessage message generation and transmission"}],["$","meta","6",{"property":"og:type","content":"article"}],["$","meta","7",{"property":"article:published_time","content":"2025-01-15"}],["$","meta","8",{"property":"article:tag","content":"Spring Boot"}],["$","meta","9",{"property":"article:tag","content":"API Configuration"}],["$","meta","10",{"property":"article:tag","content":"JSON Parsing"}],["$","meta","11",{"name":"twitter:card","content":"summary_large_image"}],["$","meta","12",{"name":"twitter:title","content":"All-Chat-on-This Configuration Parsing Implementation: Complete Data Flow from Configuration to Messages | Interactive Portfolio"}],["$","meta","13",{"name":"twitter:description","content":"Deep analysis of UserConfigDO class design, prepareRequestData data processing logic, and complete implementation principles of sendMessage message generation and transmission"}],["$","link","14",{"rel":"icon","href":"/MilkWind-Website/favicon.ico","type":"image/x-icon","sizes":"32x32"}]],"error":null,"digest":"$undefined"}
14:{"metadata":"$1c:metadata","error":null,"digest":"$undefined"}
