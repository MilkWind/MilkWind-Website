1:"$Sreact.fragment"
2:I[38735,["46","static/chunks/46-72724587da45cdb8.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"default"]
3:I[19945,["46","static/chunks/46-72724587da45cdb8.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"default"]
4:I[65337,["46","static/chunks/46-72724587da45cdb8.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"default"]
5:I[96190,["46","static/chunks/46-72724587da45cdb8.js","7177","static/chunks/app/layout-af4a6e723c0ff668.js"],"ClientProviders"]
6:I[87555,[],""]
7:I[51901,["8039","static/chunks/app/error-dda32be1d095a86c.js"],"default"]
8:I[31295,[],""]
9:I[6874,["6874","static/chunks/6874-fbe9a08eb79b991c.js","4345","static/chunks/app/not-found-9ff98b2ccf24cac7.js"],""]
a:I[94970,[],"ClientSegmentRoot"]
b:I[44065,["206","static/chunks/206-4f4cbf4d7156f437.js","3092","static/chunks/app/documents/layout-28408791defde09e.js"],"default"]
e:I[59665,[],"MetadataBoundary"]
10:I[59665,[],"OutletBoundary"]
13:I[74911,[],"AsyncMetadataOutlet"]
15:I[39460,["2415","static/chunks/2415-689c103fb3d2c28d.js","8610","static/chunks/8610-7bd3f91f3cf2a4d6.js","5650","static/chunks/app/documents/loading-1fa3f98b6e5a8e78.js"],"default"]
16:I[88610,["2415","static/chunks/2415-689c103fb3d2c28d.js","8610","static/chunks/8610-7bd3f91f3cf2a4d6.js","4209","static/chunks/app/loading-68f227fb49b3ac8c.js"],"default"]
17:I[59665,[],"ViewportBoundary"]
19:I[26614,[],""]
:HL["/_next/static/css/704956702722271c.css","style"]
:HL["/_next/static/css/b226d7ef8e491b72.css","style"]
:HL["/_next/static/css/5eacd01f773eed7f.css","style"]
0:{"P":null,"b":"bvFtULB1Kap7EFVJ0gqa4","p":"","c":["","documents","en","dark","questions-party","prompt-word-analysis",""],"i":false,"f":[[["",{"children":["documents",{"children":[["slug","en/dark/questions-party/prompt-word-analysis","c"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/704956702722271c.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","link","1",{"rel":"stylesheet","href":"/_next/static/css/b226d7ef8e491b72.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","suppressHydrationWarning":true,"children":["$","body",null,{"className":"__variable_d4c88d __variable_7b4e2b __variable_c3272d font-sans antialiased min-h-screen bg-background text-foreground","suppressHydrationWarning":true,"children":[["$","$L2",null,{}],["$","$L3",null,{}],["$","$L4",null,{}],["$","$L5",null,{"children":["$","$L6",null,{"parallelRouterKey":"children","error":"$7","errorStyles":[],"errorScripts":[],"template":["$","$L8",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","div",null,{"className":"z-10 relative min-h-screen flex items-center justify-center bg-background p-8","children":["$","div",null,{"className":"text-center max-w-md","children":[["$","div",null,{"className":"text-8xl font-bold text-primary mb-4","children":"404"}],["$","h2",null,{"className":"text-2xl font-bold text-foreground mb-4","children":"Page Not Found"}],["$","p",null,{"className":"text-foreground/70 mb-8","children":"The page you're looking for doesn't exist or has been moved to a different location."}],["$","div",null,{"className":"flex flex-col sm:flex-row gap-4 justify-center","children":[["$","$L9",null,{"href":"/","className":"px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors","children":"Go Home"}],["$","$L9",null,{"href":"/works","className":"px-6 py-2 border border-primary text-primary rounded-lg hover:bg-primary/10 transition-colors","children":"View Works"}]]}],["$","div",null,{"className":"absolute inset-0 overflow-hidden pointer-events-none -z-10","children":[["$","div",null,{"className":"absolute top-1/4 left-1/4 w-2 h-2 bg-primary/20 rounded-full animate-float"}],["$","div",null,{"className":"absolute top-3/4 right-1/4 w-3 h-3 bg-accent/20 rounded-full animate-float","style":{"animationDelay":"1s"}}],["$","div",null,{"className":"absolute bottom-1/4 left-1/3 w-1 h-1 bg-secondary/20 rounded-full animate-float","style":{"animationDelay":"2s"}}]]}]]}]}],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}]]}]}]]}],{"children":["documents",["$","$1","c",{"children":[null,["$","$La",null,{"Component":"$b","slots":{"children":["$","$L6",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L8",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]},"params":{},"promise":"$@c"}]]}],{"children":[["slug","en/dark/questions-party/prompt-word-analysis","c"],["$","$1","c",{"children":[null,["$","$L6",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L8",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$Ld",["$","$Le",null,{"children":"$Lf"}],[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/5eacd01f773eed7f.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","$L10",null,{"children":["$L11","$L12",["$","$L13",null,{"promise":"$@14"}]]}]]}],{},null,false]},null,false]},[["$","$L15","l",{}],[],[]],false]},[["$","$L16","l",{}],[],[]],false],["$","$1","h",{"children":[null,["$","$1","2agAPzGw69qkrp-FXKgAw",{"children":[["$","$L17",null,{"children":"$L18"}],null]}],null]}],false]],"m":"$undefined","G":["$19","$undefined"],"s":false,"S":true}
1a:"$Sreact.suspense"
1b:I[74911,[],"AsyncMetadata"]
c:{}
f:["$","$1a",null,{"fallback":null,"children":["$","$L1b",null,{"promise":"$@1c"}]}]
1d:I[57340,["5584","static/chunks/b498d07c-095637f0f10883c6.js","2415","static/chunks/2415-689c103fb3d2c28d.js","6874","static/chunks/6874-fbe9a08eb79b991c.js","9554","static/chunks/9554-b714f9de28e85d30.js","1873","static/chunks/app/documents/%5B...slug%5D/page-8f3efa7e6c6c5377.js"],"DocumentPageClient"]
1e:T2b896,<h1 id="prompt-generation-and-response-parsing-the-birth-of-another-machine-language" class="group relative text-4xl font-bold mt-8 mb-4 text-foreground leading-tight">
            <a href="#prompt-generation-and-response-parsing-the-birth-of-another-machine-language" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Prompt Generation and Response Parsing: The Birth of Another Machine Language">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Prompt Generation and Response Parsing: The Birth of Another Machine Language
        </h1>
<p class="text-base leading-7 mb-4 text-foreground">I often wonder, if making computers recognize machine language was the first major milestone in programming, then making AI recognize natural language today—could that be considered the second major milestone?</p>
<p class="text-base leading-7 mb-4 text-foreground">This article will comprehensively analyze the prompt management system in the Questions Party project, from the architectural design of PromptLoader to the robust implementation of response parsing, taking you through the original principles of MCP.</p>
<h2 id="promptloader-core-architecture" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#promptloader-core-architecture" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to PromptLoader Core Architecture">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            PromptLoader Core Architecture
        </h2>
<h3 id="singleton-pattern-design" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#singleton-pattern-design" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Singleton Pattern Design">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Singleton Pattern Design
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="const%20fs%20%3D%20require('fs')%3B%0Aconst%20path%20%3D%20require('path')%3B%0Aclass%20PromptLoader%20%7B%0Aconstructor()%20%7B%0Athis.promptCache%20%3D%20new%20Map()%3B%0Athis.promptsDir%20%3D%20path.join(__dirname%2C%20'..%2Fprompts')%3B%0A%7D%0A%7D%0A**Why%20Choose%20Singleton%20Pattern**%3A%0AThroughout%20the%20entire%20application%20lifecycle%2C%20PromptLoader%20only%20needs%20one%20instance%E2%80%94after%20all%2C%20prompt%20templates%20won't%20run%20away%2C%20and%20the%20file%20system%20won't%20suddenly%20change%20its%20face.%0A%23%23%23%20Directory%20Structure%20Convention%0A%60%60%60typescript%0A%2F%2F%20Actual%20directory%20structure%0Asrc%2Fprompts%2F%0A%E2%94%9C%E2%94%80%E2%94%80%20sentence-check-pure.txt%20%20%20%20%20%20%20%20%23%20Pure%20English%20sentence%20check%20template%0A%E2%94%9C%E2%94%80%E2%94%80%20sentence-check-combined.txt%20%20%20%20%23%20Bilingual%20sentence%20check%20template%0A%E2%94%9C%E2%94%80%E2%94%80%20sentence-generation-pure.txt%20%20%20%23%20Pure%20English%20sentence%20generation%20template%0A%E2%94%9C%E2%94%80%E2%94%80%20sentence-generation-combined.txt%20%20%23%20Bilingual%20sentence%20generation%20template%0A%E2%94%94%E2%94%80%E2%94%80%20README.md%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Documentation">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-keyword inline">const</span> fs = <span class="hljs-built_in inline">require</span>(<span class="hljs-string inline">&#x27;fs&#x27;</span>);
<span class="hljs-keyword inline">const</span> path = <span class="hljs-built_in inline">require</span>(<span class="hljs-string inline">&#x27;path&#x27;</span>);

<span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">PromptLoader</span> {
    <span class="hljs-title function_ inline">constructor</span>(<span class="hljs-params inline"></span>) {
        <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptCache</span> = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">Map</span>();
        <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptsDir</span> = path.<span class="hljs-title function_ inline">join</span>(__dirname, <span class="hljs-string inline">&#x27;../prompts&#x27;</span>);
    }
}

**<span class="hljs-title class_ inline">Why</span> <span class="hljs-title class_ inline">Choose</span> <span class="hljs-title class_ inline">Singleton</span> <span class="hljs-title class_ inline">Pattern</span>**:

<span class="hljs-title class_ inline">Throughout</span> the entire application lifecycle, <span class="hljs-title class_ inline">PromptLoader</span> only needs one instance—after all, prompt templates won<span class="hljs-string inline">&#x27;t run away, and the file system won&#x27;</span>t suddenly change its face.

### <span class="hljs-title class_ inline">Directory</span> <span class="hljs-title class_ inline">Structure</span> <span class="hljs-title class_ inline">Convention</span>

<span class="hljs-string inline">``</span><span class="hljs-string inline">`typescript
// Actual directory structure
src/prompts/
├── sentence-check-pure.txt        # Pure English sentence check template
├── sentence-check-combined.txt    # Bilingual sentence check template
├── sentence-generation-pure.txt   # Pure English sentence generation template
├── sentence-generation-combined.txt  # Bilingual sentence generation template
└── README.md                      # Documentation
</span></code></pre>
            </div>
        
<h3 id="map-caching" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#map-caching" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Map Caching">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Map Caching
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="this.promptCache%20%3D%20new%20Map()%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptCache</span> = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">Map</span>();
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Why Choose Map Instead of Object</strong>?</p>
<p class="text-base leading-7 mb-4 text-foreground">This is a classic data structure selection problem:</p>
<table class="w-full border-collapse mb-4 shadow-sm rounded-lg overflow-hidden">
<thead class="bg-surface">
<tr class="border-b border-gray-200"><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">Feature</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">Map</th><th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wider bg-surface">Object</th></tr>
</thead>
<tbody class="bg-background divide-y divide-gray-200">
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Key Type</td><td class="px-4 py-3 text-sm text-foreground">Any type</td><td class="px-4 py-3 text-sm text-foreground">String/Symbol</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Size Retrieval</td><td class="px-4 py-3 text-sm text-foreground">O(1)</td><td class="px-4 py-3 text-sm text-foreground">O(n)</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Iteration Performance</td><td class="px-4 py-3 text-sm text-foreground">Excellent</td><td class="px-4 py-3 text-sm text-foreground">Average</td></tr>
<tr class="border-b border-gray-200"><td class="px-4 py-3 text-sm text-foreground">Prototype Pollution</td><td class="px-4 py-3 text-sm text-foreground">None</td><td class="px-4 py-3 text-sm text-foreground">Risk</td></tr>
</tbody>
</table>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Cache Performance Mathematical Analysis</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">Assuming each prompt file averages 2KB, with 4 template files in the system:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">No Cache</strong>: Each request requires file reading, IO time ~1-5ms</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">With Cache</strong>: After initial read, access time drops to below 0.01ms</li>
</ul>
<p class="text-base leading-7 mb-4 text-foreground">When cache hit rate reaches 90%, performance improvement is approximately:<br class="block">
<span class="katex-display inline"><span class="katex inline"><span class="katex-mathml inline"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mi>e</mi><mi>r</mi><mi>f</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>I</mi><mi>m</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>v</mi><mi>e</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo>=</mo><mfrac><mrow><mn>5</mn><mi>m</mi><mi>s</mi></mrow><mrow><mn>0.01</mn><mi>m</mi><mi>s</mi></mrow></mfrac><mo>×</mo><mn>0.9</mn><mo>=</mo><mn>450</mn><mi>x</mi></mrow><annotation encoding="application/x-tex">Performance Improvement = \frac{5ms}{0.01ms} \times 0.9 = 450x</annotation></semantics></math></span><span class="katex-html inline" aria-hidden="true" style="display:none"><span class="base inline"><span class="strut inline" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal inline" style="margin-right:0.13889em;">P</span><span class="mord mathnormal inline" style="margin-right:0.02778em;">er</span><span class="mord mathnormal inline" style="margin-right:0.10764em;">f</span><span class="mord mathnormal inline" style="margin-right:0.02778em;">or</span><span class="mord mathnormal inline">man</span><span class="mord mathnormal inline">ce</span><span class="mord mathnormal inline" style="margin-right:0.07847em;">I</span><span class="mord mathnormal inline">m</span><span class="mord mathnormal inline">p</span><span class="mord mathnormal inline">ro</span><span class="mord mathnormal inline" style="margin-right:0.03588em;">v</span><span class="mord mathnormal inline">e</span><span class="mord mathnormal inline">m</span><span class="mord mathnormal inline">e</span><span class="mord mathnormal inline">n</span><span class="mord mathnormal inline">t</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord inline"><span class="mopen nulldelimiter inline"></span><span class="mfrac inline"><span class="vlist-t vlist-t2 inline"><span class="vlist-r inline"><span class="vlist inline" style="height:1.3214em;"><span style="top:-2.314em;" class="inline"><span class="pstrut inline" style="height:3em;"></span><span class="mord inline"><span class="mord inline">0.01</span><span class="mord mathnormal inline">m</span><span class="mord mathnormal inline">s</span></span></span><span style="top:-3.23em;" class="inline"><span class="pstrut inline" style="height:3em;"></span><span class="frac-line inline" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;" class="inline"><span class="pstrut inline" style="height:3em;"></span><span class="mord inline"><span class="mord inline">5</span><span class="mord mathnormal inline">m</span><span class="mord mathnormal inline">s</span></span></span></span><span class="vlist-s inline">​</span></span><span class="vlist-r inline"><span class="vlist inline" style="height:0.686em;"><span class="inline"></span></span></span></span></span><span class="mclose nulldelimiter inline"></span></span><span class="mspace inline" style="margin-right:0.2222em;"></span><span class="mbin inline">×</span><span class="mspace inline" style="margin-right:0.2222em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.6444em;"></span><span class="mord inline">0.9</span><span class="mspace inline" style="margin-right:0.2778em;"></span><span class="mrel inline">=</span><span class="mspace inline" style="margin-right:0.2778em;"></span></span><span class="base inline"><span class="strut inline" style="height:0.6444em;"></span><span class="mord inline">450</span><span class="mord mathnormal inline">x</span></span></span></span></span></p>
<h2 id="loadprompt-function" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#loadprompt-function" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to loadPrompt Function">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            loadPrompt Function
        </h2>
<h3 id="cache-first-strategy" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#cache-first-strategy" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Cache-First Strategy">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Cache-First Strategy
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="loadPrompt(type%2C%20grammarLanguageOption%20%3D%20'combined')%20%7B%0Aconst%20cacheKey%20%3D%20%60%24%7Btype%7D-%24%7BgrammarLanguageOption%7D%60%3B%0A%2F%2F%20If%20cache%20has%20it%2C%20return%20cached%20version%0Aif%20(this.promptCache.has(cacheKey))%20%7B%0Areturn%20this.promptCache.get(cacheKey)%3B%0A%7D%0Atry%20%7B%0Aconst%20filename%20%3D%20%60%24%7Btype%7D-%24%7BgrammarLanguageOption%7D.txt%60%3B%0Aconst%20filepath%20%3D%20path.join(this.promptsDir%2C%20filename)%3B%0Aif%20(!fs.existsSync(filepath))%20%7B%0Athrow%20new%20Error(%60Prompt%20file%20not%20found%3A%20%24%7Bfilepath%7D%60)%3B%0A%7D%0Aconst%20promptTemplate%20%3D%20fs.readFileSync(filepath%2C%20'utf8')%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-title function_ inline">loadPrompt</span>(<span class="hljs-params inline">type, grammarLanguageOption = <span class="hljs-string inline">&#x27;combined&#x27;</span></span>) {
    <span class="hljs-keyword inline">const</span> cacheKey = <span class="hljs-string inline">`<span class="hljs-subst inline">${type}</span>-<span class="hljs-subst inline">${grammarLanguageOption}</span>`</span>;
    
    <span class="hljs-comment inline">// If cache has it, return cached version</span>
    <span class="hljs-keyword inline">if</span> (<span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptCache</span>.<span class="hljs-title function_ inline">has</span>(cacheKey)) {
        <span class="hljs-keyword inline">return</span> <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptCache</span>.<span class="hljs-title function_ inline">get</span>(cacheKey);
    }

    <span class="hljs-keyword inline">try</span> {
        <span class="hljs-keyword inline">const</span> filename = <span class="hljs-string inline">`<span class="hljs-subst inline">${type}</span>-<span class="hljs-subst inline">${grammarLanguageOption}</span>.txt`</span>;
        <span class="hljs-keyword inline">const</span> filepath = path.<span class="hljs-title function_ inline">join</span>(<span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptsDir</span>, filename);
        
        <span class="hljs-keyword inline">if</span> (!fs.<span class="hljs-title function_ inline">existsSync</span>(filepath)) {
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">Error</span>(<span class="hljs-string inline">`Prompt file not found: <span class="hljs-subst inline">${filepath}</span>`</span>);
        }

        <span class="hljs-keyword inline">const</span> promptTemplate = fs.<span class="hljs-title function_ inline">readFileSync</span>(filepath, <span class="hljs-string inline">&#x27;utf8&#x27;</span>);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Cache Key Design</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground"><code>${type}-${grammarLanguageOption}</code> is a composite key corresponding to “function-language” respectively.</p>
<h3 id="file-system-safe-operations" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#file-system-safe-operations" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to File System Safe Operations">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            File System Safe Operations
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="if%20(!fs.existsSync(filepath))%20%7B%0Athrow%20new%20Error(%60Prompt%20file%20not%20found%3A%20%24%7Bfilepath%7D%60)%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-keyword inline">if</span> (!fs.<span class="hljs-title function_ inline">existsSync</span>(filepath)) {
    <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">Error</span>(<span class="hljs-string inline">`Prompt file not found: <span class="hljs-subst inline">${filepath}</span>`</span>);
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Why Check File Existence First</strong>?</p>
<p class="text-base leading-7 mb-4 text-foreground">This is a classic case of defensive programming:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="typescript" data-code="%2F%2F%20%E2%9D%8C%20Unsafe%20approach%0Aconst%20content%20%3D%20fs.readFileSync(filepath%2C%20'utf8')%3B%20%20%2F%2F%20May%20throw%20ENOENT%20error%0A%2F%2F%20%E2%9C%85%20Safe%20approach%0Aif%20(!fs.existsSync(filepath))%20%7B%0Athrow%20new%20Error(%60Prompt%20file%20not%20found%3A%20%24%7Bfilepath%7D%60)%3B%0A%7D%0Aconst%20content%20%3D%20fs.readFileSync(filepath%2C%20'utf8')%3B%20%20%2F%2F%20Clear%20error%20message">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">typescript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-typescript"><span class="hljs-comment inline">// ❌ Unsafe approach</span>
<span class="hljs-keyword inline">const</span> content = fs.<span class="hljs-title function_ inline">readFileSync</span>(filepath, <span class="hljs-string inline">&#x27;utf8&#x27;</span>);  <span class="hljs-comment inline">// May throw ENOENT error</span>

<span class="hljs-comment inline">// ✅ Safe approach</span>
<span class="hljs-keyword inline">if</span> (!fs.<span class="hljs-title function_ inline">existsSync</span>(filepath)) {
    <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">Error</span>(<span class="hljs-string inline">`Prompt file not found: <span class="hljs-subst inline">${filepath}</span>`</span>);
}
<span class="hljs-keyword inline">const</span> content = fs.<span class="hljs-title function_ inline">readFileSync</span>(filepath, <span class="hljs-string inline">&#x27;utf8&#x27;</span>);  <span class="hljs-comment inline">// Clear error message</span>
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Path Concatenation Compatibility</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="typescript" data-code="const%20filepath%20%3D%20path.join(this.promptsDir%2C%20filename)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">typescript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-typescript"><span class="hljs-keyword inline">const</span> filepath = path.<span class="hljs-title function_ inline">join</span>(<span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptsDir</span>, filename);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">Using <code>path.join</code> instead of string concatenation avoids cross-platform path separator issues:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed">Windows: <code>\</code></li>
<li class="text-foreground leading-relaxed">Unix/Linux: <code>/</code></li>
<li class="text-foreground leading-relaxed">Node.js handles automatically</li>
</ul>
<h3 id="prompt-loading-fallback-handling" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#prompt-loading-fallback-handling" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Prompt Loading Fallback Handling">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Prompt Loading Fallback Handling
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="%7D%20catch%20(error)%20%7B%0Aconsole.error(%60Error%20loading%20prompt%20%24%7Btype%7D-%24%7BgrammarLanguageOption%7D%3A%60%2C%20error.message)%3B%0A%2F%2F%20If%20pure%20version%20fails%2C%20fallback%20to%20combined%20version%0Aif%20(grammarLanguageOption%20%3D%3D%3D%20'pure')%20%7B%0Aconsole.warn(%60Falling%20back%20to%20combined%20prompt%20for%20%24%7Btype%7D%60)%3B%0Areturn%20this.loadPrompt(type%2C%20'combined')%3B%0A%7D%0A%2F%2F%20If%20combined%20version%20also%20fails%2C%20throw%20error%0Athrow%20new%20Error(%60Failed%20to%20load%20prompt%20template%3A%20%24%7Btype%7D-%24%7BgrammarLanguageOption%7D%60)%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript">} <span class="hljs-keyword inline">catch</span> (error) {
    <span class="hljs-variable language_ inline">console</span>.<span class="hljs-title function_ inline">error</span>(<span class="hljs-string inline">`Error loading prompt <span class="hljs-subst inline">${type}</span>-<span class="hljs-subst inline">${grammarLanguageOption}</span>:`</span>, error.<span class="hljs-property inline">message</span>);
    
    <span class="hljs-comment inline">// If pure version fails, fallback to combined version</span>
    <span class="hljs-keyword inline">if</span> (grammarLanguageOption === <span class="hljs-string inline">&#x27;pure&#x27;</span>) {
        <span class="hljs-variable language_ inline">console</span>.<span class="hljs-title function_ inline">warn</span>(<span class="hljs-string inline">`Falling back to combined prompt for <span class="hljs-subst inline">${type}</span>`</span>);
        <span class="hljs-keyword inline">return</span> <span class="hljs-variable language_ inline">this</span>.<span class="hljs-title function_ inline">loadPrompt</span>(type, <span class="hljs-string inline">&#x27;combined&#x27;</span>);
    }
    
    <span class="hljs-comment inline">// If combined version also fails, throw error</span>
    <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">Error</span>(<span class="hljs-string inline">`Failed to load prompt template: <span class="hljs-subst inline">${type}</span>-<span class="hljs-subst inline">${grammarLanguageOption}</span>`</span>);
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">Recursive fallback order: <code>pure → combined → error</code></p>
<p class="text-base leading-7 mb-4 text-foreground">Error handling decision tree:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="" data-code="Load%20pure%20version%0A%E2%86%93%0AFailed%3F%20%E2%86%92%20Yes%20%E2%86%92%20Try%20combined%20version%0A%E2%86%93%20%20%20%20%20%20%20%20%20%E2%86%93%0ANo%20%20%20%20%20%20%20%20Failed%3F%20%E2%86%92%20Yes%20%E2%86%92%20Throw%20error%0A%E2%86%93%20%20%20%20%20%20%20%20%20%E2%86%93%0AReturn%20content%20%20%20No%0A%E2%86%93%0AReturn%20content">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">code</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code><span class="hljs-keyword inline">Load</span> pure <span class="hljs-keyword inline">version</span>
    ↓
Failed? → Yes → Try combined <span class="hljs-keyword inline">version</span>
    ↓         ↓
   <span class="hljs-keyword inline">No</span>        Failed? → Yes → Throw error
    ↓         ↓
<span class="hljs-keyword inline">Return</span> content   <span class="hljs-keyword inline">No</span>
              ↓
            <span class="hljs-keyword inline">Return</span> content
</code></pre>
            </div>
        
<h2 id="prompt-structured-design" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#prompt-structured-design" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Prompt Structured Design">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Prompt Structured Design
        </h2>
<h3 id="combined-vs-pure-bilingual-teaching" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#combined-vs-pure-bilingual-teaching" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Combined vs Pure: Bilingual Teaching">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Combined vs Pure: Bilingual Teaching
        </h3>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Pure Version (English Only)</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="" data-code="Analyze%20this%20sentence%3A%20%22%7Bsentence%7D%22%0AFollow%20this%20exact%20format%20(Output%20Example)%3A%0AGRAMMAR_ANALYSIS(Parsing%20required)%3A%0A1.%20Grammar%20and%20Style%20Issues">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">code</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code>Analyze <span class="hljs-keyword inline">this</span> sentence: <span class="hljs-string inline">&quot;{sentence}&quot;</span>

Follow <span class="hljs-keyword inline">this</span> exact format (Output Example):

GRAMMAR_ANALYSIS(Parsing required):
<span class="hljs-number inline">1.</span> Grammar and Style Issues
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Combined Version (Bilingual)</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="" data-code="Analyze%20this%20sentence%3A%20%22%7Bsentence%7D%22%0APlease%20strictly%20follow%20this%20format%20(Output%20Example)%3A%0AGRAMMAR_ANALYSIS(Parsing%20required)%3A%0A1.%20Grammar%20and%20Style%20Issues">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">code</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code>Analyze <span class="hljs-keyword inline">this</span> sentence: <span class="hljs-string inline">&quot;{sentence}&quot;</span>

Please strictly follow <span class="hljs-keyword inline">this</span> format (Output Example):

GRAMMAR_ANALYSIS(Parsing required):
<span class="hljs-number inline">1.</span> Grammar and Style Issues
</code></pre>
            </div>
        
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Pure Version</strong>: For English learners, providing authentic English environment</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Combined Version</strong>: For Chinese users, lowering comprehension threshold, providing bilingual reference</li>
</ul>
<h2 id="cache-mechanism-and-performance-optimization" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#cache-mechanism-and-performance-optimization" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Cache Mechanism and Performance Optimization">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Cache Mechanism and Performance Optimization
        </h2>
<h3 id="map-vs-object-performance-comparison" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#map-vs-object-performance-comparison" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Map vs Object Performance Comparison">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Map vs Object Performance Comparison
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="%2F%2F%20Performance%20test%20pseudo-code%0Aconst%20iterations%20%3D%201000000%3B%0A%2F%2F%20Map%20performance%20test%0Aconst%20mapCache%20%3D%20new%20Map()%3B%0Aconsole.time('Map')%3B%0Afor%20(let%20i%20%3D%200%3B%20i%20set(%60key%24%7Bi%7D%60%2C%20%60value%24%7Bi%7D%60)%3B%0AmapCache.get(%60key%24%7Bi%7D%60)%3B%0A%7D%0Aconsole.timeEnd('Map')%3B%0A%2F%2F%20Object%20performance%20test%0Aconst%20objCache%20%3D%20%7B%7D%3B%0Aconsole.time('Object')%3B%0Afor%20(let%20i%20%3D%200%3B%20i%20%60key%24%7Bi%7D%60%5D%20%3D%20%60value%24%7Bi%7D%60%3B%0Aconst%20value%20%3D%20objCache%5B%60key%24%7Bi%7D%60%5D%3B%0A%7D%0Aconsole.timeEnd('Object')%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-comment inline">// Performance test pseudo-code</span>
<span class="hljs-keyword inline">const</span> iterations = <span class="hljs-number inline">1000000</span>;

<span class="hljs-comment inline">// Map performance test</span>
<span class="hljs-keyword inline">const</span> mapCache = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">Map</span>();
<span class="hljs-variable language_ inline">console</span>.<span class="hljs-title function_ inline">time</span>(<span class="hljs-string inline">&#x27;Map&#x27;</span>);
<span class="hljs-keyword inline">for</span> (<span class="hljs-keyword inline">let</span> i = <span class="hljs-number inline">0</span>; i &lt; iterations; i++) {
    mapCache.<span class="hljs-title function_ inline">set</span>(<span class="hljs-string inline">`key<span class="hljs-subst inline">${i}</span>`</span>, <span class="hljs-string inline">`value<span class="hljs-subst inline">${i}</span>`</span>);
    mapCache.<span class="hljs-title function_ inline">get</span>(<span class="hljs-string inline">`key<span class="hljs-subst inline">${i}</span>`</span>);
}
<span class="hljs-variable language_ inline">console</span>.<span class="hljs-title function_ inline">timeEnd</span>(<span class="hljs-string inline">&#x27;Map&#x27;</span>);

<span class="hljs-comment inline">// Object performance test</span>
<span class="hljs-keyword inline">const</span> objCache = {};
<span class="hljs-variable language_ inline">console</span>.<span class="hljs-title function_ inline">time</span>(<span class="hljs-string inline">&#x27;Object&#x27;</span>);
<span class="hljs-keyword inline">for</span> (<span class="hljs-keyword inline">let</span> i = <span class="hljs-number inline">0</span>; i &lt; iterations; i++) {
    objCache[<span class="hljs-string inline">`key<span class="hljs-subst inline">${i}</span>`</span>] = <span class="hljs-string inline">`value<span class="hljs-subst inline">${i}</span>`</span>;
    <span class="hljs-keyword inline">const</span> value = objCache[<span class="hljs-string inline">`key<span class="hljs-subst inline">${i}</span>`</span>];
}
<span class="hljs-variable language_ inline">console</span>.<span class="hljs-title function_ inline">timeEnd</span>(<span class="hljs-string inline">&#x27;Object&#x27;</span>);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Actual Test Results</strong>:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed">Map: ~661.084ms</li>
<li class="text-foreground leading-relaxed">Object: ~1005ms</li>
</ul>
<p class="text-base leading-7 mb-4 text-foreground">Map has about 52% performance advantage in large-scale operations!</p>
<h2 id="fallback-strategy-fault-tolerance-design" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#fallback-strategy-fault-tolerance-design" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Fallback Strategy Fault Tolerance Design">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Fallback Strategy Fault Tolerance Design
        </h2>
<h3 id="pure-→-combined-fallback-logic" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#pure-→-combined-fallback-logic" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Pure → Combined Fallback Logic">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Pure → Combined Fallback Logic
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="%2F%2F%20If%20pure%20version%20fails%2C%20fallback%20to%20combined%20version%0Aif%20(grammarLanguageOption%20%3D%3D%3D%20'pure')%20%7B%0Aconsole.warn(%60Falling%20back%20to%20combined%20prompt%20for%20%24%7Btype%7D%60)%3B%0Areturn%20this.loadPrompt(type%2C%20'combined')%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-comment inline">// If pure version fails, fallback to combined version</span>
<span class="hljs-keyword inline">if</span> (grammarLanguageOption === <span class="hljs-string inline">&#x27;pure&#x27;</span>) {
    <span class="hljs-variable language_ inline">console</span>.<span class="hljs-title function_ inline">warn</span>(<span class="hljs-string inline">`Falling back to combined prompt for <span class="hljs-subst inline">${type}</span>`</span>);
    <span class="hljs-keyword inline">return</span> <span class="hljs-variable language_ inline">this</span>.<span class="hljs-title function_ inline">loadPrompt</span>(type, <span class="hljs-string inline">&#x27;combined&#x27;</span>);
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Fallback Decision State Machine</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="" data-code="%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%E2%94%82%20Load%20Pure%20%20%20%E2%94%82%0A%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%E2%94%82%0A%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%96%BC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%20%20%20%20No%0A%E2%94%82Success%3F%20%E2%94%82%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%0A%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0AYes%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%96%BC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%96%BC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%E2%94%82Return%20%20%20%E2%94%82%20%20%20%20%E2%94%82Try%20Combined%20%20%20%E2%94%82%0A%E2%94%82Content%20%20%E2%94%82%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%96%BC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%E2%94%82Success%3F%20%E2%94%82%0A%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0AYes%20%E2%94%82%20%20No%0A%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%96%BC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%E2%94%82Return%20%20%20%E2%94%82%20%20%20%20%E2%94%82Throw%20%20%20%20%E2%94%82%0A%E2%94%82Content%20%20%E2%94%82%20%20%20%20%E2%94%82Error%20%20%20%20%E2%94%82%0A%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">code</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code>                    ┌─────────────┐
                    │ Load Pure   │
                    └─────┬───────┘
                          │
                     ┌────▼────┐     <span class="hljs-literal inline">No</span>
                     │Success? │────────────
                     └────┬────┘           │
                       <span class="hljs-literal inline">Yes</span> │               │
                     ┌────▼────┐    ┌───────▼───────┐
                     │Return   │    │Try Combined   │
                     │Content  │    └───────┬───────┘
                     └─────────┘            │
                                       ┌────▼────┐
                                       │Success? │
                                       └────┬────┘
                                         <span class="hljs-literal inline">Yes</span> │  <span class="hljs-literal inline">No</span>
                                   ┌────▼────┐    ┌─────────┐
                                   │Return   │    │Throw    │
                                   │Content  │    │<span class="hljs-built_in inline">Error</span>    │
                                   └─────────┘    └─────────┘
</code></pre>
            </div>
        
<h3 id="system-robustness-guarantee" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#system-robustness-guarantee" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to System Robustness Guarantee">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            System Robustness Guarantee
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="validatePromptFiles()%20%7B%0Aconst%20requiredPrompts%20%3D%20%5B%0A'sentence-check-pure.txt'%2C%0A'sentence-check-combined.txt'%2C%0A'sentence-generation-pure.txt'%2C%0A'sentence-generation-combined.txt'%0A%5D%3B%0Aconst%20missing%20%3D%20%5B%5D%3B%0Aconst%20existing%20%3D%20%5B%5D%3B%0Afor%20(const%20filename%20of%20requiredPrompts)%20%7B%0Aconst%20filepath%20%3D%20path.join(this.promptsDir%2C%20filename)%3B%0Aif%20(fs.existsSync(filepath))%20%7B%0Aexisting.push(filename)%3B%0A%7D%20else%20%7B%0Amissing.push(filename)%3B%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-title function_ inline">validatePromptFiles</span>(<span class="hljs-params inline"></span>) {
    <span class="hljs-keyword inline">const</span> requiredPrompts = [
        <span class="hljs-string inline">&#x27;sentence-check-pure.txt&#x27;</span>,
        <span class="hljs-string inline">&#x27;sentence-check-combined.txt&#x27;</span>,
        <span class="hljs-string inline">&#x27;sentence-generation-pure.txt&#x27;</span>,
        <span class="hljs-string inline">&#x27;sentence-generation-combined.txt&#x27;</span>
    ];

    <span class="hljs-keyword inline">const</span> missing = [];
    <span class="hljs-keyword inline">const</span> existing = [];

    <span class="hljs-keyword inline">for</span> (<span class="hljs-keyword inline">const</span> filename <span class="hljs-keyword inline">of</span> requiredPrompts) {
        <span class="hljs-keyword inline">const</span> filepath = path.<span class="hljs-title function_ inline">join</span>(<span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptsDir</span>, filename);
        <span class="hljs-keyword inline">if</span> (fs.<span class="hljs-title function_ inline">existsSync</span>(filepath)) {
            existing.<span class="hljs-title function_ inline">push</span>(filename);
        } <span class="hljs-keyword inline">else</span> {
            missing.<span class="hljs-title function_ inline">push</span>(filename);
        }
    }
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Startup Validation</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">System performs integrity check at startup, following “Fast Fail” principle:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Early Discovery</strong>: Problems found during deployment</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Clear Feedback</strong>: Missing files clearly visible</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Ops Friendly</strong>: Reduces debugging time in production environment</li>
</ul>
<h2 id="parsesentencecheckresponse-deep-analysis" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#parsesentencecheckresponse-deep-analysis" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to parseSentenceCheckResponse Deep Analysis">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            parseSentenceCheckResponse Deep Analysis
        </h2>
<h3 id="tokenized-response-format-design" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#tokenized-response-format-design" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Tokenized Response Format Design">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Tokenized Response Format Design
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="%2F%2F%20Sentence%20check%20response%20format%20configuration%0Athis.checkResponseFormat%20%3D%20%7B%0AgrammarAnalysisMarker%3A%20%22GRAMMAR_ANALYSIS%3A%22%2C%0AgrammarCorrectionMarker%3A%20%22GRAMMAR_CORRECTION%3A%22%2C%0AkeywordAnalysisMarker%3A%20%22KEYWORD_ANALYSIS%3A%22%2C%0AchineseDefinitionMarker%3A%20%22CHINESE_DEFINITION%3A%22%2C%0AendMarker%3A%20%22END_FORMAT%22%0A%7D%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-comment inline">// Sentence check response format configuration</span>
<span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">checkResponseFormat</span> = {
    <span class="hljs-attr inline">grammarAnalysisMarker</span>: <span class="hljs-string inline">&quot;GRAMMAR_ANALYSIS:&quot;</span>,
    <span class="hljs-attr inline">grammarCorrectionMarker</span>: <span class="hljs-string inline">&quot;GRAMMAR_CORRECTION:&quot;</span>,
    <span class="hljs-attr inline">keywordAnalysisMarker</span>: <span class="hljs-string inline">&quot;KEYWORD_ANALYSIS:&quot;</span>,
    <span class="hljs-attr inline">chineseDefinitionMarker</span>: <span class="hljs-string inline">&quot;CHINESE_DEFINITION:&quot;</span>,
    <span class="hljs-attr inline">endMarker</span>: <span class="hljs-string inline">&quot;END_FORMAT&quot;</span>
};
</code></pre>
            </div>
        
<h3 id="robust-parsing-algorithm" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#robust-parsing-algorithm" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Robust Parsing Algorithm">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Robust Parsing Algorithm
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="parseSentenceCheckResponse(content%2C%20locale%20%3D%20'en')%20%7B%0Atry%20%7B%0Aconst%20%7B%0AgrammarAnalysisMarker%2C%0AgrammarCorrectionMarker%2C%0AkeywordAnalysisMarker%2C%0AchineseDefinitionMarker%2C%0AendMarker%0A%7D%20%3D%20this.checkResponseFormat%3B%0A%2F%2F%20Store%20original%20content%20for%20fallback%0Aconst%20rawContent%20%3D%20content%3B%0A%2F%2F%20Clean%20content%20-%20remove%20%22(Parsing%20required)%22%20and%20other%20unwanted%20text%0Alet%20cleanedContent%20%3D%20this.cleanResponseContent(content)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-title function_ inline">parseSentenceCheckResponse</span>(<span class="hljs-params inline">content, locale = <span class="hljs-string inline">&#x27;en&#x27;</span></span>) {
    <span class="hljs-keyword inline">try</span> {
        <span class="hljs-keyword inline">const</span> {
            grammarAnalysisMarker,
            grammarCorrectionMarker,
            keywordAnalysisMarker,
            chineseDefinitionMarker,
            endMarker
        } = <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">checkResponseFormat</span>;

        <span class="hljs-comment inline">// Store original content for fallback</span>
        <span class="hljs-keyword inline">const</span> rawContent = content;

        <span class="hljs-comment inline">// Clean content - remove &quot;(Parsing required)&quot; and other unwanted text</span>
        <span class="hljs-keyword inline">let</span> cleanedContent = <span class="hljs-variable language_ inline">this</span>.<span class="hljs-title function_ inline">cleanResponseContent</span>(content);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Content Cleaning</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">AI-generated content may contain:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed">Extra markers: <code>(Parsing required)</code></li>
<li class="text-foreground leading-relaxed">Format errors: Excessive blank lines</li>
<li class="text-foreground leading-relaxed">Irrelevant content: Additional explanatory text</li>
</ul>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="cleanResponseContent(content)%20%7B%0Aif%20(!content)%20return%20''%3B%0Alet%20cleaned%20%3D%20content%3B%0A%2F%2F%20Remove%20%22(Parsing%20required)%22%20text%0Acleaned%20%3D%20cleaned.replace(%2F%5C(Parsing%20required%5C)%2Fgi%2C%20'')%3B%0A%2F%2F%20Remove%20excessive%20whitespace%20while%20maintaining%20structure%0Acleaned%20%3D%20cleaned.replace(%2F%5Cn%7B3%2C%7D%2Fg%2C%20'%5Cn%5Cn')%3B%0A%2F%2F%20Remove%20leading%2Ftrailing%20whitespace%20from%20each%20line%20while%20maintaining%20overall%20structure%0Acleaned%20%3D%20cleaned.split('%5Cn')%0A.map(line%20%3D%3E%20line.trim())%0A.join('%5Cn')%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-title function_ inline">cleanResponseContent</span>(<span class="hljs-params inline">content</span>) {
    <span class="hljs-keyword inline">if</span> (!content) <span class="hljs-keyword inline">return</span> <span class="hljs-string inline">&#x27;&#x27;</span>;

    <span class="hljs-keyword inline">let</span> cleaned = content;

    <span class="hljs-comment inline">// Remove &quot;(Parsing required)&quot; text</span>
    cleaned = cleaned.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-regexp inline">/\(Parsing required\)/gi</span>, <span class="hljs-string inline">&#x27;&#x27;</span>);

    <span class="hljs-comment inline">// Remove excessive whitespace while maintaining structure</span>
    cleaned = cleaned.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-regexp inline">/\n{3,}/g</span>, <span class="hljs-string inline">&#x27;\n\n&#x27;</span>);

    <span class="hljs-comment inline">// Remove leading/trailing whitespace from each line while maintaining overall structure</span>
    cleaned = cleaned.<span class="hljs-title function_ inline">split</span>(<span class="hljs-string inline">&#x27;\n&#x27;</span>)
        .<span class="hljs-title function_ inline">map</span>(<span class="hljs-function inline"><span class="hljs-params inline">line</span> =&gt;</span> line.<span class="hljs-title function_ inline">trim</span>())
        .<span class="hljs-title function_ inline">join</span>(<span class="hljs-string inline">&#x27;\n&#x27;</span>);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Cleaning Algorithm Design Philosophy</strong>:</p>
<ol class="list-decimal list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Preserve Structure</strong>: Don’t break original paragraph structure</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Remove Noise</strong>: Remove AI-generated marker text</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Standardize Whitespace</strong>: Unify blank lines and indentation</li>
</ol>
<h3 id="partial-parsing-fault-tolerance-mechanism" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#partial-parsing-fault-tolerance-mechanism" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Partial Parsing Fault Tolerance Mechanism">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Partial Parsing Fault Tolerance Mechanism
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="%2F%2F%20Track%20which%20markers%20exist%0Aconst%20markerPresence%20%3D%20%7B%0AgrammarAnalysis%3A%20cleanedContent.includes(grammarAnalysisMarker)%2C%0AgrammarCorrection%3A%20cleanedContent.includes(grammarCorrectionMarker)%2C%0AkeywordAnalysis%3A%20cleanedContent.includes(keywordAnalysisMarker)%2C%0AchineseDefinition%3A%20cleanedContent.includes(chineseDefinitionMarker)%0A%7D%3B%0Aconst%20presentMarkers%20%3D%20Object.values(markerPresence).filter(Boolean).length%3B%0A%2F%2F%20If%20no%20markers%20exist%2C%20this%20is%20complete%20failure%0Aif%20(presentMarkers%20%3D%3D%3D%200)%20%7B%0Areturn%20%7B%0AisValid%3A%20false%2C%0Aerror%3A%20i18n.t('ai.noValidMarkers'%2C%20locale)%20%2B%20%60%20%7C%20Response%20preview%3A%20%22%24%7BcleanedContent.substring(0%2C%20200)%7D...%22%60%2C%0AgrammarAnalysis%3A%20''%2C%0AgrammarCorrection%3A%20''%2C%0AkeywordAnalysis%3A%20''%2C%0AchineseDefinition%3A%20''%2C%0ArawResponseContent%3A%20rawContent%0A%7D%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-comment inline">// Track which markers exist</span>
<span class="hljs-keyword inline">const</span> markerPresence = {
    <span class="hljs-attr inline">grammarAnalysis</span>: cleanedContent.<span class="hljs-title function_ inline">includes</span>(grammarAnalysisMarker),
    <span class="hljs-attr inline">grammarCorrection</span>: cleanedContent.<span class="hljs-title function_ inline">includes</span>(grammarCorrectionMarker),
    <span class="hljs-attr inline">keywordAnalysis</span>: cleanedContent.<span class="hljs-title function_ inline">includes</span>(keywordAnalysisMarker),
    <span class="hljs-attr inline">chineseDefinition</span>: cleanedContent.<span class="hljs-title function_ inline">includes</span>(chineseDefinitionMarker)
};

<span class="hljs-keyword inline">const</span> presentMarkers = <span class="hljs-title class_ inline">Object</span>.<span class="hljs-title function_ inline">values</span>(markerPresence).<span class="hljs-title function_ inline">filter</span>(<span class="hljs-title class_ inline">Boolean</span>).<span class="hljs-property inline">length</span>;

<span class="hljs-comment inline">// If no markers exist, this is complete failure</span>
<span class="hljs-keyword inline">if</span> (presentMarkers === <span class="hljs-number inline">0</span>) {
    <span class="hljs-keyword inline">return</span> {
        <span class="hljs-attr inline">isValid</span>: <span class="hljs-literal inline">false</span>,
        <span class="hljs-attr inline">error</span>: i18n.<span class="hljs-title function_ inline">t</span>(<span class="hljs-string inline">&#x27;ai.noValidMarkers&#x27;</span>, locale) + <span class="hljs-string inline">` | Response preview: &quot;<span class="hljs-subst inline">${cleanedContent.substring(<span class="hljs-number inline">0</span>, <span class="hljs-number inline">200</span>)}</span>...&quot;`</span>,
        <span class="hljs-attr inline">grammarAnalysis</span>: <span class="hljs-string inline">&#x27;&#x27;</span>,
        <span class="hljs-attr inline">grammarCorrection</span>: <span class="hljs-string inline">&#x27;&#x27;</span>,
        <span class="hljs-attr inline">keywordAnalysis</span>: <span class="hljs-string inline">&#x27;&#x27;</span>,
        <span class="hljs-attr inline">chineseDefinition</span>: <span class="hljs-string inline">&#x27;&#x27;</span>,
        <span class="hljs-attr inline">rawResponseContent</span>: rawContent
    };
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Partial Parsing Philosophy</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">Better to give users some useful information than to completely reject due to incomplete format.</p>
<h2 id="parsestructuredresponse-structured-parsing" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#parsestructuredresponse-structured-parsing" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to parseStructuredResponse Structured Parsing">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            parseStructuredResponse Structured Parsing
        </h2>
<h3 id="structured-marker-extraction-logic" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#structured-marker-extraction-logic" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Structured Marker Extraction Logic">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Structured Marker Extraction Logic
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="parseStructuredResponse(content%2C%20locale%20%3D%20'en')%20%7B%0Atry%20%7B%0Aconst%20%7BsentenceMarker%2C%20grammarMarker%2C%20chineseMarker%2C%20endMarker%7D%20%3D%20this.responseFormat%3B%0A%2F%2F%20Store%20original%20content%20for%20fallback%0Aconst%20rawContent%20%3D%20content%3B%0A%2F%2F%20Clean%20content%20-%20remove%20%22(Parsing%20required)%22%20and%20other%20unwanted%20text%0Alet%20cleanedContent%20%3D%20this.cleanResponseContent(content)%3B%0A%2F%2F%20If%20END_FORMAT%20is%20missing%20but%20other%20markers%20exist%2C%20add%20it%0Aif%20(!cleanedContent.includes(endMarker))%20%7B%0Aconst%20hasOtherMarkers%20%3D%20%5BsentenceMarker%2C%20grammarMarker%2C%20chineseMarker%5D%0A.some(marker%20%3D%3E%20cleanedContent.includes(marker))%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-title function_ inline">parseStructuredResponse</span>(<span class="hljs-params inline">content, locale = <span class="hljs-string inline">&#x27;en&#x27;</span></span>) {
    <span class="hljs-keyword inline">try</span> {
        <span class="hljs-keyword inline">const</span> {sentenceMarker, grammarMarker, chineseMarker, endMarker} = <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">responseFormat</span>;

        <span class="hljs-comment inline">// Store original content for fallback</span>
        <span class="hljs-keyword inline">const</span> rawContent = content;

        <span class="hljs-comment inline">// Clean content - remove &quot;(Parsing required)&quot; and other unwanted text</span>
        <span class="hljs-keyword inline">let</span> cleanedContent = <span class="hljs-variable language_ inline">this</span>.<span class="hljs-title function_ inline">cleanResponseContent</span>(content);

        <span class="hljs-comment inline">// If END_FORMAT is missing but other markers exist, add it</span>
        <span class="hljs-keyword inline">if</span> (!cleanedContent.<span class="hljs-title function_ inline">includes</span>(endMarker)) {
            <span class="hljs-keyword inline">const</span> hasOtherMarkers = [sentenceMarker, grammarMarker, chineseMarker]
                .<span class="hljs-title function_ inline">some</span>(<span class="hljs-function inline"><span class="hljs-params inline">marker</span> =&gt;</span> cleanedContent.<span class="hljs-title function_ inline">includes</span>(marker));
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Auto-Fix Mechanism</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">System automatically adds missing end markers, this detection and fix logic can greatly improve parsing success rate:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="typescript" data-code="%2F%2F%20Auto-fix%20logic%0Aif%20(!cleanedContent.includes(endMarker))%20%7B%0Aconst%20hasOtherMarkers%20%3D%20%5BsentenceMarker%2C%20grammarMarker%2C%20chineseMarker%5D%0A.some(marker%20%3D%3E%20cleanedContent.includes(marker))%3B%0Aif%20(hasOtherMarkers)%20%7B%0AcleanedContent%20%2B%3D%20%60%5Cn%5Cn%24%7BendMarker%7D%60%3B%20%20%2F%2F%20Auto-add%20end%20marker%0A%7D%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">typescript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-typescript"><span class="hljs-comment inline">// Auto-fix logic</span>
<span class="hljs-keyword inline">if</span> (!cleanedContent.<span class="hljs-title function_ inline">includes</span>(endMarker)) {
    <span class="hljs-keyword inline">const</span> hasOtherMarkers = [sentenceMarker, grammarMarker, chineseMarker]
        .<span class="hljs-title function_ inline">some</span>(<span class="hljs-function inline"><span class="hljs-params inline">marker</span> =&gt;</span> cleanedContent.<span class="hljs-title function_ inline">includes</span>(marker));

    <span class="hljs-keyword inline">if</span> (hasOtherMarkers) {
        cleanedContent += <span class="hljs-string inline">`\n\n<span class="hljs-subst inline">${endMarker}</span>`</span>;  <span class="hljs-comment inline">// Auto-add end marker</span>
    }
}
</code></pre>
            </div>
        
<h3 id="response-validation-mechanism" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#response-validation-mechanism" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Response Validation Mechanism">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Response Validation Mechanism
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="extractSectionsRobust(content%2C%20markers)%20%7B%0Aconst%20sections%20%3D%20%7B%7D%3B%0A%2F%2F%20For%20sentence%20check%20response%0Aif%20(markers.grammarAnalysisMarker)%20%7B%0Asections.grammarAnalysis%20%3D%20this.extractSection(%0Acontent%2C%0Amarkers.grammarAnalysisMarker%2C%0A%5Bmarkers.grammarCorrectionMarker%2C%20markers.keywordAnalysisMarker%2C%20markers.chineseDefinitionMarker%2C%20markers.endMarker%5D%0A)%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-title function_ inline">extractSectionsRobust</span>(<span class="hljs-params inline">content, markers</span>) {
    <span class="hljs-keyword inline">const</span> sections = {};

    <span class="hljs-comment inline">// For sentence check response</span>
    <span class="hljs-keyword inline">if</span> (markers.<span class="hljs-property inline">grammarAnalysisMarker</span>) {
        sections.<span class="hljs-property inline">grammarAnalysis</span> = <span class="hljs-variable language_ inline">this</span>.<span class="hljs-title function_ inline">extractSection</span>(
            content,
            markers.<span class="hljs-property inline">grammarAnalysisMarker</span>,
            [markers.<span class="hljs-property inline">grammarCorrectionMarker</span>, markers.<span class="hljs-property inline">keywordAnalysisMarker</span>, markers.<span class="hljs-property inline">chineseDefinitionMarker</span>, markers.<span class="hljs-property inline">endMarker</span>]
        );
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Robust Extraction Algorithm Design</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">Each section extraction uses priority queue thinking:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="typescript" data-code="extractSection(content%2C%20startMarker%2C%20endMarkers%20%3D%20%5B%5D)%20%7B%0Aconst%20startIndex%20%3D%20content.indexOf(startMarker)%3B%0Aif%20(startIndex%20%3D%3D%3D%20-1)%20%7B%0Areturn%20null%3B%20%2F%2F%20Marker%20not%20found%0A%7D%0Aconst%20contentStart%20%3D%20startIndex%20%2B%20startMarker.length%3B%0A%2F%2F%20Find%20earliest%20end%20marker%0Alet%20endIndex%20%3D%20content.length%3B%20%2F%2F%20Default%20to%20content%20end%0Afor%20(const%20endMarker%20of%20endMarkers)%20%7B%0Aconst%20markerIndex%20%3D%20content.indexOf(endMarker%2C%20contentStart)%3B%0Aif%20(markerIndex%20!%3D%3D%20-1%20%26%26%20markerIndex%20%2F%2F%20Update%20to%20earlier%20position%0A%7D%0A%7D%0Aconst%20extractedContent%20%3D%20content.substring(contentStart%2C%20endIndex).trim()%3B%0Areturn%20extractedContent.length%20%3E%3D%205%20%3F%20extractedContent%20%3A%20null%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">typescript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-typescript"><span class="hljs-title function_ inline">extractSection</span>(<span class="hljs-params inline">content, startMarker, endMarkers = []</span>) {
    <span class="hljs-keyword inline">const</span> startIndex = content.<span class="hljs-title function_ inline">indexOf</span>(startMarker);
    <span class="hljs-keyword inline">if</span> (startIndex === -<span class="hljs-number inline">1</span>) {
        <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>; <span class="hljs-comment inline">// Marker not found</span>
    }

    <span class="hljs-keyword inline">const</span> contentStart = startIndex + startMarker.<span class="hljs-property inline">length</span>;

    <span class="hljs-comment inline">// Find earliest end marker</span>
    <span class="hljs-keyword inline">let</span> endIndex = content.<span class="hljs-property inline">length</span>; <span class="hljs-comment inline">// Default to content end</span>

    <span class="hljs-keyword inline">for</span> (<span class="hljs-keyword inline">const</span> endMarker <span class="hljs-keyword inline">of</span> endMarkers) {
        <span class="hljs-keyword inline">const</span> markerIndex = content.<span class="hljs-title function_ inline">indexOf</span>(endMarker, contentStart);
        <span class="hljs-keyword inline">if</span> (markerIndex !== -<span class="hljs-number inline">1</span> &amp;&amp; markerIndex &lt; endIndex) {
            endIndex = markerIndex;  <span class="hljs-comment inline">// Update to earlier position</span>
        }
    }

    <span class="hljs-keyword inline">const</span> extractedContent = content.<span class="hljs-title function_ inline">substring</span>(contentStart, endIndex).<span class="hljs-title function_ inline">trim</span>();
    <span class="hljs-keyword inline">return</span> extractedContent.<span class="hljs-property inline">length</span> &gt;= <span class="hljs-number inline">5</span> ? extractedContent : <span class="hljs-literal inline">null</span>;
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Algorithm Complexity Analysis</strong>:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Time Complexity</strong>: O(n × m), where n is content length, m is number of end markers</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Space Complexity</strong>: O(1), no additional storage space needed</li>
</ul>
<h3 id="data-cleaning-and-formatting" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#data-cleaning-and-formatting" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Data Cleaning and Formatting">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Data Cleaning and Formatting
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="%2F%2F%20Clean%20potential%20markdown%20traces%20that%20may%20interfere%0Acleaned%20%3D%20cleaned.replace(%2F%60%60%60%5B%5Cs%5CS%5D*%3F%60%60%60%2Fg%2C%20'')%3B%20%2F%2F%20Remove%20code%20blocks%0Acleaned%20%3D%20cleaned.replace(%2F%5E%5Cs*%23%7B1%2C6%7D%5Cs*%2Fgm%2C%20'')%3B%20%2F%2F%20Remove%20markdown%20headers%0Areturn%20cleaned.trim()%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-comment inline">// Clean potential markdown traces that may interfere</span>
cleaned = cleaned.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-regexp inline">/```[\s\S]*?```/g</span>, <span class="hljs-string inline">&#x27;&#x27;</span>); <span class="hljs-comment inline">// Remove code blocks</span>
cleaned = cleaned.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-regexp inline">/^\s*#{1,6}\s*/gm</span>, <span class="hljs-string inline">&#x27;&#x27;</span>); <span class="hljs-comment inline">// Remove markdown headers</span>

<span class="hljs-keyword inline">return</span> cleaned.<span class="hljs-title function_ inline">trim</span>();
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Cleaning Rule Design Principles</strong>:</p>
<ol class="list-decimal list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Preserve Content</strong>: Don’t delete meaningful text</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Remove Interference</strong>: Delete formatting markers</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Standardize</strong>: Unify whitespace character handling</li>
</ol>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Regex Performance Considerations</strong>:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="typescript" data-code="%2F%2F%20Code%20block%20cleaning%0Acleaned%20%3D%20cleaned.replace(%2F%60%60%60%5B%5Cs%5CS%5D*%3F%60%60%60%2Fg%2C%20'')%3B%0A%2F%2F%20Header%20cleaning%0Acleaned%20%3D%20cleaned.replace(%2F%5E%5Cs*%23%7B1%2C6%7D%5Cs*%2Fgm%2C%20'')%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">typescript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-typescript"><span class="hljs-comment inline">// Code block cleaning</span>
cleaned = cleaned.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-regexp inline">/```[\s\S]*?```/g</span>, <span class="hljs-string inline">&#x27;&#x27;</span>);

<span class="hljs-comment inline">// Header cleaning</span>
cleaned = cleaned.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-regexp inline">/^\s*#{1,6}\s*/gm</span>, <span class="hljs-string inline">&#x27;&#x27;</span>);
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">Performance characteristics of these regex patterns:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Non-greedy Matching</strong>: <code>*?</code> ensures minimal matching</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Multiline Mode</strong>: <code>m</code> flag handles multiline text</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Character Classes</strong>: <code>\s</code> more efficient than <code>[ \t\n\r]</code></li>
</ul>
<h2 id="complete-parsing-flow-architecture-design" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#complete-parsing-flow-architecture-design" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Complete Parsing Flow Architecture Design">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Complete Parsing Flow Architecture Design
        </h2>
<h3 id="lifecycle-from-template-loading-to-response-parsing" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#lifecycle-from-template-loading-to-response-parsing" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Lifecycle from Template Loading to Response Parsing">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Lifecycle from Template Loading to Response Parsing
        </h3>
<p class="text-base leading-7 mb-4 text-foreground">Complete request flow:</p>
<div class="mermaid block" id="mermaid-1765780612231-oy5xzpv">graph TD
    A[User Request] --> B[AIService.checkSentence]
    B --> C[promptLoader.getSentenceCheckPrompt]
    C --> D[loadPrompt cache lookup]
    D --> E{Cache hit?}
    E -->|Yes| F[Return cached content]
    E -->|No| G[Read file]
    G --> H[Cache storage]
    H --> I[Template variable replacement]
    I --> J[Send AI request]
    J --> K[Receive AI response]
    K --> L[parseSentenceCheckResponse]
    L --> M[Content cleaning]
    M --> N[Marker recognition]
    N --> O[Section extraction]
    O --> P[Integrity validation]
    P --> Q[Return structured result]</div>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Component Responsibilities</strong>:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">PromptLoader</strong>: Responsible for template management and caching</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">AIService</strong>: Responsible for request processing and response parsing</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">HttpUtils</strong>: Responsible for HTTP request encapsulation</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">i18n</strong>: Responsible for internationalization and error messages</li>
</ul>
<h3 id="data-flow-and-state-management" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#data-flow-and-state-management" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Data Flow and State Management">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Data Flow and State Management
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="typescript" data-code="%2F%2F%20Data%20flow%20TypeScript%20type%20definitions%0Ainterface%20RequestFlow%20%7B%0Ainput%3A%20%7B%0Asentence%3A%20string%3B%0AuserId%3F%3A%20string%3B%0AgrammarLanguageOption%3A%20'pure'%20%7C%20'combined'%3B%0A%7D%3B%0Aprocessing%3A%20%7B%0ApromptTemplate%3A%20string%3B%0AfilledPrompt%3A%20string%3B%0AaiResponse%3A%20string%3B%0AcleanedContent%3A%20string%3B%0A%7D%3B%0Aoutput%3A%20%7B%0AgrammarAnalysis%3A%20string%3B%0AgrammarCorrection%3A%20string%3B%0AkeywordAnalysis%3A%20string%3B%0AchineseDefinition%3A%20string%3B%0Asuccess%3A%20boolean%3B%0Aerror%3F%3A%20string%3B%0A%7D%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">typescript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-typescript"><span class="hljs-comment inline">// Data flow TypeScript type definitions</span>
<span class="hljs-keyword inline">interface</span> <span class="hljs-title class_ inline">RequestFlow</span> {
    <span class="hljs-attr inline">input</span>: {
        <span class="hljs-attr inline">sentence</span>: <span class="hljs-built_in inline">string</span>;
        <span class="hljs-attr inline">userId</span>?: <span class="hljs-built_in inline">string</span>;
        <span class="hljs-attr inline">grammarLanguageOption</span>: <span class="hljs-string inline">&#x27;pure&#x27;</span> | <span class="hljs-string inline">&#x27;combined&#x27;</span>;
    };
    
    <span class="hljs-attr inline">processing</span>: {
        <span class="hljs-attr inline">promptTemplate</span>: <span class="hljs-built_in inline">string</span>;
        <span class="hljs-attr inline">filledPrompt</span>: <span class="hljs-built_in inline">string</span>;
        <span class="hljs-attr inline">aiResponse</span>: <span class="hljs-built_in inline">string</span>;
        <span class="hljs-attr inline">cleanedContent</span>: <span class="hljs-built_in inline">string</span>;
    };
    
    <span class="hljs-attr inline">output</span>: {
        <span class="hljs-attr inline">grammarAnalysis</span>: <span class="hljs-built_in inline">string</span>;
        <span class="hljs-attr inline">grammarCorrection</span>: <span class="hljs-built_in inline">string</span>;
        <span class="hljs-attr inline">keywordAnalysis</span>: <span class="hljs-built_in inline">string</span>;
        <span class="hljs-attr inline">chineseDefinition</span>: <span class="hljs-built_in inline">string</span>;
        <span class="hljs-attr inline">success</span>: <span class="hljs-built_in inline">boolean</span>;
        <span class="hljs-attr inline">error</span>?: <span class="hljs-built_in inline">string</span>;
    };
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Immutable State Management</strong>:</p>
<p class="text-base leading-7 mb-4 text-foreground">Each processing step produces new state rather than modifying existing state:</p>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="typescript" data-code="%2F%2F%20Immutable%20state%20transitions%0Aconst%20state1%20%3D%20%7B%20content%3A%20rawContent%20%7D%3B%0Aconst%20state2%20%3D%20%7B%20...state1%2C%20content%3A%20cleanedContent%20%7D%3B%0Aconst%20state3%20%3D%20%7B%20...state2%2C%20sections%3A%20extractedSections%20%7D%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">typescript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-typescript"><span class="hljs-comment inline">// Immutable state transitions</span>
<span class="hljs-keyword inline">const</span> state1 = { <span class="hljs-attr inline">content</span>: rawContent };
<span class="hljs-keyword inline">const</span> state2 = { ...state1, <span class="hljs-attr inline">content</span>: cleanedContent };
<span class="hljs-keyword inline">const</span> state3 = { ...state2, <span class="hljs-attr inline">sections</span>: extractedSections };
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground">Advantages of this design:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Debug Friendly</strong>: Each state can be independently inspected</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Error Tracking</strong>: Easy to locate where problems occur</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Concurrency Safe</strong>: Avoid state race conditions</li>
</ul>
<h2 id="system-architecture-diagram-and-technical-points-summary" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#system-architecture-diagram-and-technical-points-summary" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to System Architecture Diagram and Technical Points Summary">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            System Architecture Diagram and Technical Points Summary
        </h2>
<h3 id="complete-system-architecture-flow-chart" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#complete-system-architecture-flow-chart" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Complete System Architecture Flow Chart">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Complete System Architecture Flow Chart
        </h3>
<div class="mermaid block" id="mermaid-1765780612231-5vmgmo3">graph TB
    subgraph "User Request Layer"
        A[User Input] --> B[API Routes]
    end
    
    subgraph "Business Logic Layer"
        B --> C[AIService]
        C --> D[Dynamic Model Selection]
        D --> E[Prompt Loading]
    end
    
    subgraph "Prompt Management Layer"
        E --> F[PromptLoader]
        F --> G{Cache Hit?}
        G -->|Yes| H[Return Cache]
        G -->|No| I[File Reading]
        I --> J[Cache Update]
        J --> K[Template Replacement]
    end
    
    subgraph "AI Interaction Layer"
        K --> L[HTTP Request]
        L --> M[AI Response]
        M --> N[Response Parsing]
    end
    
    subgraph "Parsing Processing Layer"
        N --> O[Content Cleaning]
        O --> P[Marker Recognition]
        P --> Q[Section Extraction]
        Q --> R[Integrity Validation]
        R --> S[Structured Output]
    end
    
    subgraph "Fault Tolerance Layer"
        I --> T{File Exists?}
        T -->|Yes| J
        T -->|No| U[Fallback Strategy]
        U --> V[Combined Version]
        V --> W{Load Success?}
        W -->|Yes| J
        W -->|No| X[Error Handling]
        N --> Y{Parse Success?}
        Y -->|Yes| S
        Y -->|No| Z[Partial Parsing]
    end
    
    S --> AA[Return Result]
    X --> AA
    Z --> AA
    H --> K</div>
<h2 id="complete-source-code-full-analysis" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#complete-source-code-full-analysis" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Complete Source Code Full Analysis">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Complete Source Code Full Analysis
        </h2>
<h3 id="promptloader-complete-source-code-analysis" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#promptloader-complete-source-code-analysis" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to PromptLoader Complete Source Code Analysis">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            PromptLoader Complete Source Code Analysis
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Dependency%20Imports%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0Aconst%20fs%20%3D%20require('fs')%3B%20%20%20%20%20%20%20%20%2F%2F%20Node.js%20file%20system%20module%20for%20file%20operations%0Aconst%20path%20%3D%20require('path')%3B%20%20%20%20%2F%2F%20Node.js%20path%20module%20for%20cross-platform%20path%20handling%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20PromptLoader%20Core%20Class%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0Aclass%20PromptLoader%20%7B%0Aconstructor()%20%7B%0A%2F%2F%20Use%20Map%20instead%20of%20Object%20for%20cache%20storage%2C%20gaining%20better%20performance%20and%20type%20safety%0Athis.promptCache%20%3D%20new%20Map()%3B%0A%2F%2F%20Use%20path.join%20to%20ensure%20cross-platform%20path%20compatibility%0A%2F%2F%20__dirname%20points%20to%20current%20file%20directory%2C%20..%2Fprompts%20points%20to%20prompts%20folder%0Athis.promptsDir%20%3D%20path.join(__dirname%2C%20'..%2Fprompts')%3B%0A%7D%0A%2F**%0A*%20Core%20method%3A%20Load%20prompt%20template%20from%20file%20and%20cache%0A*%20%40param%20%7Bstring%7D%20type%20-%20Prompt%20type%20('sentence-check'%20or%20'sentence-generation')%0A*%20%40param%20%7Bstring%7D%20grammarLanguageOption%20-%20Grammar%20language%20option%20('combined'%20or%20'pure')%0A*%20%40returns%20%7Bstring%7D%20Prompt%20template%20string%0A*%2F%0AloadPrompt(type%2C%20grammarLanguageOption%20%3D%20'combined')%20%7B%0A%2F%2F%20Construct%20cache%20key%3A%20composite%20key%20of%20type-language%20option%0A%2F%2F%20Example%3A%20'sentence-check-combined'%2C%20'sentence-generation-pure'%0Aconst%20cacheKey%20%3D%20%60%24%7Btype%7D-%24%7BgrammarLanguageOption%7D%60%3B%0A%2F%2F%20Cache-first%20strategy%3A%20if%20exists%20in%20cache%2C%20return%20directly%0A%2F%2F%20Map.has()%20and%20Map.get()%20are%20both%20O(1)%20time%20complexity%0Aif%20(this.promptCache.has(cacheKey))%20%7B%0Areturn%20this.promptCache.get(cacheKey)%3B%0A%7D%0Atry%20%7B%0A%2F%2F%20Construct%20filename%20according%20to%20convention%3A%20type-option.txt%0Aconst%20filename%20%3D%20%60%24%7Btype%7D-%24%7BgrammarLanguageOption%7D.txt%60%3B%0A%2F%2F%20Construct%20complete%20file%20path%2C%20path.join%20automatically%20handles%20path%20separators%0Aconst%20filepath%20%3D%20path.join(this.promptsDir%2C%20filename)%3B%0A%2F%2F%20Defensive%20programming%3A%20check%20file%20existence%20first%0A%2F%2F%20Avoid%20fs.readFileSync%20throwing%20hard-to-understand%20ENOENT%20errors%0Aif%20(!fs.existsSync(filepath))%20%7B%0Athrow%20new%20Error(%60Prompt%20file%20not%20found%3A%20%24%7Bfilepath%7D%60)%3B%0A%7D%0A%2F%2F%20Synchronously%20read%20file%20content%2C%20use%20utf8%20encoding%20to%20ensure%20Chinese%20displays%20correctly%0Aconst%20promptTemplate%20%3D%20fs.readFileSync(filepath%2C%20'utf8')%3B%0A%2F%2F%20Cache%20strategy%3A%20only%20successfully%20read%20content%20gets%20cached%0A%2F%2F%20Avoid%20caching%20errors%20or%20incomplete%20data%0Athis.promptCache.set(cacheKey%2C%20promptTemplate)%3B%0Areturn%20promptTemplate%3B%0A%7D%20catch%20(error)%20%7B%0A%2F%2F%20Error%20handling%20first%20layer%3A%20log%20detailed%20error%20information%0Aconsole.error(%60Error%20loading%20prompt%20%24%7Btype%7D-%24%7BgrammarLanguageOption%7D%3A%60%2C%20error.message)%3B%0A%2F%2F%20Fallback%20strategy%3A%20if%20pure%20version%20fails%2C%20try%20combined%20version%0A%2F%2F%20This%20is%20an%20elegant%20fallback%20mechanism%20ensuring%20service%20availability%0Aif%20(grammarLanguageOption%20%3D%3D%3D%20'pure')%20%7B%0Aconsole.warn(%60Falling%20back%20to%20combined%20prompt%20for%20%24%7Btype%7D%60)%3B%0A%2F%2F%20Recursive%20call%20to%20self%2C%20but%20using%20combined%20option%0Areturn%20this.loadPrompt(type%2C%20'combined')%3B%0A%7D%0A%2F%2F%20Error%20handling%20final%20defense%3A%20if%20combined%20version%20also%20fails%2C%20throw%20clear%20error%0Athrow%20new%20Error(%60Failed%20to%20load%20prompt%20template%3A%20%24%7Btype%7D-%24%7BgrammarLanguageOption%7D%60)%3B%0A%7D%0A%7D%0A%2F**%0A*%20Get%20sentence%20check%20prompt%20(with%20variable%20replacement)%0A*%20%40param%20%7Bstring%7D%20sentence%20-%20Sentence%20to%20analyze%0A*%20%40param%20%7Bstring%7D%20grammarLanguageOption%20-%20Language%20option%0A*%20%40returns%20%7Bstring%7D%20Formatted%20prompt%0A*%2F%0AgetSentenceCheckPrompt(sentence%2C%20grammarLanguageOption%20%3D%20'combined')%20%7B%0A%2F%2F%20Get%20template%20first%2C%20leveraging%20loadPrompt's%20cache%20mechanism%0Aconst%20template%20%3D%20this.loadPrompt('sentence-check'%2C%20grammarLanguageOption)%3B%0A%2F%2F%20Simple%20and%20effective%20template%20variable%20replacement%0A%2F%2F%20Use%20String.replace%20instead%20of%20complex%20template%20engine%2C%20reducing%20dependencies%20and%20complexity%0Areturn%20template.replace('%7Bsentence%7D'%2C%20sentence)%3B%0A%7D%0A%2F**%0A*%20Get%20sentence%20generation%20prompt%20(with%20variable%20replacement)%0A*%20%40param%20%7BArray%7D%20words%20-%20Array%20of%20words%20to%20use%0A*%20%40param%20%7Bstring%7D%20grammarLanguageOption%20-%20Language%20option%0A*%20%40returns%20%7Bstring%7D%20Formatted%20prompt%0A*%2F%0AgetSentenceGenerationPrompt(words%2C%20grammarLanguageOption%20%3D%20'combined')%20%7B%0Aconst%20template%20%3D%20this.loadPrompt('sentence-generation'%2C%20grammarLanguageOption)%3B%0A%2F%2F%20Type-safe%20array%20handling%3A%20ensure%20words%20is%20array%20before%20joining%0A%2F%2F%20If%20not%20array%2C%20use%20original%20value%20directly%0Aconst%20wordsString%20%3D%20Array.isArray(words)%20%3F%20words.join('%2C%20')%20%3A%20words%3B%0Areturn%20template.replace('%7Bwords%7D'%2C%20wordsString)%3B%0A%7D%0A%2F**%0A*%20Clear%20cache%20(useful%20for%20development%20and%20testing)%0A*%2F%0AclearCache()%20%7B%0A%2F%2F%20Map.clear()%20is%20O(1)%20operation%2C%20directly%20clear%20all%20cache%0Athis.promptCache.clear()%3B%0A%7D%0A%2F**%0A*%20Get%20cache%20status%20information%20(for%20debugging)%0A*%20%40returns%20%7BObject%7D%20Information%20containing%20cache%20size%20and%20cached%20items%0A*%2F%0AgetCacheInfo()%20%7B%0Areturn%20%7B%0A%2F%2F%20Map.size%20is%20O(1)%20operation%2C%20get%20number%20of%20cached%20items%0AcacheSize%3A%20this.promptCache.size%2C%0A%2F%2F%20Convert%20Map%20keys%20to%20array%20for%20easy%20debugging%20inspection%0AcachedPrompts%3A%20Array.from(this.promptCache.keys())%0A%7D%3B%0A%7D%0A%2F**%0A*%20Validate%20all%20required%20prompt%20files%20exist%0A*%20%40returns%20%7BObject%7D%20Validation%20result%2C%20containing%20existing%2Fmissing%20file%20lists%0A*%2F%0AvalidatePromptFiles()%20%7B%0A%2F%2F%20Define%20system%20required%20prompt%20file%20list%0A%2F%2F%20This%20array%20defines%20system%20integrity%20requirements%0Aconst%20requiredPrompts%20%3D%20%5B%0A'sentence-check-pure.txt'%2C%0A'sentence-check-combined.txt'%2C%0A'sentence-generation-pure.txt'%2C%0A'sentence-generation-combined.txt'%0A%5D%3B%0Aconst%20missing%20%3D%20%5B%5D%3B%20%20%20%2F%2F%20Missing%20files%0Aconst%20existing%20%3D%20%5B%5D%3B%20%20%2F%2F%20Existing%20files%0A%2F%2F%20Iterate%20through%20all%20required%20files%2C%20check%20existence%0Afor%20(const%20filename%20of%20requiredPrompts)%20%7B%0Aconst%20filepath%20%3D%20path.join(this.promptsDir%2C%20filename)%3B%0A%2F%2F%20fs.existsSync%20is%20synchronous%20check%2C%20suitable%20for%20one-time%20validation%20at%20startup%0Aif%20(fs.existsSync(filepath))%20%7B%0Aexisting.push(filename)%3B%0A%7D%20else%20%7B%0Amissing.push(filename)%3B%0A%7D%0A%7D%0Areturn%20%7B%0A%2F%2F%20System%20integrity%20flag%3A%20only%20true%20when%20all%20files%20exist%0Avalid%3A%20missing.length%20%3D%3D%3D%200%2C%0Aexisting%2C%0Amissing%2C%0A%2F%2F%20Provide%20prompts%20directory%20path%20for%20ops%20personnel%20to%20locate%20issues%0ApromptsDirectory%3A%20this.promptsDir%0A%7D%3B%0A%7D%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Module%20Export%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%2F%2F%20Export%20singleton%20instance%20instead%20of%20class%20itself%0A%2F%2F%20This%20ensures%20only%20one%20PromptLoader%20instance%20globally%2C%20saving%20memory%20and%20ensuring%20cache%20consistency%0Amodule.exports%20%3D%20new%20PromptLoader()%3B">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-comment inline">// ==================== Dependency Imports ====================</span>
<span class="hljs-keyword inline">const</span> fs = <span class="hljs-built_in inline">require</span>(<span class="hljs-string inline">&#x27;fs&#x27;</span>);        <span class="hljs-comment inline">// Node.js file system module for file operations</span>
<span class="hljs-keyword inline">const</span> path = <span class="hljs-built_in inline">require</span>(<span class="hljs-string inline">&#x27;path&#x27;</span>);    <span class="hljs-comment inline">// Node.js path module for cross-platform path handling</span>

<span class="hljs-comment inline">// ==================== PromptLoader Core Class ====================</span>
<span class="hljs-keyword inline">class</span> <span class="hljs-title class_ inline">PromptLoader</span> {
    <span class="hljs-title function_ inline">constructor</span>(<span class="hljs-params inline"></span>) {
        <span class="hljs-comment inline">// Use Map instead of Object for cache storage, gaining better performance and type safety</span>
        <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptCache</span> = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">Map</span>();
        
        <span class="hljs-comment inline">// Use path.join to ensure cross-platform path compatibility</span>
        <span class="hljs-comment inline">// __dirname points to current file directory, ../prompts points to prompts folder</span>
        <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptsDir</span> = path.<span class="hljs-title function_ inline">join</span>(__dirname, <span class="hljs-string inline">&#x27;../prompts&#x27;</span>);
    }

    <span class="hljs-comment inline">/**
     * Core method: Load prompt template from file and cache
     * <span class="hljs-doctag inline">@param</span> {<span class="hljs-type inline">string</span>} <span class="hljs-variable inline">type</span> - Prompt type (&#x27;sentence-check&#x27; or &#x27;sentence-generation&#x27;)
     * <span class="hljs-doctag inline">@param</span> {<span class="hljs-type inline">string</span>} <span class="hljs-variable inline">grammarLanguageOption</span> - Grammar language option (&#x27;combined&#x27; or &#x27;pure&#x27;)
     * <span class="hljs-doctag inline">@returns</span> {<span class="hljs-type inline">string</span>} Prompt template string
     */</span>
    <span class="hljs-title function_ inline">loadPrompt</span>(<span class="hljs-params inline">type, grammarLanguageOption = <span class="hljs-string inline">&#x27;combined&#x27;</span></span>) {
        <span class="hljs-comment inline">// Construct cache key: composite key of type-language option</span>
        <span class="hljs-comment inline">// Example: &#x27;sentence-check-combined&#x27;, &#x27;sentence-generation-pure&#x27;</span>
        <span class="hljs-keyword inline">const</span> cacheKey = <span class="hljs-string inline">`<span class="hljs-subst inline">${type}</span>-<span class="hljs-subst inline">${grammarLanguageOption}</span>`</span>;
        
        <span class="hljs-comment inline">// Cache-first strategy: if exists in cache, return directly</span>
        <span class="hljs-comment inline">// Map.has() and Map.get() are both O(1) time complexity</span>
        <span class="hljs-keyword inline">if</span> (<span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptCache</span>.<span class="hljs-title function_ inline">has</span>(cacheKey)) {
            <span class="hljs-keyword inline">return</span> <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptCache</span>.<span class="hljs-title function_ inline">get</span>(cacheKey);
        }

        <span class="hljs-keyword inline">try</span> {
            <span class="hljs-comment inline">// Construct filename according to convention: type-option.txt</span>
            <span class="hljs-keyword inline">const</span> filename = <span class="hljs-string inline">`<span class="hljs-subst inline">${type}</span>-<span class="hljs-subst inline">${grammarLanguageOption}</span>.txt`</span>;
            
            <span class="hljs-comment inline">// Construct complete file path, path.join automatically handles path separators</span>
            <span class="hljs-keyword inline">const</span> filepath = path.<span class="hljs-title function_ inline">join</span>(<span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptsDir</span>, filename);
            
            <span class="hljs-comment inline">// Defensive programming: check file existence first</span>
            <span class="hljs-comment inline">// Avoid fs.readFileSync throwing hard-to-understand ENOENT errors</span>
            <span class="hljs-keyword inline">if</span> (!fs.<span class="hljs-title function_ inline">existsSync</span>(filepath)) {
                <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">Error</span>(<span class="hljs-string inline">`Prompt file not found: <span class="hljs-subst inline">${filepath}</span>`</span>);
            }

            <span class="hljs-comment inline">// Synchronously read file content, use utf8 encoding to ensure Chinese displays correctly</span>
            <span class="hljs-keyword inline">const</span> promptTemplate = fs.<span class="hljs-title function_ inline">readFileSync</span>(filepath, <span class="hljs-string inline">&#x27;utf8&#x27;</span>);
            
            <span class="hljs-comment inline">// Cache strategy: only successfully read content gets cached</span>
            <span class="hljs-comment inline">// Avoid caching errors or incomplete data</span>
            <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptCache</span>.<span class="hljs-title function_ inline">set</span>(cacheKey, promptTemplate);
            
            <span class="hljs-keyword inline">return</span> promptTemplate;
        } <span class="hljs-keyword inline">catch</span> (error) {
            <span class="hljs-comment inline">// Error handling first layer: log detailed error information</span>
            <span class="hljs-variable language_ inline">console</span>.<span class="hljs-title function_ inline">error</span>(<span class="hljs-string inline">`Error loading prompt <span class="hljs-subst inline">${type}</span>-<span class="hljs-subst inline">${grammarLanguageOption}</span>:`</span>, error.<span class="hljs-property inline">message</span>);
            
            <span class="hljs-comment inline">// Fallback strategy: if pure version fails, try combined version</span>
            <span class="hljs-comment inline">// This is an elegant fallback mechanism ensuring service availability</span>
            <span class="hljs-keyword inline">if</span> (grammarLanguageOption === <span class="hljs-string inline">&#x27;pure&#x27;</span>) {
                <span class="hljs-variable language_ inline">console</span>.<span class="hljs-title function_ inline">warn</span>(<span class="hljs-string inline">`Falling back to combined prompt for <span class="hljs-subst inline">${type}</span>`</span>);
                <span class="hljs-comment inline">// Recursive call to self, but using combined option</span>
                <span class="hljs-keyword inline">return</span> <span class="hljs-variable language_ inline">this</span>.<span class="hljs-title function_ inline">loadPrompt</span>(type, <span class="hljs-string inline">&#x27;combined&#x27;</span>);
            }
            
            <span class="hljs-comment inline">// Error handling final defense: if combined version also fails, throw clear error</span>
            <span class="hljs-keyword inline">throw</span> <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">Error</span>(<span class="hljs-string inline">`Failed to load prompt template: <span class="hljs-subst inline">${type}</span>-<span class="hljs-subst inline">${grammarLanguageOption}</span>`</span>);
        }
    }

    <span class="hljs-comment inline">/**
     * Get sentence check prompt (with variable replacement)
     * <span class="hljs-doctag inline">@param</span> {<span class="hljs-type inline">string</span>} <span class="hljs-variable inline">sentence</span> - Sentence to analyze
     * <span class="hljs-doctag inline">@param</span> {<span class="hljs-type inline">string</span>} <span class="hljs-variable inline">grammarLanguageOption</span> - Language option
     * <span class="hljs-doctag inline">@returns</span> {<span class="hljs-type inline">string</span>} Formatted prompt
     */</span>
    <span class="hljs-title function_ inline">getSentenceCheckPrompt</span>(<span class="hljs-params inline">sentence, grammarLanguageOption = <span class="hljs-string inline">&#x27;combined&#x27;</span></span>) {
        <span class="hljs-comment inline">// Get template first, leveraging loadPrompt&#x27;s cache mechanism</span>
        <span class="hljs-keyword inline">const</span> template = <span class="hljs-variable language_ inline">this</span>.<span class="hljs-title function_ inline">loadPrompt</span>(<span class="hljs-string inline">&#x27;sentence-check&#x27;</span>, grammarLanguageOption);
        
        <span class="hljs-comment inline">// Simple and effective template variable replacement</span>
        <span class="hljs-comment inline">// Use String.replace instead of complex template engine, reducing dependencies and complexity</span>
        <span class="hljs-keyword inline">return</span> template.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-string inline">&#x27;{sentence}&#x27;</span>, sentence);
    }

    <span class="hljs-comment inline">/**
     * Get sentence generation prompt (with variable replacement)
     * <span class="hljs-doctag inline">@param</span> {<span class="hljs-type inline">Array</span>} <span class="hljs-variable inline">words</span> - Array of words to use
     * <span class="hljs-doctag inline">@param</span> {<span class="hljs-type inline">string</span>} <span class="hljs-variable inline">grammarLanguageOption</span> - Language option
     * <span class="hljs-doctag inline">@returns</span> {<span class="hljs-type inline">string</span>} Formatted prompt
     */</span>
    <span class="hljs-title function_ inline">getSentenceGenerationPrompt</span>(<span class="hljs-params inline">words, grammarLanguageOption = <span class="hljs-string inline">&#x27;combined&#x27;</span></span>) {
        <span class="hljs-keyword inline">const</span> template = <span class="hljs-variable language_ inline">this</span>.<span class="hljs-title function_ inline">loadPrompt</span>(<span class="hljs-string inline">&#x27;sentence-generation&#x27;</span>, grammarLanguageOption);
        
        <span class="hljs-comment inline">// Type-safe array handling: ensure words is array before joining</span>
        <span class="hljs-comment inline">// If not array, use original value directly</span>
        <span class="hljs-keyword inline">const</span> wordsString = <span class="hljs-title class_ inline">Array</span>.<span class="hljs-title function_ inline">isArray</span>(words) ? words.<span class="hljs-title function_ inline">join</span>(<span class="hljs-string inline">&#x27;, &#x27;</span>) : words;
        
        <span class="hljs-keyword inline">return</span> template.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-string inline">&#x27;{words}&#x27;</span>, wordsString);
    }

    <span class="hljs-comment inline">/**
     * Clear cache (useful for development and testing)
     */</span>
    <span class="hljs-title function_ inline">clearCache</span>(<span class="hljs-params inline"></span>) {
        <span class="hljs-comment inline">// Map.clear() is O(1) operation, directly clear all cache</span>
        <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptCache</span>.<span class="hljs-title function_ inline">clear</span>();
    }

    <span class="hljs-comment inline">/**
     * Get cache status information (for debugging)
     * <span class="hljs-doctag inline">@returns</span> {<span class="hljs-type inline">Object</span>} Information containing cache size and cached items
     */</span>
    <span class="hljs-title function_ inline">getCacheInfo</span>(<span class="hljs-params inline"></span>) {
        <span class="hljs-keyword inline">return</span> {
            <span class="hljs-comment inline">// Map.size is O(1) operation, get number of cached items</span>
            <span class="hljs-attr inline">cacheSize</span>: <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptCache</span>.<span class="hljs-property inline">size</span>,
            <span class="hljs-comment inline">// Convert Map keys to array for easy debugging inspection</span>
            <span class="hljs-attr inline">cachedPrompts</span>: <span class="hljs-title class_ inline">Array</span>.<span class="hljs-title function_ inline">from</span>(<span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptCache</span>.<span class="hljs-title function_ inline">keys</span>())
        };
    }

    <span class="hljs-comment inline">/**
     * Validate all required prompt files exist
     * <span class="hljs-doctag inline">@returns</span> {<span class="hljs-type inline">Object</span>} Validation result, containing existing/missing file lists
     */</span>
    <span class="hljs-title function_ inline">validatePromptFiles</span>(<span class="hljs-params inline"></span>) {
        <span class="hljs-comment inline">// Define system required prompt file list</span>
        <span class="hljs-comment inline">// This array defines system integrity requirements</span>
        <span class="hljs-keyword inline">const</span> requiredPrompts = [
            <span class="hljs-string inline">&#x27;sentence-check-pure.txt&#x27;</span>,
            <span class="hljs-string inline">&#x27;sentence-check-combined.txt&#x27;</span>,
            <span class="hljs-string inline">&#x27;sentence-generation-pure.txt&#x27;</span>,
            <span class="hljs-string inline">&#x27;sentence-generation-combined.txt&#x27;</span>
        ];

        <span class="hljs-keyword inline">const</span> missing = [];   <span class="hljs-comment inline">// Missing files</span>
        <span class="hljs-keyword inline">const</span> existing = [];  <span class="hljs-comment inline">// Existing files</span>

        <span class="hljs-comment inline">// Iterate through all required files, check existence</span>
        <span class="hljs-keyword inline">for</span> (<span class="hljs-keyword inline">const</span> filename <span class="hljs-keyword inline">of</span> requiredPrompts) {
            <span class="hljs-keyword inline">const</span> filepath = path.<span class="hljs-title function_ inline">join</span>(<span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptsDir</span>, filename);
            <span class="hljs-comment inline">// fs.existsSync is synchronous check, suitable for one-time validation at startup</span>
            <span class="hljs-keyword inline">if</span> (fs.<span class="hljs-title function_ inline">existsSync</span>(filepath)) {
                existing.<span class="hljs-title function_ inline">push</span>(filename);
            } <span class="hljs-keyword inline">else</span> {
                missing.<span class="hljs-title function_ inline">push</span>(filename);
            }
        }

        <span class="hljs-keyword inline">return</span> {
            <span class="hljs-comment inline">// System integrity flag: only true when all files exist</span>
            <span class="hljs-attr inline">valid</span>: missing.<span class="hljs-property inline">length</span> === <span class="hljs-number inline">0</span>,
            existing,
            missing,
            <span class="hljs-comment inline">// Provide prompts directory path for ops personnel to locate issues</span>
            <span class="hljs-attr inline">promptsDirectory</span>: <span class="hljs-variable language_ inline">this</span>.<span class="hljs-property inline">promptsDir</span>
        };
    }
}

<span class="hljs-comment inline">// ==================== Module Export ====================</span>
<span class="hljs-comment inline">// Export singleton instance instead of class itself</span>
<span class="hljs-comment inline">// This ensures only one PromptLoader instance globally, saving memory and ensuring cache consistency</span>
<span class="hljs-variable language_ inline">module</span>.<span class="hljs-property inline">exports</span> = <span class="hljs-keyword inline">new</span> <span class="hljs-title class_ inline">PromptLoader</span>();
</code></pre>
            </div>
        
<h3 id="response-parsing-core-algorithm-analysis" class="group relative text-2xl font-semibold mt-5 mb-2 text-foreground leading-snug">
            <a href="#response-parsing-core-algorithm-analysis" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Response Parsing Core Algorithm Analysis">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Response Parsing Core Algorithm Analysis
        </h3>

            <div class="enhanced-codeblock relative mb-6 rounded-lg border bg-background border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" data-enhanced-codeblock="true" data-language="javascript" data-code="%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Content%20Cleaning%20Algorithm%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0AcleanResponseContent(content)%20%7B%0Aif%20(!content)%20return%20''%3B%0Alet%20cleaned%20%3D%20content%3B%0A%2F%2F%20Step%201%3A%20Remove%20AI-generated%20meta%20markers%0Acleaned%20%3D%20cleaned.replace(%2F%5C(Parsing%20required%5C)%2Fgi%2C%20'')%3B%0A%2F%2F%20Step%202%3A%20Standardize%20whitespace%20characters%2C%20maintaining%20structural%20integrity%0Acleaned%20%3D%20cleaned.replace(%2F%5Cn%7B3%2C%7D%2Fg%2C%20'%5Cn%5Cn')%3B%0A%2F%2F%20Step%203%3A%20Clean%20edge%20whitespace%20from%20each%20line%20while%20maintaining%20overall%20layout%0Acleaned%20%3D%20cleaned.split('%5Cn')%0A.map(line%20%3D%3E%20line.trim())%0A.join('%5Cn')%3B%0A%2F%2F%20Step%204%3A%20Remove%20markdown%20elements%20that%20may%20interfere%20with%20parsing%0Acleaned%20%3D%20cleaned.replace(%2F%60%60%60%5B%5Cs%5CS%5D*%3F%60%60%60%2Fg%2C%20'')%3B%0Acleaned%20%3D%20cleaned.replace(%2F%5E%5Cs*%23%7B1%2C6%7D%5Cs*%2Fgm%2C%20'')%3B%0Areturn%20cleaned.trim()%3B%0A%7D%0A%2F%2F%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%20Marker%20Extraction%20Algorithm%20%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0AextractSection(content%2C%20startMarker%2C%20endMarkers%20%3D%20%5B%5D)%20%7B%0A%2F%2F%20Step%201%3A%20Locate%20start%20marker%0Aconst%20startIndex%20%3D%20content.indexOf(startMarker)%3B%0Aif%20(startIndex%20%3D%3D%3D%20-1)%20%7B%0Areturn%20null%3B%20%2F%2F%20Marker%20not%20found%2C%20return%20null%20instead%20of%20throwing%20exception%0A%7D%0A%2F%2F%20Step%202%3A%20Calculate%20content%20start%20position%0Aconst%20contentStart%20%3D%20startIndex%20%2B%20startMarker.length%3B%0A%2F%2F%20Step%203%3A%20Find%20nearest%20end%20marker%20(greedy%20algorithm)%0Alet%20endIndex%20%3D%20content.length%3B%20%2F%2F%20Default%20to%20content%20end%0Afor%20(const%20endMarker%20of%20endMarkers)%20%7B%0Aconst%20markerIndex%20%3D%20content.indexOf(endMarker%2C%20contentStart)%3B%0Aif%20(markerIndex%20!%3D%3D%20-1%20%26%26%20markerIndex%20%2F%2F%20Update%20to%20earlier%20position%0A%7D%0A%7D%0A%2F%2F%20Step%204%3A%20Extract%20and%20validate%20content%0Aconst%20extractedContent%20%3D%20content.substring(contentStart%2C%20endIndex).trim()%3B%0A%2F%2F%20Content%20quality%20check%3A%20length%20at%20least%205%20characters%20to%20be%20considered%20valid%20content%0Areturn%20extractedContent.length%20%3E%3D%205%20%3F%20extractedContent%20%3A%20null%3B%0A%7D">
                <div class="codeblock-header flex items-center justify-between px-4 py-2 bg-surface border-b border-gray-200 dark:border-gray-700">
                    <span class="codeblock-language text-xs font-medium uppercase tracking-wide text-foreground opacity-70 inline">javascript</span>
                    <button class="codeblock-copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium border rounded transition-all duration-200 bg-background hover:bg-surface text-foreground hover:text-primary border-gray-300 dark:border-gray-600 hover:scale-105 active:scale-95" title="Copy code">
                        <svg class="copy-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        <svg class="copied-icon w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span class="copy-text inline">Copy</span>
                    </button>
                </div>
                <pre class="codeblock-content p-4 overflow-x-auto font-mono text-sm leading-relaxed bg-surface text-foreground"><code class="language-javascript"><span class="hljs-comment inline">// ==================== Content Cleaning Algorithm ====================</span>
<span class="hljs-title function_ inline">cleanResponseContent</span>(<span class="hljs-params inline">content</span>) {
    <span class="hljs-keyword inline">if</span> (!content) <span class="hljs-keyword inline">return</span> <span class="hljs-string inline">&#x27;&#x27;</span>;

    <span class="hljs-keyword inline">let</span> cleaned = content;

    <span class="hljs-comment inline">// Step 1: Remove AI-generated meta markers</span>
    cleaned = cleaned.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-regexp inline">/\(Parsing required\)/gi</span>, <span class="hljs-string inline">&#x27;&#x27;</span>);

    <span class="hljs-comment inline">// Step 2: Standardize whitespace characters, maintaining structural integrity</span>
    cleaned = cleaned.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-regexp inline">/\n{3,}/g</span>, <span class="hljs-string inline">&#x27;\n\n&#x27;</span>);

    <span class="hljs-comment inline">// Step 3: Clean edge whitespace from each line while maintaining overall layout</span>
    cleaned = cleaned.<span class="hljs-title function_ inline">split</span>(<span class="hljs-string inline">&#x27;\n&#x27;</span>)
        .<span class="hljs-title function_ inline">map</span>(<span class="hljs-function inline"><span class="hljs-params inline">line</span> =&gt;</span> line.<span class="hljs-title function_ inline">trim</span>())
        .<span class="hljs-title function_ inline">join</span>(<span class="hljs-string inline">&#x27;\n&#x27;</span>);

    <span class="hljs-comment inline">// Step 4: Remove markdown elements that may interfere with parsing</span>
    cleaned = cleaned.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-regexp inline">/```[\s\S]*?```/g</span>, <span class="hljs-string inline">&#x27;&#x27;</span>);
    cleaned = cleaned.<span class="hljs-title function_ inline">replace</span>(<span class="hljs-regexp inline">/^\s*#{1,6}\s*/gm</span>, <span class="hljs-string inline">&#x27;&#x27;</span>);

    <span class="hljs-keyword inline">return</span> cleaned.<span class="hljs-title function_ inline">trim</span>();
}

<span class="hljs-comment inline">// ==================== Marker Extraction Algorithm ====================</span>
<span class="hljs-title function_ inline">extractSection</span>(<span class="hljs-params inline">content, startMarker, endMarkers = []</span>) {
    <span class="hljs-comment inline">// Step 1: Locate start marker</span>
    <span class="hljs-keyword inline">const</span> startIndex = content.<span class="hljs-title function_ inline">indexOf</span>(startMarker);
    <span class="hljs-keyword inline">if</span> (startIndex === -<span class="hljs-number inline">1</span>) {
        <span class="hljs-keyword inline">return</span> <span class="hljs-literal inline">null</span>; <span class="hljs-comment inline">// Marker not found, return null instead of throwing exception</span>
    }

    <span class="hljs-comment inline">// Step 2: Calculate content start position</span>
    <span class="hljs-keyword inline">const</span> contentStart = startIndex + startMarker.<span class="hljs-property inline">length</span>;

    <span class="hljs-comment inline">// Step 3: Find nearest end marker (greedy algorithm)</span>
    <span class="hljs-keyword inline">let</span> endIndex = content.<span class="hljs-property inline">length</span>; <span class="hljs-comment inline">// Default to content end</span>

    <span class="hljs-keyword inline">for</span> (<span class="hljs-keyword inline">const</span> endMarker <span class="hljs-keyword inline">of</span> endMarkers) {
        <span class="hljs-keyword inline">const</span> markerIndex = content.<span class="hljs-title function_ inline">indexOf</span>(endMarker, contentStart);
        <span class="hljs-keyword inline">if</span> (markerIndex !== -<span class="hljs-number inline">1</span> &amp;&amp; markerIndex &lt; endIndex) {
            endIndex = markerIndex;  <span class="hljs-comment inline">// Update to earlier position</span>
        }
    }

    <span class="hljs-comment inline">// Step 4: Extract and validate content</span>
    <span class="hljs-keyword inline">const</span> extractedContent = content.<span class="hljs-title function_ inline">substring</span>(contentStart, endIndex).<span class="hljs-title function_ inline">trim</span>();
    
    <span class="hljs-comment inline">// Content quality check: length at least 5 characters to be considered valid content</span>
    <span class="hljs-keyword inline">return</span> extractedContent.<span class="hljs-property inline">length</span> &gt;= <span class="hljs-number inline">5</span> ? extractedContent : <span class="hljs-literal inline">null</span>;
}
</code></pre>
            </div>
        
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Extraction Algorithm Time Complexity Analysis</strong>:</p>
<ul class="list-disc list-inside mb-4 pl-6 space-y-2">
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Best Case</strong>: O(n), where n is content length (only need to scan once)</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Worst Case</strong>: O(n × m), where m is number of end markers</li>
<li class="text-foreground leading-relaxed"><strong class="font-bold text-foreground">Average Case</strong>: O(n), because usually first marker can match</li>
</ul>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Space Complexity</strong>: O(1), only uses constant level additional space</p>
<h2 id="final-words" class="group relative text-3xl font-semibold mt-6 mb-3 text-foreground leading-tight">
            <a href="#final-words" class="absolute -left-6 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-primary/60 hover:text-primary" aria-label="Link to Final Words">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 11.414-1.414 4 4 0 105.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 10-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
            </a>
            Final Words
        </h2>
<p class="text-base leading-7 mb-4 text-foreground">As you can see, the original design philosophy of MCP is actually this simple and unpretentious. Agree on a set of data interaction formats with AI, and let other applications read this format to understand AI’s output, ultimately achieving the effect of “AI calling external tools.”</p>
<p class="text-base leading-7 mb-4 text-foreground">After this complete source code analysis, we’ve seen the ingenious design behind what appears to be a simple prompt management system: from singleton pattern memory optimization, to Map cache performance improvements, from fallback strategy service availability, to defensive programming robustness guarantees.</p>
<p class="text-base leading-7 mb-4 text-foreground"><strong class="font-bold text-foreground">Every line of code is not accidental, every design decision has its profound considerations.</strong></p>
<p class="text-base leading-7 mb-4 text-foreground"><em class="italic text-foreground">May your prompts be like spring breeze and gentle rain, letting AI understand your every intention; may your parsing algorithms be like a skilled butcher, transforming complex responses into clear structures. In this era where AI and human wisdom intertwine, let us together weave a more beautiful tomorrow with code!</em> ✨</p>
d:["$","$L1d",null,{"htmlContent":"$1e","frontMatter":{"title":"Prompt Alchemy: A Journey from Templates to Intelligent Language Parsing","description":"Deep analysis of the complete implementation principles of prompt loading, structured parsing, cache optimization, and fault tolerance mechanisms in AI services","date":"2025-06-22","author":"MilkWind","tags":["AI"],"references":{}},"readingTime":"16 min read","category":"questions-party","tocItems":[{"id":"prompt-generation-and-response-parsing-the-birth-of-another-machine-language","text":"Prompt Generation and Response Parsing: The Birth of Another Machine Language","level":1},{"id":"promptloader-core-architecture","text":"PromptLoader Core Architecture","level":2},{"id":"singleton-pattern-design","text":"Singleton Pattern Design","level":3},{"id":"map-caching","text":"Map Caching","level":3},{"id":"loadprompt-function","text":"loadPrompt Function","level":2},{"id":"cache-first-strategy","text":"Cache-First Strategy","level":3},{"id":"file-system-safe-operations","text":"File System Safe Operations","level":3},{"id":"prompt-loading-fallback-handling","text":"Prompt Loading Fallback Handling","level":3},{"id":"prompt-structured-design","text":"Prompt Structured Design","level":2},{"id":"combined-vs-pure-bilingual-teaching","text":"Combined vs Pure: Bilingual Teaching","level":3},{"id":"cache-mechanism-and-performance-optimization","text":"Cache Mechanism and Performance Optimization","level":2},{"id":"map-vs-object-performance-comparison","text":"Map vs Object Performance Comparison","level":3},{"id":"fallback-strategy-fault-tolerance-design","text":"Fallback Strategy Fault Tolerance Design","level":2},{"id":"pure-→-combined-fallback-logic","text":"Pure → Combined Fallback Logic","level":3},{"id":"system-robustness-guarantee","text":"System Robustness Guarantee","level":3},{"id":"parsesentencecheckresponse-deep-analysis","text":"parseSentenceCheckResponse Deep Analysis","level":2},{"id":"tokenized-response-format-design","text":"Tokenized Response Format Design","level":3},{"id":"robust-parsing-algorithm","text":"Robust Parsing Algorithm","level":3},{"id":"partial-parsing-fault-tolerance-mechanism","text":"Partial Parsing Fault Tolerance Mechanism","level":3},{"id":"parsestructuredresponse-structured-parsing","text":"parseStructuredResponse Structured Parsing","level":2},{"id":"structured-marker-extraction-logic","text":"Structured Marker Extraction Logic","level":3},{"id":"response-validation-mechanism","text":"Response Validation Mechanism","level":3},{"id":"data-cleaning-and-formatting","text":"Data Cleaning and Formatting","level":3},{"id":"complete-parsing-flow-architecture-design","text":"Complete Parsing Flow Architecture Design","level":2},{"id":"lifecycle-from-template-loading-to-response-parsing","text":"Lifecycle from Template Loading to Response Parsing","level":3},{"id":"data-flow-and-state-management","text":"Data Flow and State Management","level":3},{"id":"system-architecture-diagram-and-technical-points-summary","text":"System Architecture Diagram and Technical Points Summary","level":2},{"id":"complete-system-architecture-flow-chart","text":"Complete System Architecture Flow Chart","level":3},{"id":"complete-source-code-full-analysis","text":"Complete Source Code Full Analysis","level":2},{"id":"promptloader-complete-source-code-analysis","text":"PromptLoader Complete Source Code Analysis","level":3},{"id":"response-parsing-core-algorithm-analysis","text":"Response Parsing Core Algorithm Analysis","level":3},{"id":"final-words","text":"Final Words","level":2}],"translations":{"common":{"welcome":"Welcome","loading":"Loading...","error":"Something went wrong","retry":"Try again","theme":"Theme","language":"Language","light":"Light","dark":"Dark"},"navigation":{"home":"Home","personal":"Personal","works":"Works","contributions":"Contributions","documents":"Documents","about":"About","contact":"Contact"},"personal":{"technicalSkills":"Technical Skills","email":"Email","github":"GitHub","resume":"Resume","codeRepository":"Code Repository","loadingPersonalInfo":"Loading personal information...","loadingResume":"Loading resume...","closeResume":"Close Resume","emailCopied":"Email copied to clipboard!","galaxyDefaultDescription":"Expert in full-stack development, cross-platform architecture, AI technology integration, and high-performance system optimization","skillGalaxy":"Skill Galaxy","stirGalaxy":"Stir Galaxy","stirring":"Stirring...","fullStackEngineer":"MilkWind - Full Stack Engineer","professionalProfile":"About Me"},"documents":{"technicalDocuments":"Technical Documents","description":"Basic principles, code splitting, and some random thoughts.","articles":"Articles","categories":"Categories","allCategories":"All Categories","noArticlesFound":"No articles found","noArticlesAvailable":"No articles available in English.","noArticlesInCategory":"No articles found in the category.","readMore":"Read more","loadingDocuments":"Loading documents...","backToDocuments":"← Back to Documents","documentNotFound":"Document Not Found","documentNotFoundDescription":"The requested document could not be found.","technicalInsights":"Insights","untitledDocument":"Untitled Document","byAuthor":"By","search":"Search articles...","searchByTags":"Filter by tags","searching":"Searching...","noSearchResults":"No articles match your search criteria","clearSearch":"Clear search","selectedTags":"Selected tags","allTags":"All tags","searchInTitle":"Search in titles, descriptions, and content","enterImmersiveMode":"Immersive Reading","exitImmersiveMode":"Exit Immersive Mode","immersiveReading":"Immersive Reading Mode","exploreContent":"Explore content by category","browseBy":"Browse by","exploreAll":"All content in one place","categoryDescription":"Articles in this category","totalArticles":"Articles","totalCategories":"Categories","foundArticles":"Found articles","categoriesWithResults":"Categories with results"},"works":{"workCases":"Work Cases","projects":"Portfolio","loadingProjects":"Loading projects...","grid":"Grid","stack":"Stack","of":"of","workCasesPageTitle":"Work Cases Page","pageWorkingCorrectly":"This page is working! The routing is correct.","try3DVersion":"Try 3D Version","dragToScroll":"Drag to scroll","dragToChange":"Drag to change","swipeCards":"Swipe cards","keyboardNav":"Keyboard navigation"},"contributions":{"contributionCases":"Open Source","contributions":"Contributions","loadingContributions":"Loading contributions...","grid":"Grid","stack":"Stack","of":"of","contributionCasesPageTitle":"Contribution Cases Page","pageWorkingCorrectly":"This page is working! The routing is correct.","try3DVersion":"Try 3D Version","dragToScroll":"Drag to scroll","dragToChange":"Drag to change","swipeCards":"Swipe cards","keyboardNav":"Keyboard navigation"},"contribution":{"contributionPreview":"Contribution Preview","accessible":"Accessible","code":"Code","maintenance":"Maintenance","enhancement":"Enhancement","documentation":"Documentation","community":"Community","moreItems":"more","technicalDetails":"Technical Details","technologies":"Technologies:","contributionDetail":"Contribution Detail","description":"Description:","seeDetails":"See Details","github":"GitHub","viewContribution":"View Contribution","viewCode":"View Code"},"project":{"projectPreview":"Project Preview","accessible":"Accessible","tool":"Tool","plugin":"Plugin","toy":"Toy","moreItems":"more","technicalDetails":"Technical Details","technologies":"Technologies:","description":"Description:","seeDetails":"See Details","github":"GitHub","gitee":"Gitee","viewLiveDemo":"View Live Demo","viewCode":"View Code","access":"Access","videos":"Videos","watchVideo":"Watch Video","hasVideo":"Has Video"},"codeblock":{"copy":"Copy","copySuccess":"Code copied to clipboard!","copyError":"Failed to copy code","copyTooltip":"Copy code"},"toc":{"contents":"Contents","autoScroll":"Auto-scroll to section","collapse":"Collapse","expand":"Expand"},"loading":{"loading":"LOADING","preparingExperience":"Preparing experience"}},"lang":"en","theme":"dark"}]
12:null
18:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
11:null
1c:{"metadata":[["$","title","0",{"children":"Prompt Alchemy: A Journey from Templates to Intelligent Language Parsing | Interactive Portfolio"}],["$","meta","1",{"name":"description","content":"Deep analysis of the complete implementation principles of prompt loading, structured parsing, cache optimization, and fault tolerance mechanisms in AI services"}],["$","meta","2",{"name":"author","content":"Developer"}],["$","meta","3",{"name":"keywords","content":"portfolio,3D,interactive,web development,Three.js,Next.js"}],["$","meta","4",{"property":"og:title","content":"Prompt Alchemy: A Journey from Templates to Intelligent Language Parsing | Interactive Portfolio"}],["$","meta","5",{"property":"og:description","content":"Deep analysis of the complete implementation principles of prompt loading, structured parsing, cache optimization, and fault tolerance mechanisms in AI services"}],["$","meta","6",{"property":"og:type","content":"article"}],["$","meta","7",{"property":"article:published_time","content":"2025-06-22"}],["$","meta","8",{"property":"article:tag","content":"AI"}],["$","meta","9",{"name":"twitter:card","content":"summary_large_image"}],["$","meta","10",{"name":"twitter:title","content":"Prompt Alchemy: A Journey from Templates to Intelligent Language Parsing | Interactive Portfolio"}],["$","meta","11",{"name":"twitter:description","content":"Deep analysis of the complete implementation principles of prompt loading, structured parsing, cache optimization, and fault tolerance mechanisms in AI services"}],["$","link","12",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"32x32"}]],"error":null,"digest":"$undefined"}
14:{"metadata":"$1c:metadata","error":null,"digest":"$undefined"}
